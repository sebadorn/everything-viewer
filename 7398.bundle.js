"use strict";(self.webpackChunkeverything_viewer=self.webpackChunkeverything_viewer||[]).push([[7398],{87398:(e,t,r)=>{r.d(t,{BVHFileLoader:()=>y});var o=r(15909),n=r(97762),s=r(7540),i=r(80252),a=r(36504),l=r(15397),c=r(79923),f=r(998);const p="Xposition",h="Yposition",m="Zposition",d="Xrotation",u="Yrotation",E="Zrotation";class w{constructor(e){this.loopMode=s.X5.ANIMATIONLOOPMODE_CYCLE,this.list=[],this.root=N(),this.numFrames=0,this.frameRate=0,this.skeleton=e}}function N(){return{name:"",type:"",offset:new c.Pq,channels:[],children:[],frames:[],parent:null}}function g(e,t,r){const o=function(e){const t=e.offset.x,r=e.offset.y,o=e.offset.z;return c.uq.Translation(t,r,o)}(e),n=new a.$(e.name,r.skeleton,t,o),i=function(e,t){if(0===e.frames.length)return[];const r=[],o=e.channels.some(e=>e===p||e===h||e===m),n=e.channels.some(e=>e===d||e===u||e===E),i=new s.X5(`${e.name}_pos`,"position",t.frameRate,s.X5.ANIMATIONTYPE_VECTOR3,t.loopMode),a=new s.X5(`${e.name}_rot`,"rotationQuaternion",t.frameRate,s.X5.ANIMATIONTYPE_QUATERNION,t.loopMode),l=[],c=[];for(let t=0;t<e.frames.length;t++){const r=e.frames[t];o&&r.position&&l.push({frame:r.frame,value:r.position.clone()}),n&&c.push({frame:r.frame,value:r.rotation.clone()})}return l.length>0&&(i.setKeys(l),r.push(i)),c.length>0&&(a.setKeys(c),r.push(a)),r}(e,r);for(const e of i)e.getKeys()&&e.getKeys().length>0&&n.animations.push(e);for(const t of e.children)g(t,n,r)}function H(e,t,r,o){if("ENDSITE"===r.type)return;const n={frame:0,position:new c.Pq,rotation:new c.PT};n.frame=t,n.position=new c.Pq,n.rotation=new c.PT,r.frames.push(n);let s=c.uq.Identity();for(let t=0;t<r.channels.length;++t){const i=r.channels[t],a=e[o.i++];if(!a)continue;const l=parseFloat(a.trim());if(i.endsWith("position"))switch(i){case p:n.position.x=l;break;case h:n.position.y=l;break;case m:n.position.z=l}else if(i.endsWith("rotation")){const e=f.S0.ToRadians(l);let t;switch(i){case d:t=c.uq.RotationX(e);break;case u:t=c.uq.RotationY(e);break;case E:t=c.uq.RotationZ(e)}s=t.multiply(s)}}c.PT.FromRotationMatrixToRef(s,n.rotation);for(const n of r.children)H(e,t,n,o)}function I(e,t,r,o){const n=N();n.parent=r,o.list.push(n);let s=t.trim().split(/\s+/);if("END"===s[0].toUpperCase()&&"SITE"===s[1].toUpperCase()?(n.type="ENDSITE",n.name="ENDSITE"):(n.name=s[1],n.type=s[0].toUpperCase()),"{"!=e.shift()?.trim())throw new Error("Expected opening { after type & name");const i=e.shift()?.trim().split(/\s+/);if(!i)throw new Error("Unexpected end of file: missing OFFSET");if(s=i,"OFFSET"!=s[0].toUpperCase())throw new Error("Expected OFFSET, but got: "+s[0]);if(4!=s.length)throw new Error("OFFSET: Invalid number of values");const a=new c.Pq(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3]));if(isNaN(a.x)||isNaN(a.y)||isNaN(a.z))throw new Error("OFFSET: Invalid values");if(n.offset=a,"ENDSITE"!=n.type){if(s=e.shift()?.trim().split(/\s+/),!s)throw new Error("Unexpected end of file: missing CHANNELS");if("CHANNELS"!=s[0].toUpperCase())throw new Error("Expected CHANNELS definition");const t=parseInt(s[1]);n.channels=s.splice(2,t),n.children=[]}for(;e.length>0;){const t=e.shift()?.trim();if("}"===t)return n;t&&n.children.push(I(e,t,n,o))}throw new Error("Unexpected end of file: missing closing brace")}function T(e,t,r,o){const n=e.split("\n"),{loopMode:s}=o;t._blockEntityCollection=!!r;const i=new l.E("","",t);i._parentContainer=r,t._blockEntityCollection=!1;const a=new w(i);a.loopMode=s;const c=n.shift();if(!c||"HIERARCHY"!==c.trim().toUpperCase())throw new Error("HIERARCHY expected");const f=n.shift();if(!f)throw new Error("Unexpected end of file after HIERARCHY");const p=I(n,f.trim(),null,a),h=n.shift();if(!h||"MOTION"!==h.trim().toUpperCase())throw new Error("MOTION expected");const m=n.shift();if(!m)throw new Error("Unexpected end of file before frame count");const d=m.trim().split(/[\s]+/);if(d.length<2)throw new Error("Invalid frame count line");const u=parseInt(d[1]);if(isNaN(u))throw new Error("Failed to read number of frames.");a.numFrames=u;const E=n.shift();if(!E)throw new Error("Unexpected end of file before frame time");const N=E.trim().split(/[\s]+/);if(N.length<3)throw new Error("Invalid frame time line");const T=parseFloat(N[2]);if(isNaN(T))throw new Error("Failed to read frame time.");if(T<=0)throw new Error("Failed to read frame time. Invalid value "+T);a.frameRate=1/T;for(let e=0;e<u;++e){const t=n.shift();if(!t)continue;H(t.trim().split(/[\s]+/)||[],e,p,{i:0})}return a.root=p,g(a.root,null,a),a.skeleton.returnToRest(),a.skeleton}class y{constructor(e){this.name=i.T.name,this.extensions=i.T.extensions,this._loadingOptions={...y._DefaultLoadingOptions,...e??{}}}static get _DefaultLoadingOptions(){return{loopMode:s.X5.ANIMATIONLOOPMODE_CYCLE}}createPlugin(e){return new y(e[i.T.name])}canDirectLoad(e){return this.isBvhHeader(e)}isBvhHeader(e){return"HIERARCHY"==e.split("\n")[0]}isNotBvhHeader(e){return!this.isBvhHeader(e)}importMeshAsync(e,t,r){if("string"!=typeof r)return Promise.reject("BVH loader expects string data.");if(this.isNotBvhHeader(r))return Promise.reject("BVH loader expects HIERARCHY header.");try{const e=T(r,t,null,this._loadingOptions);return Promise.resolve({meshes:[],particleSystems:[],skeletons:[e],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]})}catch(e){return Promise.reject(e)}}loadAsync(e,t){return"string"!=typeof t?Promise.reject("BVH loader expects string data."):this.isNotBvhHeader(t)?Promise.reject("BVH loader expects HIERARCHY header."):this.importMeshAsync(null,e,t).then(()=>{})}loadAssetContainerAsync(e,t){if("string"!=typeof t)return Promise.reject("BVH loader expects string data.");if(this.isNotBvhHeader(t))return Promise.reject("BVH loader expects HIERARCHY header.");const r=new n.WZ(e);try{const o=T(t,e,r,this._loadingOptions);return r.skeletons.push(o),Promise.resolve(r)}catch(e){return Promise.reject(e)}}}(0,o.qS)(new y)}}]);