"use strict";(self.webpackChunkeverything_viewer=self.webpackChunkeverything_viewer||[]).push([[7398],{87398:(e,t,n)=>{n.d(t,{BVHFileLoader:()=>O});var o=n(15909),r=n(97762),s=n(7540),i=n(80252),a=n(36504),l=n(15397),c=n(14037),f=n(998);const p="Xposition",h="Yposition",m="Zposition",u="Xrotation",d="Yrotation",w="Zrotation";class E{constructor(e){this.loopMode=s.X5.ANIMATIONLOOPMODE_CYCLE,this.list=[],this.root=g(),this.numFrames=0,this.frameRate=0,this.skeleton=e}}function g(){return{name:"",type:"",offset:new c.Pq,channels:[],children:[],frames:[],parent:null}}function N(e,t,n){const o=function(e){const t=e.offset.x,n=e.offset.y,o=e.offset.z;return c.uq.Translation(t,n,o)}(e),r=new a.$(e.name,n.skeleton,t,o),i=function(e,t){if(0===e.frames.length)return[];const n=[],o=e.channels.some(e=>e===p||e===h||e===m),r=e.channels.some(e=>e===u||e===d||e===w),i=new s.X5(`${e.name}_pos`,"position",t.frameRate,s.X5.ANIMATIONTYPE_VECTOR3,t.loopMode),a=new s.X5(`${e.name}_rot`,"rotationQuaternion",t.frameRate,s.X5.ANIMATIONTYPE_QUATERNION,t.loopMode),l=[],c=[];for(let t=0;t<e.frames.length;t++){const n=e.frames[t];o&&n.position&&l.push({frame:n.frame,value:n.position.clone()}),r&&c.push({frame:n.frame,value:n.rotation.clone()})}return l.length>0&&(i.setKeys(l),n.push(i)),c.length>0&&(a.setKeys(c),n.push(a)),n}(e,n);for(const e of i)e.getKeys()&&e.getKeys().length>0&&r.animations.push(e);for(const t of e.children)N(t,r,n)}function T(e,t,n,o){if("ENDSITE"===n.type)return;const r={frame:0,position:new c.Pq,rotation:new c.PT};r.frame=t,r.position=new c.Pq,r.rotation=new c.PT,n.frames.push(r);let s=c.uq.Identity();for(let t=0;t<n.channels.length;++t){const i=n.channels[t],a=e[o.i++];if(!a)continue;const l=parseFloat(a.trim());if(i.endsWith("position"))switch(i){case p:r.position.x=l;break;case h:r.position.y=l;break;case m:r.position.z=l}else if(i.endsWith("rotation")){const e=f.S0.ToRadians(l);let t;switch(i){case u:t=c.uq.RotationX(e);break;case d:t=c.uq.RotationY(e);break;case w:t=c.uq.RotationZ(e)}s=t.multiply(s)}}c.PT.FromRotationMatrixToRef(s,r.rotation);for(const r of n.children)T(e,t,r,o)}function y(e,t,n,o){const r=g();r.parent=n,o.list.push(r);let s=t.trim().split(/\s+/);if("END"===s[0].toUpperCase()&&"SITE"===s[1].toUpperCase()?(r.type="ENDSITE",r.name="ENDSITE"):(r.name=s[1],r.type=s[0].toUpperCase()),"{"!=e.shift()?.trim())throw new Error("Expected opening { after type & name");const i=e.shift()?.trim().split(/\s+/);if(!i)throw new Error("Unexpected end of file: missing OFFSET");if(s=i,"OFFSET"!=s[0].toUpperCase())throw new Error("Expected OFFSET, but got: "+s[0]);if(4!=s.length)throw new Error("OFFSET: Invalid number of values");const a=new c.Pq(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3]));if(isNaN(a.x)||isNaN(a.y)||isNaN(a.z))throw new Error("OFFSET: Invalid values");if(r.offset=a,"ENDSITE"!=r.type){if(s=e.shift()?.trim().split(/\s+/),!s)throw new Error("Unexpected end of file: missing CHANNELS");if("CHANNELS"!=s[0].toUpperCase())throw new Error("Expected CHANNELS definition");const t=parseInt(s[1]);r.channels=s.splice(2,t),r.children=[]}for(;e.length>0;){const t=e.shift()?.trim();if("}"===t)return r;t&&r.children.push(y(e,t,r,o))}throw new Error("Unexpected end of file: missing closing brace")}function I(e,t,n,o){const r=e.split("\n"),{loopMode:s}=o;t._blockEntityCollection=!!n;const i=new l.E("","",t);i._parentContainer=n,t._blockEntityCollection=!1;const a=new E(i);a.loopMode=s;const c=r.shift();if(!c||"HIERARCHY"!==c.trim().toUpperCase())throw new Error("HIERARCHY expected");const f=r.shift();if(!f)throw new Error("Unexpected end of file after HIERARCHY");const p=y(r,f.trim(),null,a),h=r.shift();if(!h||"MOTION"!==h.trim().toUpperCase())throw new Error("MOTION expected");const m=r.shift();if(!m)throw new Error("Unexpected end of file before frame count");const u=m.trim().split(/[\s]+/);if(u.length<2)throw new Error("Invalid frame count line");const d=parseInt(u[1]);if(isNaN(d))throw new Error("Failed to read number of frames.");a.numFrames=d;const w=r.shift();if(!w)throw new Error("Unexpected end of file before frame time");const g=w.trim().split(/[\s]+/);if(g.length<3)throw new Error("Invalid frame time line");const I=parseFloat(g[2]);if(isNaN(I))throw new Error("Failed to read frame time.");a.frameRate=I;for(let e=0;e<d;++e){const t=r.shift();if(!t)continue;T(t.trim().split(/[\s]+/)||[],e,p,{i:0})}return a.root=p,N(a.root,null,a),a.skeleton.returnToRest(),a.skeleton}class O{constructor(e){this.name=i.T.name,this.extensions=i.T.extensions,this._loadingOptions={...O._DefaultLoadingOptions,...e??{}}}static get _DefaultLoadingOptions(){return{loopMode:s.X5.ANIMATIONLOOPMODE_CYCLE}}createPlugin(e){return new O(e[i.T.name])}canDirectLoad(){return!0}importMeshAsync(e,t,n){if("string"!=typeof n)return Promise.reject("BVH loader expects string data.");try{const e=I(n,t,null,this._loadingOptions);return Promise.resolve({meshes:[],particleSystems:[],skeletons:[e],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]})}catch(e){return Promise.reject(e)}}loadAsync(e,t){return"string"!=typeof t?Promise.reject("BVH loader expects string data."):this.importMeshAsync(null,e,t).then(()=>{})}loadAssetContainerAsync(e,t){if("string"!=typeof t)return Promise.reject("BVH loader expects string data.");const n=new r.WZ(e);try{const o=I(t,e,n,this._loadingOptions);return n.skeletons.push(o),Promise.resolve(n)}catch(e){return Promise.reject(e)}}}(0,o.qS)(new O)}}]);