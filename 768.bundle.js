"use strict";(self.webpackChunkeverything_viewer=self.webpackChunkeverything_viewer||[]).push([[768],{6874:(e,t,r)=>{var n=r(69610);const s="meshUboDeclaration",i="struct Mesh {world : mat4x4<f32>,\nvisibility : f32,};var<uniform> mesh : Mesh;\n#define WORLD_UBO\n";n.l.IncludesShadersStoreWGSL[s]||(n.l.IncludesShadersStoreWGSL[s]=i)},30976:(e,t,r)=>{var n=r(69610);const s="fresnelFunction",i="#ifdef FRESNEL\nfn computeFresnelTerm(viewDirection: vec3f,worldNormal: vec3f,bias: f32,power: f32)->f32\n{let fresnelTerm: f32=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}\n#endif\n";n.l.IncludesShadersStoreWGSL[s]||(n.l.IncludesShadersStoreWGSL[s]=i)},40242:(e,t,r)=>{var n=r(69610);const s="bakedVertexAnimation",i="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\n{\n#ifdef INSTANCES\nlet VATStartFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.x;let VATEndFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.y;let VATOffsetFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.z;let VATSpeed: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.w;\n#else\nlet VATStartFrame: f32=uniforms.bakedVertexAnimationSettings.x;let VATEndFrame: f32=uniforms.bakedVertexAnimationSettings.y;let VATOffsetFrame: f32=uniforms.bakedVertexAnimationSettings.z;let VATSpeed: f32=uniforms.bakedVertexAnimationSettings.w;\n#endif\nlet totalFrames: f32=VATEndFrame-VATStartFrame+1.0;let time: f32=uniforms.bakedVertexAnimationTime*VATSpeed/totalFrames;let frameCorrection: f32=select(1.0,0.0,time<1.0);let numOfFrames: f32=totalFrames-frameCorrection;var VATFrameNum: f32=fract(time)*numOfFrames;VATFrameNum=(VATFrameNum+VATOffsetFrame) % numOfFrames;VATFrameNum=floor(VATFrameNum);VATFrameNum=VATFrameNum+VATStartFrame+frameCorrection;var VATInfluence : mat4x4<f32>;VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[0],VATFrameNum)*vertexInputs.matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[1],VATFrameNum)*vertexInputs.matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[2],VATFrameNum)*vertexInputs.matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[3],VATFrameNum)*vertexInputs.matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[0],VATFrameNum)*vertexInputs.matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[1],VATFrameNum)*vertexInputs.matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[2],VATFrameNum)*vertexInputs.matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[3],VATFrameNum)*vertexInputs.matricesWeightsExtra[3];\n#endif\nfinalWorld=finalWorld*VATInfluence;}\n#endif\n";n.l.IncludesShadersStoreWGSL[s]||(n.l.IncludesShadersStoreWGSL[s]=i)},40768:(e,t,r)=>{r.d(t,{WebGPUEngine:()=>$t});var n=r(51137),s=r(79323),i=r(84867);class a{static ComputeNumMipmapLevels(e,t){return(0,i.ILog2)(Math.max(e,t))+1}static GetTextureTypeFromFormat(e){switch(e){case"r8unorm":case"r8uint":case"rg8unorm":case"rg8uint":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8uint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb10a2uint":case"rgb10a2unorm":case"rgb9e5ufloat":case"rg11b10ufloat":case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc6h-rgb-ufloat":case"bc5-rg-unorm":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc4-r-unorm":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-r11unorm":case"eac-rg11unorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":case"stencil8":return 0;case"r8snorm":case"r8sint":case"rg8snorm":case"rg8sint":case"rgba8snorm":case"rgba8sint":case"bc6h-rgb-float":case"bc5-rg-snorm":case"bc4-r-snorm":case"eac-r11snorm":case"eac-rg11snorm":return 3;case"r16uint":case"r16unorm":case"rg16unorm":case"rgba16unorm":case"rg16uint":case"rgba16uint":case"depth16unorm":return 5;case"r16sint":case"r16snorm":case"rg16snorm":case"rgba16snorm":case"rg16sint":case"rgba16sint":return 4;case"r16float":case"rg16float":case"rgba16float":return 2;case"r32uint":case"rg32uint":case"rgba32uint":case"r32sint":case"rg32sint":case"rgba32sint":return 7;case"r32float":case"rg32float":case"rgba32float":case"depth32float":case"depth32float-stencil8":case"depth24plus":case"depth24plus-stencil8":return 1}return 0}static GetBlockInformationFromFormat(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":return{width:1,height:1,length:1};case"r16uint":case"r16sint":case"r16unorm":case"r16snorm":case"r16float":case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":case"depth16unorm":return{width:1,height:1,length:2};case"r32uint":case"r32sint":case"r32float":case"rg16uint":case"rg16sint":case"rg16float":case"rg16unorm":case"rg16snorm":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb9e5ufloat":case"rgb10a2uint":case"rgb10a2unorm":case"rg11b10ufloat":case"depth32float":return{width:1,height:1,length:4};case"rg32uint":case"rg32sint":case"rg32float":case"rgba16uint":case"rgba16sint":case"rgba16float":case"rgba16unorm":case"rgba16snorm":return{width:1,height:1,length:8};case"rgba32uint":case"rgba32sint":case"rgba32float":return{width:1,height:1,length:16};case"stencil8":throw"No fixed size for Stencil8 format!";case"depth24plus":throw"No fixed size for Depth24Plus format!";case"depth24plus-stencil8":throw"No fixed size for Depth24PlusStencil8 format!";case"depth32float-stencil8":return{width:1,height:1,length:5};case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"bc5-rg-unorm":case"bc5-rg-snorm":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-rg11unorm":case"eac-rg11snorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":return{width:4,height:4,length:16};case"bc4-r-unorm":case"bc4-r-snorm":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"eac-r11unorm":case"eac-r11snorm":return{width:4,height:4,length:8};case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":return{width:5,height:4,length:16};case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":return{width:5,height:5,length:16};case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":return{width:6,height:5,length:16};case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":return{width:6,height:6,length:16};case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":return{width:8,height:5,length:16};case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":return{width:8,height:6,length:16};case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":return{width:8,height:8,length:16};case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":return{width:10,height:5,length:16};case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":return{width:10,height:6,length:16};case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":return{width:10,height:8,length:16};case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":return{width:10,height:10,length:16};case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":return{width:12,height:10,length:16};case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return{width:12,height:12,length:16}}return{width:1,height:1,length:4}}static IsHardwareTexture(e){return!!e.release}static IsInternalTexture(e){return!!e.dispose}static IsImageBitmap(e){return void 0!==e.close}static IsImageBitmapArray(e){return Array.isArray(e)&&void 0!==e[0].close}static IsCompressedFormat(e){switch(e){case"bc7-rgba-unorm-srgb":case"bc7-rgba-unorm":case"bc6h-rgb-float":case"bc6h-rgb-ufloat":case"bc5-rg-snorm":case"bc5-rg-unorm":case"bc4-r-snorm":case"bc4-r-unorm":case"bc3-rgba-unorm-srgb":case"bc3-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc1-rgba-unorm-srgb":case"bc1-rgba-unorm":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-r11unorm":case"eac-r11snorm":case"eac-rg11unorm":case"eac-rg11snorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return!0}return!1}static GetWebGPUTextureFormat(e,t,r=!1){switch(t){case 15:return"depth16unorm";case 16:return"depth24plus";case 13:return"depth24plus-stencil8";case 14:return"depth32float";case 18:return"depth32float-stencil8";case 19:return"stencil8";case 36492:return r?"bc7-rgba-unorm-srgb":"bc7-rgba-unorm";case 36495:return"bc6h-rgb-ufloat";case 36494:return"bc6h-rgb-float";case 33779:return r?"bc3-rgba-unorm-srgb":"bc3-rgba-unorm";case 33778:return r?"bc2-rgba-unorm-srgb":"bc2-rgba-unorm";case 33777:case 33776:return r?"bc1-rgba-unorm-srgb":"bc1-rgba-unorm";case 37808:return r?"astc-4x4-unorm-srgb":"astc-4x4-unorm";case 36196:case 37492:return r?"etc2-rgb8unorm-srgb":"etc2-rgb8unorm";case 37496:return r?"etc2-rgba8unorm-srgb":"etc2-rgba8unorm"}switch(e){case 3:switch(t){case 6:return"r8snorm";case 7:return"rg8snorm";case 4:throw"RGB format not supported in WebGPU";case 8:return"r8sint";case 9:return"rg8sint";case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return"rgba8sint";default:return"rgba8snorm"}case 0:switch(t){case 6:return"r8unorm";case 7:return"rg8unorm";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return r?"rgba8unorm-srgb":"rgba8unorm";case 12:return r?"bgra8unorm-srgb":"bgra8unorm";case 8:return"r8uint";case 9:return"rg8uint";case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return"rgba8uint";case 0:throw"TEXTUREFORMAT_ALPHA format not supported in WebGPU";case 1:throw"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case 2:throw"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return"rgba8unorm"}case 4:switch(t){case 8:return"r16sint";case 9:return"rg16sint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return"rgba16sint"}case 5:switch(t){case 8:return"r16uint";case 9:return"rg16uint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return"rgba16uint"}case 6:switch(t){case 8:return"r32sint";case 9:return"rg32sint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return"rgba32sint"}case 7:switch(t){case 8:return"r32uint";case 9:return"rg32uint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return"rgba32uint"}case 1:switch(t){case 6:return"r32float";case 7:return"rg32float";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";default:return"rgba32float"}case 2:switch(t){case 6:return"r16float";case 7:return"rg16float";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";default:return"rgba16float"}case 10:throw"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case 13:switch(t){case 5:default:return"rg11b10ufloat";case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV"}case 14:switch(t){case 5:default:return"rgb9e5ufloat";case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV"}case 8:throw"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case 9:throw"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case 11:switch(t){case 5:default:return"rgb10a2unorm";case 11:return"rgb10a2uint"}}return r?"rgba8unorm-srgb":"rgba8unorm"}static GetNumChannelsFromWebGPUTextureFormat(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":case"bc4-r-unorm":case"bc4-r-snorm":case"r16uint":case"r16sint":case"depth16unorm":case"r16float":case"r16unorm":case"r16snorm":case"r32uint":case"r32sint":case"r32float":case"depth32float":case"stencil8":case"depth24plus":case"eac-r11unorm":case"eac-r11snorm":return 1;case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":case"depth32float-stencil8":case"bc5-rg-unorm":case"bc5-rg-snorm":case"rg16uint":case"rg16sint":case"rg16float":case"rg16unorm":case"rg16snorm":case"rg32uint":case"rg32sint":case"rg32float":case"depth24plus-stencil8":case"eac-rg11unorm":case"eac-rg11snorm":return 2;case"rgb9e5ufloat":case"rg11b10ufloat":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":return 3;case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgba16unorm":case"rgba16snorm":case"rgb10a2uint":case"rgb10a2unorm":case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"rgba16uint":case"rgba16sint":case"rgba16float":case"rgba32uint":case"rgba32sint":case"rgba32float":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return 4}throw`Unknown format ${e}!`}static HasStencilAspect(e){switch(e){case"stencil8":case"depth32float-stencil8":case"depth24plus-stencil8":return!0}return!1}static HasDepthAndStencilAspects(e){switch(e){case"depth32float-stencil8":case"depth24plus-stencil8":return!0}return!1}static GetDepthFormatOnly(e){switch(e){case"depth16unorm":return"depth16unorm";case"depth24plus":case"depth24plus-stencil8":return"depth24plus";case"depth32float":case"depth32float-stencil8":return"depth32float"}return e}static GetSample(e){return e>1?4:1}}var o=r(24296);class u{constructor(){this._gpuTimeInFrameId=-1,this.counter=new o.A}_addDuration(e,t){e<this._gpuTimeInFrameId||(this._gpuTimeInFrameId!==e?(this.counter._fetchResult(),this.counter.fetchNewFrame(),this.counter.addCount(t,!1),this._gpuTimeInFrameId=e):this.counter.addCount(t,!1))}}class c extends s.${constructor(){super(...arguments),this.dbgShowShaderCode=!1,this.dbgSanityChecks=!0,this.dbgVerboseLogsNumFrames=10,this.dbgLogIfNotDrawWrapper=!0,this.dbgShowEmptyEnableEffectCalls=!0,this.dbgVerboseLogsForFirstFrames=!1,this._currentRenderPass=null,this._snapshotRenderingMode=0,this._timestampIndex=0,this._debugStackRenderPass=[]}get enableGPUTimingMeasurements(){return this._timestampQuery.enable}set enableGPUTimingMeasurements(e){this._timestampQuery.enable!==e&&(this.gpuTimeInFrameForMainPass=e?new u:void 0,this._timestampQuery.enable=e)}_currentPassIsMainPass(){return null===this._currentRenderTarget}_endCurrentRenderPass(){if(!this._currentRenderPass)return 0;if(0!==this._debugStackRenderPass.length)for(let e=0;e<this._debugStackRenderPass.length;++e)this._currentRenderPass.popDebugGroup();const e=this._currentPassIsMainPass()?2:1;return this._snapshotRendering.endRenderPass(this._currentRenderPass)||this.compatibilityMode||(this._bundleList.run(this._currentRenderPass),this._bundleList.reset()),this._currentRenderPass.end(),this._timestampQuery.endPass(this._timestampIndex,this._currentRenderTarget&&this._currentRenderTarget.gpuTimeInFrame?this._currentRenderTarget.gpuTimeInFrame:this.gpuTimeInFrameForMainPass),this._timestampIndex+=2,this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&n.V.Log("frame #"+this._count+" - "+(2===e?"main":"render target")+" end pass"+(1===e?" - internalTexture.uniqueId="+this._currentRenderTarget?.texture?.uniqueId:""))),this._debugPopGroup?.(0),this._currentRenderPass=null,e}_generateMipmaps(e,t){t=t??this._renderEncoder;const r=e._hardwareTexture;if(!r)return;t===this._renderEncoder&&this._endCurrentRenderPass();const s=e._hardwareTexture.format,i=a.ComputeNumMipmapLevels(e.width,e.height);this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&n.V.Log("frame #"+this._count+" - generate mipmaps - width="+e.width+", height="+e.height+", isCube="+e.isCube+", command encoder="+(t===this._renderEncoder?"render":"copy"))),e.isCube?this._textureHelper.generateCubeMipmaps(r,s,i,t):this._textureHelper.generateMipmaps(r,s,i,0,e.is3D,t)}}var l,h,d,p,f,g,m,_,b,x,y,S,v,C,w,T,I,B,R,A,F,P,D,L,E,M,O,G,U,V,N,W,$,k,q,H,Y,Q,z,X,K,j=r(62956),J=r(90854),Z=r(74420);!function(e){e.LowPower="low-power",e.HighPerformance="high-performance"}(l||(l={})),function(e){e.CoreFeaturesAndLimits="core-features-and-limits",e.DepthClipControl="depth-clip-control",e.Depth32FloatStencil8="depth32float-stencil8",e.TextureCompressionBC="texture-compression-bc",e.TextureCompressionBCSliced3D="texture-compression-bc-sliced-3d",e.TextureCompressionETC2="texture-compression-etc2",e.TextureCompressionASTC="texture-compression-astc",e.TextureCompressionASTCSliced3D="texture-compression-astc-sliced-3d",e.TimestampQuery="timestamp-query",e.IndirectFirstInstance="indirect-first-instance",e.ShaderF16="shader-f16",e.RG11B10UFloatRenderable="rg11b10ufloat-renderable",e.BGRA8UnormStorage="bgra8unorm-storage",e.Float32Filterable="float32-filterable",e.Float32Blendable="float32-blendable",e.ClipDistances="clip-distances",e.DualSourceBlending="dual-source-blending",e.Subgroups="subgroups",e.TextureFormatsTier1="texture-formats-tier1",e.TextureFormatsTier2="texture-formats-tier2"}(h||(h={})),function(e){e.Unmapped="unmapped",e.Pending="pending",e.Mapped="mapped"}(d||(d={})),function(e){e[e.MapRead=1]="MapRead",e[e.MapWrite=2]="MapWrite",e[e.CopySrc=4]="CopySrc",e[e.CopyDst=8]="CopyDst",e[e.Index=16]="Index",e[e.Vertex=32]="Vertex",e[e.Uniform=64]="Uniform",e[e.Storage=128]="Storage",e[e.Indirect=256]="Indirect",e[e.QueryResolve=512]="QueryResolve"}(p||(p={})),function(e){e[e.Read=1]="Read",e[e.Write=2]="Write"}(f||(f={})),function(e){e.E1d="1d",e.E2d="2d",e.E3d="3d"}(g||(g={})),function(e){e[e.CopySrc=1]="CopySrc",e[e.CopyDst=2]="CopyDst",e[e.TextureBinding=4]="TextureBinding",e[e.StorageBinding=8]="StorageBinding",e[e.RenderAttachment=16]="RenderAttachment"}(m||(m={})),function(e){e.E1d="1d",e.E2d="2d",e.E2dArray="2d-array",e.Cube="cube",e.CubeArray="cube-array",e.E3d="3d"}(_||(_={})),function(e){e.All="all",e.StencilOnly="stencil-only",e.DepthOnly="depth-only"}(b||(b={})),function(e){e.R8Unorm="r8unorm",e.R8Snorm="r8snorm",e.R8Uint="r8uint",e.R8Sint="r8sint",e.R16Uint="r16uint",e.R16Sint="r16sint",e.R16Float="r16float",e.RG8Unorm="rg8unorm",e.RG8Snorm="rg8snorm",e.RG8Uint="rg8uint",e.RG8Sint="rg8sint",e.R16Unorm="r16unorm",e.R16Snorm="r16snorm",e.R32Uint="r32uint",e.R32Sint="r32sint",e.R32Float="r32float",e.RG16Uint="rg16uint",e.RG16Sint="rg16sint",e.RG16Float="rg16float",e.RGBA8Unorm="rgba8unorm",e.RGBA8UnormSRGB="rgba8unorm-srgb",e.RGBA8Snorm="rgba8snorm",e.RGBA8Uint="rgba8uint",e.RGBA8Sint="rgba8sint",e.BGRA8Unorm="bgra8unorm",e.BGRA8UnormSRGB="bgra8unorm-srgb",e.RG16Unorm="rg16unorm",e.RG16Snorm="rg16snorm",e.RGB9E5UFloat="rgb9e5ufloat",e.RGB10A2UINT="rgb10a2uint",e.RGB10A2Unorm="rgb10a2unorm",e.RG11B10UFloat="rg11b10ufloat",e.RG32Uint="rg32uint",e.RG32Sint="rg32sint",e.RG32Float="rg32float",e.RGBA16Uint="rgba16uint",e.RGBA16Sint="rgba16sint",e.RGBA16Float="rgba16float",e.RGBA16Unorm="rgba16unorm",e.RGBA16Snorm="rgba16snorm",e.RGBA32Uint="rgba32uint",e.RGBA32Sint="rgba32sint",e.RGBA32Float="rgba32float",e.Stencil8="stencil8",e.Depth16Unorm="depth16unorm",e.Depth24Plus="depth24plus",e.Depth24PlusStencil8="depth24plus-stencil8",e.Depth32Float="depth32float",e.BC1RGBAUnorm="bc1-rgba-unorm",e.BC1RGBAUnormSRGB="bc1-rgba-unorm-srgb",e.BC2RGBAUnorm="bc2-rgba-unorm",e.BC2RGBAUnormSRGB="bc2-rgba-unorm-srgb",e.BC3RGBAUnorm="bc3-rgba-unorm",e.BC3RGBAUnormSRGB="bc3-rgba-unorm-srgb",e.BC4RUnorm="bc4-r-unorm",e.BC4RSnorm="bc4-r-snorm",e.BC5RGUnorm="bc5-rg-unorm",e.BC5RGSnorm="bc5-rg-snorm",e.BC6HRGBUFloat="bc6h-rgb-ufloat",e.BC6HRGBFloat="bc6h-rgb-float",e.BC7RGBAUnorm="bc7-rgba-unorm",e.BC7RGBAUnormSRGB="bc7-rgba-unorm-srgb",e.ETC2RGB8Unorm="etc2-rgb8unorm",e.ETC2RGB8UnormSRGB="etc2-rgb8unorm-srgb",e.ETC2RGB8A1Unorm="etc2-rgb8a1unorm",e.ETC2RGB8A1UnormSRGB="etc2-rgb8a1unorm-srgb",e.ETC2RGBA8Unorm="etc2-rgba8unorm",e.ETC2RGBA8UnormSRGB="etc2-rgba8unorm-srgb",e.EACR11Unorm="eac-r11unorm",e.EACR11Snorm="eac-r11snorm",e.EACRG11Unorm="eac-rg11unorm",e.EACRG11Snorm="eac-rg11snorm",e.ASTC4x4Unorm="astc-4x4-unorm",e.ASTC4x4UnormSRGB="astc-4x4-unorm-srgb",e.ASTC5x4Unorm="astc-5x4-unorm",e.ASTC5x4UnormSRGB="astc-5x4-unorm-srgb",e.ASTC5x5Unorm="astc-5x5-unorm",e.ASTC5x5UnormSRGB="astc-5x5-unorm-srgb",e.ASTC6x5Unorm="astc-6x5-unorm",e.ASTC6x5UnormSRGB="astc-6x5-unorm-srgb",e.ASTC6x6Unorm="astc-6x6-unorm",e.ASTC6x6UnormSRGB="astc-6x6-unorm-srgb",e.ASTC8x5Unorm="astc-8x5-unorm",e.ASTC8x5UnormSRGB="astc-8x5-unorm-srgb",e.ASTC8x6Unorm="astc-8x6-unorm",e.ASTC8x6UnormSRGB="astc-8x6-unorm-srgb",e.ASTC8x8Unorm="astc-8x8-unorm",e.ASTC8x8UnormSRGB="astc-8x8-unorm-srgb",e.ASTC10x5Unorm="astc-10x5-unorm",e.ASTC10x5UnormSRGB="astc-10x5-unorm-srgb",e.ASTC10x6Unorm="astc-10x6-unorm",e.ASTC10x6UnormSRGB="astc-10x6-unorm-srgb",e.ASTC10x8Unorm="astc-10x8-unorm",e.ASTC10x8UnormSRGB="astc-10x8-unorm-srgb",e.ASTC10x10Unorm="astc-10x10-unorm",e.ASTC10x10UnormSRGB="astc-10x10-unorm-srgb",e.ASTC12x10Unorm="astc-12x10-unorm",e.ASTC12x10UnormSRGB="astc-12x10-unorm-srgb",e.ASTC12x12Unorm="astc-12x12-unorm",e.ASTC12x12UnormSRGB="astc-12x12-unorm-srgb",e.Depth32FloatStencil8="depth32float-stencil8"}(x||(x={})),function(e){e.ClampToEdge="clamp-to-edge",e.Repeat="repeat",e.MirrorRepeat="mirror-repeat"}(y||(y={})),function(e){e.Nearest="nearest",e.Linear="linear"}(S||(S={})),function(e){e.Nearest="nearest",e.Linear="linear"}(v||(v={})),function(e){e.Never="never",e.Less="less",e.Equal="equal",e.LessEqual="less-equal",e.Greater="greater",e.NotEqual="not-equal",e.GreaterEqual="greater-equal",e.Always="always"}(C||(C={})),function(e){e[e.Vertex=1]="Vertex",e[e.Fragment=2]="Fragment",e[e.Compute=4]="Compute"}(w||(w={})),function(e){e.Uniform="uniform",e.Storage="storage",e.ReadOnlyStorage="read-only-storage"}(T||(T={})),function(e){e.Filtering="filtering",e.NonFiltering="non-filtering",e.Comparison="comparison"}(I||(I={})),function(e){e.Float="float",e.UnfilterableFloat="unfilterable-float",e.Depth="depth",e.Sint="sint",e.Uint="uint"}(B||(B={})),function(e){e.WriteOnly="write-only",e.ReadOnly="read-only",e.ReadWrite="read-write"}(R||(R={})),function(e){e.Error="error",e.Warning="warning",e.Info="info"}(A||(A={})),function(e){e.Validation="validation",e.Internal="internal"}(F||(F={})),function(e){e.Auto="auto"}(P||(P={})),function(e){e.PointList="point-list",e.LineList="line-list",e.LineStrip="line-strip",e.TriangleList="triangle-list",e.TriangleStrip="triangle-strip"}(D||(D={})),function(e){e.CCW="ccw",e.CW="cw"}(L||(L={})),function(e){e.None="none",e.Front="front",e.Back="back"}(E||(E={})),function(e){e[e.Red=1]="Red",e[e.Green=2]="Green",e[e.Blue=4]="Blue",e[e.Alpha=8]="Alpha",e[e.All=15]="All"}(M||(M={})),function(e){e.Zero="zero",e.One="one",e.Src="src",e.OneMinusSrc="one-minus-src",e.SrcAlpha="src-alpha",e.OneMinusSrcAlpha="one-minus-src-alpha",e.Dst="dst",e.OneMinusDst="one-minus-dst",e.DstAlpha="dst-alpha",e.OneMinusDstAlpha="one-minus-dst-alpha",e.SrcAlphaSaturated="src-alpha-saturated",e.Constant="constant",e.OneMinusConstant="one-minus-constant",e.Src1="src1",e.OneMinusSrc1="one-minus-src1",e.Src1Alpha="src1-alpha",e.OneMinusSrc1Alpha="one-minus-src1-alpha"}(O||(O={})),function(e){e.Add="add",e.Subtract="subtract",e.ReverseSubtract="reverse-subtract",e.Min="min",e.Max="max"}(G||(G={})),function(e){e.Keep="keep",e.Zero="zero",e.Replace="replace",e.Invert="invert",e.IncrementClamp="increment-clamp",e.DecrementClamp="decrement-clamp",e.IncrementWrap="increment-wrap",e.DecrementWrap="decrement-wrap"}(U||(U={})),function(e){e.Uint16="uint16",e.Uint32="uint32"}(V||(V={})),function(e){e.Uint8="uint8",e.Uint8x2="uint8x2",e.Uint8x4="uint8x4",e.Sint8="sint8",e.Sint8x2="sint8x2",e.Sint8x4="sint8x4",e.Unorm8="unorm8",e.Unorm8x2="unorm8x2",e.Unorm8x4="unorm8x4",e.Snorm8="snorm8",e.Snorm8x2="snorm8x2",e.Snorm8x4="snorm8x4",e.Uint16="uint16",e.Uint16x2="uint16x2",e.Uint16x4="uint16x4",e.Sint16="sint16",e.Sint16x2="sint16x2",e.Sint16x4="sint16x4",e.Unorm16="unorm16",e.Unorm16x2="unorm16x2",e.Unorm16x4="unorm16x4",e.Snorm16="snorm16",e.Snorm16x2="snorm16x2",e.Snorm16x4="snorm16x4",e.Float16="float16",e.Float16x2="float16x2",e.Float16x4="float16x4",e.Float32="float32",e.Float32x2="float32x2",e.Float32x3="float32x3",e.Float32x4="float32x4",e.Uint32="uint32",e.Uint32x2="uint32x2",e.Uint32x3="uint32x3",e.Uint32x4="uint32x4",e.Sint32="sint32",e.Sint32x2="sint32x2",e.Sint32x3="sint32x3",e.Sint32x4="sint32x4",e.UNORM10x10x10x2="unorm10-10-10-2",e.UNORM8x4BGRA="unorm8x4-bgra"}(N||(N={})),function(e){e.Vertex="vertex",e.Instance="instance"}(W||(W={})),function(e){e.Beginning="beginning",e.End="end"}($||($={})),function(e){e.Beginning="beginning",e.End="end"}(k||(k={})),function(e){e.Load="load",e.Clear="clear"}(q||(q={})),function(e){e.Store="store",e.Discard="discard"}(H||(H={})),function(e){e.Occlusion="occlusion",e.Timestamp="timestamp"}(Y||(Y={})),function(e){e.Opaque="opaque",e.Premultiplied="premultiplied"}(Q||(Q={})),function(e){e.Standard="standard",e.Extended="extended"}(z||(z={})),function(e){e.Unknown="unknown",e.Destroyed="destroyed"}(X||(X={})),function(e){e.Validation="validation",e.OutOfMemory="out-of-memory",e.Internal="internal"}(K||(K={}));var ee=r(95616),te=r(80935);class re{constructor(){this.shaderLanguage=0}_addUniformToLeftOverUBO(e,t,r){let n=0;[e,t,n]=this._getArraySize(e,t,r);for(let t=0;t<this._webgpuProcessingContext.leftOverUniforms.length;t++)if(this._webgpuProcessingContext.leftOverUniforms[t].name===e)return;this._webgpuProcessingContext.leftOverUniforms.push({name:e,type:t,length:n})}_buildLeftOverUBO(){if(!this._webgpuProcessingContext.leftOverUniforms.length)return"";const e=re.LeftOvertUBOName;let t=this._webgpuProcessingContext.availableBuffers[e];return t||(t={binding:this._webgpuProcessingContext.getNextFreeUBOBinding()},this._webgpuProcessingContext.availableBuffers[e]=t,this._addBufferBindingDescription(e,t,"uniform",!0),this._addBufferBindingDescription(e,t,"uniform",!1)),this._generateLeftOverUBOCode(e,t)}_collectBindingNames(){for(let e=0;e<this._webgpuProcessingContext.bindGroupLayoutEntries.length;e++){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[e];if(void 0!==t)for(let r=0;r<t.length;r++){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[e][r],n=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][t.binding].name,s=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][t.binding].nameInArrayOfTexture;t&&(t.texture||t.externalTexture||t.storageTexture?this._webgpuProcessingContext.textureNames.push(s):t.sampler?this._webgpuProcessingContext.samplerNames.push(n):t.buffer&&this._webgpuProcessingContext.bufferNames.push(n))}else this._webgpuProcessingContext.bindGroupLayoutEntries[e]=[]}}_preCreateBindGroupEntries(){const e=this._webgpuProcessingContext.bindGroupEntries;for(let t=0;t<this._webgpuProcessingContext.bindGroupLayoutEntries.length;t++){const r=this._webgpuProcessingContext.bindGroupLayoutEntries[t],n=[];for(let e=0;e<r.length;e++){const r=this._webgpuProcessingContext.bindGroupLayoutEntries[t][e];r.sampler||r.texture||r.storageTexture||r.externalTexture?n.push({binding:r.binding,resource:void 0}):r.buffer&&n.push({binding:r.binding,resource:{buffer:void 0,offset:0,size:0}})}e[t]=n}}_addTextureBindingDescription(e,t,r,n,s,i){let{groupIndex:a,bindingIndex:o}=t.textures[r];if(this._webgpuProcessingContext.bindGroupLayoutEntries[a]||(this._webgpuProcessingContext.bindGroupLayoutEntries[a]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][o]){let i;i=null===n?this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:o,visibility:0,externalTexture:{}}):s?this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:o,visibility:0,storageTexture:{access:"write-only",format:s,viewDimension:n}}):this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:o,visibility:0,texture:{sampleType:t.sampleType,viewDimension:n,multisampled:!1}});const u=t.isTextureArray?e+r:e;this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][o]={name:e,index:i-1,nameInArrayOfTexture:u}}o=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][o].index,this._webgpuProcessingContext.bindGroupLayoutEntries[a][o].visibility|=i?1:2}_addSamplerBindingDescription(e,t,r){let{groupIndex:n,bindingIndex:s}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[n]||(this._webgpuProcessingContext.bindGroupLayoutEntries[n]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][s]){const r=this._webgpuProcessingContext.bindGroupLayoutEntries[n].push({binding:s,visibility:0,sampler:{type:t.type}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][s]={name:e,index:r-1}}s=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][s].index,this._webgpuProcessingContext.bindGroupLayoutEntries[n][s].visibility|=r?1:2}_addBufferBindingDescription(e,t,r,n){let{groupIndex:s,bindingIndex:i}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[s]||(this._webgpuProcessingContext.bindGroupLayoutEntries[s]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][i]){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[s].push({binding:i,visibility:0,buffer:{type:r}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][i]={name:e,index:t-1}}i=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][i].index,this._webgpuProcessingContext.bindGroupLayoutEntries[s][i].visibility|=n?1:2}}re.LeftOvertUBOName="LeftOver",re.InternalsUBOName="Internals",re.UniformSizes={bool:1,int:1,float:1,vec2:2,ivec2:2,uvec2:2,vec3:3,ivec3:3,uvec3:3,vec4:4,ivec4:4,uvec4:4,mat2:4,mat3:12,mat4:16,i32:1,u32:1,f32:1,mat2x2:4,mat3x3:12,mat4x4:16,mat2x2f:4,mat3x3f:12,mat4x4f:16,vec2i:2,vec3i:3,vec4i:4,vec2u:2,vec3u:3,vec4u:4,vec2f:2,vec3f:3,vec4f:4,vec2h:1,vec3h:2,vec4h:2},re._SamplerFunctionByWebGLSamplerType={sampler2D:"sampler2D",sampler2DArray:"sampler2DArray",sampler2DShadow:"sampler2DShadow",sampler2DArrayShadow:"sampler2DArrayShadow",samplerCube:"samplerCube",sampler3D:"sampler3D"},re._TextureTypeByWebGLSamplerType={sampler2D:"texture2D",sampler2DArray:"texture2DArray",sampler2DShadow:"texture2D",sampler2DArrayShadow:"texture2DArray",samplerCube:"textureCube",samplerCubeArray:"textureCubeArray",sampler3D:"texture3D"},re._GpuTextureViewDimensionByWebGPUTextureType={textureCube:"cube",textureCubeArray:"cube-array",texture2D:"2d",texture2DArray:"2d-array",texture3D:"3d"},re._SamplerTypeByWebGLSamplerType={sampler2DShadow:"samplerShadow",sampler2DArrayShadow:"samplerShadow"},re._IsComparisonSamplerByWebGPUSamplerType={samplerShadow:!0,samplerArrayShadow:!0,sampler:!1};class ne{get isAsync(){return!1}get isReady(){return!!this.stages}constructor(e,t){this.bindGroupLayouts={},this._name="unnamed",this.shaderProcessingContext=e,this._leftOverUniformsByName={},this.engine=t,this.vertexBufferKindToType={}}_handlesSpectorRebuildCallback(){}_fillEffectInformation(e,t,r,n,s,i,a,o){const u=this.engine;u._doNotHandleContextLost&&(e._fragmentSourceCode="",e._vertexSourceCode="");const c=this.shaderProcessingContext.availableTextures;let l;for(l=0;l<s.length;l++){const e=s[l],t=c[s[l]];null==t||null==t?(s.splice(l,1),l--):i[e]=l}for(const e of u.getAttributes(this,a))o.push(e);this.buildUniformLayout();const h=[],d=[];for(l=0;l<a.length;l++){const e=o[l];e>=0&&(h.push(a[l]),d.push(e))}this.shaderProcessingContext.attributeNamesFromEffect=h,this.shaderProcessingContext.attributeLocationsFromEffect=d}buildUniformLayout(){if(this.shaderProcessingContext.leftOverUniforms.length){this.uniformBuffer?.dispose(),this.uniformBuffer=new te.D(this.engine,void 0,void 0,"leftOver-"+this._name);for(const e of this.shaderProcessingContext.leftOverUniforms){const t=e.type.replace(/^(.*?)(<.*>)?$/,"$1"),r=re.UniformSizes[t];this.uniformBuffer.addUniform(e.name,r,e.length),this._leftOverUniformsByName[e.name]=e.type}this.uniformBuffer.create()}}setEngine(e){this.engine=e}dispose(){this.uniformBuffer&&this.uniformBuffer.dispose()}setInt(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt(e,t)}setInt2(e,t,r){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt2(e,t,r)}setInt3(e,t,r,n){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt3(e,t,r,n)}setInt4(e,t,r,n,s){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt4(e,t,r,n,s)}setIntArray(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateIntArray(e,t)}setIntArray2(e,t){this.setIntArray(e,t)}setIntArray3(e,t){this.setIntArray(e,t)}setIntArray4(e,t){this.setIntArray(e,t)}setUInt(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt(e,t)}setUInt2(e,t,r){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt2(e,t,r)}setUInt3(e,t,r,n){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt3(e,t,r,n)}setUInt4(e,t,r,n,s){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt4(e,t,r,n,s)}setUIntArray(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUIntArray(e,t)}setUIntArray2(e,t){this.setUIntArray(e,t)}setUIntArray3(e,t){this.setUIntArray(e,t)}setUIntArray4(e,t){this.setUIntArray(e,t)}setArray(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateArray(e,t)}setArray2(e,t){this.setArray(e,t)}setArray3(e,t){this.setArray(e,t)}setArray4(e,t){this.setArray(e,t)}setMatrices(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrices(e,t)}setMatrix(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrix(e,t)}setMatrix3x3(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrix3x3(e,t)}setMatrix2x2(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrix2x2(e,t)}setFloat(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat(e,t)}setVector2(e,t){this.setFloat2(e,t.x,t.y)}setFloat2(e,t,r){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat2(e,t,r)}setVector3(e,t){this.setFloat3(e,t.x,t.y,t.z)}setFloat3(e,t,r,n){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat3(e,t,r,n)}setVector4(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setQuaternion(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setFloat4(e,t,r,n,s){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat4(e,t,r,n,s)}setColor3(e,t){this.setFloat3(e,t.r,t.g,t.b)}setColor4(e,t,r){this.setFloat4(e,t.r,t.g,t.b,r)}setDirectColor4(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)}_getVertexShaderCode(){return this.sources?.vertex}_getFragmentShaderCode(){return this.sources?.fragment}}const se={mat2:2,mat3:3,mat4:4,mat2x2:2,mat3x3:3,mat4x4:4};class ie{static get KnownUBOs(){return ie._SimplifiedKnownBindings?ie._SimplifiedKnownUBOs:ie._KnownUBOs}constructor(e,t=!1){this.vertexBufferKindToNumberOfComponents={},this.shaderLanguage=e,this._attributeNextLocation=0,this._varyingNextLocation=0,this.freeGroupIndex=0,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableBuffers={},this.availableTextures={},this.availableSamplers={},this.orderedAttributes=[],this.bindGroupLayoutEntries=[],this.bindGroupLayoutEntryInfo=[],this.bindGroupEntries=[],this.bufferNames=[],this.textureNames=[],this.samplerNames=[],this.leftOverUniforms=[],t||this._findStartingGroupBinding()}_findStartingGroupBinding(){const e=ie.KnownUBOs,t=[];for(const r in e){const n=e[r].binding;-1!==n.groupIndex&&(void 0===t[n.groupIndex]?t[n.groupIndex]=n.bindingIndex:t[n.groupIndex]=Math.max(t[n.groupIndex],n.bindingIndex))}this.freeGroupIndex=t.length-1,0===this.freeGroupIndex?(this.freeGroupIndex++,this.freeBindingIndex=0):this.freeBindingIndex=t[t.length-1]+1}getAttributeNextLocation(e,t=0){const r=this._attributeNextLocation;return this._attributeNextLocation+=(se[e]??1)*(t||1),r}getVaryingNextLocation(e,t=0){const r=this._varyingNextLocation;return this._varyingNextLocation+=(se[e]??1)*(t||1),r}getNextFreeUBOBinding(){return this._getNextFreeBinding(1)}_getNextFreeBinding(e){if(this.freeBindingIndex>65536-e&&(this.freeGroupIndex++,this.freeBindingIndex=0),4===this.freeGroupIndex)throw"Too many textures or UBOs have been declared and it is not supported in WebGPU.";const t={groupIndex:this.freeGroupIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=e,t}}function ae(e,t,r,n){let s=n,i=0,a="";for(;s<r.length;){const n=r.charAt(s);if(a)n===a?'"'===a||"'"===a?"\\"!==r.charAt(s-1)&&(a=""):a="":"*/"===a&&"*"===n&&s+1<r.length&&("/"===r.charAt(s+1)&&(a=""),""===a&&s++);else switch(n){case e:i++;break;case t:i--;break;case'"':case"'":case"`":a=n;break;case"/":if(s+1<r.length){const e=r.charAt(s+1);"/"===e?a="\n":"*"===e&&(a="*/")}}if(s++,0===i)break}return 0===i?s-1:-1}function oe(e,t){for(;t<e.length;){const r=e[t];if(" "!==r&&"\n"!==r&&"\r"!==r&&"\t"!==r&&"\n"!==r&&" "!==r)break;t++}return t}function ue(e){const t=e.charCodeAt(0);return t>=48&&t<=57||t>=65&&t<=90||t>=97&&t<=122||95==t}function ce(e){let t=0,r="",n=!1;const s=[];for(;t<e.length;){const i=e.charAt(t);if(r)i===r?'"'===r||"'"===r?("\\"!==e.charAt(t-1)&&(r=""),s.push(i)):(r="",n=!1):"*/"===r&&"*"===i&&t+1<e.length?("/"===e.charAt(t+1)&&(r=""),""===r&&(n=!1,t++)):n||s.push(i);else{switch(i){case'"':case"'":case"`":r=i;break;case"/":if(t+1<e.length){const s=e.charAt(t+1);"/"===s?(r="\n",n=!0):"*"===s&&(r="*/",n=!0)}}n||s.push(i)}t++}return s.join("")}function le(e,t,r,n){for(;t>=0&&e.charAt(t)!==r&&(!n||e.charAt(t)!==n);)t--;return t}function he(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function de(e,t,r,n){let s=e.indexOf(t);if(s<0)return e;if(r){for(;s++<e.length&&"{"!=e.charAt(s););if(s<e.length){const t=e.substring(0,s+1),n=e.substring(s+1);e=t+r+n}}if(n){const t=e.lastIndexOf("}");e=e.substring(0,t),e+=n+"\n}"}return e}ie._SimplifiedKnownBindings=!0,ie._SimplifiedKnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:-1,bindingIndex:-1}},Light1:{binding:{groupIndex:-1,bindingIndex:-1}},Light2:{binding:{groupIndex:-1,bindingIndex:-1}},Light3:{binding:{groupIndex:-1,bindingIndex:-1}},Light4:{binding:{groupIndex:-1,bindingIndex:-1}},Light5:{binding:{groupIndex:-1,bindingIndex:-1}},Light6:{binding:{groupIndex:-1,bindingIndex:-1}},Light7:{binding:{groupIndex:-1,bindingIndex:-1}},Light8:{binding:{groupIndex:-1,bindingIndex:-1}},Light9:{binding:{groupIndex:-1,bindingIndex:-1}},Light10:{binding:{groupIndex:-1,bindingIndex:-1}},Light11:{binding:{groupIndex:-1,bindingIndex:-1}},Light12:{binding:{groupIndex:-1,bindingIndex:-1}},Light13:{binding:{groupIndex:-1,bindingIndex:-1}},Light14:{binding:{groupIndex:-1,bindingIndex:-1}},Light15:{binding:{groupIndex:-1,bindingIndex:-1}},Light16:{binding:{groupIndex:-1,bindingIndex:-1}},Light17:{binding:{groupIndex:-1,bindingIndex:-1}},Light18:{binding:{groupIndex:-1,bindingIndex:-1}},Light19:{binding:{groupIndex:-1,bindingIndex:-1}},Light20:{binding:{groupIndex:-1,bindingIndex:-1}},Light21:{binding:{groupIndex:-1,bindingIndex:-1}},Light22:{binding:{groupIndex:-1,bindingIndex:-1}},Light23:{binding:{groupIndex:-1,bindingIndex:-1}},Light24:{binding:{groupIndex:-1,bindingIndex:-1}},Light25:{binding:{groupIndex:-1,bindingIndex:-1}},Light26:{binding:{groupIndex:-1,bindingIndex:-1}},Light27:{binding:{groupIndex:-1,bindingIndex:-1}},Light28:{binding:{groupIndex:-1,bindingIndex:-1}},Light29:{binding:{groupIndex:-1,bindingIndex:-1}},Light30:{binding:{groupIndex:-1,bindingIndex:-1}},Light31:{binding:{groupIndex:-1,bindingIndex:-1}},Material:{binding:{groupIndex:-1,bindingIndex:-1}},Mesh:{binding:{groupIndex:-1,bindingIndex:-1}},Internals:{binding:{groupIndex:-1,bindingIndex:-1}}},ie._KnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:1,bindingIndex:0}},Light1:{binding:{groupIndex:1,bindingIndex:1}},Light2:{binding:{groupIndex:1,bindingIndex:2}},Light3:{binding:{groupIndex:1,bindingIndex:3}},Light4:{binding:{groupIndex:1,bindingIndex:4}},Light5:{binding:{groupIndex:1,bindingIndex:5}},Light6:{binding:{groupIndex:1,bindingIndex:6}},Light7:{binding:{groupIndex:1,bindingIndex:7}},Light8:{binding:{groupIndex:1,bindingIndex:8}},Light9:{binding:{groupIndex:1,bindingIndex:9}},Light10:{binding:{groupIndex:1,bindingIndex:10}},Light11:{binding:{groupIndex:1,bindingIndex:11}},Light12:{binding:{groupIndex:1,bindingIndex:12}},Light13:{binding:{groupIndex:1,bindingIndex:13}},Light14:{binding:{groupIndex:1,bindingIndex:14}},Light15:{binding:{groupIndex:1,bindingIndex:15}},Light16:{binding:{groupIndex:1,bindingIndex:16}},Light17:{binding:{groupIndex:1,bindingIndex:17}},Light18:{binding:{groupIndex:1,bindingIndex:18}},Light19:{binding:{groupIndex:1,bindingIndex:19}},Light20:{binding:{groupIndex:1,bindingIndex:20}},Light21:{binding:{groupIndex:1,bindingIndex:21}},Light22:{binding:{groupIndex:1,bindingIndex:22}},Light23:{binding:{groupIndex:1,bindingIndex:23}},Light24:{binding:{groupIndex:1,bindingIndex:24}},Light25:{binding:{groupIndex:1,bindingIndex:25}},Light26:{binding:{groupIndex:1,bindingIndex:26}},Light27:{binding:{groupIndex:1,bindingIndex:27}},Light28:{binding:{groupIndex:1,bindingIndex:28}},Light29:{binding:{groupIndex:1,bindingIndex:29}},Light30:{binding:{groupIndex:1,bindingIndex:30}},Light31:{binding:{groupIndex:1,bindingIndex:31}},Material:{binding:{groupIndex:2,bindingIndex:0}},Mesh:{binding:{groupIndex:2,bindingIndex:1}},Internals:{binding:{groupIndex:2,bindingIndex:2}}};class pe extends re{constructor(){super(...arguments),this._missingVaryings=[],this._textureArrayProcessing=[],this._vertexIsGLES3=!1,this._fragmentIsGLES3=!1,this.shaderLanguage=0,this.parseGLES3=!0}_getArraySize(e,t,r){let n=0;const s=e.indexOf("["),i=e.indexOf("]");if(s>0&&i>0){const t=e.substring(s+1,i);n=+t,isNaN(n)&&(n=+r[t.trim()]),e=e.substring(0,s)}return[e,t,n]}initializeShaders(e){this._webgpuProcessingContext=e,this._missingVaryings.length=0,this._textureArrayProcessing.length=0,this.attributeKeywordName=void 0,this.varyingVertexKeywordName=void 0,this.varyingFragmentKeywordName=void 0}preProcessShaderCode(e,t){const r=`// Internals UBO\nuniform ${re.InternalsUBOName} {\nfloat yFactor_;\nfloat textureOutputHeight_;\n};\n`,n=-1!==e.indexOf("// Internals UBO");return t?(this._fragmentIsGLES3=-1!==e.indexOf("#version 3"),this._fragmentIsGLES3&&(this.varyingFragmentKeywordName="in"),n?e:r+"##INJECTCODE##\n"+e):(this._vertexIsGLES3=-1!==e.indexOf("#version 3"),this._vertexIsGLES3&&(this.attributeKeywordName="in",this.varyingVertexKeywordName="out"),n?e:r+e)}varyingCheck(e,t){return(t&&this._fragmentIsGLES3?/(flat\s)?\s*\bin\b/:!t&&this._vertexIsGLES3?/(flat\s)?\s*\bout\b/:/(flat\s)?\s*\bvarying\b/).test(e)}varyingProcessor(e,t,r){this._preProcessors=r;const s=(t&&this._fragmentIsGLES3?/\s*(flat)?\s*in\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:!t&&this._vertexIsGLES3?/\s*(flat)?\s*out\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:/\s*(flat)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm).exec(e);if(null!==s){const i=s[1]??"",a=s[2],o=s[3];let u;t?(u=this._webgpuProcessingContext.availableVaryings[o],this._missingVaryings[u]="",void 0===u&&n.V.Warn(`Invalid fragment shader: The varying named "${o}" is not declared in the vertex shader! This declaration will be ignored.`)):(u=this._webgpuProcessingContext.getVaryingNextLocation(a,this._getArraySize(o,a,r)[2]),this._webgpuProcessingContext.availableVaryings[o]=u,this._missingVaryings[u]=`layout(location = ${u}) ${i} in ${a} ${o};`),e=e.replace(s[0],void 0===u?"":`layout(location = ${u}) ${i} ${t?"in":"out"} ${a} ${o};`)}return e}attributeProcessor(e,t){this._preProcessors=t;const r=(this._vertexIsGLES3?/\s*in\s+(\S+)\s+(\S+)\s*;/gm:/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm).exec(e);if(null!==r){const n=r[1],s=r[2],i=this._webgpuProcessingContext.getAttributeNextLocation(n,this._getArraySize(s,n,t)[2]);this._webgpuProcessingContext.availableAttributes[s]=i,this._webgpuProcessingContext.orderedAttributes[i]=s;const a=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[s];if(void 0!==a){const t=a<0?-1===a?"int":"ivec"+-a:1===a?"uint":"uvec"+a,o=`_int_${s}_`;e=e.replace(r[0],`layout(location = ${i}) in ${t} ${o}; ${n} ${s} = ${n}(${o});`)}else e=e.replace(r[0],`layout(location = ${i}) in ${n} ${s};`)}return e}uniformProcessor(e,t,r){this._preProcessors=r;const n=/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm.exec(e);if(null!==n){let s=n[1],i=n[2];if(0===s.indexOf("sampler")||1===s.indexOf("sampler")){let n=0;[i,s,n]=this._getArraySize(i,s,r);let a=this._webgpuProcessingContext.availableTextures[i];if(!a){a={autoBindSampler:!0,isTextureArray:n>0,isStorageTexture:!1,textures:[],sampleType:"float"};for(let e=0;e<(n||1);++e)a.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}const o=re._SamplerTypeByWebGLSamplerType[s]??"sampler",u=!!re._IsComparisonSamplerByWebGPUSamplerType[o],c=u?"comparison":"filtering",l=i+"Sampler";let h=this._webgpuProcessingContext.availableSamplers[l];h||(h={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:c});const d="u"===s.charAt(0)?"u":"i"===s.charAt(0)?"i":"";d&&(s=s.substring(1));const p=u?"depth":"u"===d?"uint":"i"===d?"sint":"float";a.sampleType=p;const f=n>0,g=h.binding.groupIndex,m=h.binding.bindingIndex,_=re._SamplerFunctionByWebGLSamplerType[s],b=re._TextureTypeByWebGLSamplerType[s],x=re._GpuTextureViewDimensionByWebGPUTextureType[b];if(f){const t=[];t.push(`layout(set = ${g}, binding = ${m}) uniform ${d}${o} ${l};`),e="\n";for(let r=0;r<n;++r){const n=a.textures[r].groupIndex,s=a.textures[r].bindingIndex;t.push(`layout(set = ${n}, binding = ${s}) uniform ${b} ${i}Texture${r};`),e+=`${r>0?"\n":""}#define ${i}${r} ${d}${_}(${i}Texture${r}, ${l})`}e=t.join("\n")+e,this._textureArrayProcessing.push(i)}else n=1,e=`layout(set = ${g}, binding = ${m}) uniform ${o} ${l};\n                        layout(set = ${a.textures[0].groupIndex}, binding = ${a.textures[0].bindingIndex}) uniform ${d}${b} ${i}Texture;\n                        #define ${i} ${d}${_}(${i}Texture, ${l})`;this._webgpuProcessingContext.availableTextures[i]=a,this._webgpuProcessingContext.availableSamplers[l]=h,this._addSamplerBindingDescription(l,h,!t);for(let e=0;e<n;++e)this._addTextureBindingDescription(i,a,e,x,null,!t)}else this._addUniformToLeftOverUBO(i,s,r),e=""}return e}uniformBufferProcessor(e,t){const r=/uniform\s+(\w+)/gm.exec(e);if(null!==r){const n=r[1];let s=this._webgpuProcessingContext.availableBuffers[n];if(!s){const e=ie.KnownUBOs[n];let t;t=e&&-1!==e.binding.groupIndex?e.binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),s={binding:t},this._webgpuProcessingContext.availableBuffers[n]=s}this._addBufferBindingDescription(n,s,"uniform",!t),e=e.replace("uniform",`layout(set = ${s.binding.groupIndex}, binding = ${s.binding.bindingIndex}) uniform`)}return e}postProcessor(e,t,r,n,s,i){const a=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),r){const t=e.indexOf("gl_FragCoord")>=0,r="\n                glFragCoord_ = gl_FragCoord;\n                if (yFactor_ == 1.) {\n                    glFragCoord_.y = textureOutputHeight_ - glFragCoord_.y;\n                }\n            ",n=t?"vec4 glFragCoord_;\n":"",s=-1!==e.search(/layout *\(location *= *0\) *out/g);if(e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/gl_FragCoord/g,"glFragCoord_"),this._fragmentIsGLES3){const t=/^\s*out\s+\S+\s+\S+\s*;/gm.exec(e);null!==t&&(e=e.substring(0,t.index)+"layout(location = 0) "+e.substring(t.index))}else e=e.replace(/void\s+?main\s*\(/g,(a||s?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(");e=(e=e.replace(/dFdy/g,"(-yFactor_)*dFdy")).replace("##INJECTCODE##",n),t&&(e=de(e,"void main",r))}else{"VERTEXOUTPUT_INVARIANT"in i&&(e="invariant gl_Position;\n"+e),e=(e=e.replace(/gl_InstanceID/g,"gl_InstanceIndex")).replace(/gl_VertexID/g,"gl_VertexIndex");if(-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e}if(!r){const t=e.lastIndexOf("}");e=e.substring(0,t),e+="gl_Position.y *= yFactor_;\n",e+="}"}return e}_applyTextureArrayProcessing(e,t){const r=new RegExp(t+"\\s*\\[(.+)?\\]","gm");let n=r.exec(e);for(;null!==n;){const s=n[1];let i=+s;this._preProcessors&&isNaN(i)&&(i=+this._preProcessors[s.trim()]),e=e.replace(n[0],t+i),n=r.exec(e)}return e}_generateLeftOverUBOCode(e,t){let r=`layout(set = ${t.binding.groupIndex}, binding = ${t.binding.bindingIndex}) uniform ${e} {\n    `;for(const e of this._webgpuProcessingContext.leftOverUniforms)e.length>0?r+=`    ${e.type} ${e.name}[${e.length}];\n`:r+=`    ${e.type} ${e.name};\n`;return r+="};\n\n",r}finalizeShaders(e,t){for(let r=0;r<this._textureArrayProcessing.length;++r){const n=this._textureArrayProcessing[r];e=this._applyTextureArrayProcessing(e,n),t=this._applyTextureArrayProcessing(t,n)}for(let e=0;e<this._missingVaryings.length;++e){const r=this._missingVaryings[e];r&&r.length>0&&(t=r+"\n"+t)}const r=this._buildLeftOverUBO();return e=r+e,t=r+t,this._collectBindingNames(),this._preCreateBindGroupEntries(),this._preProcessors=null,this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}}r(98900),r(40242),r(44559),r(91277),r(79702),r(30976),r(6874),r(98327),r(49306);const fe="fragmentOutputs.fragDepth",ge={texture_1d:"1d",texture_2d:"2d",texture_2d_array:"2d-array",texture_3d:"3d",texture_cube:"cube",texture_cube_array:"cube-array",texture_multisampled_2d:"2d",texture_depth_2d:"2d",texture_depth_2d_array:"2d-array",texture_depth_cube:"cube",texture_depth_cube_array:"cube-array",texture_depth_multisampled_2d:"2d",texture_storage_1d:"1d",texture_storage_2d:"2d",texture_storage_2d_array:"2d-array",texture_storage_3d:"3d",texture_external:null};class me extends re{constructor(){super(...arguments),this.shaderLanguage=1,this.uniformRegexp=/uniform\s+(\w+)\s*:\s*(.+)\s*;/,this.textureRegexp=/var\s+(\w+)\s*:\s*((array<\s*)?(texture_\w+)\s*(<\s*(.+)\s*>)?\s*(,\s*\w+\s*>\s*)?);/,this.noPrecision=!0,this.pureMode=!1}_getArraySize(e,t,r){let n=0;const s=t.lastIndexOf(">");if(t.indexOf("array")>=0&&s>0){let e=s;for(;e>0&&" "!==t.charAt(e)&&","!==t.charAt(e);)e--;const i=t.substring(e+1,s);for(n=+i,isNaN(n)&&(n=+r[i.trim()]);e>0&&(" "===t.charAt(e)||","===t.charAt(e));)e--;t=t.substring(t.indexOf("<")+1,e+1)}return[e,t,n]}initializeShaders(e){this._webgpuProcessingContext=e,this._attributesInputWGSL=[],this._attributesWGSL=[],this._attributesConversionCodeWGSL=[],this._hasNonFloatAttribute=!1,this._varyingsWGSL=[],this._varyingNamesWGSL=[],this._stridedUniformArrays=[]}preProcessShaderCode(e){const t=this.pureMode?"":`struct ${re.InternalsUBOName} {\n  yFactor_: f32,\n  textureOutputHeight_: f32,\n};\nvar<uniform> internals : ${re.InternalsUBOName};\n`;return-1!==e.indexOf(t)?e:t+ce(e)}varyingCheck(e){return/(flat|linear|perspective)?\s*(center|centroid|sample)?\s*\bvarying\b/.test(e)}varyingProcessor(e,t,r){const s=/\s*(flat|linear|perspective)?\s*(center|centroid|sample)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(null!==s){const i=s[1]??"perspective",a=s[2]??"center",o=s[4],u=s[3],c="flat"===i?`@interpolate(${i})`:`@interpolate(${i}, ${a})`;let l;t?(l=this._webgpuProcessingContext.availableVaryings[u],void 0===l&&n.V.Warn(`Invalid fragment shader: The varying named "${u}" is not declared in the vertex shader! This declaration will be ignored.`)):(l=this._webgpuProcessingContext.getVaryingNextLocation(o,this._getArraySize(u,o,r)[2]),this._webgpuProcessingContext.availableVaryings[u]=l,this._varyingsWGSL.push(`  @location(${l}) ${c} ${u} : ${o},`),this._varyingNamesWGSL.push(u)),e=""}return e}attributeProcessor(e,t){const r=/\s*attribute\s+(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(null!==r){const n=r[2],s=r[1],i=this._webgpuProcessingContext.getAttributeNextLocation(n,this._getArraySize(s,n,t)[2]);this._webgpuProcessingContext.availableAttributes[s]=i,this._webgpuProcessingContext.orderedAttributes[i]=s;const a=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[s];if(void 0!==a){const e=a<0?-1===a?"i32":"vec"+-a+"<i32>":1===a?"u32":"vec"+a+"<u32>",t=`_int_${s}_`;this._attributesInputWGSL.push(`@location(${i}) ${t} : ${e},`),this._attributesWGSL.push(`${s} : ${n},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${s} = ${n}(vertexInputs_.${t});`),this._hasNonFloatAttribute=!0}else this._attributesInputWGSL.push(`@location(${i}) ${s} : ${n},`),this._attributesWGSL.push(`${s} : ${n},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${s} = vertexInputs_.${s};`);e=""}return e}uniformProcessor(e,t,r){const n=this.uniformRegexp.exec(e);if(null!==n){const t=n[2],s=n[1];this._addUniformToLeftOverUBO(s,t,r),e=""}return e}textureProcessor(e,t,r){const n=this.textureRegexp.exec(e);if(null!==n){const s=n[1],i=n[2],a=!!n[3],o=n[4],u=o.indexOf("storage")>0,c=n[6],l=u?c.substring(0,c.indexOf(",")).trim():null;let h=a?this._getArraySize(s,i,r)[2]:0,d=this._webgpuProcessingContext.availableTextures[s];if(d)h=d.textures.length;else{d={isTextureArray:h>0,isStorageTexture:u,textures:[],sampleType:"float"},h=h||1;for(let e=0;e<h;++e)d.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}this._webgpuProcessingContext.availableTextures[s]=d;const p=o.indexOf("depth")>0,f=ge[o],g=p?"depth":"u32"===c?"uint":"i32"===c?"sint":"float";if(d.sampleType=g,void 0===f)throw`Can't get the texture dimension corresponding to the texture function "${o}"!`;for(let r=0;r<h;++r){const{groupIndex:n,bindingIndex:i}=d.textures[r];0===r&&(e=`@group(${n}) @binding(${i}) ${e}`),this._addTextureBindingDescription(s,d,r,f,l,!t)}}return e}_convertDefinesToConst(e){let t="";for(const r in e){const n=e[r];r.startsWith("__")||(isNaN(parseInt(n))&&isNaN(parseFloat(n))?r&&""===n&&(t+=`const ${r} = true;\n`):t+=`const ${r} = ${n};\n`)}return t}postProcessor(e,t,r,n,s,i,a){const o=[];for(const e in a){"true"!==a[e]&&o.push(e)}o.sort((e,t)=>e.length-t.length>0?-1:e.length===t.length?0:1);for(const t of o){const r=e.indexOf("#define "+t);let n=e.indexOf("\n",r);-1===n&&(n=e.length);const s=e.substring(r+8+t.length+1,n);e=e.replace(new RegExp(t,"g"),s)}return e=this._convertDefinesToConst(i)+e,"VERTEXOUTPUT_INVARIANT"in i&&(e="#define VERTEXOUTPUT_INVARIANT\n"+e),e}finalizeShaders(e,t){const r=[],n=t.indexOf("fragmentInputs.position")>=0&&!this.pureMode?"\n            if (internals.yFactor_ == 1.) {\n                fragmentInputs.position.y = internals.textureOutputHeight_ - fragmentInputs.position.y;\n            }\n        ":"";e=this._processSamplers(e,!0),t=this._processSamplers(t,!1),e=this._processCustomBuffers(e,!0),t=this._processCustomBuffers(t,!1);const s=this._buildLeftOverUBO();t=s+t,e=(e=s+e).replace(/#define /g,"//#define "),e=this._processStridedUniformArrays(e);let i="struct VertexInputs {\n  @builtin(vertex_index) vertexIndex : u32,\n  @builtin(instance_index) instanceIndex : u32,\n";this._attributesInputWGSL.length>0&&(i+=this._attributesInputWGSL.join("\n")),i+="\n};\nvar<private> vertexInputs"+(this._hasNonFloatAttribute?"_":"")+" : VertexInputs;\n",this._hasNonFloatAttribute&&(i+="struct VertexInputs_ {\n  vertexIndex : u32, instanceIndex : u32,\n",i+=this._attributesWGSL.join("\n"),i+="\n};\nvar<private> vertexInputs : VertexInputs_;\n");let a="struct FragmentInputs {\n  @builtin(position)"+(e.indexOf("#define VERTEXOUTPUT_INVARIANT")>=0?" @invariant":"")+" position : vec4<f32>,\n";this._varyingsWGSL.length>0&&(a+=this._varyingsWGSL.join("\n")),a+="\n};\nvar<private> vertexOutputs : FragmentInputs;\n",e=i+a+e;let o=`\n  vertexInputs${this._hasNonFloatAttribute?"_":""} = input;\n`;this._hasNonFloatAttribute&&(o+="vertexInputs.vertexIndex = vertexInputs_.vertexIndex;\nvertexInputs.instanceIndex = vertexInputs_.instanceIndex;\n",o+=this._attributesConversionCodeWGSL.join("\n"),o+="\n");const u=this.pureMode?"  return vertexOutputs;":"  vertexOutputs.position.y = vertexOutputs.position.y * internals.yFactor_;\n  return vertexOutputs;";let c=-1!==e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS");e=(c?"diagnostic(off, derivative_uniformity);\n":"")+"diagnostic(off, chromium.unreachable_code);\n"+de(e,"fn main",o,u),t=t.replace(/#define /g,"//#define "),t=this._processStridedUniformArrays(t),this.pureMode||(t=t.replace(/dpdy/g,"(-internals.yFactor_)*dpdy"));let l="struct FragmentInputs {\n  @builtin(position) position : vec4<f32>,\n  @builtin(front_facing) frontFacing : bool,\n";this._varyingsWGSL.length>0&&(l+=this._varyingsWGSL.join("\n")),l+="\n};\nvar<private> fragmentInputs : FragmentInputs;\n";let h="struct FragmentOutputs {\n";const d="fragmentOutputs\\.fragData";let p=t.match(new RegExp(d+"0","g")),f=0;if(p){h+=` @location(${f}) fragData0 : vec4<f32>,\n`,f++;for(let e=1;e<8;e++)p=t.match(new RegExp(d+e,"g")),p&&(h+=` @location(${f}) fragData${f} : vec4<f32>,\n`,f++);-1!==t.indexOf("MRT_AND_COLOR")&&(h+=`  @location(${f}) color : vec4<f32>,\n`,f++)}if(p=t.match(/oitDepthSampler/),p&&(h+=` @location(${f++}) depth : vec2<f32>,\n`,h+=` @location(${f++}) frontColor : vec4<f32>,\n`,h+=` @location(${f++}) backColor : vec4<f32>,\n`),0===f){-1!==t.indexOf("DUAL_SOURCE_BLENDING")?(r.push("dual_source_blending"),h+="  @location(0) @blend_src(0) color : vec4<f32>,\n",h+="  @location(0) @blend_src(1) color2 : vec4<f32>,\n"):h+="  @location(0) color : vec4<f32>,\n",f++}let g=!1,m=0;for(;!(g||(m=t.indexOf(fe,m),m<0));){const e=m;for(g=!0;m>1&&"\n"!==t.charAt(m);){if("/"===t.charAt(m)&&"/"===t.charAt(m-1)){g=!1;break}m--}m=e+25}g&&(h+="  @builtin(frag_depth) fragDepth: f32,\n"),h+="};\nvar<private> fragmentOutputs : FragmentOutputs;\n";const _="  fragmentInputs = input;\n  "+n;return c=-1!==(t=l+h+t).indexOf("#define DISABLE_UNIFORMITY_ANALYSIS"),r.length>0&&(t="enable "+r.join(";\nenable ")+";\n"+t),t=(c?"diagnostic(off, derivative_uniformity);\n":"")+"diagnostic(off, chromium.unreachable_code);\n"+de(t,"fn main",_,"  return fragmentOutputs;"),this._collectBindingNames(),this._preCreateBindGroupEntries(),this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}_generateLeftOverUBOCode(e,t){let r="",n=`struct ${e} {\n`;for(const t of this._webgpuProcessingContext.leftOverUniforms){const s=t.type.replace(/^(.*?)(<.*>)?$/,"$1"),i=re.UniformSizes[s];if(t.length>0)if(i<=2){const i=`${e}_${this._stridedUniformArrays.length}_strided_arr`;r+=`struct ${i} {\n                        @size(16)\n                        el: ${s},\n                    }`,this._stridedUniformArrays.push(t.name),n+=` @align(16) ${t.name} : array<${i}, ${t.length}>,\n`}else n+=` ${t.name} : array<${t.type}, ${t.length}>,\n`;else n+=`  ${t.name} : ${t.type},\n`}return n+="};\n",n=`${r}\n${n}`,n+=`@group(${t.binding.groupIndex}) @binding(${t.binding.bindingIndex}) var<uniform> uniforms : ${e};\n`,n}_processSamplers(e,t){const r=/var\s+(\w+Sampler)\s*:\s*(sampler|sampler_comparison)\s*;/gm;for(;;){const n=r.exec(e);if(null===n)break;const s=n[1],i=n[2],a=s.length-7,o=s.lastIndexOf("Sampler")===a?s.substring(0,a):null,u="sampler_comparison"===i?"comparison":"filtering";if(o){const e=this._webgpuProcessingContext.availableTextures[o];e&&(e.autoBindSampler=!0)}let c=this._webgpuProcessingContext.availableSamplers[s];c||(c={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:u},this._webgpuProcessingContext.availableSamplers[s]=c),this._addSamplerBindingDescription(s,c,t);const l=e.substring(0,n.index),h=`@group(${c.binding.groupIndex}) @binding(${c.binding.bindingIndex}) `,d=e.substring(n.index);e=l+h+d,r.lastIndex+=h.length}return e}_processCustomBuffers(e,t){const r=/var<\s*(uniform|storage)\s*(,\s*(read|read_write)\s*)?>\s+(\S+)\s*:\s*(\S+)\s*;/gm;for(;;){const n=r.exec(e);if(null===n)break;const s=n[1],i=n[3];let a=n[4];const o=n[5];let u=this._webgpuProcessingContext.availableBuffers[a];if(!u){const e="uniform"===s?ie.KnownUBOs[o]:null;let t;e?(a=o,t=e.binding,-1===t.groupIndex&&(t=this._webgpuProcessingContext.availableBuffers[a]?.binding,t||(t=this._webgpuProcessingContext.getNextFreeUBOBinding()))):t=this._webgpuProcessingContext.getNextFreeUBOBinding(),u={binding:t},this._webgpuProcessingContext.availableBuffers[a]=u}this._addBufferBindingDescription(a,this._webgpuProcessingContext.availableBuffers[a],"read_write"===i?"storage":"storage"===s?"read-only-storage":"uniform",t);const c=u.binding.groupIndex,l=u.binding.bindingIndex,h=e.substring(0,n.index),d=`@group(${c}) @binding(${l}) `,p=e.substring(n.index);e=h+d+p,r.lastIndex+=d.length}return e}_processStridedUniformArrays(e){for(const t of this._stridedUniformArrays)e=e.replace(new RegExp(`${t}\\s*\\[(.*?)\\]`,"g"),`${t}[$1].el`);return e}}var _e=r(998);class be{get underlyingResource(){return this._webgpuTexture}getMSAATexture(e){return this._webgpuMSAATexture?.[e]??null}setMSAATexture(e,t){this._webgpuMSAATexture||(this._webgpuMSAATexture=[]),this._webgpuMSAATexture[t]=e}releaseMSAATexture(e){if(this._webgpuMSAATexture)if(void 0!==e)this._engine._textureHelper.releaseTexture(this._webgpuMSAATexture[e]),delete this._webgpuMSAATexture[e];else{for(const e of this._webgpuMSAATexture)this._engine._textureHelper.releaseTexture(e);this._webgpuMSAATexture=null}}constructor(e,t=null){this._engine=e,this._originalFormatIsRGB=!1,this.format="rgba8unorm",this.textureUsages=0,this.textureAdditionalUsages=0,this._webgpuTexture=t,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}set(e){this._webgpuTexture=e}setUsage(e,t,r,n,s,o,u,c){let l="2d",h=1;n?(l=r?"cube-array":"cube",h=6*(c||1)):s?(l="3d",h=1):r&&(l="2d-array",h=c);const d=a.GetDepthFormatOnly(this.format),p=a.HasDepthAndStencilAspects(this.format)?"depth-only":"all";this.createView({label:`TextureView${s?"3D":n?"Cube":"2D"}${r?"_Array"+h:""}_${o}x${u}_${t?"wmips":"womips"}_${this.format}_${l}`,format:d,dimension:l,mipLevelCount:t?(0,i.ILog2)(Math.max(o,u))+1:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:h,aspect:p})}createView(e,t=!1){if(this.view=this._webgpuTexture.createView(e),t&&e){const t=e.mipLevelCount;e.mipLevelCount=1,this.viewForWriting=this._webgpuTexture.createView(e),e.mipLevelCount=t}}reset(){this._webgpuTexture=null,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}release(){this._webgpuTexture?.destroy(),this.releaseMSAATexture(),this._copyInvertYTempTexture?.destroy(),this.reset()}}var xe=r(19125);const ye="\n    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));\n    const tex = array<vec2<f32>, 4>( vec2f(0.0f, 0.0f),  vec2f(1.0f, 0.0f),  vec2f(0.0f, 1.0f),  vec2f(1.0f, 1.0f));\n\n    var img: texture_2d<f32>;\n\n    #ifdef INVERTY\n        varying vTextureSize: vec2f;\n    #endif\n\n    @vertex\n    fn main(input : VertexInputs) -> FragmentInputs {\n        #ifdef INVERTY\n            vertexOutputs.vTextureSize = vec2f(textureDimensions(img, 0));\n        #endif\n        vertexOutputs.position =  vec4f(pos[input.vertexIndex], 0.0, 1.0);\n    }\n    ",Se=ye;var ve,Ce;!function(e){e[e.MipMap=0]="MipMap",e[e.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",e[e.Clear=2]="Clear",e[e.InvertYPremultiplyAlphaWithOfst=3]="InvertYPremultiplyAlphaWithOfst"}(ve||(ve={})),function(e){e[e.DontInvertY=0]="DontInvertY",e[e.InvertY=1]="InvertY"}(Ce||(Ce={}));const we=[{vertex:"\n    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));\n    const tex = array<vec2<f32>, 4>( vec2f(0.0f, 0.0f),  vec2f(1.0f, 0.0f),  vec2f(0.0f, 1.0f),  vec2f(1.0f, 1.0f));\n\n    varying vTex: vec2f;\n\n    @vertex\n    fn main(input : VertexInputs) -> FragmentInputs {\n        vertexOutputs.vTex = tex[input.vertexIndex];\n        vertexOutputs.position = vec4f(pos[input.vertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    var imgSampler: sampler;\n    var img: texture_2d<f32>;\n\n    varying vTex: vec2f;\n\n    @fragment\n    fn main(input: FragmentInputs) -> FragmentOutputs {\n        fragmentOutputs.color = textureSample(img, imgSampler, input.vTex);\n    }\n    "},{vertex:ye,fragment:"\n    var img: texture_2d<f32>;\n\n    #ifdef INVERTY\n        varying vTextureSize: vec2f;\n    #endif\n\n    @fragment\n    fn main(input: FragmentInputs) -> FragmentOutputs {\n    #ifdef INVERTY\n        var color: vec4f = textureLoad(img, vec2i(i32(input.position.x), i32(input.vTextureSize.y - input.position.y)), 0);\n    #else\n        var color: vec4f = textureLoad(img, vec2i(input.position.xy), 0);\n    #endif\n    #ifdef PREMULTIPLYALPHA\n        color = vec4f(color.rgb * color.a, color.a);\n    #endif\n        fragmentOutputs.color = color;\n    }\n    "},{vertex:"\n    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));\n\n    @vertex\n    fn main(input : VertexInputs) -> FragmentInputs {\n        vertexOutputs.position =  vec4f(pos[input.vertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    uniform color: vec4f;\n\n\n    @fragment\n    fn main(input: FragmentInputs) -> FragmentOutputs {\n        fragmentOutputs.color = uniforms.color;\n    }\n    "},{vertex:Se,fragment:"\n    var img: texture_2d<f32>;\n    uniform ofstX: f32;\n    uniform ofstY: f32;\n    uniform width: f32;\n    uniform height: f32;\n\n    #ifdef INVERTY\n        varying vTextureSize: vec2f;\n    #endif\n\n    @fragment\n    fn main(input: FragmentInputs) -> FragmentOutputs {\n        if (input.position.x < uniforms.ofstX || input.position.x >= uniforms.ofstX + uniforms.width) {\n            discard;\n        }\n        if (input.position.y < uniforms.ofstY || input.position.y >= uniforms.ofstY + uniforms.height) {\n            discard;\n        }\n    #ifdef INVERTY\n        var color: vec4f = textureLoad(img, vec2i(i32(input.position.x), i32(uniforms.ofstY + uniforms.height - (input.position.y - uniforms.ofstY))), 0);\n    #else\n        var color: vec4f = textureLoad(img, vec2i(input.position.xy), 0);\n    #endif\n    #ifdef PREMULTIPLYALPHA\n        color = vec4f(color.rgb * color.a, color.a);\n    #endif\n        fragmentOutputs.color = color;\n    }\n    "}],Te={"":0,r8unorm:1,r8uint:2,r8sint:3,r16uint:4,r16sint:5,r16float:6,rg8unorm:7,rg8uint:8,rg8sint:9,r32uint:10,r32sint:11,r32float:12,rg16uint:13,rg16sint:14,rg16float:15,rgba8unorm:16,"rgba8unorm-srgb":17,rgba8uint:18,rgba8sint:19,bgra8unorm:20,"bgra8unorm-srgb":21,rgb10a2uint:22,rgb10a2unorm:23,rg32uint:24,rg32sint:25,rg32float:26,rgba16uint:27,rgba16sint:28,rgba16float:29,rgba32uint:30,rgba32sint:31,rgba32float:32,stencil8:33,depth16unorm:34,depth24plus:35,"depth24plus-stencil8":36,depth32float:37,"depth32float-stencil8":38,r16unorm:39,rg16unorm:40,rgba16unorm:41,r16snorm:42,rg16snorm:43,rgba16snorm:44};class Ie{constructor(e,t,r,n){if(this._pipelines={},this._compiledShaders=[],this._videoPipelines={},this._videoCompiledShaders=[],this._deferredReleaseTextures=[],this._engine=e,this._device=t,this._bufferManager=r,-1!==n.indexOf("rg11b10ufloat-renderable")){const e=Object.keys(Te);Te.rg11b10ufloat=Te[e[e.length-1]]+1}this._mipmapSampler=t.createSampler({minFilter:"linear"}),this._videoSampler=t.createSampler({minFilter:"linear"}),this._ubCopyWithOfst=this._bufferManager.createBuffer(16,p.Uniform|p.CopyDst,"UBCopyWithOffset").underlyingResource,this._getPipeline("rgba8unorm"),this._getVideoPipeline("rgba8unorm")}_getPipeline(e,t=ve.MipMap,r){const n=t===ve.MipMap?1:t===ve.InvertYPremultiplyAlpha?((r.invertY?1:0)<<1)+((r.premultiplyAlpha?1:0)<<2):t===ve.Clear?8:t===ve.InvertYPremultiplyAlphaWithOfst?((r.invertY?1:0)<<4)+((r.premultiplyAlpha?1:0)<<5):0;this._pipelines[e]||(this._pipelines[e]=[]);let s=this._pipelines[e][n];if(!s){let i="";t!==ve.InvertYPremultiplyAlpha&&t!==ve.InvertYPremultiplyAlphaWithOfst||(r.invertY&&(i+="#define INVERTY\n"),r.premultiplyAlpha&&(i+="#define PREMULTIPLYALPHA\n"));let a=this._compiledShaders[n];if(!a){let e=we[t].vertex,r=we[t].fragment;const s={defines:i.split("\n"),indexParameters:null,isFragment:!1,shouldUseHighPrecisionShader:!0,processor:this._engine._getShaderProcessor(1),supportsUniformBuffers:!0,shadersRepository:"",includesShadersStore:{},version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._engine._getShaderProcessingContext(1,!0),isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer};(0,xe.pB)(s),s.processor.pureMode=!0,(0,xe.M0)(e,s,t=>{e=t},this._engine),s.isFragment=!0,(0,xe.M0)(r,s,e=>{r=e},this._engine);const o=(0,xe.nO)(e,r,s);s.processor.pureMode=!1;const u=this._device.createShaderModule({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalVertexShader_${n}`,code:o.vertexCode}),c=this._device.createShaderModule({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalFragmentShader_${n}`,code:o.fragmentCode});a=this._compiledShaders[n]=[u,c]}const o=this._device.createRenderPipeline({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalPipeline_${e}_${n}`,layout:"auto",vertex:{module:a[0],entryPoint:"main"},fragment:{module:a[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"}});s=this._pipelines[e][n]=[o,o.getBindGroupLayout(0)]}return s}_getVideoPipeline(e,t=Ce.DontInvertY){const r=t===Ce.InvertY?1:0;this._videoPipelines[e]||(this._videoPipelines[e]=[]);let n=this._videoPipelines[e][r];if(!n){let t=this._videoCompiledShaders[r];if(!t){const e=this._device.createShaderModule({code:"\n    struct VertexOutput {\n        @builtin(position) Position : vec4<f32>,\n        @location(0) fragUV : vec2<f32>\n    }\n\n    @vertex\n    fn main(\n        @builtin(vertex_index) VertexIndex : u32\n    ) -> VertexOutput {\n        var pos = array<vec2<f32>, 4>(\n            vec2(-1.0,  1.0),\n            vec2( 1.0,  1.0),\n            vec2(-1.0, -1.0),\n            vec2( 1.0, -1.0)\n        );\n        var tex = array<vec2<f32>, 4>(\n            vec2(0.0, 0.0),\n            vec2(1.0, 0.0),\n            vec2(0.0, 1.0),\n            vec2(1.0, 1.0)\n        );\n\n        var output: VertexOutput;\n\n        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n        output.fragUV = tex[VertexIndex];\n\n        return output;\n    }\n    ",label:`BabylonWebGPUDevice${this._engine.uniqueId}_CopyVideoToTexture_VertexShader`}),n=this._device.createShaderModule({code:0===r?"\n    @group(0) @binding(0) var videoSampler: sampler;\n    @group(0) @binding(1) var videoTexture: texture_external;\n\n    @fragment\n    fn main(\n        @location(0) fragUV: vec2<f32>\n    ) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, fragUV);\n    }\n    ":"\n    @group(0) @binding(0) var videoSampler: sampler;\n    @group(0) @binding(1) var videoTexture: texture_external;\n\n    @fragment\n    fn main(\n        @location(0) fragUV: vec2<f32>\n    ) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, vec2<f32>(fragUV.x, 1.0 - fragUV.y));\n    }\n    ",label:`BabylonWebGPUDevice${this._engine.uniqueId}_CopyVideoToTexture_FragmentShader_${0===r?"DontInvertY":"InvertY"}`});t=this._videoCompiledShaders[r]=[e,n]}const s=this._device.createRenderPipeline({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalVideoPipeline_${e}_${0===r?"DontInvertY":"InvertY"}`,layout:"auto",vertex:{module:t[0],entryPoint:"main"},fragment:{module:t[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"}});n=this._videoPipelines[e][r]=[s,s.getBindGroupLayout(0)]}return n}setCommandEncoder(e){this._commandEncoderForCreation=e}copyVideoToTexture(e,t,r,n=!1,s){const i=void 0===s,[a,o]=this._getVideoPipeline(r,n?Ce.InvertY:Ce.DontInvertY);i&&(s=this._device.createCommandEncoder({})),s.pushDebugGroup?.(`copy video to texture - invertY=${n}`);const u=t._hardwareTexture,c={label:`BabylonWebGPUDevice${this._engine.uniqueId}_copyVideoToTexture_${r}_${n?"InvertY":"DontInvertY"}${t.label?"_"+t.label:""}`,colorAttachments:[{view:u.underlyingResource.createView({format:r,dimension:"2d",mipLevelCount:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:1,aspect:"all"}),loadOp:"load",storeOp:"store"}]},l=s.beginRenderPass(c),h={layout:o,entries:[{binding:0,resource:this._videoSampler},{binding:1,resource:this._device.importExternalTexture({source:e.underlyingResource})}]},d=this._device.createBindGroup(h);l.setPipeline(a),l.setBindGroup(0,d),l.draw(4,1,0,0),l.end(),s.popDebugGroup?.(),i&&(this._device.queue.submit([s.finish()]),s=null)}invertYPreMultiplyAlpha(e,t,r,n,s=!1,i=!1,o=0,u=0,c=1,l=0,h=0,d=0,p=0,f,g){const m=0!==d,_=void 0===f,[b,x]=this._getPipeline(n,m?ve.InvertYPremultiplyAlphaWithOfst:ve.InvertYPremultiplyAlpha,{invertY:s,premultiplyAlpha:i});let y;if(o=Math.max(o,0),_&&(f=this._device.createCommandEncoder({})),f.pushDebugGroup?.(`internal process texture - invertY=${s} premultiplyAlpha=${i}`),a.IsHardwareTexture(e)?(y=e.underlyingResource,s&&!i&&1===c&&0===o||(e=void 0)):(y=e,e=void 0),!y)return;m&&this._bufferManager.setRawData(this._ubCopyWithOfst,0,new Float32Array([l,h,d,p]),0,16);const S=e,v=S?._copyInvertYTempTexture??this.createTexture({width:t,height:r,layers:1},!1,!1,!1,!1,!1,n,1,f,21,void 0,"TempTextureForCopyWithInvertY"),C=S?._copyInvertYRenderPassDescr??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_invertYPreMultiplyAlpha_${n}_${s?"InvertY":"DontInvertY"}_${i?"PremultiplyAlpha":"DontPremultiplyAlpha"}`,colorAttachments:[{view:v.createView({format:n,dimension:"2d",baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadOp:"load",storeOp:"store"}]},w=f.beginRenderPass(C);let T=m?S?._copyInvertYBindGroupWithOfst:S?._copyInvertYBindGroup;if(!T){const e={layout:x,entries:[{binding:0,resource:y.createView({format:n,dimension:"2d",baseMipLevel:u,mipLevelCount:1,arrayLayerCount:c,baseArrayLayer:o})}]};m&&e.entries.push({binding:1,resource:{buffer:this._ubCopyWithOfst}}),T=this._device.createBindGroup(e)}w.setPipeline(b),w.setBindGroup(0,T),w.draw(4,1,0,0),w.end(),f.copyTextureToTexture({texture:v},{texture:y,mipLevel:u,origin:{x:0,y:0,z:o}},{width:d||t,height:p||r,depthOrArrayLayers:1}),S?(S._copyInvertYTempTexture=v,S._copyInvertYRenderPassDescr=C,m?S._copyInvertYBindGroupWithOfst=T:S._copyInvertYBindGroup=T):this._deferredReleaseTextures.push([v,null]),f.popDebugGroup?.(),_&&(this._device.queue.submit([f.finish()]),f=null)}createTexture(e,t=!1,r=!1,n=!1,s=!1,i=!1,o="rgba8unorm",u=1,c,l=-1,h=0,d){u=a.GetSample(u);const p=e.layers||1,f={width:e.width,height:e.height,depthOrArrayLayers:p},g=Te[o]?16:0,m=a.IsCompressedFormat(o),_=t?a.ComputeNumMipmapLevels(e.width,e.height):1,b=l>=0?l:7;h|=t&&!m?1|g:0,m||i||(h|=2|g);const x=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_Texture${i?"3D":"2D"}_${d?d+"_":""}${f.width}x${f.height}x${f.depthOrArrayLayers}_${t?"wmips":"womips"}_${o}_samples${u}`,size:f,dimension:i?"3d":"2d",format:o,usage:b|h,sampleCount:u,mipLevelCount:_});return a.IsImageBitmap(e)&&(this.updateTexture(e,x,e.width,e.height,p,o,0,0,n,s,0,0),t&&r&&this.generateMipmaps(x,o,_,0,i,c)),x}createCubeTexture(e,t=!1,r=!1,n=!1,s=!1,i="rgba8unorm",o=1,u,c=-1,l=0,h){o=a.GetSample(o);const d=a.IsImageBitmapArray(e)?e[0].width:e.width,p=a.IsImageBitmapArray(e)?e[0].height:e.height,f=Te[i]?16:0,g=a.IsCompressedFormat(i),m=t?a.ComputeNumMipmapLevels(d,p):1,_=c>=0?c:7;l|=t&&!g?1|f:0,g||(l|=2|f);const b=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureCube_${h?h+"_":""}${d}x${p}x6_${t?"wmips":"womips"}_${i}_samples${o}`,size:{width:d,height:p,depthOrArrayLayers:6},dimension:"2d",format:i,usage:_|l,sampleCount:o,mipLevelCount:m});return a.IsImageBitmapArray(e)&&(this.updateCubeTextures(e,b,d,p,i,n,s,0,0),t&&r&&this.generateCubeMipmaps(b,i,m,u)),b}generateCubeMipmaps(e,t,r,n){const s=void 0===n;s&&(n=this._device.createCommandEncoder({})),n.pushDebugGroup?.(`create cube mipmaps - ${r} levels`);for(let s=0;s<6;++s)this.generateMipmaps(e,t,r,s,!1,n);n.popDebugGroup?.(),s&&(this._device.queue.submit([n.finish()]),n=null)}generateMipmaps(e,t,r,n=0,s=!1,i){const o=void 0===i,[u,c]=this._getPipeline(t);let l;if(n=Math.max(n,0),o&&(i=this._device.createCommandEncoder({})),i.pushDebugGroup?.(`create mipmaps for face #${n} - ${r} levels`),a.IsHardwareTexture(e)?(l=e.underlyingResource,e._mipmapGenRenderPassDescr=e._mipmapGenRenderPassDescr||[],e._mipmapGenBindGroup=e._mipmapGenBindGroup||[]):(l=e,e=void 0),!l)return;const h=e;for(let e=1;e<r;++e){const r=h?._mipmapGenRenderPassDescr[n]?.[e-1]??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_generateMipmaps_${t}_faceIndex${n}_level${e}`,colorAttachments:[{view:l.createView({format:t,dimension:s?"3d":"2d",baseMipLevel:e,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:n}),loadOp:"load",storeOp:"store"}]};h&&(h._mipmapGenRenderPassDescr[n]=h._mipmapGenRenderPassDescr[n]||[],h._mipmapGenRenderPassDescr[n][e-1]=r);const a=i.beginRenderPass(r),o=h?._mipmapGenBindGroup[n]?.[e-1]??this._device.createBindGroup({layout:c,entries:[{binding:0,resource:l.createView({format:t,dimension:s?"3d":"2d",baseMipLevel:e-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:n})},{binding:1,resource:this._mipmapSampler}]});h&&(h._mipmapGenBindGroup[n]=h._mipmapGenBindGroup[n]||[],h._mipmapGenBindGroup[n][e-1]=o),a.setPipeline(u),a.setBindGroup(0,o),a.draw(4,1,0,0),a.end()}i.popDebugGroup?.(),o&&(this._device.queue.submit([i.finish()]),i=null)}createGPUTextureForInternalTexture(e,t,r,n,s,i){e._hardwareTexture||(e._hardwareTexture=new be(this._engine)),void 0===t&&(t=e.width),void 0===r&&(r=e.height),void 0===n&&(n=e.depth);const o=e._hardwareTexture,u=!!(1&(s??0));o.format=a.GetWebGPUTextureFormat(e.type,e.format,e._useSRGBBuffer),o.textureUsages=5===e._source||6===e.source?21:12===e._source?20:-1,o.textureAdditionalUsages=u?8:0;const c=e.generateMipMaps,l=n||1;let h;if(h=null!==e._maxLodLevel?e._maxLodLevel:c?a.ComputeNumMipmapLevels(t,r):1,e.isCube){const n=this.createCubeTexture({width:t,height:r},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,o.format,1,this._commandEncoderForCreation,o.textureUsages,o.textureAdditionalUsages,e.label);o.set(n);const s=e.is3D?1:l,i=a.GetDepthFormatOnly(o.format),d=a.HasDepthAndStencilAspects(o.format)?"depth-only":"all",p=e.is2DArray?"cube-array":"cube";o.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureViewCube${e.is2DArray?"_Array"+s:""}_${t}x${r}_${c?"wmips":"womips"}_${i}_${p}_${d}_${e.label??"noname"}`,format:i,dimension:p,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:6,aspect:d},u)}else{const n=this.createTexture({width:t,height:r,layers:l},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,e.is3D,o.format,1,this._commandEncoderForCreation,o.textureUsages,o.textureAdditionalUsages,e.label);o.set(n);const s=e.is3D?1:l,i=a.GetDepthFormatOnly(o.format),d=a.HasDepthAndStencilAspects(o.format)?"depth-only":"all",p=e.is2DArray?"2d-array":e.is3D?"3d":"2d";o.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureView${e.is3D?"3D":"2D"}${e.is2DArray?"_Array"+s:""}_${t}x${r}${e.is3D?"x"+l:""}_${c?"wmips":"womips"}_${i}_${p}_${d}_${e.label??"noname"}`,format:i,dimension:p,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:s,aspect:d},u)}return e.width=e.baseWidth=t,e.height=e.baseHeight=r,e.depth=e.baseDepth=n,i||this.createMSAATexture(e,e.samples),o}createMSAATexture(e,t,r=!0,n=0){const s=e._hardwareTexture;if(r&&s?.releaseMSAATexture(),!s||(t??1)<=1)return;const i=e.width,a=e.height,o=this.createTexture({width:i,height:a,layers:1},!1,!1,!1,!1,!1,s.format,t,this._commandEncoderForCreation,16,0,e.label?"MSAA_"+e.label:"MSAA");s.setMSAATexture(o,n)}updateCubeTextures(e,t,r,n,s,i=!1,a=!1,o=0,u=0){const c=[0,3,1,4,2,5];for(let l=0;l<c.length;++l){const h=e[c[l]];this.updateTexture(h,t,r,n,1,s,l,0,i,a,o,u)}}updateTexture(e,t,r,n,s,i,o=0,u=0,c=!1,l=!1,h=0,d=0,f){const g=a.IsInternalTexture(t)?t._hardwareTexture.underlyingResource:t,m=a.GetBlockInformationFromFormat(i),_=a.IsInternalTexture(t)?t._hardwareTexture:t,b={texture:g,origin:{x:h,y:d,z:Math.max(o,0)},mipLevel:u,premultipliedAlpha:l},x={width:Math.ceil(r/m.width)*m.width,height:Math.ceil(n/m.height)*m.height,depthOrArrayLayers:s||1};if(void 0!==e.byteLength){const y=Math.ceil(r/m.width)*m.length;if(256*Math.ceil(y/256)===y){const t=this._device.createCommandEncoder({}),r=this._bufferManager.createRawBuffer(e.byteLength,p.MapWrite|p.CopySrc,!0,"TempBufferForUpdateTexture"+(g?"_"+g.label:"")),s=r.getMappedRange();new Uint8Array(s).set(e),r.unmap(),t.copyBufferToTexture({buffer:r,offset:0,bytesPerRow:y,rowsPerImage:n},b,x),this._device.queue.submit([t.finish()]),this._bufferManager.releaseBuffer(r)}else this._device.queue.writeTexture(b,e,{offset:0,bytesPerRow:y,rowsPerImage:n},x);if(c||l){if(!a.IsInternalTexture(t))throw"updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!";{const e=0===h&&0===d&&r===t.width&&n===t.height;this.invertYPreMultiplyAlpha(_,t.width,t.height,i,c,l,o,u,s||1,h,d,e?0:r,e?0:n,void 0,f)}}}else this._device.queue.copyExternalImageToTexture({source:e,flipY:c},b,x)}readPixels(e,t,r,n,s,i,o=0,u=0,c=null,l=!1){const h=a.GetBlockInformationFromFormat(i),d=Math.ceil(n/h.width)*h.length,f=256*Math.ceil(d/256),g=f*s,m=this._bufferManager.createRawBuffer(g,p.MapRead|p.CopyDst,void 0,"TempBufferForReadPixels"+(e.label?"_"+e.label:"")),_=this._device.createCommandEncoder({});return _.copyTextureToBuffer({texture:e,mipLevel:u,origin:{x:t,y:r,z:Math.max(o,0)}},{buffer:m,offset:0,bytesPerRow:f},{width:n,height:s,depthOrArrayLayers:1}),this._device.queue.submit([_.finish()]),this._bufferManager.readDataFromBuffer(m,g,n,s,d,f,a.GetTextureTypeFromFormat(i),0,c,!0,l)}releaseTexture(e){if(a.IsInternalTexture(e)){const t=e._hardwareTexture,r=e._irradianceTexture;this._deferredReleaseTextures.push([t,r])}else this._deferredReleaseTextures.push([e,null])}destroyDeferredTextures(){for(let e=0;e<this._deferredReleaseTextures.length;++e){const[t,r]=this._deferredReleaseTextures[e];t&&(a.IsHardwareTexture(t)?t.release():t.destroy()),r?.dispose()}this._deferredReleaseTextures.length=0}}var Be=r(71504);class Re extends Be.n{set buffer(e){this._buffer=e}constructor(e,t=0){super(),this.engineId=-1,this.capacity=t,e&&(this._buffer=e)}get underlyingResource(){return this._buffer}}var Ae=r(42683),Fe=r(16741);class Pe{static _IsGPUBuffer(e){return void 0===e.underlyingResource}static _FlagsToString(e,t=""){let r=t;for(let t=0;t<=9;++t)e&1<<t&&(r&&(r+="_"),r+=p[1<<t]);return r}constructor(e,t){this._deferredReleaseBuffers=[],this._engine=e,this._device=t}createRawBuffer(e,t,r=!1,n){const s=void 0!==e.byteLength?e.byteLength+3&-4:e+3&-4,i={label:"BabylonWebGPUDevice"+this._engine.uniqueId+"_"+Pe._FlagsToString(t,n??"Buffer")+"_size"+s,mappedAtCreation:r,size:s,usage:t};return this._device.createBuffer(i)}createBuffer(e,t,r){const n=void 0!==e.byteLength,s=new Re,i="DataBufferUniqueId="+s.uniqueId;return s.buffer=this.createRawBuffer(e,t,void 0,r?i+"-"+r:i),s.references=1,s.capacity=n?e.byteLength:e,s.engineId=this._engine.uniqueId,n&&this.setSubData(s,0,e),s}setRawData(e,t,r,n,s){n+=r.byteOffset,this._device.queue.writeBuffer(e,t,r.buffer,n,s)}setSubData(e,t,r,n=0,s=0){const i=e.underlyingResource;s=s||r.byteLength-n;const a=3&t;n-=a,t-=a;const o=s;s=s+a+3&-4;if(r.buffer.byteLength-r.byteOffset<s){const e=new Uint8Array(s);e.set(new Uint8Array(r.buffer,r.byteOffset+n,o)),r=e,n=0}this.setRawData(i,t,r,n,s)}_getHalfFloatAsFloatRGBAArrayBuffer(e,t,r){r?e=Math.min(e,r.length):r=new Float32Array(e);const n=new Uint16Array(t);for(;e--;)r[e]=(0,Ae.SX)(n[e]);return r}readDataFromBuffer(e,t,r,n,s,i,a=0,o=0,u=null,c=!0,l=!1){const h=1===a?2:2===a?1:0,d=this._engine.uniqueId;return new Promise((r,p)=>{e.mapAsync(1,o,t).then(()=>{const d=e.getMappedRange(o,t);let p=u;if(l)p=null===p?(0,Fe.kZ)(a,t,!0,d):(0,Fe.kZ)(a,p.buffer,void 0,d);else if(null===p)switch(h){case 0:p=new Uint8Array(t),p.set(new Uint8Array(d));break;case 1:p=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,d);break;case 2:p=new Float32Array(t/4),p.set(new Float32Array(d))}else switch(h){case 0:p=new Uint8Array(p.buffer),p.set(new Uint8Array(d,0,Math.min(p.byteLength,t)));break;case 1:p=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,d,u);break;case 2:p=new Float32Array(p.buffer),p.set(new Float32Array(d,0,p.byteLength/4))}if(s!==i){1!==h||l||(s*=2,i*=2);const e=new Uint8Array(p.buffer);let t=s,r=0;for(let a=1;a<n;++a){r=a*i;for(let n=0;n<s;++n)e[t++]=e[r++]}p=0===h||l?new Uint8Array(e.buffer,0,t):new Float32Array(e.buffer,0,t/4)}e.unmap(),c&&this.releaseBuffer(e),r(p)},e=>{this._engine.isDisposed||this._engine.uniqueId!==d?r(new Uint8Array):p(e)})})}releaseBuffer(e){return Pe._IsGPUBuffer(e)?(this._deferredReleaseBuffers.push(e),!0):(e.references--,0===e.references&&(this._deferredReleaseBuffers.push(e.underlyingResource),!0))}destroyDeferredBuffers(){for(let e=0;e<this._deferredReleaseBuffers.length;++e)this._deferredReleaseBuffers[e].destroy();this._deferredReleaseBuffers.length=0}}const De=[0,0,3,7,0,2,6,2,4,1,5,3,1],Le=[0,64,32,96,16,80,48,112,8],Ee=[0,128,128,0,0,0,0,128,0,0,0,0,128];class Me{constructor(e){this._samplers={},this._device=e,this.disabled=!1}static GetSamplerHashCode(e){const t=e._cachedAnisotropicFilteringLevel?e._cachedAnisotropicFilteringLevel:1;return De[e.samplingMode]+Le[(e._comparisonFunction||514)-512+1]+Ee[e.samplingMode]+((e._cachedWrapU??1)<<8)+((e._cachedWrapV??1)<<10)+((e._cachedWrapR??1)<<12)+((e.useMipMaps?1:0)<<14)+(t<<15)}static _GetSamplerFilterDescriptor(e,t){let r,n,s,i,a;const o=e.useMipMaps;switch(e.samplingMode){case 11:r="linear",n="linear",s="nearest",o||(i=a=0);break;case 3:case 3:r="linear",n="linear",o?s="linear":(s="nearest",i=a=0);break;case 8:r="nearest",n="nearest",o?s="linear":(s="nearest",i=a=0);break;case 4:r="nearest",n="nearest",s="nearest",o||(i=a=0);break;case 5:r="nearest",n="linear",s="nearest",o||(i=a=0);break;case 6:r="nearest",n="linear",o?s="linear":(s="nearest",i=a=0);break;case 7:r="nearest",n="linear",s="nearest",i=a=0;break;case 1:case 1:default:r="nearest",n="nearest",s="nearest",i=a=0;break;case 9:r="linear",n="nearest",s="nearest",o||(i=a=0);break;case 10:r="linear",n="nearest",o?s="linear":(s="nearest",i=a=0);break;case 2:case 2:r="linear",n="linear",t>1?s="linear":(s="nearest",i=a=0);break;case 12:r="linear",n="nearest",s="nearest",i=a=0}return t>1&&(0!==i||0!==a)?{magFilter:"linear",minFilter:"linear",mipmapFilter:"linear",anisotropyEnabled:!0}:{magFilter:r,minFilter:n,mipmapFilter:s,lodMinClamp:i,lodMaxClamp:a}}static _GetWrappingMode(e){switch(e){case 1:return"repeat";case 0:return"clamp-to-edge";case 2:return"mirror-repeat"}return"repeat"}static _GetSamplerWrappingDescriptor(e){return{addressModeU:this._GetWrappingMode(e._cachedWrapU),addressModeV:this._GetWrappingMode(e._cachedWrapV),addressModeW:this._GetWrappingMode(e._cachedWrapR)}}static _GetSamplerDescriptor(e,t){let r=(e.useMipMaps||2===e.samplingMode)&&e._cachedAnisotropicFilteringLevel?e._cachedAnisotropicFilteringLevel:1;11!==e.samplingMode&&3!==e.samplingMode&&2!==e.samplingMode&&(r=1);const n=this._GetSamplerFilterDescriptor(e,r);return{label:t,...n,...this._GetSamplerWrappingDescriptor(e),compare:e._comparisonFunction?Me.GetCompareFunction(e._comparisonFunction):void 0,maxAnisotropy:n.anisotropyEnabled?r:1}}static GetCompareFunction(e){switch(e){case 519:return"always";case 514:return"equal";case 516:return"greater";case 518:return"greater-equal";case 513:default:return"less";case 515:return"less-equal";case 512:return"never";case 517:return"not-equal"}}getSampler(e,t=!1,r=0,n){if(this.disabled)return this._device.createSampler(Me._GetSamplerDescriptor(e,n));t?r=0:0===r&&(r=Me.GetSamplerHashCode(e));let s=t?void 0:this._samplers[r];return s||(s=this._device.createSampler(Me._GetSamplerDescriptor(e,n)),t||(this._samplers[r]=s)),s}}var Oe=r(56608);const Ge={[Oe.R.PositionKind]:!0,[Oe.R.NormalKind]:!0,[Oe.R.TangentKind]:!0,[Oe.R.UVKind]:!0,[Oe.R.UV2Kind]:!0,[Oe.R.UV3Kind]:!0,[Oe.R.UV4Kind]:!0,[Oe.R.UV5Kind]:!0,[Oe.R.UV6Kind]:!0,[Oe.R.ColorKind]:!0,[Oe.R.ColorInstanceKind]:!0,[Oe.R.MatricesIndicesKind]:!0,[Oe.R.MatricesWeightsKind]:!0,[Oe.R.MatricesIndicesExtraKind]:!0,[Oe.R.MatricesWeightsExtraKind]:!0};function Ue(e){switch(e){case Oe.R.BYTE:case Oe.R.SHORT:case Oe.R.INT:case Oe.R.FLOAT:return!0;case Oe.R.UNSIGNED_BYTE:case Oe.R.UNSIGNED_SHORT:case Oe.R.UNSIGNED_INT:return!1;default:throw new Error(`Invalid type '${e}'`)}}var Ve;!function(e){e[e.StencilReadMask=0]="StencilReadMask",e[e.StencilWriteMask=1]="StencilWriteMask",e[e.DepthBias=2]="DepthBias",e[e.DepthBiasSlopeScale=3]="DepthBiasSlopeScale",e[e.DepthStencilState=4]="DepthStencilState",e[e.MRTAttachments=5]="MRTAttachments",e[e.RasterizationState=6]="RasterizationState",e[e.ColorStates1=7]="ColorStates1",e[e.ColorStates2=8]="ColorStates2",e[e.ColorStates3=9]="ColorStates3",e[e.ColorStates4=10]="ColorStates4",e[e.ShaderStage=11]="ShaderStage",e[e.TextureStage=12]="TextureStage",e[e.VertexState=13]="VertexState",e[e.NumStates=14]="NumStates"}(Ve||(Ve={}));const Ne={0:1,1:2,768:3,769:4,770:5,771:6,772:7,773:8,774:9,775:10,776:11,32769:12,32770:13,32771:14,32772:15,35065:16,35066:17,34185:18,35067:19},We={32774:0,32775:1,32776:2,32778:3,32779:4},$e={0:0,7680:1,7681:2,7682:3,7683:4,5386:5,34055:6,34056:7},ke=[0,0,0,0];class qe{constructor(e,t){this.mrtTextureCount=0,this._device=e,this._useTextureStage=!0,this._states=new Array(30),this._statesLength=0,this._stateDirtyLowestIndex=0,this._emptyVertexBuffer=t,this._mrtFormats=[],this._parameter={token:void 0,pipeline:null},this.disabled=!1,this.vertexBuffers=[],this._kMaxVertexBufferStride=e.limits.maxVertexBufferArrayStride||2048,this.reset()}reset(){this._isDirty=!0,this.vertexBuffers.length=0,this.setAlphaToCoverage(!1),this.resetDepthCullingState(),this.setClampDepth(!1),this.setDepthBias(0),this._webgpuColorFormat=["bgra8unorm"],this.setColorFormat("bgra8unorm"),this.setMRT([]),this.setAlphaBlendEnabled([!1],1),this.setAlphaBlendFactors([null,null,null,null],[null,null]),this.setWriteMask(15),this.setDepthStencilFormat("depth24plus-stencil8"),this.setStencilEnabled(!1),this.resetStencilState(),this.setBuffers(null,null,null),this._setTextureState(0)}get colorFormats(){return this._mrtAttachments>0?this._mrtFormats:this._webgpuColorFormat}getRenderPipeline(e,t,r,n=0){if(r=a.GetSample(r),this.disabled){const s=qe._GetTopology(e);return this._setVertexState(t),this._setTextureState(n),this._parameter.pipeline=this._createRenderPipeline(t,s,r),qe.NumCacheMiss++,qe._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}if(this._setShaderStage(t.uniqueId),this._setRasterizationState(e,r),this._setColorStates(),this._setDepthStencilState(),this._setVertexState(t),this._setTextureState(n),this.lastStateDirtyLowestIndex=this._stateDirtyLowestIndex,!this._isDirty&&this._parameter.pipeline)return this._stateDirtyLowestIndex=this._statesLength,qe.NumCacheHitWithoutHash++,this._parameter.pipeline;if(this._getRenderPipeline(this._parameter),this._isDirty=!1,this._stateDirtyLowestIndex=this._statesLength,this._parameter.pipeline)return qe.NumCacheHitWithHash++,this._parameter.pipeline;const s=qe._GetTopology(e);return this._parameter.pipeline=this._createRenderPipeline(t,s,r),this._setRenderPipeline(this._parameter),qe.NumCacheMiss++,qe._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}endFrame(){qe.NumPipelineCreationLastFrame=qe._NumPipelineCreationCurrentFrame,qe._NumPipelineCreationCurrentFrame=0}setAlphaToCoverage(e){this._alphaToCoverageEnabled=e}setFrontFace(e){this._frontFace=e}setCullEnabled(e){this._cullEnabled=e}setCullFace(e){this._cullFace=e}setClampDepth(e){this._clampDepth=e}resetDepthCullingState(){this.setDepthCullingState(!1,2,1,0,0,!0,!0,519)}setDepthCullingState(e,t,r,n,s,i,a,o){this._depthWriteEnabled=a,this._depthTestEnabled=i,this._depthCompare=(o??519)-512,this._cullFace=r,this._cullEnabled=e,this._frontFace=t,this.setDepthBiasSlopeScale(n),this.setDepthBias(s)}setDepthBias(e){this._depthBias!==e&&(this._depthBias=e,this._states[Ve.DepthBias]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ve.DepthBias))}setDepthBiasSlopeScale(e){this._depthBiasSlopeScale!==e&&(this._depthBiasSlopeScale=e,this._states[Ve.DepthBiasSlopeScale]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ve.DepthBiasSlopeScale))}setColorFormat(e){this._webgpuColorFormat[0]=e,this._colorFormat=Te[e??""]}setMRTAttachments(e){this.mrtAttachments=e;let t=0;for(let r=0;r<e.length;++r)0!==e[r]&&(t+=1<<r);this._mrtEnabledMask!==t&&(this._mrtEnabledMask=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ve.MRTAttachments))}setMRT(e,t){if((t=t??e.length)>8)throw new Error("Can't handle more than 8 attachments for a MRT in cache render pipeline!");this.mrtTextureArray=e,this.mrtTextureCount=t,this._mrtEnabledMask=65535;let r=0,n=0;for(let s=0;s<t;++s){const t=e[s],i=t?._hardwareTexture;this._mrtFormats[s]=i?.format??this._webgpuColorFormat[0],r+=Te[this._mrtFormats[s]??""]*2**n,n+=6}this._mrtFormats.length=t,this._mrtAttachments!==r&&(this._mrtAttachments=r,this._states[Ve.MRTAttachments]=r,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ve.MRTAttachments))}setAlphaBlendEnabled(e,t){this._alphaBlendEnabled=e,this._numAlphaBlendTargetsEnabled=t}setAlphaBlendFactors(e,t){this._alphaBlendFuncParams=e,this._alphaBlendEqParams=t}setWriteMask(e){this._writeMask=e}setDepthStencilFormat(e){this._webgpuDepthStencilFormat=e,this._depthStencilFormat=void 0===e?0:Te[e]}setDepthTestEnabled(e){this._depthTestEnabled=e}setDepthWriteEnabled(e){this._depthWriteEnabled=e}setDepthCompare(e){this._depthCompare=(e??519)-512}setStencilEnabled(e){this._stencilEnabled=e}setStencilCompare(e){this._stencilFrontCompare=(e??519)-512}setStencilDepthFailOp(e){this._stencilFrontDepthFailOp=null===e?1:$e[e]}setStencilPassOp(e){this._stencilFrontPassOp=null===e?2:$e[e]}setStencilFailOp(e){this._stencilFrontFailOp=null===e?1:$e[e]}setStencilBackCompare(e){this._stencilBackCompare=(e??519)-512}setStencilBackDepthFailOp(e){this._stencilBackDepthFailOp=null===e?1:$e[e]}setStencilBackPassOp(e){this._stencilBackPassOp=null===e?2:$e[e]}setStencilBackFailOp(e){this._stencilBackFailOp=null===e?1:$e[e]}setStencilReadMask(e){this._stencilReadMask!==e&&(this._stencilReadMask=e,this._states[Ve.StencilReadMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ve.StencilReadMask))}setStencilWriteMask(e){this._stencilWriteMask!==e&&(this._stencilWriteMask=e,this._states[Ve.StencilWriteMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ve.StencilWriteMask))}resetStencilState(){this.setStencilState(!1,519,7680,7681,7680,255,255)}setStencilState(e,t,r,n,s,i,a,o=null,u=null,c=null,l=null){this._stencilEnabled=e,this._stencilFrontCompare=(t??519)-512,this._stencilFrontDepthFailOp=null===r?1:$e[r],this._stencilFrontPassOp=null===n?2:$e[n],this._stencilFrontFailOp=null===s?1:$e[s],this._stencilBackCompare=(o??519)-512,this._stencilBackDepthFailOp=null===u?1:$e[u],this._stencilBackPassOp=null===c?2:$e[c],this._stencilBackFailOp=null===l?1:$e[l],this.setStencilReadMask(i),this.setStencilWriteMask(a)}setBuffers(e,t,r){this._vertexBuffers=e,this._overrideVertexBuffers=r,this.indexBuffer=t}static _GetTopology(e){switch(e){case 0:default:return"triangle-list";case 2:case 3:return"point-list";case 1:case 4:return"line-list";case 5:throw"LineLoop is an unsupported fillmode in WebGPU";case 6:return"line-strip";case 7:return"triangle-strip";case 8:throw"TriangleFan is an unsupported fillmode in WebGPU"}}static _GetAphaBlendOperation(e){switch(e){case 32774:default:return"add";case 32778:return"subtract";case 32779:return"reverse-subtract";case 32775:return"min";case 32776:return"max"}}static _GetAphaBlendFactor(e){switch(e){case 0:return"zero";case 1:default:return"one";case 768:return"src";case 769:return"one-minus-src";case 770:return"src-alpha";case 771:return"one-minus-src-alpha";case 772:return"dst-alpha";case 773:return"one-minus-dst-alpha";case 774:return"dst";case 775:return"one-minus-dst";case 776:return"src-alpha-saturated";case 32769:case 32771:return"constant";case 32770:case 32772:return"one-minus-constant";case 35065:return"src1";case 35066:return"one-minus-src1";case 34185:return"src1-alpha";case 35067:return"one-minus-src1-alpha"}}static _GetCompareFunction(e){switch(e){case 0:return"never";case 1:return"less";case 2:return"equal";case 3:return"less-equal";case 4:return"greater";case 5:return"not-equal";case 6:return"greater-equal";case 7:return"always"}return"never"}static _GetStencilOpFunction(e){switch(e){case 0:return"zero";case 1:return"keep";case 2:return"replace";case 3:return"increment-clamp";case 4:return"decrement-clamp";case 5:return"invert";case 6:return"increment-wrap";case 7:return"decrement-wrap"}return"keep"}static _GetVertexInputDescriptorFormat(e){const t=e.type,r=e.normalized,n=e.getSize();switch(t){case ee.R.BYTE:switch(n){case 1:case 2:return r?"snorm8x2":"sint8x2";case 3:case 4:return r?"snorm8x4":"sint8x4"}break;case ee.R.UNSIGNED_BYTE:switch(n){case 1:case 2:return r?"unorm8x2":"uint8x2";case 3:case 4:return r?"unorm8x4":"uint8x4"}break;case ee.R.SHORT:switch(n){case 1:case 2:return r?"snorm16x2":"sint16x2";case 3:case 4:return r?"snorm16x4":"sint16x4"}break;case ee.R.UNSIGNED_SHORT:switch(n){case 1:case 2:return r?"unorm16x2":"uint16x2";case 3:case 4:return r?"unorm16x4":"uint16x4"}break;case ee.R.INT:switch(n){case 1:return"sint32";case 2:return"sint32x2";case 3:return"sint32x3";case 4:return"sint32x4"}break;case ee.R.UNSIGNED_INT:switch(n){case 1:return"uint32";case 2:return"uint32x2";case 3:return"uint32x3";case 4:return"uint32x4"}break;case ee.R.FLOAT:switch(n){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4"}}throw new Error(`Invalid Format '${e.getKind()}' - type=${t}, normalized=${r}, size=${n}`)}_getAphaBlendState(e){return this._alphaBlendEnabled[e]?{srcFactor:qe._GetAphaBlendFactor(this._alphaBlendFuncParams[4*e+2]),dstFactor:qe._GetAphaBlendFactor(this._alphaBlendFuncParams[4*e+3]),operation:qe._GetAphaBlendOperation(this._alphaBlendEqParams[2*e+1])}:null}_getColorBlendState(e){return this._alphaBlendEnabled?{srcFactor:qe._GetAphaBlendFactor(this._alphaBlendFuncParams[4*e+0]),dstFactor:qe._GetAphaBlendFactor(this._alphaBlendFuncParams[4*e+1]),operation:qe._GetAphaBlendOperation(this._alphaBlendEqParams[2*e+0])}:null}_setShaderStage(e){this._shaderId!==e&&(this._shaderId=e,this._states[Ve.ShaderStage]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ve.ShaderStage))}_setRasterizationState(e,t){const r=this._frontFace-1+((this._cullEnabled?this._cullFace:0)<<1)+((this._clampDepth?1:0)<<3)+((this._alphaToCoverageEnabled?1:0)<<4)+(e<<5)+(t<<8);this._rasterizationState!==r&&(this._rasterizationState=r,this._states[Ve.RasterizationState]=this._rasterizationState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ve.RasterizationState))}_setColorStates(){ke[0]=(this._writeMask?1:0)*2**53,ke[1]=(this._depthWriteEnabled?1:0)*2**53,ke[2]=(7&this._colorFormat)*2**50,ke[3]=(56&this._colorFormat)*2**47;let e=0,t=!1;for(let r=0;r<8;r++){if(this._alphaBlendEnabled[r]){const t=4*r+0,n=4*r+1,s=4*r+2,i=4*r+3,a=2*r+0,o=2*r+1,u=null===this._alphaBlendEqParams[a]?0:We[this._alphaBlendEqParams[a]],c=null===this._alphaBlendEqParams[o]?0:We[this._alphaBlendEqParams[o]];ke[e]+=((null===this._alphaBlendFuncParams[t]?1:Ne[this._alphaBlendFuncParams[t]])|0)+((null===this._alphaBlendFuncParams[n]?1:Ne[this._alphaBlendFuncParams[n]])<<5)+((null===this._alphaBlendFuncParams[s]?1:Ne[this._alphaBlendFuncParams[s]])<<10)+((null===this._alphaBlendFuncParams[i]?1:Ne[this._alphaBlendFuncParams[i]])<<15)+(u+5*c)*(1<<20)}1&r&&(t=t||this._states[Ve.ColorStates1+e]!==ke[e],this._states[Ve.ColorStates1+e]=ke[e],e++)}t&&(this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ve.ColorStates1))}_setDepthStencilState(){const e=this._stencilEnabled?this._stencilFrontCompare+(this._stencilFrontDepthFailOp<<3)+(this._stencilFrontPassOp<<6)+(this._stencilFrontFailOp<<9)+(this._stencilBackCompare<<12)+(this._stencilBackDepthFailOp<<15)+(this._stencilBackPassOp<<18)+(this._stencilBackFailOp<<21):2421327,t=this._depthStencilFormat+((this._depthTestEnabled?this._depthCompare:7)<<6)+1024*e;this._depthStencilState!==t&&(this._depthStencilState=t,this._states[Ve.DepthStencilState]=this._depthStencilState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ve.DepthStencilState))}_setVertexState(e){const t=this._statesLength;let r=Ve.VertexState;const s=e._pipelineContext,i=s.shaderProcessingContext.attributeNamesFromEffect,a=s.shaderProcessingContext.attributeLocationsFromEffect;let o,u=0;for(let e=0;e<i.length;e++){const t=a[e];let s=(this._overrideVertexBuffers&&this._overrideVertexBuffers[i[e]])??this._vertexBuffers[i[e]];s||(s=this._emptyVertexBuffer,qe.LogErrorIfNoVertexBuffer&&n.V.Error(`No vertex buffer is provided for the "${i[e]}" attribute. A default empty vertex buffer will be used, but this may generate errors in some browsers.`));const c=s.effectiveBuffer?.underlyingResource;if(void 0===s._validOffsetRange){const e=s.effectiveByteOffset,t=s.getSize(!0),r=s.effectiveByteStride;s._validOffsetRange=e+t<=this._kMaxVertexBufferStride&&0===r||0!==r&&e+t<=r}o&&o===c&&s._validOffsetRange||(this.vertexBuffers[u++]=s,o=s._validOffsetRange?c:null);const l=s.hashCode+(t<<7);this._isDirty=this._isDirty||this._states[r]!==l,this._states[r++]=l}this.vertexBuffers.length=u,this._statesLength=r,this._isDirty=this._isDirty||r!==t,this._isDirty&&(this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ve.VertexState))}_setTextureState(e){this._textureState!==e&&(this._textureState=e,this._states[Ve.TextureStage]=this._textureState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ve.TextureStage))}_createPipelineLayout(e){if(this._useTextureStage)return this._createPipelineLayoutWithTextureStage(e);const t=[],r=e.shaderProcessingContext.bindGroupLayoutEntries;for(let e=0;e<r.length;e++){const n=r[e];t[e]=this._device.createBindGroupLayout({entries:n})}return e.bindGroupLayouts[0]=t,this._device.createPipelineLayout({bindGroupLayouts:t})}_createPipelineLayoutWithTextureStage(e){const t=e.shaderProcessingContext,r=t.bindGroupLayoutEntries;let n=1;for(let e=0;e<r.length;e++){const s=r[e];for(let i=0;i<s.length;i++){const s=r[e][i];if(s.texture){const i=t.bindGroupLayoutEntryInfo[e][s.binding].name,a=t.availableTextures[i],o=a.autoBindSampler?t.availableSamplers[i+"Sampler"]:null;let u=a.sampleType,c=o?.type??"filtering";if(this._textureState&n&&"depth"!==u&&(a.autoBindSampler&&(c="non-filtering"),u="unfilterable-float"),s.texture.sampleType=u,o){const e=t.bindGroupLayoutEntryInfo[o.binding.groupIndex][o.binding.bindingIndex].index;r[o.binding.groupIndex][e].sampler.type=c}n<<=1}}}const s=[];for(let e=0;e<r.length;++e)s[e]=this._device.createBindGroupLayout({entries:r[e]});return e.bindGroupLayouts[this._textureState]=s,this._device.createPipelineLayout({bindGroupLayouts:s})}_getVertexInputDescriptor(e){const t=[],r=e._pipelineContext,n=r.shaderProcessingContext.attributeNamesFromEffect,s=r.shaderProcessingContext.attributeLocationsFromEffect;let i,a;for(let e=0;e<n.length;e++){const r=s[e];let o=(this._overrideVertexBuffers&&this._overrideVertexBuffers[n[e]])??this._vertexBuffers[n[e]];o||(o=this._emptyVertexBuffer);let u=o.effectiveBuffer?.underlyingResource,c=o.effectiveByteOffset;const l=!o._validOffsetRange;if(!i||!a||i!==u||l){const e={arrayStride:o.effectiveByteStride,stepMode:o.getIsInstanced()?"instance":"vertex",attributes:[]};t.push(e),a=e.attributes,l&&(c=0,u=null)}a.push({shaderLocation:r,offset:c,format:qe._GetVertexInputDescriptorFormat(o)}),i=u}return t}_createRenderPipeline(e,t,r){const n=e._pipelineContext,s=this._getVertexInputDescriptor(e),i=this._createPipelineLayout(n),o=[];if(this._vertexBuffers&&function(e,t){const r=t.getEngine(),n=t._pipelineContext;if(!n?.vertexBufferKindToType)return;let s=null;for(const i in e){const a=e[i];if(!a||!Ge[i])continue;const o=a.normalized?Oe.R.FLOAT:a.type,u=n.vertexBufferKindToType[i];(o!==Oe.R.FLOAT&&void 0===u||void 0!==u&&u!==o)&&(s||(s=r._getShaderProcessingContext(t.shaderLanguage,!1)),n.vertexBufferKindToType[i]=o,o!==Oe.R.FLOAT&&(s.vertexBufferKindToNumberOfComponents[i]=Oe.R.DeduceStride(i),Ue(o)&&(s.vertexBufferKindToNumberOfComponents[i]*=-1)))}if(s){const e=r._caps.parallelShaderCompile;r._caps.parallelShaderCompile=void 0,t._processShaderCodeAsync(null,r._features._checkNonFloatVertexBuffersDontRecreatePipelineContext,s),r._caps.parallelShaderCompile=e}}(this._vertexBuffers,e),this._mrtAttachments>0)for(let e=0;e<this._mrtFormats.length;++e){const t=this._mrtFormats[e];if(t){const r={format:t,writeMask:this._mrtEnabledMask&1<<e?this._writeMask:0},n=this._getAphaBlendState(e<this._numAlphaBlendTargetsEnabled?e:0),s=this._getColorBlendState(e<this._numAlphaBlendTargetsEnabled?e:0);n&&s&&(r.blend={alpha:n,color:s}),o.push(r)}else o.push(null)}else if(this._webgpuColorFormat[0]){const e={format:this._webgpuColorFormat[0],writeMask:this._writeMask},t=this._getAphaBlendState(0),r=this._getColorBlendState(0);t&&r&&(e.blend={alpha:t,color:r}),o.push(e)}else o.push(null);const u={compare:qe._GetCompareFunction(this._stencilEnabled?this._stencilFrontCompare:7),depthFailOp:qe._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontDepthFailOp:1),failOp:qe._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontFailOp:1),passOp:qe._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontPassOp:1)},c={compare:qe._GetCompareFunction(this._stencilEnabled?this._stencilBackCompare:7),depthFailOp:qe._GetStencilOpFunction(this._stencilEnabled?this._stencilBackDepthFailOp:1),failOp:qe._GetStencilOpFunction(this._stencilEnabled?this._stencilBackFailOp:1),passOp:qe._GetStencilOpFunction(this._stencilEnabled?this._stencilBackPassOp:1)},l="triangle-list"===t||"triangle-strip"===t;let h;"line-strip"!==t&&"triangle-strip"!==t||(h=!this.indexBuffer||this.indexBuffer.is32Bits?"uint32":"uint16");const d=!!this._webgpuDepthStencilFormat&&a.HasStencilAspect(this._webgpuDepthStencilFormat);return this._device.createRenderPipeline({label:`RenderPipeline_${o[0]?.format??"nooutput"}_${this._webgpuDepthStencilFormat??"nodepth"}_samples${r}_textureState${this._textureState}`,layout:i,vertex:{module:n.stages.vertexStage.module,entryPoint:n.stages.vertexStage.entryPoint,buffers:s},primitive:{topology:t,stripIndexFormat:h,frontFace:1===this._frontFace?"ccw":"cw",cullMode:this._cullEnabled?2===this._cullFace?"front":"back":"none"},fragment:n.stages.fragmentStage?{module:n.stages.fragmentStage.module,entryPoint:n.stages.fragmentStage.entryPoint,targets:o}:void 0,multisample:{count:r},depthStencil:void 0===this._webgpuDepthStencilFormat?void 0:{depthWriteEnabled:this._depthWriteEnabled,depthCompare:this._depthTestEnabled?qe._GetCompareFunction(this._depthCompare):"always",format:this._webgpuDepthStencilFormat,stencilFront:this._stencilEnabled&&d?u:void 0,stencilBack:this._stencilEnabled&&d?c:void 0,stencilReadMask:this._stencilEnabled&&d?this._stencilReadMask:void 0,stencilWriteMask:this._stencilEnabled&&d?this._stencilWriteMask:void 0,depthBias:this._depthBias,depthBiasClamp:l?this._depthBiasClamp:0,depthBiasSlopeScale:l?this._depthBiasSlopeScale:0}})}}qe.LogErrorIfNoVertexBuffer=!1,qe.NumCacheHitWithoutHash=0,qe.NumCacheHitWithHash=0,qe.NumCacheMiss=0,qe.NumPipelineCreationLastFrame=0,qe._NumPipelineCreationCurrentFrame=0;class He{constructor(){this.values={}}count(){let e=0,t=this.pipeline?1:0;for(const r in this.values){const n=this.values[r],[s,i]=n.count();e+=s,t+=i,e++}return[e,t]}}class Ye extends qe{static GetNodeCounts(){const e=Ye._Cache.count();return{nodeCount:e[0],pipelineCount:e[1]}}static _GetPipelines(e,t,r,n){if(e.pipeline){const e=r.slice();e.length=n,t.push(e)}for(const s in e.values){const i=e.values[s];r[n]=parseInt(s),Ye._GetPipelines(i,t,r,n+1)}}static GetPipelines(){const e=[];return Ye._GetPipelines(Ye._Cache,e,[],0),e}static ResetCache(){Ye._Cache=new He}reset(){this._nodeStack=[],this._nodeStack[0]=Ye._Cache,super.reset()}_getRenderPipeline(e){let t=this._nodeStack[this._stateDirtyLowestIndex];for(let e=this._stateDirtyLowestIndex;e<this._statesLength;++e){let r=t.values[this._states[e]];r||(r=new He,t.values[this._states[e]]=r),t=r,this._nodeStack[e+1]=t}e.token=t,e.pipeline=t.pipeline}_setRenderPipeline(e){e.token.pipeline=e.pipeline}}Ye._Cache=new He;var Qe=r(82724);class ze extends Qe.u{constructor(e){super(!1),this._cache=e,this.reset()}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._cache.setStencilCompare(e))}get backFunc(){return this._backFunc}set backFunc(e){this._backFunc!==e&&(this._backFunc=e,this._cache.setStencilBackCompare(e))}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._cache.setStencilReadMask(e))}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._cache.setStencilFailOp(e))}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._cache.setStencilDepthFailOp(e))}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._cache.setStencilPassOp(e))}get backOpStencilFail(){return this._backOpStencilFail}set backOpStencilFail(e){this._backOpStencilFail!==e&&(this._backOpStencilFail=e,this._cache.setStencilBackFailOp(e))}get backOpDepthFail(){return this._backOpDepthFail}set backOpDepthFail(e){this._backOpDepthFail!==e&&(this._backOpDepthFail=e,this._cache.setStencilBackDepthFailOp(e))}get backOpStencilDepthPass(){return this._backOpStencilDepthPass}set backOpStencilDepthPass(e){this._backOpStencilDepthPass!==e&&(this._backOpStencilDepthPass=e,this._cache.setStencilBackPassOp(e))}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._cache.setStencilWriteMask(e))}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._cache.setStencilEnabled(e))}reset(){super.reset(),this._cache.resetStencilState()}apply(){const e=!this.useStencilGlobalOnly&&!!this.stencilMaterial?.enabled;this.enabled=e?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.enabled&&(this.mask=e?this.stencilMaterial.mask:this.stencilGlobal.mask,this.funcRef=e?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=e?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.func=e?this.stencilMaterial.func:this.stencilGlobal.func,this.opStencilFail=e?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=e?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=e?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.backFunc=e?this.stencilMaterial.backFunc:this.stencilGlobal.backFunc,this.backOpStencilFail=e?this.stencilMaterial.backOpStencilFail:this.stencilGlobal.backOpStencilFail,this.backOpDepthFail=e?this.stencilMaterial.backOpDepthFail:this.stencilGlobal.backOpDepthFail,this.backOpStencilDepthPass=e?this.stencilMaterial.backOpStencilDepthPass:this.stencilGlobal.backOpStencilDepthPass)}}var Xe=r(86867);class Ke extends Xe.N{constructor(e){super(!1),this._cache=e,this.reset()}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0,this._cache.setDepthBiasSlopeScale(e))}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0,this._cache.setDepthBias(e))}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0,this._cache.setCullFace(e??1))}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0,this._cache.setCullEnabled(!!e))}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0,this._cache.setDepthCompare(e))}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0,this._cache.setDepthWriteEnabled(e))}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0,this._cache.setDepthTestEnabled(e))}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0,this._cache.setFrontFace(e??2))}reset(){super.reset(),this._cache.resetDepthCullingState()}apply(){}}class je{static IsExternalTexture(e){return void 0!==e.underlyingResource}getClassName(){return"ExternalTexture"}get underlyingResource(){return this._video}constructor(e){this.useMipMaps=!1,this.type=16,this.format=4294967295,this._video=e,this.uniqueId=J.h._Counter++}isReady(){return this._video.readyState>=this._video.HAVE_CURRENT_DATA}dispose(){}}class Je{get forceBindGroupCreation(){return this._numExternalTextures>0}get hasFloatOrDepthTextures(){return this._numFloatOrDepthTextures>0}constructor(){this.useVertexPulling=!1,this.uniqueId=Je._Counter++,this.updateId=0,this.textureState=0,this.reset()}reset(){this.samplers={},this.textures={},this.isDirty=!0,this._numFloatOrDepthTextures=0,this._numExternalTextures=0}setSampler(e,t){let r=this.samplers[e],n=-1;r?n=r.hashCode:this.samplers[e]=r={sampler:t,hashCode:0},r.sampler=t,r.hashCode=t?Me.GetSamplerHashCode(t):0;const s=n!==r.hashCode;s&&this.updateId++,this.isDirty||(this.isDirty=s)}setTexture(e,t){let r=this.textures[e],n=-1;r?n=r.texture?.uniqueId??-1:this.textures[e]=r={texture:t,isFloatOrDepthTexture:!1,isExternalTexture:!1},r.isExternalTexture&&this._numExternalTextures--,r.isFloatOrDepthTexture&&this._numFloatOrDepthTextures--,t?(r.isFloatOrDepthTexture=1===t.type||t.format>=13&&t.format<=18,r.isExternalTexture=je.IsExternalTexture(t),r.isFloatOrDepthTexture&&this._numFloatOrDepthTextures++,r.isExternalTexture&&this._numExternalTextures++):(r.isFloatOrDepthTexture=!1,r.isExternalTexture=!1),r.texture=t;const s=n!==(t?.uniqueId??-1);s&&this.updateId++,this.isDirty||(this.isDirty=s)}}Je._Counter=0;class Ze{isDirty(e){return this._isDirty||this._materialContextUpdateId!==e}resetIsDirty(e){this._isDirty=!1,this._materialContextUpdateId=e}get enableIndirectDraw(){return this._enableIndirectDraw}set enableIndirectDraw(e){this._enableIndirectDrawInCompatMode=!0,this._enableIndirectDraw!==e&&(this._enableIndirectDraw=e,e||this._useInstancing||!this.indirectDrawBuffer?e&&!this.indirectDrawBuffer&&(this.indirectDrawBuffer=this._bufferManager.createRawBuffer(20,p.CopyDst|p.Indirect|p.Storage,void 0,"IndirectDrawBuffer"),this._indirectDrawData=new Uint32Array(5),this._indirectDrawData[3]=0,this._indirectDrawData[4]=0):(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0))}get useInstancing(){return this._useInstancing}set useInstancing(e){if(this._useInstancing===e)return;this._useInstancing=e,this._currentInstanceCount=-1;const t=this._enableIndirectDrawInCompatMode;this.enableIndirectDraw=e,this._enableIndirectDrawInCompatMode=t}constructor(e,t){this._dummyIndexBuffer=t,this._enableIndirectDrawInCompatMode=!1,this._bufferManager=e,this.uniqueId=Ze._Counter++,this._useInstancing=!1,this._currentInstanceCount=0,this._enableIndirectDraw=!1,this._vertexPullingEnabled=!1,this.reset()}reset(){this.buffers={},this._isDirty=!0,this._materialContextUpdateId=0,this.fastBundle=void 0,this.bindGroups=void 0,this._vertexPullingEnabled=!1}setBuffer(e,t){this._isDirty||(this._isDirty=t?.uniqueId!==this.buffers[e]?.uniqueId),this.buffers[e]=t}setIndirectData(e,t,r,n=!1){(n||t!==this._currentInstanceCount)&&this.indirectDrawBuffer&&this._indirectDrawData&&(this._currentInstanceCount=t,this._indirectDrawData[0]=e,this._indirectDrawData[1]=t,this._indirectDrawData[2]=r,this._bufferManager.setRawData(this.indirectDrawBuffer,0,this._indirectDrawData,0,20))}setVertexPulling(e,t,r,n,s){if(this._vertexPullingEnabled===e)return;this._vertexPullingEnabled=e,this._isDirty=!0;const i=t.shaderProcessingContext.bufferNames;if(s)for(const t in s){const r=s[t];if(!r||-1===i.indexOf(t))continue;const n=r.effectiveBuffer;this.setBuffer(t,e?n:null)}for(const t in r){if(s&&t in s)continue;const n=r[t];if(!n||-1===i.indexOf(t))continue;const a=n.effectiveBuffer;this.setBuffer(t,e?a:null)}-1!==i.indexOf("indices")&&this.setBuffer("indices",e?n??this._dummyIndexBuffer:null)}dispose(){this.indirectDrawBuffer&&(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this.fastBundle=void 0,this.bindGroups=void 0,this.buffers=void 0,this._enableIndirectDraw=!1}}Ze._Counter=0;const et=2**35;class tt{constructor(){this.values={}}}class rt{static get Statistics(){return{totalCreated:rt.NumBindGroupsCreatedTotal,lastFrameCreated:rt.NumBindGroupsCreatedLastFrame,lookupLastFrame:rt.NumBindGroupsLookupLastFrame,noLookupLastFrame:rt.NumBindGroupsNoLookupLastFrame}}static ResetCache(){rt._Cache=new tt,rt.NumBindGroupsCreatedTotal=0,rt.NumBindGroupsCreatedLastFrame=0,rt.NumBindGroupsLookupLastFrame=0,rt.NumBindGroupsNoLookupLastFrame=0,rt._NumBindGroupsCreatedCurrentFrame=0,rt._NumBindGroupsLookupCurrentFrame=0,rt._NumBindGroupsNoLookupCurrentFrame=0}constructor(e,t,r){this.disabled=!1,this._device=e,this._cacheSampler=t,this._engine=r}endFrame(){rt.NumBindGroupsCreatedLastFrame=rt._NumBindGroupsCreatedCurrentFrame,rt.NumBindGroupsLookupLastFrame=rt._NumBindGroupsLookupCurrentFrame,rt.NumBindGroupsNoLookupLastFrame=rt._NumBindGroupsNoLookupCurrentFrame,rt._NumBindGroupsCreatedCurrentFrame=0,rt._NumBindGroupsLookupCurrentFrame=0,rt._NumBindGroupsNoLookupCurrentFrame=0}getBindGroups(e,t,r){let s,i=rt._Cache;const a=this.disabled||r.forceBindGroupCreation;if(!a){if(!t.isDirty(r.updateId)&&!r.isDirty)return rt._NumBindGroupsNoLookupCurrentFrame++,t.bindGroups;for(const r of e.shaderProcessingContext.bufferNames){const e=(t.buffers[r]?.uniqueId??0)+1048576;let n=i.values[e];n||(n=new tt,i.values[e]=n),i=n}for(const t of e.shaderProcessingContext.samplerNames){const e=r.samplers[t]?.hashCode??0;let n=i.values[e];n||(n=new tt,i.values[e]=n),i=n}for(const t of e.shaderProcessingContext.textureNames){const e=(r.textures[t]?.texture?.uniqueId??0)+et;let n=i.values[e];n||(n=new tt,i.values[e]=n),i=n}s=i.bindGroups}if(t.resetIsDirty(r.updateId),r.isDirty=!1,s)return t.bindGroups=s,rt._NumBindGroupsLookupCurrentFrame++,s;s=[],t.bindGroups=s,a||(i.bindGroups=s),rt.NumBindGroupsCreatedTotal++,rt._NumBindGroupsCreatedCurrentFrame++;const o=e.bindGroupLayouts[r.textureState];for(let i=0;i<e.shaderProcessingContext.bindGroupLayoutEntries.length;i++){const a=e.shaderProcessingContext.bindGroupLayoutEntries[i],u=e.shaderProcessingContext.bindGroupEntries[i];for(let s=0;s<a.length;s++){const a=e.shaderProcessingContext.bindGroupLayoutEntries[i][s],o=e.shaderProcessingContext.bindGroupLayoutEntryInfo[i][a.binding],c=o.nameInArrayOfTexture??o.name;if(a.sampler){const e=r.samplers[c];if(e){const t=e.sampler;if(!t){this._engine.dbgSanityChecks&&n.V.Error(`Trying to bind a null sampler! entry=${JSON.stringify(a)}, name=${c}, bindingInfo=${JSON.stringify(e,(e,t)=>"texture"===e?"<no dump>":t)}, materialContext.uniqueId=${r.uniqueId}`,50);continue}u[s].resource=this._cacheSampler.getSampler(t,!1,e.hashCode,t.label)}else n.V.Error(`Sampler "${c}" not found in the material context. Make sure you bound it. entry=${JSON.stringify(a)}, materialContext=${JSON.stringify(r,(e,t)=>"texture"===e||"sampler"===e?"<no dump>":t)}`,50)}else if(a.texture||a.storageTexture){const e=r.textures[c];if(e){if(this._engine.dbgSanityChecks&&null===e.texture){n.V.Error(`Trying to bind a null texture! name="${c}", entry=${JSON.stringify(a)}, bindingInfo=${JSON.stringify(e,(e,t)=>"texture"===e?"<no dump>":t)}, materialContext.uniqueId=${r.uniqueId}`,50);continue}const t=e.texture._hardwareTexture;if(this._engine.dbgSanityChecks&&(!t||a.texture&&!t.view||a.storageTexture&&!t.viewForWriting)){n.V.Error(`Trying to bind a null gpu texture or view! entry=${JSON.stringify(a)}, name=${c}, bindingInfo=${JSON.stringify(e,(e,t)=>"texture"===e?"<no dump>":t)}, isReady=${e.texture?.isReady}, materialContext.uniqueId=${r.uniqueId}`,50);continue}u[s].resource=a.storageTexture?t.viewForWriting:t.view}else n.V.Error(`Texture "${c}" not found in the material context. Make sure you bound it (something like effect.setTexture("${c}", texture)). entry=${JSON.stringify(a)}, materialContext=${JSON.stringify(r,(e,t)=>"texture"===e||"sampler"===e?"<no dump>":t)}`,50)}else if(a.externalTexture){const e=r.textures[c];if(e){if(this._engine.dbgSanityChecks&&null===e.texture){n.V.Error(`Trying to bind a null external texture! entry=${JSON.stringify(a)}, name=${c}, bindingInfo=${JSON.stringify(e,(e,t)=>"texture"===e?"<no dump>":t)}, materialContext.uniqueId=${r.uniqueId}`,50);continue}const t=e.texture.underlyingResource;if(this._engine.dbgSanityChecks&&!t){n.V.Error(`Trying to bind a null gpu external texture! entry=${JSON.stringify(a)}, name=${c}, bindingInfo=${JSON.stringify(e,(e,t)=>"texture"===e?"<no dump>":t)}, isReady=${e.texture?.isReady}, materialContext.uniqueId=${r.uniqueId}`,50);continue}u[s].resource=this._device.importExternalTexture({source:t})}else n.V.Error(`External texture "${c}" not found in the material context. Make sure you bound it. entry=${JSON.stringify(a)}, materialContext=${JSON.stringify(r,(e,t)=>"texture"===e||"sampler"===e?"<no dump>":t)}`,50)}else if(a.buffer){const e=t.buffers[c];if(e){const t=e.underlyingResource;u[s].resource.buffer=t,u[s].resource.size=e.capacity}else n.V.Error(`Can't find buffer "${c}" in the draw context. Make sure you bound it. entry=${JSON.stringify(a)}, buffers=${JSON.stringify(t.buffers)}, drawContext.uniqueId=${t.uniqueId}`,50)}}const c=o[i];s[i]=this._device.createBindGroup({layout:c,entries:u})}return s}}rt.NumBindGroupsCreatedTotal=0,rt.NumBindGroupsCreatedLastFrame=0,rt.NumBindGroupsLookupLastFrame=0,rt.NumBindGroupsNoLookupLastFrame=0,rt._Cache=new tt,rt._NumBindGroupsCreatedCurrentFrame=0,rt._NumBindGroupsLookupCurrentFrame=0,rt._NumBindGroupsNoLookupCurrentFrame=0;var nt=r(69610);const st="clearQuadVertexShader",it="uniform depthValue: f32;const pos=array(\nvec2f(-1.0,1.0),\nvec2f(1.0,1.0),\nvec2f(-1.0,-1.0),\nvec2f(1.0,-1.0)\n);\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.position=vec4f(pos[input.vertexIndex],uniforms.depthValue,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}\n";nt.l.ShadersStoreWGSL[st]||(nt.l.ShadersStoreWGSL[st]=it);const at="clearQuadPixelShader",ot="uniform color: vec4f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=uniforms.color;}\n";nt.l.ShadersStoreWGSL[at]||(nt.l.ShadersStoreWGSL[at]=ot);class ut{setDepthStencilFormat(e){this._depthTextureFormat=e,this._cacheRenderPipeline.setDepthStencilFormat(e)}setColorFormat(e){this._cacheRenderPipeline.setColorFormat(e)}setMRTAttachments(e,t,r){this._cacheRenderPipeline.setMRT(t,r),this._cacheRenderPipeline.setMRTAttachments(e)}constructor(e,t,r){this._bindGroups={},this._bundleCache={},this._keyTemp=[],this._device=e,this._engine=t,this._cacheRenderPipeline=new Ye(this._device,r),this._cacheRenderPipeline.setDepthTestEnabled(!1),this._cacheRenderPipeline.setStencilReadMask(255),this._effect=t.createEffect("clearQuad",[],["color","depthValue"],void 0,void 0,void 0,void 0,void 0,void 0,1)}clear(e,t,r,n,s=1){let i,o,u=null;const c=!!this._engine._currentRenderTarget;if(e)i=e;else{let e=0;this._keyTemp.length=0;for(let t=0;t<this._cacheRenderPipeline.colorFormats.length;++t)this._keyTemp[e++]=Te[this._cacheRenderPipeline.colorFormats[t]??""];const l=Te[this._depthTextureFormat??0];if(this._keyTemp[e]=(t?t.r+256*t.g+256*t.b*256+256*t.a*256*256:0)+(r?2**32:0)+(n?2**33:0)+(this._engine.useReverseDepthBuffer?2**34:0)+(c?2**35:0)+(s>1?2**36:0)+l*2**37,o=this._keyTemp.join("_"),u=this._bundleCache[o],u)return u;i=this._device.createRenderBundleEncoder({label:"clearQuadRenderBundle",colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:a.GetSample(s)})}this._cacheRenderPipeline.setDepthWriteEnabled(!!r),this._cacheRenderPipeline.setStencilEnabled(!!n&&!!this._depthTextureFormat&&a.HasStencilAspect(this._depthTextureFormat)),this._cacheRenderPipeline.setStencilWriteMask(n?255:0),this._cacheRenderPipeline.setStencilCompare(n?519:512),this._cacheRenderPipeline.setStencilPassOp(n?7681:7680),this._cacheRenderPipeline.setWriteMask(t?15:0);const l=this._cacheRenderPipeline.getRenderPipeline(7,this._effect,s),h=this._effect._pipelineContext;t&&this._effect.setDirectColor4("color",t),this._effect.setFloat("depthValue",this._engine.useReverseDepthBuffer?this._engine._clearReverseDepthValue:this._engine._clearDepthValue),h.uniformBuffer.update();const d=c?this._engine._ubInvertY:this._engine._ubDontInvertY,p=h.uniformBuffer.getBuffer(),f=p.uniqueId+"-"+d.uniqueId;let g=this._bindGroups[f];if(!g){const e=h.bindGroupLayouts[0];g=this._bindGroups[f]=[],g.push(this._device.createBindGroup({label:`clearQuadBindGroup0-${f}`,layout:e[0],entries:[]})),ie._SimplifiedKnownBindings||g.push(this._device.createBindGroup({label:`clearQuadBindGroup1-${f}`,layout:e[1],entries:[]})),g.push(this._device.createBindGroup({label:`clearQuadBindGroup${ie._SimplifiedKnownBindings?1:2}-${f}`,layout:e[ie._SimplifiedKnownBindings?1:2],entries:[{binding:0,resource:{buffer:d.underlyingResource,size:d.capacity}},{binding:1,resource:{buffer:p.underlyingResource,size:p.capacity}}]}))}i.setPipeline(l);for(let e=0;e<g.length;++e)i.setBindGroup(e,g[e]);return i.draw(4,1,0,0),e||(u=i.finish(),this._bundleCache[o]=u),u}}class ct{constructor(e,t,r,n){this.x=Math.floor(e),this.y=Math.floor(t),this.w=Math.floor(r),this.h=Math.floor(n)}run(e){e.setViewport(this.x,this.y,this.w,this.h,0,1)}clone(){return new ct(this.x,this.y,this.w,this.h)}}class lt{constructor(e,t,r,n){this.x=e,this.y=t,this.w=r,this.h=n}run(e){e.setScissorRect(this.x,this.y,this.w,this.h)}clone(){return new lt(this.x,this.y,this.w,this.h)}}class ht{constructor(e){this.ref=e}run(e){e.setStencilReference(this.ref)}clone(){return new ht(this.ref)}}class dt{constructor(e){this.color=e}run(e){e.setBlendConstant(this.color)}clone(){return new dt(this.color)}}class pt{constructor(e){this.query=e}run(e){e.beginOcclusionQuery(this.query)}clone(){return new pt(this.query)}}class ft{constructor(){}run(e){e.endOcclusionQuery()}clone(){return new ft}}class gt{constructor(){this.bundles=[]}run(e){e.executeBundles(this.bundles)}clone(){const e=new gt;return e.bundles=this.bundles,e}}class mt{constructor(e){this.numDrawCalls=0,this._device=e,this._list=new Array(10),this._listLength=0}addBundle(e){if(!this._currentItemIsBundle){const e=new gt;this._list[this._listLength++]=e,this._currentBundleList=e.bundles,this._currentItemIsBundle=!0}e&&this._currentBundleList.push(e)}_finishBundle(){this._currentItemIsBundle&&this._bundleEncoder&&(this._currentBundleList.push(this._bundleEncoder.finish()),this._bundleEncoder=void 0,this._currentItemIsBundle=!1)}addItem(e){this._finishBundle(),this._list[this._listLength++]=e,this._currentItemIsBundle=!1}getBundleEncoder(e,t,r){return this._currentItemIsBundle||(this.addBundle(),this._bundleEncoder=this._device.createRenderBundleEncoder({colorFormats:e,depthStencilFormat:t,sampleCount:a.GetSample(r)})),this._bundleEncoder}close(){this._finishBundle()}run(e){this.close();for(let t=0;t<this._listLength;++t)this._list[t].run(e)}reset(){this._listLength=0,this._currentItemIsBundle=!1,this.numDrawCalls=0}clone(){this.close();const e=new mt(this._device);e._list=new Array(this._listLength),e._listLength=this._listLength,e.numDrawCalls=this.numDrawCalls;for(let t=0;t<this._listLength;++t)e._list[t]=this._list[t].clone();return e}}class _t{get querySet(){return this._querySet}constructor(e,t,r,n,s,i=!0,a){this._dstBuffers=[],this._engine=e,this._device=n,this._bufferManager=s,this._count=t,this._canUseMultipleBuffers=i,this._querySet=n.createQuerySet({label:a??"QuerySet",type:r,count:t}),this._queryBuffer=s.createRawBuffer(8*t,p.QueryResolve|p.CopySrc,void 0,"QueryBuffer"),i||this._dstBuffers.push(this._bufferManager.createRawBuffer(8*this._count,p.MapRead|p.CopyDst,void 0,"QueryBufferNoMultipleBuffers"))}_getBuffer(e,t){if(!this._canUseMultipleBuffers&&0===this._dstBuffers.length)return null;const r=this._device.createCommandEncoder();let n;return 0===this._dstBuffers.length?n=this._bufferManager.createRawBuffer(8*this._count,p.MapRead|p.CopyDst,void 0,"QueryBufferAdditionalBuffer"):(n=this._dstBuffers[this._dstBuffers.length-1],this._dstBuffers.length--),r.resolveQuerySet(this._querySet,e,t,this._queryBuffer,0),r.copyBufferToBuffer(this._queryBuffer,0,n,0,8*t),this._device.queue.submit([r.finish()]),n}async readValues(e=0,t=1){const r=this._getBuffer(e,t);if(null===r)return null;const n=this._engine.uniqueId;try{await r.mapAsync(1);const e=new BigUint64Array(r.getMappedRange()).slice();return r.unmap(),this._dstBuffers[this._dstBuffers.length]=r,e}catch(e){if(this._engine.isDisposed||this._engine.uniqueId!==n)return null;throw e}}async readValue(e=0){const t=this._getBuffer(e,1);if(null===t)return null;const r=this._engine.uniqueId;try{await t.mapAsync(1);const e=new BigUint64Array(t.getMappedRange()),r=Number(e[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,r}catch(e){if(this._engine.isDisposed||this._engine.uniqueId!==r)return 0;throw e}}async readTwoValuesAndSubtract(e=0){const t=this._getBuffer(e,2);if(null===t)return null;const r=this._engine.uniqueId;try{await t.mapAsync(1);const e=new BigUint64Array(t.getMappedRange()),r=Number(e[1]-e[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,r}catch(e){if(this._engine.isDisposed||this._engine.uniqueId!==r)return 0;throw e}}dispose(){this._querySet.destroy(),this._bufferManager.releaseBuffer(this._queryBuffer);for(let e=0;e<this._dstBuffers.length;++e)this._bufferManager.releaseBuffer(this._dstBuffers[e])}}class bt{get gpuFrameTimeCounter(){return this._gpuFrameTimeCounter}constructor(e,t,r){this._enabled=!1,this._gpuFrameTimeCounter=new o.A,this._measureDurationState=0,this._engine=e,this._device=t,this._bufferManager=r}get enable(){return this._enabled}set enable(e){if(this._enabled!==e)if(this._enabled=e,this._measureDurationState=0,e)try{this._measureDuration=new xt(this._engine,this._device,this._bufferManager,2e3,"QuerySet_TimestampQuery")}catch(e){return this._enabled=!1,void n.V.Error("Could not create a WebGPUDurationMeasure!\nError: "+e.message+"\nMake sure timestamp query is supported and enabled in your browser.")}else this._measureDuration.dispose()}startFrame(e){this._enabled&&0===this._measureDurationState&&(this._measureDuration.start(e),this._measureDurationState=1)}endFrame(e){1===this._measureDurationState&&(this._measureDurationState=2,this._measureDuration.stop(e).then(e=>{null!==e&&e>=0&&(this._gpuFrameTimeCounter.fetchNewFrame(),this._gpuFrameTimeCounter.addCount(e,!0)),this._measureDurationState=0}))}startPass(e,t){this._enabled?this._measureDuration.startPass(e,t):e.timestampWrites=void 0}endPass(e,t){if(!this._enabled||!t)return;const r=this._engine.frameId;this._measureDuration.stopPass(e).then(e=>{t._addDuration(r,null!==e&&e>0?e:0)})}dispose(){this._measureDuration?.dispose()}}class xt{constructor(e,t,r,n=2,s){this._count=n,this._querySet=new _t(e,n,"timestamp",t,r,!0,s)}start(e){e.writeTimestamp?.(this._querySet.querySet,0)}async stop(e){return e.writeTimestamp?.(this._querySet.querySet,1),e.writeTimestamp?await this._querySet.readTwoValuesAndSubtract(0):0}startPass(e,t){if(t+3>this._count)throw new Error("WebGPUDurationMeasure: index out of range ("+t+")");e.timestampWrites={querySet:this._querySet.querySet,beginningOfPassWriteIndex:t+2,endOfPassWriteIndex:t+3}}async stopPass(e){return await this._querySet.readTwoValuesAndSubtract(e+2)}dispose(){this._querySet.dispose()}}class yt{get querySet(){return this._querySet.querySet}get hasQueries(){return this._currentTotalIndices!==this._availableIndices.length}canBeginQuery(e){if(this._frameQuerySetIsDirty===this._engine.frameId||this._queryFrameId[e]===this._engine.frameId)return!1;const t=void 0!==this._engine._getCurrentRenderPassWrapper().renderPassDescriptor.occlusionQuerySet;return t&&(this._queryFrameId[e]=this._engine.frameId),t}constructor(e,t,r,n=50,s=100){this._availableIndices=[],this._frameQuerySetIsDirty=-1,this._queryFrameId=[],this._engine=e,this._device=t,this._bufferManager=r,this._frameLastBuffer=-1,this._currentTotalIndices=0,this._countIncrement=s,this._allocateNewIndices(n)}createQuery(){0===this._availableIndices.length&&this._allocateNewIndices();const e=this._availableIndices[this._availableIndices.length-1];return this._availableIndices.length--,e}deleteQuery(e){this._availableIndices[this._availableIndices.length]=e}isQueryResultAvailable(e){return this._retrieveQueryBuffer(),!!this._lastBuffer&&e<this._lastBuffer.length}getQueryResult(e){return Number(this._lastBuffer?.[e]??-1)}_retrieveQueryBuffer(){this._lastBuffer&&this._frameLastBuffer===this._engine.frameId||this._frameLastBuffer!==this._engine.frameId&&(this._frameLastBuffer=this._engine.frameId,this._querySet.readValues(0,this._currentTotalIndices).then(e=>{this._lastBuffer=e}))}_allocateNewIndices(e){e=e??this._countIncrement,this._delayQuerySetDispose();for(let t=0;t<e;++t)this._availableIndices.push(this._currentTotalIndices+t);this._currentTotalIndices+=e,this._querySet=new _t(this._engine,this._currentTotalIndices,"occlusion",this._device,this._bufferManager,!1,"QuerySet_OcclusionQuery_count_"+this._currentTotalIndices),this._frameQuerySetIsDirty=this._engine.frameId}_delayQuerySetDispose(){const e=this._querySet;e&&setTimeout(()=>e.dispose,1e3)}dispose(){this._querySet?.dispose(),this._availableIndices.length=0}}class St{get code(){return this._sourceCode}constructor(e,t=20){this.debug=!1,this._sourceCode=e,this._numMaxIterations=t,this._functionDescr=[],this.inlineToken="#define inline"}processCode(){this.debug&&n.V.Log(`Start inlining process (code size=${this._sourceCode.length})...`),this._collectFunctions(),this._processInlining(this._numMaxIterations),this.debug&&n.V.Log("End of inlining process.")}_collectFunctions(){let e=0;for(;e<this._sourceCode.length;){const t=this._sourceCode.indexOf(this.inlineToken,e);if(t<0)break;const r=this._sourceCode.indexOf("(",t+this.inlineToken.length);if(r<0){this.debug&&n.V.Warn(`Could not find the opening parenthesis after the token. startIndex=${e}`),e=t+this.inlineToken.length;continue}const s=St._RegexpFindFunctionNameAndType.exec(this._sourceCode.substring(t+this.inlineToken.length,r));if(!s){this.debug&&n.V.Warn(`Could not extract the name/type of the function from: ${this._sourceCode.substring(t+this.inlineToken.length,r)}`),e=t+this.inlineToken.length;continue}const[i,a]=[s[3],s[4]],o=ae("(",")",this._sourceCode,r);if(o<0){this.debug&&n.V.Warn(`Could not extract the parameters the function '${a}' (type=${i}). funcParamsStartIndex=${r}`),e=t+this.inlineToken.length;continue}const u=this._sourceCode.substring(r+1,o),c=oe(this._sourceCode,o+1);if(c===this._sourceCode.length){this.debug&&n.V.Warn(`Could not extract the body of the function '${a}' (type=${i}). funcParamsEndIndex=${o}`),e=t+this.inlineToken.length;continue}const l=ae("{","}",this._sourceCode,c);if(l<0){this.debug&&n.V.Warn(`Could not extract the body of the function '${a}' (type=${i}). funcBodyStartIndex=${c}`),e=t+this.inlineToken.length;continue}const h=this._sourceCode.substring(c,l+1),d=ce(u).split(","),p=[];for(let e=0;e<d.length;++e){const t=d[e].trim(),r=t.lastIndexOf(" ");r>=0&&p.push(t.substring(r+1))}"void"!==i&&p.push("return"),this._functionDescr.push({name:a,type:i,parameters:p,body:h,callIndex:0}),e=l+1;const f=t>0?this._sourceCode.substring(0,t):"",g=l+1<this._sourceCode.length-1?this._sourceCode.substring(l+1):"";this._sourceCode=f+g,e-=l+1-t}this.debug&&n.V.Log(`Collect functions: ${this._functionDescr.length} functions found. functionDescr=${this._functionDescr}`)}_processInlining(e=20){for(;e-- >=0&&this._replaceFunctionCallsByCode(););return this.debug&&n.V.Log(`numMaxIterations is ${e} after inlining process`),e>=0}_replaceFunctionCallsByCode(){let e=!1;for(const t of this._functionDescr){const{name:r,type:s,parameters:i,body:a}=t;let o=0;for(;o<this._sourceCode.length;){const u=this._sourceCode.indexOf(r,o);if(u<0)break;if(0===u||ue(this._sourceCode.charAt(u-1))){o=u+r.length;continue}const c=oe(this._sourceCode,u+r.length);if(c===this._sourceCode.length||"("!==this._sourceCode.charAt(c)){o=u+r.length;continue}const l=ae("(",")",this._sourceCode,c);if(l<0){this.debug&&n.V.Warn(`Could not extract the parameters of the function call. Function '${r}' (type=${s}). callParamsStartIndex=${c}`),o=u+r.length;continue}const h=this._sourceCode.substring(c+1,l),d=e=>{const t=[];let r=0,n=0;for(;r<e.length;){if("("===e.charAt(r)){const t=ae("(",")",e,r);if(t<0)return null;r=t}else","===e.charAt(r)&&(t.push(e.substring(n,r)),n=r+1);r++}return n<r&&t.push(e.substring(n,r)),t},p=d(ce(h));if(null===p){this.debug&&n.V.Warn(`Invalid function call: can't extract the parameters of the function call. Function '${r}' (type=${s}). callParamsStartIndex=${c}, callParams=`+h),o=u+r.length;continue}const f=[];for(let e=0;e<p.length;++e){const t=p[e].trim();f.push(t)}const g="void"!==s?r+"_"+t.callIndex++:null;if(g&&f.push(g+" ="),f.length!==i.length){this.debug&&n.V.Warn(`Invalid function call: not the same number of parameters for the call than the number expected by the function. Function '${r}' (type=${s}). function parameters=${i}, call parameters=${f}`),o=u+r.length;continue}o=l+1;const m=this._replaceNames(a,i,f);let _=u>0?this._sourceCode.substring(0,u):"";const b=l+1<this._sourceCode.length-1?this._sourceCode.substring(l+1):"";if(g){const e=le(this._sourceCode,u-1,"\n","{");_=this._sourceCode.substring(0,e+1);const t=this._sourceCode.substring(e+1,u);this._sourceCode=_+s+" "+g+";\n"+m+"\n"+t+g+b,this.debug&&n.V.Log(`Replace function call by code. Function '${r}' (type=${s}). injectDeclarationIndex=${e}, call parameters=${f}`)}else this._sourceCode=_+m+b,o+=m.length-(l+1-u),this.debug&&n.V.Log(`Replace function call by code. Function '${r}' (type=${s}). functionCallIndex=${u}, call parameters=${f}`);e=!0}}return e}_replaceNames(e,t,r){for(let n=0;n<t.length;++n){const s=new RegExp(he(t[n]),"g"),i=t[n].length,a=r[n];e=e.replace(s,(r,...s)=>{const o=s[0];return ue(e.charAt(o-1))||ue(e.charAt(o+i))?t[n]:a})}return e}}St._RegexpFindFunctionNameAndType=/((\s+?)(\w+)\s+(\w+)\s*?)$/;class vt{async initTwgsl(e){if(!vt._Twgsl)if(e=e||{},(e={...vt._TwgslDefaultOptions,...e}).twgsl)vt._Twgsl=e.twgsl;else{if(e.jsPath&&e.wasmPath&&await _e.S0.LoadBabylonScriptAsync(e.jsPath),!self.twgsl)throw new Error("twgsl is not available.");vt._Twgsl=await self.twgsl(_e.S0.GetBabylonScriptURL(e.wasmPath))}}convertSpirV2WGSL(e,t=!1){const r=vt._Twgsl.convertSpirV2WGSL(e,vt.DisableUniformityAnalysis||t);return vt.ShowWGSLShaderCode&&(n.V.Log(r),n.V.Log("***********************************************")),vt.DisableUniformityAnalysis||t?"diagnostic(off, derivative_uniformity);\n"+r:r}}vt._TwgslDefaultOptions={jsPath:`${_e.S0._DefaultCdnUrl}/twgsl/twgsl.js`,wasmPath:`${_e.S0._DefaultCdnUrl}/twgsl/twgsl.wasm`},vt.ShowWGSLShaderCode=!1,vt.DisableUniformityAnalysis=!1,vt._Twgsl=null;class Ct{constructor(e,t,r){this._record=!1,this._play=!1,this._playBundleListIndex=0,this._allBundleLists=[],this._enabled=!1,this.showDebugLogs=!1,this._engine=e,this._mode=t,this._bundleList=r}get enabled(){return this._enabled}get play(){return this._play}get record(){return this._record}set enabled(e){this._log("enabled",`activate=${e}, mode=${this._mode}`),this._allBundleLists.length=0,this._record=this._enabled=e,this._play=!1,e&&(this._modeSaved=this._mode,this._mode=0)}get mode(){return this._mode}set mode(e){this._record?this._modeSaved=e:this._mode=e}endRenderPass(e){if(!this._record&&!this._play)return!1;let t=null;return this._record?(t=this._bundleList.clone(),this._allBundleLists.push(t),this._bundleList.reset(),this._log("endRenderPass","bundleList recorded at position #"+(this._allBundleLists.length-1))):this._playBundleListIndex>=this._allBundleLists.length?this._log("endRenderPass",`empty or out-of-sync bundleList (_allBundleLists.length=${this._allBundleLists.length}, playBundleListIndex=${this._playBundleListIndex})`):(this._log("endRenderPass",`run bundleList #${this._playBundleListIndex}`),t=this._allBundleLists[this._playBundleListIndex++]),t&&(t.run(e),1===this._mode&&this._engine._reportDrawCall(t.numDrawCalls)),!0}endFrame(){this._record&&(this._record=!1,this._play=!0,this._mode=this._modeSaved,this._log("endFrame","bundles recorded, switching to play mode")),this._playBundleListIndex=0}reset(){this._log("reset","called"),this._record&&(this._mode=this._modeSaved),this.enabled=!1,this.enabled=!0}_log(e,t){this.showDebugLogs&&n.V.Log(`[Frame: ${this._engine.frameId}] WebGPUSnapshotRendering:${e} - ${t}`)}}var wt=r(26614),Tt=r(11675);const It=(()=>{const e=new Uint8Array(4);return!!((new Uint32Array(e.buffer)[0]=1)&e[0])})();Object.defineProperty(ee.R.prototype,"effectiveByteStride",{get:function(){return this._alignedBuffer&&this._alignedBuffer.byteStride||this.byteStride},enumerable:!0,configurable:!0}),Object.defineProperty(ee.R.prototype,"effectiveByteOffset",{get:function(){return this._alignedBuffer?0:this.byteOffset},enumerable:!0,configurable:!0}),Object.defineProperty(ee.R.prototype,"effectiveBuffer",{get:function(){return this._alignedBuffer&&this._alignedBuffer.getBuffer()||this._buffer.getBuffer()},enumerable:!0,configurable:!0}),ee.R.prototype._rebuild=function(){this._buffer?._rebuild(),this._alignedBuffer?._rebuild()},ee.R.prototype.dispose=function(){this._ownsBuffer&&this._buffer.dispose(),this._alignedBuffer?.dispose(),this._alignedBuffer=void 0,this._isDisposed=!0},ee.R.prototype.getWrapperBuffer=function(){return this._alignedBuffer||this._buffer},ee.R.prototype._alignBuffer=function(){const e=this._buffer.getData();if(!this.engine._features.forceVertexBufferStrideAndOffsetMultiple4Bytes||this.byteStride%4==0&&this.byteOffset%4==0||!e)return;const t=(0,Tt.PD)(this.type),r=this.byteStride+3&-4,n=r/t,s=this._maxVerticesCount,i=s*r/t;let a,o;if(Array.isArray(e)){const t=new Float32Array(e);a=new DataView(t.buffer,t.byteOffset,t.byteLength)}else a=e instanceof ArrayBuffer?new DataView(e,0,e.byteLength):new DataView(e.buffer,e.byteOffset,e.byteLength);o=this.type===ee.R.BYTE?new Int8Array(i):this.type===ee.R.UNSIGNED_BYTE?new Uint8Array(i):this.type===ee.R.SHORT?new Int16Array(i):this.type===ee.R.UNSIGNED_SHORT?new Uint16Array(i):this.type===ee.R.INT?new Int32Array(i):this.type===ee.R.UNSIGNED_INT?new Uint32Array(i):new Float32Array(i);const u=this.getSize();let c=this.byteOffset;for(let e=0;e<s;++e){for(let t=0;t<u;++t)switch(this.type){case ee.R.BYTE:o[e*n+t]=a.getInt8(c+t);break;case ee.R.UNSIGNED_BYTE:o[e*n+t]=a.getUint8(c+t);break;case ee.R.SHORT:o[e*n+t]=a.getInt16(c+2*t,It);break;case ee.R.UNSIGNED_SHORT:o[e*n+t]=a.getUint16(c+2*t,It);break;case ee.R.INT:o[e*n+t]=a.getInt32(c+4*t,It);break;case ee.R.UNSIGNED_INT:o[e*n+t]=a.getUint32(c+4*t,It);break;case ee.R.FLOAT:o[e*n+t]=a.getFloat32(c+4*t,It)}c+=this.byteStride}this._alignedBuffer?.dispose(),this._alignedBuffer=new ee.h(this.engine,o,!1,r,!1,this.getIsInstanced(),!0,this.instanceDivisor,(this._label??"VertexBuffer")+"_aligned")};var Bt=r(77517),Rt=r(84085),At=r(79161),Ft=r(70767),Pt=(r(29967),r(28019),r(46125),r(41611),r(97298),r(94994),r(57647));class Dt extends je{constructor(e){super(e)}}r(94363);function Lt(e,t,r,n){let s,i=1;1===n?s=new Float32Array(t*r*4):2===n?(s=new Uint16Array(t*r*4),i=15360):s=7===n?new Uint32Array(t*r*4):new Uint8Array(t*r*4);for(let n=0;n<t;n++)for(let a=0;a<r;a++){const r=3*(a*t+n),o=4*(a*t+n);s[o+0]=e[r+0],s[o+1]=e[r+1],s[o+2]=e[r+2],s[o+3]=i}return s}c.prototype.setAlphaMode=function(e,t=!1,r=0){const n=this._alphaState._alphaBlend[r];if(this._alphaMode[r]===e&&(0===e&&!n||0!==e&&n)){if(!t){const t=0===e;this.depthCullingState.depthMask!==t&&(this.setDepthWrite(t),this._cacheRenderPipeline.setDepthWriteEnabled(t))}return}const s=0===e;this._alphaState.setAlphaBlend(!s,r),this._alphaState.setAlphaMode(e,r),t||(this.setDepthWrite(s),this._cacheRenderPipeline.setDepthWriteEnabled(s)),this._alphaMode[r]=e,this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState._alphaBlend,this._alphaState._numTargetEnabled),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)},c.prototype.setAlphaEquation=function(e,t=0){s.$.prototype.setAlphaEquation.call(this,e,t),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)},c.prototype.createRawTexture=function(e,t,r,n,s,i,a,o=null,u=0,c=0,l=!1){const h=new J.h(this,3);return h.baseWidth=t,h.baseHeight=r,h.width=t,h.height=r,h.format=n,h.generateMipMaps=s,h.samplingMode=a,h.invertY=i,h._compression=o,h.type=u,h._creationFlags=c,h._useSRGBBuffer=l,this._doNotHandleContextLost||(h._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(h,t,r,void 0,c),this.updateRawTexture(h,e,n,i,o,u,l),this._internalTexturesCache.push(h),h},c.prototype.updateRawTexture=function(e,t,r,n,s=null,i=0,a=!1){if(e){if(this._doNotHandleContextLost||(e._bufferView=t,e.invertY=n,e._compression=s,e._useSRGBBuffer=a),t){const s=e._hardwareTexture;4===r&&(t=Lt(t,e.width,e.height,i));const a=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(a,e,e.width,e.height,e.depth,s.format,0,0,n,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0}},c.prototype.createRawCubeTexture=function(e,t,r,s,i,a,o,u=null){const c=new J.h(this,8);if(1!==s||this._caps.textureFloatLinearFiltering?2!==s||this._caps.textureHalfFloatLinearFiltering?1!==s||this._caps.textureFloatRender?2!==s||this._caps.colorBufferFloat||(i=!1,n.V.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(i=!1,n.V.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(i=!1,o=1,n.V.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(i=!1,o=1,n.V.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")),c.isCube=!0,c._originalFormat=r,c.format=4===r?5:r,c.type=s,c.generateMipMaps=i,c.width=t,c.height=t,c.samplingMode=o,this._doNotHandleContextLost||(c._bufferViewArray=e),c.invertY=a,c._compression=u,c._cachedWrapU=0,c._cachedWrapV=0,this._textureHelper.createGPUTextureForInternalTexture(c),4===r){c._hardwareTexture._originalFormatIsRGB=!0}return e&&this.updateRawCubeTexture(c,e,r,s,a,u),c.isReady=!0,c},c.prototype.updateRawCubeTexture=function(e,t,r,n,s,i=null){e._bufferViewArray=t,e.invertY=s,e._compression=i;const a=e._hardwareTexture,o=a._originalFormatIsRGB,u=[0,2,4,1,3,5],c=[];for(let r=0;r<t.length;++r){let s=t[u[r]];o&&(s=Lt(s,e.width,e.height,n)),c.push(new Uint8Array(s.buffer,s.byteOffset,s.byteLength))}this._textureHelper.updateCubeTextures(c,a.underlyingResource,e.width,e.height,a.format,s,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder),e.isReady=!0},c.prototype.createRawCubeTextureFromUrl=function(e,t,r,n,s,i,a,o,u=null,c=null,l=3,h=!1){const d=this.createRawCubeTexture(null,r,n,s,!i,h,l,null);t?.addPendingData(d),d.url=e,d.isReady=!1,this._internalTexturesCache.push(d);const p=(e,r)=>{t?.removePendingData(d),c&&e&&c(e.status+" "+e.statusText,r)},f=async e=>{const r=a(e);if(!r)return;const i=r instanceof Promise?await r:r,c=d.width;if(o){const e=4===n,t=o(i),r=d._hardwareTexture,a=[0,1,2,3,4,5];for(let n=0;n<t.length;n++){const i=c>>n,o=[];for(let r=0;r<6;r++){let u=t[n][a[r]];e&&(u=Lt(u,i,i,s)),o.push(new Uint8Array(u.buffer,u.byteOffset,u.byteLength))}this._textureHelper.updateCubeTextures(o,r.underlyingResource,i,i,r.format,h,!1,0,0)}}else this.updateRawCubeTexture(d,i,n,s,h);d.isReady=!0,t?.removePendingData(d),u&&u()};return this._loadFile(e,e=>{f(e).catch(e=>{p(void 0,e)})},void 0,t?.offlineProvider,!0,p),d},c.prototype.createRawTexture3D=function(e,t,r,n,s,i,a,o,u=null,c=0,l=0){const h=new J.h(this,10);return h.baseWidth=t,h.baseHeight=r,h.baseDepth=n,h.width=t,h.height=r,h.depth=n,h.format=s,h.type=c,h.generateMipMaps=i,h.samplingMode=o,h.is3D=!0,h._creationFlags=l,this._doNotHandleContextLost||(h._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(h,t,r,void 0,l),this.updateRawTexture3D(h,e,s,a,u,c),this._internalTexturesCache.push(h),h},c.prototype.updateRawTexture3D=function(e,t,r,n,s=null,i=0){if(this._doNotHandleContextLost||(e._bufferView=t,e.format=r,e.invertY=n,e._compression=s),t){const s=e._hardwareTexture;4===r&&(t=Lt(t,e.width,e.height,i));const a=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(a,e,e.width,e.height,e.depth,s.format,0,0,n,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0},c.prototype.createRawTexture2DArray=function(e,t,r,n,s,i,a,o,u=null,c=0,l=0){const h=new J.h(this,11);return h.baseWidth=t,h.baseHeight=r,h.baseDepth=n,h.width=t,h.height=r,h.depth=n,h.format=s,h.type=c,h.generateMipMaps=i,h.samplingMode=o,h.is2DArray=!0,h._creationFlags=l,this._doNotHandleContextLost||(h._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(h,t,r,n,l),this.updateRawTexture2DArray(h,e,s,a,u,c),this._internalTexturesCache.push(h),h},c.prototype.updateRawTexture2DArray=function(e,t,r,n,s=null,i=0){if(this._doNotHandleContextLost||(e._bufferView=t,e.format=r,e.invertY=n,e._compression=s),t){const s=e._hardwareTexture;4===r&&(t=Lt(t,e.width,e.height,i));const a=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(a,e,e.width,e.height,e.depth,s.format,0,0,n,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0},c.prototype._readTexturePixels=function(e,t,r,n=-1,s=0,i=null,a=!0,o=!1,u=0,c=0){const l=e._hardwareTexture;return a&&this.flushFramebuffer(),this._textureHelper.readPixels(l.underlyingResource,u,c,t,r,l.format,n,s,i,o)},c.prototype._readTexturePixelsSync=function(){throw"_readTexturePixelsSync is unsupported in WebGPU!"},c.prototype._createDepthStencilCubeTexture=function(e,t){const r=new J.h(this,t.generateStencil?12:14);r.isCube=!0,r.label=t.label;const n={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:t.generateStencil?13:14,...t};r.format=n.depthTextureFormat,this._setupDepthStencilTexture(r,e,n.bilinearFiltering,n.comparisonFunction,n.samples),this._textureHelper.createGPUTextureForInternalTexture(r);const s=r._hardwareTexture;return r.type=a.GetTextureTypeFromFormat(s.format),this._internalTexturesCache.push(r),r},c.prototype.createCubeTexture=function(e,t,r,n,s=null,i=null,a,o=null,u=!1,c=0,l=0,h=null,d,p=!1,f=null){return this.createCubeTextureBase(e,t,r,!!n,s,i,a,o,u,c,l,h,null,(e,t)=>{const r=t,i=r[0].width,o=i;this._setCubeMapTextureParams(e,!n),e.format=a??-1;const u=this._textureHelper.createGPUTextureForInternalTexture(e,i,o);this._textureHelper.updateCubeTextures(r,u.underlyingResource,i,o,u.format,!1,!1,0,0),n||this._generateMipmaps(e,this._uploadEncoder),e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),s&&s()},!!p,f)},c.prototype._setCubeMapTextureParams=function(e,t,r){e.samplingMode=t?3:2,e._cachedWrapU=0,e._cachedWrapV=0,r&&(e._maxLodLevel=r)},c.prototype.generateMipMapsForCubemap=function(e){if(e.generateMipMaps){const t=e._hardwareTexture?.underlyingResource;t||this._textureHelper.createGPUTextureForInternalTexture(e),this._generateMipmaps(e)}};var Et=r(61760);class Mt extends Et.v{constructor(e,t,r,n,s){super(e,t,r,n,s),n.enableGPUTimingMeasurements&&(this.gpuTimeInFrame=new u)}}var Ot=r(28086);r(9696);c.prototype._createHardwareRenderTargetWrapper=function(e,t,r){const n=new Mt(e,t,r,this);return this._renderTargetWrapperCache.push(n),n},c.prototype.createRenderTargetTexture=function(e,t){const r=this._createHardwareRenderTargetWrapper(!1,!1,e),n={};void 0!==t&&"object"==typeof t?(n.generateMipMaps=t.generateMipMaps,n.generateDepthBuffer=void 0===t.generateDepthBuffer||t.generateDepthBuffer,n.generateStencilBuffer=n.generateDepthBuffer&&t.generateStencilBuffer,n.samplingMode=void 0===t.samplingMode?3:t.samplingMode,n.creationFlags=t.creationFlags??0,n.noColorAttachment=!!t.noColorAttachment,n.colorAttachment=t.colorAttachment,n.samples=t.samples,n.label=t.label,n.format=t.format,n.type=t.type):(n.generateMipMaps=t,n.generateDepthBuffer=!0,n.generateStencilBuffer=!1,n.samplingMode=3,n.creationFlags=0,n.noColorAttachment=!1);const s=n.colorAttachment||(n.noColorAttachment?null:this._createInternalTexture(e,n,!0,5));return r.label=n.label??"RenderTargetWrapper",r._samples=n.colorAttachment?.samples??n.samples??1,r._generateDepthBuffer=n.generateDepthBuffer,r._generateStencilBuffer=!!n.generateStencilBuffer,r.setTextures(s),(r._generateDepthBuffer||r._generateStencilBuffer)&&r.createDepthStencilTexture(0,!1,r._generateStencilBuffer,r.samples,n.generateStencilBuffer?13:14,n.label?n.label+"-DepthStencil":void 0),s&&!n.colorAttachment&&(void 0!==t&&"object"==typeof t&&t.createMipMaps&&!n.generateMipMaps&&(s.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(s,void 0,void 0,void 0,n.creationFlags),void 0!==t&&"object"==typeof t&&t.createMipMaps&&!n.generateMipMaps&&(s.generateMipMaps=!1)),r},c.prototype._createDepthStencilTexture=function(e,t,r){const n={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:t.generateStencil?13:14,...t},s=(0,Ot.$l)(n.depthTextureFormat);r._depthStencilTextureWithStencil=s;const i=new J.h(this,s?12:14);return i.label=t.label,i.format=n.depthTextureFormat,i.type=(0,Ot.GX)(i.format),this._setupDepthStencilTexture(i,e,n.bilinearFiltering,n.comparisonFunction,n.samples),this._textureHelper.createGPUTextureForInternalTexture(i),this._internalTexturesCache.push(i),i},c.prototype._setupDepthStencilTexture=function(e,t,r,n,s=1){const i=t.width??t,a=t.height??t,o=t.layers||0,u=t.depth||0;e.baseWidth=i,e.baseHeight=a,e.width=i,e.height=a,e.is2DArray=o>0,e.is3D=u>0,e.depth=o||u,e.isReady=!0,e.samples=s,e.generateMipMaps=!1,e.samplingMode=r?2:1,e.type=1,e._comparisonFunction=n,e._cachedWrapU=0,e._cachedWrapV=0},c.prototype.updateRenderTargetTextureSampleCount=function(e,t){return e&&e.texture&&e.samples!==t?(t=Math.min(t,this.getCaps().maxMSAASamples),this._textureHelper.createMSAATexture(e.texture,t),e._depthStencilTexture&&(this._textureHelper.createMSAATexture(e._depthStencilTexture,t),e._depthStencilTexture.samples=t),e._samples=t,e.texture.samples=t,t):t},c.prototype.setDepthStencilTexture=function(e,t,r,n){r&&r.depthStencilTexture?this._setTexture(e,r,!1,!0,n):this._setTexture(e,null,void 0,void 0,n)},c.prototype.createRenderTargetCubeTexture=function(e,t){const r=this._createHardwareRenderTargetWrapper(!1,!0,e),n={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,samples:1,...t};n.generateStencilBuffer=n.generateDepthBuffer&&n.generateStencilBuffer,r.label=n.label??"RenderTargetWrapper",r._generateDepthBuffer=n.generateDepthBuffer,r._generateStencilBuffer=n.generateStencilBuffer;const s=new J.h(this,5);return s.width=e,s.height=e,s.depth=0,s.isReady=!0,s.isCube=!0,s.samples=n.samples,s.generateMipMaps=n.generateMipMaps,s.samplingMode=n.samplingMode,s.type=n.type,s.format=n.format,this._internalTexturesCache.push(s),r.setTextures(s),(r._generateDepthBuffer||r._generateStencilBuffer)&&r.createDepthStencilTexture(0,void 0===n.samplingMode||2===n.samplingMode||2===n.samplingMode||3===n.samplingMode||3===n.samplingMode||5===n.samplingMode||6===n.samplingMode||7===n.samplingMode||11===n.samplingMode,r._generateStencilBuffer,r.samples),t&&t.createMipMaps&&!n.generateMipMaps&&(s.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(s),t&&t.createMipMaps&&!n.generateMipMaps&&(s.generateMipMaps=!1),r};var Gt=r(50861);class Ut{constructor(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=Gt.u.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=Gt.u.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,this.forceRenderingWhenOccluded=!1}}s.$.prototype.createQuery=function(){return null},s.$.prototype.deleteQuery=function(e){return this},s.$.prototype.isQueryResultAvailable=function(e){return!1},s.$.prototype.getQueryResult=function(e){return 0},s.$.prototype.beginOcclusionQuery=function(e,t){return!1},s.$.prototype.endOcclusionQuery=function(e){return this},Object.defineProperty(Gt.u.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(e){this._occlusionDataStorage.isOcclusionQueryInProgress=e},enumerable:!1,configurable:!0}),Object.defineProperty(Gt.u.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new Ut),this.__occlusionDataStorage},enumerable:!1,configurable:!0}),Object.defineProperty(Gt.u.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(e){this._occlusionDataStorage.isOccluded=e},enumerable:!0,configurable:!0}),Object.defineProperty(Gt.u.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(e){this._occlusionDataStorage.occlusionQueryAlgorithmType=e},enumerable:!0,configurable:!0}),Object.defineProperty(Gt.u.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(e){this._occlusionDataStorage.occlusionType=e},enumerable:!0,configurable:!0}),Object.defineProperty(Gt.u.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(e){this._occlusionDataStorage.occlusionRetryCount=e},enumerable:!0,configurable:!0}),Object.defineProperty(Gt.u.prototype,"forceRenderingWhenOccluded",{get:function(){return this._occlusionDataStorage.forceRenderingWhenOccluded},set:function(e){this._occlusionDataStorage.forceRenderingWhenOccluded=e},enumerable:!0,configurable:!0}),Gt.u.prototype._checkOcclusionQuery=function(){const e=this._occlusionDataStorage;if(e.occlusionType===Gt.u.OCCLUSION_TYPE_NONE)return e.isOccluded=!1,!1;const t=this.getEngine();if(!t.getCaps().supportOcclusionQuery)return e.isOccluded=!1,!1;if(!t.isQueryResultAvailable)return e.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&null!==this._occlusionQuery&&void 0!==this._occlusionQuery){if(t.isQueryResultAvailable(this._occlusionQuery)){const r=t.getQueryResult(this._occlusionQuery);e.isOcclusionQueryInProgress=!1,e.occlusionInternalRetryCounter=0,e.isOccluded=!(r>0)}else{if(e.occlusionInternalRetryCounter++,!(-1!==e.occlusionRetryCount&&e.occlusionInternalRetryCounter>e.occlusionRetryCount))return e.occlusionType!==Gt.u.OCCLUSION_TYPE_OPTIMISTIC&&e.isOccluded;e.isOcclusionQueryInProgress=!1,e.occlusionInternalRetryCounter=0,e.isOccluded=e.occlusionType!==Gt.u.OCCLUSION_TYPE_OPTIMISTIC&&e.isOccluded}}const r=this.getScene();if(r.getBoundingBoxRenderer){const n=r.getBoundingBoxRenderer();null===this._occlusionQuery&&(this._occlusionQuery=t.createQuery()),this._occlusionQuery&&t.beginOcclusionQuery(e.occlusionQueryAlgorithmType,this._occlusionQuery)&&(n.renderOcclusionBoundingBox(this),t.endOcclusionQuery(e.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=!0)}return e.isOccluded},c.prototype.getGPUFrameTimeCounter=function(){return this._timestampQuery.gpuFrameTimeCounter},c.prototype.captureGPUFrameTime=function(e){this._timestampQuery.enable=e&&!!this._caps.timerQuery},c.prototype.createQuery=function(){return this._occlusionQuery.createQuery()},c.prototype.deleteQuery=function(e){return this._occlusionQuery.deleteQuery(e),this},c.prototype.isQueryResultAvailable=function(e){return this._occlusionQuery.isQueryResultAvailable(e)},c.prototype.getQueryResult=function(e){return this._occlusionQuery.getQueryResult(e)},c.prototype.beginOcclusionQuery=function(e,t){return this.compatibilityMode?!!this._occlusionQuery.canBeginQuery(t)&&(this._currentRenderPass?.beginOcclusionQuery(t),!0):(this._bundleList.addItem(new pt(t)),!0)},c.prototype.endOcclusionQuery=function(){return this.compatibilityMode?this._currentRenderPass?.endOcclusionQuery():this._bundleList.addItem(new ft),this};const Vt={label:"TextureView_SwapChain_ResolveTarget",dimension:"2d",format:void 0,mipLevelCount:1,arrayLayerCount:1},Nt={label:"TextureView_SwapChain",dimension:"2d",format:void 0,mipLevelCount:1,arrayLayerCount:1},Wt=new j.ov;class $t extends c{get snapshotRenderingMode(){return this._snapshotRendering.mode}set snapshotRenderingMode(e){this._snapshotRendering.mode=e}snapshotRenderingReset(){this._snapshotRendering.reset()}get snapshotRendering(){return this._snapshotRendering.enabled}set snapshotRendering(e){this._snapshotRendering.enabled=e}get disableCacheSamplers(){return!!this._cacheSampler&&this._cacheSampler.disabled}set disableCacheSamplers(e){this._cacheSampler&&(this._cacheSampler.disabled=e)}get disableCacheRenderPipelines(){return!!this._cacheRenderPipeline&&this._cacheRenderPipeline.disabled}set disableCacheRenderPipelines(e){this._cacheRenderPipeline&&(this._cacheRenderPipeline.disabled=e)}get disableCacheBindGroups(){return!!this._cacheBindGroups&&this._cacheBindGroups.disabled}set disableCacheBindGroups(e){this._cacheBindGroups&&(this._cacheBindGroups.disabled=e)}areAllEffectsReady(){return!0}getFontOffset(e){return(0,At.PR)(e)}static get IsSupportedAsync(){return navigator.gpu?navigator.gpu.requestAdapter().then(e=>!!e,()=>!1).catch(()=>!1):Promise.resolve(!1)}static get IsSupported(){return n.V.Warn("You must call IsSupportedAsync for WebGPU!"),!1}get supportsUniformBuffers(){return!0}get supportedExtensions(){return this._adapterSupportedExtensions}get enabledExtensions(){return this._deviceEnabledExtensions}get supportedLimits(){return this._adapterSupportedLimits}get currentLimits(){return this._deviceLimits}get description(){return this.name+this.version}get version(){return 1}getInfo(){return{vendor:this._adapterInfo.vendor||"unknown vendor",renderer:this._adapterInfo.architecture||"unknown renderer",version:this._adapterInfo.description||"unknown version"}}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=e}get currentSampleCount(){return this._currentRenderTarget?this._currentRenderTarget.samples:this._mainPassSampleCount}static CreateAsync(e,t={}){const r=new $t(e,t);return new Promise(e=>{r.initAsync(t.glslangOptions,t.twgslOptions).then(()=>e(r))})}constructor(e,t={}){super(t.antialias??!0,t),this.uniqueId=-1,this._uploadEncoderDescriptor={label:"upload"},this._renderEncoderDescriptor={label:"render"},this._clearDepthValue=1,this._clearReverseDepthValue=0,this._clearStencilValue=0,this._defaultSampleCount=4,this._glslang=null,this._tintWASM=null,this._glslangAndTintAreFullyLoaded=!1,this._adapterInfo={vendor:"",architecture:"",device:"",description:"",subgroupMinSize:0,subgroupMaxSize:0,isFallbackAdapter:!1},this._compiledComputeEffects={},this._counters={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.countersLastFrame={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.numMaxUncapturedErrors=20,this.scenes=[],this._virtualScenes=new Array,this._commandBuffers=[null,null],this._mainRenderPassWrapper={renderPassDescriptor:null,colorAttachmentViewDescriptor:null,depthAttachmentViewDescriptor:null,colorAttachmentGPUTextures:[],depthTextureFormat:void 0},this._rttRenderPassWrapper={renderPassDescriptor:null,colorAttachmentViewDescriptor:null,depthAttachmentViewDescriptor:null,colorAttachmentGPUTextures:[],depthTextureFormat:void 0},this._pendingDebugCommands=[],this._currentVertexBuffers={},this._currentOverrideVertexBuffers=null,this._currentIndexBuffer=null,this._colorWriteLocal=!0,this._forceEnableEffect=!1,this.isNDCHalfZRange=!0,this.hasOriginBottomLeft=!1,this._workingGlslangAndTintPromise=null,this._viewportsCurrent={x:0,y:0,w:0,h:0},this._scissorsCurrent={x:0,y:0,w:0,h:0},this._scissorCached={x:0,y:0,z:0,w:0},this._stencilRefsCurrent=-1,this._blendColorsCurrent=[null,null,null,null],this._performanceMonitor=new Rt.r,this._name="WebGPU",this._drawCalls=new o.A,t.deviceDescriptor=t.deviceDescriptor||{},t.enableGPUDebugMarkers=t.enableGPUDebugMarkers??!1,n.V.Log(`Babylon.js v${s.$.Version} - ${this.description} engine`),navigator.gpu?(t.swapChainFormat=t.swapChainFormat||navigator.gpu.getPreferredCanvasFormat(),this._isWebGPU=!0,this._shaderPlatformName="WEBGPU",this._renderingCanvas=e,this._options=t,this._mainPassSampleCount=t.antialias?this._defaultSampleCount:1,navigator&&navigator.userAgent&&this._setupMobileChecks(),this._sharedInit(this._renderingCanvas),this._shaderProcessor=new pe,this._shaderProcessorWGSL=new me):n.V.Error("WebGPU is not supported by your browser.")}prepareGlslangAndTintAsync(){return this._workingGlslangAndTintPromise||(this._workingGlslangAndTintPromise=new Promise(e=>{this._initGlslangAsync(this._glslangOptions??this._options?.glslangOptions).then(t=>{this._glslang=t,this._tintWASM=new vt,this._tintWASM.initTwgsl(this._twgslOptions??this._options?.twgslOptions).then(()=>{this._glslangAndTintAreFullyLoaded=!0,e()})})})),this._workingGlslangAndTintPromise}initAsync(e,t){return this.uniqueId=$t._InstanceId++,this._glslangOptions=e,this._twgslOptions=t,navigator.gpu.requestAdapter(this._options).then(async e=>{if(e){this._adapter=e,this._adapterSupportedExtensions=[],this._adapter.features?.forEach(e=>{this._adapterSupportedExtensions.push(e)}),this._adapterSupportedLimits=this._adapter.limits,this._adapterInfo=this._adapter.info;const t=this._options.deviceDescriptor??{},r=t?.requiredFeatures??(this._options.enableAllFeatures?this._adapterSupportedExtensions:void 0);if(r){const e=r,n=[];for(const t of e)-1!==this._adapterSupportedExtensions.indexOf(t)&&n.push(t);t.requiredFeatures=n}if(this._options.setMaximumLimits&&!t.requiredLimits){t.requiredLimits={};for(const e in this._adapterSupportedLimits)"minSubgroupSize"!==e&&"maxSubgroupSize"!==e&&(t.requiredLimits[e]=this._adapterSupportedLimits[e])}return t.label=`BabylonWebGPUDevice${this.uniqueId}`,await this._adapter.requestDevice(t)}throw"Could not retrieve a WebGPU adapter (adapter is null)."}).then(e=>{this._device=e,this._deviceEnabledExtensions=[],this._device.features?.forEach(e=>{this._deviceEnabledExtensions.push(e)}),this._deviceLimits=e.limits;let t=-1;this._device.addEventListener("uncapturederror",e=>{++t<this.numMaxUncapturedErrors?n.V.Warn(`WebGPU uncaptured error (${t+1}): ${e.error} - ${e.error.message}`):t++===this.numMaxUncapturedErrors&&n.V.Warn(`WebGPU uncaptured error: too many warnings (${this.numMaxUncapturedErrors}), no more warnings will be reported to the console for this engine.`)}),this._doNotHandleContextLost||this._device.lost?.then(e=>{this._isDisposed||(this._contextWasLost=!0,n.V.Warn("WebGPU context lost. "+e),this.onContextLostObservable.notifyObservers(this),this._restoreEngineAfterContextLost(async()=>{const e=this.snapshotRenderingMode,t=this.snapshotRendering,r=this.disableCacheSamplers,n=this.disableCacheRenderPipelines,s=this.disableCacheBindGroups,i=this.enableGPUTimingMeasurements;await this.initAsync(this._glslangOptions??this._options?.glslangOptions,this._twgslOptions??this._options?.twgslOptions),this.snapshotRenderingMode=e,this.snapshotRendering=t,this.disableCacheSamplers=r,this.disableCacheRenderPipelines=n,this.disableCacheBindGroups=s,this.enableGPUTimingMeasurements=i,this._currentRenderPass=null}))})}).then(()=>{this._initializeLimits(),this._bufferManager=new Pe(this,this._device),this._textureHelper=new Ie(this,this._device,this._bufferManager,this._deviceEnabledExtensions),this._cacheSampler=new Me(this._device),this._cacheBindGroups=new rt(this._device,this._cacheSampler,this),this._timestampQuery=new bt(this,this._device,this._bufferManager),this._occlusionQuery=this._device.createQuerySet?new yt(this,this._device,this._bufferManager):void 0,this._bundleList=new mt(this._device),this._snapshotRendering=new Ct(this,this._snapshotRenderingMode,this._bundleList),this._ubInvertY=this._bufferManager.createBuffer(new Float32Array([-1,0]),p.Uniform|p.CopyDst,"UBInvertY"),this._ubDontInvertY=this._bufferManager.createBuffer(new Float32Array([1,0]),p.Uniform|p.CopyDst,"UBDontInvertY"),this.dbgVerboseLogsForFirstFrames&&void 0===this._count&&(this._count=0,n.V.Log(["%c frame #"+this._count+" - begin","background: #ffff00"])),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._emptyVertexBuffer=new ee.R(this,[0],"",{stride:1,offset:0,size:1,label:"EmptyVertexBuffer"}),this._dummyIndexBuffer=this._bufferManager.createBuffer(new Uint16Array([0,0,0,0]),p.Storage|p.CopyDst,"DummyIndices"),this._cacheRenderPipeline=new Ye(this._device,this._emptyVertexBuffer),this._depthCullingState=new Ke(this._cacheRenderPipeline),this._stencilStateComposer=new ze(this._cacheRenderPipeline),this._stencilStateComposer.stencilGlobal=this._stencilState,this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=515,this._depthCullingState.depthMask=!0,this._textureHelper.setCommandEncoder(this._uploadEncoder),this._clearQuad=new ut(this._device,this,this._emptyVertexBuffer),this._defaultDrawContext=this.createDrawContext(),this._currentDrawContext=this._defaultDrawContext,this._defaultMaterialContext=this.createMaterialContext(),this._currentMaterialContext=this._defaultMaterialContext,this._initializeContextAndSwapChain(),this._initializeMainAttachments(),this.resize()}).catch(e=>{throw n.V.Error("A fatal error occurred during WebGPU creation/initialization."),e})}_initGlslangAsync(e){if(e=e||{},(e={...$t._GlslangDefaultOptions,...e}).glslang)return e.glslang;if(self.glslang)return self.glslang(e.wasmPath);if(e.jsPath&&e.wasmPath)return _e.S0.LoadBabylonScriptAsync(e.jsPath).then(()=>self.glslang(_e.S0.GetBabylonScriptURL(e.wasmPath)));throw new Error("glslang is not available")}_initializeLimits(){const e=this._deviceEnabledExtensions.indexOf("texture-formats-tier1")>=0;this._caps={maxTexturesImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxVertexTextureImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxCombinedTexturesImageUnits:2*this._deviceLimits.maxSampledTexturesPerShaderStage,maxTextureSize:this._deviceLimits.maxTextureDimension2D,maxCubemapTextureSize:this._deviceLimits.maxTextureDimension2D,maxRenderTextureSize:this._deviceLimits.maxTextureDimension2D,maxVertexAttribs:this._deviceLimits.maxVertexAttributes,maxDrawBuffers:8,maxVaryingVectors:this._deviceLimits.maxInterStageShaderVariables,maxFragmentUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),maxVertexUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),shaderFloatPrecision:23,standardDerivatives:!0,astc:this._deviceEnabledExtensions.indexOf("texture-compression-astc")>=0||void 0,s3tc:this._deviceEnabledExtensions.indexOf("texture-compression-bc")>=0||void 0,pvrtc:null,etc1:null,etc2:this._deviceEnabledExtensions.indexOf("texture-compression-etc2")>=0||void 0,bptc:this._deviceEnabledExtensions.indexOf("texture-compression-bc")>=0||void 0,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!0,highPrecisionShaderSupported:!0,colorBufferFloat:!0,blendFloat:this._deviceEnabledExtensions.indexOf("float32-blendable")>=0,supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:this._deviceEnabledExtensions.indexOf("rg11b10ufloat-renderable")>=0,textureFloat:!0,textureFloatLinearFiltering:this._deviceEnabledExtensions.indexOf("float32-filterable")>=0,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,texelFetch:!0,drawBuffersExtension:!0,depthTextureExtension:!0,vertexArrayObject:!1,instancedArrays:!0,timerQuery:"undefined"!=typeof BigUint64Array&&-1!==this._deviceEnabledExtensions.indexOf("timestamp-query")||void 0,supportOcclusionQuery:"undefined"!=typeof BigUint64Array,canUseTimestampForTimerQuery:!0,multiview:!1,oculusMultiview:!1,parallelShaderCompile:void 0,blendMinMax:!0,maxMSAASamples:4,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!0,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!0,texture2DArrayMaxLayerCount:this._deviceLimits.maxTextureArrayLayers,disableMorphTargetTexture:!1,textureNorm16:e,blendParametersPerTarget:!0,dualSourceBlending:!0},this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!0,supportDepthStencilTexture:!0,supportShadowSamplers:!0,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!0,trackUbosInFrame:!0,checkUbosContentBeforeUpload:!0,supportCSM:!0,basisNeedsPOT:!1,support3DTextures:!0,needTypeSuffixInShaderConstants:!0,supportMSAA:!0,supportSSAO2:!0,supportIBLShadows:!0,supportExtendedTextureFormats:!0,supportSwitchCaseInShader:!0,supportSyncTextureRead:!1,needsInvertingBitmap:!1,useUBOBindingCache:!1,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!0,supportRenderPasses:!0,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!0,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!0,_collectUbosUpdatedInFrame:!1},this._alphaState=new wt.i(this._caps.blendParametersPerTarget)}_initializeContextAndSwapChain(){if(!this._renderingCanvas)throw"The rendering canvas has not been set!";this._context=this._renderingCanvas.getContext("webgpu"),this._configureContext(),this._colorFormat=this._options.swapChainFormat,this._mainRenderPassWrapper.colorAttachmentGPUTextures=[new be(this)],this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].format=this._colorFormat,this._setColorFormat(this._mainRenderPassWrapper)}_initializeMainAttachments(){if(!this._bufferManager)return;this.flushFramebuffer(),this._mainTextureExtends={width:this.getRenderWidth(!0),height:this.getRenderHeight(!0),depthOrArrayLayers:1};const e=new Float32Array([this.getRenderHeight(!0)]);let t;if(this._bufferManager.setSubData(this._ubInvertY,4,e),this._bufferManager.setSubData(this._ubDontInvertY,4,e),this._options.antialias){const e={label:`Texture_MainColor_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}_antialiasing`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:"2d",format:this._options.swapChainFormat,usage:16};this._mainTexture&&this._textureHelper.releaseTexture(this._mainTexture),this._mainTexture=this._device.createTexture(e),t=[{view:this._mainTexture.createView({label:"TextureView_MainColor_antialiasing",dimension:"2d",format:this._options.swapChainFormat,mipLevelCount:1,arrayLayerCount:1}),clearValue:new j.ov(0,0,0,1),loadOp:"clear",storeOp:"store"}]}else t=[{view:void 0,clearValue:new j.ov(0,0,0,1),loadOp:"clear",storeOp:"store"}];this._mainRenderPassWrapper.depthTextureFormat=this.isStencilEnable?"depth24plus-stencil8":"depth32float",this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper);const r={label:`Texture_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:"2d",format:this._mainRenderPassWrapper.depthTextureFormat,usage:16};this._depthTexture&&this._textureHelper.releaseTexture(this._depthTexture),this._depthTexture=this._device.createTexture(r);const n={view:this._depthTexture.createView({label:`TextureView_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,dimension:"2d",format:this._depthTexture.format,mipLevelCount:1,arrayLayerCount:1}),depthClearValue:this._clearDepthValue,depthLoadOp:"clear",depthStoreOp:"store",stencilClearValue:this._clearStencilValue,stencilLoadOp:this.isStencilEnable?"clear":void 0,stencilStoreOp:this.isStencilEnable?"store":void 0};this._mainRenderPassWrapper.renderPassDescriptor={label:"MainRenderPass",colorAttachments:t,depthStencilAttachment:n},this.beginFrame(),this._startMainRenderPass(!0,null,!0,!1),this._endCurrentRenderPass(),this.endFrame(),this._frameId--}_sharedInit(e){super._sharedInit(e),(0,At.BG)(this,e,this._creationOptions)}_configureContext(){this._context.configure({device:this._device,format:this._options.swapChainFormat,usage:17,alphaMode:this.premultipliedAlpha?"premultiplied":"opaque"})}resizeImageBitmap(e,t,r){return(0,At.jf)(this,e,t,r)}async _createImageBitmapFromSource(e,t){return await(0,At.kF)(this,e,t)}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&(0,At.tl)(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&(0,At.g7)()}enterPointerlock(){this._renderingCanvas&&(0,At.eG)(this._renderingCanvas)}exitPointerlock(){(0,At.rT)()}_rebuildBuffers(){super._rebuildBuffers();for(const e of this._storageBuffers)e.getBuffer().engineId!==this.uniqueId&&e._rebuild()}_restoreEngineAfterContextLost(e){Ye.ResetCache(),rt.ResetCache();const t=e=>{for(const t of e){for(const e of t.meshes){const t=e.subMeshes;if(t)for(const e of t)e._drawWrappers=[]}for(const e of t.materials)e._materialContext?.reset()}};t(this.scenes),t(this._virtualScenes);const r=[];for(const e of this._uniformBuffers)e.name.indexOf("leftOver")<0&&r.push(e);this._uniformBuffers=r,super._restoreEngineAfterContextLost(e)}setSize(e,t,r=!1){return!!super.setSize(e,t,r)&&(this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&n.V.Log(["frame #"+this._count+" - setSize -",e,t])),this._initializeMainAttachments(),this.snapshotRendering&&this.snapshotRenderingReset(),!0)}_getShaderProcessor(e){return 1===e?this._shaderProcessorWGSL:this._shaderProcessor}_getShaderProcessingContext(e,t){return new ie(e,t)}_getCurrentRenderPass(){return this._currentRenderTarget&&!this._currentRenderPass?this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1):this._currentRenderPass||this._startMainRenderPass(!1),this._currentRenderPass}_getCurrentRenderPassWrapper(){return this._currentRenderTarget?this._rttRenderPassWrapper:this._mainRenderPassWrapper}applyStates(){this._stencilStateComposer.apply(),this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState._alphaBlend,this._alphaState._numTargetEnabled)}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._forceEnableEffect=!0,this._currentIndexBuffer=null,this._currentOverrideVertexBuffers=null,this._cacheRenderPipeline.setBuffers(null,null,null),e&&(this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=515,this._alphaState.reset(),this._resetAlphaMode(),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters),this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState._alphaBlend,this._alphaState._numTargetEnabled),this.setColorWrite(!0)),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}setColorWrite(e){this._colorWriteLocal=e,this._cacheRenderPipeline.setWriteMask(e?15:0)}getColorWrite(){return this._colorWriteLocal}_mustUpdateViewport(){const e=this._viewportCached.x,t=this._viewportCached.y,r=this._viewportCached.z,n=this._viewportCached.w,s=this._viewportsCurrent.x!==e||this._viewportsCurrent.y!==t||this._viewportsCurrent.w!==r||this._viewportsCurrent.h!==n;return s&&(this._viewportsCurrent.x=this._viewportCached.x,this._viewportsCurrent.y=this._viewportCached.y,this._viewportsCurrent.w=this._viewportCached.z,this._viewportsCurrent.h=this._viewportCached.w),s}_applyViewport(e){const t=Math.floor(this._viewportCached.x),r=Math.floor(this._viewportCached.z),s=Math.floor(this._viewportCached.w);let i=Math.floor(this._viewportCached.y);this._currentRenderTarget||(i=this.getRenderHeight(!0)-i-s),e?e.addItem(new ct(t,i,r,s)):this._getCurrentRenderPass().setViewport(t,i,r,s,0,1),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&n.V.Log(["frame #"+this._count+" - viewport applied - (",this._viewportCached.x,this._viewportCached.y,this._viewportCached.z,this._viewportCached.w,") current pass is main pass="+this._currentPassIsMainPass()]))}_viewport(e,t,r,n){this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=r,this._viewportCached.w=n}_mustUpdateScissor(){const e=this._scissorCached.x,t=this._scissorCached.y,r=this._scissorCached.z,n=this._scissorCached.w,s=this._scissorsCurrent.x!==e||this._scissorsCurrent.y!==t||this._scissorsCurrent.w!==r||this._scissorsCurrent.h!==n;return s&&(this._scissorsCurrent.x=this._scissorCached.x,this._scissorsCurrent.y=this._scissorCached.y,this._scissorsCurrent.w=this._scissorCached.z,this._scissorsCurrent.h=this._scissorCached.w),s}_applyScissor(e){const t=this._currentRenderTarget?this._scissorCached.y:this.getRenderHeight()-this._scissorCached.w-this._scissorCached.y;e?e.addItem(new lt(this._scissorCached.x,t,this._scissorCached.z,this._scissorCached.w)):this._getCurrentRenderPass().setScissorRect(this._scissorCached.x,t,this._scissorCached.z,this._scissorCached.w),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&n.V.Log(["frame #"+this._count+" - scissor applied - (",this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w,") current pass is main pass="+this._currentPassIsMainPass()]))}_scissorIsActive(){return 0!==this._scissorCached.x||0!==this._scissorCached.y||0!==this._scissorCached.z||0!==this._scissorCached.w}enableScissor(e,t,r,n){this._scissorCached.x=e,this._scissorCached.y=t,this._scissorCached.z=r,this._scissorCached.w=n}disableScissor(){this._scissorCached.x=this._scissorCached.y=this._scissorCached.z=this._scissorCached.w=0,this._scissorsCurrent.x=this._scissorsCurrent.y=this._scissorsCurrent.w=this._scissorsCurrent.h=0}_mustUpdateStencilRef(){const e=this._stencilStateComposer.funcRef!==this._stencilRefsCurrent;return e&&(this._stencilRefsCurrent=this._stencilStateComposer.funcRef),e}_applyStencilRef(e){e?e.addItem(new ht(this._stencilStateComposer.funcRef??0)):this._getCurrentRenderPass().setStencilReference(this._stencilStateComposer.funcRef??0)}_mustUpdateBlendColor(){const e=this._alphaState._blendConstants,t=e[0]!==this._blendColorsCurrent[0]||e[1]!==this._blendColorsCurrent[1]||e[2]!==this._blendColorsCurrent[2]||e[3]!==this._blendColorsCurrent[3];return t&&(this._blendColorsCurrent[0]=e[0],this._blendColorsCurrent[1]=e[1],this._blendColorsCurrent[2]=e[2],this._blendColorsCurrent[3]=e[3]),t}_applyBlendColor(e){e?e.addItem(new dt(this._alphaState._blendConstants.slice())):this._getCurrentRenderPass().setBlendConstant(this._alphaState._blendConstants)}_resetRenderPassStates(){this._viewportsCurrent.x=this._viewportsCurrent.y=this._viewportsCurrent.w=this._viewportsCurrent.h=0,this._scissorsCurrent.x=this._scissorsCurrent.y=this._scissorsCurrent.w=this._scissorsCurrent.h=0,this._stencilRefsCurrent=-1,this._blendColorsCurrent[0]=this._blendColorsCurrent[1]=this._blendColorsCurrent[2]=this._blendColorsCurrent[3]=null}clear(e,t,r,s=!1,i=0){e&&void 0===e.a&&(e.a=1),s&&(this._clearStencilValue=i);const a=this._scissorIsActive();this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&n.V.Log(["frame #"+this._count+" - clear - backBuffer=",t," depth=",r," stencil=",s," scissor is active=",a])),this._currentRenderTarget?a?(this._currentRenderPass||this._startRenderTargetRenderPass(this._currentRenderTarget,!1,t?e:null,r,s),this._applyScissor(this.compatibilityMode?null:this._bundleList),this._clearFullQuad(t?e:null,r,s)):(this._currentRenderPass&&this._endCurrentRenderPass(),this._startRenderTargetRenderPass(this._currentRenderTarget,!0,t?e:null,r,s)):(this._currentRenderPass&&a||this._startMainRenderPass(!a,t?e:null,r,s),a&&(this._applyScissor(this.compatibilityMode?null:this._bundleList),this._clearFullQuad(t?e:null,r,s)))}_clearFullQuad(e,t,r){const n=this.compatibilityMode?this._getCurrentRenderPass():null;this._clearQuad.setColorFormat(this._colorFormat),this._clearQuad.setDepthStencilFormat(this._depthTextureFormat),this._clearQuad.setMRTAttachments(this._cacheRenderPipeline.mrtAttachments??[],this._cacheRenderPipeline.mrtTextureArray??[],this._cacheRenderPipeline.mrtTextureCount),this.compatibilityMode?n.setStencilReference(this._clearStencilValue):this._bundleList.addItem(new ht(this._clearStencilValue));const s=this._clearQuad.clear(n,e,t,r,this.currentSampleCount);this.compatibilityMode?this._applyStencilRef(null):(this._bundleList.addBundle(s),this._applyStencilRef(this._bundleList),this._reportDrawCall())}createVertexBuffer(e,t,r){let n;n=e instanceof Array?new Float32Array(e):e instanceof ArrayBuffer?new Uint8Array(e):e;return this._bufferManager.createBuffer(n,p.Vertex|p.CopyDst|p.Storage,r)}createDynamicVertexBuffer(e,t){return this.createVertexBuffer(e,void 0,t)}createIndexBuffer(e,t,r){let n,s=!0;if(e instanceof Uint32Array||e instanceof Int32Array)n=e;else if(e instanceof Uint16Array)n=e,s=!1;else{for(let t=0;t<e.length;t++)if(e[t]>65535){n=new Uint32Array(e);break}n||(n=new Uint16Array(e),s=!1)}const i=this._bufferManager.createBuffer(n,p.Index|p.CopyDst|p.Storage,r);return i.is32Bits=s,i}updateDynamicIndexBuffer(e,t,r=0){const n=e;let s;s=e.is32Bits?t instanceof Uint32Array?t:new Uint32Array(t):t instanceof Uint16Array?t:new Uint16Array(t),this._bufferManager.setSubData(n,r,s)}updateDynamicVertexBuffer(e,t,r,n){const s=e;let i;void 0===r&&(r=0),void 0===n?(i=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,n=i.byteLength):i=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,this._bufferManager.setSubData(s,r,i,0,n)}_createBuffer(e,t,r){let n;n=e instanceof Array?new Float32Array(e):e instanceof ArrayBuffer?new Uint8Array(e):e;let s=0;return 1&t&&(s|=p.CopySrc),2&t&&(s|=p.CopyDst),4&t&&(s|=p.Uniform),8&t&&(s|=p.Vertex),16&t&&(s|=p.Index),32&t&&(s|=p.Storage),64&t&&(s|=p.Indirect),this._bufferManager.createBuffer(n,s,r)}bindBuffersDirectly(){throw"Not implemented on WebGPU"}updateAndBindInstancesBuffer(){throw"Not implemented on WebGPU"}unbindInstanceAttributes(){}bindBuffers(e,t,r,n){this._currentVertexBuffers=e,this._currentIndexBuffer=t,this._currentOverrideVertexBuffers=n??null,this._cacheRenderPipeline.setBuffers(this._currentVertexBuffers,this._currentIndexBuffer,this._currentOverrideVertexBuffers)}_releaseBuffer(e){return this._bufferManager.releaseBuffer(e)}createUniformBuffer(e,t){let r;r=e instanceof Array?new Float32Array(e):e;return this._bufferManager.createBuffer(r,p.Uniform|p.CopyDst,t)}createDynamicUniformBuffer(e,t){return this.createUniformBuffer(e,t)}updateUniformBuffer(e,t,r,n){void 0===r&&(r=0);const s=e;let i;void 0===n?(i=t instanceof Float32Array?t:new Float32Array(t),n=i.byteLength):i=t instanceof Float32Array?t:new Float32Array(t),this._bufferManager.setSubData(s,r,i,0,n)}bindUniformBufferBase(e,t,r){this._currentDrawContext.setBuffer(r,e)}bindUniformBlock(){}createEffect(e,t,r,n,s,i,a,o,u,c=0,l){const h="string"==typeof e?e:e.vertexToken||e.vertexSource||e.vertexElement||e.vertex,d="string"==typeof e?e:e.fragmentToken||e.fragmentSource||e.fragmentElement||e.fragment,p=this._getGlobalDefines(),f=void 0!==t.attributes;let g=s??t.defines??"";p&&(g+="\n"+p);const m=h+"+"+d+"@"+g;if(this._compiledEffects[m]){const e=this._compiledEffects[m];return a&&e.isReady()&&a(e),e._refCount++,e}const _=new Z.M(e,t,f?this:r,n,this,s,i,a,o,u,m,t.shaderLanguage??c,t.extraInitializationsAsync??l);return this._compiledEffects[m]=_,_}_compileRawShaderToSpirV(e,t){return this._glslang.compileGLSL(e,t)}_compileShaderToSpirV(e,t,r,n){return this._compileRawShaderToSpirV(n+(r?r+"\n":"")+e,t)}_getWGSLShader(e,t,r){return(r=r?"//"+r.split("\n").join("\n//")+"\n":"")+e}_createPipelineStageDescriptor(e,t,r,n,s){return this._tintWASM&&0===r&&(e=this._tintWASM.convertSpirV2WGSL(e,n),t=this._tintWASM.convertSpirV2WGSL(t,s)),{vertexStage:{module:this._device.createShaderModule({label:"vertex",code:e}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({label:"fragment",code:t}),entryPoint:"main"}}}_compileRawPipelineStageDescriptor(e,t,r){const n=e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,s=t.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,i=0===r?this._compileRawShaderToSpirV(e,"vertex"):e,a=0===r?this._compileRawShaderToSpirV(t,"fragment"):t;return this._createPipelineStageDescriptor(i,a,r,n,s)}_compilePipelineStageDescriptor(e,t,r,n){this.onBeforeShaderCompilationObservable.notifyObservers(this);const s=e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,i=t.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,a="#version 450\n",o=0===n?this._compileShaderToSpirV(e,"vertex",r,a):this._getWGSLShader(e,"vertex",r),u=0===n?this._compileShaderToSpirV(t,"fragment",r,a):this._getWGSLShader(t,"fragment",r),c=this._createPipelineStageDescriptor(o,u,n,s,i);return this.onAfterShaderCompilationObservable.notifyObservers(this),c}createRawShaderProgram(){throw"Not available on WebGPU"}createShaderProgram(){throw"Not available on WebGPU"}inlineShaderCode(e){const t=new St(e);return t.debug=!1,t.processCode(),t.code}createPipelineContext(e){return new ne(e,this)}createMaterialContext(){return new Je}createDrawContext(){return new Ze(this._bufferManager,this._dummyIndexBuffer)}async _preparePipelineContextAsync(e,t,r,s,i,a,o,u,c,l,h){const d=e,p=d.shaderProcessingContext.shaderLanguage;0!==p||this._glslangAndTintAreFullyLoaded||await this.prepareGlslangAndTintAsync(),this.dbgShowShaderCode&&(n.V.Log(["defines",u]),n.V.Log(t),n.V.Log(r),n.V.Log("***********************************************")),d.sources={fragment:r,vertex:t,rawVertex:i,rawFragment:a},d.stages=s?this._compileRawPipelineStageDescriptor(t,r,p):this._compilePipelineStageDescriptor(t,r,u,p),h()}getAttributes(e,t){const r=new Array(t.length),n=e;for(let e=0;e<t.length;e++){const s=t[e],i=n.shaderProcessingContext.availableAttributes[s];void 0!==i&&(r[e]=i)}return r}enableEffect(e){if(e){if((0,Ft.E)(e)){if(!e.effect||e.effect===this._currentEffect&&e.materialContext===this._currentMaterialContext&&e.drawContext===this._currentDrawContext&&!this._forceEnableEffect){if(!e.effect&&this.dbgShowEmptyEnableEffectCalls)throw n.V.Log(["drawWrapper=",e]),"Invalid call to enableEffect: the effect property is empty!";return}if(this._currentEffect=e.effect,this._currentMaterialContext=e.materialContext,this._currentDrawContext=e.drawContext,this._counters.numEnableDrawWrapper++,!this._currentMaterialContext)throw n.V.Log(["drawWrapper=",e]),"Invalid call to enableEffect: the materialContext property is empty!"}else this._currentEffect=e,this._currentMaterialContext=this._defaultMaterialContext,this._currentDrawContext=this._defaultDrawContext,this._counters.numEnableEffects++,this.dbgLogIfNotDrawWrapper&&n.V.Warn(`enableEffect has been called with an Effect and not a Wrapper! effect.uniqueId=${e.uniqueId}, effect.name=${e.name}, effect.name.vertex=${"string"==typeof e.name?"":e.name.vertex}, effect.name.fragment=${"string"==typeof e.name?"":e.name.fragment}`,10);this._stencilStateComposer.stencilMaterial=void 0,this._forceEnableEffect=!1,this._currentEffect.onBind&&this._currentEffect.onBind(this._currentEffect),this._currentEffect._onBindObservable&&this._currentEffect._onBindObservable.notifyObservers(this._currentEffect)}}_releaseEffect(e){this._compiledEffects[e._key]&&(delete this._compiledEffects[e._key],this._deletePipelineContext(e.getPipelineContext()))}releaseEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}_deletePipelineContext(e){const t=e;t&&(0,Pt.mO)(t)}get needPOTTextures(){return!1}_createHardwareTexture(){return new be(this)}_releaseTexture(e){const t=this._internalTexturesCache.indexOf(e);-1!==t&&this._internalTexturesCache.splice(t,1),this._textureHelper.releaseTexture(e)}_getRGBABufferInternalSizedFormat(){return 5}updateTextureComparisonFunction(e,t){e._comparisonFunction=t}_createInternalTexture(e,t,r=!0,s=0){const i={};void 0!==t&&"object"==typeof t?(i.generateMipMaps=t.generateMipMaps,i.createMipMaps=t.createMipMaps,i.type=void 0===t.type?0:t.type,i.samplingMode=void 0===t.samplingMode?3:t.samplingMode,i.format=void 0===t.format?5:t.format,i.samples=t.samples??1,i.creationFlags=t.creationFlags??0,i.useSRGBBuffer=t.useSRGBBuffer??!1,i.label=t.label):(i.generateMipMaps=t,i.type=0,i.samplingMode=3,i.format=5,i.samples=1,i.creationFlags=0,i.useSRGBBuffer=!1),(1!==i.type||this._caps.textureFloatLinearFiltering)&&(2!==i.type||this._caps.textureHalfFloatLinearFiltering)||(i.samplingMode=1),1!==i.type||this._caps.textureFloat||(i.type=0,n.V.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const a=new J.h(this,s),o=e.width??e,u=e.height??e,c=e.depth??0,l=e.layers??0;if(a.baseWidth=o,a.baseHeight=u,a.width=o,a.height=u,a.depth=c||l,a.isReady=!0,a.samples=i.samples,a.generateMipMaps=!!i.generateMipMaps,a.samplingMode=i.samplingMode,a.type=i.type,a.format=i.format,a.is2DArray=l>0,a.is3D=c>0,a._cachedWrapU=0,a._cachedWrapV=0,a._useSRGBBuffer=i.useSRGBBuffer,a.label=i.label,this._internalTexturesCache.push(a),!r){const e=!i.generateMipMaps&&i.createMipMaps;e&&(a.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(a,o,u,l||1,i.creationFlags),e&&(a.generateMipMaps=!1)}return a}createTexture(e,t,r,n,s=3,i=null,o=null,u=null,c=null,l=null,h=null,d,p,f,g){return this._createTextureBase(e,t,r,n,s,i,o,(e,t,r,n,s,i,o,u)=>{const c=n;if(e.baseWidth=c.width,e.baseHeight=c.height,e.width=c.width,e.height=c.height,e.format=-1!==e.format?e.format:l??5,e.type=-1!==e.type?e.type:0,e._creationFlags=f??0,u(e.width,e.height,c,t,e,()=>{}),e._hardwareTexture?.underlyingResource)i||o||this._generateMipmaps(e,this._uploadEncoder);else{const t=this._textureHelper.createGPUTextureForInternalTexture(e,c.width,c.height,void 0,f);a.IsImageBitmap(c)&&(this._textureHelper.updateTexture(c,e,c.width,c.height,e.depth,t.format,0,0,s,!1,0,0),i||o||this._generateMipmaps(e,this._uploadEncoder))}r&&r.removePendingData(e),e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()},()=>!1,u,c,l,h,d,p,g)}wrapWebGPUTexture(e){const t=new be(this,e),r=new J.h(this,0,!0);return r._hardwareTexture=t,r.isReady=!0,r}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapWebGPUTexture instead.")}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers}_unpackFlipY(e){}updateTextureSamplingMode(e,t,r=!1){r&&(t.generateMipMaps=!0,this._generateMipmaps(t)),t.samplingMode=e}updateTextureWrappingMode(e,t,r=null,n=null){null!==t&&(e._cachedWrapU=t),null!==r&&(e._cachedWrapV=r),(e.is2DArray||e.is3D)&&null!==n&&(e._cachedWrapR=n)}updateTextureDimensions(e,t,r,n=1){if(!e._hardwareTexture)return;if(e.width===t&&e.height===r&&e.depth===n)return;const s=e._hardwareTexture.textureAdditionalUsages;e._hardwareTexture.release(),this._textureHelper.createGPUTextureForInternalTexture(e,t,r,n,s)}_setInternalTexture(e,t,r){if(r=r??e,this._currentEffect){const n=this._currentEffect._pipelineContext.shaderProcessingContext.availableTextures[r];if(this._currentMaterialContext.setTexture(e,t),n&&n.autoBindSampler){const e=r+"Sampler";this._currentMaterialContext.setSampler(e,t)}}}createPrefilteredCubeTexture(e,t,r,n,s=null,i=null,a,o=null,u=!0){return this.createCubeTexture(e,t,null,!1,e=>{if(!e)return void(s&&s(null));const t=e.texture;u?e.info.sphericalPolynomial&&(t._sphericalPolynomial=e.info.sphericalPolynomial):t._sphericalPolynomial=new Bt.Q,t._source=9,s&&s(t)},i,a,o,u,r,n)}setTexture(e,t,r,n){this._setTexture(e,r,!1,!1,n,n)}setTextureArray(e,t,r,n){for(let e=0;e<r.length;e++)this._setTexture(-1,r[e],!0,!1,n+e.toString(),n)}_setTexture(e,t,r=!1,s=!1,i="",a){if(a=a??i,this._currentEffect){if(!t)return this._currentMaterialContext.setTexture(i,null),!1;if(t.video)t.update();else if(4===t.delayLoadState)return t.delayLoad(),!1;let e=null;if(e=s?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:t.is2DArray?this.emptyTexture2DArray:this.emptyTexture,e&&!e.isMultiview){if(e.isCube&&e._cachedCoordinatesMode!==t.coordinatesMode){e._cachedCoordinatesMode=t.coordinatesMode;const r=3!==t.coordinatesMode&&5!==t.coordinatesMode?1:0;t.wrapU=r,t.wrapV=r}e._cachedWrapU=t.wrapU,e._cachedWrapV=t.wrapV,e.is3D&&(e._cachedWrapR=t.wrapR),this._setAnisotropicLevel(0,e,t.anisotropicFilteringLevel)}this._setInternalTexture(i,e,a)}else this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&n.V.Log(["frame #"+this._count+" - _setTexture called with a null _currentEffect! texture=",t]));return!0}_setAnisotropicLevel(e,t,r){t._cachedAnisotropicFilteringLevel!==r&&(t._cachedAnisotropicFilteringLevel=Math.min(r,this._caps.maxAnisotropy))}_bindTexture(e,t,r){void 0!==e&&this._setInternalTexture(r,t)}generateMipmaps(e){this._generateMipmaps(e)}updateTextureData(e,t,r,n,s,i,a=0,o=0,u=!1){let c=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(c=this._textureHelper.createGPUTextureForInternalTexture(e));const l=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(l,e,s,i,e.depth,c.format,a,o,e.invertY,!1,r,n),u&&this._generateMipmaps(e)}_uploadCompressedDataToTextureDirectly(e,t,r,n,s,i=0,a=0){let o=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(e.format=t,o=this._textureHelper.createGPUTextureForInternalTexture(e,r,n));const u=new Uint8Array(s.buffer,s.byteOffset,s.byteLength);this._textureHelper.updateTexture(u,e,r,n,e.depth,o.format,i,a,!1,!1,0,0)}_uploadDataToTextureDirectly(e,t,r=0,n=0,s,i=!1){const a=Math.round(Math.log(e.width)*Math.LOG2E),o=Math.round(Math.log(e.height)*Math.LOG2E),u=i?e.width:Math.pow(2,Math.max(a-n,0)),c=i?e.height:Math.pow(2,Math.max(o-n,0));let l=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(l=this._textureHelper.createGPUTextureForInternalTexture(e,u,c));const h=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(h,e,u,c,e.depth,l.format,r,n,e.invertY,!1,0,0)}_uploadArrayBufferViewToTexture(e,t,r=0,n=0){this._uploadDataToTextureDirectly(e,t,r,n)}_uploadImageToTexture(e,t,r=0,n=0){let s=e._hardwareTexture;if(e._hardwareTexture?.underlyingResource||(s=this._textureHelper.createGPUTextureForInternalTexture(e)),t instanceof HTMLImageElement)throw"WebGPU engine: HTMLImageElement not supported in _uploadImageToTexture!";const i=t,a=Math.ceil(e.width/(1<<n)),o=Math.ceil(e.height/(1<<n));this._textureHelper.updateTexture(i,e,a,o,e.depth,s.format,r,n,e.invertY,!1,0,0)}readPixels(e,t,r,n,s=!0,i=!0,a=null){const o=this._getCurrentRenderPassWrapper().colorAttachmentGPUTextures[0];if(!o)return Promise.resolve(new Uint8Array(0));const u=o.underlyingResource,c=o.format;return u?(i&&this.flushFramebuffer(),this._textureHelper.readPixels(u,e,t,r,n,c,void 0,void 0,a)):Promise.resolve(new Uint8Array(0))}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}beginFrame(){this._measureFps(),super.beginFrame()}endFrame(){if(this._endCurrentRenderPass(),this._snapshotRendering.endFrame(),this._timestampQuery.endFrame(this._renderEncoder),this._timestampIndex=0,this.flushFramebuffer(),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._features._collectUbosUpdatedInFrame){if(this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){const e=[];for(const t in te.D._UpdatedUbosInFrame)e.push(t+":"+te.D._UpdatedUbosInFrame[t]);n.V.Log(["frame #"+this._count+" - updated ubos -",e.join(", ")])}te.D._UpdatedUbosInFrame={}}this.countersLastFrame.numEnableEffects=this._counters.numEnableEffects,this.countersLastFrame.numEnableDrawWrapper=this._counters.numEnableDrawWrapper,this.countersLastFrame.numBundleCreationNonCompatMode=this._counters.numBundleCreationNonCompatMode,this.countersLastFrame.numBundleReuseNonCompatMode=this._counters.numBundleReuseNonCompatMode,this._counters.numEnableEffects=0,this._counters.numEnableDrawWrapper=0,this._counters.numBundleCreationNonCompatMode=0,this._counters.numBundleReuseNonCompatMode=0,this._cacheRenderPipeline.endFrame(),this._cacheBindGroups.endFrame(),this._pendingDebugCommands.length=0,this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),this._count<this.dbgVerboseLogsNumFrames&&n.V.Log(["%c frame #"+this._count+" - end","background: #ffff00"]),this._count<this.dbgVerboseLogsNumFrames&&(this._count++,this._count!==this.dbgVerboseLogsNumFrames&&n.V.Log(["%c frame #"+this._count+" - begin","background: #ffff00"]))),super.endFrame()}extractDriverInfo(){return""}flushFramebuffer(){this._endCurrentRenderPass(),this._commandBuffers[0]=this._uploadEncoder.finish(),this._commandBuffers[1]=this._renderEncoder.finish(),this._device.queue.submit(this._commandBuffers),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._timestampQuery.startFrame(this._uploadEncoder),this._textureHelper.setCommandEncoder(this._uploadEncoder),this._bundleList.reset()}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentPassIsMainPass()}_startRenderTargetRenderPass(e,t,r,s,i){this._endCurrentRenderPass();const o=e,u=o._depthStencilTexture,c=u?._hardwareTexture,l=c?.underlyingResource,h=c?.getMSAATexture(0),d=l?.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),p=h?.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),f=!!c&&a.HasStencilAspect(c.format),g=[];this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const m=Wt;r&&(m.r=255*r.r,m.g=255*r.g,m.b=255*r.b,m.a=255*r.a);const _=t&&r,b=t&&s,x=t&&i;if(o._attachments&&o.isMulti){this._mrtAttachments&&0!==this._mrtAttachments.length||(this._mrtAttachments=o._defaultAttachments);for(let e=0;e<this._mrtAttachments.length;++e){const t=this._mrtAttachments[e],n=o.textures[e],s=n?._hardwareTexture,i=s?.underlyingResource;if(s&&i){const a=o.getBaseArrayLayer(e),u=s.getMSAATexture(a),c={...this._rttRenderPassWrapper.colorAttachmentViewDescriptor,dimension:n.is3D?"3d":"2d",format:s.format,baseArrayLayer:a},l={...this._rttRenderPassWrapper.colorAttachmentViewDescriptor,dimension:n.is3D?"3d":"2d",format:s.format,baseArrayLayer:0},h=7===n.type||5===n.type,d=i.createView(c),p=u?.createView(l);g.push({view:p||d,resolveTarget:u?d:void 0,depthSlice:n.is3D?o.layerIndices?.[e]??0:void 0,clearValue:0!==t&&_?h?m:r:void 0,loadOp:0!==t&&_?"clear":"load",storeOp:"store"})}}this._cacheRenderPipeline.setMRT(o.textures,this._mrtAttachments.length),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}else{const e=o.texture;if(e){const t=e._hardwareTexture,n=t.underlyingResource;let s;o.is3D&&(s=this._rttRenderPassWrapper.colorAttachmentViewDescriptor.baseArrayLayer,this._rttRenderPassWrapper.colorAttachmentViewDescriptor.baseArrayLayer=0);const i=t.getMSAATexture(0),a=n.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),u=i?.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),c=7===e.type||5===e.type;g.push({view:u||a,resolveTarget:i?a:void 0,depthSlice:s,clearValue:_?c?m:r:void 0,loadOp:_?"clear":"load",storeOp:"store"})}else g.push(null)}if(this._debugPushGroup?.("render target pass"+(e.label?" ("+e.label+")":""),0),this._rttRenderPassWrapper.renderPassDescriptor={label:(e.label??"RTT")+" - RenderPass",colorAttachments:g,depthStencilAttachment:u&&l?{view:p||d,depthClearValue:b?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,depthLoadOp:o.depthReadOnly?void 0:b?"clear":"load",depthStoreOp:o.depthReadOnly?void 0:"store",depthReadOnly:o.depthReadOnly,stencilClearValue:o._depthStencilTextureWithStencil&&x?this._clearStencilValue:void 0,stencilLoadOp:o.stencilReadOnly?void 0:f?o._depthStencilTextureWithStencil&&x?"clear":"load":void 0,stencilStoreOp:o.stencilReadOnly?void 0:f?"store":void 0,stencilReadOnly:o.stencilReadOnly}:void 0,occlusionQuerySet:this._occlusionQuery?.hasQueries?this._occlusionQuery.querySet:void 0},this._timestampQuery.startPass(this._rttRenderPassWrapper.renderPassDescriptor,this._timestampIndex),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._rttRenderPassWrapper.renderPassDescriptor),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){const r=o.texture;n.V.Log(["frame #"+this._count+" - render target begin pass - rtt name="+e.label+", internalTexture.uniqueId="+r.uniqueId+", width="+r.width+", height="+r.height+", setClearStates="+t,"renderPassDescriptor=",this._rttRenderPassWrapper.renderPassDescriptor])}this._debugFlushPendingCommands?.(),this._resetRenderPassStates(),c&&a.HasStencilAspect(c.format)||(this._stencilStateComposer.enabled=!1)}_startMainRenderPass(e,t,r,s){this._endCurrentRenderPass(),this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const i=e&&t,a=e&&r,o=e&&s;this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].clearValue=i?t:void 0,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].loadOp=i?"clear":"load",this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthClearValue=a?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthLoadOp=a?"clear":"load",this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilClearValue=o?this._clearStencilValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilLoadOp=this.isStencilEnable?o?"clear":"load":void 0,this._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet=this._occlusionQuery?.hasQueries?this._occlusionQuery.querySet:void 0;const u=this._context.getCurrentTexture();this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].set(u),this._options.antialias?(Vt.format=u.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].resolveTarget=u.createView(Vt)):(Nt.format=u.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].view=u.createView(Nt)),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&n.V.Log(["frame #"+this._count+" - main begin pass - texture width="+this._mainTextureExtends.width," height="+this._mainTextureExtends.height+", setClearStates="+e,"renderPassDescriptor=",this._mainRenderPassWrapper.renderPassDescriptor])),this._debugPushGroup?.("main pass",0),this._timestampQuery.startPass(this._mainRenderPassWrapper.renderPassDescriptor,this._timestampIndex),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._mainRenderPassWrapper.renderPassDescriptor),this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper),this._debugFlushPendingCommands?.(),this._resetRenderPassStates(),this._isStencilEnable||(this._stencilStateComposer.enabled=!1)}bindFramebuffer(e,t=0,r,s,i,o=0,u=0){const c=e.texture?._hardwareTexture;this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass(),this._currentRenderTarget=e;const l=this._currentRenderTarget._depthStencilTexture;this._rttRenderPassWrapper.colorAttachmentGPUTextures[0]=c,this._rttRenderPassWrapper.depthTextureFormat=l?a.GetWebGPUTextureFormat(-1,l.format):void 0,this._setDepthTextureFormat(this._rttRenderPassWrapper),this._setColorFormat(this._rttRenderPassWrapper),this._rttRenderPassWrapper.colorAttachmentViewDescriptor={format:this._colorFormat,dimension:e.is3D?"3d":"2d",mipLevelCount:1,baseArrayLayer:e.isCube?6*u+t:u,baseMipLevel:o,arrayLayerCount:1,aspect:"all"},this._rttRenderPassWrapper.depthAttachmentViewDescriptor={format:this._depthTextureFormat,dimension:l&&l.is3D?"3d":"2d",mipLevelCount:1,baseArrayLayer:l?l.isCube?6*u+t:u:0,baseMipLevel:0,arrayLayerCount:1,aspect:"all"},this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&n.V.Log(["frame #"+this._count+" - bindFramebuffer - rtt name="+e.label+", internalTexture.uniqueId="+e.texture?.uniqueId+", face="+t+", lodLevel="+o+", layer="+u,"colorAttachmentViewDescriptor=",this._rttRenderPassWrapper.colorAttachmentViewDescriptor,"depthAttachmentViewDescriptor=",this._rttRenderPassWrapper.depthAttachmentViewDescriptor])),(this._snapshotRendering.play||this._snapshotRendering.record)&&this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1),this._cachedViewport&&!i?this.setViewport(this._cachedViewport,r,s):(r||(r=e.width,o&&(r/=Math.pow(2,o))),s||(s=e.height,o&&(s/=Math.pow(2,o))),this._viewport(0,0,r,s)),this.wipeCaches()}unBindFramebuffer(e,t=!1,r){const s=this._currentRenderTarget;this._currentRenderTarget=null,r&&r(),this._currentRenderTarget=s,this._endCurrentRenderPass(),t||(e.isMulti?this.generateMipMapsMultiFramebuffer(e):this.generateMipMapsFramebuffer(e)),this._currentRenderTarget=null,this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&n.V.Log("frame #"+this._count+" - unBindFramebuffer - rtt name="+e.label+", internalTexture.uniqueId=",e.texture?.uniqueId)),this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}generateMipMapsFramebuffer(e){e.isMulti||!e.texture?.generateMipMaps||e.isCube||this._generateMipmaps(e.texture)}resolveFramebuffer(e){throw new Error("resolveFramebuffer is not yet implemented in WebGPU!")}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._currentRenderPass||this._startMainRenderPass(!1),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_setColorFormat(e){const t=e.colorAttachmentGPUTextures[0]?.format??null;this._cacheRenderPipeline.setColorFormat(t),this._colorFormat!==t&&(this._colorFormat=t)}_setDepthTextureFormat(e){this._cacheRenderPipeline.setDepthStencilFormat(e.depthTextureFormat),this._depthTextureFormat!==e.depthTextureFormat&&(this._depthTextureFormat=e.depthTextureFormat)}setDitheringState(){}setRasterizerState(){}_executeWhenRenderingStateIsCompiled(e,t){t()}bindSamplers(){}_getUnpackAlignement(){return 1}_bindTextureDirectly(){return!1}setStateCullFaceType(e,t=!1){const r=this.cullBackFaces??e??1?1:2;(this._depthCullingState.cullFace!==r||t)&&(this._depthCullingState.cullFace=r)}setState(e,t=0,r,n=!1,s,i,a=0){(this._depthCullingState.cull!==e||r)&&(this._depthCullingState.cull=e),this.setStateCullFaceType(s,r),this.setZOffset(t),this.setZOffsetUnits(a);const o=n?this._currentRenderTarget?1:2:this._currentRenderTarget?2:1;(this._depthCullingState.frontFace!==o||r)&&(this._depthCullingState.frontFace=o),this._stencilStateComposer.stencilMaterial=i}_applyRenderPassChanges(e){const t=!!this._stencilStateComposer.enabled&&this._mustUpdateStencilRef(),r=!!this._alphaState.alphaBlend&&this._mustUpdateBlendColor();this._mustUpdateViewport()&&this._applyViewport(e),this._mustUpdateScissor()&&this._applyScissor(e),t&&this._applyStencilRef(e),r&&this._applyBlendColor(e)}_draw(e,t,r,n,s){const i=this._getCurrentRenderPass(),o=this._bundleList;this.applyStates();const u=this._currentEffect._pipelineContext;if(this.bindUniformBufferBase(this._currentRenderTarget?this._ubInvertY:this._ubDontInvertY,0,re.InternalsUBOName),this._currentDrawContext.setVertexPulling(this._currentMaterialContext.useVertexPulling,u,this._currentVertexBuffers,this._cacheRenderPipeline.indexBuffer,this._currentOverrideVertexBuffers),u.uniformBuffer&&(u.uniformBuffer.update(),this.bindUniformBufferBase(u.uniformBuffer.getBuffer(),0,re.LeftOvertUBOName)),this._snapshotRendering.play)return void this._reportDrawCall();!this.compatibilityMode&&(this._currentDrawContext.isDirty(this._currentMaterialContext.updateId)||this._currentMaterialContext.isDirty||this._currentMaterialContext.forceBindGroupCreation)&&(this._currentDrawContext.fastBundle=void 0);let c=i;if(!this.compatibilityMode&&this._currentDrawContext.fastBundle||this._snapshotRendering.record){if(this._applyRenderPassChanges(o),!this._snapshotRendering.record)return this._counters.numBundleReuseNonCompatMode++,this._currentDrawContext.indirectDrawBuffer&&this._currentDrawContext.setIndirectData(n,s||1,r),o.addBundle(this._currentDrawContext.fastBundle),void this._reportDrawCall();c=o.getBundleEncoder(this._cacheRenderPipeline.colorFormats,this._depthTextureFormat,this.currentSampleCount),o.numDrawCalls++}let l=0;if(this._currentMaterialContext.hasFloatOrDepthTextures){let e=1;for(let t=0;t<u.shaderProcessingContext.textureNames.length;++t){const r=u.shaderProcessingContext.textureNames[t],n=this._currentMaterialContext.textures[r]?.texture,s=n&&n.format>=13&&n.format<=18;(1===n?.type&&!this._caps.textureFloatLinearFiltering||s)&&(l|=e),e<<=1}}this._currentMaterialContext.textureState=l;const h=this._cacheRenderPipeline.getRenderPipeline(t,this._currentEffect,this.currentSampleCount,l),d=this._cacheBindGroups.getBindGroups(u,this._currentDrawContext,this._currentMaterialContext);this._snapshotRendering.record||(this._applyRenderPassChanges(this.compatibilityMode?null:o),this.compatibilityMode||(this._counters.numBundleCreationNonCompatMode++,c=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:a.GetSample(this.currentSampleCount)}))),c.setPipeline(h),this._currentIndexBuffer&&c.setIndexBuffer(this._currentIndexBuffer.underlyingResource,this._currentIndexBuffer.is32Bits?"uint32":"uint16",0);const p=this._cacheRenderPipeline.vertexBuffers;for(let e=0;e<p.length;e++){const t=p[e],r=t.effectiveBuffer;r&&c.setVertexBuffer(e,r.underlyingResource,t._validOffsetRange?0:t.byteOffset)}for(let e=0;e<d.length;e++)c.setBindGroup(e,d[e]);const f=!this.compatibilityMode&&!this._snapshotRendering.record;(f||this._currentDrawContext._enableIndirectDrawInCompatMode)&&this._currentDrawContext.indirectDrawBuffer?(this._currentDrawContext.setIndirectData(n,s||1,r),0===e?c.drawIndexedIndirect(this._currentDrawContext.indirectDrawBuffer,0):c.drawIndirect(this._currentDrawContext.indirectDrawBuffer,0)):0===e?c.drawIndexed(n,s||1,r,0,0):c.draw(n,s||1,r,0),f&&(this._currentDrawContext.fastBundle=c.finish(),o.addBundle(this._currentDrawContext.fastBundle)),this._reportDrawCall()}drawElementsType(e,t,r,n=1){this._draw(0,e,t,r,n)}drawArraysType(e,t,r,n=1){this._currentIndexBuffer=null,this._draw(1,e,t,r,n)}dispose(){this._isDisposed=!0,this.hideLoadingUI(),this._timestampQuery.dispose(),this._mainTexture?.destroy(),this._depthTexture?.destroy(),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._device.destroy(),(0,At.kX)(this,this._renderingCanvas),super.dispose()}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._renderingCanvas?.width??0}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._renderingCanvas?.height??0}getError(){return 0}createExternalTexture(e){return new Dt(e)}setExternalTexture(e,t){t?this._setInternalTexture(e,t):this._currentMaterialContext.setTexture(e,null)}setTextureSampler(e,t){this._currentMaterialContext?.setSampler(e,t)}createStorageBuffer(e,t,r){return this._createBuffer(e,32|t,r)}clearStorageBuffer(e,t,r){this._renderEncoder.clearBuffer(e.underlyingResource,t,r)}updateStorageBuffer(e,t,r,n){const s=e;let i;void 0===r&&(r=0),void 0===n?(i=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,n=i.byteLength):i=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,this._bufferManager.setSubData(s,r,i,0,n)}async _readFromGPUBuffer(e,t,r,n){return await new Promise((s,i)=>{const a=()=>{e.mapAsync(1,0,t).then(()=>{const n=e.getMappedRange(0,t);let i=r;if(void 0===i)i=new Uint8Array(t),i.set(new Uint8Array(n));else{const e=i.constructor;i=new e(i.buffer),i.set(new e(n))}e.unmap(),this._bufferManager.releaseBuffer(e),s(i)},e=>{this.isDisposed?s(new Uint8Array):i(e)})};n?(this.flushFramebuffer(),a()):this.onEndFrameObservable.addOnce(()=>{a()})})}readFromStorageBuffer(e,t,r,n,s){r=r||e.capacity;const i=this._bufferManager.createRawBuffer(r,p.MapRead|p.CopyDst,void 0,"TempReadFromStorageBuffer");return this._renderEncoder.copyBufferToBuffer(e.underlyingResource,t??0,i,0,r),this._readFromGPUBuffer(i,r,n,s)}readFromMultipleStorageBuffers(e,t,r,n,s){r=r||e[0].capacity;const i=this._bufferManager.createRawBuffer(r*e.length,p.MapRead|p.CopyDst,void 0,"TempReadFromMultipleStorageBuffers");for(let n=0;n<e.length;n++)this._renderEncoder.copyBufferToBuffer(e[n].underlyingResource,t??0,i,n*r,r);return this._readFromGPUBuffer(i,r*e.length,n,s)}setStorageBuffer(e,t){this._currentDrawContext?.setBuffer(e,t?.getBuffer()??null)}}$t._GlslangDefaultOptions={jsPath:`${_e.S0._DefaultCdnUrl}/glslang/glslang.js`,wasmPath:`${_e.S0._DefaultCdnUrl}/glslang/glslang.wasm`},$t._InstanceId=0},44559:(e,t,r)=>{var n=r(69610);const s="instancesDeclaration",i="#ifdef INSTANCES\nattribute world0 : vec4<f32>;attribute world1 : vec4<f32>;attribute world2 : vec4<f32>;attribute world3 : vec4<f32>;\n#ifdef INSTANCESCOLOR\nattribute instanceColor : vec4<f32>;\n#endif\n#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)\nuniform world : mat4x4<f32>;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nattribute previousWorld0 : vec4<f32>;attribute previousWorld1 : vec4<f32>;attribute previousWorld2 : vec4<f32>;attribute previousWorld3 : vec4<f32>;\n#ifdef THIN_INSTANCES\nuniform previousWorld : mat4x4<f32>;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nuniform world : mat4x4<f32>;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nuniform previousWorld : mat4x4<f32>;\n#endif\n#endif\n";n.l.IncludesShadersStoreWGSL[s]||(n.l.IncludesShadersStoreWGSL[s]=i)},49306:(e,t,r)=>{var n=r(69610);const s="decalFragment",i="#ifdef DECAL\nvar decalTempColor=decalColor.rgb;var decalTempAlpha=decalColor.a;\n#ifdef GAMMADECAL\ndecalTempColor=toLinearSpaceVec3(decalColor.rgb);\n#endif\n#ifdef DECAL_SMOOTHALPHA\ndecalTempAlpha=decalColor.a*decalColor.a;\n#endif\nsurfaceAlbedo=mix(surfaceAlbedo.rgb,decalTempColor,decalTempAlpha);\n#endif\n";n.l.IncludesShadersStoreWGSL[s]||(n.l.IncludesShadersStoreWGSL[s]=i)},56608:(e,t,r)=>{r.d(t,{R:()=>n.R});var n=r(95616)},79702:(e,t,r)=>{var n=r(69610);const s="helperFunctions",i="const PI: f32=3.1415926535897932384626433832795;const TWO_PI: f32=6.283185307179586;const HALF_PI: f32=1.5707963267948966;const RECIPROCAL_PI: f32=0.3183098861837907;const RECIPROCAL_PI2: f32=0.15915494309189535;const RECIPROCAL_PI4: f32=0.07957747154594767;const HALF_MIN: f32=5.96046448e-08; \nconst LinearEncodePowerApprox: f32=2.2;const GammaEncodePowerApprox: f32=1.0/LinearEncodePowerApprox;const LuminanceEncodeApprox: vec3f=vec3f(0.2126,0.7152,0.0722);const Epsilon:f32=0.0000001;fn square(x: f32)->f32 {return x*x;}\nfn saturate(x: f32)->f32 {return clamp(x,0.0,1.0);}\nfn saturateVec3(x: vec3f)->vec3f {return clamp(x,vec3f(),vec3f(1.0));}\nfn saturateEps(x: f32)->f32 {return clamp(x,Epsilon,1.0);}\nfn maxEps(x: f32)->f32 {return max(x,Epsilon);}\nfn maxEpsVec3(x: vec3f)->vec3f {return max(x,vec3f(Epsilon));}\nfn absEps(x: f32)->f32 {return abs(x)+Epsilon;}\nfn transposeMat3(inMatrix: mat3x3f)->mat3x3f {let i0: vec3f=inMatrix[0];let i1: vec3f=inMatrix[1];let i2: vec3f=inMatrix[2];let outMatrix:mat3x3f=mat3x3f(\nvec3(i0.x,i1.x,i2.x),\nvec3(i0.y,i1.y,i2.y),\nvec3(i0.z,i1.z,i2.z)\n);return outMatrix;}\nfn inverseMat3(inMatrix: mat3x3f)->mat3x3f {let a00: f32=inMatrix[0][0];let a01: f32=inMatrix[0][1];let a02: f32=inMatrix[0][2];let a10: f32=inMatrix[1][0];let a11: f32=inMatrix[1][1];let a12: f32=inMatrix[1][2];let a20: f32=inMatrix[2][0];let a21: f32=inMatrix[2][1];let a22: f32=inMatrix[2][2];let b01: f32=a22*a11-a12*a21;let b11: f32=-a22*a10+a12*a20;let b21: f32=a21*a10-a11*a20;let det: f32=a00*b01+a01*b11+a02*b21;return mat3x3f(b01/det,(-a22*a01+a02*a21)/det,(a12*a01-a02*a11)/det,\nb11/det,(a22*a00-a02*a20)/det,(-a12*a00+a02*a10)/det,\nb21/det,(-a21*a00+a01*a20)/det,(a11*a00-a01*a10)/det);}\n#if USE_EXACT_SRGB_CONVERSIONS\nfn toLinearSpaceExact(color: vec3f)->vec3f\n{let nearZeroSection: vec3f=0.0773993808*color;let remainingSection: vec3f=pow(0.947867299*(color+vec3f(0.055)),vec3f(2.4));return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3f(0.04045)));}\nfn toGammaSpaceExact(color: vec3f)->vec3f\n{let nearZeroSection: vec3f=12.92*color;let remainingSection: vec3f=1.055*pow(color,vec3f(0.41666))-vec3f(0.055);return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3f(0.0031308)));}\n#endif\nfn toLinearSpace(color: f32)->f32\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nvar nearZeroSection=0.0773993808*color;var remainingSection=pow(0.947867299*(color+0.055),2.4);return select(remainingSection,nearZeroSection,color<=0.04045);\n#else\nreturn pow(color,LinearEncodePowerApprox);\n#endif\n}\nfn toLinearSpaceVec3(color: vec3f)->vec3f\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toLinearSpaceExact(color);\n#else\nreturn pow(color,vec3f(LinearEncodePowerApprox));\n#endif\n}\nfn toLinearSpaceVec4(color: vec4<f32>)->vec4<f32>\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4f(toLinearSpaceExact(color.rgb),color.a);\n#else\nreturn vec4f(pow(color.rgb,vec3f(LinearEncodePowerApprox)),color.a);\n#endif\n}\nfn toGammaSpace(color: vec4<f32>)->vec4<f32>\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4<f32>(toGammaSpaceExact(color.rgb),color.a);\n#else\nreturn vec4<f32>(pow(color.rgb,vec3f(GammaEncodePowerApprox)),color.a);\n#endif\n}\nfn toGammaSpaceVec3(color: vec3f)->vec3f\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toGammaSpaceExact(color);\n#else\nreturn pow(color,vec3f(GammaEncodePowerApprox));\n#endif\n}\nfn squareVec3(value: vec3f)->vec3f\n{return value*value;}\nfn pow5(value: f32)->f32 {let sq: f32=value*value;return sq*sq*value;}\nfn getLuminance(color: vec3f)->f32\n{return saturate(dot(color,LuminanceEncodeApprox));}\nfn getRand(seed: vec2<f32>)->f32 {return fract(sin(dot(seed.xy ,vec2<f32>(12.9898,78.233)))*43758.5453);}\nfn dither(seed: vec2<f32>,varianceAmount: f32)->f32 {let rand: f32=getRand(seed);let normVariance: f32=varianceAmount/255.0;let dither: f32=mix(-normVariance,normVariance,rand);return dither;}\nconst rgbdMaxRange: f32=255.0;fn toRGBD(color: vec3f)->vec4<f32> {let maxRGB: f32=max(max(color.r,max(color.g,color.b)),Epsilon);var D: f32 =max(rgbdMaxRange/maxRGB,1.);D =clamp(floor(D)/255.0,0.,1.);var rgb: vec3f =color.rgb*D;rgb=toGammaSpaceVec3(rgb);return vec4<f32>(saturateVec3(rgb),D);}\nfn fromRGBD(rgbd: vec4<f32>)->vec3f {let rgb=toLinearSpaceVec3(rgbd.rgb);return rgb/rgbd.a;}\nfn parallaxCorrectNormal(vertexPos: vec3f,origVec: vec3f,cubeSize: vec3f,cubePos: vec3f)->vec3f {let invOrigVec: vec3f=vec3f(1.)/origVec;let halfSize: vec3f=cubeSize*0.5;let intersecAtMaxPlane: vec3f=(cubePos+halfSize-vertexPos)*invOrigVec;let intersecAtMinPlane: vec3f=(cubePos-halfSize-vertexPos)*invOrigVec;let largestIntersec: vec3f=max(intersecAtMaxPlane,intersecAtMinPlane);let distance: f32=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);let intersectPositionWS: vec3f=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}\nfn equirectangularToCubemapDirection(uv : vec2f)->vec3f {var longitude : f32=uv.x*TWO_PI-PI;var latitude : f32=HALF_PI-uv.y*PI;var direction : vec3f;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}\nfn sqrtClamped(value: f32)->f32 {return sqrt(max(value,0.));}\nfn avg(value: vec3f)->f32 {return dot(value,vec3f(0.333333333));}\n";n.l.IncludesShadersStoreWGSL[s]||(n.l.IncludesShadersStoreWGSL[s]=i)},91277:(e,t,r)=>{var n=r(69610);const s="instancesVertex",i="#ifdef INSTANCES\nvar finalWorld=mat4x4<f32>(vertexInputs.world0,vertexInputs.world1,vertexInputs.world2,vertexInputs.world3);\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nvar finalPreviousWorld=mat4x4<f32>(\nvertexInputs.previousWorld0,vertexInputs.previousWorld1,\nvertexInputs.previousWorld2,vertexInputs.previousWorld3);\n#endif\n#ifdef THIN_INSTANCES\n#if !defined(WORLD_UBO)\nfinalWorld=uniforms.world*finalWorld;\n#else\nfinalWorld=mesh.world*finalWorld;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nfinalPreviousWorld=uniforms.previousWorld*finalPreviousWorld;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nvar finalWorld=uniforms.world;\n#else\nvar finalWorld=mesh.world;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nvar finalPreviousWorld=uniforms.previousWorld;\n#endif\n#endif\n";n.l.IncludesShadersStoreWGSL[s]||(n.l.IncludesShadersStoreWGSL[s]=i)},98327:(e,t,r)=>{var n=r(69610);const s="sceneUboDeclaration",i="struct Scene {viewProjection : mat4x4<f32>,\n#ifdef MULTIVIEW\nviewProjectionR : mat4x4<f32>,\n#endif \nview : mat4x4<f32>,\nprojection : mat4x4<f32>,\nvEyePosition : vec4<f32>,};\n#define SCENE_UBO\nvar<uniform> scene : Scene;\n";n.l.IncludesShadersStoreWGSL[s]||(n.l.IncludesShadersStoreWGSL[s]=i)},98900:(e,t,r)=>{var n=r(69610);const s="bakedVertexAnimationDeclaration",i="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\nuniform bakedVertexAnimationTime: f32;uniform bakedVertexAnimationTextureSizeInverted: vec2<f32>;uniform bakedVertexAnimationSettings: vec4<f32>;var bakedVertexAnimationTexture : texture_2d<f32>;\n#ifdef INSTANCES\nattribute bakedVertexAnimationSettingsInstanced : vec4<f32>;\n#endif\nfn readMatrixFromRawSamplerVAT(smp : texture_2d<f32>,index : f32,frame : f32)->mat4x4<f32>\n{let offset=i32(index)*4;let frameUV=i32(frame);let m0=textureLoad(smp,vec2<i32>(offset+0,frameUV),0);let m1=textureLoad(smp,vec2<i32>(offset+1,frameUV),0);let m2=textureLoad(smp,vec2<i32>(offset+2,frameUV),0);let m3=textureLoad(smp,vec2<i32>(offset+3,frameUV),0);return mat4x4<f32>(m0,m1,m2,m3);}\n#endif\n";n.l.IncludesShadersStoreWGSL[s]||(n.l.IncludesShadersStoreWGSL[s]=i)}}]);