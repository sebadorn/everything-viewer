"use strict";(self.webpackChunkeverything_viewer=self.webpackChunkeverything_viewer||[]).push([[6504],{36504:(t,e,i)=>{i.d(e,{$:()=>r});var o=i(14037),s=i(27309),n=i(4870);class r extends n.b{get _matrix(){return this._compose(),this._localMatrix}set _matrix(t){(t.updateFlag!==this._localMatrix.updateFlag||this._needToCompose)&&(this._needToCompose=!1,this._localMatrix.copyFrom(t),this._markAsDirtyAndDecompose())}constructor(t,e,i=null,s=null,n=null,r=null,a=null){super(t,e.getScene(),!1),this.name=t,this.children=[],this.animations=[],this._index=null,this._scalingDeterminant=1,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=e,this._localMatrix=s?.clone()??o.uq.Identity(),this._restMatrix=n??this._localMatrix.clone(),this._bindMatrix=r??this._localMatrix.clone(),this._index=a,this._absoluteMatrix=new o.uq,this._absoluteBindMatrix=new o.uq,this._absoluteInverseBindMatrix=new o.uq,this._finalMatrix=new o.uq,e.bones.push(this),this.setParent(i,!1),this._updateAbsoluteBindMatrices()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return null===this._index?this.getSkeleton().bones.indexOf(this):this._index}set parent(t){this.setParent(t)}setParent(t,e=!0){if(this.parent!==t){if(this.parent){const t=this.parent.children.indexOf(this);-1!==t&&this.parent.children.splice(t,1)}this._parentNode=t,this.parent&&this.parent.children.push(this),e&&this._updateAbsoluteBindMatrices(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBindMatrix(){return this._bindMatrix}getBaseMatrix(){return this.getBindMatrix()}getRestMatrix(){return this._restMatrix}getRestPose(){return this.getRestMatrix()}setRestMatrix(t){this._restMatrix.copyFrom(t)}setRestPose(t){this.setRestMatrix(t)}getBindPose(){return this.getBindMatrix()}setBindMatrix(t){this.updateMatrix(t)}setBindPose(t){this.setBindMatrix(t)}getFinalMatrix(){return this._finalMatrix}getWorldMatrix(){return this.getFinalMatrix()}returnToRest(){if(this._linkedTransformNode){const t=o.AA.Vector3[0],e=o.AA.Quaternion[0],i=o.AA.Vector3[1];this.getRestMatrix().decompose(t,e,i),this._linkedTransformNode.position.copyFrom(i),this._linkedTransformNode.rotationQuaternion=this._linkedTransformNode.rotationQuaternion??o.PT.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(e),this._linkedTransformNode.scaling.copyFrom(t)}else this._matrix=this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}getInvertedAbsoluteTransform(){return this.getAbsoluteInverseBindMatrix()}getAbsoluteMatrix(){return this._absoluteMatrix}getAbsoluteTransform(){return this._absoluteMatrix}linkTransformNode(t){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=t,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(t){this._decompose(),this._localPosition.copyFrom(t),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(t){this.setRotation(t)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(t){this.setRotationQuaternion(t)}get scaling(){return this.getScale()}set scaling(t){this.setScale(t)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=o.Pq.Zero(),this._localRotation=o.PT.Zero(),this._localPosition=o.Pq.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){this._needToCompose&&(this._localScaling?(this._needToCompose=!1,o.uq.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)):this._needToCompose=!1)}updateMatrix(t,e=!0,i=!0){this._bindMatrix.copyFrom(t),e&&this._updateAbsoluteBindMatrices(),i?this._matrix=t:this.markAsDirty()}_updateAbsoluteBindMatrices(t,e=!0){if(t||(t=this._bindMatrix),this.parent?t.multiplyToRef(this.parent._absoluteBindMatrix,this._absoluteBindMatrix):this._absoluteBindMatrix.copyFrom(t),this._absoluteBindMatrix.invertToRef(this._absoluteInverseBindMatrix),e)for(let t=0;t<this.children.length;t++)this.children[t]._updateAbsoluteBindMatrices();this._scalingDeterminant=this._absoluteBindMatrix.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}_updatePosition(t,e=0,i,s=!0){const n=this.getLocalMatrix();if(0==e)s?(n.addAtIndex(12,t.x),n.addAtIndex(13,t.y),n.addAtIndex(14,t.z)):n.setTranslationFromFloats(t.x,t.y,t.z);else{let e=null;i&&(e=i.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const a=r._TmpMats[0],l=r._TmpVecs[0];this.parent?i&&e?(a.copyFrom(this.parent.getAbsoluteMatrix()),a.multiplyToRef(e,a)):a.copyFrom(this.parent.getAbsoluteMatrix()):o.uq.IdentityToRef(a),s&&a.setTranslationFromFloats(0,0,0),a.invert(),o.Pq.TransformCoordinatesToRef(t,a,l),s?(n.addAtIndex(12,l.x),n.addAtIndex(13,l.y),n.addAtIndex(14,l.z)):n.setTranslationFromFloats(l.x,l.y,l.z)}this._markAsDirtyAndDecompose()}translate(t,e=0,i){this._updatePosition(t,e,i,!0)}setPosition(t,e=0,i){this._updatePosition(t,e,i,!1)}setAbsolutePosition(t,e){this.setPosition(t,1,e)}scale(t,e,i,s=!1){const n=this.getLocalMatrix(),a=r._TmpMats[0];o.uq.ScalingToRef(t,e,i,a),a.multiplyToRef(n,n),a.invert();for(const o of this.children){const s=o.getLocalMatrix();s.multiplyToRef(a,s),s.multiplyAtIndex(12,t),s.multiplyAtIndex(13,e),s.multiplyAtIndex(14,i),o._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),s)for(const o of this.children)o.scale(t,e,i,s)}setScale(t){this._decompose(),this._localScaling.copyFrom(t),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(t){this._decompose(),t.copyFrom(this._localScaling)}setYawPitchRoll(t,e,i,s=0,n){if(0===s){const a=r._TmpQuat;return o.PT.RotationYawPitchRollToRef(t,e,i,a),void this.setRotationQuaternion(a,s,n)}const a=r._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(a,n))return;const l=r._TmpMats[1];o.uq.RotationYawPitchRollToRef(t,e,i,l),a.multiplyToRef(l,l),this._rotateWithMatrix(l,s,n)}rotate(t,e,i=0,s){const n=r._TmpMats[0];n.setTranslationFromFloats(0,0,0),o.uq.RotationAxisToRef(t,e,n),this._rotateWithMatrix(n,i,s)}setAxisAngle(t,e,i=0,s){if(0===i){const n=r._TmpQuat;return o.PT.RotationAxisToRef(t,e,n),void this.setRotationQuaternion(n,i,s)}const n=r._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(n,s))return;const a=r._TmpMats[1];o.uq.RotationAxisToRef(t,e,a),n.multiplyToRef(a,a),this._rotateWithMatrix(a,i,s)}setRotation(t,e=0,i){this.setYawPitchRoll(t.y,t.x,t.z,e,i)}setRotationQuaternion(t,e=0,i){if(0===e)return this._decompose(),this._localRotation.copyFrom(t),void this._markAsDirtyAndCompose();const s=r._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,i))return;const n=r._TmpMats[1];o.uq.FromQuaternionToRef(t,n),s.multiplyToRef(n,n),this._rotateWithMatrix(n,e,i)}setRotationMatrix(t,e=0,i){if(0===e){const s=r._TmpQuat;return o.PT.FromRotationMatrixToRef(t,s),void this.setRotationQuaternion(s,e,i)}const s=r._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,i))return;const n=r._TmpMats[1];n.copyFrom(t),s.multiplyToRef(t,n),this._rotateWithMatrix(n,e,i)}_rotateWithMatrix(t,e=0,i){const o=this.getLocalMatrix(),s=o.m[12],n=o.m[13],a=o.m[14],l=this.getParent(),h=r._TmpMats[3],u=r._TmpMats[4];l&&1==e?(i?(h.copyFrom(i.getWorldMatrix()),l.getAbsoluteMatrix().multiplyToRef(h,h)):h.copyFrom(l.getAbsoluteMatrix()),u.copyFrom(h),u.invert(),o.multiplyToRef(h,o),o.multiplyToRef(t,o),o.multiplyToRef(u,o)):1==e&&i?(h.copyFrom(i.getWorldMatrix()),u.copyFrom(h),u.invert(),o.multiplyToRef(h,o),o.multiplyToRef(t,o),o.multiplyToRef(u,o)):o.multiplyToRef(t,o),o.setTranslationFromFloats(s,n,a),this.computeAbsoluteMatrices(),this._markAsDirtyAndDecompose()}_getAbsoluteInverseMatrixUnscaledToRef(t,e){const i=r._TmpMats[2];return t.copyFrom(this.getAbsoluteMatrix()),e?(t.multiplyToRef(e.getWorldMatrix(),t),o.uq.ScalingToRef(e.scaling.x,e.scaling.y,e.scaling.z,i)):o.uq.IdentityToRef(i),t.invert(),!isNaN(t.m[0])&&(i.multiplyAtIndex(0,this._scalingDeterminant),t.multiplyToRef(i,t),!0)}getPosition(t=0,e=null){const i=o.Pq.Zero();return this.getPositionToRef(t,e,i),i}getPositionToRef(t=0,e,i){if(0==t){const t=this.getLocalMatrix();i.x=t.m[12],i.y=t.m[13],i.z=t.m[14]}else{let t=null;e&&(t=e.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let o=r._TmpMats[0];e&&t?(o.copyFrom(this.getAbsoluteMatrix()),o.multiplyToRef(t,o)):o=this.getAbsoluteMatrix(),i.x=o.m[12],i.y=o.m[13],i.z=o.m[14]}}getAbsolutePosition(t=null){const e=o.Pq.Zero();return this.getPositionToRef(1,t,e),e}getAbsolutePositionToRef(t,e){this.getPositionToRef(1,t,e)}computeAbsoluteMatrices(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteMatrix,this._absoluteMatrix);else{this._absoluteMatrix.copyFrom(this._localMatrix);const t=this._skeleton.getPoseMatrix();t&&this._absoluteMatrix.multiplyToRef(t,this._absoluteMatrix)}const t=this.children,e=t.length;for(let i=0;i<e;i++)t[i].computeAbsoluteMatrices()}computeAbsoluteTransforms(){this.computeAbsoluteMatrices()}getDirection(t,e=null){const i=o.Pq.Zero();return this.getDirectionToRef(t,e,i),i}getDirectionToRef(t,e=null,i){let s=null;e&&(s=e.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const n=r._TmpMats[0];n.copyFrom(this.getAbsoluteMatrix()),e&&s&&n.multiplyToRef(s,n),o.Pq.TransformNormalToRef(t,n,i),i.normalize()}getRotation(t=0,e=null){const i=o.Pq.Zero();return this.getRotationToRef(t,e,i),i}getRotationToRef(t=0,e=null,i){const o=r._TmpQuat;this.getRotationQuaternionToRef(t,e,o),o.toEulerAnglesToRef(i)}getRotationQuaternion(t=0,e=null){const i=o.PT.Identity();return this.getRotationQuaternionToRef(t,e,i),i}getRotationQuaternionToRef(t=0,e=null,i){if(0==t)this._decompose(),i.copyFrom(this._localRotation);else{const t=r._TmpMats[0],o=this.getAbsoluteMatrix();e?o.multiplyToRef(e.getWorldMatrix(),t):t.copyFrom(o),t.multiplyAtIndex(0,this._scalingDeterminant),t.multiplyAtIndex(1,this._scalingDeterminant),t.multiplyAtIndex(2,this._scalingDeterminant),t.decompose(void 0,i,void 0)}}getRotationMatrix(t=0,e){const i=o.uq.Identity();return this.getRotationMatrixToRef(t,e,i),i}getRotationMatrixToRef(t=0,e,i){if(0==t)this.getLocalMatrix().getRotationMatrixToRef(i);else{const t=r._TmpMats[0],o=this.getAbsoluteMatrix();e?o.multiplyToRef(e.getWorldMatrix(),t):t.copyFrom(o),t.multiplyAtIndex(0,this._scalingDeterminant),t.multiplyAtIndex(1,this._scalingDeterminant),t.multiplyAtIndex(2,this._scalingDeterminant),t.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(t,e=null){const i=o.Pq.Zero();return this.getAbsolutePositionFromLocalToRef(t,e,i),i}getAbsolutePositionFromLocalToRef(t,e=null,i){let s=null;e&&(s=e.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const n=r._TmpMats[0];n.copyFrom(this.getAbsoluteMatrix()),e&&s&&n.multiplyToRef(s,n),o.Pq.TransformCoordinatesToRef(t,n,i)}getLocalPositionFromAbsolute(t,e=null){const i=o.Pq.Zero();return this.getLocalPositionFromAbsoluteToRef(t,e,i),i}getLocalPositionFromAbsoluteToRef(t,e=null,i){let s=null;e&&(s=e.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const n=r._TmpMats[0];n.copyFrom(this.getAbsoluteMatrix()),e&&s&&n.multiplyToRef(s,n),n.invert(),o.Pq.TransformCoordinatesToRef(t,n,i)}setCurrentPoseAsRest(){this.setRestMatrix(this.getLocalMatrix())}dispose(){this._linkedTransformNode=null;const t=this._skeleton.bones.indexOf(this);if(-1!==t&&this._skeleton.bones.splice(t,1),this._parentNode&&this._parentNode.children){const t=this._parentNode.children,e=t.indexOf(this);-1!==e&&t.splice(e,1)}super.dispose()}}r._TmpVecs=(0,s.mI)(2,o.Pq.Zero),r._TmpQuat=o.PT.Identity(),r._TmpMats=(0,s.mI)(5,o.uq.Identity)}}]);