"use strict";(self.webpackChunkeverything_viewer=self.webpackChunkeverything_viewer||[]).push([[8556],{98556:(e,t,s)=>{s.d(t,{l2:()=>ce,GLTFFileLoader:()=>ie,BT:()=>ue,dM:()=>de});var n=s(39018),i=s(14037),o=s(26041),r=s(998),a=s(30388),l=s(75524),h=s(79259),c=s(12333),d=s(22002),u=s(24146);class _{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}attachControl(e){e=r.S0.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const s=t.event;if(!s.metaKey)if(t.type===u.TB.KEYDOWN){if(-1!==this.keysUp.indexOf(s.keyCode)||-1!==this.keysDown.indexOf(s.keyCode)||-1!==this.keysLeft.indexOf(s.keyCode)||-1!==this.keysRight.indexOf(s.keyCode)||-1!==this.keysUpward.indexOf(s.keyCode)||-1!==this.keysDownward.indexOf(s.keyCode)||-1!==this.keysRotateLeft.indexOf(s.keyCode)||-1!==this.keysRotateRight.indexOf(s.keyCode)||-1!==this.keysRotateUp.indexOf(s.keyCode)||-1!==this.keysRotateDown.indexOf(s.keyCode)){-1===this._keys.indexOf(s.keyCode)&&this._keys.push(s.keyCode),e||s.preventDefault()}}else if(-1!==this.keysUp.indexOf(s.keyCode)||-1!==this.keysDown.indexOf(s.keyCode)||-1!==this.keysLeft.indexOf(s.keyCode)||-1!==this.keysRight.indexOf(s.keyCode)||-1!==this.keysUpward.indexOf(s.keyCode)||-1!==this.keysDownward.indexOf(s.keyCode)||-1!==this.keysRotateLeft.indexOf(s.keyCode)||-1!==this.keysRotateRight.indexOf(s.keyCode)||-1!==this.keysRotateUp.indexOf(s.keyCode)||-1!==this.keysRotateDown.indexOf(s.keyCode)){const t=this._keys.indexOf(s.keyCode);t>=0&&this._keys.splice(t,1),e||s.preventDefault()}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const s=this._keys[t],n=e._computeLocalCameraSpeed();-1!==this.keysLeft.indexOf(s)?e._localDirection.copyFromFloats(-n,0,0):-1!==this.keysUp.indexOf(s)?e._localDirection.copyFromFloats(0,0,n):-1!==this.keysRight.indexOf(s)?e._localDirection.copyFromFloats(n,0,0):-1!==this.keysDown.indexOf(s)?e._localDirection.copyFromFloats(0,0,-n):-1!==this.keysUpward.indexOf(s)?e._localDirection.copyFromFloats(0,n,0):-1!==this.keysDownward.indexOf(s)?e._localDirection.copyFromFloats(0,-n,0):-1!==this.keysRotateLeft.indexOf(s)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):-1!==this.keysRotateRight.indexOf(s)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):-1!==this.keysRotateUp.indexOf(s)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):-1!==this.keysRotateDown.indexOf(s)&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),i.Pq.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){const e=this.camera._calculateHandednessMultiplier();return this.rotationSpeed*this._engine.getDeltaTime()/1e3*e}}(0,l.Cg)([(0,h.lK)()],_.prototype,"keysUp",void 0),(0,l.Cg)([(0,h.lK)()],_.prototype,"keysUpward",void 0),(0,l.Cg)([(0,h.lK)()],_.prototype,"keysDown",void 0),(0,l.Cg)([(0,h.lK)()],_.prototype,"keysDownward",void 0),(0,l.Cg)([(0,h.lK)()],_.prototype,"keysLeft",void 0),(0,l.Cg)([(0,h.lK)()],_.prototype,"keysRight",void 0),(0,l.Cg)([(0,h.lK)()],_.prototype,"rotationSpeed",void 0),(0,l.Cg)([(0,h.lK)()],_.prototype,"keysRotateLeft",void 0),(0,l.Cg)([(0,h.lK)()],_.prototype,"keysRotateRight",void 0),(0,l.Cg)([(0,h.lK)()],_.prototype,"keysRotateUp",void 0),(0,l.Cg)([(0,h.lK)()],_.prototype,"keysRotateDown",void 0),d.H.FreeCameraKeyboardMoveInput=_;var p=s(99848),y=s(66240);class f{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new p.cP,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=r.S0.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),s=t.getInputElement();this._pointerInput||(this._pointerInput=n=>{const i=n.event,o="touch"===i.pointerType;if(!this.touchEnabled&&o)return;if(n.type!==y.Zp.POINTERMOVE&&-1===this.buttons.indexOf(i.button))return;const r=i.target;if(n.type===y.Zp.POINTERDOWN){if(o&&-1!==this._activePointerId||!o&&-1!==this._currentActiveButton)return;this._activePointerId=i.pointerId;try{r?.setPointerCapture(i.pointerId)}catch(e){}-1===this._currentActiveButton&&(this._currentActiveButton=i.button),this._previousPosition={x:i.clientX,y:i.clientY},e||(i.preventDefault(),s&&s.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(n.event)}else if(n.type===y.Zp.POINTERUP){if(o&&this._activePointerId!==i.pointerId||!o&&this._currentActiveButton!==i.button)return;try{r?.releasePointerCapture(i.pointerId)}catch(e){}this._currentActiveButton=-1,this._previousPosition=null,e||i.preventDefault(),this._activePointerId=-1}else if(n.type===y.Zp.POINTERMOVE&&(this._activePointerId===i.pointerId||!o))if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(n.event);else if(this._previousPosition){const t=this.camera._calculateHandednessMultiplier(),s=(i.clientX-this._previousPosition.x)*t,n=i.clientY-this._previousPosition.y;this._allowCameraRotation&&(this.camera.cameraRotation.y+=s/this.angularSensibility,this.camera.cameraRotation.x+=n/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:s,offsetY:n}),this._previousPosition={x:i.clientX,y:i.clientY},e||i.preventDefault()}}),this._onMouseMove=s=>{if(!t.isPointerLock)return;const n=this.camera._calculateHandednessMultiplier(),i=s.movementX*n;this.camera.cameraRotation.y+=i/this.angularSensibility;const o=s.movementY;this.camera.cameraRotation.x+=o/this.angularSensibility,this._previousPosition=null,e||s.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,y.Zp.POINTERDOWN|y.Zp.POINTERUP|y.Zp.POINTERMOVE),s&&(this._contextMenuBind=e=>this.onContextMenu(e),s.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){const e=this.camera.getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._activePointerId=-1,this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}}(0,l.Cg)([(0,h.lK)()],f.prototype,"buttons",void 0),(0,l.Cg)([(0,h.lK)()],f.prototype,"angularSensibility",void 0),d.H.FreeCameraMouseInput=f;var g,m=s(38123);class b{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new p.cP,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=r.S0.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==y.Zp.POINTERWHEEL)return;const s=t.event,n=s.deltaMode===m.s.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*n*s.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*n*s.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*n*s.deltaZ/this._normalize,s.preventDefault&&(e||s.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,y.Zp.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}(0,l.Cg)([(0,h.lK)()],b.prototype,"wheelPrecisionX",void 0),(0,l.Cg)([(0,h.lK)()],b.prototype,"wheelPrecisionY",void 0),(0,l.Cg)([(0,h.lK)()],b.prototype,"wheelPrecisionZ",void 0),function(e){e[e.MoveRelative=0]="MoveRelative",e[e.RotateRelative=1]="RotateRelative",e[e.MoveScene=2]="MoveScene"}(g||(g={}));class v extends b{constructor(){super(...arguments),this._moveRelative=i.Pq.Zero(),this._rotateRelative=i.Pq.Zero(),this._moveScene=i.Pq.Zero(),this._wheelXAction=g.MoveRelative,this._wheelXActionCoordinate=0,this._wheelYAction=g.MoveRelative,this._wheelYActionCoordinate=2,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){null===e&&this._wheelXAction!==g.MoveRelative||(this._wheelXAction=g.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==g.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){null===e&&this._wheelYAction!==g.MoveRelative||(this._wheelYAction=g.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==g.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){null===e&&this._wheelZAction!==g.MoveRelative||(this._wheelZAction=g.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==g.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){null===e&&this._wheelXAction!==g.RotateRelative||(this._wheelXAction=g.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==g.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){null===e&&this._wheelYAction!==g.RotateRelative||(this._wheelYAction=g.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==g.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){null===e&&this._wheelZAction!==g.RotateRelative||(this._wheelZAction=g.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==g.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){null===e&&this._wheelXAction!==g.MoveScene||(this._wheelXAction=g.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==g.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){null===e&&this._wheelYAction!==g.MoveScene||(this._wheelYAction=g.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==g.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){null===e&&this._wheelZAction!==g.MoveScene||(this._wheelZAction=g.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==g.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(0===this._wheelDeltaX&&0===this._wheelDeltaY&&0==this._wheelDeltaZ)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const e=i.uq.Zero();this.camera.getViewMatrix().invertToRef(e);const t=i.Pq.Zero();i.Pq.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,s){if(0===e)return;if(null===t||null===s)return;let n=null;switch(t){case g.MoveRelative:n=this._moveRelative;break;case g.RotateRelative:n=this._rotateRelative;break;case g.MoveScene:n=this._moveScene}switch(s){case 0:n.set(e,0,0);break;case 1:n.set(0,e,0);break;case 2:n.set(0,0,e)}}}(0,l.Cg)([(0,h.lK)()],v.prototype,"wheelXMoveRelative",null),(0,l.Cg)([(0,h.lK)()],v.prototype,"wheelYMoveRelative",null),(0,l.Cg)([(0,h.lK)()],v.prototype,"wheelZMoveRelative",null),(0,l.Cg)([(0,h.lK)()],v.prototype,"wheelXRotateRelative",null),(0,l.Cg)([(0,h.lK)()],v.prototype,"wheelYRotateRelative",null),(0,l.Cg)([(0,h.lK)()],v.prototype,"wheelZRotateRelative",null),(0,l.Cg)([(0,h.lK)()],v.prototype,"wheelXMoveScene",null),(0,l.Cg)([(0,h.lK)()],v.prototype,"wheelYMoveScene",null),(0,l.Cg)([(0,h.lK)()],v.prototype,"wheelZMoveScene",null),d.H.FreeCameraMouseWheelInput=v;class A{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=r.S0.IsSafari()}attachControl(e){e=r.S0.BackCompatCameraNoPreventDefault(arguments);let t=null;if(void 0===this._pointerInput&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=s=>{const n=s.event,i="mouse"===n.pointerType||this._isSafari&&void 0===n.pointerType;if(this.allowMouse||!i)if(s.type===y.Zp.POINTERDOWN){if(e||n.preventDefault(),this._pointerPressed.push(n.pointerId),1!==this._pointerPressed.length)return;t={x:n.clientX,y:n.clientY}}else if(s.type===y.Zp.POINTERUP){e||n.preventDefault();const s=this._pointerPressed.indexOf(n.pointerId);if(-1===s)return;if(this._pointerPressed.splice(s,1),0!=s)return;t=null,this._offsetX=null,this._offsetY=null}else if(s.type===y.Zp.POINTERMOVE){if(e||n.preventDefault(),!t)return;if(0!=this._pointerPressed.indexOf(n.pointerId))return;this._offsetX=n.clientX-t.x,this._offsetY=-(n.clientY-t.y)}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,y.Zp.POINTERDOWN|y.Zp.POINTERUP|y.Zp.POINTERMOVE),this._onLostFocus){const e=this.camera.getEngine().getInputElement();e&&e.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){const e=this.camera.getEngine().getInputElement();e&&e.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(null===this._offsetX||null===this._offsetY)return;if(0===this._offsetX&&0===this._offsetY)return;const e=this.camera,t=e._calculateHandednessMultiplier();e.cameraRotation.y=t*this._offsetX/this.touchAngularSensibility;if(this.singleFingerRotate&&1===this._pointerPressed.length||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{const t=e._computeLocalCameraSpeed(),s=new i.Pq(0,0,0!==this.touchMoveSensibility?t*this._offsetY/this.touchMoveSensibility:0);i.uq.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(i.Pq.TransformCoordinates(s,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}}(0,l.Cg)([(0,h.lK)()],A.prototype,"touchAngularSensibility",void 0),(0,l.Cg)([(0,h.lK)()],A.prototype,"touchMoveSensibility",void 0),d.H.FreeCameraTouchInput=A;class x extends d._{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new _),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new f(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new v,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new A),this}clear(){super.clear(),this._mouseInput=null}}var C=s(56552),w=s(59931);class M extends c.F{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){const e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){const t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){const e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){const t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){const e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){const e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}get keysRotateUp(){const e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e)}get keysRotateDown(){const e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e)}constructor(e,t,s,n=!0){super(e,t,s,n),this.ellipsoid=new i.Pq(.5,1,.5),this.ellipsoidOffset=new i.Pq(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=i.Pq.Zero(),this._diffPosition=i.Pq.Zero(),this._newPosition=i.Pq.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(e,t,s=null)=>{this._newPosition.copyFrom(t),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>w.$.CollisionsEpsilon&&(this.position.addToRef(this._diffPosition,this._deferredPositionUpdate),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate),this.onCollide&&s&&this.onCollide(s))},this.inputs=new x(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=r.S0.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new i.Pq(0,0,0),this.cameraRotation=new i.I9(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;t=this.parent?i.Pq.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const s=this.getScene().collisionCoordinator;this._collider||(this._collider=s.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let n=e;this.applyGravity&&(n=e.add(this.getScene().gravity)),s.getNewPosition(this._oldPosition,n,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=i.Pq.Zero(),this._transformedDirection=i.Pq.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}}(0,l.Cg)([(0,h.P_)()],M.prototype,"ellipsoid",void 0),(0,l.Cg)([(0,h.P_)()],M.prototype,"ellipsoidOffset",void 0),(0,l.Cg)([(0,h.lK)()],M.prototype,"checkCollisions",void 0),(0,l.Cg)([(0,h.lK)()],M.prototype,"applyGravity",void 0),(0,C.Y5)("BABYLON.FreeCamera",M);var T=s(36504),R=s(15397),O=s(28986),P=s(23975),S=s(82781),E=s(97328),k=s(95616),L=s(27050),I=s(50861),$=s(85530),D=s(6315),N=s(26877);class V{get influence(){return this._influence}set influence(e){if(this._influence===e)return;const t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(0===t||0===e)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,t=0,s=null){this.name=e,this.animations=[],this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uv2s=null,this._colors=null,this._uniqueId=0,this.onInfluenceChanged=new p.cP,this._onDataLayoutChanged=new p.cP,this._animationPropertiesOverride=null,this.id=e,this._scene=s||D.q.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}get hasUV2s(){return!!this._uv2s}get hasColors(){return!!this._colors}get vertexCount(){return this._positions?this._positions.length/3:this._normals?this._normals.length/3:this._tangents?this._tangents.length/3:this._uvs?this._uvs.length/2:this._uv2s?this._uv2s.length/2:this._colors?this._colors.length/4:0}setPositions(e){const t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){const t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){const t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){const t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}setUV2s(e){const t=this.hasUV2s;this._uv2s=e,t!==this.hasUV2s&&this._onDataLayoutChanged.notifyObservers(void 0)}getUV2s(){return this._uv2s}setColors(e){const t=this.hasColors;this._colors=e,t!==this.hasColors&&this._onDataLayoutChanged.notifyObservers(void 0)}getColors(){return this._colors}clone(){const e=N.p.Clone(()=>new V(this.name,this.influence,this._scene),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e._uv2s=this._uv2s,e._colors=this._colors,e}serialize(){const e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),null!=this.id&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),this.hasUV2s&&(e.uv2s=Array.prototype.slice.call(this.getUV2s())),this.hasColors&&(e.colors=Array.prototype.slice.call(this.getColors())),N.p.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){const s=new V(e.name,e.influence);if(s.setPositions(e.positions),null!=e.id&&(s.id=e.id),e.normals&&s.setNormals(e.normals),e.tangents&&s.setTangents(e.tangents),e.uvs&&s.setUVs(e.uvs),e.uv2s&&s.setUV2s(e.uv2s),e.colors&&s.setColors(e.colors),e.animations){for(let t=0;t<e.animations.length;t++){const n=e.animations[t],i=(0,C.n9)("BABYLON.Animation");i&&s.animations.push(i.Parse(n))}e.autoAnimate&&t&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return s}static FromMesh(e,t,s){t||(t=e.name);const n=new V(t,s,e.getScene());return n.setPositions(e.getVerticesData(k.R.PositionKind)),e.isVerticesDataPresent(k.R.NormalKind)&&n.setNormals(e.getVerticesData(k.R.NormalKind)),e.isVerticesDataPresent(k.R.TangentKind)&&n.setTangents(e.getVerticesData(k.R.TangentKind)),e.isVerticesDataPresent(k.R.UVKind)&&n.setUVs(e.getVerticesData(k.R.UVKind)),e.isVerticesDataPresent(k.R.UV2Kind)&&n.setUV2s(e.getVerticesData(k.R.UV2Kind)),e.isVerticesDataPresent(k.R.ColorKind)&&n.setColors(e.getVerticesData(k.R.ColorKind)),n}}(0,l.Cg)([(0,h.lK)()],V.prototype,"id",void 0);var U=s(17931),F=s(51137);class B extends S.g{get depth(){return this._depth}constructor(e,t,s,n,i,o,r=!0,a=!1,l=S.g.TRILINEAR_SAMPLINGMODE,h=0,c){super(null,o,!r,a),this.format=i,this._texture=o.getEngine().createRawTexture2DArray(e,t,s,n,i,r,a,l,null,h,c),this._depth=n,this.is2DArray=!0}update(e){this._texture&&this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,s,n,i,o=!0,r=!1,a=3,l=0){return new B(e,t,s,n,5,i,o,r,a,l)}}class G{set areUpdatesFrozen(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(this._forceUpdateWhenUnfrozen),this._forceUpdateWhenUnfrozen=!1))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(e=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new U.L(16),this._supportsPositions=!1,this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._supportsUV2s=!1,this._supportsColors=!1,this._vertexCount=0,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._mustSynchronize=!0,this._forceUpdateWhenUnfrozen=!1,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._parentContainer=null,this.optimizeInfluencers=!0,this.enablePositionMorphing=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this.enableUV2Morphing=!0,this.enableColorMorphing=!0,this._numMaxInfluencers=0,this._useTextureToStoreTargets=!0,e||(e=D.q.LastCreatedScene),this._scene=e,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();const e=this._scene.getEngine().getCaps();this._canUseTextureForTargets=e.canUseGLVertexID&&e.textureFloat&&e.maxVertexTextureImageUnits>0&&e.texture2DArrayMaxLayerCount>1}}get numMaxInfluencers(){return G.ConstantTargetCountForTextureMode>0&&this.isUsingTextureForTargets?G.ConstantTargetCountForTextureMode:this._numMaxInfluencers}set numMaxInfluencers(e){this._numMaxInfluencers!==e&&(this._numMaxInfluencers=e,this._mustSynchronize=!0,this._syncActiveTargets())}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsPositions(){return this._supportsPositions&&this.enablePositionMorphing}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get supportsUV2s(){return this._supportsUV2s&&this.enableUV2Morphing}get supportsColors(){return this._supportsColors&&this.enableColorMorphing}get hasPositions(){return this._supportsPositions}get hasNormals(){return this._supportsNormals}get hasTangents(){return this._supportsTangents}get hasUVs(){return this._supportsUVs}get hasUV2s(){return this._supportsUV2s}get hasColors(){return this._supportsColors}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(e){this._useTextureToStoreTargets!==e&&(this._useTextureToStoreTargets=e,this._mustSynchronize=!0,this._syncActiveTargets())}get isUsingTextureForTargets(){return G.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!this._scene?.getEngine().getCaps().disableMorphTargetTexture}getActiveTarget(e){return this._activeTargets.data[e]}getTarget(e){return this._targets[e]}getTargetByName(e){for(const t of this._targets)if(t.name===e)return t;return null}addTarget(e){this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add(e=>{this.areUpdatesFrozen&&e&&(this._forceUpdateWhenUnfrozen=!0),this._syncActiveTargets(e)})),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add(()=>{this._mustSynchronize=!0,this._syncActiveTargets()})),this._mustSynchronize=!0,this._syncActiveTargets()}removeTarget(e){const t=this._targets.indexOf(e);t>=0&&(this._targets.splice(t,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(t,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(t,1)[0]),this._mustSynchronize=!0,this._syncActiveTargets()),this._scene&&this._scene.stopAnimation(e)}_bind(e){e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture),e.setFloat("morphTargetCount",this.numInfluencers)}clone(){const e=new G(this._scene);e.areUpdatesFrozen=!0;for(const t of this._targets)e.addTarget(t.clone());return e.areUpdatesFrozen=!1,e.enablePositionMorphing=this.enablePositionMorphing,e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e.enableUV2Morphing=this.enableUV2Morphing,e.enableColorMorphing=this.enableColorMorphing,e}serialize(){const e={};e.id=this.uniqueId,e.targets=[];for(const t of this._targets)e.targets.push(t.serialize());return e}_syncActiveTargets(e=!1){if(this.areUpdatesFrozen)return;const t=!!this._targetStoreTexture,s=this.isUsingTextureForTargets;(this._mustSynchronize||t!==s)&&(this._mustSynchronize=!1,this.synchronize());let n=0;this._activeTargets.reset(),this._morphTargetTextureIndices&&this._morphTargetTextureIndices.length===this._targets.length||(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let i=-1;for(const e of this._targets)if(i++,0!==e.influence||!this.optimizeInfluencers){if(this._activeTargets.length>=G.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(e),this._morphTargetTextureIndices[n]=i,this._tempInfluences[n++]=e.influence}this._morphTargetTextureIndices.length!==n&&(this._morphTargetTextureIndices=this._morphTargetTextureIndices.slice(0,n)),this._influences&&this._influences.length===n||(this._influences=new Float32Array(n));for(let e=0;e<n;e++)this._influences[e]=this._tempInfluences[e];if(e&&this._scene)for(const e of this._scene.meshes)e.morphTargetManager===this&&(s?e._markSubMeshesAsAttributesDirty():e._syncGeometryWithMorphTargetManager())}synchronize(){if(!this._scene||this.areUpdatesFrozen)return;const e=this._scene.getEngine();this._supportsPositions=!0,this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._supportsUV2s=!0,this._supportsColors=!0,this._vertexCount=0,this._targetStoreTexture?.dispose(),this._targetStoreTexture=null,this.isUsingTextureForTargets&&this._targets.length>e.getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1);for(const e of this._targets){this._supportsPositions=this._supportsPositions&&e.hasPositions,this._supportsNormals=this._supportsNormals&&e.hasNormals,this._supportsTangents=this._supportsTangents&&e.hasTangents,this._supportsUVs=this._supportsUVs&&e.hasUVs,this._supportsUV2s=this._supportsUV2s&&e.hasUV2s,this._supportsColors=this._supportsColors&&e.hasColors;const t=e.vertexCount;if(0===this._vertexCount)this._vertexCount=t;else if(this._vertexCount!==t)return void F.V.Error(`Incompatible target. Targets must all have the same vertices count. Current vertex count: ${this._vertexCount}, vertex count for target "${e.name}": ${t}`)}if(this.isUsingTextureForTargets){this._textureVertexStride=0,this._supportsPositions&&this._textureVertexStride++,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._supportsUV2s&&this._textureVertexStride++,this._supportsColors&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride||1,this._textureHeight=1;const t=e.getCaps().maxTextureSize;this._textureWidth>t&&(this._textureHeight=Math.ceil(this._textureWidth/t),this._textureWidth=t);const s=this._targets.length,n=new Float32Array(s*this._textureWidth*this._textureHeight*4);let i=0;for(let e=0;e<s;e++){const t=this._targets[e],s=t.getPositions(),o=t.getNormals(),r=t.getUVs(),a=t.getTangents(),l=t.getUV2s(),h=t.getColors();i=e*this._textureWidth*this._textureHeight*4;for(let e=0;e<this._vertexCount;e++)this._supportsPositions&&s&&(n[i]=s[3*e],n[i+1]=s[3*e+1],n[i+2]=s[3*e+2],i+=4),this._supportsNormals&&o&&(n[i]=o[3*e],n[i+1]=o[3*e+1],n[i+2]=o[3*e+2],i+=4),this._supportsUVs&&r&&(n[i]=r[2*e],n[i+1]=r[2*e+1],i+=4),this._supportsTangents&&a&&(n[i]=a[3*e],n[i+1]=a[3*e+1],n[i+2]=a[3*e+2],i+=4),this._supportsUV2s&&l&&(n[i]=l[2*e],n[i+1]=l[2*e+1],i+=4),this._supportsColors&&h&&(n[i]=h[4*e],n[i+1]=h[4*e+1],n[i+2]=h[4*e+2],n[i+3]=h[4*e+3],i+=4)}this._targetStoreTexture=B.CreateRGBATexture(n,this._textureWidth,this._textureHeight,s,this._scene,!1,!1,1,1),this._targetStoreTexture.name=`Morph texture_${this.uniqueId}`}for(const e of this._scene.meshes)e.morphTargetManager===this&&e._syncGeometryWithMorphTargetManager()}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){const e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null}for(const e of this._targets)this._scene.stopAnimation(e)}}static Parse(e,t){const s=new G(t);for(const n of e.targets)s.addTarget(V.Parse(n,t));return s}}G.EnableTextureStorage=!0,G.MaxActiveMorphTargetsInVertexAttributeMode=8,G.ConstantTargetCountForTextureMode=0;var K=s(15909),Y=s(97762),q=s(36181);class W{constructor(e){this.byteOffset=0,this.buffer=e}async loadAsync(e){const t=await this.buffer.readAsync(this.byteOffset,e);this._dataView=new DataView(t.buffer,t.byteOffset,t.byteLength),this._dataByteOffset=0}readUint32(){const e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,e}readUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,t}readString(e){return(0,q.Tq)(this.readUint8Array(e))}skipBytes(e){this._dataByteOffset+=e,this.byteOffset+=e}}function Z(e,t,s,n){const i={externalResourceFunction:n};return s&&(i.uri="file:"===t?s:t+s),ArrayBuffer.isView(e)?GLTFValidator.validateBytes(e,i):GLTFValidator.validateString(e,i)}function X(){const e=[];onmessage=t=>{const s=t.data;switch(s.id){case"init":importScripts(s.url);break;case"validate":Z(s.data,s.rootUrl,s.fileName,t=>new Promise((s,n)=>{const i=e.length;e.push({resolve:s,reject:n}),postMessage({id:"getExternalResource",index:i,uri:t})})).then(e=>{postMessage({id:"validate.resolve",value:e})},e=>{postMessage({id:"validate.reject",reason:e})});break;case"getExternalResource.resolve":e[s.index].resolve(s.value);break;case"getExternalResource.reject":e[s.index].reject(s.reason)}}}class z{static ValidateAsync(e,t,s,n){return"function"==typeof Worker?new Promise((i,o)=>{const a=`${Z}(${X})()`,l=URL.createObjectURL(new Blob([a],{type:"application/javascript"})),h=new Worker(l),c=e=>{h.removeEventListener("error",c),h.removeEventListener("message",d),o(e)},d=e=>{const t=e.data;switch(t.id){case"getExternalResource":n(t.uri).then(e=>{h.postMessage({id:"getExternalResource.resolve",index:t.index,value:e},[e.buffer])},e=>{h.postMessage({id:"getExternalResource.reject",index:t.index,reason:e})});break;case"validate.resolve":h.removeEventListener("error",c),h.removeEventListener("message",d),i(t.value),h.terminate();break;case"validate.reject":h.removeEventListener("error",c),h.removeEventListener("message",d),o(t.reason),h.terminate()}};if(h.addEventListener("error",c),h.addEventListener("message",d),h.postMessage({id:"init",url:r.S0.GetBabylonScriptURL(this.Configuration.url)}),ArrayBuffer.isView(e)){const n=e.slice();h.postMessage({id:"validate",data:n,rootUrl:t,fileName:s},[n.buffer])}else h.postMessage({id:"validate",data:e,rootUrl:t,fileName:s})}):(this._LoadScriptPromise||(this._LoadScriptPromise=r.S0.LoadBabylonScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(()=>Z(e,t,s,n)))}}z.Configuration={url:`${r.S0._DefaultCdnUrl}/gltf_validator.js`};var H,j,J,Q=s(2972),ee=s(90655),te=s(88563);function se(e,t,s){try{return Promise.resolve(new Uint8Array(e,t,s))}catch(e){return Promise.reject(e)}}!function(e){e[e.AUTO=0]="AUTO",e[e.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"}(H||(H={})),function(e){e[e.NONE=0]="NONE",e[e.FIRST=1]="FIRST",e[e.ALL=2]="ALL"}(j||(j={})),function(e){e[e.LOADING=0]="LOADING",e[e.READY=1]="READY",e[e.COMPLETE=2]="COMPLETE"}(J||(J={}));class ne{constructor(){this.coordinateSystemMode=H.AUTO,this.animationStartMode=j.FIRST,this.loadNodeAnimations=!0,this.loadSkins=!0,this.loadMorphTargets=!0,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.loadOnlyMaterials=!1,this.skipMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.useGltfTextureNames=!1,this.preprocessUrlAsync=e=>Promise.resolve(e),this.extensionOptions={}}copyFrom(e){e&&(this.onParsed=e.onParsed,this.coordinateSystemMode=e.coordinateSystemMode??this.coordinateSystemMode,this.animationStartMode=e.animationStartMode??this.animationStartMode,this.loadNodeAnimations=e.loadNodeAnimations??this.loadNodeAnimations,this.loadSkins=e.loadSkins??this.loadSkins,this.loadMorphTargets=e.loadMorphTargets??this.loadMorphTargets,this.compileMaterials=e.compileMaterials??this.compileMaterials,this.useClipPlane=e.useClipPlane??this.useClipPlane,this.compileShadowGenerators=e.compileShadowGenerators??this.compileShadowGenerators,this.transparencyAsCoverage=e.transparencyAsCoverage??this.transparencyAsCoverage,this.useRangeRequests=e.useRangeRequests??this.useRangeRequests,this.createInstances=e.createInstances??this.createInstances,this.alwaysComputeBoundingBox=e.alwaysComputeBoundingBox??this.alwaysComputeBoundingBox,this.loadAllMaterials=e.loadAllMaterials??this.loadAllMaterials,this.loadOnlyMaterials=e.loadOnlyMaterials??this.loadOnlyMaterials,this.skipMaterials=e.skipMaterials??this.skipMaterials,this.useSRGBBuffers=e.useSRGBBuffers??this.useSRGBBuffers,this.targetFps=e.targetFps??this.targetFps,this.alwaysComputeSkeletonRootNode=e.alwaysComputeSkeletonRootNode??this.alwaysComputeSkeletonRootNode,this.useGltfTextureNames=e.useGltfTextureNames??this.useGltfTextureNames,this.preprocessUrlAsync=e.preprocessUrlAsync??this.preprocessUrlAsync,this.customRootNode=e.customRootNode,this.onMeshLoaded=e.onMeshLoaded,this.onSkinLoaded=e.onSkinLoaded,this.onTextureLoaded=e.onTextureLoaded,this.onMaterialLoaded=e.onMaterialLoaded,this.onCameraLoaded=e.onCameraLoaded,this.extensionOptions=e.extensionOptions??this.extensionOptions)}}class ie extends ne{constructor(e){super(),this.onParsedObservable=new p.cP,this.onMeshLoadedObservable=new p.cP,this.onSkinLoadedObservable=new p.cP,this.onTextureLoadedObservable=new p.cP,this.onMaterialLoadedObservable=new p.cP,this.onCameraLoadedObservable=new p.cP,this.onCompleteObservable=new p.cP,this.onErrorObservable=new p.cP,this.onDisposeObservable=new p.cP,this.onExtensionLoadedObservable=new p.cP,this.validate=!1,this.onValidatedObservable=new p.cP,this._loader=null,this._state=null,this._requests=new Array,this.name=Q._.name,this.extensions=Q._.extensions,this.onLoaderStateChangedObservable=new p.cP,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled,this.copyFrom(e)}set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),e&&(this._onParsedObserver=this.onParsedObservable.add(e))}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),e&&(this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e))}set onSkinLoaded(e){this._onSkinLoadedObserver&&this.onSkinLoadedObservable.remove(this._onSkinLoadedObserver),e&&(this._onSkinLoadedObserver=this.onSkinLoadedObservable.add(t=>e(t.node,t.skinnedNode)))}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),e&&(this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e))}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),e&&(this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e))}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),e&&(this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e))}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const e of this._requests)e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(e,t,s,n,i,o,a,l){if(ArrayBuffer.isView(t))return this._loadBinary(e,t,s,n,a,l),null;this._progressCallback=i;const h=t.name||r.S0.GetFilename(t);if(o){if(this.useRangeRequests){this.validate&&F.V.Warn("glTF validation is not supported when range requests are enabled");const s={abort:()=>{},onCompleteObservable:new p.cP},i={readAsync:(s,n)=>new Promise((i,o)=>{this._loadFile(e,t,e=>{i(new Uint8Array(e))},!0,e=>{o(e)},e=>{e.setRequestHeader("Range",`bytes=${s}-${s+n-1}`)})}),byteLength:0};return this._unpackBinaryAsync(new W(i)).then(e=>{s.onCompleteObservable.notifyObservers(s),n(e)},a?e=>a(void 0,e):void 0),s}return this._loadFile(e,t,t=>{this._validate(e,new Uint8Array(t,0,t.byteLength),s,h),this._unpackBinaryAsync(new W({readAsync:(e,s)=>se(t,e,s),byteLength:t.byteLength})).then(e=>{n(e)},a?e=>a(void 0,e):void 0)},!0,a)}return this._loadFile(e,t,t=>{try{this._validate(e,t,s,h),n({json:this._parseJson(t)})}catch{a&&a()}},!1,a)}_loadBinary(e,t,s,n,i,o){this._validate(e,new Uint8Array(t.buffer,t.byteOffset,t.byteLength),s,o),this._unpackBinaryAsync(new W({readAsync:(e,s)=>function(e,t,s){try{if(t<0||t>=e.byteLength)throw new RangeError("Offset is out of range.");if(t+s>e.byteLength)throw new RangeError("Length is out of range.");return Promise.resolve(new Uint8Array(e.buffer,e.byteOffset+t,s))}catch(e){return Promise.reject(e)}}(t,e,s),byteLength:t.byteLength})).then(e=>{n(e)},i?e=>i(void 0,e):void 0)}importMeshAsync(e,t,s,n,i,o){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(s),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(s),this._loader.importMeshAsync(e,t,null,s,n,i,o)))}loadAsync(e,t,s,n,i){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${i||""}`),this._loader=this._getLoader(t),this._loader.loadAsync(e,t,s,n,i)))}loadAssetContainerAsync(e,t,s,n,i){return Promise.resolve().then(()=>{this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${i||""}`),this._loader=this._getLoader(t);const o=new Y.WZ(e),r=[];this.onMaterialLoadedObservable.add(e=>{r.push(e)});const a=[];this.onTextureLoadedObservable.add(e=>{a.push(e)});const l=[];this.onCameraLoadedObservable.add(e=>{l.push(e)});const h=[];return this.onMeshLoadedObservable.add(e=>{e.morphTargetManager&&h.push(e.morphTargetManager)}),this._loader.importMeshAsync(null,e,o,t,s,n,i).then(e=>(Array.prototype.push.apply(o.geometries,e.geometries),Array.prototype.push.apply(o.meshes,e.meshes),Array.prototype.push.apply(o.particleSystems,e.particleSystems),Array.prototype.push.apply(o.skeletons,e.skeletons),Array.prototype.push.apply(o.animationGroups,e.animationGroups),Array.prototype.push.apply(o.materials,r),Array.prototype.push.apply(o.textures,a),Array.prototype.push.apply(o.lights,e.lights),Array.prototype.push.apply(o.transformNodes,e.transformNodes),Array.prototype.push.apply(o.cameras,l),Array.prototype.push.apply(o.morphTargetManagers,h),o))})}canDirectLoad(e){return Q._.canDirectLoad(e)}directLoad(e,t){if(t.startsWith("base64,"+Q.i)||t.startsWith(";base64,"+Q.i)||t.startsWith("application/octet-stream;base64,"+Q.i)||t.startsWith("model/gltf-binary;base64,"+Q.i)){const s=(0,ee.rz)(t);return this._validate(e,new Uint8Array(s,0,s.byteLength)),this._unpackBinaryAsync(new W({readAsync:(e,t)=>se(s,e,t),byteLength:s.byteLength}))}return this._validate(e,t),Promise.resolve({json:this._parseJson(t)})}createPlugin(e){return new ie(e[Q._.name])}get loaderState(){return this._state}whenCompleteAsync(){return new Promise((e,t)=>{this.onCompleteObservable.addOnce(()=>{e()}),this.onErrorObservable.addOnce(e=>{t(e)})})}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(J[this._state]))}_loadFile(e,t,s,n,i,o){const r=e._loadFile(t,s,e=>{this._onProgress(e,r)},!0,n,i,o);return r.onCompleteObservable.add(()=>{r._lengthComputable=!0,r._total=r._loaded}),this._requests.push(r),r}_onProgress(e,t){if(!this._progressCallback)return;t._lengthComputable=e.lengthComputable,t._loaded=e.loaded,t._total=e.total;let s=!0,n=0,i=0;for(const e of this._requests){if(void 0===e._lengthComputable||void 0===e._loaded||void 0===e._total)return;s=s&&e._lengthComputable,n+=e._loaded,i+=e._total}this._progressCallback({lengthComputable:s,loaded:n,total:s?i:0})}_validate(e,t,s="",n=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),z.ValidateAsync(t,s,n,t=>this.preprocessUrlAsync(s+t).then(t=>e._loadFileAsync(t,void 0,!0,!0).then(e=>new Uint8Array(e,0,e.byteLength)))).then(e=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(e),this.onValidatedObservable.clear()},e=>{this._endPerformanceCounter("Validate JSON"),r.S0.Warn(`Failed to validate: ${e.message}`),this.onValidatedObservable.clear()}))}_getLoader(e){const t=e.json.asset||{};this._log(`Asset version: ${t.version}`),t.minVersion&&this._log(`Asset minimum version: ${t.minVersion}`),t.generator&&this._log(`Asset generator: ${t.generator}`);const s=ie._parseVersion(t.version);if(!s)throw new Error("Invalid version: "+t.version);if(void 0!==t.minVersion){const e=ie._parseVersion(t.minVersion);if(!e)throw new Error("Invalid minimum version: "+t.minVersion);if(ie._compareVersion(e,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+t.minVersion)}const n={1:ie._CreateGLTF1Loader,2:ie._CreateGLTF2Loader}[s.major];if(!n)throw new Error("Unsupported version: "+t.version);return n(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${e.length}`);const t=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),t}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then(()=>{const t=e.readUint32();if(1179937895!==t)throw new te.bu("Unexpected magic: "+t,te.tG.GLTFLoaderUnexpectedMagicError);const s=e.readUint32();this.loggingEnabled&&this._log(`Binary version: ${s}`);const n=e.readUint32();let i;switch(this.useRangeRequests||n===e.buffer.byteLength||F.V.Warn(`Length in header does not match actual data length: ${n} != ${e.buffer.byteLength}`),s){case 1:i=this._unpackBinaryV1Async(e,n);break;case 2:i=this._unpackBinaryV2Async(e,n);break;default:throw new Error("Unsupported version: "+s)}return this._endPerformanceCounter("Unpack Binary"),i})}_unpackBinaryV1Async(e,t){const s=e.readUint32(),n=e.readUint32();if(0!==n)throw new Error(`Unexpected content format: ${n}`);const i=t-e.byteOffset,o={json:this._parseJson(e.readString(s)),bin:null};if(0!==i){const t=e.byteOffset;o.bin={readAsync:(s,n)=>e.buffer.readAsync(t+s,n),byteLength:i}}return Promise.resolve(o)}_unpackBinaryV2Async(e,t){const s=1313821514,n=5130562,i=e.readUint32();if(e.readUint32()!==s)throw new Error("First chunk format is not JSON");return e.byteOffset+i===t?e.loadAsync(i).then(()=>({json:this._parseJson(e.readString(i)),bin:null})):e.loadAsync(i+8).then(()=>{const o={json:this._parseJson(e.readString(i)),bin:null},r=()=>{const i=e.readUint32();switch(e.readUint32()){case s:throw new Error("Unexpected JSON chunk");case n:{const t=e.byteOffset;o.bin={readAsync:(s,n)=>e.buffer.readAsync(t+s,n),byteLength:i},e.skipBytes(i);break}default:e.skipBytes(i)}return e.byteOffset!==t?e.loadAsync(8).then(r):Promise.resolve(o)};return r()})}static _parseVersion(e){if("1.0"===e||"1.0.1"===e)return{major:1,minor:0};const t=(e+"").match(/^(\d+)\.(\d+)/);return t?{major:parseInt(t[1]),minor:parseInt(t[2])}:null}static _compareVersion(e,t){return e.major>t.major?1:e.major<t.major?-1:e.minor>t.minor?1:e.minor<t.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(e){const t=ie._logSpaces.substring(0,2*this._logIndentLevel);F.V.Log(`${t}${e}`)}_logDisabled(e){}_startPerformanceCounterEnabled(e){r.S0.StartPerformanceCounter(e)}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(e){r.S0.EndPerformanceCounter(e)}_endPerformanceCounterDisabled(e){}}ie.IncrementalLoading=!0,ie.HomogeneousCoordinates=!1,ie._logSpaces="                                ",(0,K.qS)(new ie);var oe=s(42564),re=s(37812),ae=s(49532),le=s(28853),he=s(11675);class ce{static Get(e,t,s){if(!t||null==s||!t[s])throw new Error(`${e}: Failed to find index (${s})`);return t[s]}static TryGet(e,t){return e&&null!=t&&e[t]?e[t]:null}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}}function de(e){if(e.min&&e.max){const t=e.min,s=e.max,n=i.AA.Vector3[0].copyFromFloats(t[0],t[1],t[2]),o=i.AA.Vector3[1].copyFromFloats(s[0],s[1],s[2]);if(e.normalized&&5126!==e.componentType){let t=1;switch(e.componentType){case 5120:t=127;break;case 5121:t=255;break;case 5122:t=32767;break;case 5123:t=65535}const s=1/t;n.scaleInPlace(s),o.scaleInPlace(s)}return new oe.j(n,o)}return null}class ue{static RegisterExtension(e,t){(0,re.Ye)(e,!1,t)}static UnregisterExtension(e){return(0,re.Hg)(e)}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}get rootUrl(){return this._rootUrl}constructor(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._allMaterialsDirtyRequired=!1,this._skipStartAnimationStep=!1,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=e}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(e=>e.dispose&&e.dispose()),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}async importMeshAsync(e,t,s,n,i,o,r=""){return await Promise.resolve().then(async()=>{this._babylonScene=t,this._assetContainer=s,this._loadData(n);let o=null;if(e){const t={};if(this._gltf.nodes)for(const e of this._gltf.nodes)e.name&&(t[e.name]=e.index);o=(e instanceof Array?e:[e]).map(e=>{const s=t[e];if(void 0===s)throw new Error(`Failed to find node '${e}'`);return s})}return await this._loadAsync(i,r,o,()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries(),spriteManagers:[]}))})}async loadAsync(e,t,s,n,i=""){return this._babylonScene=e,this._loadData(t),await this._loadAsync(s,i,null,()=>{})}async _loadAsync(e,t,s,n){return await Promise.resolve().then(async()=>{this._rootUrl=e,this._uniqueRootUrl=!e.startsWith("file:")&&t?e:`${e}${Date.now()}/`,this._fileName=t,this._allMaterialsDirtyRequired=!1,await this._loadExtensionsAsync();const i=`${J[J.LOADING]} => ${J[J.READY]}`,o=`${J[J.LOADING]} => ${J[J.COMPLETE]}`;this._parent._startPerformanceCounter(i),this._parent._startPerformanceCounter(o),this._parent._setState(J.LOADING),this._extensionsOnLoading();const a=new Array,l=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials)if(s)a.push(this.loadSceneAsync("/nodes",{nodes:s,index:-1}));else if(null!=this._gltf.scene||this._gltf.scenes&&this._gltf.scenes[0]){const e=ce.Get("/scene",this._gltf.scenes,this._gltf.scene||0);a.push(this.loadSceneAsync(`/scenes/${e.index}`,e))}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let e=0;e<this._gltf.materials.length;++e){const t=this._gltf.materials[e],s="/materials/"+e,n=O.i.TriangleFillMode;a.push(this._loadMaterialAsync(s,t,null,n,()=>{}))}this._allMaterialsDirtyRequired?this._babylonScene.blockMaterialDirtyMechanism=l:this._babylonScene._forceBlockMaterialDirtyMechanism(l),this._parent.compileMaterials&&a.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&a.push(this._compileShadowGeneratorsAsync());const h=Promise.all(a).then(()=>{this._rootBabylonMesh&&this._rootBabylonMesh!==this._parent.customRootNode&&this._rootBabylonMesh.setEnabled(!0);for(const e of this._babylonScene.materials){const t=e;void 0!==t.maxSimultaneousLights&&(t.maxSimultaneousLights=Math.max(t.maxSimultaneousLights,this._babylonScene.lights.length))}return this._extensionsOnReady(),this._parent._setState(J.READY),this._skipStartAnimationStep||this._startAnimations(),n()});return await h.then(e=>(this._parent._endPerformanceCounter(i),r.S0.SetImmediate(()=>{this._disposed||Promise.all(this._completePromises).then(()=>{this._parent._endPerformanceCounter(o),this._parent._setState(J.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()},e=>{this._parent.onErrorObservable.notifyObservers(e),this._parent.onErrorObservable.clear(),this.dispose()})}),e))}).catch(e=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(e),this._parent.onErrorObservable.clear(),this.dispose()),e})}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){const t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){const s=t[0];(s.byteLength<e.bin.byteLength-3||s.byteLength>e.bin.byteLength)&&F.V.Warn(`Binary buffer length (${s.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin}else F.V.Warn("Unexpected BIN chunk")}}_setupData(){if(ce.Assign(this._gltf.accessors),ce.Assign(this._gltf.animations),ce.Assign(this._gltf.buffers),ce.Assign(this._gltf.bufferViews),ce.Assign(this._gltf.cameras),ce.Assign(this._gltf.images),ce.Assign(this._gltf.materials),ce.Assign(this._gltf.meshes),ce.Assign(this._gltf.nodes),ce.Assign(this._gltf.samplers),ce.Assign(this._gltf.scenes),ce.Assign(this._gltf.skins),ce.Assign(this._gltf.textures),this._gltf.nodes){const e={};for(const t of this._gltf.nodes)if(t.children)for(const s of t.children)e[s]=t.index;const t=this._createRootNode();for(const s of this._gltf.nodes){const n=e[s.index];s.parent=void 0===n?t:this._gltf.nodes[n]}}}async _loadExtensionsAsync(){const e=[];if(re.Sv.forEach((t,s)=>{!1===this.parent.extensionOptions[s]?.enabled?t.isGLTFExtension&&this.isExtensionUsed(s)&&F.V.Warn(`Extension ${s} is used but has been explicitly disabled.`):t.isGLTFExtension&&!this.isExtensionUsed(s)||e.push((async()=>{const e=await t.factory(this);return e.name!==s&&F.V.Warn(`The name of the glTF loader extension instance does not match the registered name: ${e.name} !== ${s}`),this._parent.onExtensionLoadedObservable.notifyObservers(e),e})())}),this._extensions.push(...await Promise.all(e)),this._extensions.sort((e,t)=>(e.order||Number.MAX_VALUE)-(t.order||Number.MAX_VALUE)),this._parent.onExtensionLoadedObservable.clear(),this._gltf.extensionsRequired)for(const e of this._gltf.extensionsRequired){if(!this._extensions.some(t=>t.name===e&&t.enabled)){if(!1===this.parent.extensionOptions[e]?.enabled)throw new Error(`Required extension ${e} is disabled`);throw new Error(`Required extension ${e} is not available`)}}}_createRootNode(){if(void 0!==this._parent.customRootNode)return this._rootBabylonMesh=this._parent.customRootNode,{_babylonTransformNode:null===this._rootBabylonMesh?void 0:this._rootBabylonMesh,index:-1};this._babylonScene._blockEntityCollection=!!this._assetContainer;const e=new $.e("__root__",this._babylonScene);this._rootBabylonMesh=e,this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);const t={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case H.AUTO:this._babylonScene.useRightHandedSystem||(t.rotation=[0,1,0,0],t.scale=[1,1,-1],ue._LoadTransform(t,this._rootBabylonMesh));break;case H.FORCE_RIGHT_HANDED:this._babylonScene.useRightHandedSystem=!0;break;default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(e),t}loadSceneAsync(e,t){const s=this._extensionsLoadSceneAsync(e,t);if(s)return s;const n=new Array;if(this.logOpen(`${e} ${t.name||""}`),t.nodes)for(const s of t.nodes){const t=ce.Get(`${e}/nodes/${s}`,this._gltf.nodes,s);n.push(this.loadNodeAsync(`/nodes/${t.index}`,t,e=>{e.parent=this._rootBabylonMesh}))}for(const e of this._postSceneLoadActions)e();return n.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(n).then(()=>{})}_forEachPrimitive(e,t){if(e._primitiveBabylonMeshes)for(const s of e._primitiveBabylonMeshes)t(s)}_getGeometries(){const e=[],t=this._gltf.nodes;if(t)for(const s of t)this._forEachPrimitive(s,t=>{const s=t.geometry;s&&-1===e.indexOf(s)&&e.push(s)});return e}_getMeshes(){const e=[];this._rootBabylonMesh instanceof I.u&&e.push(this._rootBabylonMesh);const t=this._gltf.nodes;if(t)for(const s of t)this._forEachPrimitive(s,t=>{e.push(t)});return e}_getTransformNodes(){const e=[],t=this._gltf.nodes;if(t)for(const s of t)s._babylonTransformNode&&"TransformNode"===s._babylonTransformNode.getClassName()&&e.push(s._babylonTransformNode),s._babylonTransformNodeForSkin&&e.push(s._babylonTransformNodeForSkin);return e}_getSkeletons(){const e=[],t=this._gltf.skins;if(t)for(const s of t)s._data&&e.push(s._data.babylonSkeleton);return e}_getAnimationGroups(){const e=[],t=this._gltf.animations;if(t)for(const s of t)s._babylonAnimationGroup&&e.push(s._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case j.NONE:break;case j.FIRST:{const e=this._getAnimationGroups();0!==e.length&&e[0].start(!0);break}case j.ALL:{const e=this._getAnimationGroups();for(const t of e)t.start(!0);break}default:return void F.V.Error(`Invalid animation start mode (${this._parent.animationStartMode})`)}}loadNodeAsync(e,t,s=()=>{}){const n=this._extensionsLoadNodeAsync(e,t,s);if(n)return n;if(t._babylonTransformNode)throw new Error(`${e}: Invalid recursive node hierarchy`);const i=new Array;this.logOpen(`${e} ${t.name||""}`);const o=n=>{if(ue.AddPointerMetadata(n,e),ue._LoadTransform(t,n),null!=t.camera){const s=ce.Get(`${e}/camera`,this._gltf.cameras,t.camera);i.push(this.loadCameraAsync(`/cameras/${s.index}`,s,e=>{e.parent=n,this._babylonScene.useRightHandedSystem||(n.scaling.x=-1)}))}if(t.children)for(const s of t.children){const t=ce.Get(`${e}/children/${s}`,this._gltf.nodes,s);i.push(this.loadNodeAsync(`/nodes/${t.index}`,t,e=>{e.parent=n}))}s(n)},r=null!=t.mesh,a=this._parent.loadSkins&&null!=t.skin;if(!r||a){const e=t.name||`node${t.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const s=new E.V(e,this._babylonScene);s._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,null==t.mesh?t._babylonTransformNode=s:t._babylonTransformNodeForSkin=s,o(s)}if(r)if(a){const s=ce.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);i.push(this._loadMeshAsync(`/meshes/${s.index}`,t,s,s=>{const n=t._babylonTransformNodeForSkin;s.metadata=(0,le.$)(n.metadata,s.metadata||{});const o=ce.Get(`${e}/skin`,this._gltf.skins,t.skin);i.push(this._loadSkinAsync(`/skins/${o.index}`,t,o,e=>{this._forEachPrimitive(t,t=>{t.skeleton=e}),this._postSceneLoadActions.push(()=>{if(null!=o.skeleton){const e=ce.Get(`/skins/${o.index}/skeleton`,this._gltf.nodes,o.skeleton).parent;t.index===e.index?s.parent=n.parent:s.parent=e._babylonTransformNode}else s.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:n,skinnedNode:s})})}))}))}else{const s=ce.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);i.push(this._loadMeshAsync(`/meshes/${s.index}`,t,s,o))}return this.logClose(),Promise.all(i).then(()=>(this._forEachPrimitive(t,e=>{const t=e;!t.isAnInstance&&t.geometry&&t.geometry.useBoundingInfoFromGeometry?e._updateBoundingInfo():e.refreshBoundingInfo(!0,!0)}),t._babylonTransformNode))}_loadMeshAsync(e,t,s,n){const i=s.primitives;if(!i||!i.length)throw new Error(`${e}: Primitives are missing`);null==i[0].index&&ce.Assign(i);const o=new Array;this.logOpen(`${e} ${s.name||""}`);const r=t.name||`node${t.index}`;if(1===i.length){const n=s.primitives[0];o.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${n.index}`,r,t,s,n,e=>{t._babylonTransformNode=e,t._primitiveBabylonMeshes=[e]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,t._babylonTransformNode=new E.V(r,this._babylonScene),t._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._primitiveBabylonMeshes=[];for(const n of i)o.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${n.index}`,`${r}_primitive${n.index}`,t,s,n,e=>{e.parent=t._babylonTransformNode,t._primitiveBabylonMeshes.push(e)}))}return n(t._babylonTransformNode),this.logClose(),Promise.all(o).then(()=>t._babylonTransformNode)}_loadMeshPrimitiveAsync(e,t,s,n,i,o){const r=this._extensionsLoadMeshPrimitiveAsync(e,t,s,n,i,o);if(r)return r;this.logOpen(`${e}`);const a=0===this._disableInstancedMesh&&this._parent.createInstances&&null==s.skin&&!n.primitives[0].targets;let l,h;if(a&&i._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,l=i._instanceData.babylonSourceMesh.createInstance(t),l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,h=i._instanceData.promise;else{const o=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;const r=new $.e(t,this._babylonScene);r._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,r.sideOrientation=this._babylonScene.useRightHandedSystem?O.i.CounterClockWiseSideOrientation:O.i.ClockWiseSideOrientation,this._createMorphTargets(e,s,n,i,r),o.push(this._loadVertexDataAsync(e,i,r).then(async t=>await this._loadMorphTargetsAsync(e,i,r,t).then(()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,t.applyToMesh(r),t._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})));const c=ue._GetDrawMode(e,i.mode);if(null==i.material){let e=this._defaultBabylonMaterialData[c];e||(e=this._createDefaultMaterial("__GLTFLoader._default",c),this._parent.onMaterialLoadedObservable.notifyObservers(e),this._defaultBabylonMaterialData[c]=e),r.material=e}else if(!this.parent.skipMaterials){const t=ce.Get(`${e}/material`,this._gltf.materials,i.material);o.push(this._loadMaterialAsync(`/materials/${t.index}`,t,r,c,e=>{r.material=e}))}h=Promise.all(o),a&&(i._instanceData={babylonSourceMesh:r,promise:h}),l=r}return ue.AddPointerMetadata(l,e),this._parent.onMeshLoadedObservable.notifyObservers(l),o(l),this.logClose(),h.then(()=>l)}_loadVertexDataAsync(e,t,s){const n=this._extensionsLoadVertexDataAsync(e,t,s);if(n)return n;const i=t.attributes;if(!i)throw new Error(`${e}: Attributes are missing`);const o=new Array,r=new L.V(s.name,this._babylonScene);if(null==t.indices)s.isUnIndexed=!0;else{const s=ce.Get(`${e}/indices`,this._gltf.accessors,t.indices);o.push(this._loadIndicesAccessorAsync(`/accessors/${s.index}`,s).then(e=>{r.setIndices(e)}))}const a=(t,n,a)=>{if(null==i[t])return;s._delayInfo=s._delayInfo||[],-1===s._delayInfo.indexOf(n)&&s._delayInfo.push(n);const l=ce.Get(`${e}/attributes/${t}`,this._gltf.accessors,i[t]);o.push(this._loadVertexAccessorAsync(`/accessors/${l.index}`,l,n).then(e=>{if(e.getKind()===k.R.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!s.skeleton){const e=de(l);e&&(r._boundingInfo=e,r.useBoundingInfoFromGeometry=!0)}r.setVerticesBuffer(e,l.count)})),n==k.R.MatricesIndicesExtraKind&&(s.numBoneInfluencers=8),a&&a(l)};return a("POSITION",k.R.PositionKind),a("NORMAL",k.R.NormalKind),a("TANGENT",k.R.TangentKind),a("TEXCOORD_0",k.R.UVKind),a("TEXCOORD_1",k.R.UV2Kind),a("TEXCOORD_2",k.R.UV3Kind),a("TEXCOORD_3",k.R.UV4Kind),a("TEXCOORD_4",k.R.UV5Kind),a("TEXCOORD_5",k.R.UV6Kind),a("JOINTS_0",k.R.MatricesIndicesKind),a("WEIGHTS_0",k.R.MatricesWeightsKind),a("JOINTS_1",k.R.MatricesIndicesExtraKind),a("WEIGHTS_1",k.R.MatricesWeightsExtraKind),a("COLOR_0",k.R.ColorKind,e=>{"VEC4"===e.type&&(s.hasVertexAlpha=!0)}),Promise.all(o).then(()=>r)}_createMorphTargets(e,t,s,n,i){if(!n.targets||!this._parent.loadMorphTargets)return;if(null==t._numMorphTargets)t._numMorphTargets=n.targets.length;else if(n.targets.length!==t._numMorphTargets)throw new Error(`${e}: Primitives do not have the same number of targets`);const o=s.extras?s.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,i.morphTargetManager=new G(this._babylonScene),i.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i.morphTargetManager.areUpdatesFrozen=!0;for(let e=0;e<n.targets.length;e++){const n=t.weights?t.weights[e]:s.weights?s.weights[e]:0,r=o?o[e]:`morphTarget${e}`;i.morphTargetManager.addTarget(new V(r,n,i.getScene()))}}_loadMorphTargetsAsync(e,t,s,n){if(!t.targets||!this._parent.loadMorphTargets)return Promise.resolve();const i=new Array,o=s.morphTargetManager;for(let s=0;s<o.numTargets;s++){const r=o.getTarget(s);i.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${s}`,n,t.targets[s],r))}return Promise.all(i).then(()=>{o.areUpdatesFrozen=!1})}async _loadMorphTargetVertexDataAsync(e,t,s,n){const i=new Array,o=(n,o,r)=>{if(null==s[n])return;const a=t.getVertexBuffer(o);if(!a)return;const l=ce.Get(`${e}/${n}`,this._gltf.accessors,s[n]);i.push(this._loadFloatAccessorAsync(`/accessors/${l.index}`,l).then(e=>{r(a,e)}))};return o("POSITION",k.R.PositionKind,(e,t)=>{const s=new Float32Array(t.length);e.forEach(t.length,(e,n)=>{s[n]=t[n]+e}),n.setPositions(s)}),o("NORMAL",k.R.NormalKind,(e,t)=>{const s=new Float32Array(t.length);e.forEach(s.length,(e,n)=>{s[n]=t[n]+e}),n.setNormals(s)}),o("TANGENT",k.R.TangentKind,(e,t)=>{const s=new Float32Array(t.length/3*4);let i=0;e.forEach(t.length/3*4,(e,n)=>{(n+1)%4!=0&&(s[i]=t[i]+e,i++)}),n.setTangents(s)}),o("TEXCOORD_0",k.R.UVKind,(e,t)=>{const s=new Float32Array(t.length);e.forEach(t.length,(e,n)=>{s[n]=t[n]+e}),n.setUVs(s)}),o("TEXCOORD_1",k.R.UV2Kind,(e,t)=>{const s=new Float32Array(t.length);e.forEach(t.length,(e,n)=>{s[n]=t[n]+e}),n.setUV2s(s)}),o("COLOR_0",k.R.ColorKind,(t,s)=>{let i=null;const o=t.getSize();if(3===o){i=new Float32Array(s.length/3*4),t.forEach(s.length,(e,t)=>{const n=Math.floor(t/3),o=t%3;i[4*n+o]=s[3*n+o]+e});for(let e=0;e<s.length/3;++e)i[4*e+3]=1}else{if(4!==o)throw new Error(`${e}: Invalid number of components (${o}) for COLOR_0 attribute`);i=new Float32Array(s.length),t.forEach(s.length,(e,t)=>{i[t]=s[t]+e})}n.setColors(i)}),await Promise.all(i).then(()=>{})}static _LoadTransform(e,t){if(null!=e.skin)return;let s=i.Pq.Zero(),n=i.PT.Identity(),o=i.Pq.One();if(e.matrix){i.uq.FromArray(e.matrix).decompose(o,n,s)}else e.translation&&(s=i.Pq.FromArray(e.translation)),e.rotation&&(n=i.PT.FromArray(e.rotation)),e.scale&&(o=i.Pq.FromArray(e.scale));t.position=s,t.rotationQuaternion=n,t.scaling=o}_loadSkinAsync(e,t,s,n){if(!this._parent.loadSkins)return Promise.resolve();const i=this._extensionsLoadSkinAsync(e,t,s);if(i)return i;if(s._data)return n(s._data.babylonSkeleton),s._data.promise;const o=`skeleton${s.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const r=new R.E(s.name||o,o,this._babylonScene);r._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,s,r);const a=this._loadSkinInverseBindMatricesDataAsync(e,s).then(e=>{this._updateBoneMatrices(r,e)});return s._data={babylonSkeleton:r,promise:a},n(r),a}_loadBones(e,t,s){if(null==t.skeleton||this._parent.alwaysComputeSkeletonRootNode){const s=this._findSkeletonRootNode(`${e}/joints`,t.joints);if(s)if(void 0===t.skeleton)t.skeleton=s.index;else{const n=(e,t)=>{for(;t.parent;t=t.parent)if(t.parent===e)return!0;return!1},i=ce.Get(`${e}/skeleton`,this._gltf.nodes,t.skeleton);i===s||n(i,s)||(F.V.Warn(`${e}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),t.skeleton=s.index)}else F.V.Warn(`${e}: Failed to find common root`)}const n={};for(const i of t.joints){const o=ce.Get(`${e}/joints/${i}`,this._gltf.nodes,i);this._loadBone(o,t,s,n)}}_findSkeletonRootNode(e,t){if(0===t.length)return null;const s={};for(const n of t){const t=[];let i=ce.Get(`${e}/${n}`,this._gltf.nodes,n);for(;-1!==i.index;)t.unshift(i),i=i.parent;s[n]=t}let n=null;for(let e=0;;++e){let i=s[t[0]];if(e>=i.length)return n;const o=i[e];for(let r=1;r<t.length;++r)if(i=s[t[r]],e>=i.length||o!==i[e])return n;n=o}}_loadBone(e,t,s,n){e._isJoint=!0;let i=n[e.index];if(i)return i;let o=null;e.index!==t.skeleton&&(e.parent&&-1!==e.parent.index?o=this._loadBone(e.parent,t,s,n):void 0!==t.skeleton&&F.V.Warn(`/skins/${t.index}/skeleton: Skeleton node is not a common root`));const r=t.joints.indexOf(e.index);return i=new T.$(e.name||`joint${e.index}`,s,o,this._getNodeMatrix(e),null,null,r),n[e.index]=i,this._postSceneLoadActions.push(()=>{i.linkTransformNode(e._babylonTransformNode)}),i}_loadSkinInverseBindMatricesDataAsync(e,t){if(null==t.inverseBindMatrices)return Promise.resolve(null);const s=ce.Get(`${e}/inverseBindMatrices`,this._gltf.accessors,t.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${s.index}`,s)}_updateBoneMatrices(e,t){for(const s of e.bones){const e=i.uq.Identity(),n=s._index;t&&-1!==n&&(i.uq.FromArrayToRef(t,16*n,e),e.invertToRef(e));const o=s.getParent();o&&e.multiplyToRef(o.getAbsoluteInverseBindMatrix(),e),s.updateMatrix(e,!1,!1),s._updateAbsoluteBindMatrices(void 0,!1)}}_getNodeMatrix(e){return e.matrix?i.uq.FromArray(e.matrix):i.uq.Compose(e.scale?i.Pq.FromArray(e.scale):i.Pq.One(),e.rotation?i.PT.FromArray(e.rotation):i.PT.Identity(),e.translation?i.Pq.FromArray(e.translation):i.Pq.Zero())}loadCameraAsync(e,t,s=()=>{}){const n=this._extensionsLoadCameraAsync(e,t,s);if(n)return n;const o=new Array;this.logOpen(`${e} ${t.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;const r=new M(t.name||`camera${t.index}`,i.Pq.Zero(),this._babylonScene,!1);switch(r._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonCamera=r,r.setTarget(new i.Pq(0,0,-1)),t.type){case"perspective":{const s=t.perspective;if(!s)throw new Error(`${e}: Camera perspective properties are missing`);r.fov=s.yfov,r.minZ=s.znear,r.maxZ=s.zfar||0;break}case"orthographic":if(!t.orthographic)throw new Error(`${e}: Camera orthographic properties are missing`);r.mode=a.i.ORTHOGRAPHIC_CAMERA,r.orthoLeft=-t.orthographic.xmag,r.orthoRight=t.orthographic.xmag,r.orthoBottom=-t.orthographic.ymag,r.orthoTop=t.orthographic.ymag,r.minZ=t.orthographic.znear,r.maxZ=t.orthographic.zfar;break;default:throw new Error(`${e}: Invalid camera type (${t.type})`)}return ue.AddPointerMetadata(r,e),this._parent.onCameraLoadedObservable.notifyObservers(r),s(r),this.logClose(),Promise.all(o).then(()=>r)}_loadAnimationsAsync(){const e=this._gltf.animations;if(!e)return Promise.resolve();const t=new Array;for(let s=0;s<e.length;s++){const n=e[s];t.push(this.loadAnimationAsync(`/animations/${n.index}`,n).then(e=>{0===e.targetedAnimations.length&&e.dispose()}))}return Promise.all(t).then(()=>{})}loadAnimationAsync(e,t){const n=this._extensionsLoadAnimationAsync(e,t);return n||s.e(5879).then(s.bind(s,25879)).then(({AnimationGroup:s})=>{this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new s(t.name||`animation${t.index}`,this._babylonScene);n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonAnimationGroup=n;const i=new Array;ce.Assign(t.channels),ce.Assign(t.samplers);for(const s of t.channels)i.push(this._loadAnimationChannelAsync(`${e}/channels/${s.index}`,e,t,s,(e,t)=>{e.animations=e.animations||[],e.animations.push(t),n.addTargetedAnimation(t,e)}));return Promise.all(i).then(()=>(n.normalize(0),n))})}async _loadAnimationChannelAsync(e,t,n,i,o){const r=this._extensionsLoadAnimationChannelAsync(e,t,n,i,o);if(r)return await r;if(null==i.target.node)return await Promise.resolve();const a=ce.Get(`${e}/target/node`,this._gltf.nodes,i.target.node),l=i.target.path,h="weights"===l;if(h&&!a._numMorphTargets||!h&&!a._babylonTransformNode)return await Promise.resolve();if(!this._parent.loadNodeAnimations&&!h&&!a._isJoint)return await Promise.resolve();let c;switch(await s.e(4236).then(s.bind(s,34236)),l){case"translation":c=(0,ae.tQ)("/nodes/{}/translation")?.interpolation;break;case"rotation":c=(0,ae.tQ)("/nodes/{}/rotation")?.interpolation;break;case"scale":c=(0,ae.tQ)("/nodes/{}/scale")?.interpolation;break;case"weights":c=(0,ae.tQ)("/nodes/{}/weights")?.interpolation;break;default:throw new Error(`${e}/target/path: Invalid value (${i.target.path})`)}if(!c)throw new Error(`${e}/target/path: Could not find interpolation properties for target path (${i.target.path})`);const d={object:a,info:c};return await this._loadAnimationChannelFromTargetInfoAsync(e,t,n,i,d,o)}_loadAnimationChannelFromTargetInfoAsync(e,t,s,n,i,o){const r=this.parent.targetFps,a=1/r,l=ce.Get(`${e}/sampler`,s.samplers,n.sampler);return this._loadAnimationSamplerAsync(`${t}/samplers/${n.sampler}`,l).then(e=>{let t=0;const l=i.object,h=i.info;for(const i of h){const h=i.getStride(l),c=e.input,d=e.output,u=new Array(c.length);let _=0;switch(e.interpolation){case"STEP":for(let e=0;e<c.length;e++){const t=i.getValue(l,d,_,1);_+=h,u[e]={frame:c[e]*r,value:t,interpolation:1}}break;case"CUBICSPLINE":for(let e=0;e<c.length;e++){const t=i.getValue(l,d,_,a);_+=h;const s=i.getValue(l,d,_,1);_+=h;const n=i.getValue(l,d,_,a);_+=h,u[e]={frame:c[e]*r,inTangent:t,value:s,outTangent:n}}break;case"LINEAR":for(let e=0;e<c.length;e++){const t=i.getValue(l,d,_,1);_+=h,u[e]={frame:c[e]*r,value:t}}}if(_>0){const e=`${s.name||`animation${s.index}`}_channel${n.index}_${t}`,a=i.buildAnimations(l,e,r,u);for(const e of a)t++,o(e.babylonAnimatable,e.babylonAnimation)}}})}_loadAnimationSamplerAsync(e,t){if(t._data)return t._data;const s=t.interpolation||"LINEAR";switch(s){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${e}/interpolation: Invalid value (${t.interpolation})`)}const n=ce.Get(`${e}/input`,this._gltf.accessors,t.input),i=ce.Get(`${e}/output`,this._gltf.accessors,t.output);return t._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${n.index}`,n),this._loadFloatAccessorAsync(`/accessors/${i.index}`,i)]).then(([e,t])=>({input:e,interpolation:s,output:t})),t._data}loadBufferAsync(e,t,s,n){const i=this._extensionsLoadBufferAsync(e,t,s,n);if(i)return i;if(!t._data)if(t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{if(!this._bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);t._data=this._bin.readAsync(0,t.byteLength)}return t._data.then(t=>{try{return new Uint8Array(t.buffer,t.byteOffset+s,n)}catch(t){throw new Error(`${e}: ${t.message}`)}})}loadBufferViewAsync(e,t){const s=this._extensionsLoadBufferViewAsync(e,t);if(s)return s;if(t._data)return t._data;const n=ce.Get(`${e}/buffer`,this._gltf.buffers,t.buffer);return t._data=this.loadBufferAsync(`/buffers/${n.index}`,n,t.byteOffset||0,t.byteLength),t._data}_loadAccessorAsync(e,t,s){if(t._data)return t._data;const n=ue._GetNumComponents(e,t.type),i=n*k.R.GetTypeByteLength(t.componentType),o=n*t.count;if(null==t.bufferView)t._data=Promise.resolve(new s(o));else{const r=ce.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${r.index}`,r).then(a=>{if(5126!==t.componentType||t.normalized||r.byteStride&&r.byteStride!==i){const e=new s(o);return k.R.ForEach(a,t.byteOffset||0,r.byteStride||i,n,t.componentType,e.length,t.normalized||!1,(t,s)=>{e[s]=t}),e}return ue._GetTypedArray(e,t.componentType,a,t.byteOffset,o)})}if(t.sparse){const o=t.sparse;t._data=t._data.then(r=>{const a=r,l=ce.Get(`${e}/sparse/indices/bufferView`,this._gltf.bufferViews,o.indices.bufferView),h=ce.Get(`${e}/sparse/values/bufferView`,this._gltf.bufferViews,o.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${l.index}`,l),this.loadBufferViewAsync(`/bufferViews/${h.index}`,h)]).then(([r,l])=>{const h=ue._GetTypedArray(`${e}/sparse/indices`,o.indices.componentType,r,o.indices.byteOffset,o.count),c=n*o.count;let d;if(5126!==t.componentType||t.normalized){const r=ue._GetTypedArray(`${e}/sparse/values`,t.componentType,l,o.values.byteOffset,c);d=new s(c),k.R.ForEach(r,0,i,n,t.componentType,d.length,t.normalized||!1,(e,t)=>{d[t]=e})}else d=ue._GetTypedArray(`${e}/sparse/values`,t.componentType,l,o.values.byteOffset,c);let u=0;for(let e=0;e<h.length;e++){let t=h[e]*n;for(let e=0;e<n;e++)a[t++]=d[u++]}return a})})}return t._data}_loadFloatAccessorAsync(e,t){return this._loadAccessorAsync(e,t,Float32Array)}_loadIndicesAccessorAsync(e,t){if("SCALAR"!==t.type)throw new Error(`${e}/type: Invalid value ${t.type}`);if(5121!==t.componentType&&5123!==t.componentType&&5125!==t.componentType)throw new Error(`${e}/componentType: Invalid value ${t.componentType}`);if(t._data)return t._data;if(t.sparse){const s=ue._GetTypedArrayConstructor(`${e}/componentType`,t.componentType);t._data=this._loadAccessorAsync(e,t,s)}else{const s=ce.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${s.index}`,s).then(s=>ue._GetTypedArray(e,t.componentType,s,t.byteOffset,t.count))}return t._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;const t=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${e.index}`,e).then(e=>new k.h(t,e,!1)),e._babylonBuffer}_loadVertexAccessorAsync(e,t,s){if(t._babylonVertexBuffer?.[s])return t._babylonVertexBuffer[s];t._babylonVertexBuffer||(t._babylonVertexBuffer={});const n=this._babylonScene.getEngine();if(t.sparse||null==t.bufferView)t._babylonVertexBuffer[s]=this._loadFloatAccessorAsync(e,t).then(e=>new k.R(n,e,s,!1));else{const i=ce.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._babylonVertexBuffer[s]=this._loadVertexBufferViewAsync(i).then(o=>{const r=ue._GetNumComponents(e,t.type);return new k.R(n,o,s,!1,void 0,i.byteStride,void 0,t.byteOffset,r,t.componentType,t.normalized,!0,void 0,!0)})}return t._babylonVertexBuffer[s]}_loadMaterialMetallicRoughnessPropertiesAsync(e,t,s){if(!(s instanceof P.Y))throw new Error(`${e}: Material type not supported`);const n=new Array;return t&&(t.baseColorFactor?(s.albedoColor=o.v9.FromArray(t.baseColorFactor),s.alpha=t.baseColorFactor[3]):s.albedoColor=o.v9.White(),s.metallic=null==t.metallicFactor?1:t.metallicFactor,s.roughness=null==t.roughnessFactor?1:t.roughnessFactor,t.baseColorTexture&&n.push(this.loadTextureInfoAsync(`${e}/baseColorTexture`,t.baseColorTexture,e=>{e.name=`${s.name} (Base Color)`,s.albedoTexture=e})),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/metallicRoughnessTexture`,t.metallicRoughnessTexture,e=>{e.name=`${s.name} (Metallic Roughness)`,s.metallicTexture=e})),s.useMetallnessFromMetallicTextureBlue=!0,s.useRoughnessFromMetallicTextureGreen=!0,s.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(n).then(()=>{})}_loadMaterialAsync(e,t,s,n,i=()=>{}){const o=this._extensionsLoadMaterialAsync(e,t,s,n,i);if(o)return o;t._data=t._data||{};let r=t._data[n];if(!r){this.logOpen(`${e} ${t.name||""}`);const s=this.createMaterial(e,t,n);r={babylonMaterial:s,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,t,s)},t._data[n]=r,ue.AddPointerMetadata(s,e),this._parent.onMaterialLoadedObservable.notifyObservers(s),this.logClose()}return s&&(r.babylonMeshes.push(s),s.onDisposeObservable.addOnce(()=>{const e=r.babylonMeshes.indexOf(s);-1!==e&&r.babylonMeshes.splice(e,1)})),i(r.babylonMaterial),r.promise.then(()=>r.babylonMaterial)}_createDefaultMaterial(e,t){this._babylonScene._blockEntityCollection=!!this._assetContainer;const s=new P.Y(e,this._babylonScene);return s._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,s.fillMode=t,s.enableSpecularAntiAliasing=!0,s.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,s.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,s.transparencyMode=P.Y.PBRMATERIAL_OPAQUE,s.metallic=1,s.roughness=1,s}createMaterial(e,t,s){const n=this._extensionsCreateMaterial(e,t,s);if(n)return n;const i=t.name||`material${t.index}`;return this._createDefaultMaterial(i,s)}loadMaterialPropertiesAsync(e,t,s){const n=this._extensionsLoadMaterialPropertiesAsync(e,t,s);if(n)return n;const i=new Array;return i.push(this.loadMaterialBasePropertiesAsync(e,t,s)),t.pbrMetallicRoughness&&i.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${e}/pbrMetallicRoughness`,t.pbrMetallicRoughness,s)),this.loadMaterialAlphaProperties(e,t,s),Promise.all(i).then(()=>{})}loadMaterialBasePropertiesAsync(e,t,s){if(!(s instanceof P.Y))throw new Error(`${e}: Material type not supported`);const n=new Array;return s.emissiveColor=t.emissiveFactor?o.v9.FromArray(t.emissiveFactor):new o.v9(0,0,0),t.doubleSided&&(s.backFaceCulling=!1,s.twoSidedLighting=!0),t.normalTexture&&(t.normalTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/normalTexture`,t.normalTexture,e=>{e.name=`${s.name} (Normal)`,s.bumpTexture=e})),s.invertNormalMapX=!this._babylonScene.useRightHandedSystem,s.invertNormalMapY=this._babylonScene.useRightHandedSystem,null!=t.normalTexture.scale&&s.bumpTexture&&(s.bumpTexture.level=t.normalTexture.scale),s.forceIrradianceInFragment=!0),t.occlusionTexture&&(t.occlusionTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/occlusionTexture`,t.occlusionTexture,e=>{e.name=`${s.name} (Occlusion)`,s.ambientTexture=e})),s.useAmbientInGrayScale=!0,null!=t.occlusionTexture.strength&&(s.ambientTextureStrength=t.occlusionTexture.strength)),t.emissiveTexture&&n.push(this.loadTextureInfoAsync(`${e}/emissiveTexture`,t.emissiveTexture,e=>{e.name=`${s.name} (Emissive)`,s.emissiveTexture=e})),Promise.all(n).then(()=>{})}loadMaterialAlphaProperties(e,t,s){if(!(s instanceof P.Y))throw new Error(`${e}: Material type not supported`);switch(t.alphaMode||"OPAQUE"){case"OPAQUE":s.transparencyMode=P.Y.PBRMATERIAL_OPAQUE,s.alpha=1;break;case"MASK":s.transparencyMode=P.Y.PBRMATERIAL_ALPHATEST,s.alphaCutOff=null==t.alphaCutoff?.5:t.alphaCutoff,s.albedoTexture&&(s.albedoTexture.hasAlpha=!0);break;case"BLEND":s.transparencyMode=P.Y.PBRMATERIAL_ALPHABLEND,s.albedoTexture&&(s.albedoTexture.hasAlpha=!0,s.useAlphaFromAlbedoTexture=!0);break;default:throw new Error(`${e}/alphaMode: Invalid value (${t.alphaMode})`)}}loadTextureInfoAsync(e,t,s=()=>{}){const n=this._extensionsLoadTextureInfoAsync(e,t,s);if(n)return n;if(this.logOpen(`${e}`),t.texCoord>=6)throw new Error(`${e}/texCoord: Invalid value (${t.texCoord})`);const i=ce.Get(`${e}/index`,this._gltf.textures,t.index);i._textureInfo=t;const o=this._loadTextureAsync(`/textures/${t.index}`,i,n=>{n.coordinatesIndex=t.texCoord||0,ue.AddPointerMetadata(n,e),this._parent.onTextureLoadedObservable.notifyObservers(n),s(n)});return this.logClose(),o}_loadTextureAsync(e,t,s=()=>{}){const n=this._extensionsLoadTextureAsync(e,t,s);if(n)return n;this.logOpen(`${e} ${t.name||""}`);const i=null==t.sampler?ue.DefaultSampler:ce.Get(`${e}/sampler`,this._gltf.samplers,t.sampler),o=ce.Get(`${e}/source`,this._gltf.images,t.source),r=this._createTextureAsync(e,i,o,s,void 0,!t._textureInfo.nonColorData);return this.logClose(),r}_createTextureAsync(e,t,s,i=()=>{},o,r){const a=this._loadSampler(`/samplers/${t.index}`,t),l=new Array,h=new n.c;this._babylonScene._blockEntityCollection=!!this._assetContainer;const c={noMipmap:a.noMipMaps,invertY:!1,samplingMode:a.samplingMode,onLoad:()=>{this._disposed||h.resolve()},onError:(t,s)=>{this._disposed||h.reject(new Error(`${e}: ${s&&s.message?s.message:t||"Failed to load texture"}`))},mimeType:s.mimeType??(0,ee.ny)(s.uri??""),loaderOptions:o,useSRGBBuffer:!!r&&this._parent.useSRGBBuffers},d=new S.g(null,this._babylonScene,c);return d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,l.push(h.promise),l.push(this.loadImageAsync(`/images/${s.index}`,s).then(e=>{const t=s.uri||`${this._fileName}#image${s.index}`,n=`data:${this._uniqueRootUrl}${t}`;d.updateURL(n,e);const i=d.getInternalTexture();i&&(i.label=s.name)})),d.wrapU=a.wrapU,d.wrapV=a.wrapV,i(d),this._parent.useGltfTextureNames&&(d.name=s.name||s.uri||`image${s.index}`),Promise.all(l).then(()=>d)}_loadSampler(e,t){return t._data||(t._data={noMipMaps:9728===t.minFilter||9729===t.minFilter,samplingMode:ue._GetTextureSamplingMode(e,t),wrapU:ue._GetTextureWrapMode(`${e}/wrapS`,t.wrapS),wrapV:ue._GetTextureWrapMode(`${e}/wrapT`,t.wrapT)}),t._data}loadImageAsync(e,t){if(!t._data){if(this.logOpen(`${e} ${t.name||""}`),t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{const s=ce.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${s.index}`,s)}this.logClose()}return t._data}loadUriAsync(e,t,s){const n=this._extensionsLoadUriAsync(e,t,s);if(n)return n;if(!ue._ValidateUri(s))throw new Error(`${e}: '${s}' is invalid`);if((0,ee.f2)(s)){const t=new Uint8Array((0,ee.rz)(s));return this.log(`${e}: Decoded ${s.substring(0,64)}... (${t.length} bytes)`),Promise.resolve(t)}return this.log(`${e}: Loading ${s}`),this._parent.preprocessUrlAsync(this._rootUrl+s).then(t=>new Promise((n,i)=>{this._parent._loadFile(this._babylonScene,t,t=>{this._disposed||(this.log(`${e}: Loaded ${s} (${t.byteLength} bytes)`),n(new Uint8Array(t)))},!0,t=>{i(new ee.hX(`${e}: Failed to load '${s}'${t?": "+t.status+" "+t.statusText:""}`,t))})}))}static AddPointerMetadata(e,t){e.metadata=e.metadata||{};const s=e._internalMetadata=e._internalMetadata||{},n=s.gltf=s.gltf||{};(n.pointers=n.pointers||[]).push(t)}static _GetTextureWrapMode(e,t){switch(t=null==t?10497:t){case 33071:return S.g.CLAMP_ADDRESSMODE;case 33648:return S.g.MIRROR_ADDRESSMODE;case 10497:return S.g.WRAP_ADDRESSMODE;default:return F.V.Warn(`${e}: Invalid value (${t})`),S.g.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,t){const s=null==t.magFilter?9729:t.magFilter,n=null==t.minFilter?9987:t.minFilter;if(9729===s)switch(n){case 9728:return S.g.LINEAR_NEAREST;case 9729:return S.g.LINEAR_LINEAR;case 9984:return S.g.LINEAR_NEAREST_MIPNEAREST;case 9985:return S.g.LINEAR_LINEAR_MIPNEAREST;case 9986:return S.g.LINEAR_NEAREST_MIPLINEAR;case 9987:return S.g.LINEAR_LINEAR_MIPLINEAR;default:return F.V.Warn(`${e}/minFilter: Invalid value (${n})`),S.g.LINEAR_LINEAR_MIPLINEAR}else switch(9728!==s&&F.V.Warn(`${e}/magFilter: Invalid value (${s})`),n){case 9728:return S.g.NEAREST_NEAREST;case 9729:return S.g.NEAREST_LINEAR;case 9984:return S.g.NEAREST_NEAREST_MIPNEAREST;case 9985:return S.g.NEAREST_LINEAR_MIPNEAREST;case 9986:return S.g.NEAREST_NEAREST_MIPLINEAR;case 9987:return S.g.NEAREST_LINEAR_MIPLINEAR;default:return F.V.Warn(`${e}/minFilter: Invalid value (${n})`),S.g.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,t){try{return(0,he.w)(t)}catch(t){throw new Error(`${e}: ${t.message}`)}}static _GetTypedArray(e,t,s,n,i){const o=s.buffer;n=s.byteOffset+(n||0);const r=ue._GetTypedArrayConstructor(`${e}/componentType`,t),a=k.R.GetTypeByteLength(t);return n%a!==0?(F.V.Warn(`${e}: Copying buffer as byte offset (${n}) is not a multiple of component type byte length (${a})`),new r(o.slice(n,n+i*a),0)):new r(o,n,i)}static _GetNumComponents(e,t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${e}: Invalid type (${t})`)}static _ValidateUri(e){return r.S0.IsBase64(e)||-1===e.indexOf("..")}static _GetDrawMode(e,t){switch(null==t&&(t=4),t){case 0:return O.i.PointListDrawMode;case 1:return O.i.LineListDrawMode;case 2:return O.i.LineLoopDrawMode;case 3:return O.i.LineStripDrawMode;case 4:return O.i.TriangleFillMode;case 5:return O.i.TriangleStripDrawMode;case 6:return O.i.TriangleFanDrawMode}throw new Error(`${e}: Invalid mesh primitive mode (${t})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");const e=new Array;if(this._gltf.materials)for(const t of this._gltf.materials)if(t._data)for(const s in t._data){const n=t._data[s];for(const t of n.babylonMeshes){t.computeWorldMatrix(!0);const s=n.babylonMaterial;e.push(s.forceCompilationAsync(t)),e.push(s.forceCompilationAsync(t,{useInstances:!0})),this._parent.useClipPlane&&(e.push(s.forceCompilationAsync(t,{clipPlane:!0})),e.push(s.forceCompilationAsync(t,{clipPlane:!0,useInstances:!0})))}}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile materials")})}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");const e=new Array,t=this._babylonScene.lights;for(const s of t){const t=s.getShadowGenerator();t&&e.push(t.forceCompilationAsync())}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile shadow generators")})}_forEachExtensions(e){for(const t of this._extensions)t.enabled&&e(t)}_applyExtensions(e,t,s){for(const n of this._extensions)if(n.enabled){const i=`${n.name}.${t}`,o=e;o._activeLoaderExtensionFunctions=o._activeLoaderExtensionFunctions||{};const r=o._activeLoaderExtensionFunctions;if(!r[i]){r[i]=!0;try{const e=s(n);if(e)return e}finally{delete r[i]}}}return null}_extensionsOnLoading(){this._forEachExtensions(e=>e.onLoading&&e.onLoading())}_extensionsOnReady(){this._forEachExtensions(e=>e.onReady&&e.onReady())}_extensionsLoadSceneAsync(e,t){return this._applyExtensions(t,"loadScene",s=>s.loadSceneAsync&&s.loadSceneAsync(e,t))}_extensionsLoadNodeAsync(e,t,s){return this._applyExtensions(t,"loadNode",n=>n.loadNodeAsync&&n.loadNodeAsync(e,t,s))}_extensionsLoadCameraAsync(e,t,s){return this._applyExtensions(t,"loadCamera",n=>n.loadCameraAsync&&n.loadCameraAsync(e,t,s))}_extensionsLoadVertexDataAsync(e,t,s){return this._applyExtensions(t,"loadVertexData",n=>n._loadVertexDataAsync&&n._loadVertexDataAsync(e,t,s))}_extensionsLoadMeshPrimitiveAsync(e,t,s,n,i,o){return this._applyExtensions(i,"loadMeshPrimitive",r=>r._loadMeshPrimitiveAsync&&r._loadMeshPrimitiveAsync(e,t,s,n,i,o))}_extensionsLoadMaterialAsync(e,t,s,n,i){return this._applyExtensions(t,"loadMaterial",o=>o._loadMaterialAsync&&o._loadMaterialAsync(e,t,s,n,i))}_extensionsCreateMaterial(e,t,s){return this._applyExtensions(t,"createMaterial",n=>n.createMaterial&&n.createMaterial(e,t,s))}_extensionsLoadMaterialPropertiesAsync(e,t,s){return this._applyExtensions(t,"loadMaterialProperties",n=>n.loadMaterialPropertiesAsync&&n.loadMaterialPropertiesAsync(e,t,s))}_extensionsLoadTextureInfoAsync(e,t,s){return this._applyExtensions(t,"loadTextureInfo",n=>n.loadTextureInfoAsync&&n.loadTextureInfoAsync(e,t,s))}_extensionsLoadTextureAsync(e,t,s){return this._applyExtensions(t,"loadTexture",n=>n._loadTextureAsync&&n._loadTextureAsync(e,t,s))}_extensionsLoadAnimationAsync(e,t){return this._applyExtensions(t,"loadAnimation",s=>s.loadAnimationAsync&&s.loadAnimationAsync(e,t))}_extensionsLoadAnimationChannelAsync(e,t,s,n,i){return this._applyExtensions(s,"loadAnimationChannel",o=>o._loadAnimationChannelAsync&&o._loadAnimationChannelAsync(e,t,s,n,i))}_extensionsLoadSkinAsync(e,t,s){return this._applyExtensions(s,"loadSkin",n=>n._loadSkinAsync&&n._loadSkinAsync(e,t,s))}_extensionsLoadUriAsync(e,t,s){return this._applyExtensions(t,"loadUri",n=>n._loadUriAsync&&n._loadUriAsync(e,t,s))}_extensionsLoadBufferViewAsync(e,t){return this._applyExtensions(t,"loadBufferView",s=>s.loadBufferViewAsync&&s.loadBufferViewAsync(e,t))}_extensionsLoadBufferAsync(e,t,s,n){return this._applyExtensions(t,"loadBuffer",i=>i.loadBufferAsync&&i.loadBufferAsync(e,t,s,n))}static LoadExtensionAsync(e,t,s,n){if(!t.extensions)return null;const i=t.extensions[s];return i?n(`${e}/extensions/${s}`,i):null}static LoadExtraAsync(e,t,s,n){if(!t.extras)return null;const i=t.extras[s];return i?n(`${e}/extras/${s}`,i):null}isExtensionUsed(e){return!!this._gltf.extensionsUsed&&-1!==this._gltf.extensionsUsed.indexOf(e)}logOpen(e){this._parent._logOpen(e)}logClose(){this._parent._logClose()}log(e){this._parent._log(e)}startPerformanceCounter(e){this._parent._startPerformanceCounter(e)}endPerformanceCounter(e){this._parent._endPerformanceCounter(e)}}ue.DefaultSampler={index:-1},ie._CreateGLTF2Loader=e=>new ue(e)}}]);