"use strict";(self.webpackChunkeverything_viewer=self.webpackChunkeverything_viewer||[]).push([[274,362,452,481,714,833,858,880,926,994,1245,1271,1480,1650,1665,1995,2047,2083,2248,2536,2661,2905,3051,3126,3145,3314,3613,3696,4005,4190,4353,4511,4619,4676,4679,4972,5144,5407,5499,5583,5595,5682,5779,6022,6109,6154,6762,6797,6951,7105,7136,7156,7169,7593,7641,7671,7682,8137,8855,8900,8961,8993,9278,9384,9515,9569,9693,9720,9820,9938,9965],{18:(e,t,i)=>{i.r(t),i.d(t,{tonemapPixelShaderWGSL:()=>n});const r="tonemapPixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform _ExposureAdjustment: f32;\n#if defined(HABLE_TONEMAPPING)\nconst A: f32=0.15;const B: f32=0.50;const C: f32=0.10;const D: f32=0.20;const E: f32=0.02;const F: f32=0.30;const W: f32=11.2;\n#endif\nfn Luminance(c: vec3f)->f32\n{return dot(c, vec3f(0.22,0.707,0.071));}\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var colour: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;\n#if defined(REINHARD_TONEMAPPING)\nvar lum: f32=Luminance(colour.rgb); \nvar lumTm: f32=lum*uniforms._ExposureAdjustment;var scale: f32=lumTm/(1.0+lumTm); \ncolour*=scale/lum;\n#elif defined(HABLE_TONEMAPPING)\ncolour*=uniforms._ExposureAdjustment;const ExposureBias: f32=2.0;var x: vec3f=ExposureBias*colour;var curr: vec3f=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;x= vec3f(W,W,W);var whiteScale: vec3f=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);colour=curr*whiteScale;\n#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)\ncolour*=uniforms._ExposureAdjustment;var X: vec3f=max( vec3f(0.0,0.0,0.0),colour-0.004);var retColor: vec3f=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;\n#elif defined(PHOTOGRAPHIC_TONEMAPPING)\ncolour= vec3f(1.0,1.0,1.0)-exp2(-uniforms._ExposureAdjustment*colour);\n#endif\nfragmentOutputs.color= vec4f(colour.rgb,1.0);}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},30:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererPixelShader:()=>n});const r="meshUVSpaceRendererPixelShader",s="precision highp float;varying vec2 vDecalTC;uniform sampler2D textureSampler;void main(void) {if (vDecalTC.x<0. || vDecalTC.x>1. || vDecalTC.y<0. || vDecalTC.y>1.) {discard;}\ngl_FragColor=texture2D(textureSampler,vDecalTC);}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},481:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphSetPropertyBlock:()=>o});var r=i(33006),s=i(4720),n=i(56552);class o extends r.w{constructor(e){super(e),this.config=e,this.object=this.registerDataInput("object",s.Vv,e.target),this.value=this.registerDataInput("value",s.Vv),this.propertyName=this.registerDataInput("propertyName",s.Vv,e.propertyName),this.customSetFunction=this.registerDataInput("customSetFunction",s.Vv)}_execute(e,t){try{const t=this.object.getValue(e),i=this.value.getValue(e),r=this.customSetFunction.getValue(e);r?r(t,this.propertyName.getValue(e),i,e):this._setPropertyValue(t,this.propertyName.getValue(e),i)}catch(t){this._reportError(e,t)}this.out._activateSignal(e)}_setPropertyValue(e,t,i){const r=t.split(".");let s=e;for(let e=0;e<r.length-1;e++){const t=r[e];void 0===s[t]&&(s[t]={}),s=s[t]}s[r[r.length-1]]=i}getClassName(){return"FlowGraphSetPropertyBlock"}}(0,n.Y5)("FlowGraphSetPropertyBlock",o)},714:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphMultiGateBlock:()=>a});var r=i(56552),s=i(16972),n=i(4720),o=i(90868);class a extends s.u{constructor(e){super(e),this.config=e,this.outputSignals=[],this.reset=this._registerSignalInput("reset"),this.lastIndex=this.registerDataOutput("lastIndex",n.x2,new o.P(-1)),this.setNumberOfOutputSignals(e?.outputSignalCount)}_getNextIndex(e){if(e.includes(!1)||this.config.isLoop&&e.fill(!1),this.config.isRandom){const t=e.map(((e,t)=>e?-1:t)).filter((e=>-1!==e));return t.length?t[Math.floor(Math.random()*t.length)]:-1}return e.indexOf(!1)}setNumberOfOutputSignals(e=1){for(;this.outputSignals.length>e;){const e=this.outputSignals.pop();e&&(e.disconnectFromAll(),this._unregisterSignalOutput(e.name))}for(;this.outputSignals.length<e;)this.outputSignals.push(this._registerSignalOutput(`out_${this.outputSignals.length}`))}_execute(e,t){if(e._hasExecutionVariable(this,"indexesUsed")||e._setExecutionVariable(this,"indexesUsed",this.outputSignals.map((()=>!1))),t===this.reset)return e._deleteExecutionVariable(this,"indexesUsed"),void this.lastIndex.setValue(new o.P(-1),e);const i=e._getExecutionVariable(this,"indexesUsed",[]),r=this._getNextIndex(i);r>-1&&(this.lastIndex.setValue(new o.P(r),e),i[r]=!0,e._setExecutionVariable(this,"indexesUsed",i),this.outputSignals[r]._activateSignal(e))}getClassName(){return"FlowGraphMultiGateBlock"}serialize(e){super.serialize(e),e.config.outputSignalCount=this.config.outputSignalCount,e.config.isRandom=this.config.isRandom,e.config.loop=this.config.isLoop,e.config.startIndex=this.config.startIndex}}(0,r.Y5)("FlowGraphMultiGateBlock",a)},858:(e,t,i)=>{i.r(t),i.d(t,{hdrIrradianceFilteringVertexShaderWGSL:()=>n});const r="hdrIrradianceFilteringVertexShader",s="attribute position: vec2f;varying direction: vec3f;uniform up: vec3f;uniform right: vec3f;uniform front: vec3f;\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar view: mat3x3f= mat3x3f(uniforms.up,uniforms.right,uniforms.front);vertexOutputs.direction=view*vec3f(input.position,1.0);vertexOutputs.position= vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},861:(e,t,i)=>{i.r(t),i.d(t,{linePixelShader:()=>o});var r=i(69610);i(6194),i(34581),i(29741),i(7412);const s="linePixelShader",n="#include<clipPlaneFragmentDeclaration>\nuniform vec4 color;\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<logDepthFragment>\n#include<clipPlaneFragment>\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},880:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphWaitAllBlock:()=>o});var r=i(33006),s=i(56552),n=i(4720);class o extends r.w{constructor(e){super(e),this.config=e,this.inFlows=[],this._cachedActivationState=[],this.reset=this._registerSignalInput("reset"),this.completed=this._registerSignalOutput("completed"),this.remainingInputs=this.registerDataOutput("remainingInputs",n.Es,this.config.inputSignalCount||0);for(let e=0;e<this.config.inputSignalCount;e++)this.inFlows.push(this._registerSignalInput(`in_${e}`));this._unregisterSignalInput("in")}_getCurrentActivationState(e){const t=this._cachedActivationState;if(t.length=0,e._hasExecutionVariable(this,"activationState")){const i=e._getExecutionVariable(this,"activationState",[]);for(let e=0;e<i.length;e++)t.push(i[e])}else for(let e=0;e<this.config.inputSignalCount;e++)t.push(!1);return t}_execute(e,t){const i=this._getCurrentActivationState(e);if(t===this.reset)for(let e=0;e<this.config.inputSignalCount;e++)i[e]=!1;else{const e=this.inFlows.indexOf(t);e>=0&&(i[e]=!0)}if(this.remainingInputs.setValue(i.filter((e=>!e)).length,e),e._setExecutionVariable(this,"activationState",i.slice()),i.includes(!1))t!==this.reset&&this.out._activateSignal(e);else{this.completed._activateSignal(e);for(let e=0;e<this.config.inputSignalCount;e++)i[e]=!1}}getClassName(){return"FlowGraphWaitAllBlock"}serialize(e){super.serialize(e),e.config.inputFlows=this.config.inputSignalCount}}(0,s.Y5)("FlowGraphWaitAllBlock",o)},1138:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelSlabDebugPixelShaderWGSL:()=>n});const r="iblVoxelSlabDebugPixelShader",s="varying vNormalizedPosition: vec3f;uniform nearPlane: f32;uniform farPlane: f32;uniform stepSize: f32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var normPos: vec3f=input.vNormalizedPosition.xyz;var chunkSize: f32=uniforms.stepSize* f32(MAX_DRAW_BUFFERS);var numChunks: f32=1.0/chunkSize;var positionInChunk: f32=fract(normPos.z/chunkSize);var slab: f32=floor(positionInChunk* f32(MAX_DRAW_BUFFERS)) /\nf32(MAX_DRAW_BUFFERS);if (normPos.x<0.0 || normPos.y<0.0 || normPos.z<0.0 ||\nnormPos.x>1.0 || normPos.y>1.0 || normPos.z>1.0) {fragmentOutputs.color= vec4f(0.0,0.0,0.0,0.0);} else {fragmentOutputs.color= vec4f(slab,0.0,0.0,0.75);}}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},1919:(e,t,i)=>{i.d(t,{G:()=>a});var r=i(99848),s=i(26846),n=i(56744),o=i(77930);class a extends s.Ui{constructor(e,t){super(e,t,3),this._analyzer=null,this._newestInstance=null,this._outBus=null,this._privateInstances=new Set,this._state=1,this._instances=this._privateInstances,this.onEndedObservable=new r.cP,this._onInstanceEnded=e=>{this._newestInstance===e&&(this._newestInstance=null),this._privateInstances.delete(e),0===this._instances.size&&(this._state=1,this.onEndedObservable.notifyObservers(this))},this._onOutBusDisposed=()=>{this.outBus=null}}get analyzer(){return this._analyzer??(this._analyzer=new o.sQ(this._subGraph))}get autoplay(){return this._options.autoplay}get currentTime(){const e=this._getNewestInstance();return e?e.currentTime:0}set currentTime(e){this.startOffset=e;const t=this._getNewestInstance();t&&(t.currentTime=e)}get loop(){return this._options.loop}set loop(e){this._options.loop=e}get maxInstances(){return this._options.maxInstances}set maxInstances(e){this._options.maxInstances=e}get outBus(){return this._outBus}set outBus(e){if(this._outBus!==e){if(this._outBus&&(this._outBus.onDisposeObservable.removeCallback(this._onOutBusDisposed),!this._disconnect(this._outBus)))throw new Error("Disconnect failed");if(this._outBus=e,this._outBus&&(this._outBus.onDisposeObservable.add(this._onOutBusDisposed),!this._connect(this._outBus)))throw new Error("Connect failed")}}get startOffset(){return this._options.startOffset}set startOffset(e){this._options.startOffset=e}get state(){return this._state}get volume(){return(0,n.pN)(this._subGraph,"volume")}set volume(e){const t=(0,n.sf)(this._subGraph);if(!t)throw new Error("No volume subnode");t.volume=e}dispose(){super.dispose(),this.stop(),this._analyzer?.dispose(),this._analyzer=null,this._newestInstance=null,this._outBus=null,this._privateInstances.clear(),this.onEndedObservable.clear()}pause(){const e=this._instances.values();for(let t=e.next();!t.done;t=e.next())t.value.pause();this._state=5}resume(){if(5!==this._state)return;const e=this._instances.values();for(let t=e.next();!t.done;t=e.next())t.value.resume();this._state=3}_beforePlay(e){5===this.state&&this._instances.size>0?this.resume():(e.onEndedObservable.addOnce(this._onInstanceEnded),this._privateInstances.add(e),this._newestInstance=e)}_afterPlay(e){this._state=e.state}_getNewestInstance(){if(0===this._instances.size)return null;if(!this._newestInstance){const e=this._instances.values();for(let t=e.next();!t.done;t=e.next())this._newestInstance=t.value}return this._newestInstance}_setState(e){this._state=e}_stopExcessInstances(){if(this.maxInstances<1/0){const e=Array.from(this._instances).filter((e=>3===e.state)).length-this.maxInstances,t=this._instances.values();for(let i=0;i<e;i++){t.next().value.stop()}}}}},2001:(e,t,i)=>{function r(e){return Math.floor(e/8)}function s(e){return 1<<e%8}i.d(t,{P:()=>n});class n{constructor(e){this.size=e,this._byteArray=new Uint8Array(Math.ceil(this.size/8))}get(e){if(e>=this.size)throw new RangeError("Bit index out of range");const t=r(e),i=s(e);return!!(this._byteArray[t]&i)}set(e,t){if(e>=this.size)throw new RangeError("Bit index out of range");const i=r(e),n=s(e);t?this._byteArray[i]|=n:this._byteArray[i]&=~n}}},2564:(e,t,i)=>{i.r(t),i.d(t,{geometryVertexShaderWGSL:()=>o});var r=i(69610);i(32806),i(98900),i(76340),i(8217),i(44559),i(98327),i(77029),i(18258),i(9129),i(91277),i(65470),i(40242),i(85197),i(87921);const s="geometryVertexShader",n="#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\n#include<sceneUboDeclaration>\n#include<clipPlaneVertexDeclaration>\nattribute position: vec3f;attribute normal: vec3f;\n#ifdef NEED_UV\nvarying vUV: vec2f;\n#ifdef ALPHATEST\nuniform diffuseMatrix: mat4x4f;\n#endif\n#ifdef BUMP\nuniform bumpMatrix: mat4x4f;varying vBumpUV: vec2f;\n#endif\n#ifdef REFLECTIVITY\nuniform reflectivityMatrix: mat4x4f;uniform albedoMatrix: mat4x4f;varying vReflectivityUV: vec2f;varying vAlbedoUV: vec2f;\n#endif\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#endif\n#ifdef BUMP\nvarying vWorldView0: vec4f;varying vWorldView1: vec4f;varying vWorldView2: vec4f;varying vWorldView3: vec4f;\n#endif\n#ifdef BUMP\nvarying vNormalW: vec3f;\n#else\nvarying vNormalV: vec3f;\n#endif\nvarying vViewPos: vec4f;\n#if defined(POSITION) || defined(BUMP)\nvarying vPositionW: vec3f;\n#endif\n#if defined(VELOCITY) || defined(VELOCITY_LINEAR)\nuniform previousViewProjection: mat4x4f;varying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;var normalUpdated: vec3f=input.normal;\n#ifdef UV1\nvar uvUpdated: vec2f=input.uv;\n#endif\n#ifdef UV2\nvar uv2Updated: vec2f=input.uv2;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld* vec4f(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f= vec4f(finalWorld* vec4f(positionUpdated,1.0));\n#ifdef BUMP\nlet vWorldView=scene.view*finalWorld;vertexOutputs.vWorldView0=vWorldView[0];vertexOutputs.vWorldView1=vWorldView[1];vertexOutputs.vWorldView2=vWorldView[2];vertexOutputs.vWorldView3=vWorldView[3];let normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);vertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);\n#else\n#ifdef NORMAL_WORLDSPACE\nvertexOutputs.vNormalV=normalize((finalWorld* vec4f(normalUpdated,0.0)).xyz);\n#else\nvertexOutputs.vNormalV=normalize(((scene.view*finalWorld)* vec4f(normalUpdated,0.0)).xyz);\n#endif\n#endif\nvertexOutputs.vViewPos=scene.view*worldPos;\n#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)\nvertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld* vec4f(positionUpdated,1.0);\n#if NUM_BONE_INFLUENCERS>0\nvar previousInfluence: mat4x4f;previousInfluence=mPreviousBones[ i32(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[ i32(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[ i32(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[ i32(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*previousInfluence* vec4f(positionUpdated,1.0);\n#else\nvertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld* vec4f(positionUpdated,1.0);\n#endif\n#endif\n#if defined(POSITION) || defined(BUMP)\nvertexOutputs.vPositionW=worldPos.xyz/worldPos.w;\n#endif\nvertexOutputs.position=scene.viewProjection*finalWorld* vec4f(positionUpdated,1.0);\n#include<clipPlaneVertex>\n#ifdef NEED_UV\n#ifdef UV1\n#if defined(ALPHATEST) && defined(ALPHATEST_UV1)\nvertexOutputs.vUV=(uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#else\nvertexOutputs.vUV=uvUpdated;\n#endif\n#ifdef BUMP_UV1\nvertexOutputs.vBumpUV=(uniforms.bumpMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef REFLECTIVITY_UV1\nvertexOutputs.vReflectivityUV=(uniforms.reflectivityMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef ALBEDO_UV1\nvertexOutputs.vAlbedoUV=(uniforms.albedoMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#endif\n#ifdef UV2\n#if defined(ALPHATEST) && defined(ALPHATEST_UV2)\nvertexOutputs.vUV=(uniforms.diffuseMatrix* vec4f(uv2Updated,1.0,0.0)).xy;\n#else\nvertexOutputs.vUV=uv2Updated;\n#endif\n#ifdef BUMP_UV2\nvertexOutputs.vBumpUV=(uniforms.bumpMatrix* vec4f(uv2Updated,1.0,0.0)).xy;\n#endif\n#ifdef REFLECTIVITY_UV2\nvertexOutputs.vReflectivityUV=(uniforms.reflectivityMatrix* vec4f(uv2Updated,1.0,0.0)).xy;\n#endif\n#ifdef ALBEDO_UV2\nvertexOutputs.vAlbedoUV=(uniforms.albedoMatrix* vec4f(uv2Updated,1.0,0.0)).xy;\n#endif\n#endif\n#endif\n#include<bumpVertex>\n}\n";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},2641:(e,t,i)=>{i.r(t),i.d(t,{outlinePixelShader:()=>o});var r=i(69610);i(6194),i(34581),i(7412),i(29741);const s="outlinePixelShader",n="#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nuniform vec4 color;\n#ifdef ALPHATEST\nvarying vec2 vUV;uniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#include<logDepthFragment>\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},2730:(e,t,i)=>{i.r(t),i.d(t,{iblShadowDebugPixelShaderWGSL:()=>n});const r="iblShadowDebugPixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var debugSamplerSampler: sampler;var debugSampler: texture_2d<f32>;uniform sizeParams: vec4f;\n#define offsetX uniforms.sizeParams.x\n#define offsetY uniforms.sizeParams.y\n#define widthScale uniforms.sizeParams.z\n#define heightScale uniforms.sizeParams.w\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f =\nvec2f((offsetX+fragmentInputs.vUV.x)*widthScale,(offsetY+fragmentInputs.vUV.y)*heightScale);var background: vec4f=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.vUV);var debugColour: vec4f=textureSample(debugSampler,debugSamplerSampler,fragmentInputs.vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {fragmentOutputs.color=background;} else {fragmentOutputs.color=vec4f(mix(debugColour.rgb,background.rgb,0.0),1.0);}}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},3126:(e,t,i)=>{i.r(t),i.d(t,{EasingFunctionType:()=>r,FlowGraphEasingBlock:()=>l});var r,s=i(15321),n=i(71294),o=i(4720),a=i(56552);!function(e){e[e.CircleEase=0]="CircleEase",e[e.BackEase=1]="BackEase",e[e.BounceEase=2]="BounceEase",e[e.CubicEase=3]="CubicEase",e[e.ElasticEase=4]="ElasticEase",e[e.ExponentialEase=5]="ExponentialEase",e[e.PowerEase=6]="PowerEase",e[e.QuadraticEase=7]="QuadraticEase",e[e.QuarticEase=8]="QuarticEase",e[e.QuinticEase=9]="QuinticEase",e[e.SineEase=10]="SineEase",e[e.BezierCurveEase=11]="BezierCurveEase"}(r||(r={}));class l extends n.e{constructor(e){super(e),this.config=e,this._easingFunctions={},this.type=this.registerDataInput("type",o.Vv,11),this.mode=this.registerDataInput("mode",o.Es,0),this.parameters=this.registerDataInput("parameters",o.Vv,[1,0,0,1]),this.easingFunction=this.registerDataOutput("easingFunction",o.Vv)}_updateOutputs(e){const t=this.type.getValue(e),i=this.mode.getValue(e),r=this.parameters.getValue(e);if(void 0===t||void 0===i)return;const n=`${t}-${i}-${r.join("-")}`;if(!this._easingFunctions[n]){const e=function(e,...t){switch(e){case 11:return new s.Bv(...t);case 0:return new s.rm;case 1:return new s.kL(...t);case 2:return new s.ND(...t);case 3:return new s.vm;case 4:return new s._B(...t);case 5:return new s.E8(...t);default:throw new Error("Easing type not yet implemented")}}(t,...r);e.setEasingMode(i),this._easingFunctions[n]=e}this.easingFunction.setValue(this._easingFunctions[n],e)}getClassName(){return"FlowGraphEasingBlock"}}(0,a.Y5)("FlowGraphEasingBlock",l)},3157:(e,t,i)=>{i.r(t),i.d(t,{rsmGlobalIlluminationPixelShader:()=>n});const r="rsmGlobalIlluminationPixelShader",s="/**\n* The implementation is an application of the formula found in http:\n* For better results,it also adds a random (noise) rotation to the RSM samples (the noise artifacts are easier to remove than the banding artifacts).\n*/\nprecision highp float;varying vec2 vUV;uniform mat4 rsmLightMatrix;uniform vec4 rsmInfo;uniform vec4 rsmInfo2;uniform sampler2D textureSampler;uniform sampler2D normalSampler;uniform sampler2D rsmPositionW;uniform sampler2D rsmNormalW;uniform sampler2D rsmFlux;uniform sampler2D rsmSamples;\n#ifdef TRANSFORM_NORMAL\nuniform mat4 invView;\n#endif\nfloat mod289(float x){return x-floor(x*(1.0/289.0))*289.0;}\nvec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}\nvec4 perm(vec4 x){return mod289(((x*34.0)+1.0)*x);}\nfloat noise(vec3 p){vec3 a=floor(p);vec3 d=p-a;d=d*d*(3.0-2.0*d);vec4 b=a.xxyy+vec4(0.0,1.0,0.0,1.0);vec4 k1=perm(b.xyxy);vec4 k2=perm(k1.xyxy+b.zzww);vec4 c=k2+a.zzzz;vec4 k3=perm(c);vec4 k4=perm(c+1.0);vec4 o1=fract(k3*(1.0/41.0));vec4 o2=fract(k4*(1.0/41.0));vec4 o3=o2*d.z+o1*(1.0-d.z);vec2 o4=o3.yw*d.x+o3.xz*(1.0-d.x);return o4.y*d.y+o4.x*(1.0-d.y);}\nvec3 computeIndirect(vec3 p,vec3 n) {vec3 indirectDiffuse=vec3(0.);int numSamples=int(rsmInfo.x);float radius=rsmInfo.y;float intensity=rsmInfo.z;float edgeArtifactCorrection=rsmInfo.w;vec4 texRSM=rsmLightMatrix*vec4(p,1.);texRSM.xy/=texRSM.w;texRSM.xy=texRSM.xy*0.5+0.5;float angle=noise(p*rsmInfo2.x);float c=cos(angle);float s=sin(angle);for (int i=0; i<numSamples; i++) {vec3 rsmSample=texelFetch(rsmSamples,ivec2(i,0),0).xyz;float weightSquare=rsmSample.z;if (rsmInfo2.y==1.0) rsmSample.xy=vec2(rsmSample.x*c+rsmSample.y*s,-rsmSample.x*s+rsmSample.y*c);vec2 uv=texRSM.xy+rsmSample.xy*radius;if (uv.x<0. || uv.x>1. || uv.y<0. || uv.y>1.) continue;vec3 vplPositionW=textureLod(rsmPositionW,uv,0.).xyz;vec3 vplNormalW=textureLod(rsmNormalW,uv,0.).xyz*2.0-1.0;vec3 vplFlux=textureLod(rsmFlux,uv,0.).rgb;vplPositionW-=vplNormalW*edgeArtifactCorrection; \nfloat dist2=dot(vplPositionW-p,vplPositionW-p);indirectDiffuse+=vplFlux*weightSquare*max(0.,dot(n,vplPositionW-p))*max(0.,dot(vplNormalW,p-vplPositionW))/(dist2*dist2);}\nreturn clamp(indirectDiffuse*intensity,0.0,1.0);}\nvoid main(void) \n{vec3 positionW=texture2D(textureSampler,vUV).xyz;vec3 normalW=texture2D(normalSampler,vUV).xyz;\n#ifdef DECODE_NORMAL\nnormalW=normalW*2.0-1.0;\n#endif\n#ifdef TRANSFORM_NORMAL\nnormalW=(invView*vec4(normalW,0.)).xyz;\n#endif\ngl_FragColor.rgb=computeIndirect(positionW,normalW);gl_FragColor.a=1.0;}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},3399:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingRenderPixelShader:()=>n});const r="fluidRenderingRenderPixelShader",s="#define DISABLE_UNIFORMITY_ANALYSIS\n#define IOR 1.333\n#define ETA 1.0/IOR\n#define F0 0.02\nuniform sampler2D textureSampler;uniform sampler2D depthSampler;\n#ifdef FLUIDRENDERING_DIFFUSETEXTURE\nuniform sampler2D diffuseSampler;\n#else\nuniform vec3 diffuseColor;\n#endif\n#ifdef FLUIDRENDERING_FIXED_THICKNESS\nuniform float thickness;uniform sampler2D bgDepthSampler;\n#else\nuniform float minimumThickness;uniform sampler2D thicknessSampler;\n#endif\n#ifdef FLUIDRENDERING_ENVIRONMENT\nuniform samplerCube reflectionSampler;\n#endif\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)\nuniform sampler2D debugSampler;\n#endif\nuniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform mat4 invProjectionMatrix;uniform vec2 texelSize;uniform vec3 dirLight;uniform float cameraFar;uniform float density;uniform float refractionStrength;uniform float fresnelClamp;uniform float specularPower;varying vec2 vUV;vec3 computeViewPosFromUVDepth(vec2 texCoord,float depth) {vec4 ndc;ndc.xy=texCoord*2.0-1.0;\n#ifdef FLUIDRENDERING_RHS\nndc.z=-projectionMatrix[2].z+projectionMatrix[3].z/depth;\n#else\nndc.z=projectionMatrix[2].z+projectionMatrix[3].z/depth;\n#endif\nndc.w=1.0;vec4 eyePos=invProjectionMatrix*ndc;eyePos.xyz/=eyePos.w;return eyePos.xyz;}\nvec3 getViewPosFromTexCoord(vec2 texCoord) {float depth=textureLod(depthSampler,texCoord,0.).x;return computeViewPosFromUVDepth(texCoord,depth);}\nvoid main(void) {vec2 texCoord=vUV;\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)\nvec4 color=texture2D(debugSampler,texCoord);\n#ifdef FLUIDRENDERING_DEBUG_DEPTH\nglFragColor=vec4(color.rgb/vec3(2.0),1.);if (color.r>0.999 && color.g>0.999) {glFragColor=texture2D(textureSampler,texCoord);}\n#else\nglFragColor=vec4(color.rgb,1.);if (color.r<0.001 && color.g<0.001 && color.b<0.001) {glFragColor=texture2D(textureSampler,texCoord);}\n#endif\nreturn;\n#endif\nvec2 depthVel=textureLod(depthSampler,texCoord,0.).rg;float depth=depthVel.r;\n#ifndef FLUIDRENDERING_FIXED_THICKNESS\nfloat thickness=texture2D(thicknessSampler,texCoord).x;\n#else\nfloat bgDepth=texture2D(bgDepthSampler,texCoord).x;float depthNonLinear=projectionMatrix[2].z+projectionMatrix[3].z/depth;depthNonLinear=depthNonLinear*0.5+0.5;\n#endif\nvec4 backColor=texture2D(textureSampler,texCoord);\n#ifndef FLUIDRENDERING_FIXED_THICKNESS\nif (depth>=cameraFar || depth<=0. || thickness<=minimumThickness) {\n#else\nif (depth>=cameraFar || depth<=0. || bgDepth<=depthNonLinear) {\n#endif\n#ifdef FLUIDRENDERING_COMPOSITE_MODE\nglFragColor.rgb=backColor.rgb*backColor.a;glFragColor.a=backColor.a;\n#else\nglFragColor=backColor;\n#endif\nreturn;}\nvec3 viewPos=computeViewPosFromUVDepth(texCoord,depth);vec3 ddx=getViewPosFromTexCoord(texCoord+vec2(texelSize.x,0.))-viewPos;vec3 ddy=getViewPosFromTexCoord(texCoord+vec2(0.,texelSize.y))-viewPos;vec3 ddx2=viewPos-getViewPosFromTexCoord(texCoord+vec2(-texelSize.x,0.));if (abs(ddx.z)>abs(ddx2.z)) {ddx=ddx2;}\nvec3 ddy2=viewPos-getViewPosFromTexCoord(texCoord+vec2(0.,-texelSize.y));if (abs(ddy.z)>abs(ddy2.z)) {ddy=ddy2;}\nvec3 normal=normalize(cross(ddy,ddx));\n#ifdef FLUIDRENDERING_RHS\nnormal=-normal;\n#endif\n#ifndef WEBGPU\nif(isnan(normal.x) || isnan(normal.y) || isnan(normal.z) || isinf(normal.x) || isinf(normal.y) || isinf(normal.z)) {normal=vec3(0.,0.,-1.);}\n#endif\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_SHOWNORMAL)\nglFragColor=vec4(normal*0.5+0.5,1.0);return;\n#endif\nvec3 rayDir=normalize(viewPos); \n#ifdef FLUIDRENDERING_DIFFUSETEXTURE\nvec3 diffuseColor=textureLod(diffuseSampler,texCoord,0.0).rgb;\n#endif\nvec3 lightDir=normalize(vec3(viewMatrix*vec4(-dirLight,0.)));vec3 H =normalize(lightDir-rayDir);float specular=pow(max(0.0,dot(H,normal)),specularPower);\n#ifdef FLUIDRENDERING_DEBUG_DIFFUSERENDERING\nfloat diffuse =max(0.0,dot(lightDir,normal))*1.0;glFragColor=vec4(vec3(0.1) /*ambient*/+vec3(0.42,0.50,1.00)*diffuse+vec3(0,0,0.2)+specular,1.);return;\n#endif\nvec3 refractionDir=refract(rayDir,normal,ETA);vec4 transmitted=textureLod(textureSampler,vec2(texCoord+refractionDir.xy*thickness*refractionStrength),0.0);\n#ifdef FLUIDRENDERING_COMPOSITE_MODE\nif (transmitted.a==0.) transmitted.a=thickness;\n#endif\nvec3 transmittance=exp(-density*thickness*(1.0-diffuseColor)); \nvec3 refractionColor=transmitted.rgb*transmittance;\n#ifdef FLUIDRENDERING_ENVIRONMENT\nvec3 reflectionDir=reflect(rayDir,normal);vec3 reflectionColor=(textureCube(reflectionSampler,reflectionDir).rgb);float fresnel=clamp(F0+(1.0-F0)*pow(1.0-dot(normal,-rayDir),5.0),0.,fresnelClamp);vec3 finalColor=mix(refractionColor,reflectionColor,fresnel)+specular;\n#else\nvec3 finalColor=refractionColor+specular;\n#endif\n#ifdef FLUIDRENDERING_VELOCITY\nfloat velocity=depthVel.g;finalColor=mix(finalColor,vec3(1.0),smoothstep(0.3,1.0,velocity/6.0));\n#endif\nglFragColor=vec4(finalColor,transmitted.a);}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},3414:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelGridPixelShader:()=>n});const r="iblVoxelGridPixelShader",s="precision highp float;layout(location=0) out highp float glFragData[MAX_DRAW_BUFFERS];varying vec3 vNormalizedPosition;uniform float nearPlane;uniform float farPlane;uniform float stepSize;void main(void) {vec3 normPos=vNormalizedPosition.xyz;if (normPos.z<nearPlane || normPos.z>farPlane) {discard;}\nglFragData[0]=normPos.z<nearPlane+stepSize ? 1.0 : 0.0;glFragData[1]=normPos.z>=nearPlane+stepSize && normPos.z<nearPlane+2.0*stepSize ? 1.0 : 0.0;glFragData[2]=normPos.z>=nearPlane+2.0*stepSize && normPos.z<nearPlane+3.0*stepSize ? 1.0 : 0.0;glFragData[3]=normPos.z>=nearPlane+3.0*stepSize && normPos.z<nearPlane+4.0*stepSize ? 1.0 : 0.0;\n#if MAX_DRAW_BUFFERS>4\nglFragData[4]=normPos.z>=nearPlane+4.0*stepSize && normPos.z<nearPlane+5.0*stepSize ? 1.0 : 0.0;glFragData[5]=normPos.z>=nearPlane+5.0*stepSize && normPos.z<nearPlane+6.0*stepSize ? 1.0 : 0.0;glFragData[6]=normPos.z>=nearPlane+6.0*stepSize && normPos.z<nearPlane+7.0*stepSize ? 1.0 : 0.0;glFragData[7]=normPos.z>=nearPlane+7.0*stepSize && normPos.z<nearPlane+8.0*stepSize ? 1.0 : 0.0;\n#endif\n}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},3613:(e,t,i)=>{i.r(t),i.d(t,{lodPixelShaderWGSL:()=>n});const r="lodPixelShader",s="const GammaEncodePowerApprox=1.0/2.2;varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform lod: f32;uniform gamma: i32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,fragmentInputs.vUV,uniforms.lod);if (uniforms.gamma==0) {fragmentOutputs.color=vec4f(pow(fragmentOutputs.color.rgb,vec3f(GammaEncodePowerApprox)),fragmentOutputs.color.a);}}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},3934:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleDepthPixelShader:()=>n});const r="fluidRenderingParticleDepthPixelShader",s="uniform mat4 projection;varying vec2 uv;varying vec3 viewPos;varying float sphereRadius;\n#ifdef FLUIDRENDERING_VELOCITY\nvarying float velocityNorm;\n#endif\nvoid main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;normal.z=sqrt(1.0-r2);\n#ifndef FLUIDRENDERING_RHS\nnormal.z=-normal.z;\n#endif\nvec4 realViewPos=vec4(viewPos+normal*sphereRadius,1.0);vec4 clipSpacePos=projection*realViewPos;\n#ifdef WEBGPU\ngl_FragDepth=clipSpacePos.z/clipSpacePos.w;\n#else\ngl_FragDepth=(clipSpacePos.z/clipSpacePos.w)*0.5+0.5;\n#endif\n#ifdef FLUIDRENDERING_RHS\nrealViewPos.z=-realViewPos.z;\n#endif\n#ifdef FLUIDRENDERING_VELOCITY\nglFragColor=vec4(realViewPos.z,velocityNorm,0.,1.);\n#else\nglFragColor=vec4(realViewPos.z,0.,0.,1.);\n#endif\n}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},3996:(e,t,i)=>{i.r(t),i.d(t,{blackAndWhitePixelShader:()=>n});const r="blackAndWhitePixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;uniform float degree;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec3 color=texture2D(textureSampler,vUV).rgb;float luminance=dot(color,vec3(0.3,0.59,0.11)); \nvec3 blackAndWhite=vec3(luminance,luminance,luminance);gl_FragColor=vec4(color-((color-blackAndWhite)*degree),1.0);}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},4044:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererMaskerPixelShaderWGSL:()=>n});const r="meshUVSpaceRendererMaskerPixelShader",s="varying vUV: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color= vec4f(1.0,1.0,1.0,1.0);}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},4511:(e,t,i)=>{i.r(t),i.d(t,{passCubePixelShader:()=>n});const r="passCubePixelShader",s="varying vec2 vUV;uniform samplerCube textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec2 uv=vUV*2.0-1.0;\n#ifdef POSITIVEX\ngl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));\n#endif\n#ifdef NEGATIVEX\ngl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));\n#endif\n#ifdef POSITIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));\n#endif\n#ifdef NEGATIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));\n#endif\n#ifdef POSITIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,1.001));\n#endif\n#ifdef NEGATIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));\n#endif\n}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},5216:(e,t,i)=>{i.r(t),i.d(t,{colorVertexShader:()=>o});var r=i(69610);i(69707),i(18959),i(71636),i(86560),i(1218),i(3298),i(3361),i(65523),i(47314),i(16470),i(94483);const s="colorVertexShader",n="attribute vec3 position;\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#ifdef FOG\nuniform mat4 view;\n#endif\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#ifdef VERTEXCOLOR\nvec4 colorUpdated=color;\n#endif\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(position,1.0);\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<vertexColorMixing>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},5499:(e,t,i)=>{i.r(t),i.d(t,{fxaaPixelShader:()=>n});const r="fxaaPixelShader",s="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\nuniform sampler2D textureSampler;uniform vec2 texelSize;varying vec2 vUV;varying vec2 sampleCoordS;varying vec2 sampleCoordE;varying vec2 sampleCoordN;varying vec2 sampleCoordW;varying vec2 sampleCoordNW;varying vec2 sampleCoordSE;varying vec2 sampleCoordNE;varying vec2 sampleCoordSW;const float fxaaQualitySubpix=1.0;const float fxaaQualityEdgeThreshold=0.166;const float fxaaQualityEdgeThresholdMin=0.0833;const vec3 kLumaCoefficients=vec3(0.2126,0.7152,0.0722);\n#define FxaaLuma(rgba) dot(rgba.rgb,kLumaCoefficients)\nvoid main(){vec2 posM;posM.x=vUV.x;posM.y=vUV.y;vec4 rgbyM=TEXTUREFUNC(textureSampler,vUV,0.0);float lumaM=FxaaLuma(rgbyM);float lumaS=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordS,0.0));float lumaE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordE,0.0));float lumaN=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordN,0.0));float lumaW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordW,0.0));float maxSM=max(lumaS,lumaM);float minSM=min(lumaS,lumaM);float maxESM=max(lumaE,maxSM);float minESM=min(lumaE,minSM);float maxWN=max(lumaN,lumaW);float minWN=min(lumaN,lumaW);float rangeMax=max(maxWN,maxESM);float rangeMin=min(minWN,minESM);float rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;float range=rangeMax-rangeMin;float rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);\n#ifndef MALI\nif(range<rangeMaxClamped) \n{gl_FragColor=rgbyM;return;}\n#endif\nfloat lumaNW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNW,0.0));float lumaSE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSE,0.0));float lumaNE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNE,0.0));float lumaSW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSW,0.0));float lumaNS=lumaN+lumaS;float lumaWE=lumaW+lumaE;float subpixRcpRange=1.0/range;float subpixNSWE=lumaNS+lumaWE;float edgeHorz1=(-2.0*lumaM)+lumaNS;float edgeVert1=(-2.0*lumaM)+lumaWE;float lumaNESE=lumaNE+lumaSE;float lumaNWNE=lumaNW+lumaNE;float edgeHorz2=(-2.0*lumaE)+lumaNESE;float edgeVert2=(-2.0*lumaN)+lumaNWNE;float lumaNWSW=lumaNW+lumaSW;float lumaSWSE=lumaSW+lumaSE;float edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);float edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);float edgeHorz3=(-2.0*lumaW)+lumaNWSW;float edgeVert3=(-2.0*lumaS)+lumaSWSE;float edgeHorz=abs(edgeHorz3)+edgeHorz4;float edgeVert=abs(edgeVert3)+edgeVert4;float subpixNWSWNESE=lumaNWSW+lumaNESE;float lengthSign=texelSize.x;bool horzSpan=edgeHorz>=edgeVert;float subpixA=subpixNSWE*2.0+subpixNWSWNESE;if (!horzSpan)\n{lumaN=lumaW;}\nif (!horzSpan) \n{lumaS=lumaE;}\nif (horzSpan) \n{lengthSign=texelSize.y;}\nfloat subpixB=(subpixA*(1.0/12.0))-lumaM;float gradientN=lumaN-lumaM;float gradientS=lumaS-lumaM;float lumaNN=lumaN+lumaM;float lumaSS=lumaS+lumaM;bool pairN=abs(gradientN)>=abs(gradientS);float gradient=max(abs(gradientN),abs(gradientS));if (pairN)\n{lengthSign=-lengthSign;}\nfloat subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);vec2 posB;posB.x=posM.x;posB.y=posM.y;vec2 offNP;offNP.x=(!horzSpan) ? 0.0 : texelSize.x;offNP.y=(horzSpan) ? 0.0 : texelSize.y;if (!horzSpan) \n{posB.x+=lengthSign*0.5;}\nif (horzSpan)\n{posB.y+=lengthSign*0.5;}\nvec2 posN;posN.x=posB.x-offNP.x*1.5;posN.y=posB.y-offNP.y*1.5;vec2 posP;posP.x=posB.x+offNP.x*1.5;posP.y=posB.y+offNP.y*1.5;float subpixD=((-2.0)*subpixC)+3.0;float lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN,0.0));float subpixE=subpixC*subpixC;float lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP,0.0));if (!pairN) \n{lumaNN=lumaSS;}\nfloat gradientScaled=gradient*1.0/4.0;float lumaMM=lumaM-lumaNN*0.5;float subpixF=subpixD*subpixE;bool lumaMLTZero=lumaMM<0.0;lumaEndN-=lumaNN*0.5;lumaEndP-=lumaNN*0.5;bool doneN=abs(lumaEndN)>=gradientScaled;bool doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) \n{posN.x-=offNP.x*3.0;}\nif (!doneN) \n{posN.y-=offNP.y*3.0;}\nbool doneNP=(!doneN) || (!doneP);if (!doneP) \n{posP.x+=offNP.x*3.0;}\nif (!doneP)\n{posP.y+=offNP.y*3.0;}\nif (doneNP)\n{if (!doneN) lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN.xy,0.0));if (!doneP) lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP.xy,0.0));if (!doneN) lumaEndN=lumaEndN-lumaNN*0.5;if (!doneP) lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) posN.x-=offNP.x*12.0;if (!doneN) posN.y-=offNP.y*12.0;doneNP=(!doneN) || (!doneP);if (!doneP) posP.x+=offNP.x*12.0;if (!doneP) posP.y+=offNP.y*12.0;}\nfloat dstN=posM.x-posN.x;float dstP=posP.x-posM.x;if (!horzSpan)\n{dstN=posM.y-posN.y;}\nif (!horzSpan) \n{dstP=posP.y-posM.y;}\nbool goodSpanN=(lumaEndN<0.0) != lumaMLTZero;float spanLength=(dstP+dstN);bool goodSpanP=(lumaEndP<0.0) != lumaMLTZero;float spanLengthRcp=1.0/spanLength;bool directionN=dstN<dstP;float dst=min(dstN,dstP);bool goodSpan=directionN ? goodSpanN : goodSpanP;float subpixG=subpixF*subpixF;float pixelOffset=(dst*(-spanLengthRcp))+0.5;float subpixH=subpixG*fxaaQualitySubpix;float pixelOffsetGood=goodSpan ? pixelOffset : 0.0;float pixelOffsetSubpix=max(pixelOffsetGood,subpixH);if (!horzSpan)\n{posM.x+=pixelOffsetSubpix*lengthSign;}\nif (horzSpan)\n{posM.y+=pixelOffsetSubpix*lengthSign;}\n#ifdef MALI\nif(range<rangeMaxClamped) \n{gl_FragColor=rgbyM;}\nelse\n{gl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);}\n#else\ngl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);\n#endif\n}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},5543:(e,t,i)=>{i.r(t),i.d(t,{packingFunctionsWGSL:()=>n});const r="packingFunctions",s="fn pack(depth: f32)->vec4f\n{const bit_shift: vec4f= vec4f(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const bit_mask: vec4f= vec4f(0.0,1.0/255.0,1.0/255.0,1.0/255.0);var res: vec4f=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\nfn unpack(color: vec4f)->f32\n{const bit_shift: vec4f= vec4f(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}";i(69610).l.IncludesShadersStoreWGSL[r]=s;const n={name:r,shader:s}},5823:(e,t,i)=>{i.r(t),i.d(t,{lensFlarePixelShader:()=>n});const r="lensFlarePixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec4 color;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);gl_FragColor=baseColor*color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},5972:(e,t,i)=>{i.r(t),i.d(t,{AbortError:()=>jo.lc,AbstractActionManager:()=>r.G,AbstractAssetContainer:()=>W.CA,AbstractAssetTask:()=>EP,AbstractAudioAnalyzer:()=>fe.zx,AbstractAudioBus:()=>K.t,AbstractAudioNode:()=>J.f0,AbstractEngine:()=>$.$,AbstractMesh:()=>Ps.u,AbstractNamedAudioNode:()=>J.Ui,AbstractSound:()=>ee.G,AbstractSpatialAudio:()=>_e.lA,AbstractSpatialAudioListener:()=>ve,AbstractStereoAudio:()=>ye.bO,AcquireNativeObjectAsync:()=>sa,Action:()=>l,ActionEvent:()=>h.X,ActionManager:()=>A,AddAnimationExtensions:()=>O.SM,AddBlock:()=>Yg,AddIndividualParser:()=>Ep.cf,AddParser:()=>Ep.ji,AddRayExtensions:()=>st.AddRayExtensions,AddressMode:()=>_a.Ap,AdvancedTimer:()=>mp.Qz,Aggregations:()=>By,AggregatorBlock:()=>aP,AlignBlock:()=>gy,AlphaState:()=>VO.i,AmmoJSPlugin:()=>Cm,AnaglyphArcRotateCamera:()=>zi,AnaglyphFreeCamera:()=>Ui,AnaglyphGamepadCamera:()=>Wi,AnaglyphPostProcess:()=>ki,AnaglyphUniversalCamera:()=>Hi,Analyser:()=>q,AndOrNotEvaluator:()=>CP.Z,Angle:()=>ku.uM,Animatable:()=>O.rT,AnimatedInputBlockTypes:()=>yd,Animation:()=>M.X5,AnimationAssetTask:()=>MP,AnimationEvent:()=>V.p,AnimationGroup:()=>L.AnimationGroup,AnimationGroupMask:()=>U,AnimationGroupMaskMode:()=>k,AnimationKeyInterpolation:()=>w,AnimationPropertiesOverride:()=>N,AnimationRange:()=>G.K,AnisotropyBlock:()=>Fx,AppendSceneAsync:()=>sd.xc,ApplyLut:()=>Df.Kq,ApplyPostProcess:()=>Vy.Qs,Arc2:()=>ku.Xy,ArcFollowCamera:()=>bi,ArcRotateCamera:()=>fi.Lq,ArcRotateCameraGamepadInput:()=>Ut,ArcRotateCameraInputsManager:()=>qt.H,ArcRotateCameraKeyboardMoveInput:()=>Wt.n,ArcRotateCameraMouseWheelInput:()=>Ht.f,ArcRotateCameraPointersInput:()=>$t.L,ArcRotateCameraVRDeviceOrientationInput:()=>Yt,ArcTan2Block:()=>gx,AreIndices32Bits:()=>Nt.Lm,AreaLight:()=>dm,AssetContainer:()=>W.WZ,AssetTaskState:()=>hP,AssetsManager:()=>LP,AssetsProgressEvent:()=>AP,AsyncLock:()=>PC.m,AsyncLoop:()=>H.LV,AttachToBoxBehavior:()=>Je,AudioBus:()=>te.l,AudioEngine:()=>Y.L,AudioEngineV2:()=>se,AudioNodeType:()=>J.D9,AudioSceneComponent:()=>X.Y,AutoLayoutMode:()=>_a.$_,AutoReleaseWorkerPool:()=>lT.h,AutoRotationBehavior:()=>je.A,AxesViewer:()=>Bs,Axis:()=>ku._0,AxisDragGizmo:()=>Fs,AxisScaleGizmo:()=>Eu,BRDFTextureTools:()=>wx.J,BabylonFileLoaderConfiguration:()=>wm,BackEase:()=>F.kL,BackgroundMaterial:()=>Yu,BakedVertexAnimationManager:()=>We,BallAndSocketConstraint:()=>WE,BaseCameraMouseWheelInput:()=>Bt.l,BaseCameraPointersInput:()=>Vt.R,BaseError:()=>jo.Cf,BaseParticleSystem:()=>qd,BaseSixDofDragBehavior:()=>_t,BaseTexture:()=>zu.t,BasisFileInfo:()=>kP.$e,BasisTools:()=>kP.ED,BasisToolsOptions:()=>kP.Sl,BasisTranscodeConfiguration:()=>kP.SV,BezierCurve:()=>ku.vr,BezierCurveEase:()=>F.Bv,BiPlanarBlock:()=>Jx,BinaryFileAssetTask:()=>OP,BindBonesParameters:()=>ts.f$,BindFogParameters:()=>ts.Yy,BindLight:()=>ts.Kd,BindLightProperties:()=>ts.L0,BindLights:()=>ts.RL,BindLogDepth:()=>ts.DL,BindMorphTargetParameters:()=>ts.nR,BindSceneUniformBuffer:()=>ts._8,BindTextureMatrix:()=>ts.mA,BitArray:()=>TC.P,BlackAndWhitePostProcess:()=>yA,BlendFactor:()=>_a.dn,BlendOperation:()=>_a.Tb,BloomEffect:()=>EA,BloomMergePostProcess:()=>CA,BlurPostProcess:()=>Ch,Bone:()=>At.$,BoneAxesViewer:()=>Vs,BoneIKController:()=>It,BoneLookController:()=>Dt,BonesBlock:()=>__,BooleanGeometryBlock:()=>zy,BooleanGeometryOperations:()=>Ny,BounceEase:()=>F.ND,BouncingBehavior:()=>Ze.W,BoundingBlock:()=>Gy,BoundingBox:()=>ms.I,BoundingBoxGizmo:()=>Iu,BoundingBoxRenderer:()=>WR,BoundingInfo:()=>fs.j,BoundingInfoHelper:()=>_s,BoundingSphere:()=>vs.i,BoxBlock:()=>Ob,BoxBuilder:()=>ks.Jo,BoxParticleEmitter:()=>RT,Buffer:()=>Ot.h,BufferBindingType:()=>_a.Yl,BufferMapState:()=>_a.GU,BufferUsage:()=>_a.Sd,CSG:()=>bS,CSG2:()=>sb,Camera:()=>ft.i,CameraGizmo:()=>Gu,CameraInputTypes:()=>Lt.H,CameraInputsManager:()=>Lt._,CannonJSPlugin:()=>Pm,CanvasAlphaMode:()=>_a.Qb,CanvasToneMappingMode:()=>_a.Ag,CapsuleBlock:()=>Ub,CapsuleBuilder:()=>Qs,CascadedShadowGenerator:()=>Uh,CharacterSupportedState:()=>gE,ChromaticAberrationPostProcess:()=>AA,CircleEase:()=>F.rm,CircleOfConfusionPostProcess:()=>IA,ClampBlock:()=>jg,CleanGeometryBlock:()=>sy,ClearCoatBlock:()=>Vx,ClipPlanesBlock:()=>gg,ClipboardEventTypes:()=>Ra,ClipboardInfo:()=>Ma,CloudBlock:()=>jx,CloudPoint:()=>yE.M,Collider:()=>qr,Color3:()=>ku.v9,Color3Gradient:()=>yT,Color4:()=>ku.ov,ColorConverterBlock:()=>sv,ColorCorrectionPostProcess:()=>RA,ColorCurves:()=>Zm.Q,ColorGradient:()=>bT,ColorGradingTexture:()=>xf,ColorMergerBlock:()=>ex,ColorSplitterBlock:()=>Yd,ColorWrite:()=>_a.Vz,CombineAction:()=>y,CompareFunction:()=>_a.MT,CompatibilityOptions:()=>at.p9,CompilationMessageType:()=>_a.$s,CompleteGreasedLineColorTable:()=>ZS,CompleteGreasedLineWidthTable:()=>jS,CompressionCodes:()=>wf.he,ComputeAlpha:()=>fi.m$,ComputeBeta:()=>fi.__,ComputeBindingType:()=>Vo,ComputeEffect:()=>ds,ComputeNormalsBlock:()=>oy,ComputePassTimestampLocation:()=>_a.MW,ComputeShader:()=>ps.H,ComputeShaderBoundingHelper:()=>xs.ComputeShaderBoundingHelper,ComputeShaderParticleSystem:()=>HC,Condition:()=>c,ConditionBlock:()=>Jb,ConditionBlockTests:()=>Pb,ConditionalBlock:()=>Xx,ConditionalBlockConditions:()=>$x,ConeDirectedParticleEmitter:()=>WT,ConeParticleEmitter:()=>UT,Constants:()=>To.Y,ContainerAssetTask:()=>IP,ConversionMode:()=>nh,ConvolutionPostProcess:()=>MA,Coordinate:()=>ku.xp,CopyFloatData:()=>Nt.gs,CopyTextureToTexture:()=>oh,CopyTools:()=>aC.D8,CreateAlignedTypedArray:()=>Nt.oi,CreateAudioBusAsync:()=>oe,CreateAudioEngineAsync:()=>we,CreateBox:()=>ks.an,CreateBoxVertexData:()=>ks.KA,CreateCapsule:()=>Zs,CreateCapsuleVertexData:()=>js,CreateCylinder:()=>Es,CreateCylinderVertexData:()=>Cs,CreateDashedLines:()=>yn,CreateDashedLinesVertexData:()=>vn,CreateDecal:()=>eo,CreateDecoderAsync:()=>Ff.d,CreateDisc:()=>rn,CreateDiscVertexData:()=>tn,CreateEnvTextureAsync:()=>zo.Hx,CreateGeodesic:()=>oo,CreateGoldberg:()=>ho,CreateGoldbergVertexData:()=>lo,CreateGreasedLine:()=>YS,CreateGreasedLineMaterial:()=>qS,CreateGround:()=>Br.km,CreateGroundFromHeightMap:()=>Br.RI,CreateGroundFromHeightMapVertexData:()=>Br.r_,CreateGroundVertexData:()=>Br.EH,CreateHemisphere:()=>Fu,CreateHotSpotQueryForPickingInfo:()=>oS.yJ,CreateIcoSphere:()=>$n,CreateIcoSphereVertexData:()=>Hn,CreateImageBitmapFromSource:()=>Ia.kF,CreateIrradianceImageDataArrayBufferViews:()=>zo.Pu,CreateLathe:()=>Vn,CreateLineSystem:()=>Sn,CreateLineSystemVertexData:()=>xn,CreateLines:()=>bn,CreateMainAudioBusAsync:()=>ae,CreatePickingRay:()=>st.CreatePickingRay,CreatePickingRayInCameraSpace:()=>st.CreatePickingRayInCameraSpace,CreatePickingRayInCameraSpaceToRef:()=>st.CreatePickingRayInCameraSpaceToRef,CreatePickingRayToRef:()=>st.CreatePickingRayToRef,CreatePlane:()=>ht,CreatePlaneVertexData:()=>lt,CreatePolygon:()=>Mn,CreatePolygonVertexData:()=>Rn,CreatePolyhedron:()=>Un,CreatePolyhedronVertexData:()=>zn,CreateRadianceImageDataArrayBufferViews:()=>zo.ux,CreateResizedCopy:()=>Vy.EE,CreateRibbon:()=>Js,CreateRibbonVertexData:()=>Ks,CreateScreenshot:()=>dT,CreateScreenshotAsync:()=>pT,CreateScreenshotUsingRenderTarget:()=>fT,CreateScreenshotUsingRenderTargetAsync:()=>_T,CreateScreenshotWithResizeAsync:()=>mT,CreateSegmentedBoxVertexData:()=>ks.G$,CreateSoundAsync:()=>le,CreateSoundBufferAsync:()=>he,CreateSphere:()=>zs,CreateSphereVertexData:()=>Gs,CreateStreamingSoundAsync:()=>ce,CreateText:()=>mo,CreateTextShapePaths:()=>po,CreateTiledBox:()=>hn,CreateTiledBoxVertexData:()=>ln,CreateTiledGround:()=>Br.ol,CreateTiledGroundVertexData:()=>Br.k,CreateTiledPlane:()=>on,CreateTiledPlaneVertexData:()=>nn,CreateTorus:()=>Lr,CreateTorusKnot:()=>dn,CreateTorusKnotVertexData:()=>un,CreateTorusVertexData:()=>Vr,CreateTube:()=>kn,CrossBlock:()=>Zg,CubeMapToSphericalPolynomialTools:()=>$P.d,CubeTexture:()=>Wu.CubeTexture,CubeTextureAssetTask:()=>FP,CubicEase:()=>F.vm,CullMode:()=>_a.Ac,CurrentScreenBlock:()=>Bd,Curve3:()=>ku.jj,CurveBlock:()=>rv,CurveBlockTypes:()=>Yx,CustomBlock:()=>Qg,CustomOptimization:()=>ZP.DU,CustomParticleEmitter:()=>FT,CustomProceduralTexture:()=>Gf,CylinderBlock:()=>zb,CylinderBuilder:()=>As,CylinderDirectedParticleEmitter:()=>zT,CylinderParticleEmitter:()=>GT,DDSTools:()=>GP.DDSTools,DataBuffer:()=>wt.n,DataReader:()=>ET.s,DataStorage:()=>AT,Database:()=>FC,DebugBlock:()=>Ay,DebugLayer:()=>Ls,DebugLayerTab:()=>Os,DecalBuilder:()=>to,DecalMapConfiguration:()=>Pv,DecalMapDefines:()=>yv,Decode:()=>qe.Tq,DecodeBase64ToBinary:()=>qe.yS,DecodeBase64ToString:()=>qe.AV,DecodeBase64UrlToBinary:()=>Sf.rz,DecodeBase64UrlToString:()=>Sf.dy,DecodeFloat32:()=>wf.Sn,DecodeRunLength:()=>Of._,DeepCopier:()=>E.r,DefaultCollisionCoordinator:()=>Yr,DefaultKTX2DecoderOptions:()=>tC.$,DefaultLoadingScreen:()=>fm,DefaultRenderingPipeline:()=>eI,Deferred:()=>zP.c,DepthCullingState:()=>LO.N,DepthOfFieldBlurPostProcess:()=>DA,DepthOfFieldEffect:()=>NA,DepthOfFieldEffectBlurLevel:()=>bE,DepthOfFieldMergePostProcess:()=>OA,DepthPeelingRenderer:()=>qR,DepthPeelingSceneComponent:()=>YR,DepthReducer:()=>Bh,DepthRenderer:()=>Dh,DepthRendererSceneComponent:()=>HR,DepthSortedParticle:()=>sE,DerivativeBlock:()=>V_,DesaturateBlock:()=>Ox,DetailMapConfiguration:()=>bv.c,DeviceInputEventType:()=>Da.b,DeviceLostReason:()=>_a.Ld,DeviceOrientationCamera:()=>_i,DeviceSource:()=>yo.c,DeviceSourceManager:()=>Po.Z,DeviceType:()=>bo.bq,DirectionalLight:()=>Hh.Z,DirectionalLightFrustumViewer:()=>So,DiscBlock:()=>Wb,DiscBuilder:()=>sn,DiscardBlock:()=>F_,DisplayPassPostProcess:()=>wA,DistanceBlock:()=>dx,DistanceConstraint:()=>HE,DistanceJoint:()=>Hs,DivideBlock:()=>rx,DoNothingAction:()=>b,DomManagement:()=>Ai.Az,DotBlock:()=>Kg,DracoCompression:()=>hS,DracoDecoder:()=>lS.Y,DracoEncoder:()=>fS,DragOperation:()=>Au,DrawWrapper:()=>Ah.E,DualSenseInput:()=>bo.pI,DualShockButton:()=>Ti,DualShockDpad:()=>Ci,DualShockInput:()=>bo.h8,DualShockPad:()=>Ri,DumpTools:()=>cT.DumpTools,DynamicFloat32Array:()=>cC,DynamicTexture:()=>Tr,EXROutputType:()=>Nf.V,EasingFunction:()=>F.KA,EasingFunctionType:()=>pl.EasingFunctionType,EdgesRenderer:()=>jR,Effect:()=>xo.M,EffectFallbacks:()=>Qr.J,EffectLayer:()=>Cp,EffectLayerSceneComponent:()=>Ap,EffectRenderer:()=>Bi.J,EffectWrapper:()=>Bi.$,ElasticEase:()=>F._B,ElbowBlock:()=>Qx,EncodeArrayBufferToBase64:()=>qe.EL,EndsWith:()=>qe.jq,Engine:()=>Vi.Engine,EngineFactory:()=>Aa,EngineFormat:()=>Jf.GQ,EngineInstrumentation:()=>Pp,EngineStore:()=>C.q,EngineView:()=>Oo,EnumerateFloatValues:()=>Nt.XG,EnvironmentHelper:()=>Xu,EnvironmentTextureTools:()=>zo.qY,Epsilon:()=>ku.bH,EquiRectangularCubeTexture:()=>bf,EquiRectangularCubeTextureAssetTask:()=>VP,ErrorCodes:()=>jo.tG,ErrorFilter:()=>_a.fw,EventConstants:()=>Da.s,EventState:()=>s.qO,ExecuteCodeAction:()=>P,ExitFullscreen:()=>Ia.g7,ExitPointerlock:()=>Ia.rT,ExponentialEase:()=>F.E8,ExrLoaderGlobalConfiguration:()=>Nf.u,ExternalTexture:()=>yf.r,ExtractHighlightsPostProcess:()=>TA,ExtrudePolygon:()=>Dn,ExtrudeShape:()=>Nn,ExtrudeShapeCustom:()=>wn,FactorGradient:()=>PT,FadeInOutBehavior:()=>et,FeatureName:()=>_a.SD,FileTools:()=>Sf.wS,FileToolsOptions:()=>Sf.eC,FilesInput:()=>HP,FilesInputStore:()=>WP.T,FilterMode:()=>_a.U7,FilterPostProcess:()=>FA,FixFlippedFaces:()=>Jv.Y4,FlowGraph:()=>Oa.$,FlowGraphAbsBlock:()=>Tl.FlowGraphAbsBlock,FlowGraphAcosBlock:()=>Tl.FlowGraphAcosBlock,FlowGraphAcoshBlock:()=>Tl.FlowGraphAcoshBlock,FlowGraphAction:()=>Ya.r,FlowGraphAddBlock:()=>Tl.FlowGraphAddBlock,FlowGraphArrayIndexBlock:()=>Dl.FlowGraphArrayIndexBlock,FlowGraphAsinBlock:()=>Tl.FlowGraphAsinBlock,FlowGraphAsinhBlock:()=>Tl.FlowGraphAsinhBlock,FlowGraphAssetType:()=>Ua.$,FlowGraphAtan2Block:()=>Tl.FlowGraphAtan2Block,FlowGraphAtanBlock:()=>Tl.FlowGraphAtanBlock,FlowGraphAtanhBlock:()=>Tl.FlowGraphAtanhBlock,FlowGraphBezierCurveEasingBlock:()=>ml.FlowGraphBezierCurveEasingBlock,FlowGraphBitwiseAndBlock:()=>Tl.FlowGraphBitwiseAndBlock,FlowGraphBitwiseLeftShiftBlock:()=>Tl.FlowGraphBitwiseLeftShiftBlock,FlowGraphBitwiseNotBlock:()=>Tl.FlowGraphBitwiseNotBlock,FlowGraphBitwiseOrBlock:()=>Tl.FlowGraphBitwiseOrBlock,FlowGraphBitwiseRightShiftBlock:()=>Tl.FlowGraphBitwiseRightShiftBlock,FlowGraphBitwiseXorBlock:()=>Tl.FlowGraphBitwiseXorBlock,FlowGraphBlock:()=>Na.e,FlowGraphBlockNames:()=>$a,FlowGraphBooleanToFloat:()=>Rl.FlowGraphBooleanToFloat,FlowGraphBooleanToInt:()=>Rl.FlowGraphBooleanToInt,FlowGraphBranchBlock:()=>ja.FlowGraphBranchBlock,FlowGraphCallCounterBlock:()=>il.FlowGraphCallCounterBlock,FlowGraphCancelDelayBlock:()=>ll.FlowGraphCancelDelayBlock,FlowGraphCeilBlock:()=>Tl.FlowGraphCeilBlock,FlowGraphClampBlock:()=>Tl.FlowGraphClampBlock,FlowGraphCodeExecutionBlock:()=>Ol.FlowGraphCodeExecutionBlock,FlowGraphCombineMatrix2DBlock:()=>Cl.FlowGraphCombineMatrix2DBlock,FlowGraphCombineMatrix3DBlock:()=>Cl.FlowGraphCombineMatrix3DBlock,FlowGraphCombineMatrixBlock:()=>Cl.FlowGraphCombineMatrixBlock,FlowGraphCombineVector2Block:()=>Cl.FlowGraphCombineVector2Block,FlowGraphCombineVector3Block:()=>Cl.FlowGraphCombineVector3Block,FlowGraphCombineVector4Block:()=>Cl.FlowGraphCombineVector4Block,FlowGraphConditionalDataBlock:()=>fl.FlowGraphConditionalDataBlock,FlowGraphConnection:()=>Ga.X,FlowGraphConnectionType:()=>Ga.H,FlowGraphConsoleLogBlock:()=>Xa.FlowGraphConsoleLogBlock,FlowGraphConstantBlock:()=>bl.FlowGraphConstantBlock,FlowGraphContext:()=>La.Y,FlowGraphContextBlock:()=>Ml.FlowGraphContextBlock,FlowGraphCoordinator:()=>ka.x,FlowGraphCosBlock:()=>Tl.FlowGraphCosBlock,FlowGraphCoshBlock:()=>Tl.FlowGraphCoshBlock,FlowGraphCrossBlock:()=>Al.FlowGraphCrossBlock,FlowGraphCubeRootBlock:()=>Tl.FlowGraphCubeRootBlock,FlowGraphDataConnection:()=>za.l,FlowGraphDataSwitchBlock:()=>Pl.FlowGraphDataSwitchBlock,FlowGraphDebounceBlock:()=>sl.FlowGraphDebounceBlock,FlowGraphDegToRadBlock:()=>Tl.FlowGraphDegToRadBlock,FlowGraphDeterminantBlock:()=>El.FlowGraphDeterminantBlock,FlowGraphDivideBlock:()=>Tl.FlowGraphDivideBlock,FlowGraphDoNBlock:()=>Za.FlowGraphDoNBlock,FlowGraphDotBlock:()=>Al.FlowGraphDotBlock,FlowGraphEBlock:()=>Tl.FlowGraphEBlock,FlowGraphEasingBlock:()=>pl.FlowGraphEasingBlock,FlowGraphEqualityBlock:()=>Tl.FlowGraphEqualityBlock,FlowGraphEventBlock:()=>Ba.i,FlowGraphExecutionBlock:()=>Fa.u,FlowGraphExpBlock:()=>Tl.FlowGraphExpBlock,FlowGraphExtractMatrix2DBlock:()=>Cl.FlowGraphExtractMatrix2DBlock,FlowGraphExtractMatrix3DBlock:()=>Cl.FlowGraphExtractMatrix3DBlock,FlowGraphExtractMatrixBlock:()=>Cl.FlowGraphExtractMatrixBlock,FlowGraphExtractVector2Block:()=>Cl.FlowGraphExtractVector2Block,FlowGraphExtractVector3Block:()=>Cl.FlowGraphExtractVector3Block,FlowGraphExtractVector4Block:()=>Cl.FlowGraphExtractVector4Block,FlowGraphFlipFlopBlock:()=>nl.FlowGraphFlipFlopBlock,FlowGraphFloatToBoolean:()=>Rl.FlowGraphFloatToBoolean,FlowGraphFloatToInt:()=>Rl.FlowGraphFloatToInt,FlowGraphFloorBlock:()=>Tl.FlowGraphFloorBlock,FlowGraphForLoopBlock:()=>Qa.FlowGraphForLoopBlock,FlowGraphFractionBlock:()=>Tl.FlowGraphFractionBlock,FlowGraphFunctionReferenceBlock:()=>wl.FlowGraphFunctionReferenceBlock,FlowGraphGetAssetBlock:()=>yl.FlowGraphGetAssetBlock,FlowGraphGetPropertyBlock:()=>vl.FlowGraphGetPropertyBlock,FlowGraphGetVariableBlock:()=>_l.FlowGraphGetVariableBlock,FlowGraphGreaterThanBlock:()=>Tl.FlowGraphGreaterThanBlock,FlowGraphGreaterThanOrEqualBlock:()=>Tl.FlowGraphGreaterThanOrEqualBlock,FlowGraphIndexOfBlock:()=>Nl.FlowGraphIndexOfBlock,FlowGraphInfBlock:()=>Tl.FlowGraphInfBlock,FlowGraphIntToBoolean:()=>Rl.FlowGraphIntToBoolean,FlowGraphIntToFloat:()=>Rl.FlowGraphIntToFloat,FlowGraphInteger:()=>ql.P,FlowGraphInterpolationBlock:()=>dl.FlowGraphInterpolationBlock,FlowGraphInvertMatrixBlock:()=>El.FlowGraphInvertMatrixBlock,FlowGraphIsInfinityBlock:()=>Tl.FlowGraphIsInfinityBlock,FlowGraphIsNanBlock:()=>Tl.FlowGraphIsNanBlock,FlowGraphJsonPointerParserBlock:()=>Il.FlowGraphJsonPointerParserBlock,FlowGraphLeadingZerosBlock:()=>Tl.FlowGraphLeadingZerosBlock,FlowGraphLengthBlock:()=>Al.FlowGraphLengthBlock,FlowGraphLessThanBlock:()=>Tl.FlowGraphLessThanBlock,FlowGraphLessThanOrEqualBlock:()=>Tl.FlowGraphLessThanOrEqualBlock,FlowGraphLog10Block:()=>Tl.FlowGraphLog10Block,FlowGraphLog2Block:()=>Tl.FlowGraphLog2Block,FlowGraphLogBlock:()=>Tl.FlowGraphLogBlock,FlowGraphLogger:()=>Ya.H,FlowGraphMathInterpolationBlock:()=>Tl.FlowGraphMathInterpolationBlock,FlowGraphMatrix2D:()=>Yl.K,FlowGraphMatrix3D:()=>Yl.z,FlowGraphMatrixComposeBlock:()=>El.FlowGraphMatrixComposeBlock,FlowGraphMatrixDecomposeBlock:()=>El.FlowGraphMatrixDecomposeBlock,FlowGraphMatrixMultiplicationBlock:()=>El.FlowGraphMatrixMultiplicationBlock,FlowGraphMaxBlock:()=>Tl.FlowGraphMaxBlock,FlowGraphMeshPickEventBlock:()=>Fl.FlowGraphMeshPickEventBlock,FlowGraphMinBlock:()=>Tl.FlowGraphMinBlock,FlowGraphModuloBlock:()=>Tl.FlowGraphModuloBlock,FlowGraphMultiGateBlock:()=>Ja.FlowGraphMultiGateBlock,FlowGraphMultiplyBlock:()=>Tl.FlowGraphMultiplyBlock,FlowGraphNaNBlock:()=>Tl.FlowGraphNaNBlock,FlowGraphNegationBlock:()=>Tl.FlowGraphNegationBlock,FlowGraphNormalizeBlock:()=>Al.FlowGraphNormalizeBlock,FlowGraphOneBitsCounterBlock:()=>Tl.FlowGraphOneBitsCounterBlock,FlowGraphPathConverter:()=>Ha,FlowGraphPathConverterComponent:()=>qa.H,FlowGraphPauseAnimationBlock:()=>ul.FlowGraphPauseAnimationBlock,FlowGraphPiBlock:()=>Tl.FlowGraphPiBlock,FlowGraphPlayAnimationBlock:()=>hl.FlowGraphPlayAnimationBlock,FlowGraphPointerOutEventBlock:()=>Gl.FlowGraphPointerOutEventBlock,FlowGraphPointerOverEventBlock:()=>zl.FlowGraphPointerOverEventBlock,FlowGraphPowerBlock:()=>Tl.FlowGraphPowerBlock,FlowGraphRadToDegBlock:()=>Tl.FlowGraphRadToDegBlock,FlowGraphRandomBlock:()=>Tl.FlowGraphRandomBlock,FlowGraphReceiveCustomEventBlock:()=>Vl.FlowGraphReceiveCustomEventBlock,FlowGraphRotate2DBlock:()=>Al.FlowGraphRotate2DBlock,FlowGraphRotate3DBlock:()=>Al.FlowGraphRotate3DBlock,FlowGraphRoundBlock:()=>Tl.FlowGraphRoundBlock,FlowGraphSaturateBlock:()=>Tl.FlowGraphSaturateBlock,FlowGraphSceneReadyEventBlock:()=>Bl.FlowGraphSceneReadyEventBlock,FlowGraphSceneTickEventBlock:()=>kl.FlowGraphSceneTickEventBlock,FlowGraphSendCustomEventBlock:()=>Ll.FlowGraphSendCustomEventBlock,FlowGraphSequenceBlock:()=>ol.FlowGraphSequenceBlock,FlowGraphSetDelayBlock:()=>al.FlowGraphSetDelayBlock,FlowGraphSetPropertyBlock:()=>Sl.FlowGraphSetPropertyBlock,FlowGraphSetVariableBlock:()=>gl.FlowGraphSetVariableBlock,FlowGraphSignBlock:()=>Tl.FlowGraphSignBlock,FlowGraphSignalConnection:()=>wa.R,FlowGraphSinBlock:()=>Tl.FlowGraphSinBlock,FlowGraphSinhBlock:()=>Tl.FlowGraphSinhBlock,FlowGraphSquareRootBlock:()=>Tl.FlowGraphSquareRootBlock,FlowGraphState:()=>Oa.I,FlowGraphStopAnimationBlock:()=>cl.FlowGraphStopAnimationBlock,FlowGraphSubtractBlock:()=>Tl.FlowGraphSubtractBlock,FlowGraphSwitchBlock:()=>el.FlowGraphSwitchBlock,FlowGraphTanBlock:()=>Tl.FlowGraphTanBlock,FlowGraphTanhBlock:()=>Tl.FlowGraphTanhBlock,FlowGraphThrottleBlock:()=>Ka.FlowGraphThrottleBlock,FlowGraphTrailingZerosBlock:()=>Tl.FlowGraphTrailingZerosBlock,FlowGraphTransformBlock:()=>Al.FlowGraphTransformBlock,FlowGraphTransformCoordinatesBlock:()=>Al.FlowGraphTransformCoordinatesBlock,FlowGraphTransformCoordinatesSystemBlock:()=>xl.FlowGraphTransformCoordinatesSystemBlock,FlowGraphTransposeBlock:()=>El.FlowGraphTransposeBlock,FlowGraphTruncBlock:()=>Tl.FlowGraphTruncBlock,FlowGraphTypes:()=>Va.Qd,FlowGraphWaitAllBlock:()=>tl.FlowGraphWaitAllBlock,FlowGraphWhileLoopBlock:()=>rl.FlowGraphWhileLoopBlock,FluidRenderer:()=>MM,FluidRendererSceneComponent:()=>RM,FluidRenderingDebug:()=>vM,FluidRenderingObject:()=>bM,FluidRenderingObjectCustomParticles:()=>CM,FluidRenderingObjectParticleSystem:()=>yM,FluidRenderingTargetRenderer:()=>TM,FlyCamera:()=>xi,FlyCameraInputsManager:()=>gi,FlyCameraKeyboardInput:()=>jt,FlyCameraMouseInput:()=>Zt,FogBlock:()=>cg,FollowBehavior:()=>Pt,FollowCamera:()=>Si,FollowCameraInputsManager:()=>vi,FollowCameraKeyboardMoveInput:()=>Qt,FollowCameraMouseWheelInput:()=>Kt,FollowCameraPointersInput:()=>Jt,FragCoordBlock:()=>L_,FragDepthBlock:()=>W_,FragmentOutputBlock:()=>Rd,FragmentOutputBlockColorSpace:()=>Sd,FrameGraph:()=>gh,FrameGraphAnaglyphTask:()=>_c,FrameGraphBlackAndWhiteTask:()=>Sc,FrameGraphBloomTask:()=>Ac,FrameGraphBlurTask:()=>oc,FrameGraphCascadedShadowGeneratorTask:()=>$h,FrameGraphChromaticAberrationTask:()=>Dc,FrameGraphCircleOfConfusionTask:()=>wc,FrameGraphClearTextureTask:()=>Sh,FrameGraphContext:()=>ah,FrameGraphCopyToBackbufferColorTask:()=>rh,FrameGraphCopyToTextureTask:()=>bu,FrameGraphCullObjectsTask:()=>ou,FrameGraphCullPass:()=>eh,FrameGraphDepthOfFieldTask:()=>zc,FrameGraphExecuteTask:()=>Jh,FrameGraphExtractHighlightsTask:()=>Ec,FrameGraphGenerateMipMapsTask:()=>Pu,FrameGraphGeometryRendererTask:()=>cu,FrameGraphGlowLayerTask:()=>hc,FrameGraphHighlightLayerTask:()=>mc,FrameGraphObjectList:()=>Cu,FrameGraphObjectRendererTask:()=>qh,FrameGraphPass:()=>Jl,FrameGraphPassCubeTask:()=>$c,FrameGraphPassTask:()=>Hc,FrameGraphPostProcessTask:()=>nc,FrameGraphRenderContext:()=>lh,FrameGraphRenderPass:()=>th,FrameGraphRenderTarget:()=>uh,FrameGraphSSRRenderingPipelineTask:()=>iu,FrameGraphShadowGeneratorTask:()=>Wh,FrameGraphTAAObjectRendererTask:()=>fu,FrameGraphTask:()=>ih,FrameGraphTextureManager:()=>_h,FrameGraphUtilityLayerRendererTask:()=>gu,FramingBehavior:()=>Qe.p,FreeCamera:()=>di.S,FreeCameraDeviceOrientationInput:()=>ti,FreeCameraGamepadInput:()=>ii,FreeCameraInputsManager:()=>ei.s,FreeCameraKeyboardMoveInput:()=>si.i,FreeCameraMouseInput:()=>ni.h,FreeCameraMouseWheelInput:()=>oi.m,FreeCameraTouchInput:()=>ai.Z,FreeCameraVirtualJoystickInput:()=>ci,FresnelBlock:()=>hx,FresnelParameters:()=>Qm,FromHalfFloat:()=>Vy.SX,FrontFace:()=>_a.x_,FrontFacingBlock:()=>B_,Frustum:()=>ku.PP,FxaaPostProcess:()=>hT,GIRSM:()=>iD,GIRSMManager:()=>rD,GIRSMRenderPluginMaterial:()=>nD,GPUParticleSystem:()=>JC,GPUPicker:()=>ns,GUID:()=>fv.S,Gamepad:()=>Gt,GamepadCamera:()=>Ni,GamepadManager:()=>Mi,GamepadSystemSceneComponent:()=>Di,GaussianBlock:()=>d_,GaussianSplattingBlock:()=>u_,GaussianSplattingMaterial:()=>p_.b,GaussianSplattingMesh:()=>cP.t,GenerateBase64StringFromPixelData:()=>aC.c9,GenerateBase64StringFromTexture:()=>aC.lP,GenerateBase64StringFromTextureAsync:()=>aC.nh,GenericPad:()=>zt,GeodesicData:()=>no,Geometry:()=>_m.V,GeometryArcTan2Block:()=>Uy,GeometryBufferRenderer:()=>UA,GeometryBufferRendererSceneComponent:()=>HA,GeometryClampBlock:()=>jy,GeometryCollectionBlock:()=>ry,GeometryCrossBlock:()=>Zy,GeometryCurveBlock:()=>Qy,GeometryCurveBlockTypes:()=>wy,GeometryDesaturateBlock:()=>Ky,GeometryDistanceBlock:()=>tP,GeometryDotBlock:()=>iP,GeometryEaseBlock:()=>oP,GeometryEaseBlockTypes:()=>Fy,GeometryElbowBlock:()=>ny,GeometryInfoBlock:()=>Iy,GeometryInputBlock:()=>Db,GeometryInterceptorBlock:()=>nP,GeometryLengthBlock:()=>rP,GeometryLerpBlock:()=>Wy,GeometryModBlock:()=>Yy,GeometryNLerpBlock:()=>Hy,GeometryOptimizeBlock:()=>wb,GeometryOutputBlock:()=>Rb,GeometryPosterizeBlock:()=>Jy,GeometryPowBlock:()=>Xy,GeometryRenderingTextureClearType:()=>lu.Z,GeometryReplaceColorBlock:()=>eP,GeometryRotate2dBlock:()=>sP,GeometrySmoothStepBlock:()=>qy,GeometryStepBlock:()=>$y,GeometryTextureBlock:()=>Ly,GeometryTextureFetchBlock:()=>ky,GeometryTransformBlock:()=>dy,GeometryTrigonometryBlock:()=>uy,GeometryTrigonometryBlockOperations:()=>Cb,GetClass:()=>a.n9,GetClassName:()=>a.Uu,GetDOMTextContent:()=>Ai.Zl,GetDataOutConnectionByUniqueId:()=>Wa.WN,GetEnvInfo:()=>zo.cU,GetEnvironmentBRDFTexture:()=>wx.X,GetExrHeader:()=>Bf.V,GetExtensionFromUrl:()=>CC.r,GetFloatData:()=>Nt.jm,GetFlowGraphAssetWithType:()=>Ua.N,GetFogState:()=>ts.qL,GetFontOffset:()=>Ia.PR,GetForwardRay:()=>st.GetForwardRay,GetForwardRayToRef:()=>st.GetForwardRayToRef,GetHotSpotToRef:()=>oS.e0,GetIndividualParser:()=>Ep.LO,GetInternalFormatFromBasisFormat:()=>kP.yT,GetParser:()=>Ep.Iz,GetPointsCount:()=>XS,GetRegisteredSceneLoaderPluginMetadata:()=>sd.iE,GetSignalInConnectionByUniqueId:()=>Wa.dp,GetTGAHeader:()=>oT.O_,GetTextureDataAsync:()=>Vy.Oz,GetTransformedPosition:()=>oS.F3,GetTypeByteLength:()=>Nt.PD,GetTypedArrayConstructor:()=>Nt.w,GetTypedArrayData:()=>Nt.II,Gizmo:()=>ws,GizmoAnchorPoint:()=>Ms,GizmoCoordinatesMode:()=>Ds,GizmoManager:()=>wu,GlowLayer:()=>Ip,GoldbergMesh:()=>ao,GradientBlock:()=>Tx,GradientBlockColorStep:()=>Px,GradientHelper:()=>TT,GrainPostProcess:()=>BA,GreasedLineBaseMesh:()=>WS,GreasedLineMaterialDefaults:()=>Dv,GreasedLineMesh:()=>HS,GreasedLineMeshColorDistribution:()=>GS,GreasedLineMeshColorDistributionType:()=>kv,GreasedLineMeshColorMode:()=>Lv,GreasedLineMeshMaterialType:()=>Vv,GreasedLineMeshWidthDistribution:()=>zS,GreasedLinePluginMaterial:()=>wv,GreasedLineRibbonAutoDirectionMode:()=>kS,GreasedLineRibbonFacesMode:()=>LS,GreasedLineRibbonMesh:()=>$S,GreasedLineRibbonPointsMode:()=>VS,GreasedLineSimpleMaterial:()=>Bv,GreasedLineTools:()=>Ov,GreasedLineUseOffsetsSimpleMaterialDefine:()=>Fv,GridBlock:()=>kb,GroundBuilder:()=>Br.LL,GroundMesh:()=>TS.f,HDRCubeTexture:()=>xm.HDRCubeTexture,HDRCubeTextureAssetTask:()=>BP,HDRFiltering:()=>Pf.F,HDRTools:()=>qP.I9,Halton2DSequence:()=>pu,HandConstraintBehavior:()=>Et,HandConstraintOrientation:()=>St,HandConstraintVisibility:()=>bt,HandConstraintZone:()=>vt,HandPart:()=>lp,HandleFallbacksForShadows:()=>ts.c4,HardwareScalingOptimization:()=>ZP.bu,HavokPlugin:()=>hA,HeightToNormalBlock:()=>U_,HemisphereBuilder:()=>Bu,HemisphericLight:()=>Is.g,HemisphericParticleEmitter:()=>VT,HighlightLayer:()=>Mp,HighlightsPostProcess:()=>VA,Hinge2Joint:()=>Ys,HingeConstraint:()=>$E,HingeJoint:()=>qs,HtmlElementTexture:()=>Tf,HufUncompress:()=>Df.ZR,IWebXRControllerPhysicsOptions:()=>YO,IblCdfGenerator:()=>QR.O,IblCdfGeneratorSceneComponent:()=>KR,IblShadowsRenderPipeline:()=>nM,IcoSphereBlock:()=>Vb,IcoSphereBuilder:()=>qn,ImageAssetTask:()=>NP,ImageProcessingBlock:()=>O_,ImageProcessingConfiguration:()=>Sr.p,ImageProcessingPostProcess:()=>LA,ImageSourceBlock:()=>dg,ImportAnimationsAsync:()=>sd.p,ImportMeshAsync:()=>sd.Tk,IncrementValueAction:()=>x,IndexFormat:()=>_a.uK,InitializeCSG2Async:()=>ob,InputBlock:()=>Fd,InspectableType:()=>vT,InstancedLinesMesh:()=>gn,InstancedMesh:()=>mn.Z,InstancesBlock:()=>g_,InstantiateBlock:()=>Py,InstantiateLinearBlock:()=>Ty,InstantiateOnFacesBlock:()=>Sy,InstantiateOnVerticesBlock:()=>vy,InstantiateOnVolumeBlock:()=>by,InstantiateRadialBlock:()=>Cy,InstantiatedEntries:()=>W.Nx,IntFloatConverterBlock:()=>Ey,InterleaveScalar:()=>wf.KA,InternalTexture:()=>lr.h,InternalTextureSource:()=>lr.G,InterpolateValueAction:()=>D,IntersectionInfo:()=>jr.w,IsBase64DataUrl:()=>Sf.f2,IsCSG2Ready:()=>nb,IsDocumentAvailable:()=>Ai.Nf,IsFileURL:()=>Sf.my,IsNavigatorAvailable:()=>Ai.XD,IsWindowObjectExist:()=>Ai.BA,IsWrapper:()=>Ao.E,JoystickAxis:()=>ri,KeepAssets:()=>W.hA,KeyboardEventTypes:()=>Xt.TB,KeyboardInfo:()=>Xt.W0,KeyboardInfoPre:()=>Xt.Bu,KhronosTextureContainer:()=>YP.H,KhronosTextureContainer2:()=>tC.Z,LastCreatedAudioEngine:()=>re,LatheBuilder:()=>Ln,Lattice:()=>FS,LatticeBlock:()=>cy,LatticePluginMaterial:()=>BS,Layer:()=>Op,LayerSceneComponent:()=>Dp,LengthBlock:()=>px,LensFlare:()=>Yp,LensFlareSystem:()=>Xp,LensFlareSystemSceneComponent:()=>jp,LensFlaresOptimization:()=>ZP.fT,LensRenderingPipeline:()=>oI,LerpBlock:()=>ix,Light:()=>Ns.v,LightBlock:()=>ug,LightGizmo:()=>Lu,LightInformationBlock:()=>v_,LineEdgesRenderer:()=>ZR,LinesBuilder:()=>Pn,LinesMesh:()=>_n,LoadAssetContainerAsync:()=>sd.uD,LoadFile:()=>Sf.zU,LoadFileError:()=>Sf.hX,LoadIESData:()=>mm.i,LoadImage:()=>Sf.W$,LoadImageConfiguration:()=>Sf.qc,LoadOp:()=>_a.UU,LoadSceneAsync:()=>sd.X3,LoadTextureFromTranscodeResult:()=>kP.aB,LockConstraint:()=>YE,Logger:()=>m.V,LoopBlock:()=>nv,MainAudioBus:()=>ue.s,MapMode:()=>_a.iR,MapRangeBlock:()=>Kb,MappingBlock:()=>Ry,MappingTypes:()=>Eb,Material:()=>fn.i,MaterialAnisotropicDefines:()=>rf.v,MaterialBRDFDefines:()=>of.S,MaterialClearCoatDefines:()=>af.a,MaterialDefines:()=>Hu.M,MaterialDetailMapDefines:()=>bv.H,MaterialFlags:()=>$u.h,MaterialGreasedLineDefines:()=>Nv,MaterialHelper:()=>Km,MaterialHelperGeometryRendering:()=>lu.m,MaterialIridescenceDefines:()=>lf.m,MaterialPluginBase:()=>vv.y,MaterialPluginEvent:()=>xv,MaterialPluginManager:()=>Sv.uZ,MaterialSheenDefines:()=>df.Z,MaterialSubSurfaceDefines:()=>pf.p,MathBlock:()=>Qb,MathBlockOperations:()=>yb,Matrix:()=>ku.uq,MatrixBuilderBlock:()=>Hx,MatrixComposeBlock:()=>My,MatrixDeterminantBlock:()=>ev,MatrixSplitterBlock:()=>lv,MatrixTransposeBlock:()=>tv,MaxBlock:()=>cx,MergeGeometryBlock:()=>iy,MergeMeshesOptimization:()=>ZP.lx,Mesh:()=>tt.e,MeshAssetTask:()=>RP,MeshAttributeExistsBlock:()=>iv,MeshAttributeExistsBlockTypes:()=>qx,MeshBlock:()=>Bb,MeshBuilder:()=>fo,MeshDebugMode:()=>zv,MeshDebugPluginMaterial:()=>Wv,MeshExploder:()=>UP,MeshLODLevel:()=>US.L,MeshParticleEmitter:()=>wT,MeshUVSpaceRenderer:()=>yS,MeshoptCompression:()=>cS.v,MinBlock:()=>ux,MinMaxReducer:()=>Fh,MipmapFilterMode:()=>_a.Wy,MirrorTexture:()=>Uu,ModBlock:()=>Wx,ModelShape:()=>rE,MorphTarget:()=>OC.M,MorphTargetManager:()=>vm.j,MorphTargetsBlock:()=>x_,MotionBlurPostProcess:()=>$A,MotorEnabledJoint:()=>$s,MultiMaterial:()=>gm.F,MultiObserver:()=>XP,MultiPick:()=>st.MultiPick,MultiPickWithRay:()=>st.MultiPickWithRay,MultiPointerScaleBehavior:()=>pt,MultiRenderTarget:()=>Vf,MultiplyBlock:()=>Wd,NLerpBlock:()=>Cx,NativeDataStream:()=>Go,NativeEngine:()=>ha,NativePointerInput:()=>bo.Ze,NativeXRFrame:()=>YN,NativeXRLayerRenderTargetTextureProvider:()=>Nr,NativeXRLayerWrapper:()=>Or,NativeXRRenderTarget:()=>wr,NegateBlock:()=>mx,Node:()=>pi.b,NodeGeometry:()=>Nb,NodeGeometryBlock:()=>Ib,NodeGeometryBlockConnectionPointTypes:()=>xb,NodeGeometryBuildState:()=>Mb,NodeGeometryConnectionPoint:()=>Ab,NodeGeometryConnectionPointCompatibilityStates:()=>vb,NodeGeometryConnectionPointDirection:()=>Sb,NodeGeometryContextualSources:()=>bb,NodeMaterial:()=>Jd,NodeMaterialBlock:()=>Ed,NodeMaterialBlockConnectionPointMode:()=>Kf,NodeMaterialBlockConnectionPointTypes:()=>_d,NodeMaterialBlockTargets:()=>gd,NodeMaterialConnectionPoint:()=>Cd,NodeMaterialConnectionPointCompatibilityStates:()=>xd,NodeMaterialConnectionPointCustomObject:()=>c_,NodeMaterialConnectionPointDirection:()=>vd,NodeMaterialDebugBlock:()=>pv,NodeMaterialDefines:()=>Kd,NodeMaterialModes:()=>Hd,NodeMaterialOptimizer:()=>mv,NodeMaterialSystemValues:()=>bd,NodeMaterialTeleportInBlock:()=>$g,NodeMaterialTeleportOutBlock:()=>qg,NodeRenderGraph:()=>Qh,NodeRenderGraphAnaglyphPostProcessBlock:()=>xc,NodeRenderGraphBlackAndWhitePostProcessBlock:()=>bc,NodeRenderGraphBlock:()=>Zl,NodeRenderGraphBlockConnectionPointTypes:()=>Wl,NodeRenderGraphBloomPostProcessBlock:()=>Ic,NodeRenderGraphBlurPostProcessBlock:()=>Rc,NodeRenderGraphBuildState:()=>Zh,NodeRenderGraphCascadedShadowGeneratorBlock:()=>nu,NodeRenderGraphChromaticAberrationPostProcessBlock:()=>Oc,NodeRenderGraphCircleOfConfusionPostProcessBlock:()=>Fc,NodeRenderGraphClearBlock:()=>bh,NodeRenderGraphConnectionPoint:()=>jl,NodeRenderGraphConnectionPointCompatibilityStates:()=>Hl,NodeRenderGraphConnectionPointDirection:()=>$l,NodeRenderGraphCopyTextureBlock:()=>yu,NodeRenderGraphCullObjectsBlock:()=>au,NodeRenderGraphDepthOfFieldPostProcessBlock:()=>Uc,NodeRenderGraphElbowBlock:()=>Kh,NodeRenderGraphExecuteBlock:()=>ec,NodeRenderGraphExtractHighlightsPostProcessBlock:()=>Wc,NodeRenderGraphGenerateMipmapsBlock:()=>Tu,NodeRenderGraphGeometryRendererBlock:()=>uu,NodeRenderGraphGlowLayerBlock:()=>cc,NodeRenderGraphHighlightLayerBlock:()=>fc,NodeRenderGraphInputBlock:()=>vh,NodeRenderGraphObjectRendererBlock:()=>jh,NodeRenderGraphOutputBlock:()=>sh,NodeRenderGraphPassCubePostProcessBlock:()=>Yc,NodeRenderGraphPassPostProcessBlock:()=>qc,NodeRenderGraphResourceContainerBlock:()=>tc,NodeRenderGraphSSRPostProcessBlock:()=>ru,NodeRenderGraphShadowGeneratorBlock:()=>du,NodeRenderGraphTAAObjectRendererBlock:()=>_u,NodeRenderGraphTeleportInBlock:()=>vu,NodeRenderGraphTeleportOutBlock:()=>Su,NodeRenderGraphUtilityLayerRendererBlock:()=>xu,NoiseBlock:()=>ty,NoiseProceduralTexture:()=>Wf,NormalBlendBlock:()=>Ix,NormalizeBlock:()=>Jg,NormalizeVectorBlock:()=>ly,NullBlock:()=>Hb,NullEngine:()=>Ro,NullEngineOptions:()=>Io,ObjectRenderer:()=>yh.P,Observable:()=>s.cP,Observer:()=>s.nu,OcclusionMaterial:()=>tf,Octree:()=>ys,OctreeBlock:()=>bs,OctreeSceneComponent:()=>Ts,OimoJSPlugin:()=>Tm,OnAfterEnteringVRObservableEvent:()=>Ur,OneMinusBlock:()=>ox,OptimizeIndices:()=>ab.OptimizeIndices,Orientation:()=>ku.t4,OutlineRenderer:()=>xM,PBRAnisotropicConfiguration:()=>rf.i,PBRBRDFConfiguration:()=>of.j,PBRBaseMaterial:()=>sf.d,PBRBaseSimpleMaterial:()=>nf,PBRClearCoatConfiguration:()=>af.t,PBRIridescenceConfiguration:()=>lf.z,PBRMaterial:()=>Qu.Y,PBRMaterialDefines:()=>sf.g,PBRMetallicRoughnessBlock:()=>Ux,PBRMetallicRoughnessMaterial:()=>hf,PBRSheenConfiguration:()=>df.C,PBRSpecularGlossinessMaterial:()=>cf,PBRSubSurfaceConfiguration:()=>pf.I,PHI:()=>ku.a6,PadNumber:()=>qe.LW,PanoramaToCubeMapTools:()=>vf.D,Parse:()=>Ep.oj,ParseBlockAsync:()=>Wa.h5,ParseCoordinatorAsync:()=>Wa.c,ParseFloat16:()=>wf.LD,ParseFloat32:()=>wf.Ff,ParseFlowGraph:()=>Wa.kf,ParseFlowGraphAsync:()=>Wa.cB,ParseFlowGraphBlockWithClassType:()=>Wa.bY,ParseFlowGraphContext:()=>Wa.f6,ParseGraphConnectionWithClassType:()=>Wa.mM,ParseGraphDataConnection:()=>Wa.cf,ParseInt32:()=>wf.cL,ParseInt64:()=>wf.tB,ParseNullTerminatedString:()=>wf.T$,ParseUint16:()=>wf.Jn,ParseUint32:()=>wf.PX,ParseUint8:()=>wf._S,ParseUint8Array:()=>wf.fz,ParseValue:()=>wf.zX,Particle:()=>IT,ParticleBlendMultiplyBlock:()=>kd,ParticleHelper:()=>tE,ParticleRampGradientBlock:()=>Ld,ParticleSystem:()=>KT,ParticleSystemSet:()=>eE,ParticleTextureBlock:()=>Vd,ParticlesOptimization:()=>ZP.d,PassCubePostProcess:()=>wi.s,PassPostProcess:()=>wi.v,Path2:()=>ku.Cu,Path3D:()=>ku.tO,PathCursor:()=>z,PerfCollectionStrategy:()=>gC,PerfCounter:()=>Mo.A,PerformanceConfigurator:()=>Co.I,PerformanceMonitor:()=>jP.r,PerformanceViewerCollector:()=>fC,PerturbNormalBlock:()=>w_,PhotoDome:()=>Zu,Physics6DoFConstraint:()=>UE,Physics6DoFLimit:()=>zE,PhysicsActivationControl:()=>fE,PhysicsAggregate:()=>ZE,PhysicsBody:()=>RE,PhysicsCharacterController:()=>rA,PhysicsConstraint:()=>GE,PhysicsConstraintAxis:()=>lE,PhysicsConstraintAxisLimitMode:()=>aE,PhysicsConstraintMotorType:()=>uE,PhysicsConstraintType:()=>hE,PhysicsEngine:()=>ym,PhysicsEngineV2:()=>IE,PhysicsEventType:()=>dE,PhysicsHelper:()=>dA,PhysicsImpostor:()=>Xs,PhysicsJoint:()=>Ws,PhysicsMaterialCombineMode:()=>_E,PhysicsMotionType:()=>pE,PhysicsPrestepType:()=>mE,PhysicsRadialExplosionEventOptions:()=>gA,PhysicsRadialImpulseFalloff:()=>vE,PhysicsRaycastResult:()=>bm,PhysicsShape:()=>ME,PhysicsShapeBox:()=>wE,PhysicsShapeCapsule:()=>OE,PhysicsShapeContainer:()=>VE,PhysicsShapeConvexHull:()=>FE,PhysicsShapeCylinder:()=>NE,PhysicsShapeGroundMesh:()=>kE,PhysicsShapeHeightField:()=>LE,PhysicsShapeMesh:()=>BE,PhysicsShapeSphere:()=>DE,PhysicsShapeType:()=>cE,PhysicsUpdraftEventOptions:()=>xA,PhysicsUpdraftMode:()=>SE,PhysicsViewer:()=>_o,PhysicsVortexEventOptions:()=>vA,Pick:()=>st.Pick,PickWithBoundingInfo:()=>st.PickWithBoundingInfo,PickWithRay:()=>st.PickWithRay,PickingCustomization:()=>st.PickingCustomization,PickingInfo:()=>Xr.G,PipelineErrorReason:()=>_a.Xk,PivotTools:()=>nt,Plane:()=>ku.Zc,PlaneBlock:()=>Fb,PlaneBuilder:()=>ct,PlaneDragGizmo:()=>Du,PlaneRotationGizmo:()=>Ru,PlayAnimationAction:()=>v,PlaySoundAction:()=>I,PointColor:()=>PE.q,PointLight:()=>cm.H,PointListBlock:()=>$b,PointParticleEmitter:()=>BT,PointerDragBehavior:()=>dt,PointerEventTypes:()=>rt.Zp,PointerInfo:()=>rt.mx,PointerInfoBase:()=>rt.Vn,PointerInfoPre:()=>rt.tT,PointerInput:()=>bo.ST,PointsCloudSystem:()=>PE.y,PointsGroup:()=>yE.x,Polar:()=>eS,Polygon:()=>An,PolygonBuilder:()=>On,PolygonMeshBuilder:()=>In,PolyhedronBuilder:()=>Wn,PolyhedronData:()=>so,PositionGizmo:()=>Ou,PositionNormalTextureVertex:()=>ku.k0,PositionNormalVertex:()=>ku.B5,PostProcess:()=>Fi.w,PostProcessManager:()=>Oh.X,PostProcessRenderEffect:()=>PA,PostProcessRenderPipeline:()=>QA,PostProcessRenderPipelineManager:()=>KA,PostProcessRenderPipelineManagerSceneComponent:()=>JA,PostProcessesOptimization:()=>ZP.v7,PosterizeBlock:()=>bx,PowBlock:()=>fx,PowerEase:()=>F.Ww,PowerPreference:()=>_a.TK,PrePassOutputBlock:()=>$_,PrePassRenderer:()=>aM,PrePassRendererSceneComponent:()=>lM,PrePassTextureBlock:()=>Hg,PrecisionDate:()=>Md.j,PredicateCondition:()=>d,Predictor:()=>wf.XE,PrepareAttributesForBakedVertexAnimation:()=>ts.J2,PrepareAttributesForBones:()=>ts.ni,PrepareAttributesForInstances:()=>ts.ER,PrepareAttributesForMorphTargets:()=>ts.IF,PrepareAttributesForMorphTargetsInfluencers:()=>ts.MF,PrepareDefinesAndAttributesForMorphTargets:()=>ts.Dk,PrepareDefinesForAttributes:()=>ts.qB,PrepareDefinesForBakedVertexAnimation:()=>ts.wu,PrepareDefinesForBones:()=>ts.IC,PrepareDefinesForCamera:()=>ts.Y7,PrepareDefinesForFrameBoundValues:()=>ts.OR,PrepareDefinesForLight:()=>ts.lo,PrepareDefinesForLights:()=>ts.az,PrepareDefinesForMergedUV:()=>ts.YT,PrepareDefinesForMisc:()=>ts.fm,PrepareDefinesForMorphTargets:()=>ts.Jz,PrepareDefinesForMultiview:()=>ts.VO,PrepareDefinesForOIT:()=>ts.Nc,PrepareDefinesForPrePass:()=>ts.N4,PrepareUniformsAndSamplersForLight:()=>ts.GD,PrepareUniformsAndSamplersList:()=>ts.Bb,PressureObserverWrapper:()=>hC,PrimitiveTopology:()=>_a.P8,PrismaticConstraint:()=>XE,ProceduralTexture:()=>jd.p,ProceduralTextureSceneComponent:()=>Hf.a,PropertyTypeForEdition:()=>mh,ProximityCastResult:()=>SA,PushAttributesForInstances:()=>ts.te,PushMaterial:()=>Jr.E,QuadraticEase:()=>F.fA,QuadraticErrorSimplification:()=>OS,QuarticEase:()=>F.Q6,Quaternion:()=>ku.PT,QueryType:()=>_a.bO,QueueNewFrame:()=>$.r,QuinticEase:()=>F.q7,RGBDTextureTools:()=>ST.G,RSMCreatePluginMaterial:()=>tD,Ragdoll:()=>KE,RagdollBoneProperties:()=>QE,RandomBlock:()=>ey,RandomBlockLocks:()=>Tb,RandomGUID:()=>fv.z,RandomNumberBlock:()=>_x,RawCubeTexture:()=>$f.p,RawTexture:()=>He.I,RawTexture2DArray:()=>qf.L,RawTexture3D:()=>Yf,Ray:()=>st.Ray,RayHelper:()=>go,ReadFile:()=>Sf.NJ,ReadFileError:()=>Sf.VB,RecastJSCrowd:()=>wC,RecastJSPlugin:()=>NC,ReciprocalBlock:()=>vx,RectAreaLight:()=>pm,ReflectBlock:()=>Mx,ReflectionBlock:()=>Bx,ReflectionProbe:()=>Em,ReflectionTextureBaseBlock:()=>mg,ReflectionTextureBlock:()=>fg,ReflectiveShadowMap:()=>JM,Reflector:()=>lC,RefractBlock:()=>Dx,RefractionBlock:()=>kx,RefractionPostProcess:()=>XA,RefractionTexture:()=>Xf,RegisterClass:()=>a.Y5,RegisterMaterialPlugin:()=>Sv.YC,RegisterNativeTypeAsync:()=>na,RegisterSceneLoaderPlugin:()=>sd.qS,RegisterTargetForLateAnimationBinding:()=>O.BT,RemapBlock:()=>zd,RenderPassTimestampLocation:()=>_a.xf,RenderTargetTexture:()=>cr.$,RenderTargetWrapper:()=>Eo.v,RenderTargetsOptimization:()=>ZP.Ij,RenderingGroup:()=>SM.U,RenderingGroupInfo:()=>Eh.o,RenderingManager:()=>Eh.m,ReplaceColorBlock:()=>Sx,RequestFile:()=>Sf.sh,RequestFileError:()=>Sf.Mi,RequestFullscreen:()=>Ia.tl,RequestPointerlock:()=>Ia.eG,ResizeImageBitmap:()=>Ia.jf,RetryStrategy:()=>CT.a,ReverseLutFromBitmap:()=>Df.FG,RibbonBuilder:()=>en,RichType:()=>Va.D,RichTypeAny:()=>Va.Vv,RichTypeBoolean:()=>Va.RI,RichTypeColor3:()=>Va.Nf,RichTypeColor4:()=>Va.Gx,RichTypeFlowGraphInteger:()=>Va.x2,RichTypeMatrix:()=>Va.Sp,RichTypeMatrix2D:()=>Va.cZ,RichTypeMatrix3D:()=>Va.F4,RichTypeNumber:()=>Va.Es,RichTypeQuaternion:()=>Va.P_,RichTypeString:()=>Va.KV,RichTypeVector2:()=>Va.K$,RichTypeVector3:()=>Va.Dx,RichTypeVector4:()=>Va.Ko,RollingAverage:()=>jP.K,Rotate2dBlock:()=>Rx,RotationGizmo:()=>Mu,RotationXBlock:()=>py,RotationYBlock:()=>my,RotationZBlock:()=>fy,RuntimeAnimation:()=>B.x,RuntimeError:()=>jo.bu,SSAO2RenderingPipeline:()=>lI,SSAORenderingPipeline:()=>dI,SSRRenderingPipeline:()=>bI,SamplerBindingType:()=>_a.G8,Scalar:()=>Kv.X,ScaleBlock:()=>Xg,ScaleGizmo:()=>Nu,ScalingBlock:()=>_y,ScanData:()=>Ff.u,Scene:()=>it.Z,SceneComponentConstants:()=>Ei.v,SceneDepthBlock:()=>_g,SceneInstrumentation:()=>Tp,SceneLoader:()=>sd.cn,SceneLoaderAnimationGroupLoadingMode:()=>sd.gD,SceneLoaderFlags:()=>$m.B,SceneOptimization:()=>ZP.Cp,SceneOptimizer:()=>ZP.o8,SceneOptimizerOptions:()=>ZP.cR,ScenePerformancePriority:()=>it.F,SceneRecorder:()=>JT,SceneSerializer:()=>eT,ScreenSizeBlock:()=>k_,ScreenSpaceBlock:()=>G_,ScreenSpaceCurvaturePostProcess:()=>WI,ScreenSpaceReflectionPostProcess:()=>_I,ScreenshotTools:()=>xT,SerializationHelper:()=>Ue.p,SetBasisTranscoderWorker:()=>kP.af,SetColorsBlock:()=>jb,SetCorsBehavior:()=>Sf.M1,SetMaterialIDBlock:()=>hy,SetNormalsBlock:()=>Yb,SetParentAction:()=>T,SetPositionsBlock:()=>qb,SetStateAction:()=>_,SetTangentsBlock:()=>Zb,SetToDefaultGaussianSplatting:()=>f_,SetUVsBlock:()=>Xb,SetValueAction:()=>g,ShaderCodeInliner:()=>Uo.Y,ShaderLanguage:()=>uf,ShaderMaterial:()=>rs,ShaderStage:()=>_a.qd,ShaderStore:()=>qi.l,ShadowDepthWrapper:()=>gv,ShadowGenerator:()=>Ih,ShadowGeneratorSceneComponent:()=>tm,ShadowLight:()=>em.p,ShadowMapBlock:()=>H_,ShadowsOptimization:()=>ZP.Vh,ShapeBuilder:()=>Bn,ShapeCastResult:()=>bA,SharpenPostProcess:()=>ZA,SheenBlock:()=>Nx,SimplexPerlin3DBlock:()=>Ax,SimplicationQueueSceneComponent:()=>NS,SimplificationQueue:()=>AS,SimplificationSettings:()=>ES,SimplificationType:()=>PS,SineEase:()=>F.kc,SixDofDragBehavior:()=>gt,Size:()=>ku.or,Skeleton:()=>Ye.E,SkeletonViewer:()=>vo,SliderConstraint:()=>qE,SmartArray:()=>Ss.L,SmartArrayNoDuplicate:()=>Ss.b,SmoothStepBlock:()=>xx,SnapshotRenderingHelper:()=>vC.j,SolidParticle:()=>iE,SolidParticleSystem:()=>oE,SolidParticleVertex:()=>nE,Sound:()=>j.A,SoundState:()=>Se,SoundTrack:()=>Z.j,SourceTextureFormat:()=>Jf.Ok,Space:()=>ku.$x,SpatialAudioAttachmentType:()=>be,SpecularPowerToRoughness:()=>yp,SphereBlock:()=>Lb,SphereBuilder:()=>Us,SphereDirectedParticleEmitter:()=>kT,SphereParticleEmitter:()=>LT,Spherical:()=>tS,SphericalHarmonics:()=>iS.O,SphericalPolynomial:()=>iS.Q,SplatReaderBlock:()=>m_,SpotLight:()=>Vu.n,SpringConstraint:()=>jE,Sprite:()=>Im,SpriteManager:()=>Om,SpriteMap:()=>RO,SpriteMapFrameRotationDirection:()=>IO,SpritePackedManager:()=>MO,SpriteSceneComponent:()=>Mm,Stage:()=>Ei.B,StandardMaterial:()=>br.F,StandardMaterialDefines:()=>br.f,StandardRenderingPipeline:()=>vI,StartsWith:()=>qe.UH,StateCondition:()=>p,StaticSound:()=>de.k,StaticSoundBuffer:()=>pe.C,StencilOperation:()=>_a.eA,StencilState:()=>kO.K,StencilStateComposer:()=>GO.u,StepBlock:()=>nx,StereoscopicArcRotateCamera:()=>Ki,StereoscopicFreeCamera:()=>Ji,StereoscopicGamepadCamera:()=>er,StereoscopicInterlacePostProcess:()=>Zi,StereoscopicInterlacePostProcessI:()=>ji,StereoscopicScreenUniversalCamera:()=>ir,StereoscopicUniversalCamera:()=>tr,StickValues:()=>kt,StopAnimationAction:()=>S,StopSoundAction:()=>R,StorageBuffer:()=>Ft.K,StorageReadBlock:()=>ov,StorageTextureAccess:()=>_a.ne,StorageWriteBlock:()=>av,StoreOp:()=>_a.$r,StreamingSound:()=>me.G,StringDictionary:()=>li.w,StringTools:()=>qe.nQ,SubEmitter:()=>NT,SubEmitterType:()=>MT,SubMesh:()=>ip.K,SubSurfaceBlock:()=>Gx,SubSurfaceSceneComponent:()=>gM,Subdivide:()=>gb,SubdivideBlock:()=>lP,SubtractBlock:()=>sx,SurfaceMagnetismBehavior:()=>xt,SwitchBooleanAction:()=>f,SwitchInput:()=>bo.dR,TAARenderingPipeline:()=>yI,TBNBlock:()=>N_,TGATools:()=>oT.uT,Tags:()=>tT.Y,TargetCamera:()=>ui.F,TargetedAnimation:()=>L.TargetedAnimation,TeleportInBlock:()=>Dy,TeleportOutBlock:()=>Oy,TestBase64DataUrl:()=>Sf.ZP,TextFileAssetTask:()=>DP,Texture:()=>$e.g,TextureAspect:()=>_a.y2,TextureAssetTask:()=>wP,TextureBlock:()=>pg,TextureDimension:()=>_a.gZ,TextureFormat:()=>_a.nC,TextureOptimization:()=>ZP.NI,TexturePacker:()=>kf,TexturePackerFrame:()=>Lf,TextureSampleType:()=>_a.Kz,TextureSampler:()=>jf.u,TextureTools:()=>Vy.LO,TextureUsage:()=>_a.tT,TextureViewDimension:()=>_a.dL,ThinAnaglyphPostProcess:()=>Li,ThinBlackAndWhitePostProcess:()=>vc,ThinBloomEffect:()=>Cc,ThinBlurPostProcess:()=>Th,ThinChromaticAberrationPostProcess:()=>Mc,ThinCircleOfConfusionPostProcess:()=>Nc,ThinDepthOfFieldEffect:()=>Gc,ThinDepthOfFieldEffectBlurLevel:()=>uc,ThinEffectLayer:()=>rc,ThinEngine:()=>Pr.ThinEngine,ThinExtractHighlightsPostProcess:()=>Tc,ThinGlowBlurPostProcess:()=>ic,ThinGlowLayer:()=>sc,ThinHighlightLayer:()=>pc,ThinPassCubePostProcess:()=>dc.V,ThinPassPostProcess:()=>dc.m,ThinRenderTargetTexture:()=>Qf,ThinTexture:()=>Zf.D,TiledBoxBuilder:()=>cn,TiledPlaneBuilder:()=>an,TimerState:()=>mp.R$,TmpColors:()=>ku.IG,TmpVectors:()=>ku.AA,ToGammaSpace:()=>ku.rv,ToHalfFloat:()=>Vy.LZ,ToLinearSpace:()=>ku.tk,TonemapPostProcess:()=>NI,TonemappingOperator:()=>PI,Tools:()=>H.S0,TorusBlock:()=>Gb,TorusBuilder:()=>kr,TorusKnotBuilder:()=>pn,TouchCamera:()=>mi,TrailMesh:()=>CS,Trajectory:()=>iC,TrajectoryClassifier:()=>oC,TranscodeAsync:()=>kP.yk,TranscodeTarget:()=>Jf.Xl,TransformBlock:()=>Ad,TransformFeedbackBoundingHelper:()=>gs.TransformFeedbackBoundingHelper,TransformNode:()=>mt.V,TranslationBlock:()=>xy,TriPlanarBlock:()=>Kx,TrigonometryBlock:()=>Zd,TrigonometryBlockOperations:()=>Xd,TubeBuilder:()=>Gn,TwirlBlock:()=>z_,UncompressPIZ:()=>Mf.tg,UncompressPXR:()=>Mf._k,UncompressRAW:()=>Mf.S4,UncompressRLE:()=>Mf.r,UncompressZIP:()=>Mf.VE,UniformBuffer:()=>hr.D,UniversalCamera:()=>Oi,UnregisterAllMaterialPlugins:()=>Sv.tC,UnregisterMaterialPlugin:()=>Sv.lM,UploadContent:()=>oT.FA,UploadEnvLevelsAsync:()=>zo.o5,UploadEnvSpherical:()=>zo.ow,UploadIrradianceLevelsAsync:()=>zo.p$,UploadRadianceLevelsAsync:()=>zo.UA,UtilityLayerRenderer:()=>Rs,VRCameraMetrics:()=>sr,VRDeviceOrientationArcRotateCamera:()=>gr,VRDeviceOrientationFreeCamera:()=>xr,VRDeviceOrientationGamepadCamera:()=>vr,VRDistortionCorrectionPostProcess:()=>nr,VRExperienceHelper:()=>Wr,VRMultiviewToSingleviewPostProcess:()=>fr,ValidatedNativeDataStream:()=>ca,ValueCondition:()=>u,Vector2:()=>ku.I9,Vector2ToFixed:()=>rS,Vector3:()=>ku.Pq,Vector3ToFixed:()=>sS,Vector4:()=>ku.IU,Vector4ToFixed:()=>nS,VectorConverterBlock:()=>ay,VectorMergerBlock:()=>Gd,VectorSplitterBlock:()=>tx,VertexAnimationBaker:()=>Xe,VertexBuffer:()=>Ot.R,VertexData:()=>ot.P,VertexDataMaterialInfo:()=>ot.o,VertexFormat:()=>_a.ym,VertexOutputBlock:()=>Id,VertexStepMode:()=>_a.ab,VideoDome:()=>bp,VideoRecorder:()=>aT,VideoTexture:()=>Sp,ViewDirectionBlock:()=>ax,Viewport:()=>ku.LM,VirtualJoystick:()=>hi,VirtualJoysticksCamera:()=>rr,VolumetricLightScatteringPostProcess:()=>GI,VoronoiNoiseBlock:()=>Zx,Wav2Decode:()=>Df.tb,WaveBlock:()=>yx,WaveBlockKind:()=>lx,WebGL2ParticleSystem:()=>zC,WebGL2ShaderProcessor:()=>Ea.B,WebGLDataBuffer:()=>QS.A,WebGLHardwareTexture:()=>Er.d,WebGLPipelineContext:()=>fa.x,WebGPUCacheBindGroups:()=>va.k,WebGPUCacheRenderPipeline:()=>ga.D,WebGPUCacheRenderPipelineTree:()=>xa.V,WebGPUCacheSampler:()=>Sa.R,WebGPUDataBuffer:()=>KS.p,WebGPUDrawContext:()=>ba.O,WebGPUEngine:()=>ua.WebGPUEngine,WebGPUPipelineContext:()=>ya.s,WebGPURenderTargetWrapper:()=>Pa.H,WebGPUShaderProcessor:()=>Ta.q,WebGPUTintWASM:()=>Ca.g,WebRequest:()=>Kr.u,WebXRAbstractFeature:()=>md,WebXRAbstractMotionController:()=>nd,WebXRAnchorSystem:()=>WO,WebXRBackgroundRemover:()=>qO,WebXRCamera:()=>td,WebXRControllerComponent:()=>rd,WebXRControllerMovement:()=>iN,WebXRControllerPhysics:()=>XO,WebXRControllerPointerSelection:()=>fd,WebXRDefaultExperience:()=>gp,WebXRDefaultExperienceOptions:()=>_p,WebXRDepthSensing:()=>MN,WebXRDomOverlay:()=>tN,WebXREnterExitUI:()=>ap,WebXREnterExitUIButton:()=>np,WebXREnterExitUIOptions:()=>op,WebXRExperienceHelper:()=>id,WebXREyeTracking:()=>nN,WebXRFeatureName:()=>Tt,WebXRFeaturePointSystem:()=>ZO,WebXRFeaturesManager:()=>Ct,WebXRGenericHandController:()=>kN,WebXRGenericTriggerMotionController:()=>od,WebXRHTCViveMotionController:()=>$N,WebXRHand:()=>dp,WebXRHandJoint:()=>hp,WebXRHandTracking:()=>pp,WebXRHitTest:()=>jO,WebXRHitTestLegacy:()=>zO,WebXRImageTracking:()=>eN,WebXRInput:()=>pd,WebXRInputSource:()=>dd,WebXRLayerRenderTargetTextureProvider:()=>Ar,WebXRLayers:()=>gN,WebXRLightEstimation:()=>sN,WebXRManagedOutputCanvas:()=>Dr,WebXRManagedOutputCanvasOptions:()=>Mr,WebXRMeshDetector:()=>KO,WebXRMicrosoftMixedRealityController:()=>zN,WebXRMotionControllerManager:()=>cd,WebXRMotionControllerTeleportation:()=>fp,WebXRNearControllerMode:()=>tp,WebXRNearInteraction:()=>sp,WebXROculusTouchMotionController:()=>WN,WebXRPlaneDetector:()=>$O,WebXRProfiledMotionController:()=>ld,WebXRRawCameraAccess:()=>LN,WebXRSessionManager:()=>Fr,WebXRSpaceWarp:()=>VN,WebXRSpaceWarpRenderTargetTextureProvider:()=>BN,WebXRState:()=>DO,WebXRTrackingState:()=>OO,WebXRWalkingLocomotion:()=>cN,WeightedSound:()=>Q.r,WorkerPool:()=>lT.T,WorleyNoise3DBlock:()=>Ex,XRSpaceWarpRenderTarget:()=>FN,Xbox360Button:()=>yi,Xbox360Dpad:()=>Pi,Xbox360Pad:()=>Ii,XboxInput:()=>bo.sZ,_AudioAnalyzerDefaults:()=>fe.IR,_BabylonLoaderRegistered:()=>Nm,_BasisTextureLoader:()=>Af._BasisTextureLoader,_CommonDispose:()=>Ia.kX,_CommonInit:()=>Ia.BG,_CreationDataStorage:()=>tt.Ez,_DDSTextureLoader:()=>Ku._DDSTextureLoader,_ENVTextureLoader:()=>Ju._ENVTextureLoader,_ExrTextureLoader:()=>If._ExrTextureLoader,_GetAudioEngine:()=>ne,_GetCompatibleTextureLoader:()=>ia.gT,_HDRTextureLoader:()=>Ef._HDRTextureLoader,_HasAudioAnalyzerOptions:()=>fe.GA,_HasSpatialAudioListenerOptions:()=>xe,_HasSpatialAudioOptions:()=>_e.GB,_HasStereoAudioOptions:()=>ye.uD,_IESTextureLoader:()=>Rf._IESTextureLoader,_InstancesBatch:()=>tt._h,_KTXTextureLoader:()=>ed._KTXTextureLoader,_MeshCollisionData:()=>Zr.j,_OcclusionDataStorage:()=>Do.W,_PrimaryIsoTriangle:()=>ro,_SpatialAudioDefaults:()=>_e.Qc,_SpatialAudioListenerDefaults:()=>ge,_StereoAudioDefaults:()=>ye.uJ,_TGATextureLoader:()=>Cf._TGATextureLoader,_TimeToken:()=>Fo,_UpdateRGBDAsync:()=>zo.gW,_WebAudioBus:()=>Pe._WebAudioBus,_WebAudioEngine:()=>Be,_WebAudioMainBus:()=>Ve._WebAudioMainBus,_WebAudioStaticSound:()=>Le._WebAudioStaticSound,_WebAudioStaticSoundBuffer:()=>Le._WebAudioStaticSoundBuffer,_WebAudioStreamingSound:()=>ke._WebAudioStreamingSound,_forceSceneHelpersToBundle:()=>xp,_forceTransformFeedbackToBundle:()=>Bo,_injectLTSFileTools:()=>Sf.rh,_staticOffsetValueColor3:()=>M.eA,_staticOffsetValueColor4:()=>M.nl,_staticOffsetValueQuaternion:()=>M.s$,_staticOffsetValueSize:()=>M.vF,_staticOffsetValueVector2:()=>M.rq,_staticOffsetValueVector3:()=>M.y4,addClipPlaneUniforms:()=>es.TV,addToBlockFactory:()=>Ul.Q,allocateAndCopyTypedBuffer:()=>Lo.k,anaglyphPixelShader:()=>yR.anaglyphPixelShader,anaglyphPixelShaderWGSL:()=>PR.anaglyphPixelShaderWGSL,appendSceneAsync:()=>sd.VU,backbufferColorTextureHandle:()=>Ql,backbufferDepthStencilTextureHandle:()=>Kl,backgroundPixelShader:()=>jm.backgroundPixelShader,backgroundPixelShaderWGSL:()=>Ym.backgroundPixelShaderWGSL,backgroundVertexShader:()=>Xm.backgroundVertexShader,backgroundVertexShaderWGSL:()=>qm.backgroundVertexShaderWGSL,bilateralBlurPixelShader:()=>oD.bilateralBlurPixelShader,bilateralBlurPixelShaderWGSL:()=>cD.bilateralBlurPixelShaderWGSL,bilateralBlurQualityPixelShader:()=>aD.bilateralBlurQualityPixelShader,bilateralBlurQualityPixelShaderWGSL:()=>uD.bilateralBlurQualityPixelShaderWGSL,bindClipPlane:()=>es.gS,blackAndWhitePixelShader:()=>SR.blackAndWhitePixelShader,blackAndWhitePixelShaderWGSL:()=>bR.blackAndWhitePixelShaderWGSL,blockFactory:()=>Ul.e,bloomMergePixelShader:()=>dR.bloomMergePixelShader,bloomMergePixelShaderWGSL:()=>pR.bloomMergePixelShaderWGSL,bonesDeclaration:()=>y_.bonesDeclaration,bonesDeclarationWGSL:()=>S_.bonesDeclarationWGSL,bonesVertex:()=>P_.bonesVertex,bonesVertexWGSL:()=>b_.bonesVertexWGSL,boundingBoxRendererPixelShader:()=>xD.boundingBoxRendererPixelShader,boundingBoxRendererPixelShaderWGSL:()=>SD.boundingBoxRendererPixelShaderWGSL,boundingBoxRendererVertexShader:()=>vD.boundingBoxRendererVertexShader,boundingBoxRendererVertexShaderWGSL:()=>bD.boundingBoxRendererVertexShaderWGSL,bumpFragment:()=>tg.bumpFragment,bumpFragmentFunctions:()=>rg.bumpFragmentFunctions,bumpFragmentFunctionsWGSL:()=>eg.bumpFragmentFunctionsWGSL,bumpFragmentMainFunctions:()=>ig.bumpFragmentMainFunctions,bumpFragmentMainFunctionsWGSL:()=>J_.bumpFragmentMainFunctionsWGSL,bumpFragmentWGSL:()=>K_.bumpFragmentWGSL,captureEquirectangularFromScene:()=>yC,chromaticAberrationPixelShader:()=>tI.chromaticAberrationPixelShader,chromaticAberrationPixelShaderWGSL:()=>aR.chromaticAberrationPixelShaderWGSL,circleOfConfusionPixelShader:()=>cR.circleOfConfusionPixelShader,circleOfConfusionPixelShaderWGSL:()=>uR.circleOfConfusionPixelShaderWGSL,className:()=>H.s7,clipPlaneFragment:()=>yg.clipPlaneFragment,clipPlaneFragmentDeclaration:()=>Pg.clipPlaneFragmentDeclaration,clipPlaneFragmentDeclarationWGSL:()=>vg.clipPlaneFragmentDeclarationWGSL,clipPlaneFragmentWGSL:()=>xg.clipPlaneFragmentWGSL,clipPlaneVertex:()=>Tg.clipPlaneVertex,clipPlaneVertexDeclaration:()=>Cg.clipPlaneVertexDeclaration,clipPlaneVertexDeclarationWGSL:()=>bg.clipPlaneVertexDeclarationWGSL,clipPlaneVertexWGSL:()=>Sg.clipPlaneVertexWGSL,colorCorrectionPixelShader:()=>ER.colorCorrectionPixelShader,colorCorrectionPixelShaderWGSL:()=>AR.colorCorrectionPixelShaderWGSL,colorPixelShader:()=>Jm.colorPixelShader,colorPixelShaderWGSL:()=>uP.colorPixelShaderWGSL,colorVertexShader:()=>ef.colorVertexShader,colorVertexShaderWGSL:()=>dP.colorVertexShaderWGSL,computeMaxExtents:()=>wS.J,convolutionPixelShader:()=>TR.convolutionPixelShader,convolutionPixelShaderWGSL:()=>CR.convolutionPixelShaderWGSL,copyTexture3DLayerToTexturePixelShader:()=>MD.copyTexture3DLayerToTexturePixelShader,copyTexture3DLayerToTexturePixelShaderWGSL:()=>DD.copyTexture3DLayerToTexturePixelShaderWGSL,copyTextureToTexturePixelShader:()=>MC.copyTextureToTexturePixelShader,copyTextureToTexturePixelShaderWGSL:()=>DC.copyTextureToTexturePixelShaderWGSL,createDetailMapPlugin:()=>Mv,createPBRAnisotropicPlugin:()=>Tv,createPBRBRDFPlugin:()=>Cv,createPBRClearCoatPlugin:()=>Ev,createPBRIridescencePlugin:()=>Av,createPBRSheenPlugin:()=>Iv,createPBRSubSurfacePlugin:()=>Rv,createYieldingScheduler:()=>xC.VP,deepMerge:()=>dS.$,defaultPixelShader:()=>Hv.defaultPixelShader,defaultPixelShaderWGSL:()=>qv.defaultPixelShaderWGSL,defaultVertexShader:()=>$v.defaultVertexShader,defaultVertexShaderWGSL:()=>Yv.defaultVertexShaderWGSL,depthBoxBlurPixelShader:()=>lm.depthBoxBlurPixelShader,depthBoxBlurPixelShaderWGSL:()=>sm.depthBoxBlurPixelShaderWGSL,depthOfFieldMergePixelShader:()=>lR.depthOfFieldMergePixelShader,depthOfFieldMergePixelShaderWGSL:()=>hR.depthOfFieldMergePixelShaderWGSL,depthPixelShader:()=>Rh.depthPixelShader,depthPixelShaderWGSL:()=>mD.depthPixelShaderWGSL,depthVertexShader:()=>Mh.depthVertexShader,depthVertexShaderWGSL:()=>fD.depthVertexShaderWGSL,displayPassPixelShader:()=>wR.displayPassPixelShader,displayPassPixelShaderWGSL:()=>FR.displayPassPixelShaderWGSL,editableInPropertyPage:()=>xh,expandToProperty:()=>ze.$z,extractHighlightsPixelShader:()=>mR.extractHighlightsPixelShader,extractHighlightsPixelShaderWGSL:()=>fR.extractHighlightsPixelShaderWGSL,extractMinAndMax:()=>Jv.b8,extractMinAndMaxIndexed:()=>Jv.cD,filterPixelShader:()=>MR.filterPixelShader,filterPixelShaderWGSL:()=>DR.filterPixelShaderWGSL,fluidRenderingBilateralBlurPixelShader:()=>kM.fluidRenderingBilateralBlurPixelShader,fluidRenderingBilateralBlurPixelShaderWGSL:()=>ZM.fluidRenderingBilateralBlurPixelShaderWGSL,fluidRenderingParticleDepthPixelShader:()=>OM.fluidRenderingParticleDepthPixelShader,fluidRenderingParticleDepthPixelShaderWGSL:()=>WM.fluidRenderingParticleDepthPixelShaderWGSL,fluidRenderingParticleDepthVertexShader:()=>DM.fluidRenderingParticleDepthVertexShader,fluidRenderingParticleDepthVertexShaderWGSL:()=>UM.fluidRenderingParticleDepthVertexShaderWGSL,fluidRenderingParticleDiffusePixelShader:()=>LM.fluidRenderingParticleDiffusePixelShader,fluidRenderingParticleDiffusePixelShaderWGSL:()=>jM.fluidRenderingParticleDiffusePixelShaderWGSL,fluidRenderingParticleDiffuseVertexShader:()=>VM,fluidRenderingParticleDiffuseVertexShaderWGSL:()=>XM,fluidRenderingParticleThicknessPixelShader:()=>wM.fluidRenderingParticleThicknessPixelShader,fluidRenderingParticleThicknessPixelShaderWGSL:()=>$M.fluidRenderingParticleThicknessPixelShaderWGSL,fluidRenderingParticleThicknessVertexShader:()=>NM.fluidRenderingParticleThicknessVertexShader,fluidRenderingParticleThicknessVertexShaderWGSL:()=>HM.fluidRenderingParticleThicknessVertexShaderWGSL,fluidRenderingRenderPixelShader:()=>zM.fluidRenderingRenderPixelShader,fluidRenderingRenderPixelShaderWGSL:()=>KM.fluidRenderingRenderPixelShaderWGSL,fluidRenderingStandardBlurPixelShader:()=>GM.fluidRenderingStandardBlurPixelShader,fluidRenderingStandardBlurPixelShaderWGSL:()=>QM.fluidRenderingStandardBlurPixelShaderWGSL,fogFragmentDeclaration:()=>Ag.fogFragmentDeclaration,fogFragmentDeclarationWGSL:()=>Eg.fogFragmentDeclarationWGSL,fxaaPixelShader:()=>_R.fxaaPixelShader,fxaaPixelShaderWGSL:()=>xR.fxaaPixelShaderWGSL,fxaaVertexShader:()=>gR.fxaaVertexShader,fxaaVertexShaderWGSL:()=>vR.fxaaVertexShaderWGSL,gaussianSplattingVertexDeclaration:()=>dv.Q,gaussianSplattingVertexDeclarationWGSL:()=>uv,geometryPixelShader:()=>kA.geometryPixelShader,geometryPixelShaderWGSL:()=>_D.geometryPixelShaderWGSL,geometryVertexShader:()=>GA.geometryVertexShader,geometryVertexShaderWGSL:()=>gD.geometryVertexShaderWGSL,getAnimationTypeByFlowGraphType:()=>Va.U_,getDimensionsFromTextureSize:()=>ch,getRichTypeByAnimationType:()=>Va.aZ,getRichTypeByFlowGraphType:()=>Va.Yd,getRichTypeFromValue:()=>Va.k4,glowBlurPostProcessPixelShader:()=>kp.glowBlurPostProcessPixelShader,glowBlurPostProcessPixelShaderWGSL:()=>Up.glowBlurPostProcessPixelShaderWGSL,glowMapGenerationPixelShader:()=>Np.glowMapGenerationPixelShader,glowMapGenerationPixelShaderWGSL:()=>Fp.glowMapGenerationPixelShaderWGSL,glowMapGenerationVertexShader:()=>wp.glowMapGenerationVertexShader,glowMapGenerationVertexShaderWGSL:()=>Bp.glowMapGenerationVertexShaderWGSL,glowMapMergePixelShader:()=>Vp.glowMapMergePixelShader,glowMapMergePixelShaderWGSL:()=>Gp.glowMapMergePixelShaderWGSL,glowMapMergeVertexShader:()=>Lp.glowMapMergeVertexShader,glowMapMergeVertexShaderWGSL:()=>zp.glowMapMergeVertexShaderWGSL,grainPixelShader:()=>nR.grainPixelShader,grainPixelShaderWGSL:()=>oR.grainPixelShaderWGSL,greasedLinePixelShader:()=>Xv.greasedLinePixelShader,greasedLinePixelShaderWGSL:()=>Zv.greasedLinePixelShaderWGSL,greasedLineVertexShader:()=>jv.greasedLineVertexShader,greasedLineVertexShaderWGSL:()=>Qv.greasedLineVertexShaderWGSL,hdrFilteringPixelShader:()=>r_.hdrFilteringPixelShader,hdrFilteringPixelShaderWGSL:()=>n_.hdrFilteringPixelShaderWGSL,hdrFilteringVertexShader:()=>i_.hdrFilteringVertexShader,hdrFilteringVertexShaderWGSL:()=>s_.hdrFilteringVertexShaderWGSL,hdrIrradianceFilteringPixelShader:()=>a_.hdrIrradianceFilteringPixelShader,hdrIrradianceFilteringPixelShaderWGSL:()=>h_.hdrIrradianceFilteringPixelShaderWGSL,hdrIrradianceFilteringVertexShader:()=>o_.hdrIrradianceFilteringVertexShader,hdrIrradianceFilteringVertexShaderWGSL:()=>l_.hdrIrradianceFilteringVertexShaderWGSL,helperFunctions:()=>j_.helperFunctions,helperFunctionsWGSL:()=>q_.helperFunctionsWGSL,highlightsPixelShader:()=>OR.highlightsPixelShader,highlightsPixelShaderWGSL:()=>NR.highlightsPixelShaderWGSL,iblCdfDebugPixelShader:()=>nO.iblCdfDebugPixelShader,iblCdfDebugPixelShaderWGSL:()=>sO.iblCdfDebugPixelShaderWGSL,iblCdfxPixelShader:()=>JD.iblCdfxPixelShader,iblCdfxPixelShaderWGSL:()=>KD.iblCdfxPixelShaderWGSL,iblCdfyPixelShader:()=>tO.iblCdfyPixelShader,iblCdfyPixelShaderWGSL:()=>eO.iblCdfyPixelShaderWGSL,iblCombineVoxelGridsPixelShader:()=>YD.iblCombineVoxelGridsPixelShader,iblCombineVoxelGridsPixelShaderWGSL:()=>qD.iblCombineVoxelGridsPixelShaderWGSL,iblGenerateVoxelMipPixelShader:()=>XD.iblGenerateVoxelMipPixelShader,iblGenerateVoxelMipPixelShaderWGSL:()=>jD.iblGenerateVoxelMipPixelShaderWGSL,iblIcdfPixelShader:()=>rO.iblIcdfPixelShader,iblIcdfPixelShaderWGSL:()=>iO.iblIcdfPixelShaderWGSL,iblScaledLuminancePixelShader:()=>aO.iblScaledLuminancePixelShader,iblScaledLuminancePixelShaderWGSL:()=>oO.iblScaledLuminancePixelShaderWGSL,iblShadowAccumulationPixelShader:()=>kD.iblShadowAccumulationPixelShader,iblShadowAccumulationPixelShaderWGSL:()=>LD.iblShadowAccumulationPixelShaderWGSL,iblShadowDebugPixelShader:()=>wD.iblShadowDebugPixelShader,iblShadowDebugPixelShaderWGSL:()=>FD.iblShadowDebugPixelShaderWGSL,iblShadowGBufferDebugPixelShader:()=>ZD.iblShadowGBufferDebugPixelShader,iblShadowGBufferDebugPixelShaderWGSL:()=>QD.iblShadowGBufferDebugPixelShaderWGSL,iblShadowSpatialBlurPixelShader:()=>VD.iblShadowSpatialBlurPixelShader,iblShadowSpatialBlurPixelShaderWGSL:()=>BD.iblShadowSpatialBlurPixelShaderWGSL,iblShadowVoxelTracingPixelShader:()=>OD.iblShadowVoxelTracingPixelShader,iblShadowVoxelTracingPixelShaderWGSL:()=>ND.iblShadowVoxelTracingPixelShaderWGSL,iblShadowsCombinePixelShader:()=>UD,iblShadowsCombinePixelShaderWGSL:()=>$D,iblVoxelGrid2dArrayDebugPixelShader:()=>lO.iblVoxelGrid2dArrayDebugPixelShader,iblVoxelGrid2dArrayDebugPixelShaderWGSL:()=>hO.iblVoxelGrid2dArrayDebugPixelShaderWGSL,iblVoxelGrid3dDebugPixelShader:()=>mO.iblVoxelGrid3dDebugPixelShader,iblVoxelGrid3dDebugPixelShaderWGSL:()=>fO.iblVoxelGrid3dDebugPixelShaderWGSL,iblVoxelGridPixelShader:()=>cO.iblVoxelGridPixelShader,iblVoxelGridPixelShaderWGSL:()=>dO.iblVoxelGridPixelShaderWGSL,iblVoxelGridVertexShader:()=>uO.iblVoxelGridVertexShader,iblVoxelGridVertexShaderWGSL:()=>pO.iblVoxelGridVertexShaderWGSL,iblVoxelSlabDebugPixelShader:()=>gO.iblVoxelSlabDebugPixelShader,iblVoxelSlabDebugPixelShaderWGSL:()=>vO.iblVoxelSlabDebugPixelShaderWGSL,iblVoxelSlabDebugVertexShader:()=>_O.iblVoxelSlabDebugVertexShader,iblVoxelSlabDebugVertexShaderWGSL:()=>xO.iblVoxelSlabDebugVertexShaderWGSL,imageProcessingDeclaration:()=>Z_.imageProcessingDeclaration,imageProcessingDeclarationWGSL:()=>Y_.imageProcessingDeclarationWGSL,imageProcessingFunctions:()=>Q_.imageProcessingFunctions,imageProcessingFunctionsWGSL:()=>X_.imageProcessingFunctionsWGSL,imageProcessingPixelShader:()=>rR.imageProcessingPixelShader,imageProcessingPixelShaderWGSL:()=>iR.imageProcessingPixelShaderWGSL,importAnimationsAsync:()=>sd.fV,inlineScheduler:()=>xC.FE,kernelBlurPixelShader:()=>qI.kernelBlurPixelShader,kernelBlurPixelShaderWGSL:()=>XI.kernelBlurPixelShaderWGSL,kernelBlurVertexShader:()=>YI.kernelBlurVertexShader,kernelBlurVertexShaderWGSL:()=>jI.kernelBlurVertexShaderWGSL,layerPixelShader:()=>Wp.layerPixelShader,layerPixelShaderWGSL:()=>$p.layerPixelShaderWGSL,layerVertexShader:()=>Hp.layerVertexShader,layerVertexShaderWGSL:()=>qp.layerVertexShaderWGSL,lensFlarePixelShader:()=>Zp.lensFlarePixelShader,lensFlarePixelShaderWGSL:()=>Kp.lensFlarePixelShaderWGSL,lensFlareVertexShader:()=>Qp.lensFlareVertexShader,lensFlareVertexShaderWGSL:()=>Jp.lensFlareVertexShaderWGSL,lightFragment:()=>Fg.lightFragment,lightFragmentDeclaration:()=>wg.lightFragmentDeclaration,lightFragmentWGSL:()=>Ig.lightFragmentWGSL,lightUboDeclaration:()=>Bg.lightUboDeclaration,lightUboDeclarationWGSL:()=>Rg.lightUboDeclarationWGSL,lightVxFragmentDeclaration:()=>Lg.lightVxFragmentDeclaration,lightVxUboDeclaration:()=>Vg.lightVxUboDeclaration,lightVxUboDeclarationWGSL:()=>Mg.lightVxUboDeclarationWGSL,lightsFragmentFunctions:()=>kg.lightsFragmentFunctions,lightsFragmentFunctionsWGSL:()=>Dg.lightsFragmentFunctionsWGSL,linePixelShader:()=>yD.linePixelShader,linePixelShaderWGSL:()=>TD.linePixelShaderWGSL,lineVertexShader:()=>PD.lineVertexShader,lineVertexShaderWGSL:()=>CD.lineVertexShaderWGSL,loadAssetContainerAsync:()=>sd.kS,loadSceneAsync:()=>sd.VA,lodCubePixelShader:()=>iT.lodCubePixelShader,lodCubePixelShaderWGSL:()=>sT.lodCubePixelShaderWGSL,lodPixelShader:()=>rT.lodPixelShader,lodPixelShaderWGSL:()=>nT.lodPixelShaderWGSL,makeAsyncFunction:()=>xC.xu,makeSyncFunction:()=>xC.Aj,meshUVSpaceRendererFinaliserPixelShader:()=>gP.meshUVSpaceRendererFinaliserPixelShader,meshUVSpaceRendererFinaliserPixelShaderWGSL:()=>PP.meshUVSpaceRendererFinaliserPixelShaderWGSL,meshUVSpaceRendererFinaliserVertexShader:()=>xP.meshUVSpaceRendererFinaliserVertexShader,meshUVSpaceRendererFinaliserVertexShaderWGSL:()=>TP.meshUVSpaceRendererFinaliserVertexShaderWGSL,meshUVSpaceRendererMaskerPixelShader:()=>_P.meshUVSpaceRendererMaskerPixelShader,meshUVSpaceRendererMaskerPixelShaderWGSL:()=>yP.meshUVSpaceRendererMaskerPixelShaderWGSL,meshUVSpaceRendererMaskerVertexShader:()=>fP.meshUVSpaceRendererMaskerVertexShader,meshUVSpaceRendererMaskerVertexShaderWGSL:()=>bP.meshUVSpaceRendererMaskerVertexShaderWGSL,meshUVSpaceRendererPixelShader:()=>mP.meshUVSpaceRendererPixelShader,meshUVSpaceRendererPixelShaderWGSL:()=>SP.meshUVSpaceRendererPixelShaderWGSL,meshUVSpaceRendererVertexShader:()=>pP.meshUVSpaceRendererVertexShader,meshUVSpaceRendererVertexShaderWGSL:()=>vP.meshUVSpaceRendererVertexShaderWGSL,morphTargetsVertex:()=>I_.morphTargetsVertex,morphTargetsVertexDeclaration:()=>R_.morphTargetsVertexDeclaration,morphTargetsVertexDeclarationWGSL:()=>C_.morphTargetsVertexDeclarationWGSL,morphTargetsVertexGlobal:()=>M_.morphTargetsVertexGlobal,morphTargetsVertexGlobalDeclaration:()=>D_.morphTargetsVertexGlobalDeclaration,morphTargetsVertexGlobalDeclarationWGSL:()=>A_.morphTargetsVertexGlobalDeclarationWGSL,morphTargetsVertexGlobalWGSL:()=>E_.morphTargetsVertexGlobalWGSL,morphTargetsVertexWGSL:()=>T_.morphTargetsVertexWGSL,motionBlurPixelShader:()=>IR.motionBlurPixelShader,motionBlurPixelShaderWGSL:()=>RR.motionBlurPixelShaderWGSL,nativeOverride:()=>ze.Cx,normalizeEnvInfo:()=>zo.RZ,oitBackBlendPixelShader:()=>SO.oitBackBlendPixelShader,oitBackBlendPixelShaderWGSL:()=>yO.oitBackBlendPixelShaderWGSL,oitFinalPixelShader:()=>bO.oitFinalPixelShader,oitFinalPixelShaderWGSL:()=>PO.oitFinalPixelShaderWGSL,outlinePixelShader:()=>ED.outlinePixelShader,outlinePixelShaderWGSL:()=>ID.outlinePixelShaderWGSL,outlineVertexShader:()=>AD.outlineVertexShader,outlineVertexShaderWGSL:()=>RD.outlineVertexShaderWGSL,packingFunctions:()=>lg.packingFunctions,packingFunctionsWGSL:()=>ng.packingFunctionsWGSL,particlesPixelShader:()=>TE.particlesPixelShader,particlesPixelShaderWGSL:()=>EE.particlesPixelShaderWGSL,particlesVertexShader:()=>CE.particlesVertexShader,particlesVertexShaderWGSL:()=>AE.particlesVertexShaderWGSL,passCubePixelShader:()=>QI.passCubePixelShader,passCubePixelShaderWGSL:()=>JI.passCubePixelShaderWGSL,passPixelShader:()=>ZI.passPixelShader,passPixelShaderWGSL:()=>KI.passPixelShaderWGSL,pbrPixelShader:()=>gf.pbrPixelShader,pbrPixelShaderWGSL:()=>ff.pbrPixelShaderWGSL,pbrVertexShader:()=>_f.pbrVertexShader,pbrVertexShaderWGSL:()=>mf.pbrVertexShaderWGSL,pickingPixelShader:()=>os.pickingPixelShader,pickingPixelShaderWGSL:()=>ls.pickingPixelShaderWGSL,pickingVertexShader:()=>as.pickingVertexShader,pickingVertexShaderWGSL:()=>hs.pickingVertexShaderWGSL,postprocessVertexShader:()=>HI.postprocessVertexShader,postprocessVertexShaderWGSL:()=>$I.postprocessVertexShaderWGSL,prepareDefinesForClipPlanes:()=>es.Eq,prepareStringDefinesForClipPlanes:()=>es.tv,proceduralVertexShader:()=>t_.proceduralVertexShader,proceduralVertexShaderWGSL:()=>e_.proceduralVertexShaderWGSL,reflectionFunction:()=>Wg.reflectionFunction,reflectionFunctionWGSL:()=>Ug.reflectionFunctionWGSL,registerSceneLoaderPlugin:()=>sd.cH,registerTextureLoader:()=>ia.kf,rgbdDecodePixelShader:()=>EC.rgbdDecodePixelShader,rgbdDecodePixelShaderWGSL:()=>IC.rgbdDecodePixelShaderWGSL,rgbdEncodePixelShader:()=>AC.rgbdEncodePixelShader,rgbdEncodePixelShaderWGSL:()=>RC.rgbdEncodePixelShaderWGSL,rsmFullGlobalIlluminationPixelShader:()=>hD.rsmFullGlobalIlluminationPixelShader,rsmFullGlobalIlluminationPixelShaderWGSL:()=>pD.rsmFullGlobalIlluminationPixelShaderWGSL,rsmGlobalIlluminationPixelShader:()=>lD.rsmGlobalIlluminationPixelShader,rsmGlobalIlluminationPixelShaderWGSL:()=>dD.rsmGlobalIlluminationPixelShaderWGSL,runCoroutine:()=>xC.aw,runCoroutineAsync:()=>xC.kj,runCoroutineSync:()=>xC.V1,screenSpaceReflection2BlurCombinerPixelShader:()=>RI.screenSpaceReflection2BlurCombinerPixelShader,screenSpaceReflection2BlurCombinerPixelShaderWGSL:()=>OI.screenSpaceReflection2BlurCombinerPixelShaderWGSL,screenSpaceReflection2BlurPixelShader:()=>II.screenSpaceReflection2BlurPixelShader,screenSpaceReflection2BlurPixelShaderWGSL:()=>DI.screenSpaceReflection2BlurPixelShaderWGSL,screenSpaceReflection2PixelShader:()=>AI.screenSpaceReflection2PixelShader,screenSpaceReflection2PixelShaderWGSL:()=>MI.screenSpaceReflection2PixelShaderWGSL,serialize:()=>ze.lK,serializeAsCameraReference:()=>ze.fW,serializeAsColor3:()=>ze.jT,serializeAsColor4:()=>ze.qK,serializeAsColorCurves:()=>ze.wL,serializeAsFresnelParameters:()=>ze.Y9,serializeAsImageProcessingConfiguration:()=>ze.n1,serializeAsMatrix:()=>ze.GG,serializeAsMeshReference:()=>ze.xG,serializeAsQuaternion:()=>ze.bR,serializeAsTexture:()=>ze.uM,serializeAsVector2:()=>ze.WM,serializeAsVector3:()=>ze.P_,setAndStartTimer:()=>mp.fj,setOpenGLOrientationForUV:()=>at.ge,setStereoscopicAnaglyphRigMode:()=>Gi,setStereoscopicRigMode:()=>Qi,setVRRigMode:()=>_r,shadowMapFragment:()=>hg.shadowMapFragment,shadowMapFragmentSoftTransparentShadow:()=>hm.shadowMapFragmentSoftTransparentShadow,shadowMapFragmentSoftTransparentShadowWGSL:()=>nm.shadowMapFragmentSoftTransparentShadowWGSL,shadowMapFragmentWGSL:()=>og.shadowMapFragmentWGSL,shadowMapPixelShader:()=>om.shadowMapPixelShader,shadowMapPixelShaderWGSL:()=>im.shadowMapPixelShaderWGSL,shadowMapVertexMetric:()=>ag.shadowMapVertexMetric,shadowMapVertexMetricWGSL:()=>sg.shadowMapVertexMetricWGSL,shadowMapVertexShader:()=>am.shadowMapVertexShader,shadowMapVertexShaderWGSL:()=>rm.shadowMapVertexShaderWGSL,shadowsFragmentFunctions:()=>Gg.shadowsFragmentFunctions,shadowsFragmentFunctionsWGSL:()=>Og.shadowsFragmentFunctionsWGSL,shadowsVertex:()=>zg.shadowsVertex,shadowsVertexWGSL:()=>Ng.shadowsVertexWGSL,sharpenPixelShader:()=>jA.sharpenPixelShader,sharpenPixelShaderWGSL:()=>sR.sharpenPixelShaderWGSL,spritesPixelShader:()=>NO.spritesPixelShader,spritesPixelShaderWGSL:()=>FO.spritesPixelShaderWGSL,spritesVertexShader:()=>wO.spritesVertexShader,spritesVertexShaderWGSL:()=>BO.spritesVertexShaderWGSL,ssao2PixelShader:()=>TI.ssao2PixelShader,ssao2PixelShaderWGSL:()=>CI.ssao2PixelShaderWGSL,ssaoCombinePixelShader:()=>uI.ssaoCombinePixelShader,ssaoCombinePixelShaderWGSL:()=>EI.ssaoCombinePixelShaderWGSL,textureSizeIsObject:()=>hh,tonemapPixelShader:()=>BR.tonemapPixelShader,tonemapPixelShaderWGSL:()=>VR.tonemapPixelShaderWGSL,unregisterTextureLoader:()=>ia.hy,useOpenGLOrientationForUV:()=>at.rX,vrDistortionCorrectionPixelShader:()=>eR.vrDistortionCorrectionPixelShader,vrDistortionCorrectionPixelShaderWGSL:()=>tR.vrDistortionCorrectionPixelShaderWGSL});var r=i(99451),s=i(99848),n=i(79923),o=i(26041),a=i(56552);class l{constructor(e,t){this.triggerOptions=e,this.onBeforeExecuteObservable=new s.cP,e.parameter?(this.trigger=e.trigger,this._triggerParameter=e.parameter):e.trigger?this.trigger=e.trigger:this.trigger=e,this._nextActiveAction=this,this._condition=t}_prepare(){}getTriggerParameter(){return this._triggerParameter}setTriggerParameter(e){this._triggerParameter=e}_evaluateConditionForCurrentFrame(){const e=this._condition;if(!e)return!0;const t=this._actionManager.getScene().getRenderId();return e._evaluationId!==t&&(e._evaluationId=t,e._currentResult=e.isValid()),e._currentResult}_executeCurrent(e){this._evaluateConditionForCurrentFrame()&&(this.onBeforeExecuteObservable.notifyObservers(this),this._nextActiveAction.execute(e),this.skipToNextActiveAction())}execute(e){}skipToNextActiveAction(){this._nextActiveAction._child?(this._nextActiveAction._child._actionManager||(this._nextActiveAction._child._actionManager=this._actionManager),this._nextActiveAction=this._nextActiveAction._child):this._nextActiveAction=this}then(e){return this._child=e,e._actionManager=this._actionManager,e._prepare(),e}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(e){return null}_serialize(e,t){const i={type:1,children:[],name:e.name,properties:e.properties||[]};if(this._child&&this._child.serialize(i),this._condition){const e=this._condition.serialize();return e.children.push(i),t&&t.children.push(e),e}return t&&t.children.push(i),i}}l._SerializeValueAsString=e=>"number"==typeof e?e.toString():"boolean"==typeof e?e?"true":"false":e instanceof n.I9?e.x+", "+e.y:e instanceof n.Pq?e.x+", "+e.y+", "+e.z:e instanceof o.v9?e.r+", "+e.g+", "+e.b:e instanceof o.ov?e.r+", "+e.g+", "+e.b+", "+e.a:e,l._GetTargetProperty=e=>({name:"target",targetType:e._isMesh?"MeshProperties":e._isLight?"LightProperties":e._isCamera?"CameraProperties":e._isMaterial?"MaterialProperties":"SceneProperties",value:e._isScene?"Scene":e.name}),(0,a.Y5)("BABYLON.Action",l);var h=i(61466);class c{constructor(e){this._actionManager=e}isValid(){return!0}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(){}_serialize(e){return{type:2,children:[],name:e.name,properties:e.properties}}}class u extends c{static get IsEqual(){return u._IsEqual}static get IsDifferent(){return u._IsDifferent}static get IsGreater(){return u._IsGreater}static get IsLesser(){return u._IsLesser}constructor(e,t,i,r,s=u.IsEqual){super(e),this.propertyPath=i,this.value=r,this.operator=s,this._target=t,this._effectiveTarget=this._getEffectiveTarget(t,this.propertyPath),this._property=this._getProperty(this.propertyPath)}isValid(){switch(this.operator){case u.IsGreater:return this._effectiveTarget[this._property]>this.value;case u.IsLesser:return this._effectiveTarget[this._property]<this.value;case u.IsEqual:case u.IsDifferent:{let e;return e=this.value.equals?this.value.equals(this._effectiveTarget[this._property]):this.value===this._effectiveTarget[this._property],this.operator===u.IsEqual?e:!e}}return!1}serialize(){return this._serialize({name:"ValueCondition",properties:[l._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:l._SerializeValueAsString(this.value)},{name:"operator",value:u.GetOperatorName(this.operator)}]})}static GetOperatorName(e){switch(e){case u._IsEqual:return"IsEqual";case u._IsDifferent:return"IsDifferent";case u._IsGreater:return"IsGreater";case u._IsLesser:return"IsLesser";default:return""}}}u._IsEqual=0,u._IsDifferent=1,u._IsGreater=2,u._IsLesser=3;class d extends c{constructor(e,t){super(e),this.predicate=t}isValid(){return this.predicate()}}class p extends c{constructor(e,t,i){super(e),this.value=i,this._target=t}isValid(){return this._target.state===this.value}serialize(){return this._serialize({name:"StateCondition",properties:[l._GetTargetProperty(this._target),{name:"value",value:this.value}]})}}(0,a.Y5)("BABYLON.ValueCondition",u),(0,a.Y5)("BABYLON.PredicateCondition",d),(0,a.Y5)("BABYLON.StateCondition",p);var m=i(51137);class f extends l{constructor(e,t,i,r){super(e,r),this.propertyPath=i,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]}serialize(e){return super._serialize({name:"SwitchBooleanAction",properties:[l._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},e)}}class _ extends l{constructor(e,t,i,r){super(e,r),this.value=i,this._target=t}execute(){this._target.state=this.value}serialize(e){return super._serialize({name:"SetStateAction",properties:[l._GetTargetProperty(this._target),{name:"value",value:this.value}]},e)}}class g extends l{constructor(e,t,i,r,s){super(e,s),this.propertyPath=i,this.value=r,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"SetValueAction",properties:[l._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:l._SerializeValueAsString(this.value)}]},e)}}class x extends l{constructor(e,t,i,r,s){super(e,s),this.propertyPath=i,this.value=r,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath),"number"!=typeof this._effectiveTarget[this._property]&&m.V.Warn("Warning: IncrementValueAction can only be used with number values")}execute(){this._effectiveTarget[this._property]+=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"IncrementValueAction",properties:[l._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:l._SerializeValueAsString(this.value)}]},e)}}class v extends l{constructor(e,t,i,r,s,n){super(e,n),this.from=i,this.to=r,this.loop=s,this._target=t}_prepare(){}execute(){this._actionManager.getScene().beginAnimation(this._target,this.from,this.to,this.loop)}serialize(e){return super._serialize({name:"PlayAnimationAction",properties:[l._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:l._SerializeValueAsString(this.loop)||!1}]},e)}}class S extends l{constructor(e,t,i){super(e,i),this._target=t}_prepare(){}execute(){this._actionManager.getScene().stopAnimation(this._target)}serialize(e){return super._serialize({name:"StopAnimationAction",properties:[l._GetTargetProperty(this._target)]},e)}}class b extends l{constructor(e=0,t){super(e,t)}execute(){}serialize(e){return super._serialize({name:"DoNothingAction",properties:[]},e)}}class y extends l{constructor(e,t,i,r=!0){super(e,i),this.children=t,this.enableChildrenConditions=r}_prepare(){for(let e=0;e<this.children.length;e++)this.children[e]._actionManager=this._actionManager,this.children[e]._prepare()}execute(e){for(const t of this.children)this.enableChildrenConditions&&!t._evaluateConditionForCurrentFrame()||t.execute(e)}serialize(e){const t=super._serialize({name:"CombineAction",properties:[],combine:[]},e);for(let e=0;e<this.children.length;e++)t.combine.push(this.children[e].serialize(null));return t}}class P extends l{constructor(e,t,i){super(e,i),this.func=t}execute(e){this.func(e)}}class T extends l{constructor(e,t,i,r){super(e,r),this._target=t,this._parent=i}_prepare(){}execute(){if(this._target.parent===this._parent)return;const e=this._parent.getWorldMatrix().clone();e.invert(),this._target.position=n.Pq.TransformCoordinates(this._target.position,e),this._target.parent=this._parent}serialize(e){return super._serialize({name:"SetParentAction",properties:[l._GetTargetProperty(this._target),l._GetTargetProperty(this._parent)]},e)}}(0,a.Y5)("BABYLON.SetParentAction",T),(0,a.Y5)("BABYLON.ExecuteCodeAction",P),(0,a.Y5)("BABYLON.DoNothingAction",b),(0,a.Y5)("BABYLON.StopAnimationAction",S),(0,a.Y5)("BABYLON.PlayAnimationAction",v),(0,a.Y5)("BABYLON.IncrementValueAction",x),(0,a.Y5)("BABYLON.SetValueAction",g),(0,a.Y5)("BABYLON.SetStateAction",_),(0,a.Y5)("BABYLON.SetParentAction",T),(0,a.Y5)("BABYLON.SwitchBooleanAction",f),(0,a.Y5)("BABYLON.CombineAction",y);var C=i(6315),E=i(74609);class A extends r.G{constructor(e){super(),(e=e||C.q.LastCreatedScene)&&(this._scene=e,e.actionManagers.push(this))}dispose(){const e=this._scene.actionManagers.indexOf(this);for(let e=0;e<this.actions.length;e++){const t=this.actions[e];A.Triggers[t.trigger]--,0===A.Triggers[t.trigger]&&delete A.Triggers[t.trigger]}this.actions.length=0,e>-1&&this._scene.actionManagers.splice(e,1);const t=this._scene.meshes.filter((e=>e.actionManager===this));for(const e of t)e.actionManager=null}getScene(){return this._scene}hasSpecificTriggers(e){for(let t=0;t<this.actions.length;t++){const i=this.actions[t];if(e.indexOf(i.trigger)>-1)return!0}return!1}hasSpecificTriggers2(e,t){for(let i=0;i<this.actions.length;i++){const r=this.actions[i];if(e==r.trigger||t==r.trigger)return!0}return!1}hasSpecificTrigger(e,t){for(let i=0;i<this.actions.length;i++){const r=this.actions[i];if(r.trigger===e){if(!t)return!0;if(t(r.getTriggerParameter()))return!0}}return!1}get hasPointerTriggers(){for(let e=0;e<this.actions.length;e++){const t=this.actions[e];if(t.trigger>=A.OnPickTrigger&&t.trigger<=A.OnPointerOutTrigger)return!0}return!1}get hasPickTriggers(){for(let e=0;e<this.actions.length;e++){const t=this.actions[e];if(t.trigger>=A.OnPickTrigger&&t.trigger<=A.OnPickUpTrigger)return!0}return!1}registerAction(e){return e.trigger===A.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(m.V.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(e),this.getScene()._registeredActions++,A.Triggers[e.trigger]?A.Triggers[e.trigger]++:A.Triggers[e.trigger]=1,e._actionManager=this,e._prepare(),e)}unregisterAction(e){const t=this.actions.indexOf(e);return-1!==t&&(this.actions.splice(t,1),A.Triggers[e.trigger]-=1,0===A.Triggers[e.trigger]&&delete A.Triggers[e.trigger],e._actionManager=null,this.getScene()._registeredActions--,!0)}processTrigger(e,t){for(let i=0;i<this.actions.length;i++){const r=this.actions[i];if(r.trigger===e){if(t&&(e===A.OnKeyUpTrigger||e===A.OnKeyDownTrigger)){const e=r.getTriggerParameter();if("function"==typeof e){if(!e(t))continue}else if(e&&e!==t.sourceEvent.keyCode){if(!e.toLowerCase)continue;const i=e.toLowerCase();if(i!==t.sourceEvent.key){const e=t.sourceEvent.charCode?t.sourceEvent.charCode:t.sourceEvent.keyCode;if(String.fromCharCode(e).toLowerCase()!==i)continue}}}r._executeCurrent(t)}}}_getEffectiveTarget(e,t){const i=t.split(".");for(let t=0;t<i.length-1;t++)e=e[i[t]];return e}_getProperty(e){const t=e.split(".");return t[t.length-1]}serialize(e){const t={children:new Array,name:e,type:3,properties:new Array};for(let e=0;e<this.actions.length;e++){const i={type:0,children:new Array,name:A.GetTriggerName(this.actions[e].trigger),properties:new Array},r=this.actions[e].triggerOptions;if(r&&"number"!=typeof r)if(r.parameter instanceof Node)i.properties.push(l._GetTargetProperty(r.parameter));else if("object"==typeof r.parameter){const e={};E.r.DeepCopy(r.parameter,e,["mesh"]),r.parameter&&r.parameter.mesh&&(e._meshId=r.parameter.mesh.id),i.properties.push({name:"parameter",targetType:null,value:e})}else i.properties.push({name:"parameter",targetType:null,value:r.parameter});this.actions[e].serialize(i),t.children.push(i)}return t}static Parse(e,t,i){const r=new A(i);null===t?i.actionManager=r:t.actionManager=r;const s=(e,t,i,r)=>{if(null===r){const e=parseFloat(t);return"true"===t||"false"===t?"true"===t:isNaN(e)?t:e}const s=r.split("."),a=t.split(",");for(let e=0;e<s.length;e++)i=i[s[e]];if("boolean"==typeof i)return"true"===a[0];if("string"==typeof i)return a[0];const l=[];for(let e=0;e<a.length;e++)l.push(parseFloat(a[e]));return i instanceof n.Pq?n.Pq.FromArray(l):i instanceof n.IU?n.IU.FromArray(l):i instanceof o.v9?o.v9.FromArray(l):i instanceof o.ov?o.ov.FromArray(l):parseFloat(a[0])},l=(e,t,n,o,h=null)=>{if(e.detached)return;const d=[];let p=null,m=null;const f=e.combine&&e.combine.length>0;if(2===e.type?d.push(r):d.push(t),f){const t=[];for(let i=0;i<e.combine.length;i++)l(e.combine[i],A.NothingTrigger,n,o,t);d.push(t)}else for(let t=0;t<e.properties.length;t++){let r=e.properties[t].value;const n=e.properties[t].name,o=e.properties[t].targetType;"target"===n?r=p="SceneProperties"===o?i:"MaterialProperties"===o?i.getMaterialByName(r):i.getNodeByName(r):"parent"===n?r=i.getNodeByName(r):"sound"===n?i.getSoundByName&&(r=i.getSoundByName(r)):"propertyPath"!==n?r=2===e.type&&"operator"===n?u[r]:s(0,r,p,"value"===n?m:null):m=r,d.push(r)}if(null===h?d.push(n):d.push(null),"InterpolateValueAction"===e.name){const e=d[d.length-2];d[d.length-1]=e,d[d.length-2]=n}let _=((e,t)=>{const i=(0,a.n9)("BABYLON."+e);return i&&new i(...t)})(e.name,d);if(_ instanceof c&&null!==n){const e=new b(t,n);o?o.then(e):r.registerAction(e),o=e}null===h?_ instanceof c?(n=_,_=o):(n=null,o?o.then(_):r.registerAction(_)):h.push(_);for(let i=0;i<e.children.length;i++)l(e.children[i],t,n,_,null)};for(let t=0;t<e.children.length;t++){let r;const s=e.children[t];if(s.properties.length>0){const e=s.properties[0].value,t=null===s.properties[0].targetType?e:i.getMeshByName(e);t._meshId&&(t.mesh=i.getMeshById(t._meshId)),r={trigger:A[s.name],parameter:t}}else r=A[s.name];for(let e=0;e<s.children.length;e++)s.detached||l(s.children[e],r,null,null)}}static GetTriggerName(e){switch(e){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnDoublePickTrigger";case 7:return"OnPickUpTrigger";case 8:return"OnLongPressTrigger";case 9:return"OnPointerOverTrigger";case 10:return"OnPointerOutTrigger";case 11:return"OnEveryFrameTrigger";case 12:return"OnIntersectionEnterTrigger";case 13:return"OnIntersectionExitTrigger";case 14:return"OnKeyDownTrigger";case 15:return"OnKeyUpTrigger";case 16:return"OnPickOutTrigger";default:return""}}}A.NothingTrigger=0,A.OnPickTrigger=1,A.OnLeftPickTrigger=2,A.OnRightPickTrigger=3,A.OnCenterPickTrigger=4,A.OnPickDownTrigger=5,A.OnDoublePickTrigger=6,A.OnPickUpTrigger=7,A.OnPickOutTrigger=16,A.OnLongPressTrigger=8,A.OnPointerOverTrigger=9,A.OnPointerOutTrigger=10,A.OnEveryFrameTrigger=11,A.OnIntersectionEnterTrigger=12,A.OnIntersectionExitTrigger=13,A.OnKeyDownTrigger=14,A.OnKeyUpTrigger=15;class I extends l{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){void 0!==this._sound&&this._sound.play()}serialize(e){return super._serialize({name:"PlaySoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}}class R extends l{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){void 0!==this._sound&&this._sound.stop()}serialize(e){return super._serialize({name:"StopSoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}}(0,a.Y5)("BABYLON.PlaySoundAction",I),(0,a.Y5)("BABYLON.StopSoundAction",R);var M=i(7540);class D extends l{constructor(e,t,i,r,n=1e3,o,a,l){super(e,o),this.duration=1e3,this.onInterpolationDoneObservable=new s.cP,this.propertyPath=i,this.value=r,this.duration=n,this.stopOtherAnimations=a,this.onInterpolationDone=l,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){const e=this._actionManager.getScene(),t=[{frame:0,value:this._effectiveTarget[this._property]},{frame:100,value:this.value}];let i;if("number"==typeof this.value)i=M.X5.ANIMATIONTYPE_FLOAT;else if(this.value instanceof o.v9)i=M.X5.ANIMATIONTYPE_COLOR3;else if(this.value instanceof n.Pq)i=M.X5.ANIMATIONTYPE_VECTOR3;else if(this.value instanceof n.uq)i=M.X5.ANIMATIONTYPE_MATRIX;else{if(!(this.value instanceof n.PT))return void m.V.Warn("InterpolateValueAction: Unsupported type ("+typeof this.value+")");i=M.X5.ANIMATIONTYPE_QUATERNION}const r=new M.X5("InterpolateValueAction",this._property,1e3/this.duration*100,i,M.X5.ANIMATIONLOOPMODE_CONSTANT);r.setKeys(t),this.stopOtherAnimations&&e.stopAnimation(this._effectiveTarget);e.beginDirectAnimation(this._effectiveTarget,[r],0,100,!1,1,(()=>{this.onInterpolationDoneObservable.notifyObservers(this),this.onInterpolationDone&&this.onInterpolationDone()}))}serialize(e){return super._serialize({name:"InterpolateValueAction",properties:[l._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:l._SerializeValueAsString(this.value)},{name:"duration",value:l._SerializeValueAsString(this.duration)},{name:"stopOtherAnimations",value:l._SerializeValueAsString(this.stopOtherAnimations)||!1}]},e)}}(0,a.Y5)("BABYLON.InterpolateValueAction",D);var O=i(6903);class N{constructor(){this.enableBlending=!1,this.blendingSpeed=.01,this.loopMode=M.X5.ANIMATIONLOOPMODE_CYCLE}}var w,F=i(15321),B=i(27266),V=i(35238),L=i(97689);!function(e){e[e.NONE=0]="NONE",e[e.STEP=1]="STEP"}(w||(w={}));var k,G=i(56227);class z{constructor(e){this._path=e,this._onchange=new Array,this.value=0,this.animations=[]}getPoint(){const e=this._path.getPointAtLengthPosition(this.value);return new n.Pq(e.x,0,e.y)}moveAhead(e=.002){return this.move(e),this}moveBack(e=.002){return this.move(-e),this}move(e){if(Math.abs(e)>1)throw"step size should be less than 1.";return this.value+=e,this._ensureLimits(),this._raiseOnChange(),this}_ensureLimits(){for(;this.value>1;)this.value-=1;for(;this.value<0;)this.value+=1;return this}_raiseOnChange(){return this._onchange.forEach((e=>e(this))),this}onchange(e){return this._onchange.push(e),this}}!function(e){e[e.Include=0]="Include",e[e.Exclude=1]="Exclude"}(k||(k={}));class U{constructor(e,t=0){this.mode=t,this.disabled=!1,this._targetNames=new Set,e&&this.addTargetName(e)}addTargetName(e){if(Array.isArray(e))for(const t of e)this._targetNames.add(t);else this._targetNames.add(e)}removeTargetName(e){if(Array.isArray(e))for(const t of e)this._targetNames.delete(t);else this._targetNames.delete(e)}hasTarget(e){return this._targetNames.has(e)}retainsTarget(e){return this._targetNames.has(e)===(0===this.mode)}}var W=i(97889),H=i(998),$=i(32206);class q{constructor(e){this.SMOOTHING=.75,this.FFT_SIZE=512,this.BARGRAPHAMPLITUDE=256,this.DEBUGCANVASPOS={x:20,y:20},this.DEBUGCANVASSIZE={width:320,height:200},(e=e||C.q.LastCreatedScene)&&(this._scene=e,$.$.audioEngine?(this._audioEngine=$.$.audioEngine,this._audioEngine.canUseWebAudio&&this._audioEngine.audioContext&&(this._webAudioAnalyser=this._audioEngine.audioContext.createAnalyser(),this._webAudioAnalyser.minDecibels=-140,this._webAudioAnalyser.maxDecibels=0,this._byteFreqs=new Uint8Array(this._webAudioAnalyser.frequencyBinCount),this._byteTime=new Uint8Array(this._webAudioAnalyser.frequencyBinCount),this._floatFreqs=new Float32Array(this._webAudioAnalyser.frequencyBinCount))):H.S0.Warn("No audio engine initialized, failed to create an audio analyser"))}getFrequencyBinCount(){return this._audioEngine.canUseWebAudio?this._webAudioAnalyser.frequencyBinCount:0}getByteFrequencyData(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getByteFrequencyData(this._byteFreqs)),this._byteFreqs}getByteTimeDomainData(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getByteTimeDomainData(this._byteTime)),this._byteTime}getFloatFrequencyData(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getFloatFrequencyData(this._floatFreqs)),this._floatFreqs}drawDebugCanvas(){if(this._audioEngine.canUseWebAudio&&(this._debugCanvas||(this._debugCanvas=document.createElement("canvas"),this._debugCanvas.width=this.DEBUGCANVASSIZE.width,this._debugCanvas.height=this.DEBUGCANVASSIZE.height,this._debugCanvas.style.position="absolute",this._debugCanvas.style.top=this.DEBUGCANVASPOS.y+"px",this._debugCanvas.style.left=this.DEBUGCANVASPOS.x+"px",this._debugCanvasContext=this._debugCanvas.getContext("2d"),document.body.appendChild(this._debugCanvas),this._registerFunc=()=>{this.drawDebugCanvas()},this._scene.registerBeforeRender(this._registerFunc)),this._registerFunc&&this._debugCanvasContext)){const e=this.getByteFrequencyData();this._debugCanvasContext.fillStyle="rgb(0, 0, 0)",this._debugCanvasContext.fillRect(0,0,this.DEBUGCANVASSIZE.width,this.DEBUGCANVASSIZE.height);for(let t=0;t<this.getFrequencyBinCount();t++){const i=e[t]/this.BARGRAPHAMPLITUDE,r=this.DEBUGCANVASSIZE.height*i,s=this.DEBUGCANVASSIZE.height-r-1,n=this.DEBUGCANVASSIZE.width/this.getFrequencyBinCount(),o=t/this.getFrequencyBinCount()*360;this._debugCanvasContext.fillStyle="hsl("+o+", 100%, 50%)",this._debugCanvasContext.fillRect(t*n,s,n,r)}}}stopDebugCanvas(){this._debugCanvas&&(this._registerFunc&&(this._scene.unregisterBeforeRender(this._registerFunc),this._registerFunc=null),document.body.removeChild(this._debugCanvas),this._debugCanvas=null,this._debugCanvasContext=null)}connectAudioNodes(e,t){this._audioEngine.canUseWebAudio&&(e.connect(this._webAudioAnalyser),this._webAudioAnalyser.connect(t))}dispose(){this._audioEngine.canUseWebAudio&&this._webAudioAnalyser.disconnect()}}var Y=i(47841),X=i(69440),j=i(23938),Z=i(68415),Q=i(69645),K=i(34898),J=i(26846),ee=i(1919),te=i(46900);const ie=[];function re(){return 0===ie.length?null:ie[ie.length-1]}class se{constructor(){this._mainBuses=new Set,this._nodes=new Set,this._defaultMainBus=null,ie.push(this)}get defaultMainBus(){return 0===this._mainBuses.size?null:(this._defaultMainBus||(this._defaultMainBus=Array.from(this._mainBuses)[0]),this._defaultMainBus)}dispose(){ie.includes(this)&&ie.splice(ie.indexOf(this),1);const e=this._nodes.values();for(let t=e.next();!t.done;t=e.next())t.value.dispose();this._mainBuses.clear(),this._nodes.clear(),this._defaultMainBus=null}unlock(){return this.resume()}_addMainBus(e){this._mainBuses.add(e),this._addNode(e)}_removeMainBus(e){this._mainBuses.delete(e),this._defaultMainBus=null,this._removeNode(e)}_addNode(e){this._nodes.add(e)}_removeNode(e){this._nodes.delete(e)}}function ne(e){if(e||(e=re()),e)return e;throw new Error("No audio engine.")}function oe(e,t={},i=null){return(i=ne(i)).createBusAsync(e,t)}function ae(e,t={},i=null){return(i=ne(i)).createMainBusAsync(e,t)}function le(e,t,i={},r=null){return(r=ne(r)).createSoundAsync(e,t,i)}async function he(e,t={},i=null){return(i=ne(i)).createSoundBufferAsync(e,t)}function ce(e,t,i={},r=null){return(r=ne(r)).createStreamingSoundAsync(e,t,i)}var ue=i(39477),de=i(19375),pe=i(93101),me=i(15555),fe=i(21856),_e=i(82704);const ge={position:n.Pq.Zero(),rotation:n.Pq.Zero(),rotationQuaternion:new n.PT};function xe(e){return e.listenerEnabled||void 0!==e.listenerMinUpdateTime||void 0!==e.listenerPosition||void 0!==e.listenerRotation||void 0!==e.listenerRotationQuaternion}class ve{}var Se,be,ye=i(23694);!function(e){e[e.Stopping=0]="Stopping",e[e.Stopped=1]="Stopped",e[e.Starting=2]="Starting",e[e.Started=3]="Started",e[e.FailedToStart=4]="FailedToStart",e[e.Paused=5]="Paused"}(Se||(Se={})),function(e){e[e.Position=1]="Position",e[e.Rotation=2]="Rotation",e[e.PositionAndRotation=3]="PositionAndRotation"}(be||(be={}));var Pe=i(56560),Te=i(86100);class Ce extends ve{constructor(){super(),this._attacherComponent=null,this._attacherComponent=new Te.l(this)}get isAttached(){return null!==this._attacherComponent&&this._attacherComponent.isAttached}attach(e,t=!1,i=3){this._attacherComponent||(this._attacherComponent=new Te.l(this)),this._attacherComponent.attach(e,t,i)}detach(){this._attacherComponent?.detach()}dispose(){this._attacherComponent?.dispose(),this._attacherComponent=null}setOptions(e){void 0!==e.listenerMinUpdateTime&&(this.minUpdateTime=e.listenerMinUpdateTime),e.listenerPosition&&(this.position=e.listenerPosition.clone()),e.listenerRotationQuaternion?this.rotationQuaternion=e.listenerRotationQuaternion.clone():e.listenerRotation?this.rotation=e.listenerRotation.clone():this.rotationQuaternion=ge.rotationQuaternion.clone(),this.update()}}var Ee=i(41199);const Ae=n.uq.Zero(),Ie=new n.PT,Re=n.Pq.Zero();function Me(e,t,i){return new De(e,t,i)}class De extends Ce{constructor(e,t,i){super(),this._lastPosition=n.Pq.Zero(),this._lastRotation=n.Pq.Zero(),this._lastRotationQuaternion=new n.PT,this.position=n.Pq.Zero(),this.rotation=n.Pq.Zero(),this.rotationQuaternion=new n.PT,this._audioContext=e.audioContext,this._updaterComponent=new Ee.w(this,t,i)}get minUpdateTime(){return this._updaterComponent.minUpdateTime}set minUpdateTime(e){this._updaterComponent.minUpdateTime=e}dispose(){super.dispose(),this._updaterComponent.dispose(),this._updaterComponent=null}update(){this.isAttached?this._attacherComponent?.update():(this._updatePosition(),this._updateRotation())}_updatePosition(){if(this._lastPosition.equalsWithEpsilon(this.position))return;const e=this._audioContext.listener;e.positionX.value=this.position.x,e.positionY.value=this.position.y,e.positionZ.value=this.position.z,this._lastPosition.copyFrom(this.position)}_updateRotation(){if(this._lastRotationQuaternion.equalsWithEpsilon(this.rotationQuaternion)){if(this._lastRotation.equalsWithEpsilon(this.rotation))return;n.PT.FromEulerAnglesToRef(this.rotation.x,this.rotation.y,this.rotation.z,Ie),this._lastRotation.copyFrom(this.rotation)}else Ie.copyFrom(this.rotationQuaternion),this._lastRotationQuaternion.copyFrom(this.rotationQuaternion);n.uq.FromQuaternionToRef(Ie,Ae);const e=this._audioContext.listener;n.Pq.TransformNormalToRef(n.Pq.RightHandedForwardReadOnly,Ae,Re),e.forwardX.value=Re.x,e.forwardY.value=Re.y,e.forwardZ.value=Re.z,n.Pq.TransformNormalToRef(n.Pq.Up(),Ae,Re),e.upX.value=Re.x,e.upY.value=Re.y,e.upZ.value=Re.z}}class Oe extends J.f0{constructor(e){super(e,1)}}class Ne extends Oe{constructor(e){super(e);const t=e.audioContext;this._gainNode=new GainNode(t),this._destinationNode=t.destination,this._gainNode.connect(this._destinationNode)}get inNode(){return this._gainNode}get volume(){return this._gainNode.gain.value}set volume(e){this._gainNode.gain.value=e}dispose(){super.dispose(),this._gainNode.disconnect(),this._destinationNode.disconnect()}getClassName(){return"_WebAudioMainOut"}}async function we(e={}){const t=new Be(e);return await t.init(e),t}const Fe={aac:"audio/aac",ac3:"audio/ac3",flac:"audio/flac",m4a:"audio/mp4",mp3:'audio/mpeg; codecs="mp3"',mp4:"audio/mp4",ogg:'audio/ogg; codecs="vorbis"',wav:"audio/wav",webm:'audio/webm; codecs="vorbis"'};class Be extends se{constructor(e={}){super(),this._audioContextStarted=!1,this._invalidFormats=new Set,this._listener=null,this._resumeOnInteraction=!0,this._resumeOnPause=!0,this._resumeOnPauseRetryInterval=1e3,this._resumeOnPauseTimerId=null,this._resumePromise=null,this._listenerAutoUpdate=!0,this._listenerMinUpdateTime=0,this._validFormats=new Set,this._volume=1,this.isReadyPromise=new Promise((e=>{this._resolveIsReadyPromise=e})),this.stateChangedObservable=new s.cP,this.userGestureObservable=new s.cP,this._initAudioContext=async()=>{this.audioContext.addEventListener("statechange",this._onAudioContextStateChange),this._mainOut=new Ne(this),this._mainOut.volume=this._volume,await this.createMainBusAsync("default")},this._onAudioContextStateChange=()=>{"running"===this.state&&(clearInterval(this._resumeOnPauseTimerId),this._audioContextStarted=!0,this._resumePromise=null),"suspended"!==this.state&&"interrupted"!==this.state||this._audioContextStarted&&this._resumeOnPause&&(clearInterval(this._resumeOnPauseTimerId),this._resumeOnPauseTimerId=setInterval((()=>{this.resume()}),this._resumeOnPauseRetryInterval)),this.stateChangedObservable.notifyObservers(this.state)},this._onUserGesture=async()=>{this._resumeOnInteraction&&await this.audioContext.resume(),this.userGestureObservable.notifyObservers()},"boolean"==typeof e.listenerAutoUpdate&&(this._listenerAutoUpdate=e.listenerAutoUpdate),"number"==typeof e.listenerMinUpdateTime&&(this._listenerMinUpdateTime=e.listenerMinUpdateTime),this._volume=e.volume??1,this.audioContext=e.audioContext??new AudioContext}async init(e){this._resumeOnInteraction="boolean"!=typeof e.resumeOnInteraction||e.resumeOnInteraction,this._resumeOnPause="boolean"!=typeof e.resumeOnPause||e.resumeOnPause,this._resumeOnPauseRetryInterval=e.resumeOnPauseRetryInterval??1e3,document.addEventListener("click",this._onUserGesture),await this._initAudioContext(),xe(e)&&(this._listener=Me(this,this._listenerAutoUpdate,this._listenerMinUpdateTime),this._listener.setOptions(e)),this._resolveIsReadyPromise()}get currentTime(){return this.audioContext.currentTime??0}get inNode(){return this.audioContext.destination}get mainOut(){return this._mainOut}get listener(){return this._listener??(this._listener=Me(this,this._listenerAutoUpdate,this._listenerMinUpdateTime))}get state(){return this.audioContext.state}get volume(){return this._volume}set volume(e){this._volume!==e&&(this._volume=e,this._mainOut&&(this._mainOut.volume=e))}async createBusAsync(e,t={}){const r=new((await Promise.resolve().then(i.bind(i,56560)))._WebAudioBus)(e,this,t);return await r.init(t),r}async createMainBusAsync(e,t={}){const r=new((await Promise.resolve().then(i.bind(i,95587)))._WebAudioMainBus)(e,this);return await r.init(t),r}async createSoundAsync(e,t,r={}){const s=new((await Promise.resolve().then(i.bind(i,9915)))._WebAudioStaticSound)(e,this,r);return await s.init(t,r),s}async createSoundBufferAsync(e,t={}){const r=new((await Promise.resolve().then(i.bind(i,9915)))._WebAudioStaticSoundBuffer)(this);return await r.init(e,t),r}async createStreamingSoundAsync(e,t,r={}){const s=new((await Promise.resolve().then(i.bind(i,49318)))._WebAudioStreamingSound)(e,this,r);return await s.init(t,r),s}dispose(){super.dispose(),this._listener?.dispose(),this._listener=null,"closed"!==this.audioContext.state&&this.audioContext.close(),document.removeEventListener("click",this._onUserGesture),this.audioContext.removeEventListener("statechange",this._onAudioContextStateChange)}flagInvalidFormat(e){this._invalidFormats.add(e)}isFormatValid(e){if(this._validFormats.has(e))return!0;if(this._invalidFormats.has(e))return!1;const t=Fe[e];if(void 0===t)return!1;return""===(new Audio).canPlayType(t)?(this._invalidFormats.add(e),!1):(this._validFormats.add(e),!0)}async pause(){await this.audioContext.suspend()}async resume(){return this._resumePromise||(this._resumePromise=this.audioContext.resume()),this._resumePromise}addMainBus(e){this._addMainBus(e)}removeMainBus(e){this._removeMainBus(e)}addNode(e){this._addNode(e)}removeNode(e){this._removeNode(e)}}var Ve=i(95587),Le=i(9915),ke=i(49318),Ge=i(75524),ze=i(79259),Ue=i(26877);class We{constructor(e){this._texture=null,this._isEnabled=!0,this.isEnabled=!0,this.time=0,(e=e||C.q.LastCreatedScene)&&(this._scene=e,this.animationParameters=new n.IU(0,0,0,30))}_markSubMeshesAsAttributesDirty(){for(const e of this._scene.meshes)e.bakedVertexAnimationManager===this&&e._markSubMeshesAsAttributesDirty()}bind(e,t=!1){if(!this._texture||!this._isEnabled)return;const i=this._texture.getSize();e.setFloat2("bakedVertexAnimationTextureSizeInverted",1/i.width,1/i.height),e.setFloat("bakedVertexAnimationTime",this.time),t||e.setVector4("bakedVertexAnimationSettings",this.animationParameters),e.setTexture("bakedVertexAnimationTexture",this._texture)}clone(){const e=new We(this._scene);return this.copyTo(e),e}setAnimationParameters(e,t,i=0,r=30){this.animationParameters=new n.IU(e,t,i,r)}dispose(e){e&&this._texture?.dispose()}getClassName(){return"BakedVertexAnimationManager"}copyTo(e){Ue.p.Clone((()=>e),this)}serialize(){return Ue.p.Serialize(this)}parse(e,t,i){Ue.p.Parse((()=>this),e,t,i)}}(0,Ge.Cg)([(0,ze.uM)(),(0,ze.$z)("_markSubMeshesAsAttributesDirty")],We.prototype,"texture",void 0),(0,Ge.Cg)([(0,ze.lK)(),(0,ze.$z)("_markSubMeshesAsAttributesDirty")],We.prototype,"isEnabled",void 0),(0,Ge.Cg)([(0,ze.lK)()],We.prototype,"animationParameters",void 0),(0,Ge.Cg)([(0,ze.lK)()],We.prototype,"time",void 0);var He=i(96041),$e=i(7481),qe=i(36181),Ye=i(15397);class Xe{constructor(e,t){this._scene=e,t instanceof Ye.E?(this._skeleton=t,this._mesh=null):(this._mesh=t,this._skeleton=t.skeleton)}async bakeVertexData(e){if(!this._skeleton)throw new Error("No skeleton provided.");const t=this._skeleton.bones.length,i=e.reduce(((e,t)=>e+t.to-t.from+1),0);if(isNaN(i))throw new Error("Invalid animation ranges.");let r=0;const s=new Float32Array(4*(t+1)*4*i);this._scene.stopAnimation(this._skeleton),this._skeleton.returnToRest();for(const t of e)for(let e=t.from;e<=t.to;e++)await this._executeAnimationFrame(s,e,r++);return s}async _executeAnimationFrame(e,t,i){return new Promise(((r,s)=>{this._scene.beginAnimation(this._skeleton,t,t,!1,1,(()=>{const t=this._skeleton.getTransformMatrices(this._mesh);e.set(t,i*t.length),r()}))}))}textureFromBakedVertexData(e){if(!this._skeleton)throw new Error("No skeleton provided.");const t=this._skeleton.bones.length,i=He.I.CreateRGBATexture(e,4*(t+1),e.length/(4*(t+1)*4),this._scene,!1,!1,$e.g.NEAREST_NEAREST,1);return i.name="VAT"+this._skeleton.name,i}serializeBakedVertexDataToObject(e){if(!this._skeleton)throw new Error("No skeleton provided.");const t=this._skeleton.bones.length,i=4*(t+1),r=e.length/(4*(t+1)*4);return{vertexData:(0,qe.EL)(e),width:i,height:r}}loadBakedVertexDataFromObject(e){return new Float32Array((0,qe.yS)(e.vertexData))}serializeBakedVertexDataToJSON(e){return JSON.stringify(this.serializeBakedVertexDataToObject(e))}loadBakedVertexDataFromJSON(e){return this.loadBakedVertexDataFromObject(JSON.parse(e))}}var je=i(26068),Ze=i(58930),Qe=i(68907);class Ke{constructor(e,t=new n.Pq,i=0,r=!1){this.direction=e,this.rotatedDirection=t,this.diff=i,this.ignore=r}}class Je{constructor(e){this._ui=e,this.name="AttachToBoxBehavior",this.distanceAwayFromFace=.15,this.distanceAwayFromBottomOfFace=.15,this._faceVectors=[new Ke(n.Pq.Up()),new Ke(n.Pq.Down()),new Ke(n.Pq.Left()),new Ke(n.Pq.Right()),new Ke(n.Pq.Forward()),new Ke(n.Pq.Forward().scaleInPlace(-1))],this._tmpMatrix=new n.uq,this._tmpVector=new n.Pq,this._zeroVector=n.Pq.Zero(),this._lookAtTmpMatrix=new n.uq}init(){}_closestFace(e){return this._faceVectors.forEach((t=>{this._target.rotationQuaternion||(this._target.rotationQuaternion=n.PT.RotationYawPitchRoll(this._target.rotation.y,this._target.rotation.x,this._target.rotation.z)),this._target.rotationQuaternion.toRotationMatrix(this._tmpMatrix),n.Pq.TransformCoordinatesToRef(t.direction,this._tmpMatrix,t.rotatedDirection),t.diff=n.Pq.GetAngleBetweenVectors(t.rotatedDirection,e,n.Pq.Cross(t.rotatedDirection,e))})),this._faceVectors.reduce(((e,t)=>e.ignore?t:t.ignore||e.diff<t.diff?e:t),this._faceVectors[0])}_lookAtToRef(e,t=new n.Pq(0,1,0),i){n.uq.LookAtLHToRef(this._zeroVector,e,t,this._lookAtTmpMatrix),this._lookAtTmpMatrix.invert(),n.PT.FromRotationMatrixToRef(this._lookAtTmpMatrix,i)}attach(e){this._target=e,this._scene=this._target.getScene(),this._onRenderObserver=this._scene.onBeforeRenderObservable.add((()=>{if(!this._scene.activeCamera)return;let t=this._scene.activeCamera.position;this._scene.activeCamera.devicePosition&&(t=this._scene.activeCamera.devicePosition);const i=this._closestFace(t.subtract(e.position));this._scene.activeCamera.leftCamera?this._scene.activeCamera.leftCamera.computeWorldMatrix().getRotationMatrixToRef(this._tmpMatrix):this._scene.activeCamera.computeWorldMatrix().getRotationMatrixToRef(this._tmpMatrix),n.Pq.TransformCoordinatesToRef(n.Pq.Up(),this._tmpMatrix,this._tmpVector),this._faceVectors.forEach((e=>{i.direction.x&&e.direction.x&&(e.ignore=!0),i.direction.y&&e.direction.y&&(e.ignore=!0),i.direction.z&&e.direction.z&&(e.ignore=!0)}));const r=this._closestFace(this._tmpVector);this._faceVectors.forEach((e=>{e.ignore=!1})),this._ui.position.copyFrom(e.position),i.direction.x&&(i.rotatedDirection.scaleToRef(e.scaling.x/2+this.distanceAwayFromFace,this._tmpVector),this._ui.position.addInPlace(this._tmpVector)),i.direction.y&&(i.rotatedDirection.scaleToRef(e.scaling.y/2+this.distanceAwayFromFace,this._tmpVector),this._ui.position.addInPlace(this._tmpVector)),i.direction.z&&(i.rotatedDirection.scaleToRef(e.scaling.z/2+this.distanceAwayFromFace,this._tmpVector),this._ui.position.addInPlace(this._tmpVector)),this._ui.rotationQuaternion||(this._ui.rotationQuaternion=n.PT.RotationYawPitchRoll(this._ui.rotation.y,this._ui.rotation.x,this._ui.rotation.z)),i.rotatedDirection.scaleToRef(-1,this._tmpVector),this._lookAtToRef(this._tmpVector,r.rotatedDirection,this._ui.rotationQuaternion),r.direction.x&&this._ui.up.scaleToRef(this.distanceAwayFromBottomOfFace-e.scaling.x/2,this._tmpVector),r.direction.y&&this._ui.up.scaleToRef(this.distanceAwayFromBottomOfFace-e.scaling.y/2,this._tmpVector),r.direction.z&&this._ui.up.scaleToRef(this.distanceAwayFromBottomOfFace-e.scaling.z/2,this._tmpVector),this._ui.position.addInPlace(this._tmpVector)}))}detach(){this._scene.onBeforeRenderObservable.remove(this._onRenderObserver)}}class et{get delay(){return this.fadeInDelay}set delay(e){this.fadeInDelay=e,this.fadeOutDelay=e}constructor(){this.fadeInDelay=0,this.fadeOutDelay=0,this.fadeInTime=300,this.fadeOutTime=300,this._millisecondsPerFrame=1e3/60,this._hovered=!1,this._hoverValue=0,this._ownerNode=null,this._delay=0,this._time=300,this._update=()=>{if(this._ownerNode){if(this._hoverValue+=this._hovered?this._millisecondsPerFrame:-this._millisecondsPerFrame,this._setAllVisibility(this._ownerNode,(this._hoverValue-this._delay)/this._time),this._ownerNode.visibility>1){if(this._setAllVisibility(this._ownerNode,1),this._hoverValue>this._time)return this._hoverValue=this._time,void this._detachObserver()}else if(this._ownerNode.visibility<0&&(this._setAllVisibility(this._ownerNode,0),this._hoverValue<0))return this._hoverValue=0,void this._detachObserver();this._attachObserver()}}}get name(){return"FadeInOut"}init(){}attach(e){this._ownerNode=e,this._setAllVisibility(this._ownerNode,0)}detach(){this._ownerNode=null}fadeIn(e=!0){this._delay=e?this.fadeInDelay:this.fadeOutDelay,this._time=e?this.fadeInTime:this.fadeOutTime,this._detachObserver(),this._ownerNode&&(e&&this._ownerNode.visibility>=1||!e&&this._ownerNode.visibility<=0)||(this._hovered=e,this._hovered||(this._delay*=-1),this._ownerNode.visibility>=1?this._hoverValue=this._time:this._ownerNode.visibility<=0&&(this._hoverValue=0),this._update())}fadeOut(){this.fadeIn(!1)}_setAllVisibility(e,t){e.visibility=t,e.getChildMeshes().forEach((e=>{this._setAllVisibility(e,t)}))}_attachObserver(){this._onBeforeRenderObserver||(this._onBeforeRenderObserver=this._ownerNode?.getScene().onBeforeRenderObservable.add(this._update))}_detachObserver(){this._onBeforeRenderObserver&&(this._ownerNode?.getScene().onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=null)}}var tt=i(76595),it=i(87491),rt=i(66240),st=i(86919);class nt{static _RemoveAndStorePivotPoint(e){e&&0===nt._PivotCached&&(e.getPivotPointToRef(nt._OldPivotPoint),nt._PivotPostMultiplyPivotMatrix=e._postMultiplyPivotMatrix,nt._OldPivotPoint.equalsToFloats(0,0,0)||(e.setPivotMatrix(n.uq.IdentityReadOnly),nt._OldPivotPoint.subtractToRef(e.getPivotPoint(),nt._PivotTranslation),nt._PivotTmpVector.copyFromFloats(1,1,1),nt._PivotTmpVector.subtractInPlace(e.scaling),nt._PivotTmpVector.multiplyInPlace(nt._PivotTranslation),e.position.addInPlace(nt._PivotTmpVector))),nt._PivotCached++}static _RestorePivotPoint(e){e&&!nt._OldPivotPoint.equalsToFloats(0,0,0)&&1===nt._PivotCached&&(e.setPivotPoint(nt._OldPivotPoint),e._postMultiplyPivotMatrix=nt._PivotPostMultiplyPivotMatrix,nt._PivotTmpVector.copyFromFloats(1,1,1),nt._PivotTmpVector.subtractInPlace(e.scaling),nt._PivotTmpVector.multiplyInPlace(nt._PivotTranslation),e.position.subtractInPlace(nt._PivotTmpVector)),this._PivotCached--}}nt._PivotCached=0,nt._OldPivotPoint=new n.Pq,nt._PivotTranslation=new n.Pq,nt._PivotTmpVector=new n.Pq,nt._PivotPostMultiplyPivotMatrix=!1;var ot=i(36803),at=i(91313);function lt(e){const t=[],i=[],r=[],s=[],n=void 0!==e.width?e.width:void 0!==e.size?e.size:1,o=void 0!==e.height?e.height:void 0!==e.size?e.size:1,a=0===e.sideOrientation?0:e.sideOrientation||ot.P.DEFAULTSIDE,l=n/2,h=o/2;i.push(-l,-h,0),r.push(0,0,-1),s.push(0,at.rX?1:0),i.push(l,-h,0),r.push(0,0,-1),s.push(1,at.rX?1:0),i.push(l,h,0),r.push(0,0,-1),s.push(1,at.rX?0:1),i.push(-l,h,0),r.push(0,0,-1),s.push(0,at.rX?0:1),t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),ot.P._ComputeSides(a,i,t,r,s,e.frontUVs,e.backUVs);const c=new ot.P;return c.indices=t,c.positions=i,c.normals=r,c.uvs=s,c}function ht(e,t={},i=null){const r=new tt.e(e,i);t.sideOrientation=tt.e._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;return lt(t).applyToMesh(r,t.updatable),t.sourcePlane&&(r.translate(t.sourcePlane.normal,-t.sourcePlane.d),r.setDirection(t.sourcePlane.normal.scale(-1))),r}const ct={CreatePlane:ht};ot.P.CreatePlane=lt,tt.e.CreatePlane=(e,t,i,r,s)=>ht(e,{size:t,width:t,height:t,sideOrientation:s,updatable:r},i);var ut=i(65559);class dt{get currentDraggingPointerID(){return this.currentDraggingPointerId}set currentDraggingPointerID(e){this.currentDraggingPointerId=e}set enabled(e){e!=this._enabled&&this.onEnabledObservable.notifyObservers(e),this._enabled=e}get enabled(){return this._enabled}get options(){return this._options}set options(e){this._options=e}constructor(e){this._useAlternatePickedPointAboveMaxDragAngleDragSpeed=-1.1,this._activeDragButton=-1,this.maxDragAngle=0,this.dragButtons=[0,1,2],this._useAlternatePickedPointAboveMaxDragAngle=!1,this.currentDraggingPointerId=-1,this.dragging=!1,this.dragDeltaRatio=.2,this.updateDragPlane=!0,this._debugMode=!1,this._moving=!1,this.onDragObservable=new s.cP,this.onDragStartObservable=new s.cP,this.onDragEndObservable=new s.cP,this.onEnabledObservable=new s.cP,this.moveAttached=!0,this._enabled=!0,this.startAndReleaseDragOnPointerEvents=!0,this.detachCameraControls=!0,this.useObjectOrientationForDragging=!0,this.validateDrag=e=>!0,this._tmpVector=new n.Pq(0,0,0),this._alternatePickedPoint=new n.Pq(0,0,0),this._worldDragAxis=new n.Pq(0,0,0),this._targetPosition=new n.Pq(0,0,0),this._attachedToElement=!1,this._startDragRay=new st.Ray(new n.Pq,new n.Pq),this._lastPointerRay={},this._dragDelta=new n.Pq,this._pointA=new n.Pq(0,0,0),this._pointC=new n.Pq(0,0,0),this._localAxis=new n.Pq(0,0,0),this._lookAt=new n.Pq(0,0,0),this._options=e||{};let t=0;if(this._options.dragAxis&&t++,this._options.dragPlaneNormal&&t++,t>1)throw"Multiple drag modes specified in dragBehavior options. Only one expected"}get name(){return"PointerDrag"}init(){}attach(e,t){this._scene=e.getScene(),e.isNearGrabbable=!0,this.attachedNode=e,dt._PlaneScene||(this._debugMode?dt._PlaneScene=this._scene:(dt._PlaneScene=new it.Z(this._scene.getEngine(),{virtual:!0}),dt._PlaneScene.detachControl(),this._scene.onDisposeObservable.addOnce((()=>{dt._PlaneScene.dispose(),dt._PlaneScene=null})))),this._dragPlane=ht("pointerDragPlane",{size:this._debugMode?1:1e4,updatable:!1,sideOrientation:tt.e.DOUBLESIDE},dt._PlaneScene),this.lastDragPosition=new n.Pq(0,0,0);const i=t||(e=>this.attachedNode==e||e.isDescendantOf(this.attachedNode));this._pointerObserver=this._scene.onPointerObservable.add((e=>{if(this.enabled){if(e.type==rt.Zp.POINTERDOWN)this.startAndReleaseDragOnPointerEvents&&!this.dragging&&e.pickInfo&&e.pickInfo.hit&&e.pickInfo.pickedMesh&&e.pickInfo.pickedPoint&&e.pickInfo.ray&&i(e.pickInfo.pickedMesh)&&-1===this._activeDragButton&&-1!==this.dragButtons.indexOf(e.event.button)&&(this._activeDragButton=e.event.button,this._activePointerInfo=e,this._startDrag(e.event.pointerId,e.pickInfo.ray,e.pickInfo.pickedPoint));else if(e.type==rt.Zp.POINTERUP)!this.startAndReleaseDragOnPointerEvents||this.currentDraggingPointerId!=e.event.pointerId||this._activeDragButton!==e.event.button&&-1!==this._activeDragButton||this.releaseDrag();else if(e.type==rt.Zp.POINTERMOVE){const t=e.event.pointerId;if(this.currentDraggingPointerId===dt._AnyMouseId&&t!==dt._AnyMouseId){const i=e.event;("mouse"===i.pointerType||!this._scene.getEngine().hostInformation.isMobile&&i instanceof MouseEvent)&&(this._lastPointerRay[this.currentDraggingPointerId]&&(this._lastPointerRay[t]=this._lastPointerRay[this.currentDraggingPointerId],delete this._lastPointerRay[this.currentDraggingPointerId]),this.currentDraggingPointerId=t)}this._lastPointerRay[t]||(this._lastPointerRay[t]=new st.Ray(new n.Pq,new n.Pq)),e.pickInfo&&e.pickInfo.ray&&(this._lastPointerRay[t].origin.copyFrom(e.pickInfo.ray.origin),this._lastPointerRay[t].direction.copyFrom(e.pickInfo.ray.direction),this.currentDraggingPointerId==t&&this.dragging&&this._moveDrag(e.pickInfo.ray))}}else this._attachedToElement&&this.releaseDrag()})),this._beforeRenderObserver=this._scene.onBeforeRenderObservable.add((()=>{if(this._moving&&this.moveAttached){let e=!1;nt._RemoveAndStorePivotPoint(this.attachedNode),this._targetPosition.subtractToRef(this.attachedNode.absolutePosition,this._tmpVector),this._tmpVector.scaleInPlace(this.dragDeltaRatio),this.attachedNode.getAbsolutePosition().addToRef(this._tmpVector,this._tmpVector),this.validateDrag(this._tmpVector)&&(this.attachedNode.setAbsolutePosition(this._tmpVector),e=!0),nt._RestorePivotPoint(this.attachedNode),e&&this.attachedNode.computeWorldMatrix()}}))}releaseDrag(){if(this.dragging&&(this.dragging=!1,this.onDragEndObservable.notifyObservers({dragPlanePoint:this.lastDragPosition,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo})),this.currentDraggingPointerId=-1,this._activeDragButton=-1,this._activePointerInfo=null,this._moving=!1,this.detachCameraControls&&this._attachedToElement&&this._scene.activeCamera&&!this._scene.activeCamera.leftCamera){if("ArcRotateCamera"===this._scene.activeCamera.getClassName()){const e=this._scene.activeCamera;e.attachControl(!e.inputs||e.inputs.noPreventDefault,e._useCtrlForPanning,e._panningMouseButton)}else this._scene.activeCamera.attachControl(!this._scene.activeCamera.inputs||this._scene.activeCamera.inputs.noPreventDefault);this._attachedToElement=!1}}startDrag(e=dt._AnyMouseId,t,i){this._startDrag(e,t,i);let r=this._lastPointerRay[e];e===dt._AnyMouseId&&(r=this._lastPointerRay[Object.keys(this._lastPointerRay)[0]]),r&&this._moveDrag(r)}_startDrag(e,t,i){if(!this._scene.activeCamera||this.dragging||!this.attachedNode)return;nt._RemoveAndStorePivotPoint(this.attachedNode),t?(this._startDragRay.direction.copyFrom(t.direction),this._startDragRay.origin.copyFrom(t.origin)):(this._startDragRay.origin.copyFrom(this._scene.activeCamera.position),this.attachedNode.getWorldMatrix().getTranslationToRef(this._tmpVector),this._tmpVector.subtractToRef(this._scene.activeCamera.position,this._startDragRay.direction)),this._updateDragPlanePosition(this._startDragRay,i||this._tmpVector);const r=this._pickWithRayOnDragPlane(this._startDragRay);r?(this.dragging=!0,this.currentDraggingPointerId=e,this.lastDragPosition.copyFrom(r),this.onDragStartObservable.notifyObservers({dragPlanePoint:r,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo}),this._targetPosition.copyFrom(this.attachedNode.getAbsolutePosition()),this.detachCameraControls&&this._scene.activeCamera&&this._scene.activeCamera.inputs&&!this._scene.activeCamera.leftCamera&&(this._scene.activeCamera.inputs.attachedToElement?(this._scene.activeCamera.detachControl(),this._attachedToElement=!0):this._attachedToElement=!1)):this.releaseDrag(),nt._RestorePivotPoint(this.attachedNode)}_moveDrag(e){this._moving=!0;const t=this._pickWithRayOnDragPlane(e);if(t){nt._RemoveAndStorePivotPoint(this.attachedNode),this.updateDragPlane&&this._updateDragPlanePosition(e,t);let i=0;this._options.dragAxis?(this.useObjectOrientationForDragging?n.Pq.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._worldDragAxis):this._worldDragAxis.copyFrom(this._options.dragAxis),t.subtractToRef(this.lastDragPosition,this._tmpVector),this._worldDragAxis.normalize(),i=n.Pq.Dot(this._tmpVector,this._worldDragAxis),this._worldDragAxis.scaleToRef(i,this._dragDelta)):(i=this._dragDelta.length(),t.subtractToRef(this.lastDragPosition,this._dragDelta)),this._targetPosition.addInPlace(this._dragDelta),this.onDragObservable.notifyObservers({dragDistance:i,delta:this._dragDelta,dragPlanePoint:t,dragPlaneNormal:this._dragPlane.forward,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo}),this.lastDragPosition.copyFrom(t),nt._RestorePivotPoint(this.attachedNode)}}_pickWithRayOnDragPlane(e){if(!e)return null;let t=Math.acos(n.Pq.Dot(this._dragPlane.forward,e.direction));if(t>Math.PI/2&&(t=Math.PI-t),this.maxDragAngle>0&&t>this.maxDragAngle){if(this._useAlternatePickedPointAboveMaxDragAngle){this._tmpVector.copyFrom(e.direction),this.attachedNode.absolutePosition.subtractToRef(e.origin,this._alternatePickedPoint),this._alternatePickedPoint.normalize(),this._alternatePickedPoint.scaleInPlace(this._useAlternatePickedPointAboveMaxDragAngleDragSpeed*n.Pq.Dot(this._alternatePickedPoint,this._tmpVector)),this._tmpVector.addInPlace(this._alternatePickedPoint);const t=n.Pq.Dot(this._dragPlane.forward,this._tmpVector);return this._dragPlane.forward.scaleToRef(-t,this._alternatePickedPoint),this._alternatePickedPoint.addInPlace(this._tmpVector),this._alternatePickedPoint.addInPlace(this.attachedNode.absolutePosition),this._alternatePickedPoint}return null}const i=this._dragPlane.forward,r=this._dragPlane.position,s=e.direction.dot(i);if(Math.abs(s)<ut.bH)return null;r.subtractToRef(e.origin,n.AA.Vector3[0]);const o=n.AA.Vector3[0].dot(i)/s;if(o<0)return null;e.direction.scaleToRef(o,n.AA.Vector3[0]);return e.origin.add(n.AA.Vector3[0])}_updateDragPlanePosition(e,t){this._pointA.copyFrom(t),this._options.dragAxis?(this.useObjectOrientationForDragging?n.Pq.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragAxis),e.origin.subtractToRef(this._pointA,this._pointC),this._pointC.normalize(),Math.abs(n.Pq.Dot(this._localAxis,this._pointC))>.999?Math.abs(n.Pq.Dot(n.Pq.UpReadOnly,this._pointC))>.999?this._lookAt.copyFrom(n.Pq.Right()):this._lookAt.copyFrom(n.Pq.UpReadOnly):(n.Pq.CrossToRef(this._localAxis,this._pointC,this._lookAt),n.Pq.CrossToRef(this._localAxis,this._lookAt,this._lookAt),this._lookAt.normalize()),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._lookAt,this._lookAt),this._dragPlane.lookAt(this._lookAt)):this._options.dragPlaneNormal?(this.useObjectOrientationForDragging?n.Pq.TransformCoordinatesToRef(this._options.dragPlaneNormal,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragPlaneNormal),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._localAxis,this._lookAt),this._dragPlane.lookAt(this._lookAt)):(this._scene.activeCamera&&this._scene.activeCamera.getForwardRay().direction.normalizeToRef(this._localAxis),this._dragPlane.position.copyFrom(this._pointA),this._dragPlane.lookAt(this._pointA.add(this._localAxis))),this._dragPlane.position.copyFrom(this.attachedNode.getAbsolutePosition()),this._dragPlane.computeWorldMatrix(!0)}detach(){this._lastPointerRay={},this.attachedNode&&(this.attachedNode.isNearGrabbable=!1),this._pointerObserver&&this._scene.onPointerObservable.remove(this._pointerObserver),this._beforeRenderObserver&&this._scene.onBeforeRenderObservable.remove(this._beforeRenderObserver),this._dragPlane&&this._dragPlane.dispose(),this.releaseDrag()}}dt._AnyMouseId=-2;class pt{constructor(){this._startDistance=0,this._initialScale=new n.Pq(0,0,0),this._targetScale=new n.Pq(0,0,0),this._sceneRenderObserver=null,this._dragBehaviorA=new dt({}),this._dragBehaviorA.moveAttached=!1,this._dragBehaviorB=new dt({}),this._dragBehaviorB.moveAttached=!1}get name(){return"MultiPointerScale"}init(){}_getCurrentDistance(){return this._dragBehaviorA.lastDragPosition.subtract(this._dragBehaviorB.lastDragPosition).length()}attach(e){this._ownerNode=e,this._dragBehaviorA.onDragStartObservable.add((()=>{this._dragBehaviorA.dragging&&this._dragBehaviorB.dragging&&(this._dragBehaviorA.currentDraggingPointerId==this._dragBehaviorB.currentDraggingPointerId?this._dragBehaviorA.releaseDrag():(this._initialScale.copyFrom(e.scaling),this._startDistance=this._getCurrentDistance()))})),this._dragBehaviorB.onDragStartObservable.add((()=>{this._dragBehaviorA.dragging&&this._dragBehaviorB.dragging&&(this._dragBehaviorA.currentDraggingPointerId==this._dragBehaviorB.currentDraggingPointerId?this._dragBehaviorB.releaseDrag():(this._initialScale.copyFrom(e.scaling),this._startDistance=this._getCurrentDistance()))})),[this._dragBehaviorA,this._dragBehaviorB].forEach((e=>{e.onDragObservable.add((()=>{if(this._dragBehaviorA.dragging&&this._dragBehaviorB.dragging){const e=this._getCurrentDistance()/this._startDistance;this._initialScale.scaleToRef(e,this._targetScale)}}))})),e.addBehavior(this._dragBehaviorA),e.addBehavior(this._dragBehaviorB),this._sceneRenderObserver=e.getScene().onBeforeRenderObservable.add((()=>{if(this._dragBehaviorA.dragging&&this._dragBehaviorB.dragging){const t=this._targetScale.subtract(e.scaling).scaleInPlace(.1);t.length()>.01&&e.scaling.addInPlace(t)}}))}detach(){this._ownerNode.getScene().onBeforeRenderObservable.remove(this._sceneRenderObserver),[this._dragBehaviorA,this._dragBehaviorB].forEach((e=>{e.onDragStartObservable.clear(),e.onDragObservable.clear(),this._ownerNode.removeBehavior(e)}))}}var mt=i(97328),ft=i(30388);class _t{constructor(){this._attachedToElement=!1,this._virtualMeshesInfo={},this._tmpVector=new n.Pq,this._tmpQuaternion=new n.PT,this._dragType={NONE:0,DRAG:1,DRAG_WITH_CONTROLLER:2,NEAR_DRAG:3},this._moving=!1,this._dragging=this._dragType.NONE,this.draggableMeshes=null,this.zDragFactor=3,this.currentDraggingPointerIds=[],this.detachCameraControls=!0,this.onDragStartObservable=new s.cP,this.onDragObservable=new s.cP,this.onDragEndObservable=new s.cP,this.allowMultiPointer=!0}get currentDraggingPointerId(){return void 0!==this.currentDraggingPointerIds[0]?this.currentDraggingPointerIds[0]:-1}set currentDraggingPointerId(e){this.currentDraggingPointerIds[0]=e}get currentDraggingPointerID(){return this.currentDraggingPointerId}set currentDraggingPointerID(e){this.currentDraggingPointerId=e}get name(){return"BaseSixDofDrag"}get isMoving(){return this._moving}init(){}get _pointerCamera(){return this._scene.cameraToUseForPointers?this._scene.cameraToUseForPointers:this._scene.activeCamera}_createVirtualMeshInfo(){const e=new mt.V("",_t._virtualScene);e.rotationQuaternion=new n.PT;const t=new mt.V("",_t._virtualScene);t.rotationQuaternion=new n.PT;const i=new mt.V("",_t._virtualScene);return i.rotationQuaternion=new n.PT,{dragging:!1,moving:!1,dragMesh:e,originMesh:t,pivotMesh:i,startingPivotPosition:new n.Pq,startingPivotOrientation:new n.PT,startingPosition:new n.Pq,startingOrientation:new n.PT,lastOriginPosition:new n.Pq,lastDragPosition:new n.Pq}}_resetVirtualMeshesPosition(){for(let e=0;e<this.currentDraggingPointerIds.length;e++)this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.position.copyFrom(this._ownerNode.getAbsolutePivotPoint()),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.rotationQuaternion.copyFrom(this._ownerNode.rotationQuaternion),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingPivotPosition.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.position),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingPivotOrientation.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.rotationQuaternion),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingPosition.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].dragMesh.position),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingOrientation.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].dragMesh.rotationQuaternion)}_pointerUpdate2D(e,t,i){!this._pointerCamera||this._pointerCamera.cameraRigMode!=ft.i.RIG_MODE_NONE||this._pointerCamera._isLeftCamera||this._pointerCamera._isRightCamera||(e.origin.copyFrom(this._pointerCamera.globalPosition),i=0);const r=this._virtualMeshesInfo[t],s=n.AA.Vector3[11];e.origin.subtractToRef(r.lastOriginPosition,s),r.lastOriginPosition.copyFrom(e.origin);const o=-n.Pq.Dot(s,e.direction);r.originMesh.addChild(r.dragMesh),r.originMesh.addChild(r.pivotMesh),this._applyZOffset(r.dragMesh,o,i),this._applyZOffset(r.pivotMesh,o,i),r.originMesh.position.copyFrom(e.origin);const a=n.AA.Vector3[10];e.origin.addToRef(e.direction,a),r.originMesh.lookAt(a),r.originMesh.removeChild(r.dragMesh),r.originMesh.removeChild(r.pivotMesh)}_pointerUpdateXR(e,t,i,r){const s=this._virtualMeshesInfo[i];if(s.originMesh.position.copyFrom(e.position),this._dragging===this._dragType.NEAR_DRAG&&t?s.originMesh.rotationQuaternion.copyFrom(t.rotationQuaternion):s.originMesh.rotationQuaternion.copyFrom(e.rotationQuaternion),s.pivotMesh.computeWorldMatrix(!0),s.dragMesh.computeWorldMatrix(!0),0!==r){const e=n.AA.Vector3[10],t=n.AA.Vector3[11];e.copyFrom(this._pointerCamera.getForwardRay().direction),s.originMesh.position.subtractToRef(s.lastOriginPosition,t),s.lastOriginPosition.copyFrom(s.originMesh.position);const i=t.length();t.normalize();const o=n.AA.Vector3[12],a=n.AA.Vector3[9];s.dragMesh.absolutePosition.subtractToRef(this._pointerCamera.globalPosition,o),s.dragMesh.absolutePosition.subtractToRef(s.originMesh.position,a);const l=a.length();o.normalize(),a.normalize();let h=Math.abs(n.Pq.Dot(t,a))*n.Pq.Dot(t,e)*r*i*l;const c=.01;h<0&&c-l>h&&(h=Math.min(c-l,0)),a.scaleInPlace(h),a.addToRef(s.pivotMesh.absolutePosition,this._tmpVector),s.pivotMesh.setAbsolutePosition(this._tmpVector),a.addToRef(s.dragMesh.absolutePosition,this._tmpVector),s.dragMesh.setAbsolutePosition(this._tmpVector)}}attach(e){this._ownerNode=e,this._scene=this._ownerNode.getScene(),_t._virtualScene||(_t._virtualScene=new it.Z(this._scene.getEngine(),{virtual:!0}),_t._virtualScene.detachControl());const t=e=>this._ownerNode===e||e.isDescendantOf(this._ownerNode)&&(!this.draggableMeshes||-1!==this.draggableMeshes.indexOf(e));this._pointerObserver=this._scene.onPointerObservable.add((e=>{const i=e.event.pointerId;this._virtualMeshesInfo[i]||(this._virtualMeshesInfo[i]=this._createVirtualMeshInfo());const r=this._virtualMeshesInfo[i],s="xr-near"===e.event.pointerType||"xr"===e.event.pointerType,n="xr-near"===e.event.pointerType;if(e.type==rt.Zp.POINTERDOWN){if(!r.dragging&&e.pickInfo&&e.pickInfo.hit&&e.pickInfo.pickedMesh&&e.pickInfo.pickedPoint&&e.pickInfo.ray&&(!n||e.pickInfo.aimTransform)&&t(e.pickInfo.pickedMesh)){if((!this.allowMultiPointer||s)&&this.currentDraggingPointerIds.length>0)return;!this._pointerCamera||this._pointerCamera.cameraRigMode!==ft.i.RIG_MODE_NONE||this._pointerCamera._isLeftCamera||this._pointerCamera._isRightCamera||e.pickInfo.ray.origin.copyFrom(this._pointerCamera.globalPosition),this._ownerNode.computeWorldMatrix(!0);const t=this._virtualMeshesInfo[i];s?(this._dragging=e.pickInfo.originMesh?this._dragType.NEAR_DRAG:this._dragType.DRAG_WITH_CONTROLLER,t.originMesh.position.copyFrom(e.pickInfo.aimTransform.position),this._dragging===this._dragType.NEAR_DRAG&&e.pickInfo.gripTransform?t.originMesh.rotationQuaternion.copyFrom(e.pickInfo.gripTransform.rotationQuaternion):t.originMesh.rotationQuaternion.copyFrom(e.pickInfo.aimTransform.rotationQuaternion)):(this._dragging=this._dragType.DRAG,t.originMesh.position.copyFrom(e.pickInfo.ray.origin)),t.lastOriginPosition.copyFrom(t.originMesh.position),t.dragMesh.position.copyFrom(e.pickInfo.pickedPoint),t.lastDragPosition.copyFrom(e.pickInfo.pickedPoint),t.pivotMesh.position.copyFrom(this._ownerNode.getAbsolutePivotPoint()),t.pivotMesh.rotationQuaternion.copyFrom(this._ownerNode.absoluteRotationQuaternion),t.startingPosition.copyFrom(t.dragMesh.position),t.startingPivotPosition.copyFrom(t.pivotMesh.position),t.startingOrientation.copyFrom(t.dragMesh.rotationQuaternion),t.startingPivotOrientation.copyFrom(t.pivotMesh.rotationQuaternion),n?(t.originMesh.addChild(t.dragMesh),t.originMesh.addChild(t.pivotMesh)):t.originMesh.lookAt(t.dragMesh.position),t.dragging=!0,-1===this.currentDraggingPointerIds.indexOf(i)&&this.currentDraggingPointerIds.push(i),this.detachCameraControls&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._pointerCamera.inputs&&this._pointerCamera.inputs.attachedToElement?(this._pointerCamera.detachControl(),this._attachedToElement=!0):this.allowMultiPointer&&0!==this.currentDraggingPointerIds.length||(this._attachedToElement=!1)),this._targetDragStart(t.pivotMesh.position,t.pivotMesh.rotationQuaternion,i),this.onDragStartObservable.notifyObservers({position:t.pivotMesh.position})}}else if(e.type==rt.Zp.POINTERUP||e.type==rt.Zp.POINTERDOUBLETAP){const e=this.currentDraggingPointerIds.indexOf(i);r.dragging=!1,-1!==e&&(this.currentDraggingPointerIds.splice(e,1),0===this.currentDraggingPointerIds.length&&(this._moving=!1,this._dragging=this._dragType.NONE,this.detachCameraControls&&this._attachedToElement&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._reattachCameraControls(),this._attachedToElement=!1)),r.originMesh.removeChild(r.dragMesh),r.originMesh.removeChild(r.pivotMesh),this._targetDragEnd(i),this.onDragEndObservable.notifyObservers({}))}else if(e.type==rt.Zp.POINTERMOVE){if(-1!==this.currentDraggingPointerIds.indexOf(i)&&r.dragging&&e.pickInfo&&(e.pickInfo.ray||e.pickInfo.aimTransform)){let t=this.zDragFactor;(this.currentDraggingPointerIds.length>1||e.pickInfo.originMesh)&&(t=0),this._ownerNode.computeWorldMatrix(!0),n?this._pointerUpdateXR(e.pickInfo.aimTransform,e.pickInfo.gripTransform,i,t):this._pointerUpdate2D(e.pickInfo.ray,i,t),this._tmpQuaternion.copyFrom(r.startingPivotOrientation),this._tmpQuaternion.x=-this._tmpQuaternion.x,this._tmpQuaternion.y=-this._tmpQuaternion.y,this._tmpQuaternion.z=-this._tmpQuaternion.z,r.pivotMesh.absoluteRotationQuaternion.multiplyToRef(this._tmpQuaternion,this._tmpQuaternion),r.pivotMesh.absolutePosition.subtractToRef(r.startingPivotPosition,this._tmpVector),this.onDragObservable.notifyObservers({delta:this._tmpVector,position:r.pivotMesh.position,pickInfo:e.pickInfo}),this._targetDrag(this._tmpVector,this._tmpQuaternion,i),r.lastDragPosition.copyFrom(r.dragMesh.absolutePosition),this._moving=!0}}}))}_applyZOffset(e,t,i){e.position.z-=e.position.z<1?t*i:t*i*e.position.z,e.position.z<0&&(e.position.z=0)}_targetDragStart(e,t,i){}_targetDrag(e,t,i){}_targetDragEnd(e){}_reattachCameraControls(){if(this._pointerCamera)if("ArcRotateCamera"===this._pointerCamera.getClassName()){const e=this._pointerCamera;e.attachControl(!e.inputs||e.inputs.noPreventDefault,e._useCtrlForPanning,e._panningMouseButton)}else this._pointerCamera.attachControl(!this._pointerCamera.inputs||this._pointerCamera.inputs.noPreventDefault)}detach(){this._scene&&(this.detachCameraControls&&this._attachedToElement&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._reattachCameraControls(),this._attachedToElement=!1),this._scene.onPointerObservable.remove(this._pointerObserver));for(const e in this._virtualMeshesInfo)this._virtualMeshesInfo[e].originMesh.dispose(),this._virtualMeshesInfo[e].dragMesh.dispose();this.onDragEndObservable.clear(),this.onDragObservable.clear(),this.onDragStartObservable.clear()}}class gt extends _t{constructor(){super(...arguments),this._sceneRenderObserver=null,this._targetPosition=new n.Pq(0,0,0),this._targetOrientation=new n.PT,this._targetScaling=new n.Pq(1,1,1),this._startingPosition=new n.Pq(0,0,0),this._startingOrientation=new n.PT,this._startingScaling=new n.Pq(1,1,1),this.onPositionChangedObservable=new s.cP,this.dragDeltaRatio=.2,this.rotateDraggedObject=!0,this.rotateAroundYOnly=!1,this.rotateWithMotionController=!0,this.disableMovement=!1,this.faceCameraOnDragStart=!1}get name(){return"SixDofDrag"}attach(e){super.attach(e),e.isNearGrabbable=!0,e.getChildMeshes().forEach((e=>{e.isNearGrabbable=!0})),this._virtualTransformNode=new mt.V("virtual_sixDof",_t._virtualScene),this._virtualTransformNode.rotationQuaternion=n.PT.Identity(),this._sceneRenderObserver=e.getScene().onBeforeRenderObservable.add((()=>{if(1===this.currentDraggingPointerIds.length&&this._moving&&!this.disableMovement){const t=n.AA.Vector3[0];t.copyFrom(this._targetPosition).subtractInPlace(e.absolutePosition).scaleInPlace(this.dragDeltaRatio);const i=n.AA.Vector3[1];if(i.copyFrom(t),e.parent){const r=n.AA.Matrix[0];e.parent.absoluteRotationQuaternion.toRotationMatrix(r),r.invert(),n.Pq.TransformNormalToRef(t,r,i)}if(e.position.addInPlace(i),this.onPositionChangedObservable.notifyObservers({position:e.absolutePosition}),!e.parent||e.parent.scaling&&!e.parent.scaling.isNonUniformWithinEpsilon(.001)){const t=n.AA.Quaternion[0];if(t.copyFrom(this._targetOrientation),e.parent){const i=n.AA.Quaternion[0];i.copyFrom(e.parent.absoluteRotationQuaternion),i.invertInPlace(),i.multiplyToRef(this._targetOrientation,t)}n.PT.SlerpToRef(e.rotationQuaternion,t,this.dragDeltaRatio,e.rotationQuaternion)}}}))}_getPositionOffsetAround(e,t,i){const r=n.AA.Matrix[0],s=n.AA.Matrix[1],o=n.AA.Matrix[2],a=n.AA.Matrix[3],l=n.AA.Matrix[4];return n.uq.TranslationToRef(e.x,e.y,e.z,r),n.uq.TranslationToRef(-e.x,-e.y,-e.z,s),n.uq.FromQuaternionToRef(i,o),n.uq.ScalingToRef(t,t,t,a),s.multiplyToRef(o,l),l.multiplyToRef(a,l),l.multiplyToRef(r,l),l.getTranslation()}_onePointerPositionUpdated(e,t){n.AA.Vector3[0].setAll(0),this._dragging===this._dragType.DRAG?this.rotateDraggedObject&&(this.rotateAroundYOnly?n.PT.RotationYawPitchRollToRef(t.toEulerAngles().y,0,0,n.AA.Quaternion[0]):n.AA.Quaternion[0].copyFrom(t),n.AA.Quaternion[0].multiplyToRef(this._startingOrientation,this._targetOrientation)):(this._dragging===this._dragType.NEAR_DRAG||this._dragging===this._dragType.DRAG_WITH_CONTROLLER&&this.rotateWithMotionController)&&t.multiplyToRef(this._startingOrientation,this._targetOrientation),this._targetPosition.copyFrom(this._startingPosition).addInPlace(e)}_twoPointersPositionUpdated(){const e=this._virtualMeshesInfo[this.currentDraggingPointerIds[0]].startingPosition,t=this._virtualMeshesInfo[this.currentDraggingPointerIds[1]].startingPosition,i=n.AA.Vector3[0];e.addToRef(t,i),i.scaleInPlace(.5);const r=n.AA.Vector3[1];t.subtractToRef(e,r);const s=this._virtualMeshesInfo[this.currentDraggingPointerIds[0]].dragMesh.absolutePosition,o=this._virtualMeshesInfo[this.currentDraggingPointerIds[1]].dragMesh.absolutePosition,a=n.AA.Vector3[2];s.addToRef(o,a),a.scaleInPlace(.5);const l=n.AA.Vector3[3];o.subtractToRef(s,l);const h=l.length()/r.length(),c=a.subtract(i),u=n.PT.FromEulerAngles(0,n.Pq.GetAngleBetweenVectorsOnPlane(r.normalize(),l.normalize(),n.Pq.UpReadOnly),0),d=this._ownerNode.parent;this._ownerNode.setParent(null);const p=this._getPositionOffsetAround(i.subtract(this._virtualTransformNode.getAbsolutePivotPoint()),h,u);this._virtualTransformNode.rotationQuaternion.multiplyToRef(u,this._ownerNode.rotationQuaternion),this._virtualTransformNode.scaling.scaleToRef(h,this._ownerNode.scaling),this._virtualTransformNode.position.addToRef(c.addInPlace(p),this._ownerNode.position),this.onPositionChangedObservable.notifyObservers({position:this._ownerNode.position}),this._ownerNode.setParent(d)}_targetDragStart(){const e=this.currentDraggingPointerIds.length;this._ownerNode.rotationQuaternion||(this._ownerNode.rotationQuaternion=n.PT.RotationYawPitchRoll(this._ownerNode.rotation.y,this._ownerNode.rotation.x,this._ownerNode.rotation.z));const t=this._ownerNode.getAbsolutePivotPoint();if(1===e){if(this._targetPosition.copyFrom(this._ownerNode.absolutePosition),this._targetOrientation.copyFrom(this._ownerNode.rotationQuaternion),this._targetScaling.copyFrom(this._ownerNode.absoluteScaling),this.faceCameraOnDragStart&&this._scene.activeCamera){const e=n.AA.Vector3[0];this._scene.activeCamera.position.subtractToRef(t,e),e.normalize();const i=n.AA.Quaternion[0];this._scene.useRightHandedSystem?n.PT.FromLookDirectionRHToRef(e,new n.Pq(0,1,0),i):n.PT.FromLookDirectionLHToRef(e,new n.Pq(0,1,0),i),i.normalize(),n.PT.RotationYawPitchRollToRef(i.toEulerAngles().y,0,0,n.AA.Quaternion[0]),this._targetOrientation.copyFrom(n.AA.Quaternion[0])}this._startingPosition.copyFrom(this._targetPosition),this._startingOrientation.copyFrom(this._targetOrientation),this._startingScaling.copyFrom(this._targetScaling)}else 2===e&&(this._virtualTransformNode.setPivotPoint(new n.Pq(0,0,0),0),this._virtualTransformNode.position.copyFrom(this._ownerNode.absolutePosition),this._virtualTransformNode.scaling.copyFrom(this._ownerNode.absoluteScaling),this._virtualTransformNode.rotationQuaternion.copyFrom(this._ownerNode.absoluteRotationQuaternion),this._virtualTransformNode.setPivotPoint(t,1),this._resetVirtualMeshesPosition())}_targetDrag(e,t){1===this.currentDraggingPointerIds.length?this._onePointerPositionUpdated(e,t):2===this.currentDraggingPointerIds.length&&this._twoPointersPositionUpdated()}_targetDragEnd(){if(1===this.currentDraggingPointerIds.length){this._resetVirtualMeshesPosition();const e=this.faceCameraOnDragStart;this.faceCameraOnDragStart=!1,this._targetDragStart(),this.faceCameraOnDragStart=e}}detach(){super.detach(),this._ownerNode&&this._ownerNode.getScene().onBeforeRenderObservable.remove(this._sceneRenderObserver),this._virtualTransformNode&&this._virtualTransformNode.dispose()}}class xt{constructor(){this._attachPointLocalOffset=new n.Pq,this._workingPosition=new n.Pq,this._workingQuaternion=new n.PT,this._lastTick=-1,this._hit=!1,this.hitNormalOffset=.05,this.meshes=[],this.interpolatePose=!0,this.lerpTime=250,this.keepOrientationVertical=!0,this.enabled=!0,this.maxStickingDistance=.8}get name(){return"SurfaceMagnetism"}init(){}attach(e,t){this._attachedMesh=e,this._scene=t||e.getScene(),this._attachedMesh.rotationQuaternion||(this._attachedMesh.rotationQuaternion=n.PT.RotationYawPitchRoll(this._attachedMesh.rotation.y,this._attachedMesh.rotation.x,this._attachedMesh.rotation.z)),this.updateAttachPoint(),this._workingPosition.copyFrom(this._attachedMesh.position),this._workingQuaternion.copyFrom(this._attachedMesh.rotationQuaternion),this._addObservables()}detach(){this._attachedMesh=null,this._removeObservables()}_getTargetPose(e){if(!this._attachedMesh)return null;if(e&&e.hit){const t=e.getNormal(!0,!0),i=e.pickedPoint;if(!t||!i)return null;t.normalize();const r=n.AA.Vector3[0];return r.copyFrom(t),r.scaleInPlace(this.hitNormalOffset),r.addInPlace(i),this._attachedMesh.parent&&(n.AA.Matrix[0].copyFrom(this._attachedMesh.parent.getWorldMatrix()).invert(),n.Pq.TransformNormalToRef(r,n.AA.Matrix[0],r)),{position:r,quaternion:n.PT.RotationYawPitchRoll(-Math.atan2(t.x,-t.z),this.keepOrientationVertical?0:Math.atan2(t.y,Math.sqrt(t.z*t.z+t.x*t.x)),0)}}return null}updateAttachPoint(){this._getAttachPointOffsetToRef(this._attachPointLocalOffset)}findAndUpdateTarget(e){if(this._hit=!1,!e.ray)return!1;const t=e.ray.intersectsMeshes(this.meshes)[0];if(this._attachedMesh&&t&&t.hit&&t.pickedMesh){const e=this._getTargetPose(t);e&&n.Pq.Distance(this._attachedMesh.position,e.position)<this.maxStickingDistance&&(this._workingPosition.copyFrom(e.position),this._workingQuaternion.copyFrom(e.quaternion),this._hit=!0)}return this._hit}_getAttachPointOffsetToRef(e){if(!this._attachedMesh)return void e.setAll(0);const t=n.AA.Quaternion[0];t.copyFrom(this._attachedMesh.rotationQuaternion),this._attachedMesh.rotationQuaternion.copyFromFloats(0,0,0,1),this._attachedMesh.computeWorldMatrix();const i=this._attachedMesh.getHierarchyBoundingVectors(),r=n.AA.Vector3[0];i.max.addToRef(i.min,r),r.scaleInPlace(.5),r.z=i.max.z;const s=n.AA.Matrix[0];this._attachedMesh.getWorldMatrix().invertToRef(s),n.Pq.TransformCoordinatesToRef(r,s,e),this._attachedMesh.rotationQuaternion.copyFrom(t)}_updateTransformToGoal(e){if(!this._attachedMesh||!this._hit)return;const t=this._attachedMesh.parent;this._attachedMesh.setParent(null);const i=n.AA.Vector3[0];if(n.Pq.TransformNormalToRef(this._attachPointLocalOffset,this._attachedMesh.getWorldMatrix(),i),!this.interpolatePose)return this._attachedMesh.position.copyFrom(this._workingPosition).subtractInPlace(i),void this._attachedMesh.rotationQuaternion.copyFrom(this._workingQuaternion);const r=new n.Pq;n.Pq.SmoothToRef(this._attachedMesh.position,this._workingPosition,e,this.lerpTime,r),this._attachedMesh.position.copyFrom(r);const s=new n.PT;s.copyFrom(this._attachedMesh.rotationQuaternion),n.PT.SmoothToRef(s,this._workingQuaternion,e,this.lerpTime,this._attachedMesh.rotationQuaternion),this._attachedMesh.setParent(t)}_addObservables(){this._pointerObserver=this._scene.onPointerObservable.add((e=>{this.enabled&&e.type==rt.Zp.POINTERMOVE&&e.pickInfo&&this.findAndUpdateTarget(e.pickInfo)})),this._lastTick=Date.now(),this._onBeforeRender=this._scene.onBeforeRenderObservable.add((()=>{const e=Date.now();this._updateTransformToGoal(e-this._lastTick),this._lastTick=e}))}_removeObservables(){this._scene.onPointerObservable.remove(this._pointerObserver),this._scene.onBeforeRenderObservable.remove(this._onBeforeRender),this._pointerObserver=null,this._onBeforeRender=null}}var vt,St,bt,yt=i(84867);class Pt{constructor(){this._tmpQuaternion=new n.PT,this._tmpVectors=[new n.Pq,new n.Pq,new n.Pq,new n.Pq,new n.Pq,new n.Pq,new n.Pq],this._tmpMatrix=new n.uq,this._tmpInvertView=new n.uq,this._tmpForward=new n.Pq,this._tmpNodeForward=new n.Pq,this._tmpPosition=new n.Pq,this._workingPosition=new n.Pq,this._workingQuaternion=new n.PT,this._lastTick=-1,this._recenterNextUpdate=!0,this.interpolatePose=!0,this.lerpTime=500,this.ignoreCameraPitchAndRoll=!1,this.pitchOffset=15,this.maxViewVerticalDegrees=30,this.maxViewHorizontalDegrees=30,this.orientToCameraDeadzoneDegrees=60,this.ignoreDistanceClamp=!1,this.ignoreAngleClamp=!1,this.verticalMaxDistance=0,this.defaultDistance=.8,this.maximumDistance=2,this.minimumDistance=.3,this.useFixedVerticalOffset=!1,this.fixedVerticalOffset=0,this._enabled=!0}get followedCamera(){return this._followedCamera||this._scene.activeCamera}set followedCamera(e){this._followedCamera=e}get name(){return"Follow"}init(){}attach(e,t){this._scene=e.getScene(),this.attachedNode=e,t&&(this.followedCamera=t),this._addObservables()}detach(){this.attachedNode=null,this._removeObservables()}recenter(){this._recenterNextUpdate=!0}_angleBetweenVectorAndPlane(e,t){return this._tmpVectors[0].copyFrom(e),e=this._tmpVectors[0],this._tmpVectors[1].copyFrom(t),t=this._tmpVectors[1],e.normalize(),t.normalize(),Math.PI/2-Math.acos(n.Pq.Dot(e,t))}_length2D(e){return Math.sqrt(e.x*e.x+e.z*e.z)}_distanceClamp(e,t=!1){let i=this.minimumDistance,r=this.maximumDistance;const s=this.defaultDistance,n=this._tmpVectors[0];n.copyFrom(e);let o=n.length();if(n.normalizeFromLength(o),this.ignoreCameraPitchAndRoll){i=this._length2D(n)*i,r=this._length2D(n)*r;const t=this._length2D(e);n.scaleInPlace(o/t),o=t}let a=o;return a=t?s:(0,yt.Clamp)(o,i,r),e.copyFrom(n).scaleInPlace(a),o!==a}_applyVerticalClamp(e){0!==this.verticalMaxDistance&&(e.y=(0,yt.Clamp)(e.y,-this.verticalMaxDistance,this.verticalMaxDistance))}_toOrientationQuatToRef(e,t){n.PT.RotationYawPitchRollToRef(Math.atan2(e.x,e.z),Math.atan2(e.y,Math.sqrt(e.z*e.z+e.x*e.x)),0,t)}_applyPitchOffset(e){const t=this._tmpVectors[0],i=this._tmpVectors[1];t.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1),i.copyFromFloats(1,0,0),n.Pq.TransformNormalToRef(t,e,t),t.y=0,t.normalize(),n.Pq.TransformNormalToRef(i,e,i),n.PT.RotationAxisToRef(i,this.pitchOffset*Math.PI/180,this._tmpQuaternion),t.rotateByQuaternionToRef(this._tmpQuaternion,t),this._toOrientationQuatToRef(t,this._tmpQuaternion),this._tmpQuaternion.toRotationMatrix(this._tmpMatrix),e.copyFrom(this._tmpMatrix)}_angularClamp(e,t){const i=this._tmpVectors[5];i.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1);const r=this._tmpVectors[6];r.copyFromFloats(1,0,0),n.Pq.TransformNormalToRef(i,e,i),n.Pq.TransformNormalToRef(r,e,r);const s=n.Pq.UpReadOnly;if(t.length()<ut.bH)return!1;let o=!1;const a=this._tmpQuaternion;if(this.ignoreCameraPitchAndRoll){const e=n.Pq.GetAngleBetweenVectorsOnPlane(t,i,r);n.PT.RotationAxisToRef(r,e,a),t.rotateByQuaternionToRef(a,t)}else{const e=-n.Pq.GetAngleBetweenVectorsOnPlane(t,i,r),s=this.maxViewVerticalDegrees*Math.PI/180*.5;e<-s?(n.PT.RotationAxisToRef(r,-e-s,a),t.rotateByQuaternionToRef(a,t),o=!0):e>s&&(n.PT.RotationAxisToRef(r,-e+s,a),t.rotateByQuaternionToRef(a,t),o=!0)}const l=this._angleBetweenVectorAndPlane(t,r)*(this._scene.useRightHandedSystem?-1:1),h=this.maxViewHorizontalDegrees*Math.PI/180*.5;return l<-h?(n.PT.RotationAxisToRef(s,-l-h,a),t.rotateByQuaternionToRef(a,t),o=!0):l>h&&(n.PT.RotationAxisToRef(s,-l+h,a),t.rotateByQuaternionToRef(a,t),o=!0),o}_orientationClamp(e,t){const i=this._tmpVectors[0];i.copyFrom(e).scaleInPlace(-1).normalize();const r=this._tmpVectors[1],s=this._tmpVectors[2];r.copyFromFloats(0,1,0),n.Pq.CrossToRef(i,r,s);const o=s.length();o<ut.bH||(s.normalizeFromLength(o),n.Pq.CrossToRef(s,i,r),this.attachedNode?.getScene().useRightHandedSystem?n.PT.FromLookDirectionRHToRef(i,r,t):n.PT.FromLookDirectionLHToRef(i,r,t))}_passedOrientationDeadzone(e,t){const i=this._tmpVectors[5];i.copyFrom(e),i.normalize();return 180*Math.abs(n.Pq.GetAngleBetweenVectorsOnPlane(t,i,n.Pq.UpReadOnly))/Math.PI>this.orientToCameraDeadzoneDegrees}_updateLeashing(e){if(this.attachedNode&&this._enabled){const t=this.attachedNode.parent;this.attachedNode.setParent(null);const i=this.attachedNode.getWorldMatrix(),r=this._workingPosition,s=this._workingQuaternion,o=this.attachedNode.getPivotPoint(),a=this._tmpInvertView;a.copyFrom(e.getViewMatrix()),a.invert(),n.Pq.TransformCoordinatesToRef(o,i,r);const l=this._tmpPosition;l.copyFromFloats(0,0,0),n.Pq.TransformCoordinatesToRef(l,i,l),l.scaleInPlace(-1).subtractInPlace(o),r.subtractInPlace(e.globalPosition),this.ignoreCameraPitchAndRoll&&this._applyPitchOffset(a);let h=!1;const c=this._tmpForward;c.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1),n.Pq.TransformNormalToRef(c,a,c);const u=this._tmpNodeForward;if(u.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1),n.Pq.TransformNormalToRef(u,i,u),this._recenterNextUpdate)r.copyFrom(c).scaleInPlace(this.defaultDistance);else if(this.ignoreAngleClamp){const e=r.length();r.copyFrom(c).scaleInPlace(e)}else h=this._angularClamp(a,r);let d=!1;this.ignoreDistanceClamp||(d=this._distanceClamp(r,h),this._applyVerticalClamp(r)),this.useFixedVerticalOffset&&(r.y=l.y-e.globalPosition.y+this.fixedVerticalOffset),(h||d||this._passedOrientationDeadzone(r,u)||this._recenterNextUpdate)&&this._orientationClamp(r,s),this._workingPosition.subtractInPlace(o),this._recenterNextUpdate=!1,this.attachedNode.setParent(t)}}_updateTransformToGoal(e){if(!this.attachedNode||!this.followedCamera||!this._enabled)return;this.attachedNode.rotationQuaternion||(this.attachedNode.rotationQuaternion=n.PT.Identity());const t=this.attachedNode.parent;if(this.attachedNode.setParent(null),!this.interpolatePose)return this.attachedNode.position.copyFrom(this.followedCamera.globalPosition).addInPlace(this._workingPosition),void this.attachedNode.rotationQuaternion.copyFrom(this._workingQuaternion);const i=new n.Pq;i.copyFrom(this.attachedNode.position).subtractInPlace(this.followedCamera.globalPosition),n.Pq.SmoothToRef(i,this._workingPosition,e,this.lerpTime,i),i.addInPlace(this.followedCamera.globalPosition),this.attachedNode.position.copyFrom(i);const r=new n.PT;r.copyFrom(this.attachedNode.rotationQuaternion),n.PT.SmoothToRef(r,this._workingQuaternion,e,this.lerpTime,this.attachedNode.rotationQuaternion),this.attachedNode.setParent(t)}_addObservables(){this._lastTick=Date.now(),this._onBeforeRender=this._scene.onBeforeRenderObservable.add((()=>{if(!this.followedCamera)return;const e=Date.now();this._updateLeashing(this.followedCamera),this._updateTransformToGoal(e-this._lastTick),this._lastTick=e}))}_removeObservables(){this._onBeforeRender&&this._scene.onBeforeRenderObservable.remove(this._onBeforeRender)}}class Tt{}Tt.ANCHOR_SYSTEM="xr-anchor-system",Tt.BACKGROUND_REMOVER="xr-background-remover",Tt.HIT_TEST="xr-hit-test",Tt.MESH_DETECTION="xr-mesh-detection",Tt.PHYSICS_CONTROLLERS="xr-physics-controller",Tt.PLANE_DETECTION="xr-plane-detection",Tt.POINTER_SELECTION="xr-controller-pointer-selection",Tt.TELEPORTATION="xr-controller-teleportation",Tt.FEATURE_POINTS="xr-feature-points",Tt.HAND_TRACKING="xr-hand-tracking",Tt.IMAGE_TRACKING="xr-image-tracking",Tt.NEAR_INTERACTION="xr-near-interaction",Tt.DOM_OVERLAY="xr-dom-overlay",Tt.MOVEMENT="xr-controller-movement",Tt.LIGHT_ESTIMATION="xr-light-estimation",Tt.EYE_TRACKING="xr-eye-tracking",Tt.WALKING_LOCOMOTION="xr-walking-locomotion",Tt.LAYERS="xr-layers",Tt.DEPTH_SENSING="xr-depth-sensing",Tt.SPACE_WARP="xr-space-warp",Tt.RAW_CAMERA_ACCESS="xr-raw-camera-access";class Ct{constructor(e){this._xrSessionManager=e,this._features={},this._xrSessionManager.onXRSessionInit.add((()=>{this.getEnabledFeatures().forEach((e=>{const t=this._features[e];!t.enabled||t.featureImplementation.attached||t.featureImplementation.disableAutoAttach||this.attachFeature(e)}))})),this._xrSessionManager.onXRSessionEnded.add((()=>{this.getEnabledFeatures().forEach((e=>{const t=this._features[e];t.enabled&&t.featureImplementation.attached&&this.detachFeature(e)}))}))}static AddWebXRFeature(e,t,i=1,r=!1){this._AvailableFeatures[e]=this._AvailableFeatures[e]||{latest:i},i>this._AvailableFeatures[e].latest&&(this._AvailableFeatures[e].latest=i),r&&(this._AvailableFeatures[e].stable=i),this._AvailableFeatures[e][i]=t}static ConstructFeature(e,t=1,i,r){const s=this._AvailableFeatures[e][t];if(!s)throw new Error("feature not found");return s(i,r)}static GetAvailableFeatures(){return Object.keys(this._AvailableFeatures)}static GetAvailableVersions(e){return Object.keys(this._AvailableFeatures[e])}static GetLatestVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].latest||-1}static GetStableVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].stable||-1}attachFeature(e){const t=this._features[e];if(t&&t.enabled&&!t.featureImplementation.attached){t.featureImplementation.attach()||H.S0.Warn(`Feature ${e} failed to attach`)}}detachFeature(e){const t=this._features[e];if(t&&t.featureImplementation.attached){t.featureImplementation.detach()||H.S0.Warn(`Feature ${e} failed to detach`)}}disableFeature(e){const t="string"==typeof e?e:e.Name,i=this._features[t];return!(!i||!i.enabled)&&(i.enabled=!1,this.detachFeature(t),i.featureImplementation.dispose(),delete this._features[t],!0)}dispose(){this.getEnabledFeatures().forEach((e=>{this.disableFeature(e)}))}enableFeature(e,t="latest",i={},r=!0,s=!0){const n="string"==typeof e?e:e.Name;let o=0;if("string"==typeof t){if(!t)throw new Error(`Error in provided version - ${n} (${t})`);if(o="stable"===t?Ct.GetStableVersionOfFeature(n):"latest"===t?Ct.GetLatestVersionOfFeature(n):+t,-1===o||isNaN(o))throw new Error(`feature not found - ${n} (${t})`)}else o=t;const a=Ct._ConflictingFeatures[n];if(void 0!==a&&-1!==this.getEnabledFeatures().indexOf(a))throw new Error(`Feature ${n} cannot be enabled while ${a} is enabled.`);const l=this._features[n],h=Ct.ConstructFeature(n,o,this._xrSessionManager,i);if(!h)throw new Error(`feature not found - ${n}`);l&&this.disableFeature(n);const c=h();if(c.dependsOn){const e=c.dependsOn.every((e=>!!this._features[e]));if(!e)throw new Error(`Dependant features missing. Make sure the following features are enabled - ${c.dependsOn.join(", ")}`)}if(c.isCompatible())return this._features[n]={featureImplementation:c,enabled:!0,version:o,required:s},r?this._xrSessionManager.session&&!this._features[n].featureImplementation.attached&&this.attachFeature(n):this._features[n].featureImplementation.disableAutoAttach=!0,this._features[n].featureImplementation;if(s)throw new Error("required feature not compatible");return H.S0.Warn(`Feature ${n} not compatible with the current environment/browser and was not enabled.`),c}getEnabledFeature(e){return this._features[e]&&this._features[e].featureImplementation}getEnabledFeatures(){return Object.keys(this._features)}async _extendXRSessionInitObject(e){const t=this.getEnabledFeatures();for(const i of t){const t=this._features[i],r=t.featureImplementation.xrNativeFeatureName;if(r&&(t.required?(e.requiredFeatures=e.requiredFeatures||[],-1===e.requiredFeatures.indexOf(r)&&e.requiredFeatures.push(r)):(e.optionalFeatures=e.optionalFeatures||[],-1===e.optionalFeatures.indexOf(r)&&e.optionalFeatures.push(r))),t.featureImplementation.getXRSessionInitExtension){const i=await t.featureImplementation.getXRSessionInitExtension();e={...e,...i}}}return e}}Ct._AvailableFeatures={},Ct._ConflictingFeatures={[Tt.TELEPORTATION]:Tt.MOVEMENT,[Tt.MOVEMENT]:Tt.TELEPORTATION},function(e){e[e.ABOVE_FINGER_TIPS=0]="ABOVE_FINGER_TIPS",e[e.RADIAL_SIDE=1]="RADIAL_SIDE",e[e.ULNAR_SIDE=2]="ULNAR_SIDE",e[e.BELOW_WRIST=3]="BELOW_WRIST"}(vt||(vt={})),function(e){e[e.LOOK_AT_CAMERA=0]="LOOK_AT_CAMERA",e[e.HAND_ROTATION=1]="HAND_ROTATION"}(St||(St={})),function(e){e[e.ALWAYS_VISIBLE=0]="ALWAYS_VISIBLE",e[e.PALM_UP=1]="PALM_UP",e[e.GAZE_FOCUS=2]="GAZE_FOCUS",e[e.PALM_AND_GAZE=3]="PALM_AND_GAZE"}(bt||(bt={}));class Et{constructor(){this._sceneRenderObserver=null,this._zoneAxis={},this.handConstraintVisibility=3,this.palmUpStrictness=.95,this.gazeProximityRadius=.15,this.targetOffset=.1,this.targetZone=2,this.zoneOrientationMode=1,this.nodeOrientationMode=1,this.handedness="none",this.lerpTime=100,this._zoneAxis[0]=new n.Pq(0,1,0),this._zoneAxis[1]=new n.Pq(-1,0,0),this._zoneAxis[2]=new n.Pq(1,0,0),this._zoneAxis[3]=new n.Pq(0,-1,0)}get name(){return"HandConstraint"}enable(){this._node.setEnabled(!0)}disable(){this._node.setEnabled(!1)}_getHandPose(){if(!this._handTracking)return null;let e;if(e="none"===this.handedness?this._handTracking.getHandByHandedness("left")||this._handTracking.getHandByHandedness("right"):this._handTracking.getHandByHandedness(this.handedness),e){const t=e.getJointMesh("pinky-finger-metacarpal"),i=e.getJointMesh("middle-finger-metacarpal"),r=e.getJointMesh("wrist");if(r&&i&&t){const s={position:i.absolutePosition,quaternion:new n.PT,id:e.xrController.uniqueId},o=n.AA.Vector3[0],a=n.AA.Vector3[1],l=n.AA.Vector3[2];return o.copyFrom(i.absolutePosition).subtractInPlace(r.absolutePosition).normalize(),a.copyFrom(t.absolutePosition).subtractInPlace(i.absolutePosition).normalize(),n.Pq.CrossToRef(o,a,a),n.Pq.CrossToRef(a,o,l),n.PT.FromLookDirectionLHToRef(a,o,s.quaternion),s}}return null}init(){}attach(e){this._node=e,this._scene=e.getScene(),this._node.rotationQuaternion||(this._node.rotationQuaternion=n.PT.RotationYawPitchRoll(this._node.rotation.y,this._node.rotation.x,this._node.rotation.z));let t=Date.now();this._sceneRenderObserver=this._scene.onBeforeRenderObservable.add((()=>{const e=this._getHandPose();if(this._node.reservedDataStore=this._node.reservedDataStore||{},this._node.reservedDataStore.nearInteraction=this._node.reservedDataStore.nearInteraction||{},this._node.reservedDataStore.nearInteraction.excludedControllerId=null,e){const i=n.AA.Vector3[0],r=this._scene.activeCamera;i.copyFrom(this._zoneAxis[this.targetZone]);const s=n.AA.Quaternion[0];if(r&&(0===this.zoneOrientationMode||0===this.nodeOrientationMode)){const t=n.AA.Vector3[1];t.copyFrom(r.position).subtractInPlace(e.position).normalize(),this._scene.useRightHandedSystem?n.PT.FromLookDirectionRHToRef(t,n.Pq.UpReadOnly,s):n.PT.FromLookDirectionLHToRef(t,n.Pq.UpReadOnly,s)}1===this.zoneOrientationMode?e.quaternion.toRotationMatrix(n.AA.Matrix[0]):s.toRotationMatrix(n.AA.Matrix[0]),n.Pq.TransformNormalToRef(i,n.AA.Matrix[0],i),i.scaleInPlace(this.targetOffset);const o=n.AA.Vector3[2],a=n.AA.Quaternion[1];o.copyFrom(e.position).addInPlace(i),1===this.nodeOrientationMode?a.copyFrom(e.quaternion):a.copyFrom(s);const l=Date.now()-t;n.Pq.SmoothToRef(this._node.position,o,l,this.lerpTime,this._node.position),n.PT.SmoothToRef(this._node.rotationQuaternion,a,l,this.lerpTime,this._node.rotationQuaternion),this._node.reservedDataStore.nearInteraction.excludedControllerId=e.id}this._setVisibility(e),t=Date.now()}))}_setVisibility(e){let t=!0,i=!0;const r=this._scene.activeCamera;if(r){const s=r.getForwardRay();if(2===this.handConstraintVisibility||3===this.handConstraintVisibility){let t;i=!1,this._eyeTracking&&(t=this._eyeTracking.getEyeGaze()),t=t||s;const r=n.AA.Vector3[0];e?e.position.subtractToRef(t.origin,r):this._node.getAbsolutePosition().subtractToRef(t.origin,r);const o=n.Pq.Dot(r,t.direction),a=o*o;if(o>0){r.lengthSquared()-a<this.gazeProximityRadius*this.gazeProximityRadius&&(i=!0)}}if((1===this.handConstraintVisibility||3===this.handConstraintVisibility)&&(t=!1,e)){const i=n.AA.Vector3[0];n.Pq.LeftHandedForwardReadOnly.rotateByQuaternionToRef(e.quaternion,i),n.Pq.Dot(i,s.direction)>2*this.palmUpStrictness-1&&(t=!0)}}this._node.setEnabled(t&&i)}detach(){this._scene.onBeforeRenderObservable.remove(this._sceneRenderObserver)}linkToXRExperience(e){const t=e.featuresManager?e.featuresManager:e;if(t){try{this._eyeTracking=t.getEnabledFeature(Tt.EYE_TRACKING)}catch{}try{this._handTracking=t.getEnabledFeature(Tt.HAND_TRACKING)}catch{H.S0.Error("Hand tracking must be enabled for the Hand Menu to work")}}else H.S0.Error("XR features manager must be available or provided directly for the Hand Menu to work")}}var At=i(36504);class It{get maxAngle(){return this._maxAngle}set maxAngle(e){this._setMaxAngle(e)}constructor(e,t,i){this.targetPosition=n.Pq.Zero(),this.poleTargetPosition=n.Pq.Zero(),this.poleTargetLocalOffset=n.Pq.Zero(),this.poleAngle=0,this.slerpAmount=1,this._bone1Quat=n.PT.Identity(),this._bone1Mat=n.uq.Identity(),this._bone2Ang=Math.PI,this._maxAngle=Math.PI,this._rightHandedSystem=!1,this._bendAxis=n.Pq.Right(),this._slerping=!1,this._adjustRoll=0,this._notEnoughInformation=!1,this._bone2=t;const r=t.getParent();if(!r)return this._notEnoughInformation=!0,void m.V.Error("BoneIKController: bone must have a parent for IK to work.");if(this._bone1=r,0===this._bone2.children.length&&!this._bone2.length)return this._notEnoughInformation=!0,void m.V.Error("BoneIKController: bone must not be a leaf or it should have a length for IK to work.");this.mesh=e,t.getSkeleton().computeAbsoluteMatrices();const s=t.getPosition();if(t.getAbsoluteMatrix().determinant()>0&&(this._rightHandedSystem=!0,this._bendAxis.x=0,this._bendAxis.y=0,this._bendAxis.z=-1,s.x>s.y&&s.x>s.z&&(this._adjustRoll=.5*Math.PI,this._bendAxis.z=1)),this._bone1.length&&this._bone2.length){const e=this._bone1.getScale(),t=this._bone2.getScale();this._bone1Length=this._bone1.length*e.y*this.mesh.scaling.y,this._bone2Length=this._bone2.length*t.y*this.mesh.scaling.y}else if(this._bone2.children[0]){e.computeWorldMatrix(!0);const t=this._bone2.children[0].getAbsolutePosition(e),i=this._bone2.getAbsolutePosition(e),r=this._bone1.getAbsolutePosition(e);this._bone2Length=n.Pq.Distance(t,i),this._bone1Length=n.Pq.Distance(i,r)}else{e.computeWorldMatrix(!0);const t=this._bone2.getScale();this._bone2Length=this._bone2.length*t.y*this.mesh.scaling.y;const i=this._bone2.getAbsolutePosition(e),r=this._bone1.getAbsolutePosition(e);this._bone1Length=n.Pq.Distance(i,r)}this._bone1.getRotationMatrixToRef(1,e,this._bone1Mat),this.maxAngle=Math.PI,i&&(i.targetMesh&&(this.targetMesh=i.targetMesh,this.targetMesh.computeWorldMatrix(!0)),i.poleTargetMesh?(this.poleTargetMesh=i.poleTargetMesh,this.poleTargetMesh.computeWorldMatrix(!0)):i.poleTargetBone?this.poleTargetBone=i.poleTargetBone:this._bone1.getParent()&&(this.poleTargetBone=this._bone1.getParent()),i.poleTargetLocalOffset&&this.poleTargetLocalOffset.copyFrom(i.poleTargetLocalOffset),i.poleAngle&&(this.poleAngle=i.poleAngle),i.bendAxis&&this._bendAxis.copyFrom(i.bendAxis),i.maxAngle&&(this.maxAngle=i.maxAngle),i.slerpAmount&&(this.slerpAmount=i.slerpAmount))}_setMaxAngle(e){e<0&&(e=0),(e>Math.PI||null==e)&&(e=Math.PI),this._maxAngle=e;const t=this._bone1Length,i=this._bone2Length;this._maxReach=Math.sqrt(t*t+i*i-2*t*i*Math.cos(e))}update(){if(this._notEnoughInformation)return;const e=this.targetPosition,t=this.poleTargetPosition,i=It._TmpMats[0],r=It._TmpMats[1];this.targetMesh&&e.copyFrom(this.targetMesh.getAbsolutePosition()),this.poleTargetBone?this.poleTargetBone.getAbsolutePositionFromLocalToRef(this.poleTargetLocalOffset,this.mesh,t):this.poleTargetMesh&&n.Pq.TransformCoordinatesToRef(this.poleTargetLocalOffset,this.poleTargetMesh.getWorldMatrix(),t);const s=It._TmpVecs[0],o=It._TmpVecs[1],a=It._TmpVecs[2],l=It._TmpVecs[3],h=It._TmpVecs[4],c=It._TmpQuat;this._bone1.getAbsolutePositionToRef(this.mesh,s),t.subtractToRef(s,h),0==h.x&&0==h.y&&0==h.z?h.y=1:h.normalize(),e.subtractToRef(s,l),l.normalize(),n.Pq.CrossToRef(l,h,o),o.normalize(),n.Pq.CrossToRef(l,o,a),a.normalize(),n.uq.FromXYZAxesToRef(a,l,o,i);const u=this._bone1Length,d=this._bone2Length;let p=n.Pq.Distance(s,e);this._maxReach>0&&(p=Math.min(this._maxReach,p));let m=(d*d+p*p-u*u)/(2*d*p),f=(p*p+u*u-d*d)/(2*p*u);m>1&&(m=1),f>1&&(f=1),m<-1&&(m=-1),f<-1&&(f=-1);const _=Math.acos(m),g=Math.acos(f);let x=-_-g;if(this._rightHandedSystem)n.uq.RotationYawPitchRollToRef(0,0,this._adjustRoll,r),r.multiplyToRef(i,i),n.uq.RotationAxisToRef(this._bendAxis,g,r),r.multiplyToRef(i,i);else{const e=It._TmpVecs[5];e.copyFrom(this._bendAxis),e.x*=-1,n.uq.RotationAxisToRef(e,-g,r),r.multiplyToRef(i,i)}this.poleAngle&&(n.uq.RotationAxisToRef(l,this.poleAngle,r),i.multiplyToRef(r,i)),this._bone1&&(this.slerpAmount<1?(this._slerping||n.PT.FromRotationMatrixToRef(this._bone1Mat,this._bone1Quat),n.PT.FromRotationMatrixToRef(i,c),n.PT.SlerpToRef(this._bone1Quat,c,this.slerpAmount,this._bone1Quat),x=this._bone2Ang*(1-this.slerpAmount)+x*this.slerpAmount,this._bone1.setRotationQuaternion(this._bone1Quat,1,this.mesh),this._slerping=!0):(this._bone1.setRotationMatrix(i,1,this.mesh),this._bone1Mat.copyFrom(i),this._slerping=!1),this._updateLinkedTransformRotation(this._bone1)),this._bone2.setAxisAngle(this._bendAxis,x,0),this._updateLinkedTransformRotation(this._bone2),this._bone2Ang=x}_updateLinkedTransformRotation(e){e._linkedTransformNode&&(e._linkedTransformNode.rotationQuaternion||(e._linkedTransformNode.rotationQuaternion=new n.PT),e.getRotationQuaternionToRef(0,null,e._linkedTransformNode.rotationQuaternion))}}It._TmpVecs=[n.Pq.Zero(),n.Pq.Zero(),n.Pq.Zero(),n.Pq.Zero(),n.Pq.Zero(),n.Pq.Zero()],It._TmpQuat=n.PT.Identity(),It._TmpMats=[n.uq.Identity(),n.uq.Identity()];var Rt=i(27309),Mt=i(18733);class Dt{get minYaw(){return this._minYaw}set minYaw(e){this._minYaw=e,this._minYawSin=Math.sin(e),this._minYawCos=Math.cos(e),null!=this._maxYaw&&(this._midYawConstraint=.5*this._getAngleDiff(this._minYaw,this._maxYaw)+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)}get maxYaw(){return this._maxYaw}set maxYaw(e){this._maxYaw=e,this._maxYawSin=Math.sin(e),this._maxYawCos=Math.cos(e),null!=this._minYaw&&(this._midYawConstraint=.5*this._getAngleDiff(this._minYaw,this._maxYaw)+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)}get minPitch(){return this._minPitch}set minPitch(e){this._minPitch=e,this._minPitchTan=Math.tan(e)}get maxPitch(){return this._maxPitch}set maxPitch(e){this._maxPitch=e,this._maxPitchTan=Math.tan(e)}constructor(e,t,i,r){if(this.upAxis=n.Pq.Up(),this.upAxisSpace=0,this.adjustYaw=0,this.adjustPitch=0,this.adjustRoll=0,this.slerpAmount=1,this._boneQuat=n.PT.Identity(),this._slerping=!1,this._firstFrameSkipped=!1,this._fowardAxis=n.Pq.Forward(),this.useAbsoluteValueForYaw=!1,this.mesh=e,this.bone=t,this.target=i,r){if(r.adjustYaw&&(this.adjustYaw=r.adjustYaw),r.adjustPitch&&(this.adjustPitch=r.adjustPitch),r.adjustRoll&&(this.adjustRoll=r.adjustRoll),null!=r.maxYaw?this.maxYaw=r.maxYaw:this.maxYaw=Math.PI,null!=r.minYaw?this.minYaw=r.minYaw:this.minYaw=-Math.PI,null!=r.maxPitch?this.maxPitch=r.maxPitch:this.maxPitch=Math.PI,null!=r.minPitch?this.minPitch=r.minPitch:this.minPitch=-Math.PI,null!=r.slerpAmount&&(this.slerpAmount=r.slerpAmount),null!=r.upAxis&&(this.upAxis=r.upAxis),null!=r.upAxisSpace&&(this.upAxisSpace=r.upAxisSpace),null!=r.yawAxis||null!=r.pitchAxis){let e=Mt._0.Y,t=Mt._0.X;null!=r.yawAxis&&(e=r.yawAxis.clone(),e.normalize()),null!=r.pitchAxis&&(t=r.pitchAxis.clone(),t.normalize());const i=n.Pq.Cross(t,e);this._transformYawPitch=n.uq.Identity(),n.uq.FromXYZAxesToRef(t,e,i,this._transformYawPitch),this._transformYawPitchInv=this._transformYawPitch.clone(),this._transformYawPitch.invert()}void 0!==r.useAbsoluteValueForYaw&&(this.useAbsoluteValueForYaw=r.useAbsoluteValueForYaw)}t.getParent()||2!=this.upAxisSpace||(this.upAxisSpace=0)}update(){if(this.slerpAmount<1&&!this._firstFrameSkipped)return void(this._firstFrameSkipped=!0);const e=this.bone,t=Dt._TmpVecs[0];e.getAbsolutePositionToRef(this.mesh,t);let i=this.target;const r=Dt._TmpMats[0],s=Dt._TmpMats[1],o=this.mesh,a=e.getParent(),l=Dt._TmpVecs[1];l.copyFrom(this.upAxis),2==this.upAxisSpace&&a?(this._transformYawPitch&&n.Pq.TransformCoordinatesToRef(l,this._transformYawPitchInv,l),a.getDirectionToRef(l,this.mesh,l)):0==this.upAxisSpace&&(o.getDirectionToRef(l,l),1==o.scaling.x&&1==o.scaling.y&&1==o.scaling.z||l.normalize());let h=!1,c=!1;if(this._maxYaw==Math.PI&&this._minYaw==-Math.PI||(h=!0),this._maxPitch==Math.PI&&this._minPitch==-Math.PI||(c=!0),h||c){const e=Dt._TmpMats[2],r=Dt._TmpMats[3];if(2==this.upAxisSpace&&1==l.y&&a)a.getRotationMatrixToRef(1,this.mesh,e);else if(0!=this.upAxisSpace||1!=l.y||a){let t=Dt._TmpVecs[2];t.copyFrom(this._fowardAxis),this._transformYawPitch&&n.Pq.TransformCoordinatesToRef(t,this._transformYawPitchInv,t),a?a.getDirectionToRef(t,this.mesh,t):o.getDirectionToRef(t,t);const i=n.Pq.Cross(l,t);i.normalize(),t=n.Pq.Cross(i,l),n.uq.FromXYZAxesToRef(i,l,t,e)}else e.copyFrom(o.getWorldMatrix());e.invertToRef(r);let s=null;if(c){const o=Dt._TmpVecs[3];i.subtractToRef(t,o),n.Pq.TransformCoordinatesToRef(o,r,o),s=Math.sqrt(o.x*o.x+o.z*o.z);const a=Math.atan2(o.y,s);let l=a;a>this._maxPitch?(o.y=this._maxPitchTan*s,l=this._maxPitch):a<this._minPitch&&(o.y=this._minPitchTan*s,l=this._minPitch),a!=l&&(n.Pq.TransformCoordinatesToRef(o,e,o),o.addInPlace(t),i=o)}if(h){const o=Dt._TmpVecs[4];i.subtractToRef(t,o),n.Pq.TransformCoordinatesToRef(o,r,o);const a=Math.atan2(o.x,o.z),l=this.useAbsoluteValueForYaw?Math.abs(a):a;let h=a;if((l>this._maxYaw||l<this._minYaw)&&(null==s&&(s=Math.sqrt(o.x*o.x+o.z*o.z)),this._yawRange>Math.PI?this._isAngleBetween(a,this._maxYaw,this._midYawConstraint)?(o.z=this._maxYawCos*s,o.x=this._maxYawSin*s,h=this._maxYaw):this._isAngleBetween(a,this._midYawConstraint,this._minYaw)&&(o.z=this._minYawCos*s,o.x=this._minYawSin*s,h=this._minYaw):l>this._maxYaw?(o.z=this._maxYawCos*s,o.x=this._maxYawSin*s,a<0&&this.useAbsoluteValueForYaw&&(o.x*=-1),h=this._maxYaw):l<this._minYaw&&(o.z=this._minYawCos*s,o.x=this._minYawSin*s,a<0&&this.useAbsoluteValueForYaw&&(o.x*=-1),h=this._minYaw)),this._slerping&&this._yawRange>Math.PI){const e=Dt._TmpVecs[8];e.copyFrom(Mt._0.Z),this._transformYawPitch&&n.Pq.TransformCoordinatesToRef(e,this._transformYawPitchInv,e);const t=Dt._TmpMats[4];this._boneQuat.toRotationMatrix(t),this.mesh.getWorldMatrix().multiplyToRef(t,t),n.Pq.TransformCoordinatesToRef(e,t,e),n.Pq.TransformCoordinatesToRef(e,r,e);const i=Math.atan2(e.x,e.z);if(this._getAngleBetween(i,a)>this._getAngleBetween(i,this._midYawConstraint)){null==s&&(s=Math.sqrt(o.x*o.x+o.z*o.z));const e=this._getAngleBetween(i,this._maxYaw);this._getAngleBetween(i,this._minYaw)<e?(h=i+.75*Math.PI,o.z=Math.cos(h)*s,o.x=Math.sin(h)*s):(h=i-.75*Math.PI,o.z=Math.cos(h)*s,o.x=Math.sin(h)*s)}}a!=h&&(n.Pq.TransformCoordinatesToRef(o,e,o),o.addInPlace(t),i=o)}}const u=Dt._TmpVecs[5],d=Dt._TmpVecs[6],p=Dt._TmpVecs[7],m=Dt._TmpQuat,f=Dt._TmpVecs[9];i.subtractToRef(t,u),u.normalize(),n.Pq.CrossToRef(l,u,d),d.normalize(),n.Pq.CrossToRef(u,d,p),p.normalize(),n.uq.FromXYZAxesToRef(d,p,u,r),0===d.x&&0===d.y&&0===d.z||0===p.x&&0===p.y&&0===p.z||0===u.x&&0===u.y&&0===u.z||((this.adjustYaw||this.adjustPitch||this.adjustRoll)&&(n.uq.RotationYawPitchRollToRef(this.adjustYaw,this.adjustPitch,this.adjustRoll,s),s.multiplyToRef(r,r)),f.copyFrom(this.bone.getScale()),this.slerpAmount<1?(this._slerping||this.bone.getRotationQuaternionToRef(1,this.mesh,this._boneQuat),this._transformYawPitch&&this._transformYawPitch.multiplyToRef(r,r),n.PT.FromRotationMatrixToRef(r,m),n.PT.SlerpToRef(this._boneQuat,m,this.slerpAmount,this._boneQuat),this.bone.setRotationQuaternion(this._boneQuat,1,this.mesh),this._slerping=!0):(this._transformYawPitch&&this._transformYawPitch.multiplyToRef(r,r),this.bone.setRotationMatrix(r,1,this.mesh),this._slerping=!1),this.bone.setScale(f),this._updateLinkedTransformRotation())}_getAngleDiff(e,t){let i=t-e;return i%=2*Math.PI,i>Math.PI?i-=2*Math.PI:i<-Math.PI&&(i+=2*Math.PI),i}_getAngleBetween(e,t){let i=0;return i=(e=(e%=2*Math.PI)<0?e+2*Math.PI:e)<(t=(t%=2*Math.PI)<0?t+2*Math.PI:t)?t-e:e-t,i>Math.PI&&(i=2*Math.PI-i),i}_isAngleBetween(e,t,i){if(e=(e%=2*Math.PI)<0?e+2*Math.PI:e,(t=(t%=2*Math.PI)<0?t+2*Math.PI:t)<(i=(i%=2*Math.PI)<0?i+2*Math.PI:i)){if(e>t&&e<i)return!0}else if(e>i&&e<t)return!0;return!1}_updateLinkedTransformRotation(){const e=this.bone;e._linkedTransformNode&&(e._linkedTransformNode.rotationQuaternion||(e._linkedTransformNode.rotationQuaternion=new n.PT),e.getRotationQuaternionToRef(0,null,e._linkedTransformNode.rotationQuaternion))}}Dt._TmpVecs=(0,Rt.mI)(10,n.Pq.Zero),Dt._TmpQuat=n.PT.Identity(),Dt._TmpMats=(0,Rt.mI)(5,n.uq.Identity);var Ot=i(95616),Nt=i(11675),wt=i(71504),Ft=i(31367),Bt=(i(38139),i(54973)),Vt=i(40273),Lt=i(22002);class kt{constructor(e,t){this.x=e,this.y=t}}class Gt{get isConnected(){return this._isConnected}constructor(e,t,i,r=0,s=1,n=2,o=3){this.id=e,this.index=t,this.browserGamepad=i,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=Gt.GAMEPAD,this._leftStickAxisX=r,this._leftStickAxisY=s,this._rightStickAxisX=n,this._rightStickAxisY=o,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}onleftstickchanged(e){this._onleftstickchanged=e}onrightstickchanged(e){this._onrightstickchanged=e}get leftStick(){return this._leftStick}set leftStick(e){!this._onleftstickchanged||this._leftStick.x===e.x&&this._leftStick.y===e.y||this._onleftstickchanged(e),this._leftStick=e}get rightStick(){return this._rightStick}set rightStick(e){!this._onrightstickchanged||this._rightStick.x===e.x&&this._rightStick.y===e.y||this._onrightstickchanged(e),this._rightStick=e}update(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}dispose(){}}Gt.GAMEPAD=0,Gt.GENERIC=1,Gt.XBOX=2,Gt.POSE_ENABLED=3,Gt.DUALSHOCK=4;class zt extends Gt{onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}constructor(e,t,i){super(e,t,i),this.onButtonDownObservable=new s.cP,this.onButtonUpObservable=new s.cP,this.type=Gt.GENERIC,this._buttons=new Array(i.buttons.length)}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()}}class Ut{constructor(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this._yAxisScale=1}get invertYAxis(){return 1!==this._yAxisScale}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add((e=>{e.type!==Gt.POSE_ENABLED&&(this.gamepad&&e.type!==Gt.XBOX||(this.gamepad=e))})),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add((e=>{this.gamepad===e&&(this.gamepad=null)})),this.gamepad=e.getGamepadByType(Gt.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad){const e=this.camera,t=this.gamepad.rightStick;if(t){if(0!=t.x){const i=t.x/this.gamepadRotationSensibility;0!=i&&Math.abs(i)>.005&&(e.inertialAlphaOffset+=i)}if(0!=t.y){const i=t.y/this.gamepadRotationSensibility*this._yAxisScale;0!=i&&Math.abs(i)>.005&&(e.inertialBetaOffset+=i)}}const i=this.gamepad.leftStick;if(i&&0!=i.y){const e=i.y/this.gamepadMoveSensibility;0!=e&&Math.abs(e)>.005&&(this.camera.inertialRadiusOffset-=e)}}}getClassName(){return"ArcRotateCameraGamepadInput"}getSimpleName(){return"gamepad"}}(0,Ge.Cg)([(0,ze.lK)()],Ut.prototype,"gamepadRotationSensibility",void 0),(0,Ge.Cg)([(0,ze.lK)()],Ut.prototype,"gamepadMoveSensibility",void 0),Lt.H.ArcRotateCameraGamepadInput=Ut;var Wt=i(22661),Ht=i(57491),$t=i(71267),qt=i(93187);qt.H.prototype.addVRDeviceOrientation=function(){return this.add(new Yt),this};class Yt{constructor(){this.alphaCorrection=1,this.gammaCorrection=1,this._alpha=0,this._gamma=0,this._dirty=!1,this._deviceOrientationHandler=e=>this._onOrientationEvent(e)}attachControl(e){e=H.S0.BackCompatCameraNoPreventDefault(arguments),this.camera.attachControl(e);const t=this.camera.getScene().getEngine().getHostWindow();t&&("undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((e=>{"granted"===e?t.addEventListener("deviceorientation",this._deviceOrientationHandler):H.S0.Warn("Permission not granted.")})).catch((e=>{H.S0.Error(e)})):t.addEventListener("deviceorientation",this._deviceOrientationHandler))}_onOrientationEvent(e){null!==e.alpha&&(this._alpha=(0|+e.alpha)*this.alphaCorrection),null!==e.gamma&&(this._gamma=(0|+e.gamma)*this.gammaCorrection),this._dirty=!0}checkInputs(){this._dirty&&(this._dirty=!1,this._gamma<0&&(this._gamma=180+this._gamma),this.camera.alpha=-this._alpha/180*Math.PI%Math.PI*2,this.camera.beta=this._gamma/180*Math.PI)}detachControl(){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)}getClassName(){return"ArcRotateCameraVRDeviceOrientationInput"}getSimpleName(){return"VRDeviceOrientation"}}Lt.H.ArcRotateCameraVRDeviceOrientationInput=Yt;var Xt=i(24146);class jt{constructor(){this.keysForward=[87],this.keysBackward=[83],this.keysUp=[69],this.keysDown=[81],this.keysRight=[68],this.keysLeft=[65],this._keys=new Array}attachControl(e){e=H.S0.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add((()=>{this._keys.length=0})),this._onKeyboardObserver=this._scene.onKeyboardObservable.add((t=>{const i=t.event;if(t.type===Xt.TB.KEYDOWN){if(-1!==this.keysForward.indexOf(i.keyCode)||-1!==this.keysBackward.indexOf(i.keyCode)||-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)){-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),e||i.preventDefault()}}else if(-1!==this.keysForward.indexOf(i.keyCode)||-1!==this.keysBackward.indexOf(i.keyCode)||-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)){const t=this._keys.indexOf(i.keyCode);t>=0&&this._keys.splice(t,1),e||i.preventDefault()}})))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}getClassName(){return"FlyCameraKeyboardInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],r=e._computeLocalCameraSpeed();-1!==this.keysForward.indexOf(i)?e._localDirection.copyFromFloats(0,0,r):-1!==this.keysBackward.indexOf(i)?e._localDirection.copyFromFloats(0,0,-r):-1!==this.keysUp.indexOf(i)?e._localDirection.copyFromFloats(0,r,0):-1!==this.keysDown.indexOf(i)?e._localDirection.copyFromFloats(0,-r,0):-1!==this.keysRight.indexOf(i)?e._localDirection.copyFromFloats(r,0,0):-1!==this.keysLeft.indexOf(i)&&e._localDirection.copyFromFloats(-r,0,0),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),n.Pq.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}}(0,Ge.Cg)([(0,ze.lK)()],jt.prototype,"keysForward",void 0),(0,Ge.Cg)([(0,ze.lK)()],jt.prototype,"keysBackward",void 0),(0,Ge.Cg)([(0,ze.lK)()],jt.prototype,"keysUp",void 0),(0,Ge.Cg)([(0,ze.lK)()],jt.prototype,"keysDown",void 0),(0,Ge.Cg)([(0,ze.lK)()],jt.prototype,"keysRight",void 0),(0,Ge.Cg)([(0,ze.lK)()],jt.prototype,"keysLeft",void 0),Lt.H.FlyCameraKeyboardInput=jt;class Zt{constructor(){this.buttons=[0,1,2],this.buttonsYaw=[-1,0,1],this.buttonsPitch=[-1,0,1],this.buttonsRoll=[2],this.activeButton=-1,this.angularSensibility=1e3,this._previousPosition=null}attachControl(e){e=H.S0.BackCompatCameraNoPreventDefault(arguments),this._noPreventDefault=e,this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver((e=>{this._pointerInput(e)}),rt.Zp.POINTERDOWN|rt.Zp.POINTERUP|rt.Zp.POINTERMOVE),this._rollObserver=this.camera.getScene().onBeforeRenderObservable.add((()=>{this.camera.rollCorrect&&this.camera.restoreRoll(this.camera.rollCorrect)}))}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this.camera.getScene().onBeforeRenderObservable.remove(this._rollObserver),this._observer=null,this._rollObserver=null,this._previousPosition=null,this._noPreventDefault=void 0)}getClassName(){return"FlyCameraMouseInput"}getSimpleName(){return"mouse"}_pointerInput(e){const t=e.event,i=this.camera.getEngine();if(!this.touchEnabled&&"touch"===t.pointerType)return;if(e.type!==rt.Zp.POINTERMOVE&&-1===this.buttons.indexOf(t.button))return;const r=t.target;if(e.type===rt.Zp.POINTERDOWN){try{r?.setPointerCapture(t.pointerId)}catch(t){}this._previousPosition={x:t.clientX,y:t.clientY},this.activeButton=t.button,this._noPreventDefault||t.preventDefault(),i.isPointerLock&&this._onMouseMove(e.event)}else if(e.type===rt.Zp.POINTERUP){try{r?.releasePointerCapture(t.pointerId)}catch(t){}this.activeButton=-1,this._previousPosition=null,this._noPreventDefault||t.preventDefault()}else if(e.type===rt.Zp.POINTERMOVE){if(!this._previousPosition)return void(i.isPointerLock&&this._onMouseMove(e.event));const r=t.clientX-this._previousPosition.x,s=t.clientY-this._previousPosition.y;this._rotateCamera(r,s),this._previousPosition={x:t.clientX,y:t.clientY},this._noPreventDefault||t.preventDefault()}}_onMouseMove(e){if(!this.camera.getEngine().isPointerLock)return;const t=e.movementX,i=e.movementY;this._rotateCamera(t,i),this._previousPosition=null,this._noPreventDefault||e.preventDefault()}_rotateCamera(e,t){const i=this.camera,r=(e*=i._calculateHandednessMultiplier())/this.angularSensibility,s=t/this.angularSensibility,o=n.PT.RotationYawPitchRoll(i.rotation.y,i.rotation.x,i.rotation.z);let a;if(this.buttonsPitch.some((e=>e===this.activeButton))&&(a=n.PT.RotationAxis(Mt._0.X,s),o.multiplyInPlace(a)),this.buttonsYaw.some((e=>e===this.activeButton))){a=n.PT.RotationAxis(Mt._0.Y,r),o.multiplyInPlace(a);const e=i.bankedTurnLimit+i._trackRoll;if(i.bankedTurn&&-e<i.rotation.z&&i.rotation.z<e){const e=i.bankedTurnMultiplier*-r;a=n.PT.RotationAxis(Mt._0.Z,e),o.multiplyInPlace(a)}}this.buttonsRoll.some((e=>e===this.activeButton))&&(a=n.PT.RotationAxis(Mt._0.Z,-r),i._trackRoll-=r,o.multiplyInPlace(a)),o.toEulerAnglesToRef(i.rotation)}}(0,Ge.Cg)([(0,ze.lK)()],Zt.prototype,"buttons",void 0),(0,Ge.Cg)([(0,ze.lK)()],Zt.prototype,"angularSensibility",void 0),Lt.H.FlyCameraMouseInput=Zt;class Qt{constructor(){this.keysHeightOffsetIncr=[38],this.keysHeightOffsetDecr=[40],this.keysHeightOffsetModifierAlt=!1,this.keysHeightOffsetModifierCtrl=!1,this.keysHeightOffsetModifierShift=!1,this.keysRotationOffsetIncr=[37],this.keysRotationOffsetDecr=[39],this.keysRotationOffsetModifierAlt=!1,this.keysRotationOffsetModifierCtrl=!1,this.keysRotationOffsetModifierShift=!1,this.keysRadiusIncr=[40],this.keysRadiusDecr=[38],this.keysRadiusModifierAlt=!0,this.keysRadiusModifierCtrl=!1,this.keysRadiusModifierShift=!1,this.heightSensibility=1,this.rotationSensibility=1,this.radiusSensibility=1,this._keys=new Array}attachControl(e){e=H.S0.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add((()=>{this._keys.length=0})),this._onKeyboardObserver=this._scene.onKeyboardObservable.add((t=>{const i=t.event;if(!i.metaKey)if(t.type===Xt.TB.KEYDOWN){if(this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,this._shiftPressed=i.shiftKey,-1!==this.keysHeightOffsetIncr.indexOf(i.keyCode)||-1!==this.keysHeightOffsetDecr.indexOf(i.keyCode)||-1!==this.keysRotationOffsetIncr.indexOf(i.keyCode)||-1!==this.keysRotationOffsetDecr.indexOf(i.keyCode)||-1!==this.keysRadiusIncr.indexOf(i.keyCode)||-1!==this.keysRadiusDecr.indexOf(i.keyCode)){-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault())}}else if(-1!==this.keysHeightOffsetIncr.indexOf(i.keyCode)||-1!==this.keysHeightOffsetDecr.indexOf(i.keyCode)||-1!==this.keysRotationOffsetIncr.indexOf(i.keyCode)||-1!==this.keysRotationOffsetDecr.indexOf(i.keyCode)||-1!==this.keysRadiusIncr.indexOf(i.keyCode)||-1!==this.keysRadiusDecr.indexOf(i.keyCode)){const t=this._keys.indexOf(i.keyCode);t>=0&&this._keys.splice(t,1),i.preventDefault&&(e||i.preventDefault())}})))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){this._onKeyboardObserver&&this._keys.forEach((e=>{-1!==this.keysHeightOffsetIncr.indexOf(e)&&this._modifierHeightOffset()?this.camera.heightOffset+=this.heightSensibility:-1!==this.keysHeightOffsetDecr.indexOf(e)&&this._modifierHeightOffset()?this.camera.heightOffset-=this.heightSensibility:-1!==this.keysRotationOffsetIncr.indexOf(e)&&this._modifierRotationOffset()?(this.camera.rotationOffset+=this.rotationSensibility,this.camera.rotationOffset%=360):-1!==this.keysRotationOffsetDecr.indexOf(e)&&this._modifierRotationOffset()?(this.camera.rotationOffset-=this.rotationSensibility,this.camera.rotationOffset%=360):-1!==this.keysRadiusIncr.indexOf(e)&&this._modifierRadius()?this.camera.radius+=this.radiusSensibility:-1!==this.keysRadiusDecr.indexOf(e)&&this._modifierRadius()&&(this.camera.radius-=this.radiusSensibility)}))}getClassName(){return"FollowCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}_modifierHeightOffset(){return this.keysHeightOffsetModifierAlt===this._altPressed&&this.keysHeightOffsetModifierCtrl===this._ctrlPressed&&this.keysHeightOffsetModifierShift===this._shiftPressed}_modifierRotationOffset(){return this.keysRotationOffsetModifierAlt===this._altPressed&&this.keysRotationOffsetModifierCtrl===this._ctrlPressed&&this.keysRotationOffsetModifierShift===this._shiftPressed}_modifierRadius(){return this.keysRadiusModifierAlt===this._altPressed&&this.keysRadiusModifierCtrl===this._ctrlPressed&&this.keysRadiusModifierShift===this._shiftPressed}}(0,Ge.Cg)([(0,ze.lK)()],Qt.prototype,"keysHeightOffsetIncr",void 0),(0,Ge.Cg)([(0,ze.lK)()],Qt.prototype,"keysHeightOffsetDecr",void 0),(0,Ge.Cg)([(0,ze.lK)()],Qt.prototype,"keysHeightOffsetModifierAlt",void 0),(0,Ge.Cg)([(0,ze.lK)()],Qt.prototype,"keysHeightOffsetModifierCtrl",void 0),(0,Ge.Cg)([(0,ze.lK)()],Qt.prototype,"keysHeightOffsetModifierShift",void 0),(0,Ge.Cg)([(0,ze.lK)()],Qt.prototype,"keysRotationOffsetIncr",void 0),(0,Ge.Cg)([(0,ze.lK)()],Qt.prototype,"keysRotationOffsetDecr",void 0),(0,Ge.Cg)([(0,ze.lK)()],Qt.prototype,"keysRotationOffsetModifierAlt",void 0),(0,Ge.Cg)([(0,ze.lK)()],Qt.prototype,"keysRotationOffsetModifierCtrl",void 0),(0,Ge.Cg)([(0,ze.lK)()],Qt.prototype,"keysRotationOffsetModifierShift",void 0),(0,Ge.Cg)([(0,ze.lK)()],Qt.prototype,"keysRadiusIncr",void 0),(0,Ge.Cg)([(0,ze.lK)()],Qt.prototype,"keysRadiusDecr",void 0),(0,Ge.Cg)([(0,ze.lK)()],Qt.prototype,"keysRadiusModifierAlt",void 0),(0,Ge.Cg)([(0,ze.lK)()],Qt.prototype,"keysRadiusModifierCtrl",void 0),(0,Ge.Cg)([(0,ze.lK)()],Qt.prototype,"keysRadiusModifierShift",void 0),(0,Ge.Cg)([(0,ze.lK)()],Qt.prototype,"heightSensibility",void 0),(0,Ge.Cg)([(0,ze.lK)()],Qt.prototype,"rotationSensibility",void 0),(0,Ge.Cg)([(0,ze.lK)()],Qt.prototype,"radiusSensibility",void 0),Lt.H.FollowCameraKeyboardMoveInput=Qt;class Kt{constructor(){this.axisControlRadius=!0,this.axisControlHeight=!1,this.axisControlRotation=!1,this.wheelPrecision=3,this.wheelDeltaPercentage=0}attachControl(e){e=H.S0.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==rt.Zp.POINTERWHEEL)return;const i=t.event;let r=0;const s=Math.max(-1,Math.min(1,i.deltaY));this.wheelDeltaPercentage?(+this.axisControlRadius+ +this.axisControlHeight+ +this.axisControlRotation&&m.V.Warn("wheelDeltaPercentage only usable when mouse wheel controls ONE axis. Currently enabled: axisControlRadius: "+this.axisControlRadius+", axisControlHeightOffset: "+this.axisControlHeight+", axisControlRotationOffset: "+this.axisControlRotation),this.axisControlRadius?r=.01*s*this.wheelDeltaPercentage*this.camera.radius:this.axisControlHeight?r=.01*s*this.wheelDeltaPercentage*this.camera.heightOffset:this.axisControlRotation&&(r=.01*s*this.wheelDeltaPercentage*this.camera.rotationOffset)):r=s*this.wheelPrecision,r&&(this.axisControlRadius?this.camera.radius+=r:this.axisControlHeight?this.camera.heightOffset-=r:this.axisControlRotation&&(this.camera.rotationOffset-=r)),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,rt.Zp.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}(0,Ge.Cg)([(0,ze.lK)()],Kt.prototype,"axisControlRadius",void 0),(0,Ge.Cg)([(0,ze.lK)()],Kt.prototype,"axisControlHeight",void 0),(0,Ge.Cg)([(0,ze.lK)()],Kt.prototype,"axisControlRotation",void 0),(0,Ge.Cg)([(0,ze.lK)()],Kt.prototype,"wheelPrecision",void 0),(0,Ge.Cg)([(0,ze.lK)()],Kt.prototype,"wheelDeltaPercentage",void 0),Lt.H.FollowCameraMouseWheelInput=Kt;class Jt extends Vt.R{constructor(){super(...arguments),this.angularSensibilityX=1,this.angularSensibilityY=1,this.pinchPrecision=1e4,this.pinchDeltaPercentage=0,this.axisXControlRadius=!1,this.axisXControlHeight=!1,this.axisXControlRotation=!0,this.axisYControlRadius=!1,this.axisYControlHeight=!0,this.axisYControlRotation=!1,this.axisPinchControlRadius=!0,this.axisPinchControlHeight=!1,this.axisPinchControlRotation=!1,this.warningEnable=!0,this._warningCounter=0}getClassName(){return"FollowCameraPointersInput"}onTouch(e,t,i){this._warning(),this.axisXControlRotation?this.camera.rotationOffset+=t/this.angularSensibilityX:this.axisYControlRotation&&(this.camera.rotationOffset+=i/this.angularSensibilityX),this.axisXControlHeight?this.camera.heightOffset+=t/this.angularSensibilityY:this.axisYControlHeight&&(this.camera.heightOffset+=i/this.angularSensibilityY),this.axisXControlRadius?this.camera.radius-=t/this.angularSensibilityY:this.axisYControlRadius&&(this.camera.radius-=i/this.angularSensibilityY)}onMultiTouch(e,t,i,r,s,n){if(0===i&&null===s)return;if(0===r&&null===n)return;let o=(r-i)/(this.pinchPrecision*(this.angularSensibilityX+this.angularSensibilityY)/2);this.pinchDeltaPercentage?(o*=.01*this.pinchDeltaPercentage,this.axisPinchControlRotation&&(this.camera.rotationOffset+=o*this.camera.rotationOffset),this.axisPinchControlHeight&&(this.camera.heightOffset+=o*this.camera.heightOffset),this.axisPinchControlRadius&&(this.camera.radius-=o*this.camera.radius)):(this.axisPinchControlRotation&&(this.camera.rotationOffset+=o),this.axisPinchControlHeight&&(this.camera.heightOffset+=o),this.axisPinchControlRadius&&(this.camera.radius-=o))}_warning(){if(!this.warningEnable||this._warningCounter++%100!=0)return;const e="It probably only makes sense to control ONE camera property with each pointer axis. Set 'warningEnable = false' if you are sure. Currently enabled: ";+this.axisXControlRotation+ +this.axisXControlHeight+ +this.axisXControlRadius<=1&&m.V.Warn(e+"axisXControlRotation: "+this.axisXControlRotation+", axisXControlHeight: "+this.axisXControlHeight+", axisXControlRadius: "+this.axisXControlRadius),+this.axisYControlRotation+ +this.axisYControlHeight+ +this.axisYControlRadius<=1&&m.V.Warn(e+"axisYControlRotation: "+this.axisYControlRotation+", axisYControlHeight: "+this.axisYControlHeight+", axisYControlRadius: "+this.axisYControlRadius),+this.axisPinchControlRotation+ +this.axisPinchControlHeight+ +this.axisPinchControlRadius<=1&&m.V.Warn(e+"axisPinchControlRotation: "+this.axisPinchControlRotation+", axisPinchControlHeight: "+this.axisPinchControlHeight+", axisPinchControlRadius: "+this.axisPinchControlRadius)}}(0,Ge.Cg)([(0,ze.lK)()],Jt.prototype,"angularSensibilityX",void 0),(0,Ge.Cg)([(0,ze.lK)()],Jt.prototype,"angularSensibilityY",void 0),(0,Ge.Cg)([(0,ze.lK)()],Jt.prototype,"pinchPrecision",void 0),(0,Ge.Cg)([(0,ze.lK)()],Jt.prototype,"pinchDeltaPercentage",void 0),(0,Ge.Cg)([(0,ze.lK)()],Jt.prototype,"axisXControlRadius",void 0),(0,Ge.Cg)([(0,ze.lK)()],Jt.prototype,"axisXControlHeight",void 0),(0,Ge.Cg)([(0,ze.lK)()],Jt.prototype,"axisXControlRotation",void 0),(0,Ge.Cg)([(0,ze.lK)()],Jt.prototype,"axisYControlRadius",void 0),(0,Ge.Cg)([(0,ze.lK)()],Jt.prototype,"axisYControlHeight",void 0),(0,Ge.Cg)([(0,ze.lK)()],Jt.prototype,"axisYControlRotation",void 0),(0,Ge.Cg)([(0,ze.lK)()],Jt.prototype,"axisPinchControlRadius",void 0),(0,Ge.Cg)([(0,ze.lK)()],Jt.prototype,"axisPinchControlHeight",void 0),(0,Ge.Cg)([(0,ze.lK)()],Jt.prototype,"axisPinchControlRotation",void 0),Lt.H.FollowCameraPointersInput=Jt;var ei=i(67100);ei.s.prototype.addDeviceOrientation=function(e){return this._deviceOrientationInput||(this._deviceOrientationInput=new ti,e&&(this._deviceOrientationInput.smoothFactor=e),this.add(this._deviceOrientationInput)),this};class ti{static WaitForOrientationChangeAsync(e){return new Promise(((t,i)=>{let r=!1;const s=()=>{window.removeEventListener("deviceorientation",s),r=!0,t()};e&&setTimeout((()=>{r||(window.removeEventListener("deviceorientation",s),i("WaitForOrientationChangeAsync timed out"))}),e),"undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((e=>{"granted"==e?window.addEventListener("deviceorientation",s):H.S0.Warn("Permission not granted.")})).catch((e=>{H.S0.Error(e)})):window.addEventListener("deviceorientation",s)}))}constructor(){this._screenOrientationAngle=0,this._screenQuaternion=new n.PT,this._alpha=0,this._beta=0,this._gamma=0,this.smoothFactor=0,this._onDeviceOrientationChangedObservable=new s.cP,this._orientationChanged=()=>{this._screenOrientationAngle=void 0!==window.orientation?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this._screenOrientationAngle=-H.S0.ToRadians(this._screenOrientationAngle/2),this._screenQuaternion.copyFromFloats(0,Math.sin(this._screenOrientationAngle),0,Math.cos(this._screenOrientationAngle))},this._deviceOrientation=e=>{this.smoothFactor?(this._alpha=null!==e.alpha?H.S0.SmoothAngleChange(this._alpha,e.alpha,this.smoothFactor):0,this._beta=null!==e.beta?H.S0.SmoothAngleChange(this._beta,e.beta,this.smoothFactor):0,this._gamma=null!==e.gamma?H.S0.SmoothAngleChange(this._gamma,e.gamma,this.smoothFactor):0):(this._alpha=null!==e.alpha?e.alpha:0,this._beta=null!==e.beta?e.beta:0,this._gamma=null!==e.gamma?e.gamma:0),null!==e.alpha&&this._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTransform=new n.PT(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}get camera(){return this._camera}set camera(e){this._camera=e,null==this._camera||this._camera.rotationQuaternion||(this._camera.rotationQuaternion=new n.PT),this._camera&&this._camera.onDisposeObservable.add((()=>{this._onDeviceOrientationChangedObservable.clear()}))}attachControl(){const e=this.camera.getScene().getEngine().getHostWindow();if(e){const t=()=>{e.addEventListener("orientationchange",this._orientationChanged),e.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()};"undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((e=>{"granted"===e?t():H.S0.Warn("Permission not granted.")})).catch((e=>{H.S0.Error(e)})):t()}}detachControl(){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0}checkInputs(){this._alpha&&(n.PT.RotationYawPitchRollToRef(H.S0.ToRadians(this._alpha),H.S0.ToRadians(this._beta),-H.S0.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTransform),this._camera.getScene().useRightHandedSystem?this._camera.rotationQuaternion.y*=-1:this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}}Lt.H.FreeCameraDeviceOrientationInput=ti;class ii{constructor(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this.deadzoneDelta=.1,this._yAxisScale=1,this._cameraTransform=n.uq.Identity(),this._deltaTransform=n.Pq.Zero(),this._vector3=n.Pq.Zero(),this._vector2=n.I9.Zero()}get invertYAxis(){return 1!==this._yAxisScale}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add((e=>{e.type!==Gt.POSE_ENABLED&&(this.gamepad&&e.type!==Gt.XBOX||(this.gamepad=e))})),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add((e=>{this.gamepad===e&&(this.gamepad=null)})),this.gamepad=e.getGamepadByType(Gt.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad&&this.gamepad.leftStick){const e=this.camera,t=this.gamepad.leftStick;0!==this.gamepadMoveSensibility&&(t.x=Math.abs(t.x)>this.deadzoneDelta?t.x/this.gamepadMoveSensibility:0,t.y=Math.abs(t.y)>this.deadzoneDelta?t.y/this.gamepadMoveSensibility:0);let i=this.gamepad.rightStick;i&&0!==this.gamepadAngularSensibility?(i.x=Math.abs(i.x)>this.deadzoneDelta?i.x/this.gamepadAngularSensibility:0,i.y=(Math.abs(i.y)>this.deadzoneDelta?i.y/this.gamepadAngularSensibility:0)*this._yAxisScale):i={x:0,y:0},e.rotationQuaternion?e.rotationQuaternion.toRotationMatrix(this._cameraTransform):n.uq.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,this._cameraTransform);const r=50*e._computeLocalCameraSpeed();this._vector3.copyFromFloats(t.x*r,0,-t.y*r),n.Pq.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),e.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(i.y,i.x),e.cameraRotation.addInPlace(this._vector2)}}getClassName(){return"FreeCameraGamepadInput"}getSimpleName(){return"gamepad"}}(0,Ge.Cg)([(0,ze.lK)()],ii.prototype,"gamepadAngularSensibility",void 0),(0,Ge.Cg)([(0,ze.lK)()],ii.prototype,"gamepadMoveSensibility",void 0),Lt.H.FreeCameraGamepadInput=ii;var ri,si=i(23102),ni=i(12901),oi=i(11984),ai=i(5305),li=i(87216);!function(e){e[e.X=0]="X",e[e.Y=1]="Y",e[e.Z=2]="Z"}(ri||(ri={}));class hi{static _GetDefaultOptions(){return{puckSize:40,containerSize:60,color:"cyan",puckImage:void 0,containerImage:void 0,position:void 0,alwaysVisible:!1,limitToContainer:!1}}constructor(e,t){this._released=!1;const i={...hi._GetDefaultOptions(),...t};if(this._leftJoystick=!!e,hi._GlobalJoystickIndex++,this._axisTargetedByLeftAndRight=0,this._axisTargetedByUpAndDown=1,this.reverseLeftRight=!1,this.reverseUpDown=!1,this._touches=new li.w,this.deltaPosition=n.Pq.Zero(),this._joystickSensibility=25,this._inversedSensibility=1/(this._joystickSensibility/1e3),this._onResize=()=>{hi._VJCanvasWidth=window.innerWidth,hi._VJCanvasHeight=window.innerHeight,hi.Canvas&&(hi.Canvas.width=hi._VJCanvasWidth,hi.Canvas.height=hi._VJCanvasHeight),hi._HalfWidth=hi._VJCanvasWidth/2},!hi.Canvas){window.addEventListener("resize",this._onResize,!1),hi.Canvas=document.createElement("canvas"),hi._VJCanvasWidth=window.innerWidth,hi._VJCanvasHeight=window.innerHeight,hi.Canvas.width=window.innerWidth,hi.Canvas.height=window.innerHeight,hi.Canvas.style.width="100%",hi.Canvas.style.height="100%",hi.Canvas.style.position="absolute",hi.Canvas.style.backgroundColor="transparent",hi.Canvas.style.top="0px",hi.Canvas.style.left="0px",hi.Canvas.style.zIndex="5",hi.Canvas.style.touchAction="none",hi.Canvas.setAttribute("touch-action","none");const e=hi.Canvas.getContext("2d");if(!e)throw new Error("Unable to create canvas for virtual joystick");hi._VJCanvasContext=e,hi._VJCanvasContext.strokeStyle="#ffffff",hi._VJCanvasContext.lineWidth=2,document.body.appendChild(hi.Canvas)}hi._HalfWidth=hi.Canvas.width/2,this.pressed=!1,this.limitToContainer=i.limitToContainer,this._joystickColor=i.color,this.containerSize=i.containerSize,this.puckSize=i.puckSize,i.position&&this.setPosition(i.position.x,i.position.y),i.puckImage&&this.setPuckImage(i.puckImage),i.containerImage&&this.setContainerImage(i.containerImage),i.alwaysVisible&&hi._AlwaysVisibleSticks++,this.alwaysVisible=i.alwaysVisible,this._joystickPointerId=-1,this._joystickPointerPos=new n.I9(0,0),this._joystickPreviousPointerPos=new n.I9(0,0),this._joystickPointerStartPos=new n.I9(0,0),this._deltaJoystickVector=new n.I9(0,0),this._onPointerDownHandlerRef=e=>{this._onPointerDown(e)},this._onPointerMoveHandlerRef=e=>{this._onPointerMove(e)},this._onPointerUpHandlerRef=e=>{this._onPointerUp(e)},hi.Canvas.addEventListener("pointerdown",this._onPointerDownHandlerRef,!1),hi.Canvas.addEventListener("pointermove",this._onPointerMoveHandlerRef,!1),hi.Canvas.addEventListener("pointerup",this._onPointerUpHandlerRef,!1),hi.Canvas.addEventListener("pointerout",this._onPointerUpHandlerRef,!1),hi.Canvas.addEventListener("pointercancel",this._onPointerUpHandlerRef,!1),hi.Canvas.addEventListener("contextmenu",(e=>{e.preventDefault()}),!1),requestAnimationFrame((()=>{this._drawVirtualJoystick()}))}setJoystickSensibility(e){this._joystickSensibility=e,this._inversedSensibility=1/(this._joystickSensibility/1e3)}_onPointerDown(e){let t;e.preventDefault(),t=!0===this._leftJoystick?e.clientX<hi._HalfWidth:e.clientX>hi._HalfWidth,t&&this._joystickPointerId<0?(this._joystickPointerId=e.pointerId,this._joystickPosition?(this._joystickPointerStartPos=this._joystickPosition.clone(),this._joystickPointerPos=this._joystickPosition.clone(),this._joystickPreviousPointerPos=this._joystickPosition.clone(),this._onPointerMove(e)):(this._joystickPointerStartPos.x=e.clientX,this._joystickPointerStartPos.y=e.clientY,this._joystickPointerPos=this._joystickPointerStartPos.clone(),this._joystickPreviousPointerPos=this._joystickPointerStartPos.clone()),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this.pressed=!0,this._touches.add(e.pointerId.toString(),e)):hi._GlobalJoystickIndex<2&&this._action&&(this._action(),this._touches.add(e.pointerId.toString(),{x:e.clientX,y:e.clientY,prevX:e.clientX,prevY:e.clientY}))}_onPointerMove(e){if(this._joystickPointerId==e.pointerId){if(this.limitToContainer){const t=new n.I9(e.clientX-this._joystickPointerStartPos.x,e.clientY-this._joystickPointerStartPos.y),i=t.length();i>this.containerSize&&t.scaleInPlace(this.containerSize/i),this._joystickPointerPos.x=this._joystickPointerStartPos.x+t.x,this._joystickPointerPos.y=this._joystickPointerStartPos.y+t.y}else this._joystickPointerPos.x=e.clientX,this._joystickPointerPos.y=e.clientY;this._deltaJoystickVector=this._joystickPointerPos.clone(),this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos),0<hi._AlwaysVisibleSticks&&(this._leftJoystick?this._joystickPointerPos.x=Math.min(hi._HalfWidth,this._joystickPointerPos.x):this._joystickPointerPos.x=Math.max(hi._HalfWidth,this._joystickPointerPos.x));const t=(this.reverseLeftRight?-1:1)*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case 0:this.deltaPosition.x=Math.min(1,Math.max(-1,t));break;case 1:this.deltaPosition.y=Math.min(1,Math.max(-1,t));break;case 2:this.deltaPosition.z=Math.min(1,Math.max(-1,t))}const i=(this.reverseUpDown?1:-1)*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case 0:this.deltaPosition.x=Math.min(1,Math.max(-1,i));break;case 1:this.deltaPosition.y=Math.min(1,Math.max(-1,i));break;case 2:this.deltaPosition.z=Math.min(1,Math.max(-1,i))}}else{const t=this._touches.get(e.pointerId.toString());t&&(t.x=e.clientX,t.y=e.clientY)}}_onPointerUp(e){if(this._joystickPointerId==e.pointerId)this._clearPreviousDraw(),this._joystickPointerId=-1,this.pressed=!1;else{const t=this._touches.get(e.pointerId.toString());t&&hi._VJCanvasContext.clearRect(t.prevX-44,t.prevY-44,88,88)}this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this._touches.remove(e.pointerId.toString())}setJoystickColor(e){this._joystickColor=e}set containerSize(e){this._joystickContainerSize=e,this._clearContainerSize=~~(2.1*this._joystickContainerSize),this._clearContainerSizeOffset=~~(this._clearContainerSize/2)}get containerSize(){return this._joystickContainerSize}set puckSize(e){this._joystickPuckSize=e,this._clearPuckSize=~~(2.1*this._joystickPuckSize),this._clearPuckSizeOffset=~~(this._clearPuckSize/2)}get puckSize(){return this._joystickPuckSize}clearPosition(){this.alwaysVisible=!1,this._joystickPosition=null}set alwaysVisible(e){this._alwaysVisible!==e&&(e&&this._joystickPosition?(hi._AlwaysVisibleSticks++,this._alwaysVisible=!0):(hi._AlwaysVisibleSticks--,this._alwaysVisible=!1))}get alwaysVisible(){return this._alwaysVisible}setPosition(e,t){this._joystickPointerStartPos&&this._clearPreviousDraw(),this._joystickPosition=new n.I9(e,t)}setActionOnTouch(e){this._action=e}setAxisForLeftRight(e){switch(e){case 0:case 1:case 2:this._axisTargetedByLeftAndRight=e;break;default:this._axisTargetedByLeftAndRight=0}}setAxisForUpDown(e){switch(e){case 0:case 1:case 2:this._axisTargetedByUpAndDown=e;break;default:this._axisTargetedByUpAndDown=1}}_clearPreviousDraw(){const e=this._joystickPosition||this._joystickPointerStartPos;hi._VJCanvasContext.clearRect(e.x-this._clearContainerSizeOffset,e.y-this._clearContainerSizeOffset,this._clearContainerSize,this._clearContainerSize),hi._VJCanvasContext.clearRect(this._joystickPreviousPointerPos.x-this._clearPuckSizeOffset-1,this._joystickPreviousPointerPos.y-this._clearPuckSizeOffset-1,this._clearPuckSize+2,this._clearPuckSize+2)}setContainerImage(e){const t=new Image;t.src=e,t.onload=()=>this._containerImage=t}setPuckImage(e){const t=new Image;t.src=e,t.onload=()=>this._puckImage=t}_drawContainer(){const e=this._joystickPosition||this._joystickPointerStartPos;this._clearPreviousDraw(),this._containerImage?hi._VJCanvasContext.drawImage(this._containerImage,e.x-this.containerSize,e.y-this.containerSize,2*this.containerSize,2*this.containerSize):(hi._VJCanvasContext.beginPath(),hi._VJCanvasContext.strokeStyle=this._joystickColor,hi._VJCanvasContext.lineWidth=2,hi._VJCanvasContext.arc(e.x,e.y,this.containerSize,0,2*Math.PI,!0),hi._VJCanvasContext.stroke(),hi._VJCanvasContext.closePath(),hi._VJCanvasContext.beginPath(),hi._VJCanvasContext.lineWidth=6,hi._VJCanvasContext.strokeStyle=this._joystickColor,hi._VJCanvasContext.arc(e.x,e.y,this.puckSize,0,2*Math.PI,!0),hi._VJCanvasContext.stroke(),hi._VJCanvasContext.closePath())}_drawPuck(){this._puckImage?hi._VJCanvasContext.drawImage(this._puckImage,this._joystickPointerPos.x-this.puckSize,this._joystickPointerPos.y-this.puckSize,2*this.puckSize,2*this.puckSize):(hi._VJCanvasContext.beginPath(),hi._VJCanvasContext.strokeStyle=this._joystickColor,hi._VJCanvasContext.lineWidth=2,hi._VJCanvasContext.arc(this._joystickPointerPos.x,this._joystickPointerPos.y,this.puckSize,0,2*Math.PI,!0),hi._VJCanvasContext.stroke(),hi._VJCanvasContext.closePath())}_drawVirtualJoystick(){this._released||(this.alwaysVisible&&this._drawContainer(),this.pressed&&this._touches.forEach(((e,t)=>{t.pointerId===this._joystickPointerId?(this.alwaysVisible||this._drawContainer(),this._drawPuck(),this._joystickPreviousPointerPos=this._joystickPointerPos.clone()):(hi._VJCanvasContext.clearRect(t.prevX-44,t.prevY-44,88,88),hi._VJCanvasContext.beginPath(),hi._VJCanvasContext.fillStyle="white",hi._VJCanvasContext.beginPath(),hi._VJCanvasContext.strokeStyle="red",hi._VJCanvasContext.lineWidth=6,hi._VJCanvasContext.arc(t.x,t.y,40,0,2*Math.PI,!0),hi._VJCanvasContext.stroke(),hi._VJCanvasContext.closePath(),t.prevX=t.x,t.prevY=t.y)})),requestAnimationFrame((()=>{this._drawVirtualJoystick()})))}releaseCanvas(){hi.Canvas&&(hi.Canvas.removeEventListener("pointerdown",this._onPointerDownHandlerRef),hi.Canvas.removeEventListener("pointermove",this._onPointerMoveHandlerRef),hi.Canvas.removeEventListener("pointerup",this._onPointerUpHandlerRef),hi.Canvas.removeEventListener("pointerout",this._onPointerUpHandlerRef),hi.Canvas.removeEventListener("pointercancel",this._onPointerUpHandlerRef),window.removeEventListener("resize",this._onResize),document.body.removeChild(hi.Canvas),hi.Canvas=null),this._released=!0}}hi._GlobalJoystickIndex=0,hi._AlwaysVisibleSticks=0,ei.s.prototype.addVirtualJoystick=function(){return this.add(new ci),this};class ci{getLeftJoystick(){return this._leftjoystick}getRightJoystick(){return this._rightjoystick}checkInputs(){if(this._leftjoystick){const e=this.camera,t=50*e._computeLocalCameraSpeed(),i=n.uq.RotationYawPitchRoll(e.rotation.y,e.rotation.x,0),r=n.Pq.TransformCoordinates(new n.Pq(this._leftjoystick.deltaPosition.x*t,this._leftjoystick.deltaPosition.y*t,this._leftjoystick.deltaPosition.z*t),i);e.cameraDirection=e.cameraDirection.add(r),e.cameraRotation=e.cameraRotation.addVector3(this._rightjoystick.deltaPosition),this._leftjoystick.pressed||(this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)),this._rightjoystick.pressed||(this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9))}}attachControl(){this._leftjoystick=new hi(!0),this._leftjoystick.setAxisForUpDown(2),this._leftjoystick.setAxisForLeftRight(0),this._leftjoystick.setJoystickSensibility(.15),this._rightjoystick=new hi(!1),this._rightjoystick.setAxisForUpDown(0),this._rightjoystick.setAxisForLeftRight(1),this._rightjoystick.reverseUpDown=!0,this._rightjoystick.setJoystickSensibility(.05),this._rightjoystick.setJoystickColor("yellow")}detachControl(){this._leftjoystick.releaseCanvas(),this._rightjoystick.releaseCanvas()}getClassName(){return"FreeCameraVirtualJoystickInput"}getSimpleName(){return"virtualJoystick"}}Lt.H.FreeCameraVirtualJoystickInput=ci;var ui=i(12333),di=i(11710),pi=i(4870);pi.b.AddNodeConstructor("TouchCamera",((e,t)=>()=>new mi(e,n.Pq.Zero(),t)));class mi extends di.S{get touchAngularSensibility(){const e=this.inputs.attached.touch;return e?e.touchAngularSensibility:0}set touchAngularSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchAngularSensibility=e)}get touchMoveSensibility(){const e=this.inputs.attached.touch;return e?e.touchMoveSensibility:0}set touchMoveSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addTouch(),this._setupInputs()}getClassName(){return"TouchCamera"}_setupInputs(){const e=this.inputs.attached.touch,t=this.inputs.attached.mouse;t?t.touchEnabled=!e:e.allowMouse=!t}}var fi=i(7839);pi.b.AddNodeConstructor("DeviceOrientationCamera",((e,t)=>()=>new _i(e,n.Pq.Zero(),t)));class _i extends di.S{constructor(e,t,i){super(e,t,i),this._tmpDragQuaternion=new n.PT,this._disablePointerInputWhenUsingDeviceOrientation=!0,this._dragFactor=0,this._quaternionCache=new n.PT,this.inputs.addDeviceOrientation(),this.inputs._deviceOrientationInput&&this.inputs._deviceOrientationInput._onDeviceOrientationChangedObservable.addOnce((()=>{this._disablePointerInputWhenUsingDeviceOrientation&&this.inputs._mouseInput&&(this.inputs._mouseInput._allowCameraRotation=!1,this.inputs._mouseInput.onPointerMovedObservable.add((e=>{0!=this._dragFactor&&(this._initialQuaternion||(this._initialQuaternion=new n.PT),n.PT.FromEulerAnglesToRef(0,e.offsetX*this._dragFactor,0,this._tmpDragQuaternion),this._initialQuaternion.multiplyToRef(this._tmpDragQuaternion,this._initialQuaternion))})))}))}get disablePointerInputWhenUsingDeviceOrientation(){return this._disablePointerInputWhenUsingDeviceOrientation}set disablePointerInputWhenUsingDeviceOrientation(e){this._disablePointerInputWhenUsingDeviceOrientation=e}enableHorizontalDragging(e=1/300){this._dragFactor=e}getClassName(){return"DeviceOrientationCamera"}_checkInputs(){super._checkInputs(),this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}resetToCurrentRotation(e=Mt._0.Y){this.rotationQuaternion&&(this._initialQuaternion||(this._initialQuaternion=new n.PT),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion),["x","y","z"].forEach((t=>{e[t]?this._initialQuaternion[t]*=-1:this._initialQuaternion[t]=0})),this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))}}class gi extends Lt._{constructor(e){super(e)}addKeyboard(){return this.add(new jt),this}addMouse(){return this.add(new Zt),this}}class xi extends ui.F{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysForward(){const e=this.inputs.attached.keyboard;return e?e.keysForward:[]}set keysForward(e){const t=this.inputs.attached.keyboard;t&&(t.keysForward=e)}get keysBackward(){const e=this.inputs.attached.keyboard;return e?e.keysBackward:[]}set keysBackward(e){const t=this.inputs.attached.keyboard;t&&(t.keysBackward=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}constructor(e,t,i,r=!0){super(e,t,i,r),this.ellipsoid=new n.Pq(1,1,1),this.ellipsoidOffset=new n.Pq(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this.cameraDirection=n.Pq.Zero(),this._trackRoll=0,this.rollCorrect=100,this.bankedTurn=!1,this.bankedTurnLimit=Math.PI/2,this.bankedTurnMultiplier=1,this._needMoveForGravity=!1,this._oldPosition=n.Pq.Zero(),this._diffPosition=n.Pq.Zero(),this._newPosition=n.Pq.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(e,t,i=null)=>{(e=>{this._newPosition.copyFrom(e),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>$.$.CollisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&i&&this.onCollide(i))})(t)},this.inputs=new gi(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=H.S0.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new n.Pq(0,0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;t=this.parent?n.Pq.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let r=e;this.applyGravity&&(r=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,r,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=n.Pq.Zero(),this._transformedDirection=n.Pq.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}restoreRoll(e){const t=this._trackRoll,i=t-this.rotation.z;Math.abs(i)>=.001&&(this.rotation.z+=i/e,Math.abs(t-this.rotation.z)<=.001&&(this.rotation.z=t))}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FlyCamera"}}(0,Ge.Cg)([(0,ze.P_)()],xi.prototype,"ellipsoid",void 0),(0,Ge.Cg)([(0,ze.P_)()],xi.prototype,"ellipsoidOffset",void 0),(0,Ge.Cg)([(0,ze.lK)()],xi.prototype,"checkCollisions",void 0),(0,Ge.Cg)([(0,ze.lK)()],xi.prototype,"applyGravity",void 0),(0,a.Y5)("BABYLON.FlyCamera",xi);class vi extends Lt._{constructor(e){super(e)}addKeyboard(){return this.add(new Qt),this}addMouseWheel(){return this.add(new Kt),this}addPointers(){return this.add(new Jt),this}addVRDeviceOrientation(){return m.V.Warn("DeviceOrientation support not yet implemented for FollowCamera."),this}}pi.b.AddNodeConstructor("FollowCamera",((e,t)=>()=>new Si(e,n.Pq.Zero(),t))),pi.b.AddNodeConstructor("ArcFollowCamera",((e,t)=>()=>new bi(e,0,0,1,null,t)));class Si extends ui.F{constructor(e,t,i,r=null){super(e,t,i),this.radius=12,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.rotationOffset=0,this.lowerRotationOffsetLimit=null,this.upperRotationOffsetLimit=null,this.heightOffset=4,this.lowerHeightOffsetLimit=null,this.upperHeightOffsetLimit=null,this.cameraAcceleration=.05,this.maxCameraSpeed=20,this.lockedTarget=r,this.inputs=new vi(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_follow(e){if(!e)return;const t=n.AA.Matrix[0];e.absoluteRotationQuaternion.toRotationMatrix(t);const i=Math.atan2(t.m[8],t.m[10]),r=H.S0.ToRadians(this.rotationOffset)+i,s=e.getAbsolutePosition(),o=s.x+Math.sin(r)*this.radius,a=s.z+Math.cos(r)*this.radius,l=o-this.position.x,h=s.y+this.heightOffset-this.position.y,c=a-this.position.z;let u=l*this.cameraAcceleration*2,d=h*this.cameraAcceleration,p=c*this.cameraAcceleration*2;(u>this.maxCameraSpeed||u<-this.maxCameraSpeed)&&(u=u<1?-this.maxCameraSpeed:this.maxCameraSpeed),(d>this.maxCameraSpeed||d<-this.maxCameraSpeed)&&(d=d<1?-this.maxCameraSpeed:this.maxCameraSpeed),(p>this.maxCameraSpeed||p<-this.maxCameraSpeed)&&(p=p<1?-this.maxCameraSpeed:this.maxCameraSpeed),this.position=new n.Pq(this.position.x+u,this.position.y+d,this.position.z+p),this.setTarget(s)}attachControl(e,t){t=H.S0.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t),this._reset=()=>{}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){this.inputs.checkInputs(),this._checkLimits(),super._checkInputs(),this.lockedTarget&&this._follow(this.lockedTarget)}_checkLimits(){null!==this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit),null!==this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit),null!==this.lowerHeightOffsetLimit&&this.heightOffset<this.lowerHeightOffsetLimit&&(this.heightOffset=this.lowerHeightOffsetLimit),null!==this.upperHeightOffsetLimit&&this.heightOffset>this.upperHeightOffsetLimit&&(this.heightOffset=this.upperHeightOffsetLimit),null!==this.lowerRotationOffsetLimit&&this.rotationOffset<this.lowerRotationOffsetLimit&&(this.rotationOffset=this.lowerRotationOffsetLimit),null!==this.upperRotationOffsetLimit&&this.rotationOffset>this.upperRotationOffsetLimit&&(this.rotationOffset=this.upperRotationOffsetLimit)}getClassName(){return"FollowCamera"}}(0,Ge.Cg)([(0,ze.lK)()],Si.prototype,"radius",void 0),(0,Ge.Cg)([(0,ze.lK)()],Si.prototype,"lowerRadiusLimit",void 0),(0,Ge.Cg)([(0,ze.lK)()],Si.prototype,"upperRadiusLimit",void 0),(0,Ge.Cg)([(0,ze.lK)()],Si.prototype,"rotationOffset",void 0),(0,Ge.Cg)([(0,ze.lK)()],Si.prototype,"lowerRotationOffsetLimit",void 0),(0,Ge.Cg)([(0,ze.lK)()],Si.prototype,"upperRotationOffsetLimit",void 0),(0,Ge.Cg)([(0,ze.lK)()],Si.prototype,"heightOffset",void 0),(0,Ge.Cg)([(0,ze.lK)()],Si.prototype,"lowerHeightOffsetLimit",void 0),(0,Ge.Cg)([(0,ze.lK)()],Si.prototype,"upperHeightOffsetLimit",void 0),(0,Ge.Cg)([(0,ze.lK)()],Si.prototype,"cameraAcceleration",void 0),(0,Ge.Cg)([(0,ze.lK)()],Si.prototype,"maxCameraSpeed",void 0),(0,Ge.Cg)([(0,ze.xG)("lockedTargetId")],Si.prototype,"lockedTarget",void 0);class bi extends ui.F{constructor(e,t,i,r,s,o){super(e,n.Pq.Zero(),o),this.alpha=t,this.beta=i,this.radius=r,this._cartesianCoordinates=n.Pq.Zero(),this.setMeshTarget(s)}setMeshTarget(e){this._meshTarget=e,this._follow()}_follow(){if(!this._meshTarget)return;this._cartesianCoordinates.x=this.radius*Math.cos(this.alpha)*Math.cos(this.beta),this._cartesianCoordinates.y=this.radius*Math.sin(this.beta),this._cartesianCoordinates.z=this.radius*Math.sin(this.alpha)*Math.cos(this.beta);const e=this._meshTarget.getAbsolutePosition();this.position=e.add(this._cartesianCoordinates),this.setTarget(e)}_checkInputs(){super._checkInputs(),this._follow()}getClassName(){return"ArcFollowCamera"}}(0,a.Y5)("BABYLON.FollowCamera",Si),(0,a.Y5)("BABYLON.ArcFollowCamera",bi);var yi,Pi,Ti,Ci,Ei=i(16945),Ai=i(18790);!function(e){e[e.A=0]="A",e[e.B=1]="B",e[e.X=2]="X",e[e.Y=3]="Y",e[e.LB=4]="LB",e[e.RB=5]="RB",e[e.Back=8]="Back",e[e.Start=9]="Start",e[e.LeftStick=10]="LeftStick",e[e.RightStick=11]="RightStick"}(yi||(yi={})),function(e){e[e.Up=12]="Up",e[e.Down=13]="Down",e[e.Left=14]="Left",e[e.Right=15]="Right"}(Pi||(Pi={}));class Ii extends Gt{constructor(e,t,i,r=!1){super(e,t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new s.cP,this.onButtonUpObservable=new s.cP,this.onPadDownObservable=new s.cP,this.onPadUpObservable=new s.cP,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLB=0,this._buttonRB=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this._isXboxOnePad=!1,this.type=Gt.XBOX,this._isXboxOnePad=r}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(1===e&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),0===e&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonA(){return this._buttonA}set buttonA(e){this._buttonA=this._setButtonValue(e,this._buttonA,0)}get buttonB(){return this._buttonB}set buttonB(e){this._buttonB=this._setButtonValue(e,this._buttonB,1)}get buttonX(){return this._buttonX}set buttonX(e){this._buttonX=this._setButtonValue(e,this._buttonX,2)}get buttonY(){return this._buttonY}set buttonY(e){this._buttonY=this._setButtonValue(e,this._buttonY,3)}get buttonStart(){return this._buttonStart}set buttonStart(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,9)}get buttonBack(){return this._buttonBack}set buttonBack(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,8)}get buttonLB(){return this._buttonLB}set buttonLB(e){this._buttonLB=this._setButtonValue(e,this._buttonLB,4)}get buttonRB(){return this._buttonRB}set buttonRB(e){this._buttonRB=this._setButtonValue(e,this._buttonRB,5)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,10)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,11)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,12)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,13)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,14)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,15)}update(){super.update(),this._isXboxOnePad,this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}!function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.Share=8]="Share",e[e.Options=9]="Options",e[e.LeftStick=10]="LeftStick",e[e.RightStick=11]="RightStick"}(Ti||(Ti={})),function(e){e[e.Up=12]="Up",e[e.Down=13]="Down",e[e.Left=14]="Left",e[e.Right=15]="Right"}(Ci||(Ci={}));class Ri extends Gt{constructor(e,t,i){super(e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new s.cP,this.onButtonUpObservable=new s.cP,this.onPadDownObservable=new s.cP,this.onPadUpObservable=new s.cP,this._buttonCross=0,this._buttonCircle=0,this._buttonSquare=0,this._buttonTriangle=0,this._buttonShare=0,this._buttonOptions=0,this._buttonL1=0,this._buttonR1=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this.type=Gt.DUALSHOCK}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(1===e&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),0===e&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonCross(){return this._buttonCross}set buttonCross(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,0)}get buttonCircle(){return this._buttonCircle}set buttonCircle(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,1)}get buttonSquare(){return this._buttonSquare}set buttonSquare(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,2)}get buttonTriangle(){return this._buttonTriangle}set buttonTriangle(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,3)}get buttonOptions(){return this._buttonOptions}set buttonOptions(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,9)}get buttonShare(){return this._buttonShare}set buttonShare(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,8)}get buttonL1(){return this._buttonL1}set buttonL1(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,4)}get buttonR1(){return this._buttonR1}set buttonR1(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,5)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,10)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,11)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,12)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,13)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,14)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,15)}update(){super.update(),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}class Mi{constructor(e){if(this._scene=e,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new s.cP,(0,Ai.BA)()?(this._gamepadEventSupported="GamepadEvent"in window,this._gamepadSupport=navigator&&navigator.getGamepads):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new s.cP((e=>{for(const t in this._babylonGamepads){const i=this._babylonGamepads[t];i&&i._isConnected&&this.onGamepadConnectedObservable.notifyObserver(e,i)}})),this._onGamepadConnectedEvent=e=>{const t=e.gamepad;if(t.index in this._babylonGamepads&&this._babylonGamepads[t.index].isConnected)return;let i;this._babylonGamepads[t.index]?(i=this._babylonGamepads[t.index],i.browserGamepad=t,i._isConnected=!0):i=this._addNewGamepad(t),this.onGamepadConnectedObservable.notifyObservers(i),this._startMonitoringGamepads()},this._onGamepadDisconnectedEvent=e=>{const t=e.gamepad;for(const e in this._babylonGamepads)if(this._babylonGamepads[e].index===t.index){const t=this._babylonGamepads[e];t._isConnected=!1,this.onGamepadDisconnectedObservable.notifyObservers(t),t.dispose&&t.dispose();break}},this._gamepadSupport)if(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported){const e=this._scene?this._scene.getEngine().getHostWindow():window;e&&(e.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),e.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,!1))}else this._startMonitoringGamepads()}get gamepads(){return this._babylonGamepads}getGamepadByType(e=Gt.XBOX){for(const t of this._babylonGamepads)if(t&&t.type===e)return t;return null}dispose(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null),this._babylonGamepads.forEach((e=>{e.dispose()})),this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]}_addNewGamepad(e){let t;this._oneGamepadConnected||(this._oneGamepadConnected=!0);const i=-1!==e.id.search("054c")&&-1===e.id.search("0ce6"),r=-1!==e.id.search("Xbox One");return t=r||-1!==e.id.search("Xbox 360")||-1!==e.id.search("xinput")||-1!==e.id.search("045e")&&-1===e.id.search("Surface Dock")?new Ii(e.id,e.index,e,r):i?new Ri(e.id,e.index,e):new zt(e.id,e.index,e),this._babylonGamepads[t.index]=t,t}_startMonitoringGamepads(){this._isMonitoring||(this._isMonitoring=!0,this._checkGamepadsStatus())}_stopMonitoringGamepads(){this._isMonitoring=!1}_checkGamepadsStatus(){this._updateGamepadObjects();for(const e in this._babylonGamepads){const t=this._babylonGamepads[e];if(t&&t.isConnected)try{t.update()}catch{-1===this._loggedErrors.indexOf(t.index)&&(H.S0.Warn(`Error updating gamepad ${t.id}`),this._loggedErrors.push(t.index))}}this._isMonitoring&&$.$.QueueNewFrame((()=>{this._checkGamepadsStatus()}))}_updateGamepadObjects(){const e=navigator.getGamepads?navigator.getGamepads():[];for(let t=0;t<e.length;t++){const i=e[t];if(i)if(this._babylonGamepads[i.index])this._babylonGamepads[t].browserGamepad=i,this._babylonGamepads[t].isConnected||(this._babylonGamepads[t]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[t]));else{const e=this._addNewGamepad(i);this.onGamepadConnectedObservable.notifyObservers(e)}}}}Object.defineProperty(it.Z.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new Mi(this);let e=this._getComponent(Ei.v.NAME_GAMEPAD);e||(e=new Di(this),this._addComponent(e))}return this._gamepadManager},enumerable:!0,configurable:!0}),ei.s.prototype.addGamepad=function(){return this.add(new ii),this},qt.H.prototype.addGamepad=function(){return this.add(new Ut),this};class Di{constructor(e){this.name=Ei.v.NAME_GAMEPAD,this.scene=e}register(){}rebuild(){}dispose(){const e=this.scene._gamepadManager;e&&(e.dispose(),this.scene._gamepadManager=null)}}pi.b.AddNodeConstructor("FreeCamera",((e,t)=>()=>new Oi(e,n.Pq.Zero(),t)));class Oi extends mi{get gamepadAngularSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadAngularSensibility:0}set gamepadAngularSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadAngularSensibility=e)}get gamepadMoveSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadMoveSensibility:0}set gamepadMoveSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addGamepad()}getClassName(){return"UniversalCamera"}}ft.i._CreateDefaultParsedCamera=(e,t)=>new Oi(e,n.Pq.Zero(),t),pi.b.AddNodeConstructor("GamepadCamera",((e,t)=>()=>new Ni(e,n.Pq.Zero(),t)));class Ni extends Oi{constructor(e,t,i){super(e,t,i)}getClassName(){return"GamepadCamera"}}var wi=i(30580),Fi=i(77891),Bi=i(84255),Vi=i(93856);class Li extends Bi.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,91506)))):t.push(Promise.resolve().then(i.bind(i,69723)))}constructor(e,t=null,i){super({...i,name:e,engine:t||Vi.Engine.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Li.FragmentUrl,samplers:Li.Samplers})}}Li.FragmentUrl="anaglyph",Li.Samplers=["leftSampler"];class ki extends Fi.w{getClassName(){return"AnaglyphPostProcess"}constructor(e,t,i,r,s,n){const o={samplers:Li.Samplers,size:"number"==typeof t?t:void 0,camera:i[1],samplingMode:r,engine:s,reusable:n,...t};super(e,Li.FragmentUrl,{effectWrapper:"number"!=typeof t&&t.effectWrapper?void 0:new Li(e,s,o),...o}),this._passedProcess=i[0]._rigPostProcess,this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("leftSampler",this._passedProcess)}))}}function Gi(e){e._rigCameras[0]._rigPostProcess=new wi.v(e.name+"_passthru",1,e._rigCameras[0]),e._rigCameras[1]._rigPostProcess=new ki(e.name+"_anaglyph",1,e._rigCameras)}(0,a.Y5)("BABYLON.AnaglyphPostProcess",ki),pi.b.AddNodeConstructor("AnaglyphArcRotateCamera",((e,t,i)=>()=>new zi(e,0,0,1,n.Pq.Zero(),i.interaxial_distance,t)));class zi extends fi.Lq{constructor(e,t,i,r,s,n,o){super(e,t,i,r,s,o),this._setRigMode=()=>Gi(this),this.interaxialDistance=n,this.setCameraRigMode(ft.i.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:n})}getClassName(){return"AnaglyphArcRotateCamera"}}pi.b.AddNodeConstructor("AnaglyphFreeCamera",((e,t,i)=>()=>new Ui(e,n.Pq.Zero(),i.interaxial_distance,t)));class Ui extends di.S{constructor(e,t,i,r){super(e,t,r),this._setRigMode=()=>Gi(this),this.interaxialDistance=i,this.setCameraRigMode(ft.i.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphFreeCamera"}}pi.b.AddNodeConstructor("AnaglyphGamepadCamera",((e,t,i)=>()=>new Wi(e,n.Pq.Zero(),i.interaxial_distance,t)));class Wi extends Ni{constructor(e,t,i,r){super(e,t,r),this._setRigMode=()=>Gi(this),this.interaxialDistance=i,this.setCameraRigMode(ft.i.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphGamepadCamera"}}pi.b.AddNodeConstructor("AnaglyphUniversalCamera",((e,t,i)=>()=>new Hi(e,n.Pq.Zero(),i.interaxial_distance,t)));class Hi extends Oi{constructor(e,t,i,r){super(e,t,r),this._setRigMode=()=>Gi(this),this.interaxialDistance=i,this.setCameraRigMode(ft.i.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphUniversalCamera"}}var $i=i(54494),qi=i(69610);const Yi="stereoscopicInterlacePixelShader",Xi="const vec3 TWO=vec3(2.0,2.0,2.0);varying vec2 vUV;uniform sampler2D camASampler;uniform sampler2D textureSampler;uniform vec2 stepSize;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{bool useCamA;bool useCamB;vec2 texCoord1;vec2 texCoord2;vec3 frag1;vec3 frag2;\n#ifdef IS_STEREOSCOPIC_HORIZ\nuseCamB=vUV.x>0.5;useCamA=!useCamB;texCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);texCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);\n#else\n#ifdef IS_STEREOSCOPIC_INTERLACED\nfloat rowNum=floor(vUV.y/stepSize.y);useCamA=mod(rowNum,2.0)==1.0;useCamB=mod(rowNum,2.0)==0.0;texCoord1=vec2(vUV.x,vUV.y);texCoord2=vec2(vUV.x,vUV.y);\n#else\nuseCamB=vUV.y>0.5;useCamA=!useCamB;texCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);texCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);\n#endif\n#endif\nif (useCamB){frag1=texture2D(textureSampler,texCoord1).rgb;frag2=texture2D(textureSampler,texCoord2).rgb;}else if (useCamA){frag1=texture2D(camASampler ,texCoord1).rgb;frag2=texture2D(camASampler ,texCoord2).rgb;}else {discard;}\ngl_FragColor=vec4((frag1+frag2)/TWO,1.0);}\n";qi.l.ShadersStore[Yi]=Xi;class ji extends Fi.w{getClassName(){return"StereoscopicInterlacePostProcessI"}constructor(e,t,i,r,s,o,a){super(e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,t[1],s,o,a,r?"#define IS_STEREOSCOPIC_INTERLACED 1":i?"#define IS_STEREOSCOPIC_HORIZ 1":void 0),this._passedProcess=t[0]._rigPostProcess,this._stepSize=new n.I9(1/this.width,1/this.height),this.onSizeChangedObservable.add((()=>{this._stepSize=new n.I9(1/this.width,1/this.height)})),this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("camASampler",this._passedProcess),e.setFloat2("stepSize",this._stepSize.x,this._stepSize.y)}))}}class Zi extends Fi.w{getClassName(){return"StereoscopicInterlacePostProcess"}constructor(e,t,i,r,s,o){super(e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,t[1],r,s,o,i?"#define IS_STEREOSCOPIC_HORIZ 1":void 0),this._passedProcess=t[0]._rigPostProcess,this._stepSize=new n.I9(1/this.width,1/this.height),this.onSizeChangedObservable.add((()=>{this._stepSize=new n.I9(1/this.width,1/this.height)})),this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("camASampler",this._passedProcess),e.setFloat2("stepSize",this._stepSize.x,this._stepSize.y)}))}}function Qi(e){const t=e.cameraRigMode===ft.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL||e.cameraRigMode===ft.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED,i=e.cameraRigMode===ft.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED;e.cameraRigMode===ft.i.RIG_MODE_STEREOSCOPIC_INTERLACED?(e._rigCameras[0]._rigPostProcess=new wi.v(e.name+"_passthru",1,e._rigCameras[0]),e._rigCameras[1]._rigPostProcess=new ji(e.name+"_stereoInterlace",e._rigCameras,!1,!0)):(e._rigCameras[i?1:0].viewport=new $i.L(0,0,t?.5:1,t?1:.5),e._rigCameras[i?0:1].viewport=new $i.L(t?.5:0,t?0:.5,t?.5:1,t?1:.5))}pi.b.AddNodeConstructor("StereoscopicArcRotateCamera",((e,t,i)=>()=>new Ki(e,0,0,1,n.Pq.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t)));class Ki extends fi.Lq{constructor(e,t,i,r,s,n,o,a){super(e,t,i,r,s,a),this._setRigMode=()=>Qi(this),this.interaxialDistance=n,this.isStereoscopicSideBySide=o,this.setCameraRigMode(o?ft.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:ft.i.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:n})}getClassName(){return"StereoscopicArcRotateCamera"}}pi.b.AddNodeConstructor("StereoscopicFreeCamera",((e,t,i)=>()=>new Ji(e,n.Pq.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t)));class Ji extends di.S{constructor(e,t,i,r,s){super(e,t,s),this._setRigMode=()=>Qi(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?ft.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:ft.i.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicFreeCamera"}}pi.b.AddNodeConstructor("StereoscopicGamepadCamera",((e,t,i)=>()=>new er(e,n.Pq.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t)));class er extends Ni{constructor(e,t,i,r,s){super(e,t,s),this._setRigMode=()=>Qi(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?ft.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:ft.i.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicGamepadCamera"}}pi.b.AddNodeConstructor("StereoscopicFreeCamera",((e,t,i)=>()=>new tr(e,n.Pq.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t)));class tr extends Oi{constructor(e,t,i,r,s){super(e,t,s),this._setRigMode=()=>Qi(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?ft.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:ft.i.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicUniversalCamera"}}class ir extends Oi{set distanceBetweenEyes(e){this._distanceBetweenEyes=e}get distanceBetweenEyes(){return this._distanceBetweenEyes}set distanceToProjectionPlane(e){this._distanceToProjectionPlane=e}get distanceToProjectionPlane(){return this._distanceToProjectionPlane}constructor(e,t,i,r=1,s=.065){super(e,t,i),this._distanceBetweenEyes=s,this._distanceToProjectionPlane=r,this.setCameraRigMode(ft.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL,{stereoHalfAngle:0}),this._cameraRigParams.stereoHalfAngle=0,this._cameraRigParams.interaxialDistance=s}getClassName(){return"StereoscopicUniversalCamera"}createRigCamera(e){const t=new ui.F(e,n.Pq.Zero(),this.getScene()),i=new mt.V("tm_"+e,this.getScene());return t.parent=i,i.setPivotMatrix(n.uq.Identity(),!1),t.isRigCamera=!0,t.rigParent=this,t}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++){const t=this._rigCameras[e];t.minZ=this.minZ,t.maxZ=this.maxZ,t.fov=this.fov,t.upVector.copyFrom(this.upVector),t.rotationQuaternion?t.rotationQuaternion.copyFrom(this.rotationQuaternion):t.rotation.copyFrom(this.rotation),this._updateCamera(this._rigCameras[e],e)}}_updateCamera(e,t){const i=this.distanceBetweenEyes/2,r=i/this.distanceToProjectionPlane;e.position.copyFrom(this.position),e.position.addInPlaceFromFloats(0===t?-i:i,0,-this._distanceToProjectionPlane);const s=e.parent,n=s.getPivotMatrix();n.setTranslationFromFloats(0===t?i:-i,0,0),n.setRowFromFloats(2,0===t?r:-r,0,1,0),s.setPivotMatrix(n,!1)}_setRigMode(){this._rigCameras[0].viewport=new $i.L(0,0,.5,1),this._rigCameras[1].viewport=new $i.L(.5,0,.5,1);for(let e=0;e<this._rigCameras.length;e++)this._updateCamera(this._rigCameras[e],e)}}pi.b.AddNodeConstructor("VirtualJoysticksCamera",((e,t)=>()=>new rr(e,n.Pq.Zero(),t)));class rr extends di.S{constructor(e,t,i){super(e,t,i),this.inputs.addVirtualJoystick()}getClassName(){return"VirtualJoysticksCamera"}}class sr{constructor(){this.compensateDistortion=!0,this.multiviewEnabled=!1}get aspectRatio(){return this.hResolution/(2*this.vResolution)}get aspectRatioFov(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))}get leftHMatrix(){const e=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return n.uq.Translation(e,0,0)}get rightHMatrix(){const e=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return n.uq.Translation(-e,0,0)}get leftPreViewMatrix(){return n.uq.Translation(.5*this.interpupillaryDistance,0,0)}get rightPreViewMatrix(){return n.uq.Translation(-.5*this.interpupillaryDistance,0,0)}static GetDefault(){const e=new sr;return e.hResolution=1280,e.vResolution=800,e.hScreenSize=.149759993,e.vScreenSize=.0935999975,e.vScreenCenter=.0467999987,e.eyeToScreenDistance=.0410000011,e.lensSeparationDistance=.063500002,e.interpupillaryDistance=.064000003,e.distortionK=[1,.219999999,.239999995,0],e.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],e.postProcessScaleFactor=1.714605507808412,e.lensCenterOffset=.151976421,e}}class nr extends Fi.w{getClassName(){return"VRDistortionCorrectionPostProcess"}constructor(e,t,i,r){super(e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,r.postProcessScaleFactor,t,$e.g.BILINEAR_SAMPLINGMODE),this._isRightEye=i,this._distortionFactors=r.distortionK,this._postProcessScaleFactor=r.postProcessScaleFactor,this._lensCenterOffset=r.lensCenterOffset,this.adaptScaleToCurrentViewport=!0,this.onSizeChangedObservable.add((()=>{this._scaleIn=new n.I9(2,2/this.aspectRatio),this._scaleFactor=new n.I9(1/this._postProcessScaleFactor*.5,1/this._postProcessScaleFactor*.5*this.aspectRatio),this._lensCenter=new n.I9(this._isRightEye?.5-.5*this._lensCenterOffset:.5+.5*this._lensCenterOffset,.5)})),this.onApplyObservable.add((e=>{e.setFloat2("LensCenter",this._lensCenter.x,this._lensCenter.y),e.setFloat2("Scale",this._scaleFactor.x,this._scaleFactor.y),e.setFloat2("ScaleIn",this._scaleIn.x,this._scaleIn.y),e.setFloat4("HmdWarpParam",this._distortionFactors[0],this._distortionFactors[1],this._distortionFactors[2],this._distortionFactors[3])}))}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,57811)))):t.push(Promise.resolve().then(i.bind(i,21830))),super._gatherImports(e,t)}}const or="vrMultiviewToSingleviewPixelShader",ar="precision mediump sampler2DArray;varying vec2 vUV;uniform sampler2DArray multiviewSampler;uniform int imageIndex;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(multiviewSampler,vec3(vUV,imageIndex));}";qi.l.ShadersStore[or]=ar;var lr=i(81194),hr=i(80935),cr=i(75474);class ur extends cr.${set samples(e){this._samples=e}get samples(){return this._samples}constructor(e,t=512){super("multiview rtt",t,e,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0),this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight()),this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,this.samples=this._getEngine().getCaps().maxSamples||this.samples,this._texture.samples=this._samples}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindMultiviewFramebuffer(this._renderTarget)}getViewCount(){return 2}}var dr=i(22572);function pr(e,t){const i=new hr.D(e,void 0,!0,t);return i.addUniform("viewProjection",16),i.addUniform("viewProjectionR",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}Vi.Engine.prototype.createMultiviewRenderTargetTexture=function(e,t,i,r){const s=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";const n=this._createHardwareRenderTargetWrapper(!1,!1,{width:e,height:t});n._framebuffer=s.createFramebuffer();const o=new lr.h(this,0,!0);return o.width=e,o.height=t,o.isMultiview=!0,i||(i=s.createTexture(),s.bindTexture(s.TEXTURE_2D_ARRAY,i),s.texStorage3D(s.TEXTURE_2D_ARRAY,1,s.RGBA8,e,t,2)),n._colorTextureArray=i,r||(r=s.createTexture(),s.bindTexture(s.TEXTURE_2D_ARRAY,r),s.texStorage3D(s.TEXTURE_2D_ARRAY,1,s.DEPTH24_STENCIL8,e,t,2)),n._depthStencilTextureArray=r,o.isReady=!0,n.setTextures(o),n._depthStencilTexture=o,n},Vi.Engine.prototype.bindMultiviewFramebuffer=function(e){const t=e,i=this._gl,r=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(t,void 0,void 0,void 0,!0),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._framebuffer),!t._colorTextureArray||!t._depthStencilTextureArray)throw"Invalid multiview frame buffer";this.getCaps().oculusMultiview?(r.framebufferTextureMultisampleMultiviewOVR(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,t._colorTextureArray,0,t.samples,0,2),r.framebufferTextureMultisampleMultiviewOVR(i.DRAW_FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,t._depthStencilTextureArray,0,t.samples,0,2)):(r.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,t._colorTextureArray,0,0,2),r.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,t._depthStencilTextureArray,0,0,2))},Vi.Engine.prototype.bindSpaceWarpFramebuffer=function(e){const t=e,i=this._gl,r=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(t,void 0,void 0,void 0,!0),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._framebuffer),!t._colorTextureArray||!t._depthStencilTextureArray)throw new Error("Invalid Space Warp framebuffer");r.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,t._colorTextureArray,0,0,2),r.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.DEPTH_ATTACHMENT,t._depthStencilTextureArray,0,0,2)},ft.i.prototype._useMultiviewToSingleView=!1,ft.i.prototype._multiviewTexture=null,ft.i.prototype._resizeOrCreateMultiviewTexture=function(e,t){this._multiviewTexture?this._multiviewTexture.getRenderWidth()==e&&this._multiviewTexture.getRenderHeight()==t||(this._multiviewTexture.dispose(),this._multiviewTexture=new ur(this.getScene(),{width:e,height:t})):this._multiviewTexture=new ur(this.getScene(),{width:e,height:t})};const mr=it.Z.prototype.createSceneUniformBuffer;it.Z.prototype._transformMatrixR=n.uq.Zero(),it.Z.prototype._multiviewSceneUbo=null,it.Z.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=pr(this.getEngine(),"scene_multiview")},it.Z.prototype.createSceneUniformBuffer=function(e){return this._multiviewSceneUbo?pr(this.getEngine(),e):mr.bind(this)(e)},it.Z.prototype._updateMultiviewUbo=function(e,t){e&&t&&e.multiplyToRef(t,this._transformMatrixR),e&&t&&(e.multiplyToRef(t,n.AA.Matrix[0]),dr.P.GetRightPlaneToRef(n.AA.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))},it.Z.prototype._renderMultiviewToSingleView=function(e){e._resizeOrCreateMultiviewTexture(e._rigPostProcess&&e._rigPostProcess&&e._rigPostProcess.width>0?e._rigPostProcess.width:this.getEngine().getRenderWidth(!0),e._rigPostProcess&&e._rigPostProcess&&e._rigPostProcess.height>0?e._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),e.outputRenderTarget=e._multiviewTexture,this._renderForCamera(e),e.outputRenderTarget=null;for(let t=0;t<e._rigCameras.length;t++){const i=this.getEngine();this._activeCamera=e._rigCameras[t],i.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}};class fr extends Fi.w{getClassName(){return"VRMultiviewToSingleviewPostProcess"}constructor(e,t,i){super(e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],i,t,$e.g.BILINEAR_SAMPLINGMODE);const r=t??this.getCamera();this.onSizeChangedObservable.add((()=>{})),this.onApplyObservable.add((e=>{r._scene.activeCamera&&r._scene.activeCamera.isLeftCamera?e.setInt("imageIndex",0):e.setInt("imageIndex",1),e.setTexture("multiviewSampler",r._multiviewTexture)}))}}function _r(e,t){const i=t.vrCameraMetrics||sr.GetDefault();e._rigCameras[0]._cameraRigParams.vrMetrics=i,e._rigCameras[0].viewport=new $i.L(0,0,.5,1),e._rigCameras[0]._cameraRigParams.vrWorkMatrix=new n.uq,e._rigCameras[0]._cameraRigParams.vrHMatrix=i.leftHMatrix,e._rigCameras[0]._cameraRigParams.vrPreViewMatrix=i.leftPreViewMatrix,e._rigCameras[0].getProjectionMatrix=e._rigCameras[0]._getVRProjectionMatrix,e._rigCameras[1]._cameraRigParams.vrMetrics=i,e._rigCameras[1].viewport=new $i.L(.5,0,.5,1),e._rigCameras[1]._cameraRigParams.vrWorkMatrix=new n.uq,e._rigCameras[1]._cameraRigParams.vrHMatrix=i.rightHMatrix,e._rigCameras[1]._cameraRigParams.vrPreViewMatrix=i.rightPreViewMatrix,e._rigCameras[1].getProjectionMatrix=e._rigCameras[1]._getVRProjectionMatrix,i.multiviewEnabled&&(e.getScene().getEngine().getCaps().multiview?(e._useMultiviewToSingleView=!0,e._rigPostProcess=new fr("VRMultiviewToSingleview",e,i.postProcessScaleFactor)):(m.V.Warn("Multiview is not supported, falling back to standard rendering"),i.multiviewEnabled=!1)),i.compensateDistortion&&(e._rigCameras[0]._rigPostProcess=new nr("VR_Distort_Compensation_Left",e._rigCameras[0],!1,i),e._rigCameras[1]._rigPostProcess=new nr("VR_Distort_Compensation_Right",e._rigCameras[1],!0,i))}pi.b.AddNodeConstructor("VRDeviceOrientationArcRotateCamera",((e,t)=>()=>new gr(e,0,0,1,n.Pq.Zero(),t)));class gr extends fi.Lq{constructor(e,t,i,r,s,n,o=!0,a=sr.GetDefault()){super(e,t,i,r,s,n),this._setRigMode=e=>_r(this,e),a.compensateDistortion=o,this.setCameraRigMode(ft.i.RIG_MODE_VR,{vrCameraMetrics:a}),this.inputs.addVRDeviceOrientation()}getClassName(){return"VRDeviceOrientationArcRotateCamera"}}pi.b.AddNodeConstructor("VRDeviceOrientationFreeCamera",((e,t)=>()=>new xr(e,n.Pq.Zero(),t)));class xr extends _i{constructor(e,t,i,r=!0,s=sr.GetDefault()){super(e,t,i),this._setRigMode=e=>_r(this,e),s.compensateDistortion=r,this.setCameraRigMode(ft.i.RIG_MODE_VR,{vrCameraMetrics:s})}getClassName(){return"VRDeviceOrientationFreeCamera"}}pi.b.AddNodeConstructor("VRDeviceOrientationGamepadCamera",((e,t)=>()=>new vr(e,n.Pq.Zero(),t)));class vr extends xr{constructor(e,t,i,r=!0,s=sr.GetDefault()){super(e,t,i,r,s),this._setRigMode=e=>_r(this,e),this.inputs.addGamepad()}getClassName(){return"VRDeviceOrientationGamepadCamera"}}var Sr=i(32033),br=i(2093),yr=i(91597),Pr=i(86514);Pr.ThinEngine.prototype.createDynamicTexture=function(e,t,i,r){const s=new lr.h(this,4);return s.baseWidth=e,s.baseHeight=t,i&&(e=this.needPOTTextures?(0,yr.R)(e,this._caps.maxTextureSize):e,t=this.needPOTTextures?(0,yr.R)(t,this._caps.maxTextureSize):t),s.width=e,s.height=t,s.isReady=!1,s.generateMipMaps=i,s.samplingMode=r,this.updateTextureSamplingMode(r,s),this._internalTexturesCache.push(s),s},Pr.ThinEngine.prototype.updateDynamicTexture=function(e,t,i,r=!1,s,n=!1,o=!1){if(!e)return;const a=this._gl,l=a.TEXTURE_2D,h=this._bindTextureDirectly(l,e,!0,n);this._unpackFlipY(void 0===i?e.invertY:i),r&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);const c=this._getWebGLTextureType(e.type),u=this._getInternalFormat(s||e.format),d=this._getRGBABufferInternalSizedFormat(e.type,u);a.texImage2D(l,0,d,u,c,t),e.generateMipMaps&&a.generateMipmap(l),h||this._bindTextureDirectly(l,null),r&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),s&&(e.format=s),e._dynamicTextureSource=t,e._premulAlpha=r,e.invertY=i||!1,e.isReady=!0};class Tr extends $e.g{constructor(e,t,i,r=!1,s=3,n=5,o){const a=!i||i._isScene;super(null,a?i:i?.scene,a?!r:i,o,s,void 0,void 0,void 0,void 0,n),this.name=e,this.wrapU=$e.g.CLAMP_ADDRESSMODE,this.wrapV=$e.g.CLAMP_ADDRESSMODE,this._generateMipMaps=r;const l=this._getEngine();if(!l)return;if(t.getContext)this._canvas=t,this._ownCanvas=!1,this._texture=l.createDynamicTexture(this._canvas.width,this._canvas.height,r,s);else{this._canvas=l.createCanvas(1,1),this._ownCanvas=!0;const e=t;e.width||0===e.width?this._texture=l.createDynamicTexture(e.width,e.height,r,s):this._texture=l.createDynamicTexture(t,t,r,s)}const h=this.getSize();this._canvas.width!==h.width&&(this._canvas.width=h.width),this._canvas.height!==h.height&&(this._canvas.height=h.height),this._context=this._canvas.getContext("2d")}getClassName(){return"DynamicTexture"}get canRescale(){return!0}_recreate(e){this._canvas.width=e.width,this._canvas.height=e.height,this.releaseInternalTexture(),this._texture=this._getEngine().createDynamicTexture(e.width,e.height,this._generateMipMaps,this.samplingMode)}scale(e){const t=this.getSize();t.width*=e,t.height*=e,this._recreate(t)}scaleTo(e,t){const i=this.getSize();i.width=e,i.height=t,this._recreate(i)}getContext(){return this._context}clear(e){const t=this.getSize();e&&(this._context.fillStyle=e),this._context.clearRect(0,0,t.width,t.height)}update(e,t=!1,i=!1){this._getEngine().updateDynamicTexture(this._texture,this._canvas,void 0===e||e,t,this._format||void 0,void 0,i)}drawText(e,t,i,r,s,n,o,a=!0){const l=this.getSize();if(n&&(this._context.fillStyle=n,this._context.fillRect(0,0,l.width,l.height)),this._context.font=r,null==t){const i=this._context.measureText(e);t=(l.width-i.width)/2}if(null==i){const e=parseInt(r.replace(/\D/g,""));i=l.height/2+e/3.65}this._context.fillStyle=s||"",this._context.fillText(e,t,i),a&&this.update(o)}dispose(){super.dispose(),this._ownCanvas&&this._canvas?.remove?.(),this._canvas=null,this._context=null}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new Tr(this.name,t,e,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.wrapU=this.wrapU,i.wrapV=this.wrapV,i}serialize(){const e=this.getScene();e&&!e.isReady()&&m.V.Warn("The scene must be ready before serializing the dynamic texture");const t=super.serialize();return Tr._IsCanvasElement(this._canvas)&&(t.base64String=this._canvas.toDataURL()),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t}static _IsCanvasElement(e){return void 0!==e.toDataURL}_rebuild(){this.update()}}class Cr{get isFixedFoveationSupported(){return"XRWebGLLayer"==this.layerType&&"number"==typeof this.layer.fixedFoveation}get fixedFoveation(){return this.isFixedFoveationSupported?this.layer.fixedFoveation:null}set fixedFoveation(e){if(this.isFixedFoveationSupported){const t=Math.max(0,Math.min(1,e||0));this.layer.fixedFoveation=t}}createRenderTargetTextureProvider(e){return this._rttWrapper=this._createRenderTargetTextureProvider(e),this._rttWrapper}dispose(){this._rttWrapper&&(this._rttWrapper.dispose(),this._rttWrapper=null)}constructor(e,t,i,r,s){this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=r,this._createRenderTargetTextureProvider=s,this._rttWrapper=null}}var Er=i(67716);class Ar{constructor(e,t){this._scene=e,this.layerWrapper=t,this._renderTargetTextures=new Array,this._engine=e.getEngine()}_createInternalTexture(e,t){const i=new lr.h(this._engine,0,!0);return i.width=e.width,i.height=e.height,i._hardwareTexture=new Er.d(t,this._engine._gl),i.isReady=!0,i}_createRenderTargetTexture(e,t,i,r,s,n){if(!this._engine)throw new Error("Engine is disposed");const o={width:e,height:t},a=n?new ur(this._scene,o):new cr.$("XR renderTargetTexture",o,this._scene),l=a.renderTarget;if(l._samples=a.samples,!i&&r||(l._framebuffer=i),r)if(n)l._colorTextureArray=r;else{const e=this._createInternalTexture(o,r);l.setTexture(e,0),a._texture=e}return s&&(n?l._depthStencilTextureArray=s:l._depthStencilTexture=this._createInternalTexture(o,s)),a.disableRescaling(),this._renderTargetTextures.push(a),a}_destroyRenderTargetTexture(e){this._renderTargetTextures.splice(this._renderTargetTextures.indexOf(e),1),e.dispose()}getFramebufferDimensions(){return this._framebufferDimensions}dispose(){this._renderTargetTextures.forEach((e=>e.dispose())),this._renderTargetTextures.length=0}}class Ir extends Cr{constructor(e){super((()=>e.framebufferWidth),(()=>e.framebufferHeight),e,"XRWebGLLayer",(e=>new Rr(e.scene,this))),this.layer=e}}class Rr extends Ar{constructor(e,t){super(e,t),this.layerWrapper=t,this._layer=t.layer,this._framebufferDimensions={framebufferWidth:this._layer.framebufferWidth,framebufferHeight:this._layer.framebufferHeight}}trySetViewportForView(e,t){const i=this._layer.getViewport(t);if(!i)return!1;const r=this._framebufferDimensions.framebufferWidth,s=this._framebufferDimensions.framebufferHeight;return e.x=i.x/r,e.y=i.y/s,e.width=i.width/r,e.height=i.height/s,!0}getRenderTargetTextureForEye(e){const t=this._layer.framebufferWidth,i=this._layer.framebufferHeight,r=this._layer.framebuffer;return this._rtt&&t===this._framebufferDimensions.framebufferWidth&&i===this._framebufferDimensions.framebufferHeight&&r===this._framebuffer||(this._rtt=this._createRenderTargetTexture(t,i,r),this._framebufferDimensions.framebufferWidth=t,this._framebufferDimensions.framebufferHeight=i,this._framebuffer=r),this._rtt}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}}class Mr{static GetDefaults(e){const t=new Mr;return t.canvasOptions={antialias:!0,depth:!0,stencil:!e||e.isStencilEnable,alpha:!0,framebufferScaleFactor:1},t.newCanvasCssStyle="position:absolute; bottom:0px;right:0px;z-index:10;width:90%;height:100%;background-color: #000000;",t}}class Dr{constructor(e,t=Mr.GetDefaults()){if(this._options=t,this._canvas=null,this._engine=null,this.xrLayer=null,this._xrLayerWrapper=null,this.onXRLayerInitObservable=new s.cP,this._engine=e.scene.getEngine(),this._engine.onDisposeObservable.addOnce((()=>{this._engine=null})),t.canvasElement)this._setManagedOutputCanvas(t.canvasElement);else{const e=document.createElement("canvas");e.style.cssText=this._options.newCanvasCssStyle||"position:absolute; bottom:0px;right:0px;",this._setManagedOutputCanvas(e)}e.onXRSessionInit.add((()=>{this._addCanvas()})),e.onXRSessionEnded.add((()=>{this._removeCanvas()})),this._makeCanvasCompatibleAsync()}dispose(){this._removeCanvas(),this._setManagedOutputCanvas(null),this.onXRLayerInitObservable.clear()}_makeCanvasCompatibleAsync(){this._canvasCompatiblePromise=new Promise(((e,t)=>{try{this.canvasContext&&this.canvasContext.makeXRCompatible?this.canvasContext.makeXRCompatible().then((()=>{e()}),(()=>{H.S0.Warn("Error executing makeXRCompatible. This does not mean that the session will work incorrectly."),e()})):e()}catch(e){t(e)}}))}async initializeXRLayerAsync(e){const t=()=>(this.xrLayer=new XRWebGLLayer(e,this.canvasContext,this._options.canvasOptions),this._xrLayerWrapper=new Ir(this.xrLayer),this.onXRLayerInitObservable.notifyObservers(this.xrLayer),this.xrLayer);return this._canvasCompatiblePromise.then((()=>{}),(()=>{})).then((()=>t()))}_addCanvas(){this._canvas&&this._engine&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.appendChild(this._canvas),this.xrLayer?this._setCanvasSize(!0):this.onXRLayerInitObservable.addOnce((()=>{this._setCanvasSize(!0)}))}_removeCanvas(){this._canvas&&this._engine&&document.body.contains(this._canvas)&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.removeChild(this._canvas),this._setCanvasSize(!1)}_setCanvasSize(e=!0,t=this._xrLayerWrapper){this._canvas&&this._engine&&(e?t&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=t.getWidth()+"px",this._canvas.style.height=t.getHeight()+"px"):this._engine.setSize(t.getWidth(),t.getHeight())):this._originalCanvasSize&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=this._originalCanvasSize.width+"px",this._canvas.style.height=this._originalCanvasSize.height+"px"):this._engine.setSize(this._originalCanvasSize.width,this._originalCanvasSize.height)))}_setManagedOutputCanvas(e){this._removeCanvas(),e?(this._originalCanvasSize={width:e.offsetWidth,height:e.offsetHeight},this._canvas=e,this.canvasContext=this._canvas.getContext("webgl2"),this.canvasContext||(this.canvasContext=this._canvas.getContext("webgl"))):(this._canvas=null,this.canvasContext=null)}}class Or extends Cr{constructor(e){super((()=>e.framebufferWidth),(()=>e.framebufferHeight),e,"XRWebGLLayer",(e=>new Nr(e,this))),this.layer=e}}class Nr extends Ar{constructor(e,t){super(e.scene,t),this.layerWrapper=t,this._nativeRTTProvider=navigator.xr.getNativeRenderTargetProvider(e.session,this._createRenderTargetTexture.bind(this),this._destroyRenderTargetTexture.bind(this)),this._nativeLayer=t.layer}trySetViewportForView(e){return e.x=0,e.y=0,e.width=1,e.height=1,!0}getRenderTargetTextureForEye(e){return this._nativeRTTProvider.getRenderTargetForEye(e)}getRenderTargetTextureForView(e){return this._nativeRTTProvider.getRenderTargetForEye(e.eye)}getFramebufferDimensions(){return{framebufferWidth:this._nativeLayer.framebufferWidth,framebufferHeight:this._nativeLayer.framebufferHeight}}}class wr{constructor(e){this._nativeRenderTarget=navigator.xr.getWebXRRenderTarget(e.scene.getEngine())}async initializeXRLayerAsync(e){return await this._nativeRenderTarget.initializeXRLayerAsync(e),this.xrLayer=this._nativeRenderTarget.xrLayer,this.xrLayer}dispose(){}}class Fr{get worldScalingFactor(){return this._worldScalingFactor}set worldScalingFactor(e){const t=this._worldScalingFactor;this._worldScalingFactor=e,this.onWorldScaleFactorChangedObservable.notifyObservers({previousScaleFactor:t,newScaleFactor:e})}constructor(e){this.scene=e,this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this.onXRFrameObservable=new s.cP,this.onXRReferenceSpaceChanged=new s.cP,this.onXRSessionEnded=new s.cP,this.onXRSessionInit=new s.cP,this.onXRReferenceSpaceInitialized=new s.cP,this.onXRReady=new s.cP,this.inXRFrameLoop=!1,this.inXRSession=!1,this._worldScalingFactor=1,this.onWorldScaleFactorChangedObservable=new s.cP(void 0,!0),this._engine=e.getEngine(),this._onEngineDisposedObserver=this._engine.onDisposeObservable.addOnce((()=>{this._engine=null})),e.onDisposeObservable.addOnce((()=>{this.dispose()}))}get referenceSpace(){return this._referenceSpace}set referenceSpace(e){this._referenceSpace=e,this.onXRReferenceSpaceChanged.notifyObservers(this._referenceSpace)}get sessionMode(){return this._sessionMode}dispose(){this.inXRSession&&this.exitXRAsync(),this.onXRReady.clear(),this.onXRFrameObservable.clear(),this.onXRSessionEnded.clear(),this.onXRReferenceSpaceChanged.clear(),this.onXRSessionInit.clear(),this.onWorldScaleFactorChangedObservable.clear(),this._engine?.onDisposeObservable.remove(this._onEngineDisposedObserver),this._engine=null}async exitXRAsync(){if(this.session&&this.inXRSession){this.inXRSession=!1;try{return await this.session.end()}catch{m.V.Warn("Could not end XR session.")}}return Promise.resolve()}trySetViewportForView(e,t){return this._baseLayerRTTProvider?.trySetViewportForView(e,t)||!1}getRenderTargetTextureForEye(e){return this._baseLayerRTTProvider?.getRenderTargetTextureForEye(e)||null}getRenderTargetTextureForView(e){return this._baseLayerRTTProvider?.getRenderTargetTextureForView(e)||null}getWebXRRenderTarget(e){const t=this.scene.getEngine();return this._xrNavigator.xr.native?new wr(this):((e=e||Mr.GetDefaults(t)).canvasElement=e.canvasElement||t.getRenderingCanvas()||void 0,new Dr(this,e))}initializeAsync(){return this._xrNavigator=navigator,this._xrNavigator.xr?Promise.resolve():Promise.reject("WebXR not available")}initializeSessionAsync(e="immersive-vr",t={}){return this._xrNavigator.xr.requestSession(e,t).then((t=>(this.session=t,this._sessionMode=e,this.inXRSession=!0,this.onXRSessionInit.notifyObservers(t),this.session.addEventListener("end",(()=>{this.inXRSession=!1,this.onXRSessionEnded.notifyObservers(null),this._engine&&(this._engine.framebufferDimensionsObject=null,this._engine.restoreDefaultFramebuffer(),this._engine.customAnimationFrameRequester=null,this._engine._renderLoop()),this.isNative&&this._baseLayerRTTProvider?.dispose(),this._baseLayerRTTProvider=null,this._baseLayerWrapper=null}),{once:!0}),this.session)))}isSessionSupportedAsync(e){return Fr.IsSessionSupportedAsync(e)}resetReferenceSpace(){this.referenceSpace=this.baseReferenceSpace}runXRRenderLoop(){this.inXRSession&&this._engine&&(this._engine.customAnimationFrameRequester={requestAnimationFrame:e=>this.session.requestAnimationFrame(e),renderFunction:(e,t)=>{if(this.inXRSession&&this._engine&&(this.currentFrame=t,this.currentTimestamp=e,t)){this.inXRFrameLoop=!0;const e=this._baseLayerRTTProvider?.getFramebufferDimensions()||null;this._engine.framebufferDimensionsObject!==e&&(this._engine.framebufferDimensionsObject=e),this.onXRFrameObservable.notifyObservers(t),this._engine._renderLoop(),this._engine.framebufferDimensionsObject=null,this.inXRFrameLoop=!1}}},this._engine.framebufferDimensionsObject=this._baseLayerRTTProvider?.getFramebufferDimensions()||null,this.onXRFrameObservable.addOnce((()=>{this.onXRReady.notifyObservers(this)})),"undefined"!=typeof window&&window.cancelAnimationFrame&&window.cancelAnimationFrame(this._engine._frameHandler),this._engine._renderLoop())}setReferenceSpaceTypeAsync(e="local-floor"){return this.session.requestReferenceSpace(e).then((e=>e),(e=>(m.V.Error("XR.requestReferenceSpace failed for the following reason: "),m.V.Error(e),m.V.Log('Defaulting to universally-supported "viewer" reference space type.'),this.session.requestReferenceSpace("viewer").then((e=>{const t=new XRRigidTransform({x:0,y:-this.defaultHeightCompensation,z:0});return e.getOffsetReferenceSpace(t)}),(e=>{throw m.V.Error(e),'XR initialization failed: required "viewer" reference space type not supported.'}))))).then((e=>this.session.requestReferenceSpace("viewer").then((t=>(this.viewerReferenceSpace=t,e))))).then((e=>(this.referenceSpace=this.baseReferenceSpace=e,this.onXRReferenceSpaceInitialized.notifyObservers(e),this.referenceSpace)))}updateRenderStateAsync(e){return Promise.resolve(this.session.updateRenderState(e))}_setBaseLayerWrapper(e){this.isNative&&this._baseLayerRTTProvider?.dispose(),this._baseLayerWrapper=e,this._baseLayerRTTProvider=this._baseLayerWrapper?.createRenderTargetTextureProvider(this)||null}_getBaseLayerWrapper(){return this._baseLayerWrapper}updateRenderState(e){e.baseLayer&&this._setBaseLayerWrapper(this.isNative?new Or(e.baseLayer):new Ir(e.baseLayer)),this.session.updateRenderState(e)}static IsSessionSupportedAsync(e){if(!navigator.xr)return Promise.resolve(!1);const t=navigator.xr.isSessionSupported||navigator.xr.supportsSession;return t?t.call(navigator.xr,e).then((e=>{const t=void 0===e||e;return Promise.resolve(t)})).catch((e=>(m.V.Warn(e),Promise.resolve(!1)))):Promise.resolve(!1)}get isNative(){return this._xrNavigator.xr.native??!1}get currentFrameRate(){return this.session?.frameRate}get supportedFrameRates(){return this.session?.supportedFrameRates}updateTargetFrameRate(e){return this.session.updateTargetFrameRate(e)}runInXRFrame(e,t=!0){this.inXRFrameLoop?e():!this.inXRSession&&t||this.onXRFrameObservable.addOnce(e)}get isFixedFoveationSupported(){return this._baseLayerWrapper?.isFixedFoveationSupported||!1}get fixedFoveation(){return this._baseLayerWrapper?.fixedFoveation||null}set fixedFoveation(e){const t=Math.max(0,Math.min(1,e||0));this._baseLayerWrapper&&(this._baseLayerWrapper.fixedFoveation=t)}get enabledFeatures(){return this.session?.enabledFeatures??null}}var Br=i(66423);function Vr(e){const t=[],i=[],r=[],s=[],o=e.diameter||1,a=e.thickness||.5,l=0|(e.tessellation||16),h=0===e.sideOrientation?0:e.sideOrientation||ot.P.DEFAULTSIDE,c=l+1;for(let e=0;e<=l;e++){const h=e/l,u=e*Math.PI*2/l-Math.PI/2,d=n.uq.Translation(o/2,0,0).multiply(n.uq.RotationY(u));for(let o=0;o<=l;o++){const u=1-o/l,p=o*Math.PI*2/l+Math.PI,m=Math.cos(p),f=Math.sin(p);let _=new n.Pq(m,f,0),g=_.scale(a/2);const x=new n.I9(h,u);g=n.Pq.TransformCoordinates(g,d),_=n.Pq.TransformNormal(_,d),i.push(g.x,g.y,g.z),r.push(_.x,_.y,_.z),s.push(x.x,at.rX?1-x.y:x.y);const v=(e+1)%c,S=(o+1)%c;t.push(e*c+o),t.push(e*c+S),t.push(v*c+o),t.push(e*c+S),t.push(v*c+S),t.push(v*c+o)}}ot.P._ComputeSides(h,i,t,r,s,e.frontUVs,e.backUVs);const u=new ot.P;return u.indices=t,u.positions=i,u.normals=r,u.uvs=s,u}function Lr(e,t={},i){const r=new tt.e(e,i);t.sideOrientation=tt.e._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;return Vr(t).applyToMesh(r,t.updatable),r}const kr={CreateTorus:Lr};ot.P.CreateTorus=Vr,tt.e.CreateTorus=(e,t,i,r,s,n,o)=>Lr(e,{diameter:t,thickness:i,tessellation:r,sideOrientation:o,updatable:n},s);class Gr{constructor(e,t=null){if(this.scene=e,this._pointerDownOnMeshAsked=!1,this._isActionableMesh=!1,this._teleportationRequestInitiated=!1,this._teleportationBackRequestInitiated=!1,this._rotationRightAsked=!1,this._rotationLeftAsked=!1,this._dpadPressed=!0,this._activePointer=!1,this._id=Gr._IdCounter++,t)this._gazeTracker=t.clone("gazeTracker");else{this._gazeTracker=Lr("gazeTracker",{diameter:.0035,thickness:.0025,tessellation:20,updatable:!1},e),this._gazeTracker.bakeCurrentTransformIntoVertices(),this._gazeTracker.isPickable=!1,this._gazeTracker.isVisible=!1;const t=new br.F("targetMat",e);t.specularColor=o.v9.Black(),t.emissiveColor=new o.v9(.7,.7,.7),t.backFaceCulling=!1,this._gazeTracker.material=t}}_getForwardRay(e){return new st.Ray(n.Pq.Zero(),new n.Pq(0,0,e))}_selectionPointerDown(){this._pointerDownOnMeshAsked=!0,this._currentHit&&this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})}_selectionPointerUp(){this._currentHit&&this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id}),this._pointerDownOnMeshAsked=!1}_activatePointer(){this._activePointer=!0}_deactivatePointer(){this._activePointer=!1}_updatePointerDistance(e=100){}dispose(){this._interactionsEnabled=!1,this._teleportationEnabled=!1,this._gazeTracker&&this._gazeTracker.dispose()}}Gr._IdCounter=0;class zr extends Gr{constructor(e,t){super(t),this._getCamera=e}_getForwardRay(e){const t=this._getCamera();return t?t.getForwardRay(e):new st.Ray(n.Pq.Zero(),n.Pq.Forward())}}class Ur{}class Wr{get onEnteringVR(){return this.onEnteringVRObservable}get onExitingVR(){return this.onExitingVRObservable}get teleportationTarget(){return this._teleportationTarget}set teleportationTarget(e){e&&(e.name="teleportationTarget",this._isDefaultTeleportationTarget=!1,this._teleportationTarget=e)}get gazeTrackerMesh(){return this._cameraGazer._gazeTracker}set gazeTrackerMesh(e){e&&(this._cameraGazer._gazeTracker&&this._cameraGazer._gazeTracker.dispose(),this._cameraGazer._gazeTracker=e,this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices(),this._cameraGazer._gazeTracker.isPickable=!1,this._cameraGazer._gazeTracker.isVisible=!1,this._cameraGazer._gazeTracker.name="gazeTracker")}get displayGaze(){return this._displayGaze}set displayGaze(e){this._displayGaze=e,e||(this._cameraGazer._gazeTracker.isVisible=!1)}get displayLaserPointer(){return this._displayLaserPointer}set displayLaserPointer(e){this._displayLaserPointer=e}get deviceOrientationCamera(){return this._deviceOrientationCamera}get currentVRCamera(){return this._scene.activeCamera}get vrDeviceOrientationCamera(){return this._vrDeviceOrientationCamera}get vrButton(){return this._btnVR}get _teleportationRequestInitiated(){return this._cameraGazer._teleportationRequestInitiated}constructor(e,t={}){this.webVROptions=t,this._fullscreenVRpresenting=!1,this.enableGazeEvenWhenNoPointerLock=!1,this.exitVROnDoubleTap=!0,this.onEnteringVRObservable=new s.cP,this.onAfterEnteringVRObservable=new s.cP,this.onExitingVRObservable=new s.cP,this._useCustomVRButton=!1,this._teleportActive=!1,this._floorMeshesCollection=[],this._teleportationMode=Wr.TELEPORTATIONMODE_CONSTANTTIME,this._teleportationTime=122,this._teleportationSpeed=20,this._rotationAllowed=!0,this._teleportBackwardsVector=new n.Pq(0,-1,-1),this._isDefaultTeleportationTarget=!0,this._teleportationFillColor="#444444",this._teleportationBorderColor="#FFFFFF",this._rotationAngle=0,this._haloCenter=new n.Pq(0,0,0),this._padSensibilityUp=.65,this._padSensibilityDown=.35,this._pickedLaserColor=new o.v9(.2,.2,1),this._pickedGazeColor=new o.v9(0,0,1),this.onNewMeshSelected=new s.cP,this.onNewMeshPicked=new s.cP,this.onBeforeCameraTeleport=new s.cP,this.onAfterCameraTeleport=new s.cP,this.onSelectedMeshUnselected=new s.cP,this.teleportationEnabled=!0,this._teleportationInitialized=!1,this._interactionsEnabled=!1,this._displayGaze=!0,this._displayLaserPointer=!0,this.updateGazeTrackerScale=!0,this.updateGazeTrackerColor=!0,this.updateControllerLaserColor=!0,this.requestPointerLockOnFullScreen=!0,this.xrTestDone=!1,this._onResize=()=>{this._moveButtonToBottomRight()},this._onFullscreenChange=()=>{this._fullscreenVRpresenting=!!document.fullscreenElement,!this._fullscreenVRpresenting&&this._inputElement&&(this.exitVR(),!this._useCustomVRButton&&this._btnVR&&(this._btnVR.style.top=this._inputElement.offsetTop+this._inputElement.offsetHeight-70+"px",this._btnVR.style.left=this._inputElement.offsetLeft+this._inputElement.offsetWidth-100+"px",this._updateButtonVisibility()))},this._cachedAngularSensibility={angularSensibilityX:null,angularSensibilityY:null,angularSensibility:null},this._beforeRender=()=>{this._scene.getEngine().isPointerLock||this.enableGazeEvenWhenNoPointerLock||(this._cameraGazer._gazeTracker.isVisible=!1)},this._onNewGamepadConnected=e=>{e.type!==Gt.POSE_ENABLED&&(e.leftStick&&e.onleftstickchanged((e=>{this._teleportationInitialized&&this.teleportationEnabled&&(this._checkTeleportWithRay(e,this._cameraGazer),this._checkTeleportBackwards(e,this._cameraGazer))})),e.rightStick&&e.onrightstickchanged((e=>{this._teleportationInitialized&&this._checkRotate(e,this._cameraGazer)})),e.type===Gt.XBOX&&(e.onbuttondown((e=>{this._interactionsEnabled&&0===e&&this._cameraGazer._selectionPointerDown()})),e.onbuttonup((e=>{this._interactionsEnabled&&0===e&&this._cameraGazer._selectionPointerUp()}))))},this._workingVector=n.Pq.Zero(),this._workingQuaternion=n.PT.Identity(),this._workingMatrix=n.uq.Identity(),m.V.Warn("WebVR is deprecated. Please avoid using this experience helper and use the WebXR experience helper instead"),this._scene=e,this._inputElement=e.getEngine().getInputElement();if("getVRDisplays"in navigator||void 0!==t.useXR||(t.useXR=!0),void 0===t.createFallbackVRDeviceOrientationFreeCamera&&(t.createFallbackVRDeviceOrientationFreeCamera=!0),void 0===t.createDeviceOrientationCamera&&(t.createDeviceOrientationCamera=!0),void 0===t.laserToggle&&(t.laserToggle=!0),this._hasEnteredVR=!1,this._scene.activeCamera?this._position=this._scene.activeCamera.position.clone():this._position=new n.Pq(0,this._defaultHeight,0),t.createDeviceOrientationCamera||!this._scene.activeCamera){if(this._deviceOrientationCamera=new _i("deviceOrientationVRHelper",this._position.clone(),e),this._scene.activeCamera&&(this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ,this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ,this._scene.activeCamera instanceof ui.F&&this._scene.activeCamera.rotation)){const e=this._scene.activeCamera;e.rotationQuaternion?this._deviceOrientationCamera.rotationQuaternion.copyFrom(e.rotationQuaternion):this._deviceOrientationCamera.rotationQuaternion.copyFrom(n.PT.RotationYawPitchRoll(e.rotation.y,e.rotation.x,e.rotation.z)),this._deviceOrientationCamera.rotation=e.rotation.clone()}this._scene.activeCamera=this._deviceOrientationCamera,this._inputElement&&this._scene.activeCamera.attachControl()}else this._existingCamera=this._scene.activeCamera;this.webVROptions.useXR&&navigator.xr?Fr.IsSessionSupportedAsync("immersive-vr").then((i=>{i?(m.V.Log("Using WebXR. It is recommended to use the WebXRDefaultExperience directly"),e.createDefaultXRExperienceAsync({floorMeshes:t.floorMeshes||[]}).then((t=>{this.xr=t,this.xrTestDone=!0,this._cameraGazer=new zr((()=>this.xr.baseExperience.camera),e),this.xr.baseExperience.onStateChangedObservable.add((e=>{switch(e){case 0:this.onEnteringVRObservable.notifyObservers(this),this._interactionsEnabled||this.xr.pointerSelection.detach(),this.xr.pointerSelection.displayLaserPointer=this._displayLaserPointer;break;case 1:this.onExitingVRObservable.notifyObservers(this),this._scene.getEngine().resize();break;case 2:this._hasEnteredVR=!0;break;case 3:this._hasEnteredVR=!1}}))}))):this._completeVRInit(e,t)})):this._completeVRInit(e,t)}_completeVRInit(e,t){if(this.xrTestDone=!0,t.createFallbackVRDeviceOrientationFreeCamera&&(this._vrDeviceOrientationCamera=new xr("VRDeviceOrientationVRHelper",this._position,this._scene,!0,t.vrDeviceOrientationCameraMetrics),this._vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._cameraGazer=new zr((()=>this.currentVRCamera),e),!this._useCustomVRButton){this._btnVR=document.createElement("BUTTON"),this._btnVR.className="babylonVRicon",this._btnVR.id="babylonVRiconbtn",this._btnVR.title="Click to switch to VR";let e=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A":"https://cdn.babylonjs.com/Assets/vrButton.png")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";e+=".babylonVRicon.vrdisplaypresenting { display: none; }";const t=document.createElement("style");t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t),this._moveButtonToBottomRight()}this._btnVR&&this._btnVR.addEventListener("click",(()=>{this.isInVRMode||this.enterVR()}));const i=this._scene.getEngine().getHostWindow();i&&(i.addEventListener("resize",this._onResize),document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),t.createFallbackVRDeviceOrientationFreeCamera&&this._displayVRButton(),this._onKeyDown=e=>{27===e.keyCode&&this.isInVRMode&&this.exitVR()},document.addEventListener("keydown",this._onKeyDown),this._scene.onPrePointerObservable.add((()=>{this._hasEnteredVR&&this.exitVROnDoubleTap&&(this.exitVR(),this._fullscreenVRpresenting&&this._scene.getEngine().exitFullscreen())}),rt.Zp.POINTERDOUBLETAP,!1),e.onDisposeObservable.add((()=>{this.dispose()})),this._updateButtonVisibility(),this._circleEase=new F.rm,this._circleEase.setEasingMode(F.KA.EASINGMODE_EASEINOUT),this._teleportationEasing=this._circleEase,e.onPointerObservable.add((t=>{this._interactionsEnabled&&e.activeCamera===this.vrDeviceOrientationCamera&&"mouse"===t.event.pointerType&&(t.type===rt.Zp.POINTERDOWN?this._cameraGazer._selectionPointerDown():t.type===rt.Zp.POINTERUP&&this._cameraGazer._selectionPointerUp())})),this.webVROptions.floorMeshes&&this.enableTeleportation({floorMeshes:this.webVROptions.floorMeshes}))}get isInVRMode(){return this.xr&&this.webVROptions.useXR&&2===this.xr.baseExperience.state||this._fullscreenVRpresenting}_moveButtonToBottomRight(){if(this._inputElement&&!this._useCustomVRButton&&this._btnVR){const e=this._inputElement.getBoundingClientRect();this._btnVR.style.top=e.top+e.height-70+"px",this._btnVR.style.left=e.left+e.width-100+"px"}}_displayVRButton(){this._useCustomVRButton||this._btnVRDisplayed||!this._btnVR||(document.body.appendChild(this._btnVR),this._btnVRDisplayed=!0)}_updateButtonVisibility(){this._btnVR&&!this._useCustomVRButton&&(this._btnVR.className="babylonVRicon",this.isInVRMode&&(this._btnVR.className+=" vrdisplaypresenting"))}enterVR(){if(this.xr)this.xr.baseExperience.enterXRAsync("immersive-vr","local-floor",this.xr.renderTarget);else{if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(e){m.V.Warn("Error in your custom logic onEnteringVR: "+e)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone(),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.rotation=n.PT.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles(),this.vrDeviceOrientationCamera.angularSensibility=2e3),this._existingCamera=this._scene.activeCamera,this._existingCamera.angularSensibilityX&&(this._cachedAngularSensibility.angularSensibilityX=this._existingCamera.angularSensibilityX,this._existingCamera.angularSensibilityX=Number.MAX_VALUE),this._existingCamera.angularSensibilityY&&(this._cachedAngularSensibility.angularSensibilityY=this._existingCamera.angularSensibilityY,this._existingCamera.angularSensibilityY=Number.MAX_VALUE),this._existingCamera.angularSensibility&&(this._cachedAngularSensibility.angularSensibility=this._existingCamera.angularSensibility,this._existingCamera.angularSensibility=Number.MAX_VALUE)),this._vrDeviceOrientationCamera&&(this._vrDeviceOrientationCamera.position=this._position,this._scene.activeCamera&&(this._vrDeviceOrientationCamera.minZ=this._scene.activeCamera.minZ),this._scene.activeCamera=this._vrDeviceOrientationCamera,this._scene.getEngine().enterFullscreen(this.requestPointerLockOnFullScreen),this._updateButtonVisibility(),this._vrDeviceOrientationCamera.onViewMatrixChangedObservable.addOnce((()=>{this.onAfterEnteringVRObservable.notifyObservers({success:!0})}))),this._scene.activeCamera&&this._inputElement&&this._scene.activeCamera.attachControl(),this._interactionsEnabled&&this._scene.registerBeforeRender(this._beforeRender),this._hasEnteredVR=!0}}exitVR(){if(this.xr)this.xr.baseExperience.exitXRAsync();else if(this._hasEnteredVR){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(e){m.V.Warn("Error in your custom logic onExitingVR: "+e)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone()),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._deviceOrientationCamera?(this._deviceOrientationCamera.position=this._position,this._scene.activeCamera=this._deviceOrientationCamera,this._cachedAngularSensibility.angularSensibilityX&&(this._deviceOrientationCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._deviceOrientationCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._deviceOrientationCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)):this._existingCamera&&(this._existingCamera.position=this._position,this._scene.activeCamera=this._existingCamera,this._inputElement&&this._scene.activeCamera.attachControl(),this._cachedAngularSensibility.angularSensibilityX&&(this._existingCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._existingCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._existingCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)),this._updateButtonVisibility(),this._interactionsEnabled&&(this._scene.unregisterBeforeRender(this._beforeRender),this._cameraGazer._gazeTracker.isVisible=!1),this._scene.getEngine().resize(),this._hasEnteredVR=!1}}get position(){return this._position}set position(e){this._position=e,this._scene.activeCamera&&(this._scene.activeCamera.position=e)}enableInteractions(){if(!this._interactionsEnabled){if(this.xr)return void(2===this.xr.baseExperience.state&&this.xr.pointerSelection.attach());this.raySelectionPredicate=e=>e.isVisible&&(e.isPickable||e.name===this._floorMeshName),this.meshSelectionPredicate=()=>!0,this._raySelectionPredicate=e=>!!(this._isTeleportationFloor(e)||-1===e.name.indexOf("gazeTracker")&&-1===e.name.indexOf("teleportationTarget")&&-1===e.name.indexOf("torusTeleportation"))&&this.raySelectionPredicate(e),this._interactionsEnabled=!0}}_isTeleportationFloor(e){for(let t=0;t<this._floorMeshesCollection.length;t++)if(this._floorMeshesCollection[t].id===e.id)return!0;return!(!this._floorMeshName||e.name!==this._floorMeshName)}addFloorMesh(e){this._floorMeshesCollection&&(this._floorMeshesCollection.indexOf(e)>-1||this._floorMeshesCollection.push(e))}removeFloorMesh(e){if(!this._floorMeshesCollection)return;const t=this._floorMeshesCollection.indexOf(e);-1!==t&&this._floorMeshesCollection.splice(t,1)}enableTeleportation(e={}){if(!this._teleportationInitialized){if(this.enableInteractions(),this.webVROptions.useXR&&(e.floorMeshes||e.floorMeshName)){const t=e.floorMeshes||[];if(!t.length){const i=this._scene.getMeshByName(e.floorMeshName);i&&t.push(i)}if(this.xr)return t.forEach((e=>{this.xr.teleportation.addFloorMesh(e)})),void(this.xr.teleportation.attached||this.xr.teleportation.attach());if(!this.xrTestDone){const t=()=>{this.xrTestDone&&(this._scene.unregisterBeforeRender(t),this.xr?this.xr.teleportation.attached||this.xr.teleportation.attach():this.enableTeleportation(e))};return void this._scene.registerBeforeRender(t)}}e.floorMeshName&&(this._floorMeshName=e.floorMeshName),e.floorMeshes&&(this._floorMeshesCollection=e.floorMeshes),e.teleportationMode&&(this._teleportationMode=e.teleportationMode),e.teleportationTime&&e.teleportationTime>0&&(this._teleportationTime=e.teleportationTime),e.teleportationSpeed&&e.teleportationSpeed>0&&(this._teleportationSpeed=e.teleportationSpeed),void 0!==e.easingFunction&&(this._teleportationEasing=e.easingFunction);const t=new Sr.p;t.vignetteColor=new o.ov(0,0,0,0),t.vignetteEnabled=!0,this._teleportationInitialized=!0,this._isDefaultTeleportationTarget&&this._createTeleportationCircles()}}_checkTeleportWithRay(e,t){this._teleportationRequestInitiated&&!t._teleportationRequestInitiated||(t._teleportationRequestInitiated?Math.sqrt(e.y*e.y+e.x*e.x)<this._padSensibilityDown&&(this._teleportActive&&this.teleportCamera(this._haloCenter),t._teleportationRequestInitiated=!1):e.y<-this._padSensibilityUp&&t._dpadPressed&&(t._activatePointer(),t._teleportationRequestInitiated=!0))}_checkRotate(e,t){t._teleportationRequestInitiated||(t._rotationLeftAsked?e.x>-this._padSensibilityDown&&(t._rotationLeftAsked=!1):e.x<-this._padSensibilityUp&&t._dpadPressed&&(t._rotationLeftAsked=!0,this._rotationAllowed&&this._rotateCamera(!1)),t._rotationRightAsked?e.x<this._padSensibilityDown&&(t._rotationRightAsked=!1):e.x>this._padSensibilityUp&&t._dpadPressed&&(t._rotationRightAsked=!0,this._rotationAllowed&&this._rotateCamera(!0)))}_checkTeleportBackwards(e,t){if(!t._teleportationRequestInitiated)if(e.y>this._padSensibilityUp&&t._dpadPressed){if(!t._teleportationBackRequestInitiated){if(!this.currentVRCamera)return;const e=n.PT.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),i=this.currentVRCamera.position;e.toEulerAnglesToRef(this._workingVector),this._workingVector.z=0,this._workingVector.x=0,n.PT.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion),this._workingQuaternion.toRotationMatrix(this._workingMatrix),n.Pq.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);const r=new st.Ray(i,this._workingVector),s=this._scene.pickWithRay(r,this._raySelectionPredicate);s&&s.pickedPoint&&s.pickedMesh&&this._isTeleportationFloor(s.pickedMesh)&&s.distance<5&&this.teleportCamera(s.pickedPoint),t._teleportationBackRequestInitiated=!0}}else t._teleportationBackRequestInitiated=!1}_createTeleportationCircles(){this._teleportationTarget=(0,Br.km)("teleportationTarget",{width:2,height:2,subdivisions:2},this._scene),this._teleportationTarget.isPickable=!1;const e=new Tr("DynamicTexture",512,this._scene,!0);e.hasAlpha=!0;const t=e.getContext();t.beginPath(),t.arc(256,256,200,0,2*Math.PI,!1),t.fillStyle=this._teleportationFillColor,t.fill(),t.lineWidth=10,t.strokeStyle=this._teleportationBorderColor,t.stroke(),t.closePath(),e.update();const i=new br.F("TextPlaneMaterial",this._scene);i.diffuseTexture=e,this._teleportationTarget.material=i;const r=Lr("torusTeleportation",{diameter:.75,thickness:.1,tessellation:25,updatable:!1},this._scene);r.isPickable=!1,r.parent=this._teleportationTarget;const s=new M.X5("animationInnerCircle","position.y",30,M.X5.ANIMATIONTYPE_FLOAT,M.X5.ANIMATIONLOOPMODE_CYCLE),n=[];n.push({frame:0,value:0}),n.push({frame:30,value:.4}),n.push({frame:60,value:0}),s.setKeys(n);const o=new F.kc;o.setEasingMode(F.KA.EASINGMODE_EASEINOUT),s.setEasingFunction(o),r.animations=[],r.animations.push(s),this._scene.beginAnimation(r,0,60,!0),this._hideTeleportationTarget()}_hideTeleportationTarget(){this._teleportActive=!1,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!1,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!1))}_rotateCamera(e){if(!(this.currentVRCamera instanceof di.S))return;e?this._rotationAngle++:this._rotationAngle--,this.currentVRCamera.animations=[];const t=n.PT.FromRotationMatrix(n.uq.RotationY(Math.PI/4*this._rotationAngle)),i=new M.X5("animationRotation","rotationQuaternion",90,M.X5.ANIMATIONTYPE_QUATERNION,M.X5.ANIMATIONLOOPMODE_CONSTANT),r=[];r.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),r.push({frame:6,value:t}),i.setKeys(r),i.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(i),this._postProcessMove.animations=[];const s=new M.X5("animationPP","vignetteWeight",90,M.X5.ANIMATIONTYPE_FLOAT,M.X5.ANIMATIONLOOPMODE_CONSTANT),o=[];o.push({frame:0,value:0}),o.push({frame:3,value:4}),o.push({frame:6,value:0}),s.setKeys(o),s.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(s);const a=new M.X5("animationPP2","vignetteStretch",90,M.X5.ANIMATIONTYPE_FLOAT,M.X5.ANIMATIONLOOPMODE_CONSTANT),l=[];l.push({frame:0,value:0}),l.push({frame:3,value:10}),l.push({frame:6,value:0}),a.setKeys(l),a.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(a),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._postProcessMove.samples=4,this._scene.beginAnimation(this.currentVRCamera,0,6,!1,1)}teleportCamera(e){if(!(this.currentVRCamera instanceof di.S))return;this._workingVector.copyFrom(e),this.isInVRMode||(this._workingVector.y+=this._defaultHeight),this.onBeforeCameraTeleport.notifyObservers(this._workingVector);let t,i;if(this._teleportationMode==Wr.TELEPORTATIONMODE_CONSTANTSPEED){i=90;const e=n.Pq.Distance(this.currentVRCamera.position,this._workingVector);t=this._teleportationSpeed/e}else i=Math.round(90*this._teleportationTime/1e3),t=1;this.currentVRCamera.animations=[];const r=new M.X5("animationCameraTeleportation","position",90,M.X5.ANIMATIONTYPE_VECTOR3,M.X5.ANIMATIONLOOPMODE_CONSTANT),s=[{frame:0,value:this.currentVRCamera.position},{frame:i,value:this._workingVector}];r.setKeys(s),r.setEasingFunction(this._teleportationEasing),this.currentVRCamera.animations.push(r),this._postProcessMove.animations=[];const o=Math.round(i/2),a=new M.X5("animationPP","vignetteWeight",90,M.X5.ANIMATIONTYPE_FLOAT,M.X5.ANIMATIONLOOPMODE_CONSTANT),l=[];l.push({frame:0,value:0}),l.push({frame:o,value:8}),l.push({frame:i,value:0}),a.setKeys(l),this._postProcessMove.animations.push(a);const h=new M.X5("animationPP2","vignetteStretch",90,M.X5.ANIMATIONTYPE_FLOAT,M.X5.ANIMATIONLOOPMODE_CONSTANT),c=[];c.push({frame:0,value:0}),c.push({frame:o,value:10}),c.push({frame:i,value:0}),h.setKeys(c),this._postProcessMove.animations.push(h),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._scene.beginAnimation(this.currentVRCamera,0,i,!1,t,(()=>{this.onAfterCameraTeleport.notifyObservers(this._workingVector)})),this._hideTeleportationTarget()}setLaserColor(e,t=this._pickedLaserColor){this._pickedLaserColor=t}setLaserLightingState(e=!0){}setGazeColor(e,t=this._pickedGazeColor){this._pickedGazeColor=t}changeLaserColor(e){this.updateControllerLaserColor}changeGazeColor(e){this.updateGazeTrackerColor&&this._cameraGazer._gazeTracker.material&&(this._cameraGazer._gazeTracker.material.emissiveColor=e)}dispose(){this.isInVRMode&&this.exitVR(),this._postProcessMove&&this._postProcessMove.dispose(),this._vrDeviceOrientationCamera&&this._vrDeviceOrientationCamera.dispose(),!this._useCustomVRButton&&this._btnVR&&this._btnVR.parentNode&&document.body.removeChild(this._btnVR),this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera&&this._deviceOrientationCamera.dispose(),this._cameraGazer&&this._cameraGazer.dispose(),this._teleportationTarget&&this._teleportationTarget.dispose(),this.xr&&this.xr.dispose(),this._floorMeshesCollection.length=0,document.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),window.removeEventListener("resize",this._onResize),document.removeEventListener("fullscreenchange",this._onFullscreenChange),this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected),this._scene.unregisterBeforeRender(this._beforeRender)}getClassName(){return"VRExperienceHelper"}}Wr.TELEPORTATIONMODE_CONSTANTTIME=0,Wr.TELEPORTATIONMODE_CONSTANTSPEED=1;var Hr=i(94100);const $r=function(){const e={root:0,found:!1};return function(t,i,r,s){e.root=0,e.found=!1;const n=i*i-4*t*r;if(n<0)return e;const o=Math.sqrt(n);let a=(-i-o)/(2*t),l=(-i+o)/(2*t);if(a>l){const e=l;l=a,a=e}return a>0&&a<s?(e.root=a,e.found=!0,e):l>0&&l<s?(e.root=l,e.found=!0,e):e}}();class qr{constructor(){this._collisionPoint=n.Pq.Zero(),this._planeIntersectionPoint=n.Pq.Zero(),this._tempVector=n.Pq.Zero(),this._tempVector2=n.Pq.Zero(),this._tempVector3=n.Pq.Zero(),this._tempVector4=n.Pq.Zero(),this._edge=n.Pq.Zero(),this._baseToVertex=n.Pq.Zero(),this._destinationPoint=n.Pq.Zero(),this._slidePlaneNormal=n.Pq.Zero(),this._displacementVector=n.Pq.Zero(),this._radius=n.Pq.One(),this._retry=0,this._basePointWorld=n.Pq.Zero(),this._velocityWorld=n.Pq.Zero(),this._normalizedVelocity=n.Pq.Zero(),this._collisionMask=-1}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}get slidePlaneNormal(){return this._slidePlaneNormal}_initialize(e,t,i){this._velocity=t,this._velocitySquaredLength=this._velocity.lengthSquared();const r=Math.sqrt(this._velocitySquaredLength);0===r||1===r?this._normalizedVelocity.copyFromFloats(t._x,t._y,t._z):t.scaleToRef(1/r,this._normalizedVelocity),this._basePoint=e,e.multiplyToRef(this._radius,this._basePointWorld),t.multiplyToRef(this._radius,this._velocityWorld),this._velocityWorldLength=this._velocityWorld.length(),this._epsilon=i,this.collisionFound=!1}_checkPointInTriangle(e,t,i,r,s){t.subtractToRef(e,this._tempVector),i.subtractToRef(e,this._tempVector2),n.Pq.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);let o=n.Pq.Dot(this._tempVector4,s);return!(o<0)&&(r.subtractToRef(e,this._tempVector3),n.Pq.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),o=n.Pq.Dot(this._tempVector4,s),!(o<0)&&(n.Pq.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),o=n.Pq.Dot(this._tempVector4,s),o>=0))}_canDoCollision(e,t,i,r){const s=n.Pq.Distance(this._basePointWorld,e),o=Math.max(this._radius.x,this._radius.y,this._radius.z);return!(s>this._velocityWorldLength+o+t)&&!!((e,t,i,r)=>!(e.x>i.x+r||i.x-r>t.x||e.y>i.y+r||i.y-r>t.y||e.z>i.z+r||i.z-r>t.z))(i,r,this._basePointWorld,this._velocityWorldLength+o)}_testTriangle(e,t,i,r,s,o,a){let l,h=!1;t||(t=[]),t[e]||(t[e]=new Hr.Z(0,0,0,0),t[e].copyFromPoints(i,r,s));const c=t[e];if(!o&&!c.isFrontFacingTo(this._normalizedVelocity,0))return;const u=c.signedDistanceTo(this._basePoint),d=n.Pq.Dot(c.normal,this._velocity);if(qr.DoubleSidedCheck&&d>1e-4)return;if(0==d){if(Math.abs(u)>=1)return;h=!0,l=0}else{l=(-1-u)/d;let e=(1-u)/d;if(l>e){const t=e;e=l,l=t}if(l>1||e<0)return;l<0&&(l=0),l>1&&(l=1)}this._collisionPoint.copyFromFloats(0,0,0);let p=!1,m=1;if(h||(this._basePoint.subtractToRef(c.normal,this._planeIntersectionPoint),this._velocity.scaleToRef(l,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,i,r,s,c.normal)&&(p=!0,m=l,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!p){let e=this._velocitySquaredLength;this._basePoint.subtractToRef(i,this._tempVector);let t=2*n.Pq.Dot(this._velocity,this._tempVector),o=this._tempVector.lengthSquared()-1,a=$r(e,t,o,m);a.found&&(m=a.root,p=!0,this._collisionPoint.copyFrom(i)),this._basePoint.subtractToRef(r,this._tempVector),t=2*n.Pq.Dot(this._velocity,this._tempVector),o=this._tempVector.lengthSquared()-1,a=$r(e,t,o,m),a.found&&(m=a.root,p=!0,this._collisionPoint.copyFrom(r)),this._basePoint.subtractToRef(s,this._tempVector),t=2*n.Pq.Dot(this._velocity,this._tempVector),o=this._tempVector.lengthSquared()-1,a=$r(e,t,o,m),a.found&&(m=a.root,p=!0,this._collisionPoint.copyFrom(s)),r.subtractToRef(i,this._edge),i.subtractToRef(this._basePoint,this._baseToVertex);let l=this._edge.lengthSquared(),h=n.Pq.Dot(this._edge,this._velocity),c=n.Pq.Dot(this._edge,this._baseToVertex);if(e=l*-this._velocitySquaredLength+h*h,t=2*(l*n.Pq.Dot(this._velocity,this._baseToVertex)-h*c),o=l*(1-this._baseToVertex.lengthSquared())+c*c,a=$r(e,t,o,m),a.found){const e=(h*a.root-c)/l;e>=0&&e<=1&&(m=a.root,p=!0,this._edge.scaleInPlace(e),i.addToRef(this._edge,this._collisionPoint))}if(s.subtractToRef(r,this._edge),r.subtractToRef(this._basePoint,this._baseToVertex),l=this._edge.lengthSquared(),h=n.Pq.Dot(this._edge,this._velocity),c=n.Pq.Dot(this._edge,this._baseToVertex),e=l*-this._velocitySquaredLength+h*h,t=2*(l*n.Pq.Dot(this._velocity,this._baseToVertex)-h*c),o=l*(1-this._baseToVertex.lengthSquared())+c*c,a=$r(e,t,o,m),a.found){const e=(h*a.root-c)/l;e>=0&&e<=1&&(m=a.root,p=!0,this._edge.scaleInPlace(e),r.addToRef(this._edge,this._collisionPoint))}if(i.subtractToRef(s,this._edge),s.subtractToRef(this._basePoint,this._baseToVertex),l=this._edge.lengthSquared(),h=n.Pq.Dot(this._edge,this._velocity),c=n.Pq.Dot(this._edge,this._baseToVertex),e=l*-this._velocitySquaredLength+h*h,t=2*(l*n.Pq.Dot(this._velocity,this._baseToVertex)-h*c),o=l*(1-this._baseToVertex.lengthSquared())+c*c,a=$r(e,t,o,m),a.found){const e=(h*a.root-c)/l;e>=0&&e<=1&&(m=a.root,p=!0,this._edge.scaleInPlace(e),s.addToRef(this._edge,this._collisionPoint))}}if(p){const e=m*m*this._velocitySquaredLength;(!this.collisionFound||e<this._nearestDistanceSquared)&&(a.collisionResponse&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this._nearestDistanceSquared=e,this._nearestDistance=Math.sqrt(e),this.collisionFound=!0),this.collidedMesh=a)}}_collide(e,t,i,r,s,n,o,a,l,h=!1){if(h)if(i&&0!==i.length)for(let n=r;n<s-2;n+=1){const r=i[n],s=i[n+1],h=i[n+2];if(4294967295===h){n+=2;continue}const c=t[r],u=t[s],d=t[h];c&&u&&d&&((l?1:0)^n%2?this._testTriangle(n,e,c,u,d,o,a):this._testTriangle(n,e,u,c,d,o,a))}else for(let i=0;i<t.length-2;i+=1){const r=t[i],s=t[i+1],n=t[i+2];r&&s&&n&&((l?1:0)^i%2?this._testTriangle(i,e,r,s,n,o,a):this._testTriangle(i,e,s,r,n,o,a))}else if(i&&0!==i.length)for(let h=r;h<s;h+=3){const r=t[i[h]-n],s=t[i[h+1]-n],c=t[i[h+2]-n];l?this._testTriangle(h,e,r,s,c,o,a):this._testTriangle(h,e,c,s,r,o,a)}else for(let i=0;i<t.length;i+=3){const r=t[i],s=t[i+1],n=t[i+2];l?this._testTriangle(i,e,r,s,n,o,a):this._testTriangle(i,e,n,s,r,o,a)}}_getResponse(e,t){e.addToRef(t,this._destinationPoint),t.scaleInPlace(this._nearestDistance/t.length()),this._basePoint.addToRef(t,e),e.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this._epsilon,this._displacementVector),e.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(Hr.Z.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,t)}}qr.DoubleSidedCheck=!1;class Yr{constructor(){this._scaledPosition=n.Pq.Zero(),this._scaledVelocity=n.Pq.Zero(),this._finalPosition=n.Pq.Zero()}getNewPosition(e,t,i,r,s,n,o){e.divideToRef(i._radius,this._scaledPosition),t.divideToRef(i._radius,this._scaledVelocity),i.collidedMesh=null,i._retry=0,i._initialVelocity=this._scaledVelocity,i._initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,r,this._finalPosition,s),this._finalPosition.multiplyInPlace(i._radius),n(o,this._finalPosition,i.collidedMesh)}createCollider(){return new qr}init(e){this._scene=e}_collideWithWorld(e,t,i,r,s,n=null){const o=10*$.$.CollisionsEpsilon;if(i._retry>=r)return void s.copyFrom(e);const a=n?n.collisionMask:i.collisionMask;i._initialize(e,t,o);const l=n&&n.surroundingMeshes||this._scene.meshes;for(let e=0;e<l.length;e++){const t=l[e];t.isEnabled()&&t.checkCollisions&&t.subMeshes&&t!==n&&a&t.collisionGroup&&t._checkCollision(i)}i.collisionFound?(0===t.x&&0===t.y&&0===t.z||i._getResponse(e,t),t.length()<=o?s.copyFrom(e):(i._retry++,this._collideWithWorld(e,t,i,r,s,n))):e.addToRef(t,s)}}it.Z.CollisionCoordinatorFactory=()=>new Yr;var Xr=i(30311),jr=i(77103),Zr=i(76439),Qr=i(82565),Kr=i(62366),Jr=i(21644),es=i(30492),ts=i(80467);const is={effect:null,subMesh:null};class rs extends Jr.E{constructor(e,t,i,r={},s=!0){super(e,t,s),this._textures={},this._textureArrays={},this._externalTextures={},this._floats={},this._ints={},this._uints={},this._floatsArrays={},this._colors3={},this._colors3Arrays={},this._colors4={},this._colors4Arrays={},this._vectors2={},this._vectors3={},this._vectors4={},this._quaternions={},this._quaternionsArrays={},this._matrices={},this._matrixArrays={},this._matrices3x3={},this._matrices2x2={},this._vectors2Arrays={},this._vectors3Arrays={},this._vectors4Arrays={},this._uniformBuffers={},this._textureSamplers={},this._storageBuffers={},this._cachedWorldViewMatrix=new n.uq,this._cachedWorldViewProjectionMatrix=new n.uq,this._multiview=!1,this._materialHelperNeedsPreviousMatrices=!1,this._shaderPath=i,this._options={needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1,...r}}get shaderPath(){return this._shaderPath}set shaderPath(e){this._shaderPath=e}get options(){return this._options}get isMultiview(){return this._multiview}getClassName(){return"ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this._options.needAlphaBlending}needAlphaTesting(){return this._options.needAlphaTesting}_checkUniform(e){-1===this._options.uniforms.indexOf(e)&&this._options.uniforms.push(e)}setTexture(e,t){return-1===this._options.samplers.indexOf(e)&&this._options.samplers.push(e),this._textures[e]=t,this}removeTexture(e){delete this._textures[e]}setTextureArray(e,t){return-1===this._options.samplers.indexOf(e)&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this}setExternalTexture(e,t){return-1===this._options.externalTextures.indexOf(e)&&this._options.externalTextures.push(e),this._externalTextures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setUInt(e,t){return this._checkUniform(e),this._uints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor3Array(e,t){return this._checkUniform(e),this._colors3Arrays[e]=t.reduce(((e,t)=>(t.toArray(e,e.length),e)),[]),this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setColor4Array(e,t){return this._checkUniform(e),this._colors4Arrays[e]=t.reduce(((e,t)=>(t.toArray(e,e.length),e)),[]),this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setQuaternion(e,t){return this._checkUniform(e),this._quaternions[e]=t,this}setQuaternionArray(e,t){return this._checkUniform(e),this._quaternionsArrays[e]=t.reduce(((e,t)=>(t.toArray(e,e.length),e)),[]),this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}setMatrices(e,t){this._checkUniform(e);const i=new Float32Array(16*t.length);for(let e=0;e<t.length;e++){t[e].copyToArray(i,16*e)}return this._matrixArrays[e]=i,this}setMatrix3x3(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this}setMatrix2x2(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this}setArray2(e,t){return this._checkUniform(e),this._vectors2Arrays[e]=t,this}setArray3(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this}setArray4(e,t){return this._checkUniform(e),this._vectors4Arrays[e]=t,this}setUniformBuffer(e,t){return-1===this._options.uniformBuffers.indexOf(e)&&this._options.uniformBuffers.push(e),this._uniformBuffers[e]=t,this}setTextureSampler(e,t){return-1===this._options.samplerObjects.indexOf(e)&&this._options.samplerObjects.push(e),this._textureSamplers[e]=t,this}setStorageBuffer(e,t){return-1===this._options.storageBuffers.indexOf(e)&&this._options.storageBuffers.push(e),this._storageBuffers[e]=t,this}setDefine(e,t){const i=e.trimEnd()+" ",r=this.options.defines.findIndex((t=>t===e||t.startsWith(i)));return r>=0&&this.options.defines.splice(r,1),("boolean"!=typeof t||t)&&this.options.defines.push(i+t),this}isReadyForSubMesh(e,t,i){return this.isReady(e,i,t)}isReady(e,t,i){const r=i&&this._storeEffectOnSubMeshes;if(this.isFrozen){const e=r?i._drawWrapper:this._drawWrapper;if(e.effect&&e._wasPreviouslyReady&&e._wasPreviouslyUsingInstances===t)return!0}const s=this.getScene(),n=s.getEngine(),o=[],a=[];let l=null,h=this._shaderPath,c=this._options.uniforms,u=this._options.uniformBuffers,d=this._options.samplers;n.getCaps().multiview&&s.activeCamera&&s.activeCamera.outputRenderTarget&&s.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,o.push("#define MULTIVIEW"),-1!==c.indexOf("viewProjection")&&-1===c.indexOf("viewProjectionR")&&c.push("viewProjectionR"));for(let e=0;e<this._options.defines.length;e++){const t=0===this._options.defines[e].indexOf("#define")?this._options.defines[e]:`#define ${this._options.defines[e]}`;o.push(t)}for(let e=0;e<this._options.attributes.length;e++)a.push(this._options.attributes[e]);if(e&&e.isVerticesDataPresent(Ot.R.ColorKind)&&(-1===a.indexOf(Ot.R.ColorKind)&&a.push(Ot.R.ColorKind),o.push("#define VERTEXCOLOR")),t&&(o.push("#define INSTANCES"),(0,ts.te)(a,this._materialHelperNeedsPreviousMatrices),e?.hasThinInstances&&(o.push("#define THIN_INSTANCES"),e&&e.isVerticesDataPresent(Ot.R.ColorInstanceKind)&&(a.push(Ot.R.ColorInstanceKind),o.push("#define INSTANCESCOLOR")))),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){a.push(Ot.R.MatricesIndicesKind),a.push(Ot.R.MatricesWeightsKind),e.numBoneInfluencers>4&&(a.push(Ot.R.MatricesIndicesExtraKind),a.push(Ot.R.MatricesWeightsExtraKind));const t=e.skeleton;o.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),l=new Qr.J,l.addCPUSkinningFallback(0,e),t.isUsingTextureForMatrices?(o.push("#define BONETEXTURE"),-1===c.indexOf("boneTextureWidth")&&c.push("boneTextureWidth"),-1===this._options.samplers.indexOf("boneSampler")&&this._options.samplers.push("boneSampler")):(o.push("#define BonesPerMesh "+(t.bones.length+1)),-1===c.indexOf("mBones")&&c.push("mBones"))}else o.push("#define NUM_BONE_INFLUENCERS 0");let p=0;const m=e?e.morphTargetManager:null;if(m){const t=-1!==o.indexOf("#define UV1"),i=-1!==o.indexOf("#define UV2"),r=-1!==o.indexOf("#define TANGENT"),s=-1!==o.indexOf("#define NORMAL"),n=-1!==o.indexOf("#define VERTEXCOLOR");p=(0,ts.Dk)(m,o,a,e,!0,s,r,t,i,n),m.isUsingTextureForTargets&&(-1===c.indexOf("morphTargetTextureIndices")&&c.push("morphTargetTextureIndices"),-1===this._options.samplers.indexOf("morphTargets")&&this._options.samplers.push("morphTargets")),p>0&&(c=c.slice(),c.push("morphTargetInfluences"),c.push("morphTargetCount"),c.push("morphTargetTextureInfo"),c.push("morphTargetTextureIndices"))}else o.push("#define NUM_MORPH_INFLUENCERS 0");if(e){const t=e.bakedVertexAnimationManager;t&&t.isEnabled&&(o.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),-1===c.indexOf("bakedVertexAnimationSettings")&&c.push("bakedVertexAnimationSettings"),-1===c.indexOf("bakedVertexAnimationTextureSizeInverted")&&c.push("bakedVertexAnimationTextureSizeInverted"),-1===c.indexOf("bakedVertexAnimationTime")&&c.push("bakedVertexAnimationTime"),-1===this._options.samplers.indexOf("bakedVertexAnimationTexture")&&this._options.samplers.push("bakedVertexAnimationTexture")),(0,ts.J2)(a,e,o)}for(const e in this._textures)if(!this._textures[e].isReady())return!1;e&&this.needAlphaTestingForMesh(e)&&o.push("#define ALPHATEST"),!1!==this._options.useClipPlane&&((0,es.TV)(c),(0,es.tv)(this,s,o)),s.fogEnabled&&e?.applyFog&&s.fogMode!==it.Z.FOGMODE_NONE&&(o.push("#define FOG"),-1===c.indexOf("view")&&c.push("view"),-1===c.indexOf("vFogInfos")&&c.push("vFogInfos"),-1===c.indexOf("vFogColor")&&c.push("vFogColor")),this._useLogarithmicDepth&&(o.push("#define LOGARITHMICDEPTH"),-1===c.indexOf("logarithmicDepthConstant")&&c.push("logarithmicDepthConstant")),this.customShaderNameResolve&&(c=c.slice(),u=u.slice(),d=d.slice(),h=this.customShaderNameResolve(this.name,c,u,d,o,a));const f=r?i._getDrawWrapper(void 0,!0):this._drawWrapper,_=f?.effect??null,g=f?.defines??null,x=o.join("\n");let v=_;return g!==x&&(v=n.createEffect(h,{attributes:a,uniformsNames:c,uniformBuffersNames:u,samplers:d,defines:x,fallbacks:l,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:p},shaderLanguage:this._options.shaderLanguage,extraInitializationsAsync:this._options.extraInitializationsAsync},n),r?i.setEffect(v,x,this._materialContext):f&&f.setEffect(v,x),this._onEffectCreatedObservable&&(is.effect=v,is.subMesh=i??e?.subMeshes[0]??null,this._onEffectCreatedObservable.notifyObservers(is))),f._wasPreviouslyUsingInstances=!!t,!!v?.isReady()&&(_!==v&&s.resetCachedMaterial(),f._wasPreviouslyReady=!0,!0)}bindOnlyWorldMatrix(e,t){const i=t??this.getEffect();if(!i)return;const r=this._options.uniforms;-1!==r.indexOf("world")&&i.setMatrix("world",e);const s=this.getScene();-1!==r.indexOf("worldView")&&(e.multiplyToRef(s.getViewMatrix(),this._cachedWorldViewMatrix),i.setMatrix("worldView",this._cachedWorldViewMatrix)),-1!==r.indexOf("worldViewProjection")&&(e.multiplyToRef(s.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),i.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)),-1!==r.indexOf("view")&&i.setMatrix("view",s.getViewMatrix())}bindForSubMesh(e,t,i){this.bind(e,t,i._drawWrapperOverride?.effect,i)}bind(e,t,i,r){const s=r&&this._storeEffectOnSubMeshes,n=i??(s?r.effect:this.getEffect());if(!n)return;const o=this.getScene();this._activeEffect=n,this.bindOnlyWorldMatrix(e,i);const a=this._options.uniformBuffers;let l=!1;if(n&&a&&a.length>0&&o.getEngine().supportsUniformBuffers)for(let i=0;i<a.length;++i){switch(a[i]){case"Mesh":t&&(t.getMeshUniformBuffer().bindToEffect(n,"Mesh"),t.transferToEffect(e));break;case"Scene":(0,ts._8)(n,o.getSceneUniformBuffer()),o.finalizeSceneUbo(),l=!0}}const h=t&&s?this._mustRebind(o,n,r,t.visibility):o.getCachedMaterial()!==this;if(n&&h){let e;for(e in l||-1===this._options.uniforms.indexOf("view")||n.setMatrix("view",o.getViewMatrix()),l||-1===this._options.uniforms.indexOf("projection")||n.setMatrix("projection",o.getProjectionMatrix()),l||-1===this._options.uniforms.indexOf("viewProjection")||(n.setMatrix("viewProjection",o.getTransformMatrix()),this._multiview&&n.setMatrix("viewProjectionR",o._transformMatrixR)),o.activeCamera&&-1!==this._options.uniforms.indexOf("cameraPosition")&&n.setVector3("cameraPosition",o.activeCamera.globalPosition),(0,ts.f$)(t,n),(0,es.gS)(n,this,o),this._useLogarithmicDepth&&(0,ts.DL)(s?r.materialDefines:n.defines,n,o),t&&(0,ts.Yy)(o,t,n),this._textures)n.setTexture(e,this._textures[e]);for(e in this._textureArrays)n.setTextureArray(e,this._textureArrays[e]);for(e in this._ints)n.setInt(e,this._ints[e]);for(e in this._uints)n.setUInt(e,this._uints[e]);for(e in this._floats)n.setFloat(e,this._floats[e]);for(e in this._floatsArrays)n.setArray(e,this._floatsArrays[e]);for(e in this._colors3)n.setColor3(e,this._colors3[e]);for(e in this._colors3Arrays)n.setArray3(e,this._colors3Arrays[e]);for(e in this._colors4){const t=this._colors4[e];n.setFloat4(e,t.r,t.g,t.b,t.a)}for(e in this._colors4Arrays)n.setArray4(e,this._colors4Arrays[e]);for(e in this._vectors2)n.setVector2(e,this._vectors2[e]);for(e in this._vectors3)n.setVector3(e,this._vectors3[e]);for(e in this._vectors4)n.setVector4(e,this._vectors4[e]);for(e in this._quaternions)n.setQuaternion(e,this._quaternions[e]);for(e in this._matrices)n.setMatrix(e,this._matrices[e]);for(e in this._matrixArrays)n.setMatrices(e,this._matrixArrays[e]);for(e in this._matrices3x3)n.setMatrix3x3(e,this._matrices3x3[e]);for(e in this._matrices2x2)n.setMatrix2x2(e,this._matrices2x2[e]);for(e in this._vectors2Arrays)n.setArray2(e,this._vectors2Arrays[e]);for(e in this._vectors3Arrays)n.setArray3(e,this._vectors3Arrays[e]);for(e in this._vectors4Arrays)n.setArray4(e,this._vectors4Arrays[e]);for(e in this._quaternionsArrays)n.setArray4(e,this._quaternionsArrays[e]);for(e in this._uniformBuffers){const t=this._uniformBuffers[e].getBuffer();t&&n.bindUniformBuffer(t,e)}const i=o.getEngine(),a=i.setExternalTexture;if(a)for(e in this._externalTextures)a.call(i,e,this._externalTextures[e]);const h=i.setTextureSampler;if(h)for(e in this._textureSamplers)h.call(i,e,this._textureSamplers[e]);const c=i.setStorageBuffer;if(c)for(e in this._storageBuffers)c.call(i,e,this._storageBuffers[e])}if(n&&t&&(h||!this.isFrozen)){(0,ts.nR)(t,n),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(n);const e=t.bakedVertexAnimationManager;if(e&&e.isEnabled){const e=s?r._drawWrapper:this._drawWrapper;t.bakedVertexAnimationManager?.bind(n,!!e._wasPreviouslyUsingInstances)}}this._afterBind(t,n,r)}getActiveTextures(){const e=super.getActiveTextures();for(const t in this._textures)e.push(this._textures[t]);for(const t in this._textureArrays){const i=this._textureArrays[t];for(let t=0;t<i.length;t++)e.push(i[t])}return e}hasTexture(e){if(super.hasTexture(e))return!0;for(const t in this._textures)if(this._textures[t]===e)return!0;for(const t in this._textureArrays){const i=this._textureArrays[t];for(let t=0;t<i.length;t++)if(i[t]===e)return!0}return!1}clone(e){const t=Ue.p.Clone((()=>new rs(e,this.getScene(),this._shaderPath,this._options,this._storeEffectOnSubMeshes)),this);t.name=e,t.id=e,"object"==typeof t._shaderPath&&(t._shaderPath={...t._shaderPath}),this._options={...this._options},Object.keys(this._options).forEach((e=>{const t=this._options[e];Array.isArray(t)&&(this._options[e]=t.slice(0))})),this.stencil.copyTo(t.stencil);for(const e in this._textures)t.setTexture(e,this._textures[e]);for(const e in this._textureArrays)t.setTextureArray(e,this._textureArrays[e]);for(const e in this._externalTextures)t.setExternalTexture(e,this._externalTextures[e]);for(const e in this._ints)t.setInt(e,this._ints[e]);for(const e in this._uints)t.setUInt(e,this._uints[e]);for(const e in this._floats)t.setFloat(e,this._floats[e]);for(const e in this._floatsArrays)t.setFloats(e,this._floatsArrays[e]);for(const e in this._colors3)t.setColor3(e,this._colors3[e]);for(const e in this._colors3Arrays)t._colors3Arrays[e]=this._colors3Arrays[e];for(const e in this._colors4)t.setColor4(e,this._colors4[e]);for(const e in this._colors4Arrays)t._colors4Arrays[e]=this._colors4Arrays[e];for(const e in this._vectors2)t.setVector2(e,this._vectors2[e]);for(const e in this._vectors3)t.setVector3(e,this._vectors3[e]);for(const e in this._vectors4)t.setVector4(e,this._vectors4[e]);for(const e in this._quaternions)t.setQuaternion(e,this._quaternions[e]);for(const e in this._quaternionsArrays)t._quaternionsArrays[e]=this._quaternionsArrays[e];for(const e in this._matrices)t.setMatrix(e,this._matrices[e]);for(const e in this._matrixArrays)t._matrixArrays[e]=this._matrixArrays[e].slice();for(const e in this._matrices3x3)t.setMatrix3x3(e,this._matrices3x3[e]);for(const e in this._matrices2x2)t.setMatrix2x2(e,this._matrices2x2[e]);for(const e in this._vectors2Arrays)t.setArray2(e,this._vectors2Arrays[e]);for(const e in this._vectors3Arrays)t.setArray3(e,this._vectors3Arrays[e]);for(const e in this._vectors4Arrays)t.setArray4(e,this._vectors4Arrays[e]);for(const e in this._uniformBuffers)t.setUniformBuffer(e,this._uniformBuffers[e]);for(const e in this._textureSamplers)t.setTextureSampler(e,this._textureSamplers[e]);for(const e in this._storageBuffers)t.setStorageBuffer(e,this._storageBuffers[e]);return t}dispose(e,t,i){if(t){let e;for(e in this._textures)this._textures[e].dispose();for(e in this._textureArrays){const t=this._textureArrays[e];for(let e=0;e<t.length;e++)t[e].dispose()}}this._textures={},super.dispose(e,t,i)}serialize(){const e=Ue.p.Serialize(this);let t;for(t in e.customType="BABYLON.ShaderMaterial",e.uniqueId=this.uniqueId,e.options=this._options,e.shaderPath=this._shaderPath,e.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes,e.stencil=this.stencil.serialize(),e.textures={},this._textures)e.textures[t]=this._textures[t].serialize();for(t in e.textureArrays={},this._textureArrays){e.textureArrays[t]=[];const i=this._textureArrays[t];for(let r=0;r<i.length;r++)e.textureArrays[t].push(i[r].serialize())}for(t in e.ints={},this._ints)e.ints[t]=this._ints[t];for(t in e.uints={},this._uints)e.uints[t]=this._uints[t];for(t in e.floats={},this._floats)e.floats[t]=this._floats[t];for(t in e.floatsArrays={},this._floatsArrays)e.floatsArrays[t]=this._floatsArrays[t];for(t in e.colors3={},this._colors3)e.colors3[t]=this._colors3[t].asArray();for(t in e.colors3Arrays={},this._colors3Arrays)e.colors3Arrays[t]=this._colors3Arrays[t];for(t in e.colors4={},this._colors4)e.colors4[t]=this._colors4[t].asArray();for(t in e.colors4Arrays={},this._colors4Arrays)e.colors4Arrays[t]=this._colors4Arrays[t];for(t in e.vectors2={},this._vectors2){const i=this._vectors2[t];e.vectors2[t]=[i.x,i.y]}for(t in e.vectors3={},this._vectors3){const i=this._vectors3[t];e.vectors3[t]=[i.x,i.y,i.z]}for(t in e.vectors4={},this._vectors4){const i=this._vectors4[t];e.vectors4[t]=[i.x,i.y,i.z,i.w]}for(t in e.quaternions={},this._quaternions)e.quaternions[t]=this._quaternions[t].asArray();for(t in e.matrices={},this._matrices)e.matrices[t]=this._matrices[t].asArray();for(t in e.matrixArray={},this._matrixArrays)e.matrixArray[t]=this._matrixArrays[t];for(t in e.matrices3x3={},this._matrices3x3)e.matrices3x3[t]=this._matrices3x3[t];for(t in e.matrices2x2={},this._matrices2x2)e.matrices2x2[t]=this._matrices2x2[t];for(t in e.vectors2Arrays={},this._vectors2Arrays)e.vectors2Arrays[t]=this._vectors2Arrays[t];for(t in e.vectors3Arrays={},this._vectors3Arrays)e.vectors3Arrays[t]=this._vectors3Arrays[t];for(t in e.vectors4Arrays={},this._vectors4Arrays)e.vectors4Arrays[t]=this._vectors4Arrays[t];for(t in e.quaternionsArrays={},this._quaternionsArrays)e.quaternionsArrays[t]=this._quaternionsArrays[t];return e}static Parse(e,t,i){const r=Ue.p.Parse((()=>new rs(e.name,t,e.shaderPath,e.options,e.storeEffectOnSubMeshes)),e,t,i);let s;for(s in e.stencil&&r.stencil.parse(e.stencil,t,i),e.textures)r.setTexture(s,$e.g.Parse(e.textures[s],t,i));for(s in e.textureArrays){const n=e.textureArrays[s],o=[];for(let e=0;e<n.length;e++)o.push($e.g.Parse(n[e],t,i));r.setTextureArray(s,o)}for(s in e.ints)r.setInt(s,e.ints[s]);for(s in e.uints)r.setUInt(s,e.uints[s]);for(s in e.floats)r.setFloat(s,e.floats[s]);for(s in e.floatsArrays)r.setFloats(s,e.floatsArrays[s]);for(s in e.colors3)r.setColor3(s,o.v9.FromArray(e.colors3[s]));for(s in e.colors3Arrays){const t=e.colors3Arrays[s].reduce(((e,t,i)=>(i%3==0?e.push([t]):e[e.length-1].push(t),e)),[]).map((e=>o.v9.FromArray(e)));r.setColor3Array(s,t)}for(s in e.colors4)r.setColor4(s,o.ov.FromArray(e.colors4[s]));for(s in e.colors4Arrays){const t=e.colors4Arrays[s].reduce(((e,t,i)=>(i%4==0?e.push([t]):e[e.length-1].push(t),e)),[]).map((e=>o.ov.FromArray(e)));r.setColor4Array(s,t)}for(s in e.vectors2)r.setVector2(s,n.I9.FromArray(e.vectors2[s]));for(s in e.vectors3)r.setVector3(s,n.Pq.FromArray(e.vectors3[s]));for(s in e.vectors4)r.setVector4(s,n.IU.FromArray(e.vectors4[s]));for(s in e.quaternions)r.setQuaternion(s,n.PT.FromArray(e.quaternions[s]));for(s in e.matrices)r.setMatrix(s,n.uq.FromArray(e.matrices[s]));for(s in e.matrixArray)r._matrixArrays[s]=new Float32Array(e.matrixArray[s]);for(s in e.matrices3x3)r.setMatrix3x3(s,e.matrices3x3[s]);for(s in e.matrices2x2)r.setMatrix2x2(s,e.matrices2x2[s]);for(s in e.vectors2Arrays)r.setArray2(s,e.vectors2Arrays[s]);for(s in e.vectors3Arrays)r.setArray3(s,e.vectors3Arrays[s]);for(s in e.vectors4Arrays)r.setArray4(s,e.vectors4Arrays[s]);for(s in e.quaternionsArrays)r.setArray4(s,e.quaternionsArrays[s]);return r}static ParseFromFileAsync(e,t,i,r=""){return new Promise(((s,n)=>{const o=new Kr.u;o.addEventListener("readystatechange",(()=>{if(4==o.readyState)if(200==o.status){const t=JSON.parse(o.responseText),n=this.Parse(t,i||C.q.LastCreatedScene,r);e&&(n.name=e),s(n)}else n("Unable to load the ShaderMaterial")})),o.open("GET",t),o.send()}))}static ParseFromSnippetAsync(e,t,i=""){return new Promise(((r,s)=>{const n=new Kr.u;n.addEventListener("readystatechange",(()=>{if(4==n.readyState)if(200==n.status){const s=JSON.parse(JSON.parse(n.responseText).jsonPayload),o=JSON.parse(s.shaderMaterial),a=this.Parse(o,t||C.q.LastCreatedScene,i);a.snippetId=e,r(a)}else s("Unable to load the snippet "+e)})),n.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),n.send()}))}}rs.SnippetUrl="https://snippet.babylonjs.com",rs.CreateFromSnippetAsync=rs.ParseFromSnippetAsync,(0,a.Y5)("BABYLON.ShaderMaterial",rs);var ss=i(56608);class ns{constructor(){this._pickingTexture=null,this._idMap=[],this._thinIdMap=[],this._idColors=[],this._meshMaterialMap=new Map,this._meshRenderingCount=0,this._attributeName="instanceMeshID",this._shaderLanguage=0,this._pickingInProgress=!1}get shaderLanguage(){return this._shaderLanguage}get pickingInProgress(){return this._pickingInProgress}static _IdToRgb(e){ns._TempColor.r=(16711680&e)>>16,ns._TempColor.g=(65280&e)>>8,ns._TempColor.b=255&e}_getColorIdFromReadBuffer(e){return(this._readbuffer[e]<<16)+(this._readbuffer[e+1]<<8)+this._readbuffer[e+2]}static _SetColorData(e,t,i,r,s){e[t]=i/255,e[t+1]=r/255,e[t+2]=s/255,e[t+3]=1}_createRenderTarget(e,t,i){this._pickingTexture&&this._pickingTexture.dispose(),this._pickingTexture=new cr.$("pickingTexure",{width:t,height:i},e,!1,void 0,0,!1,1)}async _createColorMaterialAsync(e){this._defaultRenderMaterial&&this._defaultRenderMaterial.dispose(),this._defaultRenderMaterial=null;e.getEngine().isWebGPU&&(this._shaderLanguage=1);const t={attributes:[ss.R.PositionKind,this._attributeName,"bakedVertexAnimationSettingsInstanced"],uniforms:["world","viewProjection","meshID"],needAlphaBlending:!1,defines:[],useClipPlane:null,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this.shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,99949)),Promise.resolve().then(i.bind(i,45095))]):await Promise.all([Promise.resolve().then(i.bind(i,29698)),Promise.resolve().then(i.bind(i,99992))])}};this._defaultRenderMaterial=new rs("pickingShader",e,"picking",t,!1),this._defaultRenderMaterial.onBindObservable.add(this._materialBindCallback,void 0,void 0,this)}_materialBindCallback(e){if(!e)return;const t=this._meshMaterialMap.get(e).getEffect();e.hasInstances||e.isAnInstance||e.hasThinInstances||t.setColor4("meshID",this._idColors[e.uniqueId],1),this._meshRenderingCount++}_generateColorData(e,t,i,r,s,n,o){const a=new Float32Array(4*(e+1));ns._SetColorData(a,0,r,s,n);for(let i=0;i<e;i++)ns._IdToRgb(t),o(i,t),ns._SetColorData(a,4*(i+1),ns._TempColor.r,ns._TempColor.g,ns._TempColor.b),t++;return a}_generateThinInstanceColorData(e,t,i){const r=new Float32Array(4*e);for(let s=0;s<e;s++)ns._IdToRgb(t),i(s,t),ns._SetColorData(r,4*s,ns._TempColor.r,ns._TempColor.g,ns._TempColor.b),t++;return r}setPickingList(e){if(this._pickableMeshes){for(let e=0;e<this._pickableMeshes.length;e++){const t=this._pickableMeshes[e];t.hasInstances&&t.removeVerticesData(this._attributeName),t.hasThinInstances&&t.thinInstanceSetBuffer(this._attributeName,null),this._pickingTexture&&this._pickingTexture.setMaterialForRendering(t,void 0);const i=this._meshMaterialMap.get(t);i!==this._defaultRenderMaterial&&i.onBindObservable.removeCallback(this._materialBindCallback)}this._pickableMeshes.length=0,this._meshMaterialMap.clear(),this._idMap.length=0,this._thinIdMap.length=0,this._idColors.length=0,this._pickingTexture&&(this._pickingTexture.renderList=[])}if(!e||0===e.length)return;this._pickableMeshes=e;const t=("mesh"in e[0]?e[0].mesh:e[0]).getScene(),i=t.getEngine(),r=i.getRenderWidth(),s=i.getRenderHeight();if(this._pickingTexture){const e=this._pickingTexture.getSize();e.width===r&&e.height===s&&this._cachedScene===t||this._createRenderTarget(t,r,s)}else this._createRenderTarget(t,r,s);this._cachedScene&&this._cachedScene===t||this._createColorMaterialAsync(t),this._cachedScene=t,this._engine=t.getEngine();for(let t=0;t<e.length;t++){const i=e[t];"mesh"in i?(this._meshMaterialMap.set(i.mesh,i.material),e[t]=i.mesh):this._meshMaterialMap.set(i,this._defaultRenderMaterial)}this._pickingTexture.renderList=[];let n=1;for(let e=0;e<this._pickableMeshes.length;e++){const t=this._pickableMeshes[e],i=this._meshMaterialMap.get(t);if(i!==this._defaultRenderMaterial&&i.onBindObservable.add(this._materialBindCallback,void 0,void 0,this),this._pickingTexture.setMaterialForRendering(t,i),this._pickingTexture.renderList.push(t),!t.isAnInstance)if(ns._IdToRgb(n),t.hasThinInstances){const i=this._generateThinInstanceColorData(t.thinInstanceCount,n,((t,i)=>{this._thinIdMap[i]={meshId:e,thinId:t}}));n+=t.thinInstanceCount,t.thinInstanceSetBuffer(this._attributeName,i,4)}else if(this._idMap[n]=e,n++,t.hasInstances){const i=t.instances,r=this._generateColorData(i.length,n,e,ns._TempColor.r,ns._TempColor.g,ns._TempColor.b,((e,t)=>{const r=i[e];this._idMap[t]=this._pickableMeshes.indexOf(r)}));n+=i.length;const s=t.getEngine(),o=new ss.R(s,r,this._attributeName,!1,!1,4,!0);t.setVerticesBuffer(o,!0)}else this._idColors[t.uniqueId]=o.v9.FromInts(ns._TempColor.r,ns._TempColor.g,ns._TempColor.b)}}async pickAsync(e,t,i=!1){if(this._pickingInProgress)return null;if(!this._pickableMeshes||0===this._pickableMeshes.length)return null;const{x:r,y:s,rttSizeW:n,rttSizeH:o}=this._prepareForPicking(e,t);if(r<0||s<0||r>=n||s>=o)return null;this._pickingInProgress=!0;const a=o-s-1;return this._preparePickingBuffer(this._engine,n,o,r,a),this._executePicking(r,a,i)}async multiPickAsync(e,t=!1){if(this._pickingInProgress)return null;if(!this._pickableMeshes||0===this._pickableMeshes.length||0===e.length)return null;if(1===e.length){const i=await this.pickAsync(e[0].x,e[0].y,t);return{meshes:[i?.mesh??null],thinInstanceIndexes:i?.thinInstanceIndex?[i.thinInstanceIndex]:void 0}}this._pickingInProgress=!0;let i=e[0].x,r=e[0].x,s=e[0].y,n=e[0].y;for(let t=1;t<e.length;t++){const{x:o,y:a}=e[t];i=Math.min(i,o),r=Math.max(r,o),s=Math.min(s,a),n=Math.max(n,a)}const{rttSizeW:o,rttSizeH:a}=this._prepareForPicking(i,s),l=Math.max(r-i,1),h=Math.max(n-s,1),c=a-n-1;return this._preparePickingBuffer(this._engine,o,a,i,c,l,h),this._executeMultiPicking(e,i,n,a,l,h,t)}_prepareForPicking(e,t){const i=this._cachedScene.getEngine(),r=i.getRenderWidth(),s=i.getRenderHeight(),n=1/i._hardwareScalingLevel;return{x:n*e|0,y:n*t|0,rttSizeW:r,rttSizeH:s}}_preparePickingBuffer(e,t,i,r,s,n=1,a=1){this._meshRenderingCount=0;const l=e.isWebGPU?4*n*a+255&-256:4*n*a;(!this._readbuffer||this._readbuffer.length<l)&&(this._readbuffer=new Uint8Array(l));const h=this._pickingTexture.getSize();h.width===t&&h.height===i||(this._createRenderTarget(this._cachedScene,t,i),this._updateRenderList()),this._pickingTexture.clearColor=new o.ov(0,0,0,0),this._pickingTexture.onBeforeRender=()=>{this._enableScissor(r,s,n,a)},this._cachedScene.customRenderTargets.push(this._pickingTexture)}_executePicking(e,t,i){return new Promise(((r,s)=>{if(!this._pickingTexture)return this._pickingInProgress=!1,void s();this._pickingTexture.onAfterRender=async()=>{if(this._disableScissor(),this._checkRenderStatus()){this._pickingTexture.onAfterRender=null;let s,n=null;const o=this._cachedScene.customRenderTargets.indexOf(this._pickingTexture);if(o>-1&&this._cachedScene.customRenderTargets.splice(o,1),await this._readTexturePixelsAsync(e,t)){const e=this._getColorIdFromReadBuffer(0);this._thinIdMap[e]?(n=this._pickableMeshes[this._thinIdMap[e].meshId],s=this._thinIdMap[e].thinId):n=this._pickableMeshes[this._idMap[e]]}i&&this.dispose(),this._pickingInProgress=!1,r(n?{mesh:n,thinInstanceIndex:s}:null)}}}))}_executeMultiPicking(e,t,i,r,s,n,o){return new Promise(((a,l)=>{if(!this._pickingTexture)return this._pickingInProgress=!1,void l();this._pickingTexture.onAfterRender=async()=>{if(this._disableScissor(),this._checkRenderStatus()){this._pickingTexture.onAfterRender=null;const l=[],h=[];if(await this._readTexturePixelsAsync(t,r-i-1,s,n))for(let r=0;r<e.length;r++){const{pickedMesh:n,thinInstanceIndex:o}=this._getMeshFromMultiplePoints(e[r].x,e[r].y,t,i,s);l.push(n),h.push(o??0)}o&&this.dispose(),this._pickingInProgress=!1,a({meshes:l,thinInstanceIndexes:h})}}}))}_enableScissor(e,t,i=1,r=1){this._engine.enableScissor&&this._engine.enableScissor(e,t,i,r)}_disableScissor(){this._engine.disableScissor&&this._engine.disableScissor()}_checkRenderStatus(){if(this._meshRenderingCount>0){const e=this._cachedScene.customRenderTargets.indexOf(this._pickingTexture);return e>-1&&this._cachedScene.customRenderTargets.splice(e,1),!0}return this._meshRenderingCount=0,!1}_getMeshFromMultiplePoints(e,t,i,r,s){let n=4*(e-i-1),o=(r-t-1)*s*4;n=Math.max(n,0),o=Math.max(o,0);const a=this._getColorIdFromReadBuffer(n+o);let l,h=null;return a>0&&(this._thinIdMap[a]?(h=this._pickableMeshes[this._thinIdMap[a].meshId],l=this._thinIdMap[a].thinId):h=this._pickableMeshes[this._idMap[a]]),{pickedMesh:h,thinInstanceIndex:l}}_updateRenderList(){this._pickingTexture.renderList=[];for(const e of this._pickableMeshes)this._pickingTexture.setMaterialForRendering(e,this._meshMaterialMap.get(e)),this._pickingTexture.renderList.push(e)}async _readTexturePixelsAsync(e,t,i=1,r=1){if(!this._cachedScene||!this._pickingTexture?._texture)return!1;const s=this._cachedScene.getEngine();return await s._readTexturePixels(this._pickingTexture._texture,i,r,-1,0,this._readbuffer,!0,!0,e,t),!0}dispose(){this.setPickingList(null),this._cachedScene=null,this._pickingTexture?.dispose(),this._pickingTexture=null,this._defaultRenderMaterial?.dispose(),this._defaultRenderMaterial=null}}ns._TempColor={r:0,g:0,b:0};var os=i(29698),as=i(99992),ls=i(99949),hs=i(45095),cs=i(19125),us=i(2940);class ds{constructor(e,t,i,r=""){let n;this.defines="",this.onCompiled=null,this.onError=null,this.uniqueId=0,this.onCompileObservable=new s.cP,this.onErrorObservable=new s.cP,this.onBindObservable=new s.cP,this._wasPreviouslyReady=!1,this._isReady=!1,this._compilationError="",this._key="",this._computeSourceCodeOverride="",this._pipelineContext=null,this._computeSourceCode="",this._rawComputeSourceCode="",this._shaderLanguage=1,this.name=e,this._key=r,this._engine=i,this.uniqueId=ds._UniqueIdSeed++,this.defines=t.defines??"",this.onError=t.onError,this.onCompiled=t.onCompiled,this._entryPoint=t.entryPoint??"main",this._shaderStore=qi.l.GetShadersStore(this._shaderLanguage),this._shaderRepository=qi.l.GetShadersRepository(this._shaderLanguage),this._includeShaderStore=qi.l.GetIncludesShadersStore(this._shaderLanguage);const o=(0,Ai.BA)()?this._engine.getHostDocument():null;n="string"==typeof e?e:e.computeSource?"source:"+e.computeSource:e.computeElement?o?.getElementById(e.computeElement)||e.computeElement:e.compute||e;const a={defines:this.defines.split("\n"),indexParameters:void 0,isFragment:!1,shouldUseHighPrecisionShader:!1,processor:null,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:this._shaderRepository,includesShadersStore:this._includeShaderStore,version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:null,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:(e,t,i)=>{if(!i)return t;for(const e of i){const i=e.replace("#define","").replace(";","").trim().split(" ");if(2===i.length){const e=i[0],r=i[1];isNaN(parseInt(r))&&isNaN(parseFloat(r))||(t=`const ${e} = ${r};\n`+t)}}return t}};this._loadShader(n,"Compute","",(i=>{(0,cs.pB)(a),(0,cs.jC)(i,a,(r=>{this._rawComputeSourceCode=i,t.processFinalCode&&(r=t.processFinalCode(r));const s=(0,cs.nO)(r,"",a);this._useFinalCode(s.vertexCode,e)}),this._engine)}))}_useFinalCode(e,t){if(t){const i=t.computeElement||t.compute||t.spectorName||t;this._computeSourceCode="//#define SHADER_NAME compute:"+i+"\n"+e}else this._computeSourceCode=e;this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return!!this._isReady||!!this._pipelineContext&&this._pipelineContext.isReady}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getCompilationError(){return this._compilationError}executeWhenCompiled(e){this.isReady()?e(this):(this.onCompileObservable.add((t=>{e(t)})),this._pipelineContext&&!this._pipelineContext.isAsync||this._checkIsReady(null))}_checkIsReady(e){(0,us.F)((()=>this._isReadyInternal()),(()=>{}),(t=>{this._processCompilationErrors(t,e)}),void 0,void 0,!1)}_loadShader(e,t,i,r){if("undefined"!=typeof HTMLElement&&e instanceof HTMLElement){return void r((0,Ai.Zl)(e))}if("source:"===e.substring(0,7))return void r(e.substring(7));if("base64:"===e.substring(0,7)){return void r(window.atob(e.substring(7)))}if(this._shaderStore[e+t+"Shader"])return void r(this._shaderStore[e+t+"Shader"]);if(i&&this._shaderStore[e+i+"Shader"])return void r(this._shaderStore[e+i+"Shader"]);let s;s="."===e[0]||"/"===e[0]||e.indexOf("http")>-1?e:this._shaderRepository+e,this._engine._loadFile(s+"."+t.toLowerCase()+".fx",r)}get computeSourceCode(){return this._computeSourceCodeOverride?this._computeSourceCodeOverride:this._pipelineContext?._getComputeShaderCode()??this._computeSourceCode}get rawComputeSourceCode(){return this._rawComputeSourceCode}_prepareEffect(){const e=this.defines,t=this._pipelineContext;this._isReady=!1;try{const i=this._engine;this._pipelineContext=i.createComputePipelineContext(),this._pipelineContext._name=this._key,i._prepareComputePipelineContext(this._pipelineContext,this._computeSourceCodeOverride?this._computeSourceCodeOverride:this._computeSourceCode,this._rawComputeSourceCode,this._computeSourceCodeOverride?null:e,this._entryPoint),i._executeWhenComputeStateIsCompiled(this._pipelineContext,(e=>{e&&e.numErrors>0?this._processCompilationErrors(e,t):(this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),t&&this.getEngine()._deleteComputePipelineContext(t))})),this._pipelineContext.isAsync&&this._checkIsReady(t)}catch(e){this._processCompilationErrors(e,t)}}_processCompilationErrors(e,t=null){if(this._compilationError="",m.V.Error("Unable to compile compute effect:"),this.defines&&m.V.Error("Defines:\n"+this.defines),ds.LogShaderCodeOnCompilationError){const e=this._pipelineContext?._getComputeShaderCode();e&&(m.V.Error("Compute code:"),m.V.Error(e))}if("string"==typeof e)this._compilationError=e,m.V.Error("Error: "+this._compilationError);else for(const t of e.messages){let e="";void 0!==t.line&&(e+="Line "+t.line+", "),void 0!==t.offset&&(e+="Offset "+t.offset+", "),void 0!==t.length&&(e+="Length "+t.length+", "),e+=t.type+": "+t.text,this._compilationError&&(this._compilationError+="\n"),this._compilationError+=e,m.V.Error(e)}t&&(this._pipelineContext=t,this._isReady=!0),this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseComputeEffect(this)}static RegisterShader(e,t){qi.l.GetShadersStore(1)[`${e}ComputeShader`]=t}}ds._UniqueIdSeed=0,ds.LogShaderCodeOnCompilationError=!0;var ps=i(72266),ms=i(84766),fs=i(20863);class _s{constructor(e){this._engine=e}async _initializePlatform(){if(!this._platform)if(this._engine.getCaps().supportComputeShaders){const e=await Promise.resolve().then(i.bind(i,28011));this._platform=new e.ComputeShaderBoundingHelper(this._engine)}else{if(!this._engine.getCaps().supportTransformFeedbacks)throw new Error("Your engine does not support Compute Shaders or Transform Feedbacks");{const e=await Promise.resolve().then(i.bind(i,17301));this._platform=new e.TransformFeedbackBoundingHelper(this._engine)}}}async computeAsync(e){return await this._initializePlatform(),this._platform.processAsync(e)}async batchInitializeAsync(e){return await this._initializePlatform(),this._platform.registerMeshListAsync(e)}batchProcess(){this._platform.processMeshList()}async batchFetchResultsAsync(){return this._platform.fetchResultsForMeshListAsync()}dispose(){this._platform.dispose()}}var gs=i(17301),xs=i(28011),vs=i(27906),Ss=i(17931);class bs{constructor(e,t,i,r,s,n){this.entries=[],this._boundingVectors=new Array,this._capacity=i,this._depth=r,this._maxDepth=s,this._creationFunc=n,this._minPoint=e,this._maxPoint=t,this._boundingVectors.push(e.clone()),this._boundingVectors.push(t.clone()),this._boundingVectors.push(e.clone()),this._boundingVectors[2].x=t.x,this._boundingVectors.push(e.clone()),this._boundingVectors[3].y=t.y,this._boundingVectors.push(e.clone()),this._boundingVectors[4].z=t.z,this._boundingVectors.push(t.clone()),this._boundingVectors[5].z=e.z,this._boundingVectors.push(t.clone()),this._boundingVectors[6].x=e.x,this._boundingVectors.push(t.clone()),this._boundingVectors[7].y=e.y}get capacity(){return this._capacity}get minPoint(){return this._minPoint}get maxPoint(){return this._maxPoint}addEntry(e){if(this.blocks)for(let t=0;t<this.blocks.length;t++){this.blocks[t].addEntry(e)}else this._creationFunc(e,this),this.entries.length>this.capacity&&this._depth<this._maxDepth&&this.createInnerBlocks()}removeEntry(e){if(this.blocks){for(let t=0;t<this.blocks.length;t++){this.blocks[t].removeEntry(e)}return}const t=this.entries.indexOf(e);t>-1&&this.entries.splice(t,1)}addEntries(e){for(let t=0;t<e.length;t++){const i=e[t];this.addEntry(i)}}select(e,t,i){if(ms.I.IsInFrustum(this._boundingVectors,e)){if(this.blocks){for(let r=0;r<this.blocks.length;r++){this.blocks[r].select(e,t,i)}return}i?t.concat(this.entries):t.concatWithNoDuplicate(this.entries)}}intersects(e,t,i,r){if(ms.I.IntersectsSphere(this._minPoint,this._maxPoint,e,t)){if(this.blocks){for(let s=0;s<this.blocks.length;s++){this.blocks[s].intersects(e,t,i,r)}return}r?i.concat(this.entries):i.concatWithNoDuplicate(this.entries)}}intersectsRay(e,t){if(e.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(let i=0;i<this.blocks.length;i++){this.blocks[i].intersectsRay(e,t)}return}t.concatWithNoDuplicate(this.entries)}}createInnerBlocks(){bs._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc),this.entries.splice(0)}static _CreateBlocks(e,t,i,r,s,o,a,l){a.blocks=new Array;const h=new n.Pq((t.x-e.x)/2,(t.y-e.y)/2,(t.z-e.z)/2);for(let t=0;t<2;t++)for(let n=0;n<2;n++)for(let c=0;c<2;c++){const u=e.add(h.multiplyByFloats(t,n,c)),d=e.add(h.multiplyByFloats(t+1,n+1,c+1)),p=new bs(u,d,r,s+1,o,l);p.addEntries(i),a.blocks.push(p)}}}class ys{constructor(e,t,i=2){this.maxDepth=i,this.dynamicContent=[],this._maxBlockCapacity=t||64,this._selectionContent=new Ss.b(1024),this._creationFunc=e}update(e,t,i){bs._CreateBlocks(e,t,i,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)}addMesh(e){for(let t=0;t<this.blocks.length;t++){this.blocks[t].addEntry(e)}}removeMesh(e){for(let t=0;t<this.blocks.length;t++){this.blocks[t].removeEntry(e)}}select(e,t){this._selectionContent.reset();for(let i=0;i<this.blocks.length;i++){this.blocks[i].select(e,this._selectionContent,t)}return t?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersects(e,t,i){this._selectionContent.reset();for(let r=0;r<this.blocks.length;r++){this.blocks[r].intersects(e,t,this._selectionContent,i)}return i?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersectsRay(e){this._selectionContent.reset();for(let t=0;t<this.blocks.length;t++){this.blocks[t].intersectsRay(e,this._selectionContent)}return this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}}ys.CreationFuncForMeshes=(e,t)=>{const i=e.getBoundingInfo();!e.isBlocked&&i.boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)&&t.entries.push(e)},ys.CreationFuncForSubMeshes=(e,t)=>{e.getBoundingInfo().boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)&&t.entries.push(e)};var Ps=i(35985);it.Z.prototype.createOrUpdateSelectionOctree=function(e=64,t=2){let i=this._getComponent(Ei.v.NAME_OCTREE);i||(i=new Ts(this),this._addComponent(i)),this._selectionOctree||(this._selectionOctree=new ys(ys.CreationFuncForMeshes,e,t));const r=this.getWorldExtends();return this._selectionOctree.update(r.min,r.max,this.meshes),this._selectionOctree},Object.defineProperty(it.Z.prototype,"selectionOctree",{get:function(){return this._selectionOctree},enumerable:!0,configurable:!0}),Ps.u.prototype.createOrUpdateSubmeshesOctree=function(e=64,t=2){const i=this.getScene();let r=i._getComponent(Ei.v.NAME_OCTREE);r||(r=new Ts(i),i._addComponent(r)),this._submeshesOctree||(this._submeshesOctree=new ys(ys.CreationFuncForSubMeshes,e,t)),this.computeWorldMatrix(!0);const s=this.getBoundingInfo().boundingBox;return this._submeshesOctree.update(s.minimumWorld,s.maximumWorld,this.subMeshes),this._submeshesOctree};class Ts{constructor(e){this.name=Ei.v.NAME_OCTREE,this.checksIsEnabled=!0,this._tempRay=new st.Ray(n.Pq.Zero(),new n.Pq(1,1,1)),(e=e||C.q.LastCreatedScene)&&(this.scene=e,this.scene.getActiveMeshCandidates=()=>this.getActiveMeshCandidates(),this.scene.getActiveSubMeshCandidates=e=>this.getActiveSubMeshCandidates(e),this.scene.getCollidingSubMeshCandidates=(e,t)=>this.getCollidingSubMeshCandidates(e,t),this.scene.getIntersectingSubMeshCandidates=(e,t)=>this.getIntersectingSubMeshCandidates(e,t))}register(){this.scene.onMeshRemovedObservable.add((e=>{const t=this.scene.selectionOctree;if(null!=t){const i=t.dynamicContent.indexOf(e);-1!==i&&t.dynamicContent.splice(i,1)}})),this.scene.onMeshImportedObservable.add((e=>{const t=this.scene.selectionOctree;null!=t&&t.addMesh(e)}))}getActiveMeshCandidates(){return this.scene._selectionOctree?.select(this.scene.frustumPlanes)||this.scene._getDefaultMeshCandidates()}getActiveSubMeshCandidates(e){if(e._submeshesOctree&&e.useOctreeForRenderingSelection){return e._submeshesOctree.select(this.scene.frustumPlanes)}return this.scene._getDefaultSubMeshCandidates(e)}getIntersectingSubMeshCandidates(e,t){if(e._submeshesOctree&&e.useOctreeForPicking){st.Ray.TransformToRef(t,e.getWorldMatrix(),this._tempRay);return e._submeshesOctree.intersectsRay(this._tempRay)}return this.scene._getDefaultSubMeshCandidates(e)}getCollidingSubMeshCandidates(e,t){if(e._submeshesOctree&&e.useOctreeForCollisions){const i=t._velocityWorldLength+Math.max(t._radius.x,t._radius.y,t._radius.z);return e._submeshesOctree.intersects(t._basePointWorld,i)}return this.scene._getDefaultSubMeshCandidates(e)}rebuild(){}dispose(){}}function Cs(e){const t=e.height||2;let i=0===e.diameterTop?0:e.diameterTop||e.diameter||1,r=0===e.diameterBottom?0:e.diameterBottom||e.diameter||1;i=i||1e-5,r=r||1e-5;const s=0|(e.tessellation||24),a=0|(e.subdivisions||1),l=!!e.hasRings,h=!!e.enclose,c=0===e.cap?0:e.cap||tt.e.CAP_ALL,u=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1,d=0===e.sideOrientation?0:e.sideOrientation||ot.P.DEFAULTSIDE,p=e.faceUV||new Array(3),m=e.faceColors,f=2+(1+(1!==u&&h?2:0))*(l?a:1);let _;for(_=0;_<f;_++)m&&void 0===m[_]&&(m[_]=new o.ov(1,1,1,1));for(_=0;_<f;_++)p&&void 0===p[_]&&(p[_]=new n.IU(0,0,1,1));const g=[],x=[],v=[],S=[],b=[],y=2*Math.PI*u/s;let P,T,C;const E=(r-i)/2/t,A=n.Pq.Zero(),I=n.Pq.Zero(),R=n.Pq.Zero(),M=n.Pq.Zero(),D=n.Pq.Zero(),O=Mt._0.Y;let N,w,F,B=1,V=1,L=0,k=0;for(N=0;N<=a;N++)for(T=N/a,C=(T*(i-r)+r)/2,B=l&&0!==N&&N!==a?2:1,F=0;F<B;F++){for(l&&(V+=F),h&&(V+=2*F),w=0;w<=s;w++)P=w*y,A.x=Math.cos(-P)*C,A.y=-t/2+T*t,A.z=Math.sin(-P)*C,0===i&&N===a?(I.x=v[v.length-3*(s+1)],I.y=v[v.length-3*(s+1)+1],I.z=v[v.length-3*(s+1)+2]):(I.x=A.x,I.z=A.z,I.y=Math.sqrt(I.x*I.x+I.z*I.z)*E,I.normalize()),0===w&&(R.copyFrom(A),M.copyFrom(I)),x.push(A.x,A.y,A.z),v.push(I.x,I.y,I.z),k=l?L!==V?p[V].y:p[V].w:p[V].y+(p[V].w-p[V].y)*T,S.push(p[V].x+(p[V].z-p[V].x)*w/s,at.rX?1-k:k),m&&b.push(m[V].r,m[V].g,m[V].b,m[V].a);1!==u&&h&&(x.push(A.x,A.y,A.z),x.push(0,A.y,0),x.push(0,A.y,0),x.push(R.x,R.y,R.z),n.Pq.CrossToRef(O,I,D),D.normalize(),v.push(D.x,D.y,D.z,D.x,D.y,D.z),n.Pq.CrossToRef(M,O,D),D.normalize(),v.push(D.x,D.y,D.z,D.x,D.y,D.z),k=l?L!==V?p[V+1].y:p[V+1].w:p[V+1].y+(p[V+1].w-p[V+1].y)*T,S.push(p[V+1].x,at.rX?1-k:k),S.push(p[V+1].z,at.rX?1-k:k),k=l?L!==V?p[V+2].y:p[V+2].w:p[V+2].y+(p[V+2].w-p[V+2].y)*T,S.push(p[V+2].x,at.rX?1-k:k),S.push(p[V+2].z,at.rX?1-k:k),m&&(b.push(m[V+1].r,m[V+1].g,m[V+1].b,m[V+1].a),b.push(m[V+1].r,m[V+1].g,m[V+1].b,m[V+1].a),b.push(m[V+2].r,m[V+2].g,m[V+2].b,m[V+2].a),b.push(m[V+2].r,m[V+2].g,m[V+2].b,m[V+2].a))),L!==V&&(L=V)}const G=1!==u&&h?s+4:s;for(N=0,V=0;V<a;V++){let e=0,t=0,i=0,r=0;for(w=0;w<s;w++)e=N*(G+1)+w,t=(N+1)*(G+1)+w,i=N*(G+1)+(w+1),r=(N+1)*(G+1)+(w+1),g.push(e,t,i),g.push(r,i,t);1!==u&&h&&(g.push(e+2,t+2,i+2),g.push(r+2,i+2,t+2),g.push(e+4,t+4,i+4),g.push(r+4,i+4,t+4)),N=l?N+2:N+1}const z=e=>{const o=e?i/2:r/2;if(0===o)return;let a,l,h;const c=e?p[f-1]:p[0];let d=null;m&&(d=e?m[f-1]:m[0]);const _=x.length/3,y=e?t/2:-t/2,P=new n.Pq(0,y,0);x.push(P.x,P.y,P.z),v.push(0,e?1:-1,0);const T=c.y+.5*(c.w-c.y);S.push(c.x+.5*(c.z-c.x),at.rX?1-T:T),d&&b.push(d.r,d.g,d.b,d.a);const C=new n.I9(.5,.5);for(h=0;h<=s;h++){a=2*Math.PI*h*u/s;const t=Math.cos(-a),i=Math.sin(-a);l=new n.Pq(t*o,y,i*o);const r=new n.I9(t*C.x+.5,i*C.y+.5);x.push(l.x,l.y,l.z),v.push(0,e?1:-1,0);const p=c.y+(c.w-c.y)*r.y;S.push(c.x+(c.z-c.x)*r.x,at.rX?1-p:p),d&&b.push(d.r,d.g,d.b,d.a)}for(h=0;h<s;h++)e?(g.push(_),g.push(_+(h+2)),g.push(_+(h+1))):(g.push(_),g.push(_+(h+1)),g.push(_+(h+2)))};c!==tt.e.CAP_START&&c!==tt.e.CAP_ALL||z(!1),c!==tt.e.CAP_END&&c!==tt.e.CAP_ALL||z(!0),ot.P._ComputeSides(d,x,g,v,S,e.frontUVs,e.backUVs);const U=new ot.P;return U.indices=g,U.positions=x,U.normals=v,U.uvs=S,m&&(U.colors=b),U}function Es(e,t={},i){const r=new tt.e(e,i);t.sideOrientation=tt.e._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;return Cs(t).applyToMesh(r,t.updatable),r}const As={CreateCylinder:Es};ot.P.CreateCylinder=Cs,tt.e.CreateCylinder=(e,t,i,r,s,n,o,a,l)=>{void 0!==o&&o instanceof it.Z||(void 0!==o&&(l=a||tt.e.DEFAULTSIDE,a=o),o=n,n=1);return Es(e,{height:t,diameterTop:i,diameterBottom:r,tessellation:s,subdivisions:n,sideOrientation:l,updatable:a},o)};var Is=i(71513);class Rs{getRenderCamera(e){if(this._renderCamera)return this._renderCamera;{let t;return t=this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:this.originalScene.activeCamera,e&&t&&t.isRigCamera?t.rigParent:t}}setRenderCamera(e){this._renderCamera=e}_getSharedGizmoLight(){return this._sharedGizmoLight||(this._sharedGizmoLight=new Is.g("shared gizmo light",new n.Pq(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=o.v9.Gray()),this._sharedGizmoLight}static get DefaultUtilityLayer(){return null==Rs._DefaultUtilityLayer?Rs._CreateDefaultUtilityLayerFromScene(C.q.LastCreatedScene):Rs._DefaultUtilityLayer}static _CreateDefaultUtilityLayerFromScene(e){return Rs._DefaultUtilityLayer=new Rs(e),Rs._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce((()=>{Rs._DefaultUtilityLayer=null})),Rs._DefaultUtilityLayer}static get DefaultKeepDepthUtilityLayer(){return null==Rs._DefaultKeepDepthUtilityLayer&&(Rs._DefaultKeepDepthUtilityLayer=new Rs(C.q.LastCreatedScene),Rs._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,Rs._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce((()=>{Rs._DefaultKeepDepthUtilityLayer=null}))),Rs._DefaultKeepDepthUtilityLayer}constructor(e,t=!0,i=!1){this.originalScene=e,this.handleEvents=t,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new s.cP,this.utilityLayerScene=new it.Z(e.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=e.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),t&&(this._originalPointerObserver=e.onPrePointerObservable.add((t=>{if(!this.utilityLayerScene.activeCamera)return;if(!this.pickingEnabled)return;if(!this.processAllEvents&&t.type!==rt.Zp.POINTERMOVE&&t.type!==rt.Zp.POINTERUP&&t.type!==rt.Zp.POINTERDOWN&&t.type!==rt.Zp.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=e.pointerX,this.utilityLayerScene.pointerY=e.pointerY;const i=t.event;if(e.isPointerCaptured(i.pointerId))return void(this._pointerCaptures[i.pointerId]=!1);const r=i=>{let r=null;if(t.nearInteractionPickingInfo)r=t.nearInteractionPickingInfo.pickedMesh.getScene()==i?t.nearInteractionPickingInfo:new Xr.G;else if(i!==this.utilityLayerScene&&t.originalPickingInfo)r=t.originalPickingInfo;else{let s=null;this._renderCamera&&(s=i._activeCamera,i._activeCamera=this._renderCamera,t.ray=null),r=t.ray?i.pickWithRay(t.ray):i.pick(e.pointerX,e.pointerY),s&&(i._activeCamera=s)}return r},s=r(this.utilityLayerScene);if(!t.ray&&s&&(t.ray=s.ray),t.originalPickingInfo?.aimTransform&&s&&(s.aimTransform=t.originalPickingInfo.aimTransform,s.gripTransform=t.originalPickingInfo.gripTransform),this.utilityLayerScene.onPrePointerObservable.notifyObservers(t),this.onlyCheckPointerDownEvents&&t.type!=rt.Zp.POINTERDOWN)return t.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new rt.mx(t.type,t.event,s),t.type),void(t.type===rt.Zp.POINTERUP&&this._pointerCaptures[i.pointerId]&&(this._pointerCaptures[i.pointerId]=!1));if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)s&&s.hit&&(t.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new rt.mx(t.type,t.event,s),t.type),t.skipOnPointerObservable=!0);else{const i=r(e),n=t.event;i&&s&&(0===s.distance&&i.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(i.pickedMesh)?(this._notifyObservers(t,i,n),t.skipOnPointerObservable=!0):t.type===rt.Zp.POINTERDOWN?(this._pointerCaptures[n.pointerId]=!0,this._notifyObservers(t,i,n)):t.type!==rt.Zp.POINTERMOVE&&t.type!==rt.Zp.POINTERUP||(this._lastPointerEvents[n.pointerId]&&(this.onPointerOutObservable.notifyObservers(n.pointerId),delete this._lastPointerEvents[n.pointerId]),this._notifyObservers(t,i,n)):!this._pointerCaptures[n.pointerId]&&(s.distance<i.distance||0===i.distance)?(this._notifyObservers(t,s,n),t.skipOnPointerObservable||(t.skipOnPointerObservable=s.distance>0)):!this._pointerCaptures[n.pointerId]&&s.distance>=i.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(i.pickedMesh)?(this._notifyObservers(t,i,n),t.skipOnPointerObservable=!0):(t.type!==rt.Zp.POINTERMOVE&&t.type!==rt.Zp.POINTERUP||this._lastPointerEvents[n.pointerId]&&(this.onPointerOutObservable.notifyObservers(n.pointerId),delete this._lastPointerEvents[n.pointerId]),this._notifyObservers(t,s,n))),t.type===rt.Zp.POINTERUP&&this._pointerCaptures[n.pointerId]&&(this._pointerCaptures[n.pointerId]=!1))}})),this._originalPointerObserver&&e.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,i||(this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add((e=>{this.shouldRender&&e==this.getRenderCamera()&&this.render()}))),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add((()=>{this.dispose()})),this._updateCamera()}_notifyObservers(e,t,i){e.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new rt.mx(e.type,e.event,t),e.type),this._lastPointerEvents[i.pointerId]=!0)}render(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){const e=this.utilityLayerScene.activeCamera.getScene(),t=this.utilityLayerScene.activeCamera;t._scene=this.utilityLayerScene,t.leftCamera&&(t.leftCamera._scene=this.utilityLayerScene),t.rightCamera&&(t.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),t._scene=e,t.leftCamera&&(t.leftCamera._scene=e),t.rightCamera&&(t.rightCamera._scene=e)}}dispose(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()}_updateCamera(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()}}Rs._DefaultUtilityLayer=null,Rs._DefaultKeepDepthUtilityLayer=null;var Ms,Ds,Os,Ns=i(64704);!function(e){e[e.Origin=0]="Origin",e[e.Pivot=1]="Pivot"}(Ms||(Ms={})),function(e){e[e.World=0]="World",e[e.Local=1]="Local"}(Ds||(Ds={}));class ws{set scaleRatio(e){this._scaleRatio=e}get scaleRatio(){return this._scaleRatio}get isHovered(){return this._isHovered}get attachedMesh(){return this._attachedMesh}set attachedMesh(e){this._attachedMesh=e,e&&(this._attachedNode=e),this._rootMesh.setEnabled(!!e),this._attachedNodeChanged(e)}get attachedNode(){return this._attachedNode}set attachedNode(e){this._attachedNode=e,this._attachedMesh=null,this._rootMesh.setEnabled(!!e),this._attachedNodeChanged(e)}setCustomMesh(e){if(e.getScene()!=this.gizmoLayer.utilityLayerScene)throw"When setting a custom mesh on a gizmo, the custom meshes scene must be the same as the gizmos (eg. gizmo.gizmoLayer.utilityLayerScene)";this._rootMesh.getChildMeshes().forEach((e=>{e.dispose()})),e.parent=this._rootMesh,this._customMeshSet=!0}get additionalTransformNode(){return this._additionalTransformNode}set additionalTransformNode(e){this._additionalTransformNode=e}set updateGizmoRotationToMatchAttachedMesh(e){this._updateGizmoRotationToMatchAttachedMesh=e}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set updateGizmoPositionToMatchAttachedMesh(e){this._updateGizmoPositionToMatchAttachedMesh=e}get updateGizmoPositionToMatchAttachedMesh(){return this._updateGizmoPositionToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e}get anchorPoint(){return this._anchorPoint}set coordinatesMode(e){this._coordinatesMode=e;const t=1==e;this.updateGizmoRotationToMatchAttachedMesh=t,this.updateGizmoPositionToMatchAttachedMesh=!0}get coordinatesMode(){return this._coordinatesMode}set updateScale(e){this._updateScale=e}get updateScale(){return this._updateScale}_attachedNodeChanged(e){}constructor(e=Rs.DefaultUtilityLayer){this.gizmoLayer=e,this._attachedMesh=null,this._attachedNode=null,this._customRotationQuaternion=null,this._scaleRatio=1,this._isHovered=!1,this._customMeshSet=!1,this._updateGizmoRotationToMatchAttachedMesh=!0,this._updateGizmoPositionToMatchAttachedMesh=!0,this._anchorPoint=0,this._updateScale=!0,this._coordinatesMode=1,this._interactionsEnabled=!0,this._rightHandtoLeftHandMatrix=n.uq.RotationY(Math.PI),this._rootMesh=new tt.e("gizmoRootNode",e.utilityLayerScene),this._rootMesh.rotationQuaternion=n.PT.Identity(),this._beforeRenderObserver=this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.add((()=>{this._update()}))}get customRotationQuaternion(){return this._customRotationQuaternion}set customRotationQuaternion(e){this._customRotationQuaternion=e}_update(){if(this.attachedNode){let e=this.attachedNode;if(this.attachedMesh&&(e=this.attachedMesh||this.attachedNode),this.updateGizmoPositionToMatchAttachedMesh)if(1==this.anchorPoint&&e.getAbsolutePivotPoint){const t=e.getAbsolutePivotPoint();this._rootMesh.position.copyFrom(t)}else{const t=e.getWorldMatrix().getRow(3),i=t?t.toVector3():new n.Pq(0,0,0);this._rootMesh.position.copyFrom(i)}if(this.updateGizmoRotationToMatchAttachedMesh){const t=e._isMesh||"AbstractMesh"===e.getClassName()||"TransformNode"===e.getClassName()||"InstancedMesh"===e.getClassName()?e:void 0;e.getWorldMatrix().decompose(void 0,this._rootMesh.rotationQuaternion,void 0,ws.PreserveScaling?t:void 0),this._rootMesh.rotationQuaternion.normalize()}else this._customRotationQuaternion?this._rootMesh.rotationQuaternion.copyFrom(this._customRotationQuaternion):this._rootMesh.rotationQuaternion.set(0,0,0,1);if(this.updateScale){const t=this.gizmoLayer.utilityLayerScene.activeCamera,i=t.globalPosition;this._rootMesh.position.subtractToRef(i,n.AA.Vector3[0]);let r=this.scaleRatio;if(t.mode==ft.i.ORTHOGRAPHIC_CAMERA){if(t.orthoTop&&t.orthoBottom){r*=t.orthoTop-t.orthoBottom}}else{const e=t.getScene().useRightHandedSystem?n.Pq.RightHandedForwardReadOnly:n.Pq.LeftHandedForwardReadOnly,i=t.getDirection(e);r*=n.Pq.Dot(n.AA.Vector3[0],i)}this._rootMesh.scaling.setAll(r),e._getWorldMatrixDeterminant()<0&&!ws.PreserveScaling&&(this._rootMesh.scaling.y*=-1)}else this._rootMesh.scaling.setAll(this.scaleRatio)}this.additionalTransformNode&&(this._rootMesh.computeWorldMatrix(!0),this._rootMesh.getWorldMatrix().multiplyToRef(this.additionalTransformNode.getWorldMatrix(),n.AA.Matrix[0]),n.AA.Matrix[0].decompose(this._rootMesh.scaling,this._rootMesh.rotationQuaternion,this._rootMesh.position))}_handlePivotMatrixInverse(e,t,i){if(e.isUsingPivotMatrix()&&!e.isUsingPostMultiplyPivotMatrix())return e.getPivotMatrix().invertToRef(n.AA.Matrix[5]),void n.AA.Matrix[5].multiplyToRef(t,i);i.copyFrom(t)}_matrixChanged(){if(this._attachedNode)if(this._attachedNode._isCamera){const e=this._attachedNode;let t,i;if(e.parent){const i=n.AA.Matrix[1];e.parent._worldMatrix.invertToRef(i),this._attachedNode._worldMatrix.multiplyToRef(i,n.AA.Matrix[0]),t=n.AA.Matrix[0]}else t=this._attachedNode._worldMatrix;e.getScene().useRightHandedSystem?(this._rightHandtoLeftHandMatrix.multiplyToRef(t,n.AA.Matrix[1]),i=n.AA.Matrix[1]):i=t,i.decompose(n.AA.Vector3[1],n.AA.Quaternion[0],n.AA.Vector3[0]);if("FreeCamera"===this._attachedNode.getClassName()||"FlyCamera"===this._attachedNode.getClassName()||"ArcFollowCamera"===this._attachedNode.getClassName()||"TargetCamera"===this._attachedNode.getClassName()||"TouchCamera"===this._attachedNode.getClassName()||"UniversalCamera"===this._attachedNode.getClassName()){const e=this._attachedNode;e.rotation=n.AA.Quaternion[0].toEulerAngles(),e.rotationQuaternion&&(e.rotationQuaternion.copyFrom(n.AA.Quaternion[0]),e.rotationQuaternion.normalize())}e.position.copyFrom(n.AA.Vector3[0])}else if(this._attachedNode._isMesh||"AbstractMesh"===this._attachedNode.getClassName()||"TransformNode"===this._attachedNode.getClassName()||"InstancedMesh"===this._attachedNode.getClassName()){const e=this._attachedNode;if(e.parent){const t=n.AA.Matrix[0],i=n.AA.Matrix[1];e.parent.getWorldMatrix().invertToRef(t),this._attachedNode.getWorldMatrix().multiplyToRef(t,i);const r=n.AA.Matrix[4];if(this._handlePivotMatrixInverse(e,i,r),r.decompose(n.AA.Vector3[0],n.AA.Quaternion[0],e.position,ws.PreserveScaling?e:void 0,ws.UseAbsoluteScaling),n.AA.Quaternion[0].normalize(),e.isUsingPivotMatrix()){const t=n.AA.Quaternion[1];n.PT.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,t);const i=n.AA.Matrix[2];n.uq.ScalingToRef(e.scaling.x,e.scaling.y,e.scaling.z,i);const r=n.AA.Matrix[2];t.toRotationMatrix(r);const s=e.getPivotMatrix(),o=n.AA.Matrix[3];s.invertToRef(o),s.multiplyToRef(i,n.AA.Matrix[4]),n.AA.Matrix[4].multiplyToRef(r,n.AA.Matrix[5]),n.AA.Matrix[5].multiplyToRef(o,n.AA.Matrix[6]),n.AA.Matrix[6].getTranslationToRef(n.AA.Vector3[1]),e.position.subtractInPlace(n.AA.Vector3[1])}}else{const t=n.AA.Matrix[4];this._handlePivotMatrixInverse(e,this._attachedNode._worldMatrix,t),t.decompose(n.AA.Vector3[0],n.AA.Quaternion[0],e.position,ws.PreserveScaling?e:void 0,ws.UseAbsoluteScaling)}n.AA.Vector3[0].scaleInPlace(1/e.scalingDeterminant),e.scaling.copyFrom(n.AA.Vector3[0]),e.billboardMode||(e.rotationQuaternion?(e.rotationQuaternion.copyFrom(n.AA.Quaternion[0]),e.rotationQuaternion.normalize()):e.rotation=n.AA.Quaternion[0].toEulerAngles())}else if("Bone"===this._attachedNode.getClassName()){const e=this._attachedNode,t=e.getParent();if(t){const i=n.AA.Matrix[0],r=n.AA.Matrix[1];t.getFinalMatrix().invertToRef(i),e.getFinalMatrix().multiplyToRef(i,r);e.getLocalMatrix().copyFrom(r)}else{e.getLocalMatrix().copyFrom(e.getFinalMatrix())}e.markAsDirty()}else{const e=this._attachedNode;if(e.getTypeID){const t=e.getTypeID();if(t===Ns.v.LIGHTTYPEID_DIRECTIONALLIGHT||t===Ns.v.LIGHTTYPEID_SPOTLIGHT||t===Ns.v.LIGHTTYPEID_POINTLIGHT){const t=e.parent;if(t){const i=n.AA.Matrix[0],r=n.AA.Matrix[1];t.getWorldMatrix().invertToRef(i),e.getWorldMatrix().multiplyToRef(i,r),r.decompose(void 0,n.AA.Quaternion[0],n.AA.Vector3[0])}else this._attachedNode._worldMatrix.decompose(void 0,n.AA.Quaternion[0],n.AA.Vector3[0]);e.position=new n.Pq(n.AA.Vector3[0].x,n.AA.Vector3[0].y,n.AA.Vector3[0].z),e.direction&&(e.direction=new n.Pq(e.direction.x,e.direction.y,e.direction.z))}}}}_setGizmoMeshMaterial(e,t){e&&e.forEach((e=>{e.material=t,e.color&&(e.color=t.diffuseColor)}))}static GizmoAxisPointerObserver(e,t){let i=!1;return e.utilityLayerScene.onPointerObservable.add((e=>{if(e.pickInfo){if(e.type===rt.Zp.POINTERMOVE){if(i)return;t.forEach((t=>{if(t.colliderMeshes&&t.gizmoMeshes){const i=-1!=t.colliderMeshes?.indexOf(e?.pickInfo?.pickedMesh),r=t.dragBehavior.enabled?i||t.active?t.hoverMaterial:t.material:t.disableMaterial;t.gizmoMeshes.forEach((e=>{e.material=r,e.color&&(e.color=r.diffuseColor)}))}}))}if(e.type===rt.Zp.POINTERDOWN&&t.has(e.pickInfo.pickedMesh?.parent)){i=!0;t.get(e.pickInfo.pickedMesh?.parent).active=!0,t.forEach((t=>{const i=(-1!=t.colliderMeshes?.indexOf(e?.pickInfo?.pickedMesh)||t.active)&&t.dragBehavior.enabled?t.hoverMaterial:t.disableMaterial;t.gizmoMeshes.forEach((e=>{e.material=i,e.color&&(e.color=i.diffuseColor)}))}))}e.type===rt.Zp.POINTERUP&&t.forEach((e=>{e.active=!1,i=!1,e.gizmoMeshes.forEach((t=>{t.material=e.dragBehavior.enabled?e.material:e.disableMaterial,t.color&&(t.color=e.material.diffuseColor)}))}))}}))}dispose(){this._rootMesh.dispose(),this._beforeRenderObserver&&this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.remove(this._beforeRenderObserver)}}ws.PreserveScaling=!1,ws.UseAbsoluteScaling=!0;class Fs extends ws{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}static _CreateArrow(e,t,i=1,r=!1){const s=new mt.V("arrow",e),n=Es("cylinder",{diameterTop:0,height:.075,diameterBottom:.0375*(1+(i-1)/4),tessellation:96},e),o=Es("cylinder",{diameterTop:.005*i,height:.275,diameterBottom:.005*i,tessellation:96},e);return n.parent=s,n.material=t,n.rotation.x=Math.PI/2,n.position.z+=.3,o.parent=s,o.material=t,o.position.z+=.1375,o.rotation.x=Math.PI/2,r&&(o.visibility=0,n.visibility=0),s}static _CreateArrowInstance(e,t){const i=new mt.V("arrow",e);for(const e of t.getChildMeshes()){e.createInstance(e.name).parent=i}return i}constructor(e,t=o.v9.Gray(),i=Rs.DefaultUtilityLayer,r=null,a=1,l=o.v9.Yellow(),h=o.v9.Gray()){super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new s.cP,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._parent=r,this._coloredMaterial=new br.F("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new o.v9(.1,.1,.1)),this._hoverMaterial=new br.F("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=l,this._disableMaterial=new br.F("",i.utilityLayerScene),this._disableMaterial.diffuseColor=h,this._disableMaterial.alpha=.4;const c=Fs._CreateArrow(i.utilityLayerScene,this._coloredMaterial,a),u=Fs._CreateArrow(i.utilityLayerScene,this._coloredMaterial,a+4,!0);this._gizmoMesh=new tt.e("",i.utilityLayerScene),this._gizmoMesh.addChild(c),this._gizmoMesh.addChild(u),this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._gizmoMesh.scaling.scaleInPlace(1/3),this._gizmoMesh.parent=this._rootMesh;let d=0;const p={snapDistance:0};this.dragBehavior=new dt({dragAxis:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.updateDragPlane=!1,this._rootMesh.addBehavior(this.dragBehavior),this.dragBehavior.onDragObservable.add((e=>{if(this.attachedNode){let t=!1;if(0==this.snapDistance)this.attachedNode.getWorldMatrix().getTranslationToRef(n.AA.Vector3[2]),n.AA.Vector3[2].addInPlace(e.delta),this.dragBehavior.validateDrag(n.AA.Vector3[2])&&(this.attachedNode.position&&this.attachedNode.position.addInPlaceFromFloats(e.delta.x,e.delta.y,e.delta.z),this.attachedNode.getWorldMatrix().addTranslationFromFloats(e.delta.x,e.delta.y,e.delta.z),this.attachedNode.updateCache(),t=!0);else if(d+=e.dragDistance,Math.abs(d)>this.snapDistance){const i=Math.floor(Math.abs(d)/this.snapDistance);d%=this.snapDistance,e.delta.normalizeToRef(n.AA.Vector3[1]),n.AA.Vector3[1].scaleInPlace(this.snapDistance*i),this.attachedNode.getWorldMatrix().getTranslationToRef(n.AA.Vector3[2]),n.AA.Vector3[2].addInPlace(n.AA.Vector3[1]),this.dragBehavior.validateDrag(n.AA.Vector3[2])&&(this.attachedNode.getWorldMatrix().addTranslationFromFloats(n.AA.Vector3[1].x,n.AA.Vector3[1].y,n.AA.Vector3[1].z),this.attachedNode.updateCache(),p.snapDistance=this.snapDistance*i*Math.sign(d),this.onSnapObservable.notifyObservers(p),t=!0)}t&&this._matrixChanged()}})),this.dragBehavior.onDragStartObservable.add((()=>{this._dragging=!0})),this.dragBehavior.onDragEndObservable.add((()=>{this._dragging=!1}));const m=i._getSharedGizmoLight();m.includedOnlyMeshes=m.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes(!1));const f={gizmoMeshes:c.getChildMeshes(),colliderMeshes:u.getChildMeshes(),material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};this._parent?.addToAxisCache(u,f),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((e=>{if(!this._customMeshSet&&(this._isHovered=!(-1==f.colliderMeshes.indexOf(e?.pickInfo?.pickedMesh)),!this._parent)){const e=this.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(f.gizmoMeshes,e)}})),this.dragBehavior.onEnabledObservable.add((e=>{this._setGizmoMeshMaterial(f.gizmoMeshes,e?f.material:f.disableMaterial)}))}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()})),super.dispose()}}class Bs{get scaleLines(){return this._scaleLines}set scaleLines(e){this._scaleLines=e,this._xAxis.scaling.setAll(this._scaleLines*this._scaleLinesFactor),this._yAxis.scaling.setAll(this._scaleLines*this._scaleLinesFactor),this._zAxis.scaling.setAll(this._scaleLines*this._scaleLinesFactor)}get xAxis(){return this._xAxis}get yAxis(){return this._yAxis}get zAxis(){return this._zAxis}constructor(e,t=1,i=2,r,s,a,l=1){if(this._scaleLinesFactor=4,this._instanced=!1,this.scene=null,this._scaleLines=1,e=e||C.q.LastCreatedScene){if(!r){const t=new br.F("xAxisMaterial",e);t.disableLighting=!0,t.emissiveColor=o.v9.Red().scale(.5),r=Fs._CreateArrow(e,t,l)}if(!s){const t=new br.F("yAxisMaterial",e);t.disableLighting=!0,t.emissiveColor=o.v9.Green().scale(.5),s=Fs._CreateArrow(e,t,l)}if(!a){const t=new br.F("zAxisMaterial",e);t.disableLighting=!0,t.emissiveColor=o.v9.Blue().scale(.5),a=Fs._CreateArrow(e,t,l)}this._xAxis=r,this._yAxis=s,this._zAxis=a,this.scaleLines=t,null!=i&&(Bs._SetRenderingGroupId(this._xAxis,i),Bs._SetRenderingGroupId(this._yAxis,i),Bs._SetRenderingGroupId(this._zAxis,i)),this.scene=e,this.update(new n.Pq,n.Pq.Right(),n.Pq.Up(),n.Pq.Forward())}}update(e,t,i,r){this._xAxis.position.copyFrom(e),this._xAxis.setDirection(t),this._yAxis.position.copyFrom(e),this._yAxis.setDirection(i),this._zAxis.position.copyFrom(e),this._zAxis.setDirection(r)}createInstance(){const e=Fs._CreateArrowInstance(this.scene,this._xAxis),t=Fs._CreateArrowInstance(this.scene,this._yAxis),i=Fs._CreateArrowInstance(this.scene,this._zAxis),r=new Bs(this.scene,this.scaleLines,null,e,t,i);return r._instanced=!0,r}dispose(){this._xAxis&&this._xAxis.dispose(!1,!this._instanced),this._yAxis&&this._yAxis.dispose(!1,!this._instanced),this._zAxis&&this._zAxis.dispose(!1,!this._instanced),this.scene=null}static _SetRenderingGroupId(e,t){e.getChildMeshes().forEach((e=>{e.renderingGroupId=t}))}}class Vs extends Bs{constructor(e,t,i,r=1){super(e,r),this.pos=n.Pq.Zero(),this.xaxis=n.Pq.Zero(),this.yaxis=n.Pq.Zero(),this.zaxis=n.Pq.Zero(),this.mesh=i,this.bone=t}update(){if(!this.mesh||!this.bone)return;const e=this.bone;e.getAbsolutePositionToRef(this.mesh,this.pos),e.getDirectionToRef(Mt._0.X,this.mesh,this.xaxis),e.getDirectionToRef(Mt._0.Y,this.mesh,this.yaxis),e.getDirectionToRef(Mt._0.Z,this.mesh,this.zaxis),super.update(this.pos,this.xaxis,this.yaxis,this.zaxis)}dispose(){this.mesh&&(this.mesh=null,this.bone=null,super.dispose())}}Object.defineProperty(it.Z.prototype,"debugLayer",{get:function(){return this._debugLayer||(this._debugLayer=new Ls(this)),this._debugLayer},enumerable:!0,configurable:!0}),function(e){e[e.Properties=0]="Properties",e[e.Debug=1]="Debug",e[e.Statistics=2]="Statistics",e[e.Tools=3]="Tools",e[e.Settings=4]="Settings"}(Os||(Os={}));class Ls{get onPropertyChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable:(this._onPropertyChangedObservable||(this._onPropertyChangedObservable=new s.cP),this._onPropertyChangedObservable)}get onSelectionChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable:(this._onSelectionChangedObservable||(this._onSelectionChangedObservable=new s.cP),this._onSelectionChangedObservable)}constructor(e){this.BJSINSPECTOR=this._getGlobalInspector(),this._scene=e||C.q.LastCreatedScene,this._scene&&this._scene.onDisposeObservable.add((()=>{this._scene._debugLayer&&this._scene._debugLayer.hide()}))}_createInspector(e){if(this.isVisible())return;if(this._onPropertyChangedObservable){for(const e of this._onPropertyChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable.add(e);this._onPropertyChangedObservable.clear(),this._onPropertyChangedObservable=void 0}if(this._onSelectionChangedObservable){for(const e of this._onSelectionChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnSelectionChangedObservable.add(e);this._onSelectionChangedObservable.clear(),this._onSelectionChangedObservable=void 0}const t={...Ls.Config,...e};this.BJSINSPECTOR=this.BJSINSPECTOR||this._getGlobalInspector(),this.BJSINSPECTOR.Inspector.Show(this._scene,t)}select(e,t){this.BJSINSPECTOR&&(t&&("[object String]"==Object.prototype.toString.call(t)?this.BJSINSPECTOR.Inspector.MarkLineContainerTitleForHighlighting(t):this.BJSINSPECTOR.Inspector.MarkMultipleLineContainerTitlesForHighlighting(t)),this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable.notifyObservers(e))}_getGlobalInspector(){return"undefined"!=typeof INSPECTOR?INSPECTOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.Inspector?BABYLON:void 0}isVisible(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.IsVisible}hide(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.Hide()}get openedPanes(){return this.BJSINSPECTOR?this.BJSINSPECTOR.Inspector._OpenedPane:0}setAsActiveScene(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector._SetNewScene(this._scene)}popupSceneExplorer(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.PopupSceneExplorer()}popupInspector(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.PopupInspector()}popupEmbed(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.PopupEmbed()}show(e){return new Promise((t=>{if(void 0===this.BJSINSPECTOR){const i=e&&e.inspectorURL?e.inspectorURL:Ls.InspectorURL;H.S0.LoadBabylonScript(i,(()=>{this._createInspector(e),t(this)}))}else this._createInspector(e),t(this)}))}}Ls.InspectorURL=`${H.S0._DefaultCdnUrl}/v${$.$.Version}/inspector/babylon.inspector.bundle.js`,Ls.Config={overlay:!1,showExplorer:!0,showInspector:!0,embedMode:!1,handleResize:!0,enablePopup:!0};var ks=i(96793);function Gs(e){const t=0|(e.segments||32),i=e.diameterX||e.diameter||1,r=e.diameterY||e.diameter||1,s=e.diameterZ||e.diameter||1,o=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1,a=e.slice&&e.slice<=0?1:e.slice||1,l=0===e.sideOrientation?0:e.sideOrientation||ot.P.DEFAULTSIDE,h=!!e.dedupTopBottomIndices,c=new n.Pq(i/2,r/2,s/2),u=2+t,d=2*u,p=[],m=[],f=[],_=[];for(let e=0;e<=u;e++){const t=e/u,i=t*Math.PI*a;for(let e=0;e<=d;e++){const r=e/d,s=r*Math.PI*2*o,a=n.uq.RotationZ(-i),l=n.uq.RotationY(s),h=n.Pq.TransformCoordinates(n.Pq.Up(),a),u=n.Pq.TransformCoordinates(h,l),p=u.multiply(c),g=u.divide(c).normalize();m.push(p.x,p.y,p.z),f.push(g.x,g.y,g.z),_.push(r,at.rX?1-t:t)}if(e>0){const t=m.length/3;for(let i=t-2*(d+1);i+d+2<t;i++)h?(e>1&&(p.push(i),p.push(i+1),p.push(i+d+1)),(e<u||a<1)&&(p.push(i+d+1),p.push(i+1),p.push(i+d+2))):(p.push(i),p.push(i+1),p.push(i+d+1),p.push(i+d+1),p.push(i+1),p.push(i+d+2))}}ot.P._ComputeSides(l,m,p,f,_,e.frontUVs,e.backUVs);const g=new ot.P;return g.indices=p,g.positions=m,g.normals=f,g.uvs=_,g}function zs(e,t={},i=null){const r=new tt.e(e,i);t.sideOrientation=tt.e._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;return Gs(t).applyToMesh(r,t.updatable),r}const Us={CreateSphere:zs};ot.P.CreateSphere=Gs,tt.e.CreateSphere=(e,t,i,r,s,n)=>zs(e,{segments:t,diameterX:i,diameterY:i,diameterZ:i,sideOrientation:n,updatable:s},r);class Ws{constructor(e,t){this.type=e,this.jointData=t,t.nativeParams=t.nativeParams||{}}get physicsJoint(){return this._physicsJoint}set physicsJoint(e){this._physicsJoint=e}set physicsPlugin(e){this._physicsPlugin=e}executeNativeFunction(e){e(this._physicsPlugin.world,this._physicsJoint)}}Ws.DistanceJoint=0,Ws.HingeJoint=1,Ws.BallAndSocketJoint=2,Ws.WheelJoint=3,Ws.SliderJoint=4,Ws.PrismaticJoint=5,Ws.UniversalJoint=6,Ws.Hinge2Joint=Ws.WheelJoint,Ws.PointToPointJoint=8,Ws.SpringJoint=9,Ws.LockJoint=10;class Hs extends Ws{constructor(e){super(Ws.DistanceJoint,e)}updateDistance(e,t){this._physicsPlugin.updateDistanceJoint(this,e,t)}}class $s extends Ws{constructor(e,t){super(e,t)}setMotor(e,t){this._physicsPlugin.setMotor(this,e||0,t)}setLimit(e,t){this._physicsPlugin.setLimit(this,e,t)}}class qs extends $s{constructor(e){super(Ws.HingeJoint,e)}setMotor(e,t){this._physicsPlugin.setMotor(this,e||0,t)}setLimit(e,t){this._physicsPlugin.setLimit(this,e,t)}}class Ys extends $s{constructor(e){super(Ws.Hinge2Joint,e)}setMotor(e,t,i=0){this._physicsPlugin.setMotor(this,e||0,t,i)}setLimit(e,t,i=0){this._physicsPlugin.setLimit(this,e,t,i)}}tt.e._PhysicsImpostorParser=function(e,t,i){return new Xs(t,i.physicsImpostor,{mass:i.physicsMass,friction:i.physicsFriction,restitution:i.physicsRestitution},e)};class Xs{get isDisposed(){return this._isDisposed}get mass(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0}set mass(e){this.setMass(e)}get friction(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0}set friction(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,e)}get restitution(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0}set restitution(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,e)}get pressure(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.setBodyPressure?e.getBodyPressure(this):0}set pressure(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyPressure&&t.setBodyPressure(this,e)}get stiffness(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyStiffness?e.getBodyStiffness(this):0}set stiffness(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyStiffness&&t.setBodyStiffness(this,e)}get velocityIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyVelocityIterations?e.getBodyVelocityIterations(this):0}set velocityIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyVelocityIterations&&t.setBodyVelocityIterations(this,e)}get positionIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyPositionIterations?e.getBodyPositionIterations(this):0}set positionIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyPositionIterations&&t.setBodyPositionIterations(this,e)}constructor(e,t,i={mass:0},r){this.object=e,this.type=t,this._options=i,this._scene=r,this._pluginData={},this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=n.Pq.Zero(),this._isDisposed=!1,this.soft=!1,this.segments=0,this._tmpQuat=new n.PT,this._tmpQuat2=new n.PT,this.beforeStep=()=>{this._physicsEngine&&(this.object.translate(this._deltaPosition,-1),this._deltaRotationConjugated&&this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotationConjugated,this.object.rotationQuaternion),this.object.computeWorldMatrix(!1),this.object.parent&&this.object.rotationQuaternion?(this.getParentsRotation(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this._tmpQuat)):this._tmpQuat.copyFrom(this.object.rotationQuaternion||new n.PT),this._options.disableBidirectionalTransformation||this.object.rotationQuaternion&&this._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(this,this.object.getAbsolutePosition(),this._tmpQuat),this._onBeforePhysicsStepCallbacks.forEach((e=>{e(this)})))},this.afterStep=()=>{this._physicsEngine&&(this._onAfterPhysicsStepCallbacks.forEach((e=>{e(this)})),this._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(this),this.object.parent&&this.object.rotationQuaternion&&(this.getParentsRotation(),this._tmpQuat.conjugateInPlace(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this.object.rotationQuaternion)),this.object.setAbsolutePosition(this.object.position),this._deltaRotation?(this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotation,this.object.rotationQuaternion),this._deltaPosition.applyRotationQuaternionToRef(this._deltaRotation,Xs._TmpVecs[0]),this.object.translate(Xs._TmpVecs[0],1)):this.object.translate(this._deltaPosition,1),this.object.computeWorldMatrix(!0))},this.onCollideEvent=null,this.onCollide=e=>{if(!this._onPhysicsCollideCallbacks.length&&!this.onCollideEvent)return;if(!this._physicsEngine)return;const t=this._physicsEngine.getImpostorWithPhysicsBody(e.body);t&&(this.onCollideEvent&&this.onCollideEvent(this,t),this._onPhysicsCollideCallbacks.filter((e=>-1!==e.otherImpostors.indexOf(t))).forEach((i=>{i.callback(this,t,e.point,e.distance,e.impulse,e.normal)})))},this.object?(this.object.parent&&0!==i.mass&&m.V.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),this._scene&&(this.type>100&&(this.soft=!0),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=n.PT.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new n.PT),this._options.mass=void 0===i.mass?0:i.mass,this._options.friction=void 0===i.friction?.2:i.friction,this._options.restitution=void 0===i.restitution?.2:i.restitution,this.soft&&(this._options.mass=this._options.mass>0?this._options.mass:1,this._options.pressure=void 0===i.pressure?200:i.pressure,this._options.stiffness=void 0===i.stiffness?1:i.stiffness,this._options.velocityIterations=void 0===i.velocityIterations?20:i.velocityIterations,this._options.positionIterations=void 0===i.positionIterations?20:i.positionIterations,this._options.fixedPoints=void 0===i.fixedPoints?0:i.fixedPoints,this._options.margin=void 0===i.margin?0:i.margin,this._options.damping=void 0===i.damping?0:i.damping,this._options.path=void 0===i.path?null:i.path,this._options.shape=void 0===i.shape?null:i.shape),this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&m.V.Warn("You must affect impostors to children before affecting impostor to parent.")):m.V.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))):m.V.Error("No object was provided. A physics object is obligatory")}_init(){this._physicsEngine&&(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),this._isDisposed||this.parent&&!this._options.ignoreParent||this._physicsEngine.addImpostor(this))}_getPhysicsParent(){if(this.object.parent instanceof Ps.u){return this.object.parent.physicsImpostor}return null}isBodyInitRequired(){return this._bodyUpdateRequired||!this._physicsBody&&(!this._parent||!!this._options.ignoreParent)}setScalingUpdated(){this.forceUpdate()}forceUpdate(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()}get physicsBody(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody}get parent(){return!this._options.ignoreParent&&this._parent?this._parent:null}set parent(e){this._parent=e}set physicsBody(e){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=e,this.resetUpdateFlags()}resetUpdateFlags(){this._bodyUpdateRequired=!1}getObjectExtents(){if(this.object.getBoundingInfo){const e=this.object.rotationQuaternion,t=this.object.scaling.clone();this.object.rotationQuaternion=Xs.IDENTITY_QUATERNION;const i=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);i&&i.decompose(t,void 0,void 0);const r=this.object.getBoundingInfo().boundingBox.extendSize.scale(2).multiplyInPlace(t);return r.x=Math.abs(r.x),r.y=Math.abs(r.y),r.z=Math.abs(r.z),this.object.rotationQuaternion=e,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),r}return Xs.DEFAULT_OBJECT_SIZE}getObjectCenter(){if(this.object.getBoundingInfo){return this.object.getBoundingInfo().boundingBox.centerWorld}return this.object.position}getParam(e){return this._options[e]}setParam(e,t){this._options[e]=t,this._bodyUpdateRequired=!0}setMass(e){this.getParam("mass")!==e&&this.setParam("mass",e),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,e)}getLinearVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):n.Pq.Zero()}setLinearVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,e)}getAngularVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):n.Pq.Zero()}setAngularVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,e)}executeNativeFunction(e){this._physicsEngine&&e(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)}registerBeforePhysicsStep(e){this._onBeforePhysicsStepCallbacks.push(e)}unregisterBeforePhysicsStep(e){const t=this._onBeforePhysicsStepCallbacks.indexOf(e);t>-1?this._onBeforePhysicsStepCallbacks.splice(t,1):m.V.Warn("Function to remove was not found")}registerAfterPhysicsStep(e){this._onAfterPhysicsStepCallbacks.push(e)}unregisterAfterPhysicsStep(e){const t=this._onAfterPhysicsStepCallbacks.indexOf(e);t>-1?this._onAfterPhysicsStepCallbacks.splice(t,1):m.V.Warn("Function to remove was not found")}registerOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];this._onPhysicsCollideCallbacks.push({callback:t,otherImpostors:i})}unregisterOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];let r=-1;this._onPhysicsCollideCallbacks.some(((e,s)=>{if(e.callback===t&&e.otherImpostors.length===i.length){const t=e.otherImpostors.every((e=>i.indexOf(e)>-1));return t&&(r=s),t}return!1}))?this._onPhysicsCollideCallbacks.splice(r,1):m.V.Warn("Function to remove was not found")}getParentsRotation(){let e=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);e;)e.rotationQuaternion?this._tmpQuat2.copyFrom(e.rotationQuaternion):n.PT.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),e=e.parent;return this._tmpQuat}applyForce(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,e,t),this}applyImpulse(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,e,t),this}createJoint(e,t,i){const r=new Ws(t,i);return this.addJoint(e,r),this}addJoint(e,t){return this._joints.push({otherImpostor:e,joint:t}),this._physicsEngine&&this._physicsEngine.addJoint(this,e,t),this}addAnchor(e,t,i,r,s){if(!this._physicsEngine)return this;const n=this._physicsEngine.getPhysicsPlugin();return n.appendAnchor?(this._physicsEngine&&n.appendAnchor(this,e,t,i,r,s),this):this}addHook(e,t,i,r){if(!this._physicsEngine)return this;const s=this._physicsEngine.getPhysicsPlugin();return s.appendAnchor?(this._physicsEngine&&s.appendHook(this,e,t,i,r),this):this}sleep(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this}wakeUp(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this}clone(e){return e?new Xs(e,this.type,this._options,this._scene):null}dispose(){this._physicsEngine&&(this._joints.forEach((e=>{this._physicsEngine&&this._physicsEngine.removeJoint(this,e.otherImpostor,e.joint)})),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0)}setDeltaPosition(e){this._deltaPosition.copyFrom(e)}setDeltaRotation(e){this._deltaRotation||(this._deltaRotation=new n.PT),this._deltaRotation.copyFrom(e),this._deltaRotationConjugated=this._deltaRotation.conjugate()}getBoxSizeToRef(e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,e),this}getRadius(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0}syncBoneWithImpostor(e,t,i,r,s){const n=Xs._TmpVecs[0],o=this.object;if(o.rotationQuaternion)if(s){const i=Xs._TmpQuat;o.rotationQuaternion.multiplyToRef(s,i),e.setRotationQuaternion(i,1,t)}else e.setRotationQuaternion(o.rotationQuaternion,1,t);n.x=0,n.y=0,n.z=0,i&&(n.x=i.x,n.y=i.y,n.z=i.z,e.getDirectionToRef(n,t,n),null==r&&(r=i.length()),n.x*=r,n.y*=r,n.z*=r),e.getParent()?(n.addInPlace(o.getAbsolutePosition()),e.setAbsolutePosition(n,t)):(t.setAbsolutePosition(o.getAbsolutePosition()),t.position.x-=n.x,t.position.y-=n.y,t.position.z-=n.z)}syncImpostorWithBone(e,t,i,r,s,n){const o=this.object;if(o.rotationQuaternion)if(s){const i=Xs._TmpQuat;e.getRotationQuaternionToRef(1,t,i),i.multiplyToRef(s,o.rotationQuaternion)}else e.getRotationQuaternionToRef(1,t,o.rotationQuaternion);const a=Xs._TmpVecs[0],l=Xs._TmpVecs[1];n||((n=Xs._TmpVecs[2]).x=0,n.y=1,n.z=0),e.getDirectionToRef(n,t,l),e.getAbsolutePositionToRef(t,a),null==r&&i&&(r=i.length()),null!=r&&(a.x+=l.x*r,a.y+=l.y*r,a.z+=l.z*r),o.setAbsolutePosition(a)}}function js(e={subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){const t=0|Math.max(e.subdivisions?e.subdivisions:2,1),i=0|Math.max(e.tessellation?e.tessellation:16,3),r=Math.max(e.height?e.height:1,0),s=Math.max(e.radius?e.radius:.25,0),o=0|Math.max(e.capSubdivisions?e.capSubdivisions:6,1),a=i,l=t,h=Math.max(e.radiusTop?e.radiusTop:s,0),c=Math.max(e.radiusBottom?e.radiusBottom:s,0),u=r-(h+c),d=2*Math.PI,p=Math.max(e.topCapSubdivisions?e.topCapSubdivisions:o,1),m=Math.max(e.bottomCapSubdivisions?e.bottomCapSubdivisions:o,1),f=Math.acos((c-h)/r);let _=[];const g=[],x=[],v=[];let S=0;const b=[],y=.5*u,P=.5*Math.PI;let T,C;const E=n.Pq.Zero(),A=n.Pq.Zero(),I=Math.cos(f),R=Math.sin(f),M=new n.I9(h*R,y+h*I).subtract(new n.I9(c*R,c*I-y)).length(),D=h*f+M+c*(P-f);let O=0;for(C=0;C<=p;C++){const e=[],t=P-f*(C/p);O+=h*f/p;const i=Math.cos(t),r=Math.sin(t),s=i*h;for(T=0;T<=a;T++){const t=T/a,n=t*d+0,o=Math.sin(n),l=Math.cos(n);A.x=s*o,A.y=y+r*h,A.z=s*l,g.push(A.x,A.y,A.z),E.set(i*o,r,i*l),x.push(E.x,E.y,E.z),v.push(t,at.rX?O/D:1-O/D),e.push(S),S++}b.push(e)}const N=r-h-c+I*h-I*c,w=R*(c-h)/N;for(C=1;C<=l;C++){const e=[];O+=M/l;const t=R*(C*(c-h)/l+h);for(T=0;T<=a;T++){const i=T/a,r=i*d+0,s=Math.sin(r),n=Math.cos(r);A.x=t*s,A.y=y+I*h-C*N/l,A.z=t*n,g.push(A.x,A.y,A.z),E.set(s,w,n).normalize(),x.push(E.x,E.y,E.z),v.push(i,at.rX?O/D:1-O/D),e.push(S),S++}b.push(e)}for(C=1;C<=m;C++){const e=[],t=P-f-(Math.PI-f)*(C/m);O+=c*f/m;const i=Math.cos(t),r=Math.sin(t),s=i*c;for(T=0;T<=a;T++){const t=T/a,n=t*d+0,o=Math.sin(n),l=Math.cos(n);A.x=s*o,A.y=r*c-y,A.z=s*l,g.push(A.x,A.y,A.z),E.set(i*o,r,i*l),x.push(E.x,E.y,E.z),v.push(t,at.rX?O/D:1-O/D),e.push(S),S++}b.push(e)}for(T=0;T<a;T++)for(C=0;C<p+l+m;C++){const e=b[C][T],t=b[C+1][T],i=b[C+1][T+1],r=b[C][T+1];_.push(e),_.push(t),_.push(r),_.push(t),_.push(i),_.push(r)}if(_=_.reverse(),e.orientation&&!e.orientation.equals(n.Pq.Up())){const t=new n.uq;e.orientation.clone().scale(.5*Math.PI).cross(n.Pq.Up()).toQuaternion().toRotationMatrix(t);const i=n.Pq.Zero();for(let e=0;e<g.length;e+=3)i.set(g[e],g[e+1],g[e+2]),n.Pq.TransformCoordinatesToRef(i.clone(),t,i),g[e]=i.x,g[e+1]=i.y,g[e+2]=i.z}const F=new ot.P;return F.positions=g,F.normals=x,F.uvs=v,F.indices=_,F}function Zs(e,t={orientation:n.Pq.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6,updatable:!1},i=null){const r=new tt.e(e,i);return js(t).applyToMesh(r,t.updatable),r}Xs.DEFAULT_OBJECT_SIZE=new n.Pq(1,1,1),Xs.IDENTITY_QUATERNION=n.PT.Identity(),Xs._TmpVecs=(0,Rt.mI)(3,n.Pq.Zero),Xs._TmpQuat=n.PT.Identity(),Xs.NoImpostor=0,Xs.SphereImpostor=1,Xs.BoxImpostor=2,Xs.PlaneImpostor=3,Xs.MeshImpostor=4,Xs.CapsuleImpostor=6,Xs.CylinderImpostor=7,Xs.ParticleImpostor=8,Xs.HeightmapImpostor=9,Xs.ConvexHullImpostor=10,Xs.CustomImpostor=100,Xs.RopeImpostor=101,Xs.ClothImpostor=102,Xs.SoftbodyImpostor=103;const Qs={CreateCapsule:Zs};function Ks(e){let t=e.pathArray;const i=e.closeArray||!1,r=e.closePath||!1,s=e.invertUV||!1,n=Math.floor(t[0].length/2);let o=e.offset||n;o=o>n?n:Math.floor(o);const a=0===e.sideOrientation?0:e.sideOrientation||ot.P.DEFAULTSIDE,l=e.uvs,h=e.colors,c=[],u=[],d=[],p=[],m=[],f=[],_=[],g=[];let x;const v=[],S=[];let b,y,P;if(t.length<2){const e=[],i=[];for(y=0;y<t[0].length-o;y++)e.push(t[0][y]),i.push(t[0][y+o]);t=[e,i]}let T=0;const C=r?1:0,E=i?1:0;let A,I,R,M,D,O;for(x=t[0].length,b=0;b<t.length+E;b++){for(_[b]=0,m[b]=[0],A=b===t.length?t[0]:t[b],I=A.length,x=x<I?x:I,P=0;P<I;)c.push(A[P].x,A[P].y,A[P].z),P>0&&(R=A[P].subtract(A[P-1]).length(),M=R+_[b],m[b].push(M),_[b]=M),P++;r&&(P--,c.push(A[0].x,A[0].y,A[0].z),R=A[P].subtract(A[0]).length(),M=R+_[b],m[b].push(M),_[b]=M),v[b]=I+C,S[b]=T,T+=I+C}let N,w,F=null,B=null;for(y=0;y<x+C;y++)for(g[y]=0,f[y]=[0],b=0;b<t.length-1+E;b++)D=t[b],O=b===t.length-1?t[0]:t[b+1],y===x?(F=D[0],B=O[0]):(F=D[y],B=O[y]),R=B.subtract(F).length(),M=R+g[y],f[y].push(M),g[y]=M;if(l)for(b=0;b<l.length;b++)p.push(l[b].x,at.rX?1-l[b].y:l[b].y);else for(b=0;b<t.length+E;b++)for(y=0;y<x+C;y++)N=0!=_[b]?m[b][y]/_[b]:0,w=0!=g[y]?f[y][b]/g[y]:0,s?p.push(w,N):p.push(N,at.rX?1-w:w);b=0;let V=0,L=v[b]-1,k=v[b+1]-1,G=L<k?L:k,z=S[1]-S[0];const U=v.length-1;for(;V<=G&&b<U;)u.push(V,V+z,V+1),u.push(V+z+1,V+1,V+z),V+=1,V===G&&(b++,z=S[b+1]-S[b],L=v[b]-1,k=v[b+1]-1,V=S[b],G=L<k?L+V:k+V);if(ot.P.ComputeNormals(c,u,d),r){let e=0,i=0;for(b=0;b<t.length;b++){e=3*S[b],i=b+1<t.length?3*(S[b+1]-1):d.length-3,d[e]=.5*(d[e]+d[i]),d[e+1]=.5*(d[e+1]+d[i+1]),d[e+2]=.5*(d[e+2]+d[i+2]);const r=Math.sqrt(d[e]*d[e]+d[e+1]*d[e+1]+d[e+2]*d[e+2]);d[e]/=r,d[e+1]/=r,d[e+2]/=r,d[i]=d[e],d[i+1]=d[e+1],d[i+2]=d[e+2]}}if(i){let e=3*S[0],i=3*S[t.length];for(y=0;y<x+C;y++){d[e]=.5*(d[e]+d[i]),d[e+1]=.5*(d[e+1]+d[i+1]),d[e+2]=.5*(d[e+2]+d[i+2]);const t=Math.sqrt(d[e]*d[e]+d[e+1]*d[e+1]+d[e+2]*d[e+2]);d[e]/=t,d[e+1]/=t,d[e+2]/=t,d[i]=d[e],d[i+1]=d[e+1],d[i+2]=d[e+2],e+=3,i+=3}}ot.P._ComputeSides(a,c,u,d,p,e.frontUVs,e.backUVs);let W=null;if(h){W=new Float32Array(4*h.length);for(let e=0;e<h.length;e++)W[4*e]=h[e].r,W[4*e+1]=h[e].g,W[4*e+2]=h[e].b,W[4*e+3]=h[e].a}const H=new ot.P,$=new Float32Array(c),q=new Float32Array(d),Y=new Float32Array(p);return H.indices=u,H.positions=$,H.normals=q,H.uvs=Y,W&&H.set(W,Ot.R.ColorKind),r&&(H._idx=S),H}function Js(e,t,i=null){const r=t.pathArray,s=t.closeArray,o=t.closePath,a=tt.e._GetDefaultSideOrientation(t.sideOrientation),l=t.instance,h=t.updatable;if(l){const e=n.AA.Vector3[0].setAll(Number.MAX_VALUE),i=n.AA.Vector3[1].setAll(-Number.MAX_VALUE),s=t=>{let s=r[0].length;const n=l;let o=0;const a=n._originalBuilderSideOrientation===tt.e.DOUBLESIDE?2:1;for(let l=1;l<=a;++l)for(let a=0;a<r.length;++a){const l=r[a],h=l.length;s=s<h?s:h;for(let r=0;r<s;++r){const s=l[r];t[o]=s.x,t[o+1]=s.y,t[o+2]=s.z,e.minimizeInPlaceFromFloats(s.x,s.y,s.z),i.maximizeInPlaceFromFloats(s.x,s.y,s.z),o+=3}if(n._creationDataStorage&&n._creationDataStorage.closePath){const e=l[0];t[o]=e.x,t[o+1]=e.y,t[o+2]=e.z,o+=3}}},o=l.getVerticesData(Ot.R.PositionKind);if(s(o),l.hasBoundingInfo?l.getBoundingInfo().reConstruct(e,i,l._worldMatrix):l.buildBoundingInfo(e,i,l._worldMatrix),l.updateVerticesData(Ot.R.PositionKind,o,!1,!1),t.colors){const e=l.getVerticesData(Ot.R.ColorKind);for(let i=0,r=0;i<t.colors.length;i++,r+=4){const s=t.colors[i];e[r]=s.r,e[r+1]=s.g,e[r+2]=s.b,e[r+3]=s.a}l.updateVerticesData(Ot.R.ColorKind,e,!1,!1)}if(t.uvs){const e=l.getVerticesData(Ot.R.UVKind);for(let i=0;i<t.uvs.length;i++)e[2*i]=t.uvs[i].x,e[2*i+1]=at.rX?1-t.uvs[i].y:t.uvs[i].y;l.updateVerticesData(Ot.R.UVKind,e,!1,!1)}if(!l.areNormalsFrozen||l.isFacetDataEnabled){const e=l.getIndices(),t=l.getVerticesData(Ot.R.NormalKind),i=l.isFacetDataEnabled?l.getFacetDataParameters():null;if(ot.P.ComputeNormals(o,e,t,i),l._creationDataStorage&&l._creationDataStorage.closePath){let e=0,i=0;for(let s=0;s<r.length;s++)e=3*l._creationDataStorage.idx[s],i=s+1<r.length?3*(l._creationDataStorage.idx[s+1]-1):t.length-3,t[e]=.5*(t[e]+t[i]),t[e+1]=.5*(t[e+1]+t[i+1]),t[e+2]=.5*(t[e+2]+t[i+2]),t[i]=t[e],t[i+1]=t[e+1],t[i+2]=t[e+2]}l.areNormalsFrozen||l.updateVerticesData(Ot.R.NormalKind,t,!1,!1)}return l}{const r=new tt.e(e,i);r._originalBuilderSideOrientation=a,r._creationDataStorage=new tt.Ez;const n=Ks(t);return o&&(r._creationDataStorage.idx=n._idx),r._creationDataStorage.closePath=o,r._creationDataStorage.closeArray=s,n.applyToMesh(r,h),r}}tt.e.CreateCapsule=(e,t,i)=>Zs(e,t,i),ot.P.CreateCapsule=js;const en={CreateRibbon:Js};function tn(e){const t=[],i=[],r=[],s=[],n=e.radius||.5,o=e.tessellation||64,a=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1,l=0===e.sideOrientation?0:e.sideOrientation||ot.P.DEFAULTSIDE;t.push(0,0,0),s.push(.5,.5);const h=2*Math.PI*a,c=1===a?h/o:h/(o-1);let u=0;for(let e=0;e<o;e++){const e=Math.cos(u),i=Math.sin(u),r=(e+1)/2,o=(1-i)/2;t.push(n*e,n*i,0),s.push(r,at.rX?1-o:o),u+=c}1===a&&(t.push(t[3],t[4],t[5]),s.push(s[2],at.rX?1-s[3]:s[3]));const d=t.length/3;for(let e=1;e<d-1;e++)i.push(e+1,0,e);ot.P.ComputeNormals(t,i,r),ot.P._ComputeSides(l,t,i,r,s,e.frontUVs,e.backUVs);const p=new ot.P;return p.indices=i,p.positions=t,p.normals=r,p.uvs=s,p}function rn(e,t={},i=null){const r=new tt.e(e,i);t.sideOrientation=tt.e._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;return tn(t).applyToMesh(r,t.updatable),r}ot.P.CreateRibbon=Ks,tt.e.CreateRibbon=(e,t,i=!1,r,s,n,o=!1,a,l)=>Js(e,{pathArray:t,closeArray:i,closePath:r,offset:s,updatable:o,sideOrientation:a,instance:l},n);const sn={CreateDisc:rn};function nn(e){const t=e.pattern||tt.e.NO_FLIP,i=e.tileWidth||e.tileSize||1,r=e.tileHeight||e.tileSize||1,s=e.alignHorizontal||0,n=e.alignVertical||0,o=e.width||e.size||1,a=Math.floor(o/i);let l=o-a*i;const h=e.height||e.size||1,c=Math.floor(h/r);let u=h-c*r;const d=i*a/2,p=r*c/2;let m=0,f=0,_=0,g=0,x=0,v=0;if(l>0||u>0){switch(_=-d,g=-p,x=d,v=p,s){case tt.e.CENTER:l/=2,_-=l,x+=l;break;case tt.e.LEFT:x+=l,m=-l/2;break;case tt.e.RIGHT:_-=l,m=l/2}switch(n){case tt.e.CENTER:u/=2,g-=u,v+=u;break;case tt.e.BOTTOM:v+=u,f=-u/2;break;case tt.e.TOP:g-=u,f=u/2}}const S=[],b=[],y=[];y[0]=[0,0,1,0,1,1,0,1],y[1]=[0,0,1,0,1,1,0,1],t!==tt.e.ROTATE_TILE&&t!==tt.e.ROTATE_ROW||(y[1]=[1,1,0,1,0,0,1,0]),t!==tt.e.FLIP_TILE&&t!==tt.e.FLIP_ROW||(y[1]=[1,0,0,0,0,1,1,1]),t!==tt.e.FLIP_N_ROTATE_TILE&&t!==tt.e.FLIP_N_ROTATE_ROW||(y[1]=[0,1,1,1,1,0,0,0]);let P=[];const T=[],C=[];let E=0;for(let e=0;e<c;e++)for(let s=0;s<a;s++)S.push(s*i-d+m,e*r-p+f,0),S.push((s+1)*i-d+m,e*r-p+f,0),S.push((s+1)*i-d+m,(e+1)*r-p+f,0),S.push(s*i-d+m,(e+1)*r-p+f,0),C.push(E,E+1,E+3,E+1,E+2,E+3),P=t===tt.e.FLIP_TILE||t===tt.e.ROTATE_TILE||t===tt.e.FLIP_N_ROTATE_TILE?P.concat(y[(s%2+e%2)%2]):t===tt.e.FLIP_ROW||t===tt.e.ROTATE_ROW||t===tt.e.FLIP_N_ROTATE_ROW?P.concat(y[e%2]):P.concat(y[0]),T.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),b.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1),E+=4;if(l>0||u>0){const e=u>0&&(n===tt.e.CENTER||n===tt.e.TOP),o=u>0&&(n===tt.e.CENTER||n===tt.e.BOTTOM),h=l>0&&(s===tt.e.CENTER||s===tt.e.RIGHT),y=l>0&&(s===tt.e.CENTER||s===tt.e.LEFT);let A,I,R,M,D=[];if(e&&h&&(S.push(_+m,g+f,0),S.push(-d+m,g+f,0),S.push(-d+m,g+u+f,0),S.push(_+m,g+u+f,0),C.push(E,E+1,E+3,E+1,E+2,E+3),E+=4,A=1-l/i,I=1-u/r,R=1,M=1,D=[A,I,R,I,R,M,A,M],t===tt.e.ROTATE_ROW&&(D=[1-A,1-I,1-R,1-I,1-R,1-M,1-A,1-M]),t===tt.e.FLIP_ROW&&(D=[1-A,I,1-R,I,1-R,M,1-A,M]),t===tt.e.FLIP_N_ROTATE_ROW&&(D=[A,1-I,R,1-I,R,1-M,A,1-M]),P=P.concat(D),T.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),b.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),e&&y&&(S.push(d+m,g+f,0),S.push(x+m,g+f,0),S.push(x+m,g+u+f,0),S.push(d+m,g+u+f,0),C.push(E,E+1,E+3,E+1,E+2,E+3),E+=4,A=0,I=1-u/r,R=l/i,M=1,D=[A,I,R,I,R,M,A,M],(t===tt.e.ROTATE_ROW||t===tt.e.ROTATE_TILE&&a%2==0)&&(D=[1-A,1-I,1-R,1-I,1-R,1-M,1-A,1-M]),(t===tt.e.FLIP_ROW||t===tt.e.FLIP_TILE&&a%2==0)&&(D=[1-A,I,1-R,I,1-R,M,1-A,M]),(t===tt.e.FLIP_N_ROTATE_ROW||t===tt.e.FLIP_N_ROTATE_TILE&&a%2==0)&&(D=[A,1-I,R,1-I,R,1-M,A,1-M]),P=P.concat(D),T.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),b.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),o&&h&&(S.push(_+m,p+f,0),S.push(-d+m,p+f,0),S.push(-d+m,v+f,0),S.push(_+m,v+f,0),C.push(E,E+1,E+3,E+1,E+2,E+3),E+=4,A=1-l/i,I=0,R=1,M=u/r,D=[A,I,R,I,R,M,A,M],(t===tt.e.ROTATE_ROW&&c%2==1||t===tt.e.ROTATE_TILE&&c%1==0)&&(D=[1-A,1-I,1-R,1-I,1-R,1-M,1-A,1-M]),(t===tt.e.FLIP_ROW&&c%2==1||t===tt.e.FLIP_TILE&&c%2==0)&&(D=[1-A,I,1-R,I,1-R,M,1-A,M]),(t===tt.e.FLIP_N_ROTATE_ROW&&c%2==1||t===tt.e.FLIP_N_ROTATE_TILE&&c%2==0)&&(D=[A,1-I,R,1-I,R,1-M,A,1-M]),P=P.concat(D),T.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),b.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),o&&y&&(S.push(d+m,p+f,0),S.push(x+m,p+f,0),S.push(x+m,v+f,0),S.push(d+m,v+f,0),C.push(E,E+1,E+3,E+1,E+2,E+3),E+=4,A=0,I=0,R=l/i,M=u/r,D=[A,I,R,I,R,M,A,M],(t===tt.e.ROTATE_ROW&&c%2==1||t===tt.e.ROTATE_TILE&&(c+a)%2==1)&&(D=[1-A,1-I,1-R,1-I,1-R,1-M,1-A,1-M]),(t===tt.e.FLIP_ROW&&c%2==1||t===tt.e.FLIP_TILE&&(c+a)%2==1)&&(D=[1-A,I,1-R,I,1-R,M,1-A,M]),(t===tt.e.FLIP_N_ROTATE_ROW&&c%2==1||t===tt.e.FLIP_N_ROTATE_TILE&&(c+a)%2==1)&&(D=[A,1-I,R,1-I,R,1-M,A,1-M]),P=P.concat(D),T.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),b.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),e){const e=[];A=0,I=1-u/r,R=1,M=1,e[0]=[A,I,R,I,R,M,A,M],e[1]=[A,I,R,I,R,M,A,M],t!==tt.e.ROTATE_TILE&&t!==tt.e.ROTATE_ROW||(e[1]=[1-A,1-I,1-R,1-I,1-R,1-M,1-A,1-M]),t!==tt.e.FLIP_TILE&&t!==tt.e.FLIP_ROW||(e[1]=[1-A,I,1-R,I,1-R,M,1-A,M]),t!==tt.e.FLIP_N_ROTATE_TILE&&t!==tt.e.FLIP_N_ROTATE_ROW||(e[1]=[A,1-I,R,1-I,R,1-M,A,1-M]);for(let r=0;r<a;r++)S.push(r*i-d+m,g+f,0),S.push((r+1)*i-d+m,g+f,0),S.push((r+1)*i-d+m,g+u+f,0),S.push(r*i-d+m,g+u+f,0),C.push(E,E+1,E+3,E+1,E+2,E+3),E+=4,P=t===tt.e.FLIP_TILE||t===tt.e.ROTATE_TILE||t===tt.e.FLIP_N_ROTATE_TILE?P.concat(e[(r+1)%2]):t===tt.e.FLIP_ROW||t===tt.e.ROTATE_ROW||t===tt.e.FLIP_N_ROTATE_ROW?P.concat(e[1]):P.concat(e[0]),T.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),b.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(o){const e=[];A=0,I=0,R=1,M=u/r,e[0]=[A,I,R,I,R,M,A,M],e[1]=[A,I,R,I,R,M,A,M],t!==tt.e.ROTATE_TILE&&t!==tt.e.ROTATE_ROW||(e[1]=[1-A,1-I,1-R,1-I,1-R,1-M,1-A,1-M]),t!==tt.e.FLIP_TILE&&t!==tt.e.FLIP_ROW||(e[1]=[1-A,I,1-R,I,1-R,M,1-A,M]),t!==tt.e.FLIP_N_ROTATE_TILE&&t!==tt.e.FLIP_N_ROTATE_ROW||(e[1]=[A,1-I,R,1-I,R,1-M,A,1-M]);for(let r=0;r<a;r++)S.push(r*i-d+m,v-u+f,0),S.push((r+1)*i-d+m,v-u+f,0),S.push((r+1)*i-d+m,v+f,0),S.push(r*i-d+m,v+f,0),C.push(E,E+1,E+3,E+1,E+2,E+3),E+=4,P=t===tt.e.FLIP_TILE||t===tt.e.ROTATE_TILE||t===tt.e.FLIP_N_ROTATE_TILE?P.concat(e[(r+c)%2]):t===tt.e.FLIP_ROW||t===tt.e.ROTATE_ROW||t===tt.e.FLIP_N_ROTATE_ROW?P.concat(e[c%2]):P.concat(e[0]),T.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),b.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(h){const e=[];A=1-l/i,I=0,R=1,M=1,e[0]=[A,I,R,I,R,M,A,M],e[1]=[A,I,R,I,R,M,A,M],t!==tt.e.ROTATE_TILE&&t!==tt.e.ROTATE_ROW||(e[1]=[1-A,1-I,1-R,1-I,1-R,1-M,1-A,1-M]),t!==tt.e.FLIP_TILE&&t!==tt.e.FLIP_ROW||(e[1]=[1-A,I,1-R,I,1-R,M,1-A,M]),t!==tt.e.FLIP_N_ROTATE_TILE&&t!==tt.e.FLIP_N_ROTATE_ROW||(e[1]=[A,1-I,R,1-I,R,1-M,A,1-M]);for(let i=0;i<c;i++)S.push(_+m,i*r-p+f,0),S.push(_+l+m,i*r-p+f,0),S.push(_+l+m,(i+1)*r-p+f,0),S.push(_+m,(i+1)*r-p+f,0),C.push(E,E+1,E+3,E+1,E+2,E+3),E+=4,P=t===tt.e.FLIP_TILE||t===tt.e.ROTATE_TILE||t===tt.e.FLIP_N_ROTATE_TILE?P.concat(e[(i+1)%2]):t===tt.e.FLIP_ROW||t===tt.e.ROTATE_ROW||t===tt.e.FLIP_N_ROTATE_ROW?P.concat(e[i%2]):P.concat(e[0]),T.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),b.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(y){const e=[];A=0,I=0,R=l/r,M=1,e[0]=[A,I,R,I,R,M,A,M],e[1]=[A,I,R,I,R,M,A,M],t!==tt.e.ROTATE_TILE&&t!==tt.e.ROTATE_ROW||(e[1]=[1-A,1-I,1-R,1-I,1-R,1-M,1-A,1-M]),t!==tt.e.FLIP_TILE&&t!==tt.e.FLIP_ROW||(e[1]=[1-A,I,1-R,I,1-R,M,1-A,M]),t!==tt.e.FLIP_N_ROTATE_TILE&&t!==tt.e.FLIP_N_ROTATE_ROW||(e[1]=[A,1-I,R,1-I,R,1-M,A,1-M]);for(let i=0;i<c;i++)S.push(x-l+m,i*r-p+f,0),S.push(x+m,i*r-p+f,0),S.push(x+m,(i+1)*r-p+f,0),S.push(x-l+m,(i+1)*r-p+f,0),C.push(E,E+1,E+3,E+1,E+2,E+3),E+=4,P=t===tt.e.FLIP_TILE||t===tt.e.ROTATE_TILE||t===tt.e.FLIP_N_ROTATE_TILE?P.concat(e[(i+a)%2]):t===tt.e.FLIP_ROW||t===tt.e.ROTATE_ROW||t===tt.e.FLIP_N_ROTATE_ROW?P.concat(e[i%2]):P.concat(e[0]),T.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),b.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}}const A=0===e.sideOrientation?0:e.sideOrientation||ot.P.DEFAULTSIDE;ot.P._ComputeSides(A,S,C,b,P,e.frontUVs,e.backUVs);const I=new ot.P;I.indices=C,I.positions=S,I.normals=b,I.uvs=P;const R=A===ot.P.DOUBLESIDE?T.concat(T):T;return I.colors=R,I}function on(e,t,i=null){const r=new tt.e(e,i);t.sideOrientation=tt.e._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;return nn(t).applyToMesh(r,t.updatable),r}ot.P.CreateDisc=tn,tt.e.CreateDisc=(e,t,i,r=null,s,n)=>rn(e,{radius:t,tessellation:i,sideOrientation:n,updatable:s},r);const an={CreateTiledPlane:on};function ln(e){const t=e.faceUV||new Array(6),i=e.faceColors,r=e.pattern||tt.e.NO_FLIP,s=e.width||e.size||1,a=e.height||e.size||1,l=e.depth||e.size||1,h=e.tileWidth||e.tileSize||1,c=e.tileHeight||e.tileSize||1,u=e.alignHorizontal||0,d=e.alignVertical||0,p=0===e.sideOrientation?0:e.sideOrientation||ot.P.DEFAULTSIDE;for(let e=0;e<6;e++)void 0===t[e]&&(t[e]=new n.IU(0,0,1,1)),i&&void 0===i[e]&&(i[e]=new o.ov(1,1,1,1));const m=s/2,f=a/2,_=l/2,g=[];for(let e=0;e<2;e++)g[e]=nn({pattern:r,tileWidth:h,tileHeight:c,width:s,height:a,alignVertical:d,alignHorizontal:u,sideOrientation:p});for(let e=2;e<4;e++)g[e]=nn({pattern:r,tileWidth:h,tileHeight:c,width:l,height:a,alignVertical:d,alignHorizontal:u,sideOrientation:p});let x=d;d===tt.e.BOTTOM?x=tt.e.TOP:d===tt.e.TOP&&(x=tt.e.BOTTOM);for(let e=4;e<6;e++)g[e]=nn({pattern:r,tileWidth:h,tileHeight:c,width:s,height:l,alignVertical:x,alignHorizontal:u,sideOrientation:p});let v=[],S=[],b=[],y=[];const P=[],T=[],C=[],E=[];let A=0,I=0;for(let e=0;e<6;e++){const r=g[e].positions.length;T[e]=[],C[e]=[];for(let t=0;t<r/3;t++)T[e].push(new n.Pq(g[e].positions[3*t],g[e].positions[3*t+1],g[e].positions[3*t+2])),C[e].push(new n.Pq(g[e].normals[3*t],g[e].normals[3*t+1],g[e].normals[3*t+2]));A=g[e].uvs.length,E[e]=[];for(let i=0;i<A;i+=2)E[e][i]=t[e].x+(t[e].z-t[e].x)*g[e].uvs[i],E[e][i+1]=t[e].y+(t[e].w-t[e].y)*g[e].uvs[i+1],at.rX&&(E[e][i+1]=1-E[e][i+1]);if(b=b.concat(E[e]),y=y.concat(g[e].indices.map((e=>e+I))),I+=T[e].length,i)for(let t=0;t<4;t++)P.push(i[e].r,i[e].g,i[e].b,i[e].a)}const R=new n.Pq(0,0,_),M=n.uq.RotationY(Math.PI);v=T[0].map((e=>n.Pq.TransformNormal(e,M).add(R))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[]),S=C[0].map((e=>n.Pq.TransformNormal(e,M))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[]),v=v.concat(T[1].map((e=>e.subtract(R))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[])),S=S.concat(C[1].map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[]));const D=new n.Pq(m,0,0),O=n.uq.RotationY(-Math.PI/2);v=v.concat(T[2].map((e=>n.Pq.TransformNormal(e,O).add(D))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[])),S=S.concat(C[2].map((e=>n.Pq.TransformNormal(e,O))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[]));const N=n.uq.RotationY(Math.PI/2);v=v.concat(T[3].map((e=>n.Pq.TransformNormal(e,N).subtract(D))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[])),S=S.concat(C[3].map((e=>n.Pq.TransformNormal(e,N))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[]));const w=new n.Pq(0,f,0),F=n.uq.RotationX(Math.PI/2);v=v.concat(T[4].map((e=>n.Pq.TransformNormal(e,F).add(w))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[])),S=S.concat(C[4].map((e=>n.Pq.TransformNormal(e,F))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[]));const B=n.uq.RotationX(-Math.PI/2);v=v.concat(T[5].map((e=>n.Pq.TransformNormal(e,B).subtract(w))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[])),S=S.concat(C[5].map((e=>n.Pq.TransformNormal(e,B))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[])),ot.P._ComputeSides(p,v,y,S,b);const V=new ot.P;if(V.indices=y,V.positions=v,V.normals=S,V.uvs=b,i){const e=p===ot.P.DOUBLESIDE?P.concat(P):P;V.colors=e}return V}function hn(e,t,i=null){const r=new tt.e(e,i);t.sideOrientation=tt.e._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;return ln(t).applyToMesh(r,t.updatable),r}ot.P.CreateTiledPlane=nn;const cn={CreateTiledBox:hn};function un(e){const t=[],i=[],r=[],s=[],o=e.radius||2,a=e.tube||.5,l=e.radialSegments||32,h=e.tubularSegments||32,c=e.p||2,u=e.q||3,d=0===e.sideOrientation?0:e.sideOrientation||ot.P.DEFAULTSIDE,p=e=>{const t=Math.cos(e),i=Math.sin(e),r=u/c*e,s=Math.cos(r),a=o*(2+s)*.5*t,l=o*(2+s)*i*.5,h=o*Math.sin(r)*.5;return new n.Pq(a,l,h)};let m,f;for(m=0;m<=l;m++){const e=m%l/l*2*c*Math.PI,t=p(e),r=p(e+.01),o=r.subtract(t);let u=r.add(t);const d=n.Pq.Cross(o,u);for(u=n.Pq.Cross(d,o),d.normalize(),u.normalize(),f=0;f<h;f++){const e=f%h/h*2*Math.PI,r=-a*Math.cos(e),n=a*Math.sin(e);i.push(t.x+r*u.x+n*d.x),i.push(t.y+r*u.y+n*d.y),i.push(t.z+r*u.z+n*d.z),s.push(m/l),s.push(at.rX?1-f/h:f/h)}}for(m=0;m<l;m++)for(f=0;f<h;f++){const e=(f+1)%h,i=m*h+f,r=(m+1)*h+f,s=(m+1)*h+e,n=m*h+e;t.push(n),t.push(r),t.push(i),t.push(n),t.push(s),t.push(r)}ot.P.ComputeNormals(i,t,r),ot.P._ComputeSides(d,i,t,r,s,e.frontUVs,e.backUVs);const _=new ot.P;return _.indices=t,_.positions=i,_.normals=r,_.uvs=s,_}function dn(e,t={},i){const r=new tt.e(e,i);t.sideOrientation=tt.e._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;return un(t).applyToMesh(r,t.updatable),r}ot.P.CreateTiledBox=ln;const pn={CreateTorusKnot:dn};ot.P.CreateTorusKnot=un,tt.e.CreateTorusKnot=(e,t,i,r,s,n,o,a,l,h)=>dn(e,{radius:t,tube:i,radialSegments:r,tubularSegments:s,p:n,q:o,sideOrientation:h,updatable:l},a);var mn=i(61440),fn=i(28986);tt.e._LinesMeshParser=(e,t)=>_n.Parse(e,t);class _n extends tt.e{_isShaderMaterial(e){return"ShaderMaterial"===e.getClassName()}constructor(e,t=null,r=null,s=null,n,a,l,h){super(e,t,r,s,n),this.useVertexColor=a,this.useVertexAlpha=l,this.color=new o.v9(1,1,1),this.alpha=1,this._shaderLanguage=0,s&&(this.color=s.color.clone(),this.alpha=s.alpha,this.useVertexColor=s.useVertexColor,this.useVertexAlpha=s.useVertexAlpha),this.intersectionThreshold=.1;const c={attributes:[Ot.R.PositionKind],uniforms:["world","viewProjection"],needAlphaBlending:!0,defines:[],useClipPlane:null,shaderLanguage:0};if(this.useVertexAlpha?c.defines.push("#define VERTEXALPHA"):c.needAlphaBlending=!1,this.useVertexColor?(c.defines.push("#define VERTEXCOLOR"),c.attributes.push(Ot.R.ColorKind)):(c.uniforms.push("color"),this._color4=new o.ov),h)this.material=h;else{this.getScene().getEngine().isWebGPU&&!_n.ForceGLSL&&(this._shaderLanguage=1),c.shaderLanguage=this._shaderLanguage,c.extraInitializationsAsync=async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,84935)),Promise.resolve().then(i.bind(i,50861))]):await Promise.all([Promise.resolve().then(i.bind(i,5216)),Promise.resolve().then(i.bind(i,15450))])},this.material=new rs("colorShader",this.getScene(),"color",c,!1),this.material.doNotSerialize=!0}}isReady(){return!!this._lineMaterial.isReady(this,!!this._userInstancedBuffersStorage||this.hasThinInstances)&&super.isReady()}getClassName(){return"LinesMesh"}get material(){return this._lineMaterial}set material(e){this._lineMaterial=e,this._lineMaterial.fillMode=fn.i.LineListDrawMode}get checkCollisions(){return!1}set checkCollisions(e){}_bind(e,t){if(!this._geometry)return this;const i=this.isUnIndexed?null:this._geometry.getIndexBuffer();if(!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(t,i):this._geometry._bind(t,i,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),!this.useVertexColor&&this._isShaderMaterial(this._lineMaterial)){const{r:e,g:t,b:i}=this.color;this._color4.set(e,t,i,this.alpha),this._lineMaterial.setColor4("color",this._color4)}return this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const r=this.getScene().getEngine();return this._unIndexed?r.drawArraysType(fn.i.LineListDrawMode,e.verticesStart,e.verticesCount,i):r.drawElementsType(fn.i.LineListDrawMode,e.indexStart,e.indexCount,i),this}dispose(e,t=!1,i){i||this._lineMaterial.dispose(!1,!1,!0),super.dispose(e)}clone(e,t=null,i){return new _n(e,this.getScene(),t,this,i)}createInstance(e){const t=new gn(e,this);if(this.instancedBuffers){t.instancedBuffers={};for(const e in this.instancedBuffers)t.instancedBuffers[e]=this.instancedBuffers[e]}return t}serialize(e){super.serialize(e),e.color=this.color.asArray(),e.alpha=this.alpha}static Parse(e,t){const i=new _n(e.name,t);return i.color=o.v9.FromArray(e.color),i.alpha=e.alpha,i}}_n.ForceGLSL=!1;class gn extends mn.Z{constructor(e,t){super(e,t),this.intersectionThreshold=t.intersectionThreshold}getClassName(){return"InstancedLinesMesh"}}function xn(e){const t=[],i=[],r=e.lines,s=e.colors,n=[];let o=0;for(let e=0;e<r.length;e++){const a=r[e];for(let r=0;r<a.length;r++){const{x:l,y:h,z:c}=a[r];if(i.push(l,h,c),s){const t=s[e],{r:i,g:o,b:a,a:l}=t[r];n.push(i,o,a,l)}r>0&&(t.push(o-1),t.push(o)),o++}}const a=new ot.P;return a.indices=t,a.positions=i,s&&(a.colors=n),a}function vn(e){const t=e.dashSize||3,i=e.gapSize||1,r=e.dashNb||200,s=e.points,o=[],a=[],l=n.Pq.Zero();let h=0,c=0,u=0,d=0,p=0,m=0,f=0;for(f=0;f<s.length-1;f++)s[f+1].subtractToRef(s[f],l),h+=l.length();for(u=h/r,d=t*u/(t+i),f=0;f<s.length-1;f++){s[f+1].subtractToRef(s[f],l),c=Math.floor(l.length()/u),l.normalize();for(let e=0;e<c;e++)p=u*e,o.push(s[f].x+p*l.x,s[f].y+p*l.y,s[f].z+p*l.z),o.push(s[f].x+(p+d)*l.x,s[f].y+(p+d)*l.y,s[f].z+(p+d)*l.z),a.push(m,m+1),m+=2}const _=new ot.P;return _.positions=o,_.indices=a,_}function Sn(e,t,i=null){const r=t.instance,s=t.lines,n=t.colors;if(r){const e=r.getVerticesData(Ot.R.PositionKind);let t,i;n&&(t=r.getVerticesData(Ot.R.ColorKind));let o=0,a=0;for(let r=0;r<s.length;r++){const l=s[r];for(let s=0;s<l.length;s++)e[o]=l[s].x,e[o+1]=l[s].y,e[o+2]=l[s].z,n&&t&&(i=n[r],t[a]=i[s].r,t[a+1]=i[s].g,t[a+2]=i[s].b,t[a+3]=i[s].a,a+=4),o+=3}return r.updateVerticesData(Ot.R.PositionKind,e,!1,!1),n&&t&&r.updateVerticesData(Ot.R.ColorKind,t,!1,!1),r.refreshBoundingInfo(),r}const o=new _n(e,i,null,void 0,void 0,!!n,t.useVertexAlpha,t.material);return xn(t).applyToMesh(o,t.updatable),o}function bn(e,t,i=null){const r=t.colors?[t.colors]:null;return Sn(e,{lines:[t.points],updatable:t.updatable,instance:t.instance,colors:r,useVertexAlpha:t.useVertexAlpha,material:t.material},i)}function yn(e,t,i=null){const r=t.points,s=t.instance,o=t.gapSize||1,a=t.dashSize||3;if(s){const e=e=>{const t=n.Pq.Zero(),i=e.length/6;let o=0,a=0,l=0,h=0,c=0,u=0,d=0,p=0;for(d=0;d<r.length-1;d++)r[d+1].subtractToRef(r[d],t),o+=t.length();l=o/i;const m=s._creationDataStorage.dashSize;for(h=m*l/(m+s._creationDataStorage.gapSize),d=0;d<r.length-1;d++)for(r[d+1].subtractToRef(r[d],t),a=Math.floor(t.length()/l),t.normalize(),p=0;p<a&&u<e.length;)c=l*p,e[u]=r[d].x+c*t.x,e[u+1]=r[d].y+c*t.y,e[u+2]=r[d].z+c*t.z,e[u+3]=r[d].x+(c+h)*t.x,e[u+4]=r[d].y+(c+h)*t.y,e[u+5]=r[d].z+(c+h)*t.z,u+=6,p++;for(;u<e.length;)e[u]=r[d].x,e[u+1]=r[d].y,e[u+2]=r[d].z,u+=3};return(t.dashNb||t.dashSize||t.gapSize||t.useVertexAlpha||t.material)&&m.V.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),s.updateMeshPositions(e,!1),s}const l=new _n(e,i,null,void 0,void 0,void 0,t.useVertexAlpha,t.material);return vn(t).applyToMesh(l,t.updatable),l._creationDataStorage=new tt.Ez,l._creationDataStorage.dashSize=a,l._creationDataStorage.gapSize=o,l}const Pn={CreateDashedLines:yn,CreateLineSystem:Sn,CreateLines:bn};ot.P.CreateLineSystem=xn,ot.P.CreateDashedLines=vn,tt.e.CreateLines=(e,t,i=null,r=!1,s=null)=>bn(e,{points:t,updatable:r,instance:s},i),tt.e.CreateDashedLines=(e,t,i,r,s,n=null,o,a)=>yn(e,{points:t,dashSize:i,gapSize:r,dashNb:s,updatable:o,instance:a},n);var Tn=i(21903);class Cn extends n.I9{constructor(e,t){super(e.x,e.y),this.index=t}}class En{constructor(){this.elements=[]}add(e){const t=[];return e.forEach((e=>{const i=new Cn(e,this.elements.length);t.push(i),this.elements.push(i)})),t}computeBounds(){const e=new n.I9(this.elements[0].x,this.elements[0].y),t=new n.I9(this.elements[0].x,this.elements[0].y);return this.elements.forEach((i=>{i.x<e.x?e.x=i.x:i.x>t.x&&(t.x=i.x),i.y<e.y?e.y=i.y:i.y>t.y&&(t.y=i.y)})),{min:e,max:t,width:t.x-e.x,height:t.y-e.y}}}class An{static Rectangle(e,t,i,r){return[new n.I9(e,t),new n.I9(i,t),new n.I9(i,r),new n.I9(e,r)]}static Circle(e,t=0,i=0,r=32){const s=[];let o=0;const a=2*Math.PI/r;for(let l=0;l<r;l++)s.push(new n.I9(t+Math.cos(o)*e,i+Math.sin(o)*e)),o-=a;return s}static Parse(e){const t=e.split(/[^-+eE.\d]+/).map(parseFloat).filter((e=>!isNaN(e)));let i;const r=[];for(i=0;i<(2147483646&t.length);i+=2)r.push(new n.I9(t[i],t[i+1]));return r}static StartingAt(e,t){return Tn.Cu.StartingAt(e,t)}}class In{_addToepoint(e){for(const t of e)this._epoints.push(t.x,t.y)}constructor(e,t,i,r=earcut){let s;this._points=new En,this._outlinepoints=new En,this._holes=new Array,this._epoints=new Array,this._eholes=new Array,this.bjsEarcut=r,this._name=e,this._scene=i||C.q.LastCreatedScene,s=t instanceof Tn.Cu?t.getPoints():t,this._addToepoint(s),this._points.add(s),this._outlinepoints.add(s),void 0===this.bjsEarcut&&m.V.Warn("Earcut was not found, the polygon will not be built.")}addHole(e){this._points.add(e);const t=new En;return t.add(e),this._holes.push(t),this._eholes.push(this._epoints.length/2),this._addToepoint(e),this}build(e=!1,t=0,i=2){const r=new tt.e(this._name,this._scene),s=this.buildVertexData(t,i);return r.setVerticesData(Ot.R.PositionKind,s.positions,e),r.setVerticesData(Ot.R.NormalKind,s.normals,e),r.setVerticesData(Ot.R.UVKind,s.uvs,e),r.setIndices(s.indices),r}buildVertexData(e=0,t=2){const i=new ot.P,r=[],s=[],n=[],o=this._points.computeBounds();this._points.elements.forEach((e=>{r.push(0,1,0),s.push(e.x,0,e.y),n.push((e.x-o.min.x)/o.width,(e.y-o.min.y)/o.height)}));const a=[],l=this.bjsEarcut(this._epoints,this._eholes,2);for(let e=0;e<l.length;e++)a.push(l[e]);if(e>0){const i=s.length/3;this._points.elements.forEach((t=>{r.push(0,-1,0),s.push(t.x,-e,t.y),n.push(1-(t.x-o.min.x)/o.width,1-(t.y-o.min.y)/o.height)}));const l=a.length;for(let e=0;e<l;e+=3){const t=a[e+0],r=a[e+1],s=a[e+2];a.push(s+i),a.push(r+i),a.push(t+i)}this._addSide(s,r,n,a,o,this._outlinepoints,e,!1,t),this._holes.forEach((i=>{this._addSide(s,r,n,a,o,i,e,!0,t)}))}return i.indices=a,i.positions=s,i.normals=r,i.uvs=n,i}_addSide(e,t,i,r,s,o,a,l,h){let c=e.length/3,u=0;for(let d=0;d<o.elements.length;d++){const p=o.elements[d],m=o.elements[(d+1)%o.elements.length];e.push(p.x,0,p.y),e.push(p.x,-a,p.y),e.push(m.x,0,m.y),e.push(m.x,-a,m.y);const f=o.elements[(d+o.elements.length-1)%o.elements.length],_=o.elements[(d+2)%o.elements.length];let g=new n.Pq(-(m.y-p.y),0,m.x-p.x),x=new n.Pq(-(p.y-f.y),0,p.x-f.x),v=new n.Pq(-(_.y-m.y),0,_.x-m.x);l||(g=g.scale(-1),x=x.scale(-1),v=v.scale(-1));const S=g.normalizeToNew();let b=x.normalizeToNew(),y=v.normalizeToNew();const P=n.Pq.Dot(b,S);b=P>h?P<ut.bH-1?new n.Pq(p.x,0,p.y).subtract(new n.Pq(m.x,0,m.y)).normalize():x.add(g).normalize():S;const T=n.Pq.Dot(v,g);y=T>h?T<ut.bH-1?new n.Pq(m.x,0,m.y).subtract(new n.Pq(p.x,0,p.y)).normalize():v.add(g).normalize():S,i.push(u/s.width,0),i.push(u/s.width,1),u+=g.length(),i.push(u/s.width,0),i.push(u/s.width,1),t.push(b.x,b.y,b.z),t.push(b.x,b.y,b.z),t.push(y.x,y.y,y.z),t.push(y.x,y.y,y.z),l?(r.push(c),r.push(c+2),r.push(c+1),r.push(c+1),r.push(c+2),r.push(c+3)):(r.push(c),r.push(c+1),r.push(c+2),r.push(c+1),r.push(c+3),r.push(c+2)),c+=4}}}function Rn(e,t,i,r,s,a,l){const h=i||new Array(3),c=r,u=[],d=l||!1;for(let e=0;e<3;e++)void 0===h[e]&&(h[e]=new n.IU(0,0,1,1)),c&&void 0===c[e]&&(c[e]=new o.ov(1,1,1,1));const p=e.getVerticesData(Ot.R.PositionKind),m=e.getVerticesData(Ot.R.NormalKind),f=e.getVerticesData(Ot.R.UVKind),_=e.getIndices(),g=p.length/9;let x=0,v=0,S=0,b=0,y=0;const P=[0];if(d)for(let e=g;e<p.length/3;e+=4)v=p[3*(e+2)]-p[3*e],S=p[3*(e+2)+2]-p[3*e+2],b=Math.sqrt(v*v+S*S),y+=b,P.push(y);let T=0,C=0;for(let e=0;e<m.length;e+=3)Math.abs(m[e+1])<.001&&(C=1),Math.abs(m[e+1]-1)<.001&&(C=0),Math.abs(m[e+1]+1)<.001&&(C=2),T=e/3,1===C?(x=T-g,f[2*T]=x%4<1.5?d?h[C].x+(h[C].z-h[C].x)*P[Math.floor(x/4)]/y:h[C].x:d?h[C].x+(h[C].z-h[C].x)*P[Math.floor(x/4)+1]/y:h[C].z,f[2*T+1]=x%2==0?at.rX?1-h[C].w:h[C].w:at.rX?1-h[C].y:h[C].y):(f[2*T]=(1-f[2*T])*h[C].x+f[2*T]*h[C].z,f[2*T+1]=(1-f[2*T+1])*h[C].y+f[2*T+1]*h[C].w,at.rX&&(f[2*T+1]=1-f[2*T+1])),c&&u.push(c[C].r,c[C].g,c[C].b,c[C].a);ot.P._ComputeSides(t,p,_,m,f,s,a);const E=new ot.P;if(E.indices=_,E.positions=p,E.normals=m,E.uvs=f,c){const e=t===ot.P.DOUBLESIDE?u.concat(u):u;E.colors=e}return E}function Mn(e,t,i=null,r=earcut){t.sideOrientation=tt.e._GetDefaultSideOrientation(t.sideOrientation);const s=t.shape,o=t.holes||[],a=t.depth||0,l=t.smoothingThreshold||2,h=[];let c=[];for(let e=0;e<s.length;e++)h[e]=new n.I9(s[e].x,s[e].z);h[0].equalsWithEpsilon(h[h.length-1],1e-8)&&h.pop();const u=new In(e,h,i||C.q.LastCreatedScene,r);for(let e=0;e<o.length;e++){c=[];for(let t=0;t<o[e].length;t++)c.push(new n.I9(o[e][t].x,o[e][t].z));u.addHole(c)}const d=u.build(!1,a,l);d._originalBuilderSideOrientation=t.sideOrientation;return Rn(d,t.sideOrientation,t.faceUV,t.faceColors,t.frontUVs,t.backUVs,t.wrap).applyToMesh(d,t.updatable),d}function Dn(e,t,i=null,r=earcut){return Mn(e,t,i,r)}const On={ExtrudePolygon:Dn,CreatePolygon:Mn};function Nn(e,t,i=null){const r=t.path,s=t.shape,n=t.scale||1,o=t.rotation||0,a=0===t.cap?0:t.cap||tt.e.NO_CAP,l=t.updatable,h=tt.e._GetDefaultSideOrientation(t.sideOrientation),c=t.instance||null,u=t.invertUV||!1,d=t.closeShape||!1,p=t.closePath||!1,m=t.capFunction||null;return Fn(e,s,r,n,o,null,null,p,d,a,!1,i,!!l,h,c,u,t.frontUVs||null,t.backUVs||null,t.firstNormal||null,!!t.adjustFrame,m)}function wn(e,t,i=null){const r=t.path,s=t.shape,n=t.scaleFunction||(()=>1),o=t.rotationFunction||(()=>0),a=t.closePath||t.ribbonCloseArray||!1,l=t.closeShape||t.ribbonClosePath||!1,h=0===t.cap?0:t.cap||tt.e.NO_CAP,c=t.updatable,u=t.firstNormal||null,d=t.adjustFrame||!1,p=tt.e._GetDefaultSideOrientation(t.sideOrientation),m=t.instance,f=t.invertUV||!1,_=t.capFunction||null;return Fn(e,s,r,null,null,n,o,a,l,h,!0,i,!!c,p,m||null,f,t.frontUVs||null,t.backUVs||null,u,d,_||null)}function Fn(e,t,i,r,s,o,a,l,h,c,u,d,p,m,f,_,g,x,v,S,b){const y=(e,t,i,r,s,o,a,l,h,c,u)=>{const d=i.getTangents(),p=i.getNormals(),m=i.getBinormals(),f=i.getDistances();if(u)for(let e=0;e<d.length;e++)if(0==d[e].x&&0==d[e].y&&0==d[e].z&&d[e].copyFrom(d[e-1]),0==p[e].x&&0==p[e].y&&0==p[e].z&&p[e].copyFrom(p[e-1]),0==m[e].x&&0==m[e].y&&0==m[e].z&&m[e].copyFrom(m[e-1]),e>0){let t=d[e-1];n.Pq.Dot(t,d[e])<0&&d[e].scaleInPlace(-1),t=p[e-1],n.Pq.Dot(t,p[e])<0&&p[e].scaleInPlace(-1),t=m[e-1],n.Pq.Dot(t,m[e])<0&&m[e].scaleInPlace(-1)}let _=0;const g=c&&l?l:()=>null!==o?o:0,x=c&&a?a:()=>null!==s?s:1;let v=h===tt.e.NO_CAP||h===tt.e.CAP_END?0:2;const S=n.AA.Matrix[0];for(let i=0;i<t.length;i++){const s=[],o=g(i,f[i]),a=x(i,f[i]);n.uq.RotationAxisToRef(d[i],_,S);for(let r=0;r<e.length;r++){const o=d[i].scale(e[r].z).add(p[i].scale(e[r].x)).add(m[i].scale(e[r].y)),l=n.Pq.Zero();n.Pq.TransformCoordinatesToRef(o,S,l),l.scaleInPlace(a).addInPlace(t[i]),s[r]=l}r[v]=s,_+=o,v++}const y=b||(e=>{const t=Array(),i=n.Pq.Zero();let r;for(r=0;r<e.length;r++)i.addInPlace(e[r]);for(i.scaleInPlace(1/e.length),r=0;r<e.length;r++)t.push(i);return t});switch(h){case tt.e.NO_CAP:break;case tt.e.CAP_START:r[0]=y(r[2]),r[1]=r[2];break;case tt.e.CAP_END:r[v]=r[v-1],r[v+1]=y(r[v-1]);break;case tt.e.CAP_ALL:r[0]=y(r[2]),r[1]=r[2],r[v]=r[v-1],r[v+1]=y(r[v-1])}return r};let P,T;if(f){const e=f._creationDataStorage;return P=v?e.path3D.update(i,v):e.path3D.update(i),T=y(t,i,e.path3D,e.pathArray,r,s,o,a,e.cap,u,S),f=Js("",{pathArray:T,closeArray:!1,closePath:!1,offset:0,updatable:!1,sideOrientation:0,instance:f},d||void 0)}P=v?new Tn.tO(i,v):new Tn.tO(i);T=y(t,i,P,new Array,r,s,o,a,c=c<0||c>3?0:c,u,S);const C=Js(e,{pathArray:T,closeArray:l,closePath:h,updatable:p,sideOrientation:m,invertUV:_,frontUVs:g||void 0,backUVs:x||void 0},d);return C._creationDataStorage.pathArray=T,C._creationDataStorage.path3D=P,C._creationDataStorage.cap=c,C}ot.P.CreatePolygon=Rn,tt.e.CreatePolygon=(e,t,i,r,s,n,o=earcut)=>Mn(e,{shape:t,holes:r,updatable:s,sideOrientation:n},i,o),tt.e.ExtrudePolygon=(e,t,i,r,s,n,o,a=earcut)=>Dn(e,{shape:t,holes:s,depth:i,updatable:n,sideOrientation:o},r,a);const Bn={ExtrudeShape:Nn,ExtrudeShapeCustom:wn};function Vn(e,t,i=null){const r=t.arc?t.arc<=0||t.arc>1?1:t.arc:1,s=void 0===t.closed||t.closed,o=t.shape,a=t.radius||1,l=t.tessellation||64,h=t.clip||0,c=t.updatable,u=tt.e._GetDefaultSideOrientation(t.sideOrientation),d=t.cap||tt.e.NO_CAP,p=2*Math.PI,m=[],f=t.invertUV||!1;let _=0,g=0;const x=p/l*r;let v,S;for(_=0;_<=l-h;_++){for(S=[],d!=tt.e.CAP_START&&d!=tt.e.CAP_ALL||(S.push(new n.Pq(0,o[0].y,0)),S.push(new n.Pq(Math.cos(_*x)*o[0].x*a,o[0].y,Math.sin(_*x)*o[0].x*a))),g=0;g<o.length;g++)v=new n.Pq(Math.cos(_*x)*o[g].x*a,o[g].y,Math.sin(_*x)*o[g].x*a),S.push(v);d!=tt.e.CAP_END&&d!=tt.e.CAP_ALL||(S.push(new n.Pq(Math.cos(_*x)*o[o.length-1].x*a,o[o.length-1].y,Math.sin(_*x)*o[o.length-1].x*a)),S.push(new n.Pq(0,o[o.length-1].y,0))),m.push(S)}return Js(e,{pathArray:m,closeArray:s,sideOrientation:u,updatable:c,invertUV:f,frontUVs:t.frontUVs,backUVs:t.backUVs},i)}tt.e.ExtrudeShape=(e,t,i,r,s,n,o=null,a,l,h)=>Nn(e,{shape:t,path:i,scale:r,rotation:s,cap:0===n?0:n||tt.e.NO_CAP,sideOrientation:l,instance:h,updatable:a},o),tt.e.ExtrudeShapeCustom=(e,t,i,r,s,n,o,a,l,h,c,u)=>wn(e,{shape:t,path:i,scaleFunction:r,rotationFunction:s,ribbonCloseArray:n,ribbonClosePath:o,cap:0===a?0:a||tt.e.NO_CAP,sideOrientation:c,instance:u,updatable:h},l);const Ln={CreateLathe:Vn};function kn(e,t,i=null){const r=t.path;let s=t.instance,o=1;void 0!==t.radius?o=t.radius:s&&(o=s._creationDataStorage.radius);const a=t.tessellation||64,l=t.radiusFunction||null;let h=t.cap||tt.e.NO_CAP;const c=t.invertUV||!1,u=t.updatable,d=tt.e._GetDefaultSideOrientation(t.sideOrientation);t.arc=t.arc&&(t.arc<=0||t.arc>1)?1:t.arc||1;const p=(e,t,i,r,s,o,a,l)=>{const h=t.getTangents(),c=t.getNormals(),u=t.getDistances(),d=2*Math.PI/s*l,p=o||(()=>r);let m,f,_,g;const x=n.AA.Matrix[0];let v=a===tt.e.NO_CAP||a===tt.e.CAP_END?0:2;for(let t=0;t<e.length;t++){f=p(t,u[t]),m=Array(),_=c[t];for(let i=0;i<s;i++)n.uq.RotationAxisToRef(h[t],d*i,x),g=m[i]?m[i]:n.Pq.Zero(),n.Pq.TransformCoordinatesToRef(_,x,g),g.scaleInPlace(f).addInPlace(e[t]),m[i]=g;i[v]=m,v++}const S=(t,i)=>{const r=Array();for(let s=0;s<t;s++)r.push(e[i]);return r};switch(a){case tt.e.NO_CAP:break;case tt.e.CAP_START:i[0]=S(s,0),i[1]=i[2].slice(0);break;case tt.e.CAP_END:i[v]=i[v-1].slice(0),i[v+1]=S(s,e.length-1);break;case tt.e.CAP_ALL:i[0]=S(s,0),i[1]=i[2].slice(0),i[v]=i[v-1].slice(0),i[v+1]=S(s,e.length-1)}return i};let m,f;if(s){const e=s._creationDataStorage,i=t.arc||e.arc;return m=e.path3D.update(r),f=p(r,m,e.pathArray,o,e.tessellation,l,e.cap,i),s=Js("",{pathArray:f,instance:s}),e.path3D=m,e.pathArray=f,e.arc=i,e.radius=o,s}m=new Tn.tO(r);h=h<0||h>3?0:h,f=p(r,m,new Array,o,a,l,h,t.arc);const _=Js(e,{pathArray:f,closePath:!0,closeArray:!1,updatable:u,sideOrientation:d,invertUV:c,frontUVs:t.frontUVs,backUVs:t.backUVs},i);return _._creationDataStorage.pathArray=f,_._creationDataStorage.path3D=m,_._creationDataStorage.tessellation=a,_._creationDataStorage.cap=h,_._creationDataStorage.arc=t.arc,_._creationDataStorage.radius=o,_}tt.e.CreateLathe=(e,t,i,r,s,n,o)=>Vn(e,{shape:t,radius:i,tessellation:r,sideOrientation:o,updatable:n},s);const Gn={CreateTube:kn};function zn(e){const t=[];t[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]},t[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]},t[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]},t[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]},t[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]},t[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]},t[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]},t[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]},t[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]},t[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]},t[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]},t[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]},t[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]},t[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]},t[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};const i=e.type&&(e.type<0||e.type>=t.length)?0:e.type||0,r=e.size,s=e.sizeX||r||1,a=e.sizeY||r||1,l=e.sizeZ||r||1,h=e.custom||t[i],c=h.face.length,u=e.faceUV||new Array(c),d=e.faceColors,p=void 0===e.flat||e.flat,m=0===e.sideOrientation?0:e.sideOrientation||ot.P.DEFAULTSIDE,f=[],_=[],g=[],x=[],v=[];let S=0,b=0;const y=[];let P,T,C,E,A,I,R=0,M=0;if(p)for(M=0;M<c;M++)d&&void 0===d[M]&&(d[M]=new o.ov(1,1,1,1)),u&&void 0===u[M]&&(u[M]=new n.IU(0,0,1,1));if(p)for(M=0;M<c;M++){const e=h.face[M].length;for(C=2*Math.PI/e,E=.5*Math.tan(C/2),A=.5,R=0;R<e;R++)f.push(h.vertex[h.face[M][R]][0]*s,h.vertex[h.face[M][R]][1]*a,h.vertex[h.face[M][R]][2]*l),y.push(S),S++,P=u[M].x+(u[M].z-u[M].x)*(.5+E),T=u[M].y+(u[M].w-u[M].y)*(A-.5),x.push(P,at.rX?1-T:T),I=E*Math.cos(C)-A*Math.sin(C),A=E*Math.sin(C)+A*Math.cos(C),E=I,d&&v.push(d[M].r,d[M].g,d[M].b,d[M].a);for(R=0;R<e-2;R++)_.push(y[0+b],y[R+2+b],y[R+1+b]);b+=e}else{for(R=0;R<h.vertex.length;R++)f.push(h.vertex[R][0]*s,h.vertex[R][1]*a,h.vertex[R][2]*l),x.push(0,at.rX?1:0);for(M=0;M<c;M++)for(R=0;R<h.face[M].length-2;R++)_.push(h.face[M][0],h.face[M][R+2],h.face[M][R+1])}ot.P.ComputeNormals(f,_,g),ot.P._ComputeSides(m,f,_,g,x,e.frontUVs,e.backUVs);const D=new ot.P;return D.positions=f,D.indices=_,D.normals=g,D.uvs=x,d&&p&&(D.colors=v),D}function Un(e,t={},i=null){const r=new tt.e(e,i);t.sideOrientation=tt.e._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;return zn(t).applyToMesh(r,t.updatable),r}tt.e.CreateTube=(e,t,i,r,s,n,o,a,l,h)=>kn(e,{path:t,radius:i,tessellation:r,radiusFunction:s,arc:1,cap:n,updatable:a,sideOrientation:l,instance:h},o);const Wn={CreatePolyhedron:Un};function Hn(e){const t=e.sideOrientation||ot.P.DEFAULTSIDE,i=e.radius||1,r=void 0===e.flat||e.flat,s=0|(e.subdivisions||4),o=e.radiusX||i,a=e.radiusY||i,l=e.radiusZ||i,h=(1+Math.sqrt(5))/2,c=[-1,h,-0,1,h,0,-1,-h,0,1,-h,0,0,-1,-h,0,1,-h,0,-1,h,0,1,h,h,0,1,h,0,-1,-h,0,1,-h,0,-1],u=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],d=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],p=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],m=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],f=[],_=[],g=[],x=[];let v=0;const S=new Array(3),b=new Array(3);let y;for(y=0;y<3;y++)S[y]=n.Pq.Zero(),b[y]=n.I9.Zero();for(let e=0;e<20;e++){for(y=0;y<3;y++){const t=u[3*e+y];S[y].copyFromFloats(c[3*d[t]],c[3*d[t]+1],c[3*d[t]+2]),S[y].normalize(),b[y].copyFromFloats(.134765625*p[2*t]+.05859375+-.0390625*m[e],.2333984375*p[2*t+1]+.025390625+.01953125*m[e])}const t=(e,t,i,h)=>{const c=n.Pq.Lerp(S[0],S[2],t/s),u=n.Pq.Lerp(S[1],S[2],t/s),d=s===t?S[2]:n.Pq.Lerp(c,u,e/(s-t));let p;if(d.normalize(),r){const e=n.Pq.Lerp(S[0],S[2],h/s),t=n.Pq.Lerp(S[1],S[2],h/s);p=n.Pq.Lerp(e,t,i/(s-h))}else p=new n.Pq(d.x,d.y,d.z);p.x/=o,p.y/=a,p.z/=l,p.normalize();const m=n.I9.Lerp(b[0],b[2],t/s),y=n.I9.Lerp(b[1],b[2],t/s),P=s===t?b[2]:n.I9.Lerp(m,y,e/(s-t));_.push(d.x*o,d.y*a,d.z*l),g.push(p.x,p.y,p.z),x.push(P.x,at.rX?1-P.y:P.y),f.push(v),v++};for(let e=0;e<s;e++)for(let i=0;i+e<s;i++)t(i,e,i+1/3,e+1/3),t(i+1,e,i+1/3,e+1/3),t(i,e+1,i+1/3,e+1/3),i+e+1<s&&(t(i+1,e,i+2/3,e+2/3),t(i+1,e+1,i+2/3,e+2/3),t(i,e+1,i+2/3,e+2/3))}ot.P._ComputeSides(t,_,f,g,x,e.frontUVs,e.backUVs);const P=new ot.P;return P.indices=f,P.positions=_,P.normals=g,P.uvs=x,P}function $n(e,t={},i=null){const r=new tt.e(e,i);t.sideOrientation=tt.e._GetDefaultSideOrientation(t.sideOrientation),r._originalBuilderSideOrientation=t.sideOrientation;return Hn(t).applyToMesh(r,t.updatable),r}ot.P.CreatePolyhedron=zn,tt.e.CreatePolyhedron=(e,t,i)=>Un(e,t,i);const qn={CreateIcoSphere:$n};ot.P.CreateIcoSphere=Hn,tt.e.CreateIcoSphere=(e,t,i)=>$n(e,t,i);const Yn=new n.Pq(1,0,0),Xn=new n.Pq(-1,0,0),jn=new n.Pq(0,1,0),Zn=new n.Pq(0,-1,0),Qn=new n.Pq(0,0,1),Kn=new n.Pq(0,0,-1);class Jn{constructor(e=n.Pq.Zero(),t=n.Pq.Up(),i=n.I9.Zero(),r=0,s=0,o=null,a=null,l=null,h=null){this.position=e,this.normal=t,this.uv=i,this.vertexIdx=r,this.vertexIdxForBones=s,this.localPositionOverride=o,this.localNormalOverride=a,this.matrixIndicesOverride=l,this.matrixWeightsOverride=h}clone(){return new Jn(this.position.clone(),this.normal.clone(),this.uv.clone(),this.vertexIdx,this.vertexIdxForBones,this.localPositionOverride?.slice(),this.localNormalOverride?.slice(),this.matrixIndicesOverride?.slice(),this.matrixWeightsOverride?.slice())}}function eo(e,t,i){const r=!!t.skeleton,s=i.localMode||r,o=t.getIndices(),a=r?t.getPositionData(!0,!0):t.getVerticesData(Ot.R.PositionKind),l=r?t.getNormalsData(!0,!0):t.getVerticesData(Ot.R.NormalKind),h=s?r?t.getVerticesData(Ot.R.PositionKind):a:null,c=s?r?t.getVerticesData(Ot.R.NormalKind):l:null,u=t.getVerticesData(Ot.R.UVKind),d=r?t.getVerticesData(Ot.R.MatricesIndicesKind):null,p=r?t.getVerticesData(Ot.R.MatricesWeightsKind):null,m=r?t.getVerticesData(Ot.R.MatricesIndicesExtraKind):null,f=r?t.getVerticesData(Ot.R.MatricesWeightsExtraKind):null,_=i.position||n.Pq.Zero();let g=i.normal||n.Pq.Up();const x=i.size||n.Pq.One(),v=i.angle||0;if(!g){const e=new n.Pq(0,0,1),i=t.getScene().activeCamera,r=n.Pq.TransformCoordinates(e,i.getWorldMatrix());g=i.globalPosition.subtract(r)}const S=-Math.atan2(g.z,g.x)-Math.PI/2,b=Math.sqrt(g.x*g.x+g.z*g.z),y=Math.atan2(g.y,b),P=new ot.P;P.indices=[],P.positions=[],P.normals=[],P.uvs=[],P.matricesIndices=r?[]:null,P.matricesWeights=r?[]:null,P.matricesIndicesExtra=m?[]:null,P.matricesWeightsExtra=f?[]:null;let T=0;const C=(e,t)=>{const r=new Jn;if(!o||!a||!l)return r;const s=o[e];if(r.vertexIdx=3*s,r.vertexIdxForBones=4*s,r.position=new n.Pq(a[3*s],a[3*s+1],a[3*s+2]),n.Pq.TransformCoordinatesToRef(r.position,t,r.position),r.normal=new n.Pq(l[3*s],l[3*s+1],l[3*s+2]),n.Pq.TransformNormalToRef(r.normal,t,r.normal),i.captureUVS&&u){const e=u[2*s+1];r.uv=new n.I9(u[2*s],at.rX?1-e:e)}return r},E=[0,0,0,0],A=(e,t)=>{if(0===e.length)return e;const i=.5*Math.abs(n.Pq.Dot(x,t)),r=(e,t,i,r)=>{for(let s=0;s<r;++s)if(e[i+s]===t)return i+s;return-1},s=(e,s)=>{const o=n.Pq.GetClipFactor(e.position,s.position,t,i);let a=E,l=E;if(d&&p){const t=e.matrixIndicesOverride?0:e.vertexIdxForBones,i=e.matrixIndicesOverride??d,n=e.matrixWeightsOverride??p,h=s.matrixIndicesOverride?0:s.vertexIdxForBones,c=s.matrixIndicesOverride??d,u=s.matrixWeightsOverride??p;a=[0,0,0,0],l=[0,0,0,0];let m=0;for(let e=0;e<4;++e)if(n[t+e]>0){const s=r(c,i[t+e],h,4);a[m]=i[t+e],l[m]=(0,yt.Lerp)(n[t+e],s>=0?u[s]:0,o),m++}for(let e=0;e<4&&m<4;++e){const s=c[h+e];-1===r(i,s,t,4)&&(a[m]=s,l[m]=(0,yt.Lerp)(0,u[h+e],o),m++)}const f=l[0]+l[1]+l[2]+l[3];l[0]/=f,l[1]/=f,l[2]/=f,l[3]/=f}const u=e.localPositionOverride?e.localPositionOverride[0]:h?.[e.vertexIdx]??0,m=e.localPositionOverride?e.localPositionOverride[1]:h?.[e.vertexIdx+1]??0,f=e.localPositionOverride?e.localPositionOverride[2]:h?.[e.vertexIdx+2]??0,_=s.localPositionOverride?s.localPositionOverride[0]:h?.[s.vertexIdx]??0,g=s.localPositionOverride?s.localPositionOverride[1]:h?.[s.vertexIdx+1]??0,x=s.localPositionOverride?s.localPositionOverride[2]:h?.[s.vertexIdx+2]??0,v=e.localNormalOverride?e.localNormalOverride[0]:c?.[e.vertexIdx]??0,S=e.localNormalOverride?e.localNormalOverride[1]:c?.[e.vertexIdx+1]??0,b=e.localNormalOverride?e.localNormalOverride[2]:c?.[e.vertexIdx+2]??0,y=v+((s.localNormalOverride?s.localNormalOverride[0]:c?.[s.vertexIdx]??0)-v)*o,P=S+((s.localNormalOverride?s.localNormalOverride[1]:c?.[s.vertexIdx+1]??0)-S)*o,T=b+((s.localNormalOverride?s.localNormalOverride[2]:c?.[s.vertexIdx+2]??0)-b)*o,C=Math.sqrt(y*y+P*P+T*T);return new Jn(n.Pq.Lerp(e.position,s.position,o),n.Pq.Lerp(e.normal,s.normal,o).normalize(),n.I9.Lerp(e.uv,s.uv,o),-1,-1,h?[u+(_-u)*o,m+(g-m)*o,f+(x-f)*o]:null,c?[y/C,P/C,T/C]:null,a,l)};let o=null;e.length>3&&(o=[]);for(let r=0;r<e.length;r+=3){let a=0,l=null,h=null,c=null,u=null;const d=n.Pq.Dot(e[r].position,t)-i>0,p=n.Pq.Dot(e[r+1].position,t)-i>0,m=n.Pq.Dot(e[r+2].position,t)-i>0;switch(a=(d?1:0)+(p?1:0)+(m?1:0),a){case 0:e.length>3?(o.push(e[r]),o.push(e[r+1]),o.push(e[r+2])):o=e;break;case 1:if(o=o??new Array,d&&(l=e[r+1],h=e[r+2],c=s(e[r],l),u=s(e[r],h)),p){l=e[r],h=e[r+2],c=s(e[r+1],l),u=s(e[r+1],h),o.push(c),o.push(h.clone()),o.push(l.clone()),o.push(h.clone()),o.push(c.clone()),o.push(u);break}m&&(l=e[r],h=e[r+1],c=s(e[r+2],l),u=s(e[r+2],h)),l&&h&&c&&u&&(o.push(l.clone()),o.push(h.clone()),o.push(c),o.push(u),o.push(c.clone()),o.push(h.clone()));break;case 2:o=o??new Array,d||(l=e[r].clone(),h=s(l,e[r+1]),c=s(l,e[r+2]),o.push(l),o.push(h),o.push(c)),p||(l=e[r+1].clone(),h=s(l,e[r+2]),c=s(l,e[r]),o.push(l),o.push(h),o.push(c)),m||(l=e[r+2].clone(),h=s(l,e[r]),c=s(l,e[r+1]),o.push(l),o.push(h),o.push(c))}}return o},I=t instanceof tt.e?t:null,R=I?._thinInstanceDataStorage.matrixData,M=I?.thinInstanceCount||1,D=n.AA.Matrix[0];D.copyFrom(n.uq.IdentityReadOnly);for(let e=0;e<M;++e){if(I?.hasThinInstances&&R){const t=16*e;D.setRowFromFloats(0,R[t+0],R[t+1],R[t+2],R[t+3]),D.setRowFromFloats(1,R[t+4],R[t+5],R[t+6],R[t+7]),D.setRowFromFloats(2,R[t+8],R[t+9],R[t+10],R[t+11]),D.setRowFromFloats(3,R[t+12],R[t+13],R[t+14],R[t+15])}const r=n.uq.RotationYawPitchRoll(S,y,v).multiply(n.uq.Translation(_.x,_.y,_.z)),a=n.uq.Invert(r),l=t.getWorldMatrix(),u=D.multiply(l).multiply(a),g=new Array(3);for(let e=0;e<o.length;e+=3){let t=g;if(t[0]=C(e,u),t[1]=C(e+1,u),t[2]=C(e+2,u),!(i.cullBackFaces&&-t[0].normal.z<=0&&-t[1].normal.z<=0&&-t[2].normal.z<=0)&&(t=A(t,Yn),t&&(t=A(t,Xn),t&&(t=A(t,jn),t&&(t=A(t,Zn),t&&(t=A(t,Qn),t&&(t=A(t,Kn),t)))))))for(let e=0;e<t.length;e++){const r=t[e];if(P.indices.push(T),s?(r.localPositionOverride?(P.positions[3*T]=r.localPositionOverride[0],P.positions[3*T+1]=r.localPositionOverride[1],P.positions[3*T+2]=r.localPositionOverride[2]):h&&(P.positions[3*T]=h[r.vertexIdx],P.positions[3*T+1]=h[r.vertexIdx+1],P.positions[3*T+2]=h[r.vertexIdx+2]),r.localNormalOverride?(P.normals[3*T]=r.localNormalOverride[0],P.normals[3*T+1]=r.localNormalOverride[1],P.normals[3*T+2]=r.localNormalOverride[2]):c&&(P.normals[3*T]=c[r.vertexIdx],P.normals[3*T+1]=c[r.vertexIdx+1],P.normals[3*T+2]=c[r.vertexIdx+2])):(r.position.toArray(P.positions,3*T),r.normal.toArray(P.normals,3*T)),P.matricesIndices&&P.matricesWeights&&(r.matrixIndicesOverride?(P.matricesIndices[4*T]=r.matrixIndicesOverride[0],P.matricesIndices[4*T+1]=r.matrixIndicesOverride[1],P.matricesIndices[4*T+2]=r.matrixIndicesOverride[2],P.matricesIndices[4*T+3]=r.matrixIndicesOverride[3]):(d&&(P.matricesIndices[4*T]=d[r.vertexIdxForBones],P.matricesIndices[4*T+1]=d[r.vertexIdxForBones+1],P.matricesIndices[4*T+2]=d[r.vertexIdxForBones+2],P.matricesIndices[4*T+3]=d[r.vertexIdxForBones+3]),m&&P.matricesIndicesExtra&&(P.matricesIndicesExtra[4*T]=m[r.vertexIdxForBones],P.matricesIndicesExtra[4*T+1]=m[r.vertexIdxForBones+1],P.matricesIndicesExtra[4*T+2]=m[r.vertexIdxForBones+2],P.matricesIndicesExtra[4*T+3]=m[r.vertexIdxForBones+3])),r.matrixWeightsOverride?(P.matricesWeights[4*T]=r.matrixWeightsOverride[0],P.matricesWeights[4*T+1]=r.matrixWeightsOverride[1],P.matricesWeights[4*T+2]=r.matrixWeightsOverride[2],P.matricesWeights[4*T+3]=r.matrixWeightsOverride[3]):(p&&(P.matricesWeights[4*T]=p[r.vertexIdxForBones],P.matricesWeights[4*T+1]=p[r.vertexIdxForBones+1],P.matricesWeights[4*T+2]=p[r.vertexIdxForBones+2],P.matricesWeights[4*T+3]=p[r.vertexIdxForBones+3]),f&&P.matricesWeightsExtra&&(P.matricesWeightsExtra[4*T]=f[r.vertexIdxForBones],P.matricesWeightsExtra[4*T+1]=f[r.vertexIdxForBones+1],P.matricesWeightsExtra[4*T+2]=f[r.vertexIdxForBones+2],P.matricesWeightsExtra[4*T+3]=f[r.vertexIdxForBones+3]))),i.captureUVS)r.uv.toArray(P.uvs,2*T);else{P.uvs.push(.5+r.position.x/x.x);const e=.5+r.position.y/x.y;P.uvs.push(at.rX?1-e:e)}T++}}}0===P.indices.length&&(P.indices=null),0===P.positions.length&&(P.positions=null),0===P.normals.length&&(P.normals=null),0===P.uvs.length&&(P.uvs=null),0===P.matricesIndices?.length&&(P.matricesIndices=null),0===P.matricesWeights?.length&&(P.matricesWeights=null),0===P.matricesIndicesExtra?.length&&(P.matricesIndicesExtra=null),0===P.matricesWeightsExtra?.length&&(P.matricesWeightsExtra=null);const O=new tt.e(e,t.getScene());return P.applyToMesh(O),s?(O.skeleton=t.skeleton,O.parent=t):(O.position=_.clone(),O.rotation=new n.Pq(y,S,v)),O.computeWorldMatrix(!0),O.refreshBoundingInfo(!0,!0),O}const to={CreateDecal:eo};tt.e.CreateDecal=(e,t,i,r,s,n)=>eo(e,t,{position:i,normal:r,size:s,angle:n});class io{constructor(e=0,t=0){this.x=e,this.y=t,e!==Math.floor(e)&&(e=Math.floor(e),m.V.Warn("x is not an integer, floor(x) used")),t!==Math.floor(t)&&(t=Math.floor(t),m.V.Warn("y is not an integer, floor(y) used"))}clone(){return new io(this.x,this.y)}rotate60About(e){const t=this.x;return this.x=e.x+e.y-this.y,this.y=t+this.y-e.x,this}rotateNeg60About(e){const t=this.x;return this.x=t+this.y-e.y,this.y=e.x+e.y-t,this}rotate120(e,t){e!==Math.floor(e)&&(e=Math.floor(e),m.V.Warn("m not an integer only floor(m) used")),t!==Math.floor(t)&&(t=Math.floor(t),m.V.Warn("n not an integer only floor(n) used"));const i=this.x;return this.x=e-i-this.y,this.y=t+i,this}rotateNeg120(e,t){e!==Math.floor(e)&&(e=Math.floor(e),m.V.Warn("m is not an integer, floor(m) used")),t!==Math.floor(t)&&(t=Math.floor(t),m.V.Warn("n is not an integer,   floor(n) used"));const i=this.x;return this.x=this.y-t,this.y=e+t-i-this.y,this}toCartesianOrigin(e,t){const i=n.Pq.Zero();return i.x=e.x+2*this.x*t+this.y*t,i.y=e.y+Math.sqrt(3)*this.y*t,i}static Zero(){return new io(0,0)}}class ro{constructor(){this.cartesian=[],this.vertices=[],this.max=[],this.min=[],this.closestTo=[],this.innerFacets=[],this.isoVecsABOB=[],this.isoVecsOBOA=[],this.isoVecsBAOA=[],this.vertexTypes=[],this.IDATA=new so("icosahedron","Regular",[[0,ut.a6,-1],[-ut.a6,1,0],[-1,0,-ut.a6],[1,0,-ut.a6],[ut.a6,1,0],[0,ut.a6,1],[-1,0,ut.a6],[-ut.a6,-1,0],[0,-ut.a6,-1],[ut.a6,-1,0],[1,0,ut.a6],[0,-ut.a6,1]],[[0,2,1],[0,3,2],[0,4,3],[0,5,4],[0,1,5],[7,6,1],[8,7,2],[9,8,3],[10,9,4],[6,10,5],[2,7,1],[3,8,2],[4,9,3],[5,10,4],[1,6,5],[11,6,7],[11,7,8],[11,8,9],[11,9,10],[11,10,6]])}setIndices(){let e=12;const t={},i=this.m,r=this.n;let s,n,o,a,l,h=i,c=1,u=0;0!==r&&(h=(0,yt.HighestCommonFactor)(i,r)),c=i/h,u=r/h;const d=io.Zero(),p=new io(i,r),m=new io(-r,i+r),f=io.Zero(),_=io.Zero(),g=io.Zero();let x,v,S,b,y=[];const P=[],T=this.vertByDist,C=(i,r,s,n)=>{x=i+"|"+s,v=r+"|"+n,x in t||v in t?x in t&&!(v in t)?t[v]=t[x]:v in t&&!(x in t)&&(t[x]=t[v]):(t[x]=e,t[v]=e,e++),T[s][0]>2?P[t[x]]=[-T[s][0],T[s][1],t[x]]:P[t[x]]=[y[T[s][0]],T[s][1],t[x]]};this.IDATA.edgematch=[[1,"B"],[2,"B"],[3,"B"],[4,"B"],[0,"B"],[10,"O",14,"A"],[11,"O",10,"A"],[12,"O",11,"A"],[13,"O",12,"A"],[14,"O",13,"A"],[0,"O"],[1,"O"],[2,"O"],[3,"O"],[4,"O"],[19,"B",5,"A"],[15,"B",6,"A"],[16,"B",7,"A"],[17,"B",8,"A"],[18,"B",9,"A"]];for(let v=0;v<20;v++){if(y=this.IDATA.face[v],o=y[2],a=y[1],l=y[0],S=d.x+"|"+d.y,x=v+"|"+S,x in t||(t[x]=o,P[o]=[y[T[S][0]],T[S][1]]),S=p.x+"|"+p.y,x=v+"|"+S,x in t||(t[x]=a,P[a]=[y[T[S][0]],T[S][1]]),S=m.x+"|"+m.y,x=v+"|"+S,x in t||(t[x]=l,P[l]=[y[T[S][0]],T[S][1]]),s=this.IDATA.edgematch[v][0],n=this.IDATA.edgematch[v][1],"B"===n)for(let e=1;e<h;e++)_.x=i-e*(c+u),_.y=r+e*c,g.x=-e*u,g.y=e*(c+u),S=_.x+"|"+_.y,b=g.x+"|"+g.y,C(v,s,S,b);if("O"===n)for(let e=1;e<h;e++)g.x=-e*u,g.y=e*(c+u),f.x=e*c,f.y=e*u,S=g.x+"|"+g.y,b=f.x+"|"+f.y,C(v,s,S,b);if(s=this.IDATA.edgematch[v][2],n=this.IDATA.edgematch[v][3],n&&"A"===n)for(let e=1;e<h;e++)f.x=e*c,f.y=e*u,_.x=i-(h-e)*(c+u),_.y=r+(h-e)*c,S=f.x+"|"+f.y,b=_.x+"|"+_.y,C(v,s,S,b);for(let i=0;i<this.vertices.length;i++)S=this.vertices[i].x+"|"+this.vertices[i].y,x=v+"|"+S,x in t||(t[x]=e++,T[S][0]>2?P[t[x]]=[-T[S][0],T[S][1],t[x]]:P[t[x]]=[y[T[S][0]],T[S][1],t[x]])}this.closestTo=P,this.vecToidx=t}calcCoeffs(){const e=this.m,t=this.n,i=Math.sqrt(3)/3,r=e*e+t*t+e*t;this.coau=(e+t)/r,this.cobu=-t/r,this.coav=-i*(e-t)/r,this.cobv=i*(2*e+t)/r}createInnerFacets(){const e=this.m,t=this.n;for(let i=0;i<t+e+1;i++)for(let e=this.min[i];e<this.max[i]+1;e++)e<this.max[i]&&e<this.max[i+1]+1&&this.innerFacets.push(["|"+e+"|"+i,"|"+e+"|"+(i+1),"|"+(e+1)+"|"+i]),i>0&&e<this.max[i-1]&&e+1<this.max[i]+1&&this.innerFacets.push(["|"+e+"|"+i,"|"+(e+1)+"|"+i,"|"+(e+1)+"|"+(i-1)])}edgeVecsABOB(){const e=this.m,t=this.n,i=new io(-t,e+t);for(let r=1;r<e+t;r++){const e=new io(this.min[r],r),t=new io(this.min[r-1],r-1),s=new io(this.min[r+1],r+1),n=e.clone(),o=t.clone(),a=s.clone();n.rotate60About(i),o.rotate60About(i),a.rotate60About(i);const l=new io(this.max[n.y],n.y),h=new io(this.max[n.y-1],n.y-1),c=new io(this.max[n.y-1]-1,n.y-1);n.x===l.x&&n.y===l.y||(n.x!==h.x?(this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([e,h,c]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([e,c,l])):n.y===a.y?(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([e,t,h]),this.vertexTypes.push([1,0,1]),this.isoVecsABOB.push([e,h,s])):(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([e,t,h]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([e,h,l])))}}mapABOBtoOBOA(){const e=new io(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){const i=[];for(let r=0;r<3;r++)e.x=this.isoVecsABOB[t][r].x,e.y=this.isoVecsABOB[t][r].y,0===this.vertexTypes[t][r]&&e.rotateNeg120(this.m,this.n),i.push(e.clone());this.isoVecsOBOA.push(i)}}mapABOBtoBAOA(){const e=new io(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){const i=[];for(let r=0;r<3;r++)e.x=this.isoVecsABOB[t][r].x,e.y=this.isoVecsABOB[t][r].y,1===this.vertexTypes[t][r]&&e.rotate120(this.m,this.n),i.push(e.clone());this.isoVecsBAOA.push(i)}}MapToFace(e,t){const i=this.IDATA.face[e],r=i[2],s=i[1],o=i[0],a=n.Pq.FromArray(this.IDATA.vertex[r]),l=n.Pq.FromArray(this.IDATA.vertex[s]),h=n.Pq.FromArray(this.IDATA.vertex[o]),c=l.subtract(a),u=h.subtract(a),d=c.scale(this.coau).add(u.scale(this.cobu)),p=c.scale(this.coav).add(u.scale(this.cobv)),m=[];let f,_=n.AA.Vector3[0];for(let i=0;i<this.cartesian.length;i++)_=d.scale(this.cartesian[i].x).add(p.scale(this.cartesian[i].y)).add(a),m[i]=[_.x,_.y,_.z],f=e+"|"+this.vertices[i].x+"|"+this.vertices[i].y,t.vertex[this.vecToidx[f]]=[_.x,_.y,_.z]}build(e,t){const i=[],r=io.Zero(),s=new io(e,t),n=new io(-t,e+t);i.push(r,s,n);for(let r=t;r<e+1;r++)for(let t=0;t<e+1-r;t++)i.push(new io(t,r));if(t>0){const r=(0,yt.HighestCommonFactor)(e,t),s=e/r,n=t/r;for(let o=1;o<r;o++)i.push(new io(o*s,o*n)),i.push(new io(-o*n,o*(s+n))),i.push(new io(e-o*(s+n),t+o*s));const o=e/t;for(let r=1;r<t;r++)for(let s=0;s<r*o;s++)i.push(new io(s,r)),i.push(new io(s,r).rotate120(e,t)),i.push(new io(s,r).rotateNeg120(e,t))}i.sort(((e,t)=>e.x-t.x)),i.sort(((e,t)=>e.y-t.y));const o=new Array(e+t+1),a=new Array(e+t+1);for(let e=0;e<o.length;e++)o[e]=1/0,a[e]=-1/0;let l=0,h=0;const c=i.length;for(let e=0;e<c;e++)h=i[e].x,l=i[e].y,o[l]=Math.min(h,o[l]),a[l]=Math.max(h,a[l]);const u=(i,r)=>{const s=i.clone();return"A"===r&&s.rotateNeg120(e,t),"B"===r&&s.rotate120(e,t),s.x<0?s.y:s.x+s.y},d=[],p=[],m=[],f=[],_={},g=[];let x=-1,v=-1;for(let e=0;e<c;e++)d[e]=i[e].toCartesianOrigin(new io(0,0),.5),p[e]=u(i[e],"O"),m[e]=u(i[e],"A"),f[e]=u(i[e],"B"),p[e]===m[e]&&m[e]===f[e]?(x=3,v=p[e]):p[e]===m[e]?(x=4,v=p[e]):m[e]===f[e]?(x=5,v=m[e]):f[e]===p[e]&&(x=6,v=p[e]),p[e]<m[e]&&p[e]<f[e]&&(x=2,v=p[e]),m[e]<p[e]&&m[e]<f[e]&&(x=1,v=m[e]),f[e]<m[e]&&f[e]<p[e]&&(x=0,v=f[e]),g.push([x,v,i[e].x,i[e].y]);g.sort(((e,t)=>e[2]-t[2])),g.sort(((e,t)=>e[3]-t[3])),g.sort(((e,t)=>e[1]-t[1])),g.sort(((e,t)=>e[0]-t[0]));for(let e=0;e<g.length;e++)_[g[e][2]+"|"+g[e][3]]=[g[e][0],g[e][1],e];return this.m=e,this.n=t,this.vertices=i,this.vertByDist=_,this.cartesian=d,this.min=o,this.max=a,this}}class so{constructor(e,t,i,r){this.name=e,this.category=t,this.vertex=i,this.face=r}}class no extends so{innerToData(e,t){for(let i=0;i<t.innerFacets.length;i++)this.face.push(t.innerFacets[i].map((i=>t.vecToidx[e+i])))}mapABOBtoDATA(e,t){const i=t.IDATA.edgematch[e][0];for(let r=0;r<t.isoVecsABOB.length;r++){const s=[];for(let n=0;n<3;n++)0===t.vertexTypes[r][n]?s.push(e+"|"+t.isoVecsABOB[r][n].x+"|"+t.isoVecsABOB[r][n].y):s.push(i+"|"+t.isoVecsABOB[r][n].x+"|"+t.isoVecsABOB[r][n].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}mapOBOAtoDATA(e,t){const i=t.IDATA.edgematch[e][0];for(let r=0;r<t.isoVecsOBOA.length;r++){const s=[];for(let n=0;n<3;n++)1===t.vertexTypes[r][n]?s.push(e+"|"+t.isoVecsOBOA[r][n].x+"|"+t.isoVecsOBOA[r][n].y):s.push(i+"|"+t.isoVecsOBOA[r][n].x+"|"+t.isoVecsOBOA[r][n].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}mapBAOAtoDATA(e,t){const i=t.IDATA.edgematch[e][2];for(let r=0;r<t.isoVecsBAOA.length;r++){const s=[];for(let n=0;n<3;n++)1===t.vertexTypes[r][n]?s.push(e+"|"+t.isoVecsBAOA[r][n].x+"|"+t.isoVecsBAOA[r][n].y):s.push(i+"|"+t.isoVecsBAOA[r][n].x+"|"+t.isoVecsBAOA[r][n].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}orderData(e){const t=[];for(let e=0;e<13;e++)t[e]=[];const i=e.closestTo;for(let e=0;e<i.length;e++)i[e][0]>-1?i[e][1]>0&&t[i[e][0]].push([e,i[e][1]]):t[12].push([e,i[e][0]]);const r=[];for(let e=0;e<12;e++)r[e]=e;let s=12;for(let e=0;e<12;e++){t[e].sort(((e,t)=>e[1]-t[1]));for(let i=0;i<t[e].length;i++)r[t[e][i][0]]=s++}for(let e=0;e<t[12].length;e++)r[t[12][e][0]]=s++;for(let e=0;e<this.vertex.length;e++)this.vertex[e].push(r[e]);this.vertex.sort(((e,t)=>e[3]-t[3]));for(let e=0;e<this.vertex.length;e++)this.vertex[e].pop();for(let e=0;e<this.face.length;e++)for(let t=0;t<this.face[e].length;t++)this.face[e][t]=r[this.face[e][t]];this.sharedNodes=t[12].length,this.poleNodes=this.vertex.length-this.sharedNodes}setOrder(e,t){const i=[],r=[];let s=t.pop();r.push(s);let n=this.face[s].indexOf(e);n=(n+2)%3;let o=this.face[s][n];i.push(o);let a=0;for(;t.length>0;)s=t[a],this.face[s].indexOf(o)>-1?(n=(this.face[s].indexOf(o)+1)%3,o=this.face[s][n],i.push(o),r.push(s),t.splice(a,1),a=0):a++;return this.adjacentFaces.push(i),r}toGoldbergPolyhedronData(){const e=new so("GeoDual","Goldberg",[],[]);e.name="GD dual";const t=this.vertex.length,i=new Array(t);for(let e=0;e<t;e++)i[e]=[];for(let e=0;e<this.face.length;e++)for(let t=0;t<3;t++)i[this.face[e][t]].push(e);let r=0,s=0,n=0,o=[],a=[];this.adjacentFaces=[];for(let t=0;t<i.length;t++)e.face[t]=this.setOrder(t,i[t].concat([])),i[t].forEach((t=>{r=0,s=0,n=0,o=this.face[t];for(let e=0;e<3;e++)a=this.vertex[o[e]],r+=a[0],s+=a[1],n+=a[2];e.vertex[t]=[r/3,s/3,n/3]}));return e}static BuildGeodesicData(e){const t=new no("Geodesic-m-n","Geodesic",[[0,ut.a6,-1],[-ut.a6,1,0],[-1,0,-ut.a6],[1,0,-ut.a6],[ut.a6,1,0],[0,ut.a6,1],[-1,0,ut.a6],[-ut.a6,-1,0],[0,-ut.a6,-1],[ut.a6,-1,0],[1,0,ut.a6],[0,-ut.a6,1]],[]);e.setIndices(),e.calcCoeffs(),e.createInnerFacets(),e.edgeVecsABOB(),e.mapABOBtoOBOA(),e.mapABOBtoBAOA();for(let i=0;i<e.IDATA.face.length;i++)e.MapToFace(i,t),t.innerToData(i,e),"B"===e.IDATA.edgematch[i][1]&&t.mapABOBtoDATA(i,e),"O"===e.IDATA.edgematch[i][1]&&t.mapOBOAtoDATA(i,e),"A"===e.IDATA.edgematch[i][3]&&t.mapBAOAtoDATA(i,e);t.orderData(e);return t.vertex=t.vertex.map((function(e){const t=e[0],i=e[1],r=e[2],s=Math.sqrt(t*t+i*i+r*r);return e[0]*=1/s,e[1]*=1/s,e[2]*=1/s,e})),t}}function oo(e,t,i=null){let r=t.m||1;r!==Math.floor(r)&&(r=Math.floor(r),m.V.Warn("m not an integer only floor(m) used"));let s=t.n||0;if(s!==Math.floor(s)&&(s=Math.floor(s),m.V.Warn("n not an integer only floor(n) used")),s>r){const e=s;s=r,r=e,m.V.Warn("n > m therefore m and n swapped")}const n=new ro;n.build(r,s);return Un(e,{custom:no.BuildGeodesicData(n),size:t.size,sizeX:t.sizeX,sizeY:t.sizeY,sizeZ:t.sizeZ,faceUV:t.faceUV,faceColors:t.faceColors,flat:t.flat,updatable:t.updatable,sideOrientation:t.sideOrientation,frontUVs:t.frontUVs,backUVs:t.backUVs},i)}tt.e._GoldbergMeshParser=(e,t)=>ao.Parse(e,t);class ao extends tt.e{constructor(){super(...arguments),this.goldbergData={faceColors:[],faceCenters:[],faceZaxis:[],faceXaxis:[],faceYaxis:[],nbSharedFaces:0,nbUnsharedFaces:0,nbFaces:0,nbFacesAtPole:0,adjacentFaces:[]}}relatedGoldbergFace(e,t){return void 0===t?(e>this.goldbergData.nbUnsharedFaces-1&&(m.V.Warn("Maximum number of unshared faces used"),e=this.goldbergData.nbUnsharedFaces-1),this.goldbergData.nbUnsharedFaces+e):(e>11&&(m.V.Warn("Last pole used"),e=11),t>this.goldbergData.nbFacesAtPole-1&&(m.V.Warn("Maximum number of faces at a pole used"),t=this.goldbergData.nbFacesAtPole-1),12+e*this.goldbergData.nbFacesAtPole+t)}_changeGoldbergFaceColors(e){for(let t=0;t<e.length;t++){const i=e[t][0],r=e[t][1],s=e[t][2];for(let e=i;e<r+1;e++)this.goldbergData.faceColors[e]=s}const t=[];for(let e=0;e<12;e++)for(let i=0;i<5;i++)t.push(this.goldbergData.faceColors[e].r,this.goldbergData.faceColors[e].g,this.goldbergData.faceColors[e].b,this.goldbergData.faceColors[e].a);for(let e=12;e<this.goldbergData.faceColors.length;e++)for(let i=0;i<6;i++)t.push(this.goldbergData.faceColors[e].r,this.goldbergData.faceColors[e].g,this.goldbergData.faceColors[e].b,this.goldbergData.faceColors[e].a);return t}setGoldbergFaceColors(e){const t=this._changeGoldbergFaceColors(e);this.setVerticesData(Ot.R.ColorKind,t)}updateGoldbergFaceColors(e){const t=this._changeGoldbergFaceColors(e);this.updateVerticesData(Ot.R.ColorKind,t)}_changeGoldbergFaceUVs(e){const t=this.getVerticesData(Ot.R.UVKind);for(let i=0;i<e.length;i++){const r=e[i][0],s=e[i][1],n=e[i][2],o=e[i][3],a=e[i][4],l=[],h=[];let c,u;for(let e=0;e<5;e++)c=n.x+o*Math.cos(a+e*Math.PI/2.5),u=n.y+o*Math.sin(a+e*Math.PI/2.5),c<0&&(c=0),c>1&&(c=1),l.push(c,u);for(let e=0;e<6;e++)c=n.x+o*Math.cos(a+e*Math.PI/3),u=n.y+o*Math.sin(a+e*Math.PI/3),c<0&&(c=0),c>1&&(c=1),h.push(c,u);for(let e=r;e<Math.min(12,s+1);e++)for(let i=0;i<5;i++)t[10*e+2*i]=l[2*i],t[10*e+2*i+1]=l[2*i+1];for(let e=Math.max(12,r);e<s+1;e++)for(let i=0;i<6;i++)t[12*e-24+2*i]=h[2*i],t[12*e-23+2*i]=h[2*i+1]}return t}setGoldbergFaceUVs(e){const t=this._changeGoldbergFaceUVs(e);this.setVerticesData(Ot.R.UVKind,t)}updateGoldbergFaceUVs(e){const t=this._changeGoldbergFaceUVs(e);this.updateVerticesData(Ot.R.UVKind,t)}placeOnGoldbergFaceAt(e,t,i){const r=n.Pq.RotationFromAxis(this.goldbergData.faceXaxis[t],this.goldbergData.faceYaxis[t],this.goldbergData.faceZaxis[t]);e.rotation=r,e.position=this.goldbergData.faceCenters[t].add(this.goldbergData.faceXaxis[t].scale(i.x)).add(this.goldbergData.faceYaxis[t].scale(i.y)).add(this.goldbergData.faceZaxis[t].scale(i.z))}serialize(e){super.serialize(e),e.type="GoldbergMesh";const t={};if(t.adjacentFaces=this.goldbergData.adjacentFaces,t.nbSharedFaces=this.goldbergData.nbSharedFaces,t.nbUnsharedFaces=this.goldbergData.nbUnsharedFaces,t.nbFaces=this.goldbergData.nbFaces,t.nbFacesAtPole=this.goldbergData.nbFacesAtPole,this.goldbergData.faceColors){t.faceColors=[];for(const e of this.goldbergData.faceColors)t.faceColors.push(e.asArray())}if(this.goldbergData.faceCenters){t.faceCenters=[];for(const e of this.goldbergData.faceCenters)t.faceCenters.push(e.asArray())}if(this.goldbergData.faceZaxis){t.faceZaxis=[];for(const e of this.goldbergData.faceZaxis)t.faceZaxis.push(e.asArray())}if(this.goldbergData.faceYaxis){t.faceYaxis=[];for(const e of this.goldbergData.faceYaxis)t.faceYaxis.push(e.asArray())}if(this.goldbergData.faceXaxis){t.faceXaxis=[];for(const e of this.goldbergData.faceXaxis)t.faceXaxis.push(e.asArray())}e.goldbergData=t}static Parse(e,t){const i=e.goldbergData;i.faceColors=i.faceColors.map((e=>o.ov.FromArray(e))),i.faceCenters=i.faceCenters.map((e=>n.Pq.FromArray(e))),i.faceZaxis=i.faceZaxis.map((e=>n.Pq.FromArray(e))),i.faceXaxis=i.faceXaxis.map((e=>n.Pq.FromArray(e))),i.faceYaxis=i.faceYaxis.map((e=>n.Pq.FromArray(e)));const r=new ao(e.name,t);return r.goldbergData=i,r}}function lo(e,t){const i=e.size,r=e.sizeX||i||1,s=e.sizeY||i||1,o=e.sizeZ||i||1,a=0===e.sideOrientation?0:e.sideOrientation||ot.P.DEFAULTSIDE,l=[],h=[],c=[],u=[];let d=1/0,p=-1/0,m=1/0,f=-1/0;for(let e=0;e<t.vertex.length;e++)d=Math.min(d,t.vertex[e][0]*r),p=Math.max(p,t.vertex[e][0]*r),m=Math.min(m,t.vertex[e][1]*s),f=Math.max(f,t.vertex[e][1]*s);let _=0;for(let e=0;e<t.face.length;e++){const i=t.face[e],a=n.Pq.FromArray(t.vertex[i[0]]),g=n.Pq.FromArray(t.vertex[i[2]]),x=n.Pq.FromArray(t.vertex[i[1]]),v=g.subtract(a),S=x.subtract(a),b=n.Pq.Cross(S,v).normalize();for(let e=0;e<i.length;e++){c.push(b.x,b.y,b.z);const n=t.vertex[i[e]];l.push(n[0]*r,n[1]*s,n[2]*o);const a=(n[1]*s-m)/(f-m);u.push((n[0]*r-d)/(p-d),at.rX?1-a:a)}for(let e=0;e<i.length-2;e++)h.push(_,_+e+2,_+e+1);_+=i.length}ot.P._ComputeSides(a,l,h,c,u);const g=new ot.P;return g.positions=l,g.indices=h,g.normals=c,g.uvs=u,g}function ho(e,t,i=null){const r=t.size,s=t.sizeX||r||1,a=t.sizeY||r||1,l=t.sizeZ||r||1;let h=t.m||1;h!==Math.floor(h)&&(h=Math.floor(h),m.V.Warn("m not an integer only floor(m) used"));let c=t.n||0;if(c!==Math.floor(c)&&(c=Math.floor(c),m.V.Warn("n not an integer only floor(n) used")),c>h){const e=c;c=h,h=e,m.V.Warn("n > m therefore m and n swapped")}const u=new ro;u.build(h,c);const d=no.BuildGeodesicData(u),p=d.toGoldbergPolyhedronData(),f=new ao(e,i);t.sideOrientation=tt.e._GetDefaultSideOrientation(t.sideOrientation),f._originalBuilderSideOrientation=t.sideOrientation;lo(t,p).applyToMesh(f,t.updatable),f.goldbergData.nbSharedFaces=d.sharedNodes,f.goldbergData.nbUnsharedFaces=d.poleNodes,f.goldbergData.adjacentFaces=d.adjacentFaces,f.goldbergData.nbFaces=f.goldbergData.nbSharedFaces+f.goldbergData.nbUnsharedFaces,f.goldbergData.nbFacesAtPole=(f.goldbergData.nbUnsharedFaces-12)/12;for(let e=0;e<d.vertex.length;e++)f.goldbergData.faceCenters.push(n.Pq.FromArray(d.vertex[e])),f.goldbergData.faceCenters[e].x*=s,f.goldbergData.faceCenters[e].y*=a,f.goldbergData.faceCenters[e].z*=l,f.goldbergData.faceColors.push(new o.ov(1,1,1,1));for(let e=0;e<p.face.length;e++){const t=p.face[e],i=n.Pq.FromArray(p.vertex[t[0]]),r=n.Pq.FromArray(p.vertex[t[2]]),s=n.Pq.FromArray(p.vertex[t[1]]),o=r.subtract(i),a=s.subtract(i),l=n.Pq.Cross(a,o).normalize(),h=n.Pq.Cross(a,l).normalize();f.goldbergData.faceXaxis.push(a.normalize()),f.goldbergData.faceYaxis.push(l),f.goldbergData.faceZaxis.push(h)}return f}class co{constructor(e){this._paths=[],this._tempPaths=[],this._holes=[],this._resolution=e}moveTo(e,t){this._currentPath=new Tn.Cu(e,t),this._tempPaths.push(this._currentPath)}lineTo(e,t){this._currentPath.addLineTo(e,t)}quadraticCurveTo(e,t,i,r){this._currentPath.addQuadraticCurveTo(e,t,i,r,this._resolution)}bezierCurveTo(e,t,i,r,s,n){this._currentPath.addBezierCurveTo(e,t,i,r,s,n,this._resolution)}extractHoles(){for(const e of this._tempPaths)e.area()>0?this._holes.push(e):this._paths.push(e);if(!this._paths.length&&this._holes.length){const e=this._holes;this._holes=this._paths,this._paths=e}this._tempPaths.length=0}get paths(){return this._paths}get holes(){return this._holes}}function uo(e,t,i,r,s,n){const o=n.glyphs[e]||n.glyphs["?"];if(!o)return null;const a=new co(s);if(o.o){const e=o.o.split(" ");for(let s=0,n=e.length;s<n;){switch(e[s++]){case"m":{const n=parseInt(e[s++])*t+i,o=parseInt(e[s++])*t+r;a.moveTo(n,o);break}case"l":{const n=parseInt(e[s++])*t+i,o=parseInt(e[s++])*t+r;a.lineTo(n,o);break}case"q":{const n=parseInt(e[s++])*t+i,o=parseInt(e[s++])*t+r,l=parseInt(e[s++])*t+i,h=parseInt(e[s++])*t+r;a.quadraticCurveTo(l,h,n,o);break}case"b":{const n=parseInt(e[s++])*t+i,o=parseInt(e[s++])*t+r,l=parseInt(e[s++])*t+i,h=parseInt(e[s++])*t+r,c=parseInt(e[s++])*t+i,u=parseInt(e[s++])*t+r;a.bezierCurveTo(l,h,c,u,n,o);break}}}}return a.extractHoles(),{offsetX:o.ha*t,shapePath:a}}function po(e,t,i,r){const s=Array.from(e),n=t/r.resolution,o=(r.boundingBox.yMax-r.boundingBox.yMin+r.underlineThickness)*n,a=[];let l=0,h=0;for(let e=0;e<s.length;e++){const t=s[e];if("\n"===t)l=0,h-=o;else{const e=uo(t,n,l,h,i,r);e&&(l+=e.offsetX,a.push(e.shapePath))}}return a}function mo(e,t,i,r={size:50,resolution:8,depth:1},s=null,o=earcut){const a=po(t,r.size||50,r.resolution||8,i),l=[];let h=0;for(const t of a){if(!t.paths.length)continue;const i=t.holes.slice();for(const a of t.paths){const t=[],c=[],u=a.getPoints();for(const e of u)c.push(new n.Pq(e.x,0,e.y));const d=i.slice();for(const e of d){const r=e.getPoints();let s=!1;for(const e of r)if(a.isPointInside(e)){s=!0;break}if(!s)continue;const o=[];for(const e of r)o.push(new n.Pq(e.x,0,e.y));t.push(o),i.splice(i.indexOf(e),1)}if(!t.length&&i.length)for(const e of i){const i=e.getPoints(),r=[];for(const e of i)r.push(new n.Pq(e.x,0,e.y));t.push(r)}const p=Dn(e,{shape:c,holes:t.length?t:void 0,depth:r.depth||1,faceUV:r.faceUV||r.perLetterFaceUV?.(h),faceColors:r.faceColors||r.perLetterFaceColors?.(h),sideOrientation:tt.e._GetDefaultSideOrientation(r.sideOrientation||tt.e.DOUBLESIDE)},s,o);l.push(p),h++}}const c=tt.e.MergeMeshes(l,!0,!0);if(c){const t=c.getBoundingInfo().boundingBox;c.position.x+=-(t.minimumWorld.x+t.maximumWorld.x)/2,c.position.y+=-(t.minimumWorld.y+t.maximumWorld.y)/2,c.position.z+=-(t.minimumWorld.z+t.maximumWorld.z)/2+t.extendSize.z,c.name=e;const i=new mt.V("pivot",s);i.rotation.x=-Math.PI/2,c.parent=i,c.bakeCurrentTransformIntoVertices(),c.parent=null,i.dispose()}return c}const fo={CreateBox:ks.an,CreateTiledBox:hn,CreateSphere:zs,CreateDisc:rn,CreateIcoSphere:$n,CreateRibbon:Js,CreateCylinder:Es,CreateTorus:Lr,CreateTorusKnot:dn,CreateLineSystem:Sn,CreateLines:bn,CreateDashedLines:yn,ExtrudeShape:Nn,ExtrudeShapeCustom:wn,CreateLathe:Vn,CreateTiledPlane:on,CreatePlane:ht,CreateGround:Br.km,CreateTiledGround:Br.ol,CreateGroundFromHeightMap:Br.RI,CreatePolygon:Mn,ExtrudePolygon:Dn,CreateTube:kn,CreatePolyhedron:Un,CreateGeodesic:oo,CreateGoldberg:ho,CreateDecal:eo,CreateCapsule:Zs,CreateText:mo};class _o{constructor(e,t){if(this._impostors=[],this._meshes=[],this._bodies=[],this._inertiaBodies=[],this._constraints=[],this._bodyMeshes=[],this._inertiaMeshes=[],this._constraintMeshes=[],this._numMeshes=0,this._numBodies=0,this._numInertiaBodies=0,this._numConstraints=0,this._debugMeshMeshes=new Array,this._constraintAxesSize=.4,this._constraintAngularSize=.4,this._scene=e||C.q.LastCreatedScene,!this._scene)return;const i=this._scene.getPhysicsEngine();i&&(this._physicsEnginePlugin=i.getPhysicsPlugin()),this._utilityLayer=new Rs(this._scene,!1),this._utilityLayer.pickUtilitySceneFirst=!1,this._utilityLayer.utilityLayerScene.autoClearDepthAndStencil=!0,t&&(this._constraintAxesSize=.4*t,this._constraintAngularSize=.4*t)}_updateDebugMeshes(){const e=this._physicsEnginePlugin;1===e?.getPluginVersion()?this._updateDebugMeshesV1():this._updateDebugMeshesV2()}_updateDebugMeshesV1(){const e=this._physicsEnginePlugin;for(let t=0;t<this._numMeshes;t++){const i=this._impostors[t];if(i)if(i.isDisposed)this.hideImpostor(this._impostors[t--]);else{if(i.type===Xs.MeshImpostor)continue;const r=this._meshes[t];r&&e&&e.syncMeshWithImpostor(r,i)}}}_updateDebugMeshesV2(){const e=this._physicsEnginePlugin;for(let t=0;t<this._numBodies;){const i=this._bodies[t];if(i&&i.isDisposed&&this.hideBody(i))continue;const r=this._bodyMeshes[t];i&&r&&e.syncTransform(i,r),t++}}_updateInertiaMeshes(){for(let e=0;e<this._numInertiaBodies;){const t=this._inertiaBodies[e];if(t&&t.isDisposed&&this.hideInertia(t))continue;const i=this._inertiaMeshes[e];t&&i&&this._updateDebugInertia(t,i),e++}}_updateDebugInertia(e,t){const i=n.uq.Identity(),r=n.uq.Identity(),s=n.uq.Identity();if(e._pluginDataInstances.length){const o=t,a=o._thinInstanceDataStorage.matrixData,l=e.transformNode._thinInstanceDataStorage.matrixData;for(let t=0;t<e._pluginDataInstances.length;t++){const o=e.getMassProperties(t);this._getMeshDebugInertiaMatrixToRef(o,i),n.uq.FromArrayToRef(l,16*t,r),i.multiplyToRef(r,s),s.copyToArray(a,16*t)}o.thinInstanceBufferUpdated("matrix")}else{const s=e.getMassProperties();if(this._getMeshDebugInertiaMatrixToRef(s,i),e.transformNode.rotationQuaternion?.toRotationMatrix(r),r.setTranslation(e.transformNode.position),e.transformNode.parent){const t=e.transformNode.parent.computeWorldMatrix(!0);r.multiplyToRef(t,r)}i.multiplyToRef(r,i),i.decomposeToTransformNode(t)}}_updateDebugConstraints(){for(let e=0;e<this._numConstraints;e++){const t=this._constraints[e],i=this._constraintMeshes[e];t&&i&&this._updateDebugConstraint(t,i[0])}}_makeScalingUnitInPlace(e){Math.abs(e.x-1)>ut.bH&&(e.x=1*Math.sign(e.x)),Math.abs(e.y-1)>ut.bH&&(e.y=1*Math.sign(e.y)),Math.abs(e.z-1)>ut.bH&&(e.z=1*Math.sign(e.z))}_updateDebugConstraint(e,t){if(!e._initOptions)return;const{pivotA:i,pivotB:r,axisA:s,axisB:o,perpAxisA:a,perpAxisB:l}=e._initOptions;i&&r&&s&&o&&a&&l&&t.getDescendants(!0).forEach((e=>{const t=e.getDescendants(!0)[0],h=e.getDescendants(!0)[1],{parentBody:c,parentBodyIndex:u}=t.metadata,{childBody:d,childBodyIndex:p}=h.metadata,m=this._getTransformFromBodyToRef(c,n.AA.Matrix[0],u),f=this._getTransformFromBodyToRef(d,n.AA.Matrix[1],p);m.decomposeToTransformNode(t),this._makeScalingUnitInPlace(t.scaling),f.decomposeToTransformNode(h),this._makeScalingUnitInPlace(h.scaling);const _=t.getDescendants(!0)[0];_.position.copyFrom(i);const g=h.getDescendants(!0)[0];g.position.copyFrom(r),n.PT.FromRotationMatrixToRef(n.uq.FromXYZAxesToRef(s,a,n.Pq.CrossToRef(s,a,n.AA.Vector3[0]),n.AA.Matrix[0]),_.rotationQuaternion),n.PT.FromRotationMatrixToRef(n.uq.FromXYZAxesToRef(o,l,n.Pq.CrossToRef(o,l,n.AA.Vector3[1]),n.AA.Matrix[1]),g.rotationQuaternion)}))}showImpostor(e,t){if(!this._scene)return null;for(let t=0;t<this._numMeshes;t++)if(this._impostors[t]==e)return null;const i=this._getDebugMesh(e,t);return i&&(this._impostors[this._numMeshes]=e,this._meshes[this._numMeshes]=i,0===this._numMeshes&&(this._renderFunction=()=>this._updateDebugMeshes(),this._scene.registerBeforeRender(this._renderFunction)),this._numMeshes++),i}showBody(e){if(!this._scene)return null;for(let t=0;t<this._numBodies;t++)if(this._bodies[t]==e)return null;const t=this._getDebugBodyMesh(e);return t&&(this._bodies[this._numBodies]=e,this._bodyMeshes[this._numBodies]=t,0===this._numBodies&&(this._renderFunction=()=>this._updateDebugMeshes(),this._scene.registerBeforeRender(this._renderFunction)),this._numBodies++),t}showInertia(e){if(!this._scene)return null;for(let t=0;t<this._numInertiaBodies;t++)if(this._inertiaBodies[t]==e)return null;const t=this._getDebugInertiaMesh(e);return t&&(this._inertiaBodies[this._numInertiaBodies]=e,this._inertiaMeshes[this._numInertiaBodies]=t,0===this._numInertiaBodies&&(this._inertiaRenderFunction=()=>this._updateInertiaMeshes(),this._scene.registerBeforeRender(this._inertiaRenderFunction)),this._numInertiaBodies++),t}showConstraint(e){if(!this._scene)return null;for(let t=0;t<this._numConstraints;t++)if(this._constraints[t]==e)return null;const t=this._getDebugConstraintMesh(e);return t&&(this._constraints[this._numConstraints]=e,this._constraintMeshes[this._numConstraints]=t,0===this._numConstraints&&(this._constraintRenderFunction=()=>this._updateDebugConstraints(),this._scene.registerBeforeRender(this._constraintRenderFunction)),this._numConstraints++),t?t[0]:null}hideImpostor(e){if(!e||!this._scene||!this._utilityLayer)return;let t=!1;const i=this._utilityLayer.utilityLayerScene;for(let r=0;r<this._numMeshes;r++)if(this._impostors[r]==e){const e=this._meshes[r];if(!e)continue;i.removeMesh(e),e.dispose();const s=this._debugMeshMeshes.indexOf(e);s>-1&&this._debugMeshMeshes.splice(s,1),this._numMeshes--,this._numMeshes>0?(this._meshes[r]=this._meshes[this._numMeshes],this._impostors[r]=this._impostors[this._numMeshes],this._meshes[this._numMeshes]=null,this._impostors[this._numMeshes]=null):(this._meshes[0]=null,this._impostors[0]=null),t=!0;break}t&&0===this._numMeshes&&this._scene.unregisterBeforeRender(this._renderFunction)}hideBody(e){if(!e||!this._scene||!this._utilityLayer)return!1;let t=!1;const i=this._utilityLayer.utilityLayerScene;for(let r=0;r<this._numBodies;r++)if(this._bodies[r]===e){const e=this._bodyMeshes[r];if(!e)continue;i.removeMesh(e),e.dispose(),this._numBodies--,this._numBodies>0?(this._bodyMeshes[r]=this._bodyMeshes[this._numBodies],this._bodies[r]=this._bodies[this._numBodies],this._bodyMeshes[this._numBodies]=null,this._bodies[this._numBodies]=null):(this._bodyMeshes[0]=null,this._bodies[0]=null),t=!0;break}return t&&0===this._numBodies&&this._scene.unregisterBeforeRender(this._renderFunction),t}hideInertia(e){if(!e||!this._scene||!this._utilityLayer)return!1;let t=!1;const i=this._utilityLayer.utilityLayerScene;for(let r=0;r<this._numInertiaBodies;r++)if(this._inertiaBodies[r]===e){const e=this._inertiaMeshes[r];if(!e)continue;i.removeMesh(e),e.dispose(),this._inertiaBodies.splice(r,1),this._inertiaMeshes.splice(r,1),this._numInertiaBodies--,t=!0;break}return t&&0===this._numInertiaBodies&&this._scene.unregisterBeforeRender(this._inertiaRenderFunction),t}hideConstraint(e){if(!e||!this._scene||!this._utilityLayer)return;let t=!1;const i=this._utilityLayer.utilityLayerScene;for(let r=0;r<this._numConstraints;r++)if(this._constraints[r]===e){const e=this._constraintMeshes[r];if(!e)continue;e.forEach((e=>{i.removeMesh(e),e.dispose()})),this._constraints.splice(r,1),this._constraintMeshes.splice(r,1),this._numConstraints--,this._numConstraints>0?(this._constraints[r]=this._constraints[this._numConstraints],this._constraintMeshes[r]=this._constraintMeshes[this._numConstraints],this._constraints[this._numConstraints]=null,this._constraintMeshes[this._numConstraints]=null):(this._constraints[0]=null,this._constraintMeshes[0]=null),t=!0;break}t&&0===this._numConstraints&&this._scene.unregisterBeforeRender(this._constraintRenderFunction)}_getDebugMaterial(e){return this._debugMaterial||(this._debugMaterial=new br.F("",e),this._debugMaterial.wireframe=!0,this._debugMaterial.emissiveColor=o.v9.White(),this._debugMaterial.disableLighting=!0),this._debugMaterial}_getDebugInertiaMaterial(e){return this._debugInertiaMaterial||(this._debugInertiaMaterial=new br.F("",e),this._debugInertiaMaterial.disableLighting=!0,this._debugInertiaMaterial.alpha=0),this._debugInertiaMaterial}_getDebugAxisColoredMaterial(e,t){const i=new br.F("",t);return i.emissiveColor=0==e?o.v9.Red():1==e?o.v9.Green():o.v9.Blue(),i.disableLighting=!0,i}_getDebugBoxMesh(e){return this._debugBoxMesh||(this._debugBoxMesh=(0,ks.an)("physicsBodyBoxViewMesh",{size:1},e),this._debugBoxMesh.rotationQuaternion=n.PT.Identity(),this._debugBoxMesh.material=this._getDebugMaterial(e),this._debugBoxMesh.setEnabled(!1)),this._debugBoxMesh.createInstance("physicsBodyBoxViewInstance")}_getDebugSphereMesh(e){return this._debugSphereMesh||(this._debugSphereMesh=zs("physicsBodySphereViewMesh",{diameter:1},e),this._debugSphereMesh.rotationQuaternion=n.PT.Identity(),this._debugSphereMesh.material=this._getDebugMaterial(e),this._debugSphereMesh.setEnabled(!1)),this._debugSphereMesh.createInstance("physicsBodySphereViewInstance")}_getDebugCapsuleMesh(e){return this._debugCapsuleMesh||(this._debugCapsuleMesh=Zs("physicsBodyCapsuleViewMesh",{height:1},e),this._debugCapsuleMesh.rotationQuaternion=n.PT.Identity(),this._debugCapsuleMesh.material=this._getDebugMaterial(e),this._debugCapsuleMesh.setEnabled(!1)),this._debugCapsuleMesh.createInstance("physicsBodyCapsuleViewInstance")}_getDebugCylinderMesh(e){return this._debugCylinderMesh||(this._debugCylinderMesh=Es("physicsBodyCylinderViewMesh",{diameterTop:1,diameterBottom:1,height:1},e),this._debugCylinderMesh.rotationQuaternion=n.PT.Identity(),this._debugCylinderMesh.material=this._getDebugMaterial(e),this._debugCylinderMesh.setEnabled(!1)),this._debugCylinderMesh.createInstance("physicsBodyCylinderViewInstance")}_getDebugMeshMesh(e,t){const i=new tt.e(e.name,t,null,e);return i.setParent(e),i.position=n.Pq.Zero(),i.material=this._getDebugMaterial(t),this._debugMeshMeshes.push(i),i}_getDebugMesh(e,t){if(!this._utilityLayer)return null;if(t&&t.parent&&t.parent.physicsImpostor)return null;let i=null;const r=this._utilityLayer.utilityLayerScene;if(!e.physicsBody)return m.V.Warn("Unable to get physicsBody of impostor. It might be initialized later by its parent's impostor."),null;switch(e.type){case Xs.BoxImpostor:i=this._getDebugBoxMesh(r),e.getBoxSizeToRef(i.scaling);break;case Xs.SphereImpostor:{i=this._getDebugSphereMesh(r);const t=e.getRadius();i.scaling.x=2*t,i.scaling.y=2*t,i.scaling.z=2*t;break}case Xs.CapsuleImpostor:{i=this._getDebugCapsuleMesh(r);const t=e.object.getBoundingInfo();i.scaling.x=2*(t.boundingBox.maximum.x-t.boundingBox.minimum.x)*e.object.scaling.x,i.scaling.y=(t.boundingBox.maximum.y-t.boundingBox.minimum.y)*e.object.scaling.y,i.scaling.z=2*(t.boundingBox.maximum.z-t.boundingBox.minimum.z)*e.object.scaling.z;break}case Xs.MeshImpostor:t&&(i=this._getDebugMeshMesh(t,r));break;case Xs.NoImpostor:if(t){t.getChildMeshes().filter((e=>e.physicsImpostor?1:0)).forEach((e=>{if(e.physicsImpostor&&"Mesh"===e.getClassName()){const t=e.getBoundingInfo(),s=t.boundingBox.minimum,n=t.boundingBox.maximum;switch(e.physicsImpostor.type){case Xs.BoxImpostor:i=this._getDebugBoxMesh(r),i.position.copyFrom(s),i.position.addInPlace(n),i.position.scaleInPlace(.5);break;case Xs.SphereImpostor:i=this._getDebugSphereMesh(r);break;case Xs.CylinderImpostor:i=this._getDebugCylinderMesh(r);break;default:i=null}i&&(i.scaling.x=n.x-s.x,i.scaling.y=n.y-s.y,i.scaling.z=n.z-s.z,i.parent=e)}}))}else m.V.Warn("No target mesh parameter provided for NoImpostor. Skipping.");i=null;break;case Xs.CylinderImpostor:{i=this._getDebugCylinderMesh(r);const t=e.object.getBoundingInfo();i.scaling.x=(t.boundingBox.maximum.x-t.boundingBox.minimum.x)*e.object.scaling.x,i.scaling.y=(t.boundingBox.maximum.y-t.boundingBox.minimum.y)*e.object.scaling.y,i.scaling.z=(t.boundingBox.maximum.z-t.boundingBox.minimum.z)*e.object.scaling.z;break}}return i}_getDebugBodyMesh(e){if(!this._utilityLayer)return null;const t=this._utilityLayer.utilityLayerScene,i=new tt.e("custom",t),r=new ot.P,s=e.getGeometry();if(r.positions=s.positions,r.indices=s.indices,r.applyToMesh(i),e._pluginDataInstances){const t=new Float32Array(16*e._pluginDataInstances.length);i.thinInstanceSetBuffer("matrix",t,16,!1)}return i.material=this._getDebugMaterial(t),i}_getMeshDebugInertiaMatrixToRef(e,t){const i=e.inertiaOrientation??n.PT.Identity(),r=e.inertia??n.Pq.Zero(),s=e.centerOfMass??n.Pq.Zero(),o=6*(r.x-r.y+r.z),a=Math.sqrt(Math.max(o,0)),l=12*r.x-o,h=Math.sqrt(Math.max(l,0)),c=12*r.z-o,u=Math.sqrt(Math.max(c,0)),d=n.AA.Vector3[0];d.set(u,a,h);const p=n.uq.ScalingToRef(d.x,d.y,d.z,n.AA.Matrix[0]),m=i.toRotationMatrix(n.AA.Matrix[1]),f=n.uq.TranslationToRef(s.x,s.y,s.z,n.AA.Matrix[2]);return p.multiplyToRef(m,t),t.multiplyToRef(f,t),t}_getDebugInertiaMesh(e){if(!this._utilityLayer)return null;const t=this._utilityLayer.utilityLayerScene,i=fo.CreateBox("custom",{size:1},t),r=n.uq.Identity();if(e._pluginDataInstances.length){const t=new Float32Array(16*e._pluginDataInstances.length);for(let i=0;i<e._pluginDataInstances.length;++i){const s=e.getMassProperties(i);this._getMeshDebugInertiaMatrixToRef(s,r),r.copyToArray(t,16*i)}i.thinInstanceSetBuffer("matrix",t,16,!1)}else{const t=e.getMassProperties();this._getMeshDebugInertiaMatrixToRef(t,r),r.decomposeToTransformNode(i)}return i.enableEdgesRendering(),i.edgesWidth=2,i.edgesColor=new o.ov(1,0,1,1),i.material=this._getDebugInertiaMaterial(t),i}_getTransformFromBodyToRef(e,t,i){const r=e.transformNode;return i&&i>=0?n.uq.FromArrayToRef(r._thinInstanceDataStorage.matrixData,i,t):t.copyFrom(r.getWorldMatrix())}_createAngularConstraintMesh(e,t,i,r,s){const n=(t-e)/(2*Math.PI),o=fo.CreateCylinder("ConstraintCylinder",{height:1e-4,diameter:3*this._constraintAngularSize,arc:n},s);o.material=this._getDebugAxisColoredMaterial(i,s),o.parent=r;const a=r.absoluteScaling;switch(i){case 0:o.rotation.z=.5*Math.PI,o.rotation.x=-e+.5*Math.PI,o.scaling.x=1/a.x,o.scaling.y=1/a.z,o.scaling.z=1/a.y;break;case 1:o.rotation.y=1.5*Math.PI+e,o.scaling.x=1/a.z,o.scaling.y=1/a.y,o.scaling.z=1/a.x;break;case 2:o.rotation.x=.5*Math.PI,o.scaling.x=1/a.x,o.scaling.y=1/a.z,o.scaling.z=1/a.y}return o}_createCage(e,t){const i=fo.CreateBox("cage",{size:1},t);i.setPivotPoint(new n.Pq(-.5,-.5,-.5));const r=new br.F("cage_material",t);return r.alpha=0,i.material=r,i.enableEdgesRendering(),i.edgesWidth=4,i.edgesColor=new o.ov(1,1,1,1),i.parent=e,i}_getDebugConstraintMesh(e){if(!this._utilityLayer)return null;const t=this._utilityLayer.utilityLayerScene;if(!e._initOptions)return null;const{pivotA:i,pivotB:r,axisA:s,axisB:o,perpAxisA:a,perpAxisB:l}=e._initOptions;if(!(i&&r&&s&&o&&a&&l))return null;const h=new tt.e("parentingDebugConstraint",t),c=e.getBodiesUsingConstraint(),u=[];u.push(h);for(const d of c){const c=new mt.V("parentOfPair",t);c.parent=h;const{parentBody:p,parentBodyIndex:m,childBody:f,childBodyIndex:_}=d,g=this._getTransformFromBodyToRef(p,n.AA.Matrix[0],m),x=this._getTransformFromBodyToRef(f,n.AA.Matrix[1],_),v=new mt.V("parentCoordSystem",t);v.parent=c,v.metadata={parentBody:p,parentBodyIndex:m},g.decomposeToTransformNode(v);const S=new mt.V("childCoordSystem",t);S.parent=c,S.metadata={childBody:f,childBodyIndex:_},x.decomposeToTransformNode(S);const b=n.PT.FromRotationMatrix(n.uq.FromXYZAxesToRef(s,a,s.cross(a),n.AA.Matrix[0])),y=n.PT.FromRotationMatrix(n.uq.FromXYZAxesToRef(o,l,o.cross(l),n.AA.Matrix[0])),P=i,T=r,C=new mt.V("constraint_parent",t);C.position.copyFrom(P),C.rotationQuaternion=b,C.parent=v;const E=new mt.V("constraint_child",t);E.parent=S,E.position.copyFrom(T),E.rotationQuaternion=y;const A=new Bs(t,this._constraintAxesSize);A.xAxis.parent=C,A.yAxis.parent=C,A.zAxis.parent=C;const I=new Bs(t,this._constraintAxesSize);I.xAxis.parent=E,I.yAxis.parent=E,I.zAxis.parent=E;const R=this._physicsEnginePlugin,M=[3,4,5],D=[M,[0,1,2]],O=[0,0];for(let t=0;t<2;t++)for(let i=0;i<3;i++){const r=D[t][i];2==R.getAxisMode(e,r)&&O[t]++}if(3!=O[1]){const i=this._createCage(C,t),r=n.AA.Vector3[0],s=n.AA.Vector3[1],o=[!1,!1,!1];o[0]=1==R.getAxisMode(e,0),o[1]=1==R.getAxisMode(e,1),o[2]=1==R.getAxisMode(e,2),r.x=o[0]?R.getAxisMinLimit(e,0):0,s.x=o[0]?R.getAxisMaxLimit(e,0):0,r.y=o[1]?R.getAxisMinLimit(e,1):0,s.y=o[1]?R.getAxisMaxLimit(e,1):0,r.z=o[2]?R.getAxisMinLimit(e,2):0,s.z=o[2]?R.getAxisMaxLimit(e,2):0,i.position.x=r.x+.5,i.position.y=r.y+.5,i.position.z=r.z+.5,i.scaling.x=s.x-r.x+ut.bH,i.scaling.y=s.y-r.y+ut.bH,i.scaling.z=s.z-r.z+ut.bH,u.push(i)}if(3!=O[0])for(let i=0;i<3;i++){const r=M[i],s=R.getAxisMode(e,r);let n=0,o=2*Math.PI;if(1==s&&(n=R.getAxisMinLimit(e,r),o=R.getAxisMaxLimit(e,r)),2!=s&&e.options.pivotB){const r=this._createAngularConstraintMesh(n,o,i,f.transformNode,t);r.position.copyFrom(e.options.pivotB),u.push(r)}}}return u}dispose(){for(let e=this._numMeshes-1;e>=0;e--)this.hideImpostor(this._impostors[0]);for(let e=this._numBodies-1;e>=0;e--)this.hideBody(this._bodies[0]);for(let e=this._numInertiaBodies-1;e>=0;e--)this.hideInertia(this._inertiaBodies[0]);this._debugBoxMesh&&this._debugBoxMesh.dispose(),this._debugSphereMesh&&this._debugSphereMesh.dispose(),this._debugCylinderMesh&&this._debugCylinderMesh.dispose(),this._debugMaterial&&this._debugMaterial.dispose(),this._impostors.length=0,this._scene=null,this._physicsEnginePlugin=null,this._utilityLayer&&(this._utilityLayer.dispose(),this._utilityLayer=null)}}class go{static CreateAndShow(e,t,i){const r=new go(e);return r.show(t,i),r}constructor(e){this.ray=e}show(e,t){if(!this._renderFunction&&this.ray){const t=this.ray;this._renderFunction=()=>this._render(),this._scene=e,this._renderPoints=[t.origin,t.origin.add(t.direction.scale(t.length))],this._renderLine=bn("ray",{points:this._renderPoints,updatable:!0},e),this._renderLine.isPickable=!1,this._renderFunction&&this._scene.registerBeforeRender(this._renderFunction)}t&&this._renderLine&&this._renderLine.color.copyFrom(t)}hide(){this._renderFunction&&this._scene&&(this._scene.unregisterBeforeRender(this._renderFunction),this._scene=null,this._renderFunction=null,this._renderLine&&(this._renderLine.dispose(),this._renderLine=null),this._renderPoints=[])}_render(){const e=this.ray;if(!e)return;const t=this._renderPoints[1],i=Math.min(e.length,1e6);t.copyFrom(e.direction),t.scaleInPlace(i),t.addInPlace(e.origin),this._renderPoints[0].copyFrom(e.origin),bn("ray",{points:this._renderPoints,updatable:!0,instance:this._renderLine},this._scene),this._renderLine?.refreshBoundingInfo()}attachToMesh(e,t,i,r){this._attachedToMesh=e;const s=this.ray;s&&(s.direction||(s.direction=n.Pq.Zero()),s.origin||(s.origin=n.Pq.Zero()),r&&(s.length=r),i||(i=n.Pq.Zero()),t||(t=new n.Pq(0,0,-1)),this._scene||(this._scene=e.getScene()),this._meshSpaceDirection?(this._meshSpaceDirection.copyFrom(t),this._meshSpaceOrigin.copyFrom(i)):(this._meshSpaceDirection=t.clone(),this._meshSpaceOrigin=i.clone()),this._onAfterRenderObserver||(this._onAfterRenderObserver=this._scene.onBeforeRenderObservable.add((()=>this._updateToMesh())),this._onAfterStepObserver=this._scene.onAfterStepObservable.add((()=>this._updateToMesh()))),this._attachedToMesh.computeWorldMatrix(!0),this._updateToMesh())}detachFromMesh(){this._attachedToMesh&&this._scene&&(this._onAfterRenderObserver&&(this._scene.onBeforeRenderObservable.remove(this._onAfterRenderObserver),this._scene.onAfterStepObservable.remove(this._onAfterStepObserver)),this._attachedToMesh=null,this._onAfterRenderObserver=null,this._onAfterStepObserver=null,this._scene=null)}_updateToMesh(){const e=this.ray;this._attachedToMesh&&e&&(this._attachedToMesh.isDisposed()?this.detachFromMesh():(this._attachedToMesh.getDirectionToRef(this._meshSpaceDirection,e.direction),n.Pq.TransformCoordinatesToRef(this._meshSpaceOrigin,this._attachedToMesh.getWorldMatrix(),e.origin)))}dispose(){this.hide(),this.detachFromMesh(),this.ray=null}}var xo=i(74420);class vo{static CreateBoneWeightShader(e,t){const i=e.skeleton,r=e.colorBase??o.v9.Black(),s=e.colorZero??o.v9.Blue(),n=e.colorQuarter??o.v9.Green(),a=e.colorHalf??o.v9.Yellow(),l=e.colorFull??o.v9.Red(),h=e.targetBoneIndex??0;xo.M.ShadersStore["boneWeights:"+i.name+"VertexShader"]="precision highp float;\n\n        attribute vec3 position;\n        attribute vec2 uv;\n\n        uniform mat4 view;\n        uniform mat4 projection;\n        uniform mat4 worldViewProjection;\n\n        #include<bonesDeclaration>\n        #if NUM_BONE_INFLUENCERS == 0\n            attribute vec4 matricesIndices;\n            attribute vec4 matricesWeights;\n        #endif\n        #include<bakedVertexAnimationDeclaration>\n\n        #include<instancesDeclaration>\n\n        varying vec3 vColor;\n\n        uniform vec3 colorBase;\n        uniform vec3 colorZero;\n        uniform vec3 colorQuarter;\n        uniform vec3 colorHalf;\n        uniform vec3 colorFull;\n\n        uniform float targetBoneIndex;\n\n        void main() {\n            vec3 positionUpdated = position;\n\n            #include<instancesVertex>\n            #include<bonesVertex>\n            #include<bakedVertexAnimation>\n\n            vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);\n\n            vec3 color = colorBase;\n            float totalWeight = 0.;\n            if(matricesIndices[0] == targetBoneIndex && matricesWeights[0] > 0.){\n                totalWeight += matricesWeights[0];\n            }\n            if(matricesIndices[1] == targetBoneIndex && matricesWeights[1] > 0.){\n                totalWeight += matricesWeights[1];\n            }\n            if(matricesIndices[2] == targetBoneIndex && matricesWeights[2] > 0.){\n                totalWeight += matricesWeights[2];\n            }\n            if(matricesIndices[3] == targetBoneIndex && matricesWeights[3] > 0.){\n                totalWeight += matricesWeights[3];\n            }\n\n            color = mix(color, colorZero, smoothstep(0., 0.25, totalWeight));\n            color = mix(color, colorQuarter, smoothstep(0.25, 0.5, totalWeight));\n            color = mix(color, colorHalf, smoothstep(0.5, 0.75, totalWeight));\n            color = mix(color, colorFull, smoothstep(0.75, 1.0, totalWeight));\n            vColor = color;\n\n        gl_Position = projection * view * worldPos;\n        }",xo.M.ShadersStore["boneWeights:"+i.name+"FragmentShader"]="\n            precision highp float;\n            varying vec3 vPosition;\n\n            varying vec3 vColor;\n\n            void main() {\n                vec4 color = vec4(vColor, 1.0);\n                gl_FragColor = color;\n            }\n        ";const c=new rs("boneWeight:"+i.name,t,{vertex:"boneWeights:"+i.name,fragment:"boneWeights:"+i.name},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorBase","colorZero","colorQuarter","colorHalf","colorFull","targetBoneIndex"]});return c.setColor3("colorBase",r),c.setColor3("colorZero",s),c.setColor3("colorQuarter",n),c.setColor3("colorHalf",a),c.setColor3("colorFull",l),c.setFloat("targetBoneIndex",h),c.getClassName=()=>"BoneWeightShader",c.transparencyMode=fn.i.MATERIAL_OPAQUE,c}static CreateSkeletonMapShader(e,t){const i=e.skeleton,r=e.colorMap??[{color:new o.v9(1,.38,.18),location:0},{color:new o.v9(.59,.18,1),location:.2},{color:new o.v9(.59,1,.18),location:.4},{color:new o.v9(1,.87,.17),location:.6},{color:new o.v9(1,.17,.42),location:.8},{color:new o.v9(.17,.68,1),location:1}],s=i.bones.length+1,n=vo._CreateBoneMapColorBuffer(s,r,t),a=new rs("boneWeights:"+i.name,t,{vertexSource:"precision highp float;\n\n            attribute vec3 position;\n            attribute vec2 uv;\n\n            uniform mat4 view;\n            uniform mat4 projection;\n            uniform mat4 worldViewProjection;\n            uniform float colorMap["+4*i.bones.length+"];\n\n            #include<bonesDeclaration>\n            #if NUM_BONE_INFLUENCERS == 0\n                attribute vec4 matricesIndices;\n                attribute vec4 matricesWeights;\n            #endif\n            #include<bakedVertexAnimationDeclaration>\n            #include<instancesDeclaration>\n\n            varying vec3 vColor;\n\n            void main() {\n                vec3 positionUpdated = position;\n\n                #include<instancesVertex>\n                #include<bonesVertex>\n                #include<bakedVertexAnimation>\n\n                vec3 color = vec3(0.);\n                bool first = true;\n\n                for (int i = 0; i < 4; i++) {\n                    int boneIdx = int(matricesIndices[i]);\n                    float boneWgt = matricesWeights[i];\n\n                    vec3 c = vec3(colorMap[boneIdx * 4 + 0], colorMap[boneIdx * 4 + 1], colorMap[boneIdx * 4 + 2]);\n\n                    if (boneWgt > 0.) {\n                        if (first) {\n                            first = false;\n                            color = c;\n                        } else {\n                            color = mix(color, c, boneWgt);\n                        }\n                    }\n                }\n\n                vColor = color;\n\n                vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);\n\n                gl_Position = projection * view * worldPos;\n            }",fragmentSource:"\n            precision highp float;\n            varying vec3 vColor;\n\n            void main() {\n                vec4 color = vec4( vColor, 1.0 );\n                gl_FragColor = color;\n            }\n            "},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorMap"]});return a.setFloats("colorMap",n),a.getClassName=()=>"SkeletonMapShader",a.transparencyMode=fn.i.MATERIAL_OPAQUE,a}static _CreateBoneMapColorBuffer(e,t,i){const r=new Tr("temp",{width:e,height:1},i,!1),s=r.getContext(),n=s.createLinearGradient(0,0,e,0);t.forEach((e=>{n.addColorStop(e.location,e.color.toHexString())})),s.fillStyle=n,s.fillRect(0,0,e,1),r.update();const o=[],a=s.getImageData(0,0,e,1).data,l=1/255;for(let e=0;e<a.length;e++)o.push(a[e]*l);return r.dispose(),o}get scene(){return this._scene}get utilityLayer(){return this._utilityLayer}get isReady(){return this._ready}set ready(e){this._ready=e}get debugMesh(){return this._debugMesh}set debugMesh(e){this._debugMesh=e}get displayMode(){return this.options.displayMode||vo.DISPLAY_LINES}set displayMode(e){e>vo.DISPLAY_SPHERE_AND_SPURS&&(e=vo.DISPLAY_LINES),this.options.displayMode=e}constructor(e,t,i,r=!0,s=3,n={}){if(this.skeleton=e,this.mesh=t,this.autoUpdateBonesMatrices=r,this.renderingGroupId=s,this.options=n,this.color=o.v9.White(),this._debugLines=new Array,this._localAxes=null,this._isEnabled=!0,this._obs=null,this._scene=i,this._ready=!1,n.pauseAnimations=n.pauseAnimations??!0,n.returnToRest=n.returnToRest??!1,n.displayMode=n.displayMode??vo.DISPLAY_LINES,n.displayOptions=n.displayOptions??{},n.displayOptions.midStep=n.displayOptions.midStep??.235,n.displayOptions.midStepFactor=n.displayOptions.midStepFactor??.155,n.displayOptions.sphereBaseSize=n.displayOptions.sphereBaseSize??.15,n.displayOptions.sphereScaleUnit=n.displayOptions.sphereScaleUnit??2,n.displayOptions.sphereFactor=n.displayOptions.sphereFactor??.865,n.displayOptions.spurFollowsChild=n.displayOptions.spurFollowsChild??!1,n.displayOptions.showLocalAxes=n.displayOptions.showLocalAxes??!1,n.displayOptions.localAxesSize=n.displayOptions.localAxesSize??.075,n.computeBonesUsingShaders=n.computeBonesUsingShaders??!0,n.useAllBones=n.useAllBones??!0,this._boneIndices=new Set,!n.useAllBones){const e=t?.getVerticesData(Ot.R.MatricesIndicesKind),i=t?.getVerticesData(Ot.R.MatricesWeightsKind);if(e&&i)for(let t=0;t<e.length;++t){const r=e[t];0!==i[t]&&this._boneIndices.add(r)}}this._utilityLayer=new Rs(this._scene,!1),this._utilityLayer.pickUtilitySceneFirst=!1,this._utilityLayer.utilityLayerScene.autoClearDepthAndStencil=!0;let a=this.options.displayMode||0;a>vo.DISPLAY_SPHERE_AND_SPURS&&(a=vo.DISPLAY_LINES),this.displayMode=a,this.update(),this._bindObs()}_bindObs(){if(this.displayMode===vo.DISPLAY_LINES)this._obs=this.scene.onBeforeRenderObservable.add((()=>{this._displayLinesUpdate()}))}update(){switch(this.displayMode){case vo.DISPLAY_LINES:this._displayLinesUpdate();break;case vo.DISPLAY_SPHERES:this._buildSpheresAndSpurs(!0);break;case vo.DISPLAY_SPHERE_AND_SPURS:this._buildSpheresAndSpurs(!1)}this._buildLocalAxes()}set isEnabled(e){this.isEnabled!==e&&(this._isEnabled=e,this.debugMesh&&this.debugMesh.setEnabled(e),e&&!this._obs?this._bindObs():!e&&this._obs&&(this.scene.onBeforeRenderObservable.remove(this._obs),this._obs=null))}get isEnabled(){return this._isEnabled}_getBonePosition(e,t,i,r=0,s=0,o=0){const a=n.AA.Matrix[0],l=t.getParent();if(a.copyFrom(t.getLocalMatrix()),0!==r||0!==s||0!==o){const e=n.AA.Matrix[1];n.uq.IdentityToRef(e),e.setTranslationFromFloats(r,s,o),e.multiplyToRef(a,a)}l&&a.multiplyToRef(l.getAbsoluteMatrix(),a),a.multiplyToRef(i,a),e.x=a.m[12],e.y=a.m[13],e.z=a.m[14]}_getLinesForBonesWithLength(e,t){const i=e.length;let r,s;t?(r=t.getWorldMatrix(),s=t.position):(r=new n.uq,s=e[0].position);let o=0;for(let t=0;t<i;t++){const i=e[t];let a=this._debugLines[o];-1!==i._index&&(this._boneIndices.has(i.getIndex())||this.options.useAllBones)&&(a||(a=[n.Pq.Zero(),n.Pq.Zero()],this._debugLines[o]=a),this._getBonePosition(a[0],i,r),this._getBonePosition(a[1],i,r,0,i.length,0),a[0].subtractInPlace(s),a[1].subtractInPlace(s),o++)}}_getLinesForBonesNoLength(e){const t=e.length;let i=0;const r=this.mesh;let s,o;r?(s=r,o=r.position):(s=new mt.V(""),o=e[0].position);for(let r=t-1;r>=0;r--){const t=e[r],a=t.getParent();if(!a||!this._boneIndices.has(t.getIndex())&&!this.options.useAllBones)continue;let l=this._debugLines[i];l||(l=[n.Pq.Zero(),n.Pq.Zero()],this._debugLines[i]=l),t.getAbsolutePositionToRef(s,l[0]),a.getAbsolutePositionToRef(s,l[1]),l[0].subtractInPlace(o),l[1].subtractInPlace(o),i++}r||s.dispose()}_revert(e){this.options.pauseAnimations&&(this.scene.animationsEnabled=e,this.utilityLayer.utilityLayerScene.animationsEnabled=e)}_getAbsoluteBindPoseToRef(e,t){null!==e&&-1!==e._index?(this._getAbsoluteBindPoseToRef(e.getParent(),t),e.getBindMatrix().multiplyToRef(t,t)):t.copyFrom(n.uq.Identity())}_createSpur(e,t,i,r,s,o){const a=i.subtract(e),l=a.length(),h=a.normalize().scale(l),c=s.midStep||.165,u=s.midStepFactor||.215,d=h.scale(c),p=wn("skeletonViewer",{shape:[new n.Pq(1,-1,0),new n.Pq(1,1,0),new n.Pq(-1,1,0),new n.Pq(-1,-1,0),new n.Pq(1,-1,0)],path:[n.Pq.Zero(),d,h],scaleFunction:e=>{switch(e){case 0:case 2:return 0;case 1:return l*u}return 0},sideOrientation:tt.e.DEFAULTSIDE,updatable:!1},o),m=p.getTotalVertices(),f=[],_=[];for(let e=0;e<m;e++)f.push(1,0,0,0),r&&s.spurFollowsChild&&e>9?_.push(r.getIndex(),0,0,0):_.push(t.getIndex(),0,0,0);return p.position=e.clone(),p.setVerticesData(Ot.R.MatricesWeightsKind,f,!1),p.setVerticesData(Ot.R.MatricesIndicesKind,_,!1),p.convertToFlatShadedMesh(),p}_getBoundingSphereForBone(e){if(!this.mesh)return null;const t=this.mesh.getVerticesData(Ot.R.PositionKind),i=this.mesh.getIndices(),r=this.mesh.getVerticesData(Ot.R.MatricesWeightsKind),s=this.mesh.getVerticesData(Ot.R.MatricesIndicesKind);if(!(t&&i&&r&&s))return null;const o=new n.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new n.Pq(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);let l=0;for(let h=0;h<i.length;++h){const c=i[h];for(let i=0;i<4;++i){const h=s[4*c+i],u=r[4*c+i];if(h===e&&u>1e-5){n.Pq.FromArrayToRef(t,3*c,n.AA.Vector3[0]),o.minimizeInPlace(n.AA.Vector3[0]),a.maximizeInPlace(n.AA.Vector3[0]),l++;break}}}return l>1?{center:n.Pq.Center(o,a),radius:n.Pq.Distance(o,a)/2}:null}_buildSpheresAndSpurs(e=!0){this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this._ready=!1;const t=this.utilityLayer?.utilityLayerScene,i=this.skeleton.bones,r=[],s=[],o=this.scene.animationsEnabled;try{this.options.pauseAnimations&&(this.scene.animationsEnabled=!1,t.animationsEnabled=!1),this.options.returnToRest&&this.skeleton.returnToRest(),this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteMatrices();let a=Number.NEGATIVE_INFINITY;const l=this.options.displayOptions||{};for(let o=0;o<i.length;o++){const h=i[o];if(-1===h._index||!this._boneIndices.has(h.getIndex())&&!this.options.useAllBones)continue;const c=new n.uq;this._getAbsoluteBindPoseToRef(h,c);const u=new n.Pq;if(c.decompose(void 0,void 0,u),h.children.length>0)h.children.forEach((i=>{const r=new n.uq;i.getLocalMatrix().multiplyToRef(c,r);const o=new n.Pq;r.decompose(void 0,void 0,o);const d=n.Pq.Distance(u,o);d>a&&(a=d),e||s.push(this._createSpur(u,h,o,i,l,t))}));else{const i=this._getBoundingSphereForBone(h.getIndex());if(i&&(i.radius>a&&(a=i.radius),!e)){let e;const r=h.getParent();r?(this._getAbsoluteBindPoseToRef(r,c),c.decompose(void 0,void 0,n.AA.Vector3[0]),e=u.subtract(n.AA.Vector3[0]).normalize().scale(i.radius).add(u)):e=i.center.subtract(u).normalize().scale(i.radius).add(u),s.push(this._createSpur(u,h,e,null,l,t))}}const d=zs("skeletonViewer",{segments:6,diameter:l.sphereBaseSize||.2,updatable:!0},t),p=d.getTotalVertices(),m=[],f=[];for(let e=0;e<p;e++)m.push(1,0,0,0),f.push(h.getIndex(),0,0,0);d.setVerticesData(Ot.R.MatricesWeightsKind,m,!1),d.setVerticesData(Ot.R.MatricesIndicesKind,f,!1),d.position=u.clone(),r.push([d,h])}const h=l.sphereScaleUnit||2,c=l.sphereFactor||.85,u=[];for(let e=0;e<r.length;e++){const[t,i]=r[e],s=1/(h/a);let n=0,o=i;for(;o.getParent()&&-1!==o.getParent().getIndex();)n++,o=o.getParent();t.scaling.scaleInPlace(s*Math.pow(c,n)),u.push(t)}this.debugMesh=tt.e.MergeMeshes(u.concat(s),!0,!0),this.debugMesh&&(this.debugMesh.renderingGroupId=this.renderingGroupId,this.debugMesh.skeleton=this.skeleton,this.debugMesh.parent=this.mesh,this.debugMesh.computeBonesUsingShaders=this.options.computeBonesUsingShaders??!0,this.debugMesh.alwaysSelectAsActiveMesh=!0);this.utilityLayer._getSharedGizmoLight().intensity=.7,this._revert(o),this.ready=!0}catch(e){m.V.Error(e),this._revert(o),this.dispose()}}_buildLocalAxes(){this._localAxes&&this._localAxes.dispose(),this._localAxes=null;const e=this.options.displayOptions||{};if(!e.showLocalAxes)return;const t=this._utilityLayer.utilityLayerScene,i=e.localAxesSize||.075,r=[],s=[],a=new o.ov(1,0,0,1),l=new o.ov(0,1,0,1),h=new o.ov(0,0,1,1),c=[],u=[];for(const e in this.skeleton.bones){const t=this.skeleton.bones[e];if(-1===t._index||!this._boneIndices.has(t.getIndex())&&!this.options.useAllBones)continue;const o=new n.uq,d=new n.Pq;this._getAbsoluteBindPoseToRef(t,o),o.decompose(void 0,n.AA.Quaternion[0],d);const p=new n.uq;n.AA.Quaternion[0].toRotationMatrix(p);const m=n.Pq.TransformCoordinates(new n.Pq(0+i,0,0),p),f=n.Pq.TransformCoordinates(new n.Pq(0,0+i,0),p),_=n.Pq.TransformCoordinates(new n.Pq(0,0,0+i),p),g=[[d,d.add(m)],[d,d.add(f)],[d,d.add(_)]],x=[[a,a],[l,l],[h,h]];r.push(...g),s.push(...x);for(let e=0;e<6;e++)c.push(1,0,0,0),u.push(t.getIndex(),0,0,0)}this._localAxes=Sn("localAxes",{lines:r,colors:s,updatable:!0},t),this._localAxes.setVerticesData(Ot.R.MatricesWeightsKind,c,!1),this._localAxes.setVerticesData(Ot.R.MatricesIndicesKind,u,!1),this._localAxes.skeleton=this.skeleton,this._localAxes.renderingGroupId=this.renderingGroupId+1,this._localAxes.parent=this.mesh,this._localAxes.computeBonesUsingShaders=this.options.computeBonesUsingShaders??!0}_displayLinesUpdate(){if(!this._utilityLayer)return;this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteMatrices(),void 0===this.skeleton.bones[0].length?this._getLinesForBonesNoLength(this.skeleton.bones):this._getLinesForBonesWithLength(this.skeleton.bones,this.mesh);const e=this._utilityLayer.utilityLayerScene;e&&(this._debugMesh?Sn("",{lines:this._debugLines,updatable:!0,instance:this._debugMesh},e):(this._debugMesh=Sn("",{lines:this._debugLines,updatable:!0,instance:null},e),this._debugMesh.renderingGroupId=this.renderingGroupId),this.mesh?this._debugMesh.position.copyFrom(this.mesh.position):this._debugMesh.position.copyFrom(this.skeleton.bones[0].position),this._debugMesh.color=this.color)}changeDisplayMode(e){const t=!!this.isEnabled;this.displayMode!==e&&(this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this.displayMode=e,this.update(),this._bindObs(),this.isEnabled=t)}changeDisplayOptions(e,t){const i=!!this.isEnabled;this.options.displayOptions[e]=t,this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this.update(),this._bindObs(),this.isEnabled=i}dispose(){this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null),this._utilityLayer&&(this._utilityLayer.dispose(),this._utilityLayer=null),this.ready=!1}}vo.DISPLAY_LINES=0,vo.DISPLAY_SPHERES=1,vo.DISPLAY_SPHERE_AND_SPURS=2;class So{get transparency(){return this._transparency}set transparency(e){this._transparency=e;for(let t=6;t<12;++t)this._lightHelperFrustumMeshes[t].material.alpha=e}get showLines(){return this._showLines}set showLines(e){if(this._showLines!==e){this._showLines=e;for(let t=0;t<6;++t)this._lightHelperFrustumMeshes[t].setEnabled(e)}}get showPlanes(){return this._showPlanes}set showPlanes(e){if(this._showPlanes!==e){this._showPlanes=e;for(let t=6;t<12;++t)this._lightHelperFrustumMeshes[t].setEnabled(e)}}constructor(e,t=null){this._oldPosition=new n.Pq(Number.NaN,Number.NaN,Number.NaN),this._oldDirection=new n.Pq(Number.NaN,Number.NaN,Number.NaN),this._transparency=.3,this._showLines=!0,this._showPlanes=!0,this._scene=e.getScene(),this._light=e,this._camera=t,this._inverseViewMatrix=n.uq.Identity(),this._lightHelperFrustumMeshes=[],this._createGeometry(),this.show(),this.update()}show(){this._lightHelperFrustumMeshes.forEach(((e,t)=>{e.setEnabled(t<6&&this._showLines||t>=6&&this._showPlanes)})),this._oldPosition.set(Number.NaN,Number.NaN,Number.NaN),this._visible=!0}hide(){this._lightHelperFrustumMeshes.forEach((e=>{e.setEnabled(!1)})),this._visible=!1}update(){if(!this._visible)return;if(this._oldPosition.equals(this._light.position)&&this._oldDirection.equals(this._light.direction)&&this._oldAutoCalc===this._light.autoCalcShadowZBounds&&this._oldMinZ===this._light.shadowMinZ&&this._oldMaxZ===this._light.shadowMaxZ)return;this._oldPosition.copyFrom(this._light.position),this._oldDirection.copyFrom(this._light.direction),this._oldAutoCalc=this._light.autoCalcShadowZBounds,this._oldMinZ=this._light.shadowMinZ,this._oldMaxZ=this._light.shadowMaxZ,n.AA.Vector3[0].set(this._light.orthoLeft,this._light.orthoBottom,void 0!==this._light.shadowMinZ?this._light.shadowMinZ:this._camera?.minZ??0),n.AA.Vector3[1].set(this._light.orthoRight,this._light.orthoTop,void 0!==this._light.shadowMaxZ?this._light.shadowMaxZ:this._camera?.maxZ??1e4);const e=this._getInvertViewMatrix();n.AA.Vector3[2].copyFromFloats(n.AA.Vector3[1].x,n.AA.Vector3[1].y,n.AA.Vector3[0].z),n.AA.Vector3[3].copyFromFloats(n.AA.Vector3[1].x,n.AA.Vector3[0].y,n.AA.Vector3[0].z),n.AA.Vector3[4].copyFromFloats(n.AA.Vector3[0].x,n.AA.Vector3[0].y,n.AA.Vector3[0].z),n.AA.Vector3[5].copyFromFloats(n.AA.Vector3[0].x,n.AA.Vector3[1].y,n.AA.Vector3[0].z),n.Pq.TransformCoordinatesToRef(n.AA.Vector3[2],e,n.AA.Vector3[2]),n.Pq.TransformCoordinatesToRef(n.AA.Vector3[3],e,n.AA.Vector3[3]),n.Pq.TransformCoordinatesToRef(n.AA.Vector3[4],e,n.AA.Vector3[4]),n.Pq.TransformCoordinatesToRef(n.AA.Vector3[5],e,n.AA.Vector3[5]),n.AA.Vector3[6].copyFromFloats(n.AA.Vector3[1].x,n.AA.Vector3[1].y,n.AA.Vector3[1].z),n.AA.Vector3[7].copyFromFloats(n.AA.Vector3[1].x,n.AA.Vector3[0].y,n.AA.Vector3[1].z),n.AA.Vector3[8].copyFromFloats(n.AA.Vector3[0].x,n.AA.Vector3[0].y,n.AA.Vector3[1].z),n.AA.Vector3[9].copyFromFloats(n.AA.Vector3[0].x,n.AA.Vector3[1].y,n.AA.Vector3[1].z),n.Pq.TransformCoordinatesToRef(n.AA.Vector3[6],e,n.AA.Vector3[6]),n.Pq.TransformCoordinatesToRef(n.AA.Vector3[7],e,n.AA.Vector3[7]),n.Pq.TransformCoordinatesToRef(n.AA.Vector3[8],e,n.AA.Vector3[8]),n.Pq.TransformCoordinatesToRef(n.AA.Vector3[9],e,n.AA.Vector3[9]),bn("nearlines",{updatable:!0,points:this._nearLinesPoints,instance:this._lightHelperFrustumMeshes[0]},this._scene),bn("farlines",{updatable:!0,points:this._farLinesPoints,instance:this._lightHelperFrustumMeshes[1]},this._scene),bn("trlines",{updatable:!0,points:this._trLinesPoints,instance:this._lightHelperFrustumMeshes[2]},this._scene),bn("brlines",{updatable:!0,points:this._brLinesPoints,instance:this._lightHelperFrustumMeshes[3]},this._scene),bn("tllines",{updatable:!0,points:this._tlLinesPoints,instance:this._lightHelperFrustumMeshes[4]},this._scene),bn("bllines",{updatable:!0,points:this._blLinesPoints,instance:this._lightHelperFrustumMeshes[5]},this._scene),n.AA.Vector3[2].toArray(this._nearPlaneVertices,0),n.AA.Vector3[3].toArray(this._nearPlaneVertices,3),n.AA.Vector3[4].toArray(this._nearPlaneVertices,6),n.AA.Vector3[5].toArray(this._nearPlaneVertices,9),this._lightHelperFrustumMeshes[6].geometry?.updateVerticesDataDirectly("position",this._nearPlaneVertices,0),n.AA.Vector3[6].toArray(this._farPlaneVertices,0),n.AA.Vector3[7].toArray(this._farPlaneVertices,3),n.AA.Vector3[8].toArray(this._farPlaneVertices,6),n.AA.Vector3[9].toArray(this._farPlaneVertices,9),this._lightHelperFrustumMeshes[7].geometry?.updateVerticesDataDirectly("position",this._farPlaneVertices,0),n.AA.Vector3[2].toArray(this._rightPlaneVertices,0),n.AA.Vector3[6].toArray(this._rightPlaneVertices,3),n.AA.Vector3[7].toArray(this._rightPlaneVertices,6),n.AA.Vector3[3].toArray(this._rightPlaneVertices,9),this._lightHelperFrustumMeshes[8].geometry?.updateVerticesDataDirectly("position",this._rightPlaneVertices,0),n.AA.Vector3[5].toArray(this._leftPlaneVertices,0),n.AA.Vector3[9].toArray(this._leftPlaneVertices,3),n.AA.Vector3[8].toArray(this._leftPlaneVertices,6),n.AA.Vector3[4].toArray(this._leftPlaneVertices,9),this._lightHelperFrustumMeshes[9].geometry?.updateVerticesDataDirectly("position",this._leftPlaneVertices,0),n.AA.Vector3[2].toArray(this._topPlaneVertices,0),n.AA.Vector3[6].toArray(this._topPlaneVertices,3),n.AA.Vector3[9].toArray(this._topPlaneVertices,6),n.AA.Vector3[5].toArray(this._topPlaneVertices,9),this._lightHelperFrustumMeshes[10].geometry?.updateVerticesDataDirectly("position",this._topPlaneVertices,0),n.AA.Vector3[3].toArray(this._bottomPlaneVertices,0),n.AA.Vector3[7].toArray(this._bottomPlaneVertices,3),n.AA.Vector3[8].toArray(this._bottomPlaneVertices,6),n.AA.Vector3[4].toArray(this._bottomPlaneVertices,9),this._lightHelperFrustumMeshes[11].geometry?.updateVerticesDataDirectly("position",this._bottomPlaneVertices,0)}dispose(){this._lightHelperFrustumMeshes.forEach((e=>{e.material?.dispose(),e.dispose()})),this._rootNode.dispose()}_createGeometry(){this._rootNode=new mt.V("directionalLightHelperRoot_"+this._light.name,this._scene),this._rootNode.parent=this._light.parent,this._nearLinesPoints=[n.AA.Vector3[0],n.AA.Vector3[1],n.AA.Vector3[2],n.AA.Vector3[3],n.AA.Vector3[4]];const e=bn("nearlines",{updatable:!0,points:this._nearLinesPoints},this._scene);e.parent=this._rootNode,e.alwaysSelectAsActiveMesh=!0,this._farLinesPoints=[n.AA.Vector3[5],n.AA.Vector3[6],n.AA.Vector3[7],n.AA.Vector3[8],n.AA.Vector3[9]];const t=bn("farlines",{updatable:!0,points:this._farLinesPoints},this._scene);t.parent=this._rootNode,t.alwaysSelectAsActiveMesh=!0,this._trLinesPoints=[n.AA.Vector3[10],n.AA.Vector3[11]];const i=bn("trlines",{updatable:!0,points:this._trLinesPoints},this._scene);i.parent=this._rootNode,i.alwaysSelectAsActiveMesh=!0,this._brLinesPoints=[n.AA.Vector3[12],n.AA.Vector3[0]];const r=bn("brlines",{updatable:!0,points:this._brLinesPoints},this._scene);r.parent=this._rootNode,r.alwaysSelectAsActiveMesh=!0,this._tlLinesPoints=[n.AA.Vector3[1],n.AA.Vector3[2]];const s=bn("tllines",{updatable:!0,points:this._tlLinesPoints},this._scene);s.parent=this._rootNode,s.alwaysSelectAsActiveMesh=!0,this._blLinesPoints=[n.AA.Vector3[3],n.AA.Vector3[4]];const a=bn("bllines",{updatable:!0,points:this._blLinesPoints},this._scene);a.parent=this._rootNode,a.alwaysSelectAsActiveMesh=!0,this._lightHelperFrustumMeshes.push(e,t,i,r,s,a);const l=(e,t,i)=>{const r=new tt.e(e+"plane",this._scene),s=new br.F(e+"PlaneMat",this._scene);r.material=s,r.parent=this._rootNode,r.alwaysSelectAsActiveMesh=!0,s.emissiveColor=t,s.alpha=this.transparency,s.backFaceCulling=!1,s.disableLighting=!0;const n=new ot.P;n.positions=i,n.indices=[0,1,2,0,2,3],n.applyToMesh(r,!0),this._lightHelperFrustumMeshes.push(r)};this._nearPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._farPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._rightPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._leftPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._topPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._bottomPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],l("near",new o.v9(1,0,0),this._nearPlaneVertices),l("far",new o.v9(.3,0,0),this._farPlaneVertices),l("right",new o.v9(0,1,0),this._rightPlaneVertices),l("left",new o.v9(0,.3,0),this._leftPlaneVertices),l("top",new o.v9(0,0,1),this._topPlaneVertices),l("bottom",new o.v9(0,0,.3),this._bottomPlaneVertices),this._nearLinesPoints[0]=n.AA.Vector3[2],this._nearLinesPoints[1]=n.AA.Vector3[3],this._nearLinesPoints[2]=n.AA.Vector3[4],this._nearLinesPoints[3]=n.AA.Vector3[5],this._nearLinesPoints[4]=n.AA.Vector3[2],this._farLinesPoints[0]=n.AA.Vector3[6],this._farLinesPoints[1]=n.AA.Vector3[7],this._farLinesPoints[2]=n.AA.Vector3[8],this._farLinesPoints[3]=n.AA.Vector3[9],this._farLinesPoints[4]=n.AA.Vector3[6],this._trLinesPoints[0]=n.AA.Vector3[2],this._trLinesPoints[1]=n.AA.Vector3[6],this._brLinesPoints[0]=n.AA.Vector3[3],this._brLinesPoints[1]=n.AA.Vector3[7],this._tlLinesPoints[0]=n.AA.Vector3[4],this._tlLinesPoints[1]=n.AA.Vector3[8],this._blLinesPoints[0]=n.AA.Vector3[5],this._blLinesPoints[1]=n.AA.Vector3[9]}_getInvertViewMatrix(){return n.uq.LookAtLHToRef(this._light.position,this._light.position.add(this._light.direction),n.Pq.UpReadOnly,this._inverseViewMatrix),this._inverseViewMatrix.invertToRef(this._inverseViewMatrix),this._inverseViewMatrix}}var bo=i(24153),yo=i(51314),Po=i(64100),To=i(96125),Co=i(20215),Eo=i(61760),Ao=i(70767);class Io{constructor(){this.renderWidth=512,this.renderHeight=256,this.textureSize=512,this.deterministicLockstep=!1,this.lockstepMaxSteps=4}}class Ro extends Vi.Engine{isDeterministicLockStep(){return this._options.deterministicLockstep}getLockstepMaxSteps(){return this._options.lockstepMaxSteps}getHardwareScalingLevel(){return 1}constructor(e=new Io){super(null),void 0===e.deterministicLockstep&&(e.deterministicLockstep=!1),void 0!==e.timeStep&&(this._timeStep=e.timeStep),void 0===e.lockstepMaxSteps&&(e.lockstepMaxSteps=4),this._options=e,Co.I.SetMatrixPrecision(!!e.useHighPrecisionMatrix),this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:512,maxCubemapTextureSize:512,maxDrawBuffers:0,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!1,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:0,uintIndices:!1,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,textureFloat:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloat:!1,textureHalfFloatLinearFiltering:!1,textureHalfFloatRender:!1,textureLOD:!1,texelFetch:!1,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!1,instancedArrays:!1,supportOcclusionQuery:!1,canUseTimestampForTimerQuery:!1,maxMSAASamples:1,blendMinMax:!1,canUseGLInstanceID:!1,canUseGLVertexID:!1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:!1,textureMaxLevel:!1,texture2DArrayMaxLayerCount:128,disableMorphTargetTexture:!1,textureNorm16:!1},this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!1,supportSSAO2:!1,supportIBLShadows:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!1,useUBOBindingCache:!1,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!0,supportSpriteInstancing:!1,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1},e.renderingCanvas&&(this._renderingCanvas=e.renderingCanvas),m.V.Log(`Babylon.js v${Vi.Engine.Version} - Null engine`);const t="undefined"!=typeof self?self:"undefined"!=typeof global?global:window;"undefined"==typeof URL&&(t.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),"undefined"==typeof Blob&&(t.Blob=function(){})}createVertexBuffer(e){const t=new wt.n;return t.references=1,t}createIndexBuffer(e){const t=new wt.n;return t.references=1,t}clear(e,t,i,r=!1){}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._options.renderWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._options.renderHeight}setViewport(e,t,i){this._cachedViewport=e}createShaderProgram(e,t,i,r,s){return{__SPECTOR_rebuildProgram:null}}getUniforms(e,t){return[]}getAttributes(e,t){return[]}bindSamplers(e){this._currentEffect=null}enableEffect(e){e=null!==e&&(0,Ao.E)(e)?e.effect:e,this._currentEffect=e,e&&(e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setStateCullFaceType(e,t){}setState(e,t=0,i,r=!1,s,n,o=0){}setIntArray(e,t){return!0}setIntArray2(e,t){return!0}setIntArray3(e,t){return!0}setIntArray4(e,t){return!0}setFloatArray(e,t){return!0}setFloatArray2(e,t){return!0}setFloatArray3(e,t){return!0}setFloatArray4(e,t){return!0}setArray(e,t){return!0}setArray2(e,t){return!0}setArray3(e,t){return!0}setArray4(e,t){return!0}setMatrices(e,t){return!0}setMatrix3x3(e,t){return!0}setMatrix2x2(e,t){return!0}setFloat(e,t){return!0}setFloat2(e,t,i){return!0}setFloat3(e,t,i,r){return!0}setBool(e,t){return!0}setFloat4(e,t,i,r,s){return!0}setAlphaMode(e,t=!1){this._alphaMode!==e&&(this.alphaState.alphaBlend=0!==e,t||this.setDepthWrite(0===e),this._alphaMode=e)}bindBuffers(e,t,i){}wipeCaches(e){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,e&&(this._currentProgram=null,this._stencilStateComposer.reset(),this.depthCullingState.reset(),this.alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}draw(e,t,i,r){}drawElementsType(e,t,i,r){}drawArraysType(e,t,i,r){}_createTexture(){return{}}_releaseTexture(e){}createTexture(e,t,i,r,s=3,n=null,o=null,a=null,l=null,h=null,c=null,u){const d=new lr.h(this,1),p=String(e);return d.url=p,d.generateMipMaps=!t,d.samplingMode=s,d.invertY=i,d.baseWidth=this._options.textureSize,d.baseHeight=this._options.textureSize,d.width=this._options.textureSize,d.height=this._options.textureSize,h&&(d.format=h),d.isReady=!0,n&&setTimeout((()=>{n(d)})),this._internalTexturesCache.push(d),d}_createHardwareRenderTargetWrapper(e,t,i){const r=new Eo.v(e,t,i,this);return this._renderTargetWrapperCache.push(r),r}createRenderTargetTexture(e,t){const i=this._createHardwareRenderTargetWrapper(!1,!1,e),r={};void 0!==t&&"object"==typeof t?(r.generateMipMaps=t.generateMipMaps,r.generateDepthBuffer=void 0===t.generateDepthBuffer||t.generateDepthBuffer,r.generateStencilBuffer=r.generateDepthBuffer&&t.generateStencilBuffer,r.type=void 0===t.type?0:t.type,r.samplingMode=void 0===t.samplingMode?3:t.samplingMode):(r.generateMipMaps=t,r.generateDepthBuffer=!0,r.generateStencilBuffer=!1,r.type=0,r.samplingMode=3);const s=new lr.h(this,5),n=e.width||e,o=e.height||e;return i._generateDepthBuffer=r.generateDepthBuffer,i._generateStencilBuffer=!!r.generateStencilBuffer,s.baseWidth=n,s.baseHeight=o,s.width=n,s.height=o,s.isReady=!0,s.samples=1,s.generateMipMaps=!!r.generateMipMaps,s.samplingMode=r.samplingMode,s.type=r.type,this._internalTexturesCache.push(s),i}createRenderTargetCubeTexture(e,t){const i=this._createHardwareRenderTargetWrapper(!1,!0,e),r={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...t};r.generateStencilBuffer=r.generateDepthBuffer&&r.generateStencilBuffer,(1!==r.type||this._caps.textureFloatLinearFiltering)&&(2!==r.type||this._caps.textureHalfFloatLinearFiltering)||(r.samplingMode=1),i._generateDepthBuffer=r.generateDepthBuffer,i._generateStencilBuffer=!!r.generateStencilBuffer;const s=new lr.h(this,5);return s.baseWidth=e,s.baseHeight=e,s.width=e,s.height=e,s.isReady=!0,s.isCube=!0,s.samples=1,s.generateMipMaps=!!r.generateMipMaps,s.samplingMode=r.samplingMode,s.type=r.type,this._internalTexturesCache.push(s),i}updateTextureSamplingMode(e,t){t.samplingMode=e}createRawTexture(e,t,i,r,s,n,o,a=null,l=0,h=0,c=!1){const u=new lr.h(this,3);return u.baseWidth=t,u.baseHeight=i,u.width=t,u.height=i,u.format=r,u.generateMipMaps=s,u.samplingMode=o,u.invertY=n,u._compression=a,u.type=l,u._useSRGBBuffer=c,this._doNotHandleContextLost||(u._bufferView=e),u}updateRawTexture(e,t,i,r,s=null,n=0,o=!1){e&&(e._bufferView=t,e.format=i,e.invertY=r,e._compression=s,e.type=n,e._useSRGBBuffer=o)}bindFramebuffer(e,t,i,r,s){this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._currentFramebuffer=null,this._cachedViewport&&!s&&this.setViewport(this._cachedViewport,i,r)}unBindFramebuffer(e,t=!1,i){this._currentRenderTarget=null,i&&i(),this._currentFramebuffer=null}createDynamicVertexBuffer(e){const t=new wt.n;return t.references=1,t.capacity=1,t}updateDynamicTexture(e,t,i,r=!1,s){}areAllEffectsReady(){return!0}getError(){return 0}_getUnpackAlignement(){return 1}_unpackFlipY(e){}updateDynamicIndexBuffer(e,t,i=0){}updateDynamicVertexBuffer(e,t,i,r){}_bindTextureDirectly(e,t){return this._boundTexturesCache[this._activeChannel]!==t&&(this._boundTexturesCache[this._activeChannel]=t,!0)}_bindTexture(e,t){e<0||this._bindTextureDirectly(0,t)}_deleteBuffer(e){}releaseEffects(){}displayLoadingUI(){}hideLoadingUI(){}set loadingUIText(e){}flushFramebuffer(){}_uploadCompressedDataToTextureDirectly(e,t,i,r,s,n=0,o=0){}_uploadDataToTextureDirectly(e,t,i=0,r=0){}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){}_uploadImageToTexture(e,t,i=0,r=0){}}i(69195),i(29967),i(28019),i(46125);var Mo=i(24296);$.$.prototype.getGPUFrameTimeCounter=function(){return this._gpuFrameTime||(this._gpuFrameTime=new Mo.A),this._gpuFrameTime},$.$.prototype.captureGPUFrameTime=function(e){};var Do=i(11411);i(97298),i(9696),i(94363);class Oo{}const No=new s.cP,wo=new s.cP;Object.defineProperty($.$.prototype,"onBeforeViewRenderObservable",{get:function(){return No}}),Object.defineProperty($.$.prototype,"onAfterViewRenderObservable",{get:function(){return wo}}),Object.defineProperty($.$.prototype,"inputElement",{get:function(){return this._inputElement},set:function(e){this._inputElement!==e&&(this._inputElement=e,this._onEngineViewChanged?.())}}),$.$.prototype.getInputElement=function(){return this.inputElement||this.getRenderingCanvas()},$.$.prototype.registerView=function(e,t,i){this.views||(this.views=[]);for(const t of this.views)if(t.target===e)return t;const r=this.getRenderingCanvas();r&&(e.width=r.width,e.height=r.height);const s={target:e,camera:t,clearBeforeCopy:i,enabled:!0,id:(1e5*Math.random()).toFixed()};return this.views.push(s),t&&!Array.isArray(t)&&t.onDisposeObservable.add((()=>{this.unRegisterView(e)})),s},$.$.prototype.unRegisterView=function(e){if(!this.views||0===this.views.length)return this;for(const t of this.views)if(t.target===e){const e=this.views.indexOf(t);-1!==e&&this.views.splice(e,1);break}return this},$.$.prototype._renderViewStep=function(e){const t=e.target,i=t.getContext("2d");if(!i)return!0;const r=this.getRenderingCanvas();No.notifyObservers(e);const s=e.camera;let n=null,o=null,a=null;if(s&&(a=Array.isArray(s)?s[0].getScene():s.getScene(),n=a.activeCamera,o=a.activeCameras,Array.isArray(s)?a.activeCameras=s:(a.activeCamera=s,a.activeCameras=null)),this.activeView=e,e.customResize)e.customResize(t);else{const e=Math.floor(t.clientWidth/this._hardwareScalingLevel),i=Math.floor(t.clientHeight/this._hardwareScalingLevel),s=e!==t.width||r.width!==t.width||i!==t.height||r.height!==t.height;t.clientWidth&&t.clientHeight&&s&&(t.width=e,t.height=i,this.setSize(e,i))}return!(!r.width||!r.height)&&(this._renderFrame(),this.flushFramebuffer(),e.clearBeforeCopy&&i.clearRect(0,0,r.width,r.height),i.drawImage(r,0,0),a&&(a.activeCameras=o,a.activeCamera=n),wo.notifyObservers(e),!0)},$.$.prototype._renderViews=function(){if(!this.views||0===this.views.length)return!1;if(!this.getRenderingCanvas())return!1;let e;for(const t of this.views){if(!t.enabled)continue;if(t.target!==this.inputElement){if(!this._renderViewStep(t))return!1}else e=t}return!(e&&!this._renderViewStep(e))&&(this.activeView=null,!0)};i(41843);$.$.prototype._debugPushGroup=function(e,t){},$.$.prototype._debugPopGroup=function(e){},$.$.prototype._debugInsertMarker=function(e,t){},$.$.prototype._debugFlushPendingCommands=function(){};class Fo{constructor(){this._timeElapsedQueryEnded=!1}}Pr.ThinEngine.prototype.createQuery=function(){const e=this._gl.createQuery();if(!e)throw new Error("Unable to create Occlusion Query");return e},Pr.ThinEngine.prototype.deleteQuery=function(e){return this._gl.deleteQuery(e),this},Pr.ThinEngine.prototype.isQueryResultAvailable=function(e){return this._gl.getQueryParameter(e,this._gl.QUERY_RESULT_AVAILABLE)},Pr.ThinEngine.prototype.getQueryResult=function(e){return this._gl.getQueryParameter(e,this._gl.QUERY_RESULT)},Pr.ThinEngine.prototype.beginOcclusionQuery=function(e,t){const i=this._getGlAlgorithmType(e);return this._gl.beginQuery(i,t),!0},Pr.ThinEngine.prototype.endOcclusionQuery=function(e){const t=this._getGlAlgorithmType(e);return this._gl.endQuery(t),this},Pr.ThinEngine.prototype._createTimeQuery=function(){const e=this.getCaps().timerQuery;return e.createQueryEXT?e.createQueryEXT():this.createQuery()},Pr.ThinEngine.prototype._deleteTimeQuery=function(e){const t=this.getCaps().timerQuery;t.deleteQueryEXT?t.deleteQueryEXT(e):this.deleteQuery(e)},Pr.ThinEngine.prototype._getTimeQueryResult=function(e){const t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(e,t.QUERY_RESULT_EXT):this.getQueryResult(e)},Pr.ThinEngine.prototype._getTimeQueryAvailability=function(e){const t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(e,t.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(e)},Pr.ThinEngine.prototype.startTimeQuery=function(){const e=this.getCaps(),t=e.timerQuery;if(!t)return null;const i=new Fo;if(this._gl.getParameter(t.GPU_DISJOINT_EXT),e.canUseTimestampForTimerQuery)i._startTimeQuery=this._createTimeQuery(),i._startTimeQuery&&t.queryCounterEXT(i._startTimeQuery,t.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;i._timeElapsedQuery=this._createTimeQuery(),i._timeElapsedQuery&&(t.beginQueryEXT?t.beginQueryEXT(t.TIME_ELAPSED_EXT,i._timeElapsedQuery):this._gl.beginQuery(t.TIME_ELAPSED_EXT,i._timeElapsedQuery)),this._currentNonTimestampToken=i}return i},Pr.ThinEngine.prototype.endTimeQuery=function(e){const t=this.getCaps(),i=t.timerQuery;if(!i||!e)return-1;if(t.canUseTimestampForTimerQuery){if(!e._startTimeQuery)return-1;e._endTimeQuery||(e._endTimeQuery=this._createTimeQuery(),e._endTimeQuery&&i.queryCounterEXT(e._endTimeQuery,i.TIMESTAMP_EXT))}else if(!e._timeElapsedQueryEnded){if(!e._timeElapsedQuery)return-1;i.endQueryEXT?i.endQueryEXT(i.TIME_ELAPSED_EXT):(this._gl.endQuery(i.TIME_ELAPSED_EXT),this._currentNonTimestampToken=null),e._timeElapsedQueryEnded=!0}const r=this._gl.getParameter(i.GPU_DISJOINT_EXT);let s=!1;if(e._endTimeQuery?s=this._getTimeQueryAvailability(e._endTimeQuery):e._timeElapsedQuery&&(s=this._getTimeQueryAvailability(e._timeElapsedQuery)),s&&!r){let i=0;if(t.canUseTimestampForTimerQuery){if(!e._startTimeQuery||!e._endTimeQuery)return-1;const t=this._getTimeQueryResult(e._startTimeQuery);i=this._getTimeQueryResult(e._endTimeQuery)-t,this._deleteTimeQuery(e._startTimeQuery),this._deleteTimeQuery(e._endTimeQuery),e._startTimeQuery=null,e._endTimeQuery=null}else{if(!e._timeElapsedQuery)return-1;i=this._getTimeQueryResult(e._timeElapsedQuery),this._deleteTimeQuery(e._timeElapsedQuery),e._timeElapsedQuery=null,e._timeElapsedQueryEnded=!1}return i}return-1},Pr.ThinEngine.prototype.captureGPUFrameTime=function(e){if(e!==this._captureGPUFrameTime)if(this._captureGPUFrameTime=e,e){const e=this.getGPUFrameTimeCounter();this._onBeginFrameObserver=this.onBeginFrameObservable.add((()=>{this._gpuFrameTimeToken||(this._gpuFrameTimeToken=this.startTimeQuery())})),this._onEndFrameObserver=this.onEndFrameObservable.add((()=>{if(!this._gpuFrameTimeToken)return;const t=this.endTimeQuery(this._gpuFrameTimeToken);t>-1&&(this._gpuFrameTimeToken=null,e.fetchNewFrame(),e.addCount(t,!0))}))}else this.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null},Pr.ThinEngine.prototype._getGlAlgorithmType=function(e){return e===Ps.u.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED};var Bo=!0;Vi.Engine.prototype.createTransformFeedback=function(){const e=this._gl.createTransformFeedback();if(!e)throw new Error("Unable to create Transform Feedback");return e},Vi.Engine.prototype.deleteTransformFeedback=function(e){this._gl.deleteTransformFeedback(e)},Vi.Engine.prototype.bindTransformFeedback=function(e){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,e)},Vi.Engine.prototype.beginTransformFeedback=function(e=!0){this._gl.beginTransformFeedback(e?this._gl.POINTS:this._gl.TRIANGLES)},Vi.Engine.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()},Vi.Engine.prototype.setTranformFeedbackVaryings=function(e,t){this._gl.transformFeedbackVaryings(e,t,this._gl.INTERLEAVED_ATTRIBS)},Vi.Engine.prototype.bindTransformFeedbackBuffer=function(e){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,e?e.underlyingResource:null)},Vi.Engine.prototype.readTransformFeedbackBuffer=function(e){this._gl.getBufferSubData(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,e)};i(52426);Pr.ThinEngine.prototype.updateVideoTexture=function(e,t,i){if(!e||e._isDisabled)return;const r=this._getInternalFormat(e.format),s=this._getRGBABufferInternalSizedFormat(0,e.format),n=this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0);this._unpackFlipY(!i);try{if(void 0===this._videoTextureSupported&&(this._gl.getError(),this._gl.texImage2D(this._gl.TEXTURE_2D,0,s,r,this._gl.UNSIGNED_BYTE,t),0!==this._gl.getError()?this._videoTextureSupported=!1:this._videoTextureSupported=!0),this._videoTextureSupported)this._gl.texImage2D(this._gl.TEXTURE_2D,0,s,r,this._gl.UNSIGNED_BYTE,t);else{if(!e._workingCanvas){e._workingCanvas=this.createCanvas(e.width,e.height);const t=e._workingCanvas.getContext("2d");if(!t)throw new Error("Unable to get 2d context");e._workingContext=t,e._workingCanvas.width=e.width,e._workingCanvas.height=e.height}e._workingContext.clearRect(0,0,e.width,e.height),e._workingContext.drawImage(t,0,0,t.videoWidth,t.videoHeight,0,0,e.width,e.height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,s,r,this._gl.UNSIGNED_BYTE,e._workingCanvas)}e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),n||this._bindTextureDirectly(this._gl.TEXTURE_2D,null),e.isReady=!0}catch(t){e._isDisabled=!0}},Pr.ThinEngine.prototype.restoreSingleAttachment=function(){const e=this._gl;this.bindAttachments([e.BACK])},Pr.ThinEngine.prototype.restoreSingleAttachmentForRenderTarget=function(){const e=this._gl;this.bindAttachments([e.COLOR_ATTACHMENT0])},Pr.ThinEngine.prototype.buildTextureLayout=function(e){const t=this._gl,i=[];for(let r=0;r<e.length;r++)e[r]?i.push(t["COLOR_ATTACHMENT"+r]):i.push(t.NONE);return i},Pr.ThinEngine.prototype.bindAttachments=function(e){this._gl.drawBuffers(e)},Pr.ThinEngine.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t=!1,i){this._currentRenderTarget=null,e.disableAutomaticMSAAResolve||this.resolveMultiFramebuffer(e),t||this.generateMipMapsMultiFramebuffer(e),i&&(e._MSAAFramebuffer&&this._bindUnboundFramebuffer(e._framebuffer),i()),this._bindUnboundFramebuffer(null)},Pr.ThinEngine.prototype.createMultipleRenderTarget=function(e,t,i=!0){let r,s=!1,n=!0,o=!1,a=!1,l=1,h=1;let c=[],u=[],d=[],p=[],f=[],_=[],g=[],x=[],v=[],S=!1;const b=this._createHardwareRenderTargetWrapper(!0,!1,e);void 0!==t&&(s=void 0!==t.generateMipMaps&&t.generateMipMaps,n=void 0===t.generateDepthBuffer||t.generateDepthBuffer,o=void 0!==t.generateStencilBuffer&&t.generateStencilBuffer,a=void 0!==t.generateDepthTexture&&t.generateDepthTexture,l=t.textureCount??1,h=t.samples??h,c=t.types||c,u=t.samplingModes||u,d=t.useSRGBBuffers||d,p=t.formats||p,f=t.targetTypes||f,_=t.faceIndex||_,g=t.layerIndex||g,x=t.layerCounts||x,v=t.labels||v,S=t.dontCreateTextures??!1,this.webGLVersion>1&&(13===t.depthTextureFormat||17===t.depthTextureFormat||16===t.depthTextureFormat||14===t.depthTextureFormat||18===t.depthTextureFormat)&&(r=t.depthTextureFormat)),void 0===r&&(r=o?13:14);const y=this._gl,P=this._currentFramebuffer,T=y.createFramebuffer();this._bindUnboundFramebuffer(T);const C=e.width??e,E=e.height??e,A=[],I=[],R=this.webGLVersion>1&&(13===r||17===r||18===r);b.label=t?.label??"MultiRenderTargetWrapper",b._framebuffer=T,b._generateDepthBuffer=a||n,b._generateStencilBuffer=a?R:o,b._depthStencilBuffer=this._setupFramebufferDepthAttachments(b._generateStencilBuffer,b._generateDepthBuffer,C,E,1,r),b._attachments=I;for(let e=0;e<l;e++){let t=u[e]||3,i=c[e]||0,r=d[e]||false;const n=p[e]||5,o=f[e]||3553,a=x[e]??1;(1!==i||this._caps.textureFloatLinearFiltering)&&(2!==i||this._caps.textureHalfFloatLinearFiltering)||(t=1);const l=this._getSamplingParameters(t,s);1!==i||this._caps.textureFloat||(i=0,m.V.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),r=r&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);const h=this.webGLVersion>1,_=y[h?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"];if(I.push(_),-1===o||S)continue;const g=new lr.h(this,6);A[e]=g,y.activeTexture(y["TEXTURE"+e]),y.bindTexture(o,g._hardwareTexture.underlyingResource),y.texParameteri(o,y.TEXTURE_MAG_FILTER,l.mag),y.texParameteri(o,y.TEXTURE_MIN_FILTER,l.min),y.texParameteri(o,y.TEXTURE_WRAP_S,y.CLAMP_TO_EDGE),y.texParameteri(o,y.TEXTURE_WRAP_T,y.CLAMP_TO_EDGE);const P=this._getRGBABufferInternalSizedFormat(i,n,r),T=this._getInternalFormat(n),R=this._getWebGLTextureType(i);if(!h||35866!==o&&32879!==o)if(34067===o){for(let e=0;e<6;e++)y.texImage2D(y.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,P,C,E,0,T,R,null);g.isCube=!0}else y.texImage2D(y.TEXTURE_2D,0,P,C,E,0,T,R,null);else 35866===o?g.is2DArray=!0:g.is3D=!0,g.baseDepth=g.depth=a,y.texImage3D(o,0,P,C,E,a,0,T,R,null);s&&y.generateMipmap(o),this._bindTextureDirectly(o,null),g.baseWidth=C,g.baseHeight=E,g.width=C,g.height=E,g.isReady=!0,g.samples=1,g.generateMipMaps=s,g.samplingMode=t,g.type=i,g._useSRGBBuffer=r,g.format=n,g.label=v[e]??b.label+"-Texture"+e,this._internalTexturesCache.push(g)}if(a&&this._caps.depthTextureExtension&&!S){const e=new lr.h(this,14);let t=5,i=y.DEPTH_COMPONENT16,n=y.DEPTH_COMPONENT,o=y.UNSIGNED_SHORT,a=y.DEPTH_ATTACHMENT;this.webGLVersion<2?i=y.DEPTH_COMPONENT:14===r?(t=1,o=y.FLOAT,i=y.DEPTH_COMPONENT32F):18===r?(t=0,o=y.FLOAT_32_UNSIGNED_INT_24_8_REV,i=y.DEPTH32F_STENCIL8,n=y.DEPTH_STENCIL,a=y.DEPTH_STENCIL_ATTACHMENT):16===r?(t=0,o=y.UNSIGNED_INT,i=y.DEPTH_COMPONENT24,a=y.DEPTH_ATTACHMENT):13!==r&&17!==r||(t=12,o=y.UNSIGNED_INT_24_8,i=y.DEPTH24_STENCIL8,n=y.DEPTH_STENCIL,a=y.DEPTH_STENCIL_ATTACHMENT),this._bindTextureDirectly(y.TEXTURE_2D,e,!0),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,y.NEAREST),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,y.NEAREST),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,y.CLAMP_TO_EDGE),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,y.CLAMP_TO_EDGE),y.texImage2D(y.TEXTURE_2D,0,i,C,E,0,n,o,null),y.framebufferTexture2D(y.FRAMEBUFFER,a,y.TEXTURE_2D,e._hardwareTexture.underlyingResource,0),this._bindTextureDirectly(y.TEXTURE_2D,null),b._depthStencilTexture=e,b._depthStencilTextureWithStencil=R,e.baseWidth=C,e.baseHeight=E,e.width=C,e.height=E,e.isReady=!0,e.samples=1,e.generateMipMaps=s,e.samplingMode=1,e.format=r,e.type=t,e.label=b.label+"-DepthStencil",A[l]=e,this._internalTexturesCache.push(e)}if(b.setTextures(A),i&&y.drawBuffers(I),this._bindUnboundFramebuffer(P),b.setLayerAndFaceIndices(g,_),this.resetTextureCache(),S){if(h>1){const e=y.createFramebuffer();if(!e)throw new Error("Unable to create multi sampled framebuffer");b._samples=h,b._MSAAFramebuffer=e,l>0&&i&&(this._bindUnboundFramebuffer(e),y.drawBuffers(I),this._bindUnboundFramebuffer(P))}}else this.updateMultipleRenderTargetTextureSampleCount(b,h,i);return b},Pr.ThinEngine.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t,i=!0){if(this.webGLVersion<2||!e)return 1;if(e.samples===t)return t;const r=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples),e._depthStencilBuffer&&(r.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(r.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null);const s=e._attachments.length;for(let t=0;t<s;t++){const i=e.textures[t]._hardwareTexture;i?.releaseMSAARenderBuffers()}if(t>1&&"function"==typeof r.renderbufferStorageMultisample){const n=r.createFramebuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");e._MSAAFramebuffer=n,this._bindUnboundFramebuffer(n);const o=[];for(let i=0;i<s;i++){const s=e.textures[i],n=s._hardwareTexture,a=r[this.webGLVersion>1?"COLOR_ATTACHMENT"+i:"COLOR_ATTACHMENT"+i+"_WEBGL"],l=this._createRenderBuffer(s.width,s.height,t,-1,this._getRGBABufferInternalSizedFormat(s.type,s.format,s._useSRGBBuffer),a);if(!l)throw new Error("Unable to create multi sampled framebuffer");n.addMSAARenderBuffer(l),s.samples=t,o.push(a)}i&&r.drawBuffers(o)}else this._bindUnboundFramebuffer(e._framebuffer);const n=e._depthStencilTexture?e._depthStencilTexture.format:void 0;return e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.width,e.height,t,n),this._bindUnboundFramebuffer(null),e._samples=t,t},Pr.ThinEngine.prototype.generateMipMapsMultiFramebuffer=function(e){const t=e,i=this._gl;if(t.isMulti)for(let e=0;e<t._attachments.length;e++){const r=t.textures[e];!r?.generateMipMaps||r?.isCube||r?.is3D||(this._bindTextureDirectly(i.TEXTURE_2D,r,!0),i.generateMipmap(i.TEXTURE_2D),this._bindTextureDirectly(i.TEXTURE_2D,null))}},Pr.ThinEngine.prototype.resolveMultiFramebuffer=function(e){const t=e,i=this._gl;if(!t._MSAAFramebuffer||!t.isMulti)return;let r=t.resolveMSAAColors?i.COLOR_BUFFER_BIT:0;r|=t._generateDepthBuffer&&t.resolveMSAADepth?i.DEPTH_BUFFER_BIT:0,r|=t._generateStencilBuffer&&t.resolveMSAAStencil?i.STENCIL_BUFFER_BIT:0;const s=t._attachments,n=s.length;i.bindFramebuffer(i.READ_FRAMEBUFFER,t._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._framebuffer);for(let e=0;e<n;e++){const o=t.textures[e];for(let e=0;e<n;e++)s[e]=i.NONE;s[e]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"],i.readBuffer(s[e]),i.drawBuffers(s),i.blitFramebuffer(0,0,o.width,o.height,0,0,o.width,o.height,r,i.NEAREST)}for(let e=0;e<n;e++)s[e]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"];i.drawBuffers(s),i.bindFramebuffer(this._gl.FRAMEBUFFER,t._MSAAFramebuffer)};i(83155),i(51881),i(44176),i(79779),i(15183),i(36317),i(86556);var Vo,Lo=i(52212);function ko(e){if(this._excludedCompressedTextures&&this._excludedCompressedTextures.some((t=>{const i="\\b"+t+"\\b";return e&&(e===t||e.match(new RegExp(i,"g")))})))return e;const t=e.lastIndexOf("."),i=e.lastIndexOf("?"),r=i>-1?e.substring(i,e.length):"";return(t>-1?e.substring(0,t):e)+this._textureFormatInUse+r}!function(e){e[e.Texture=0]="Texture",e[e.StorageTexture=1]="StorageTexture",e[e.UniformBuffer=2]="UniformBuffer",e[e.StorageBuffer=3]="StorageBuffer",e[e.TextureWithoutSampler=4]="TextureWithoutSampler",e[e.Sampler=5]="Sampler",e[e.ExternalTexture=6]="ExternalTexture",e[e.DataBuffer=7]="DataBuffer"}(Vo||(Vo={})),Pr.ThinEngine.prototype.createComputeEffect=function(e,t){throw new Error("createComputeEffect: This engine does not support compute shaders!")},Pr.ThinEngine.prototype.createComputePipelineContext=function(){throw new Error("createComputePipelineContext: This engine does not support compute shaders!")},Pr.ThinEngine.prototype.createComputeContext=function(){},Pr.ThinEngine.prototype.computeDispatch=function(e,t,i,r,s,n,o){throw new Error("computeDispatch: This engine does not support compute shaders!")},Pr.ThinEngine.prototype.computeDispatchIndirect=function(e,t,i,r,s,n){throw new Error("computeDispatchIndirect: This engine does not support compute shaders!")},Pr.ThinEngine.prototype.areAllComputeEffectsReady=function(){return!0},Pr.ThinEngine.prototype.releaseComputeEffects=function(){},Pr.ThinEngine.prototype._prepareComputePipelineContext=function(e,t,i,r,s){},Pr.ThinEngine.prototype._rebuildComputeEffects=function(){},$.$.prototype._executeWhenComputeStateIsCompiled=function(e,t){t(null)},Pr.ThinEngine.prototype._releaseComputeEffect=function(e){},Pr.ThinEngine.prototype._deleteComputePipelineContext=function(e){},Object.defineProperty(Vi.Engine.prototype,"texturesSupported",{get:function(){const e=[];return this._caps.astc&&e.push("-astc.ktx"),this._caps.s3tc&&e.push("-dxt.ktx"),this._caps.pvrtc&&e.push("-pvrtc.ktx"),this._caps.etc2&&e.push("-etc2.ktx"),this._caps.etc1&&e.push("-etc1.ktx"),e},enumerable:!0,configurable:!0}),Object.defineProperty(Vi.Engine.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse||null},enumerable:!0,configurable:!0}),Vi.Engine.prototype.setCompressedTextureExclusions=function(e){this._excludedCompressedTextures=e},Vi.Engine.prototype.setTextureFormatToUse=function(e){const t=this.texturesSupported;for(let i=0,r=t.length;i<r;i++)for(let r=0,s=e.length;r<s;r++)if(t[i]===e[r].toLowerCase())return this._transformTextureUrl=ko.bind(this),this._textureFormatInUse=t[i];return this._textureFormatInUse="",this._transformTextureUrl=null,null};class Go{constructor(){const e=new ArrayBuffer(Go.DEFAULT_BUFFER_SIZE);this._uint32s=new Uint32Array(e),this._int32s=new Int32Array(e),this._float32s=new Float32Array(e),this._length=Go.DEFAULT_BUFFER_SIZE/4,this._position=0,this._nativeDataStream=new _native.NativeDataStream((()=>{this._flush()}))}writeUint32(e){this._flushIfNecessary(1),this._uint32s[this._position++]=e}writeInt32(e){this._flushIfNecessary(1),this._int32s[this._position++]=e}writeFloat32(e){this._flushIfNecessary(1),this._float32s[this._position++]=e}writeUint32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._uint32s.set(e,this._position),this._position+=e.length}writeInt32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._int32s.set(e,this._position),this._position+=e.length}writeFloat32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._float32s.set(e,this._position),this._position+=e.length}writeNativeData(e){this._flushIfNecessary(e.length),this._uint32s.set(e,this._position),this._position+=e.length}writeBoolean(e){this.writeUint32(e?1:0)}_flushIfNecessary(e){this._position+e>this._length&&this._flush()}_flush(){this._nativeDataStream.writeBuffer(this._uint32s.buffer,this._position),this._position=0}}Go.DEFAULT_BUFFER_SIZE=65536;var zo=i(55234),Uo=i(56617),Wo=i(65394);const Ho=/(flat\s)?\s*varying\s*.*/;class $o{constructor(){this.shaderLanguage=0}initializeShaders(e){this._nativeProcessingContext=e,this._nativeProcessingContext&&(this._nativeProcessingContext.remappedAttributeNames={},this._nativeProcessingContext.injectInVertexMain="")}attributeProcessor(e){if(!this._nativeProcessingContext)return e.replace("attribute","in");const t=/\s*(?:attribute|in)\s+(\S+)\s+(\S+)\s*;/gm.exec(e);if(null!==t){const i=t[1],r=t[2],s=this._nativeProcessingContext.vertexBufferKindToNumberOfComponents[r];if(void 0!==s){const n=s<0?-1===s?"int":"ivec"+-s:1===s?"uint":"uvec"+s,o=`_int_${r}_`;e=e.replace(t[0],`in ${n} ${o}; ${i} ${r};`),this._nativeProcessingContext.injectInVertexMain+=`${r} = ${i}(${o});\n`,this._nativeProcessingContext.remappedAttributeNames[r]=o}else e=e.replace(t[0],`in ${i} ${r};`)}return e}varyingCheck(e,t){return Ho.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){const r=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i){const t=-1!==e.search(/layout *\(location *= *0\) *out/g);e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(r||t?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(")}else{this._nativeProcessingContext?.injectInVertexMain&&(e=(0,Wo.bI)(e,"void main",this._nativeProcessingContext.injectInVertexMain));if(-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e}return e}}class qo{get isReady(){if(this.compilationError){const e=this.compilationError.message;throw new Error("SHADER ERROR"+("string"==typeof e?"\n"+e:""))}return this.isCompiled}_getVertexShaderCode(){return null}_getFragmentShaderCode(){return null}constructor(e,t,i){this.isCompiled=!1,this.vertexBufferKindToType={},this._valueCache={},this._engine=e,this.isAsync=t,this.shaderProcessingContext=i}_fillEffectInformation(e,t,i,r,s,n,o,a){const l=this._engine;if(l.supportsUniformBuffers)for(const i in t)e.bindUniformBlock(i,t[i]);let h;for(this._engine.getUniforms(this,i).forEach(((e,t)=>{r[i[t]]=e})),this._uniforms=r,h=0;h<s.length;h++){null==e.getUniform(s[h])&&(s.splice(h,1),h--)}s.forEach(((e,t)=>{n[e]=t})),a.push(...l.getAttributes(this,o))}setEngine(e){this._engine=e}dispose(){this._uniforms={}}_cacheMatrix(e,t){const i=this._valueCache[e],r=t.updateFlag;return(void 0===i||i!==r)&&(this._valueCache[e]=r,!0)}_cacheFloat2(e,t,i){let r=this._valueCache[e];if(!r)return r=[t,i],this._valueCache[e]=r,!0;let s=!1;return r[0]!==t&&(r[0]=t,s=!0),r[1]!==i&&(r[1]=i,s=!0),s}_cacheFloat3(e,t,i,r){let s=this._valueCache[e];if(!s)return s=[t,i,r],this._valueCache[e]=s,!0;let n=!1;return s[0]!==t&&(s[0]=t,n=!0),s[1]!==i&&(s[1]=i,n=!0),s[2]!==r&&(s[2]=r,n=!0),n}_cacheFloat4(e,t,i,r,s){let n=this._valueCache[e];if(!n)return n=[t,i,r,s],this._valueCache[e]=n,!0;let o=!1;return n[0]!==t&&(n[0]=t,o=!0),n[1]!==i&&(n[1]=i,o=!0),n[2]!==r&&(n[2]=r,o=!0),n[3]!==s&&(n[3]=s,o=!0),o}setInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setInt4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this._engine.setInt4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this._engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this._engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this._engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this._engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setUInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setUInt4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this._engine.setUInt4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this._engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this._engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this._engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this._engine.setUIntArray4(this._uniforms[e],t)}setFloatArray(e,t){this._valueCache[e]=null,this._engine.setFloatArray(this._uniforms[e],t)}setFloatArray2(e,t){this._valueCache[e]=null,this._engine.setFloatArray2(this._uniforms[e],t)}setFloatArray3(e,t){this._valueCache[e]=null,this._engine.setFloatArray3(this._uniforms[e],t)}setFloatArray4(e,t){this._valueCache[e]=null,this._engine.setFloatArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this._engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this._engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this._engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this._engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this._engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this._engine.setMatrices(this._uniforms[e],t.asArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this._engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this._engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setBool(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setInt(this._uniforms[e],t?1:0)&&(this._valueCache[e]=t?1:0)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this._engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this._engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setFloat3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this._engine.setFloat4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this._engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}}class Yo extends Eo.v{get _framebuffer(){return this.__framebuffer}set _framebuffer(e){this.__framebuffer&&this._engine._releaseFramebufferObjects(this.__framebuffer),this.__framebuffer=e}get _framebufferDepthStencil(){return this.__framebufferDepthStencil}set _framebufferDepthStencil(e){this.__framebufferDepthStencil&&this._engine._releaseFramebufferObjects(this.__framebufferDepthStencil),this.__framebufferDepthStencil=e}constructor(e,t,i,r){super(e,t,i,r),this.__framebuffer=null,this.__framebufferDepthStencil=null,this._engine=r}dispose(e=!1){this._framebuffer=null,this._framebufferDepthStencil=null,super.dispose(e)}}class Xo{get underlyingResource(){return this._nativeTexture}constructor(e,t){this._engine=t,this.set(e)}setUsage(){}set(e){this._nativeTexture=e}reset(){this._nativeTexture=null}release(){this._nativeTexture&&this._engine.deleteTexture(this._nativeTexture),this.reset()}}var jo=i(88563);function Zo(e,t){switch(e){case 15:return _native.Engine.TEXTURE_FORMAT_D16;case 16:return _native.Engine.TEXTURE_FORMAT_D24;case 13:return _native.Engine.TEXTURE_FORMAT_D24S8;case 14:return _native.Engine.TEXTURE_FORMAT_D32F;case 36492:return _native.Engine.TEXTURE_FORMAT_BC7;case 36494:return _native.Engine.TEXTURE_FORMAT_BC6H;case 33779:return _native.Engine.TEXTURE_FORMAT_BC3;case 33778:return _native.Engine.TEXTURE_FORMAT_BC2;case 33777:case 33776:return _native.Engine.TEXTURE_FORMAT_BC1;case 37808:return _native.Engine.TEXTURE_FORMAT_ASTC4x4;case 36196:return _native.Engine.TEXTURE_FORMAT_ETC1;case 37492:return _native.Engine.TEXTURE_FORMAT_ETC2;case 37496:return _native.Engine.TEXTURE_FORMAT_ETC2A;case 4:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_RGB8;case 3:return _native.Engine.TEXTURE_FORMAT_RGB8S;case 6:return _native.Engine.TEXTURE_FORMAT_RGB8I;case 7:return _native.Engine.TEXTURE_FORMAT_RGB8U}break;case 5:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_RGBA8;case 1:return _native.Engine.TEXTURE_FORMAT_RGBA32F;case 2:return _native.Engine.TEXTURE_FORMAT_RGBA16F;case 3:return _native.Engine.TEXTURE_FORMAT_RGBA8S;case 4:return _native.Engine.TEXTURE_FORMAT_RGBA16I;case 5:return _native.Engine.TEXTURE_FORMAT_RGBA16U;case 6:return _native.Engine.TEXTURE_FORMAT_RGBA32I;case 7:return _native.Engine.TEXTURE_FORMAT_RGBA32U}break;case 6:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_R8;case 1:return _native.Engine.TEXTURE_FORMAT_R32F;case 2:return _native.Engine.TEXTURE_FORMAT_R16F;case 3:return _native.Engine.TEXTURE_FORMAT_R8S;case 4:return _native.Engine.TEXTURE_FORMAT_R16S;case 5:return _native.Engine.TEXTURE_FORMAT_R16U;case 6:return _native.Engine.TEXTURE_FORMAT_R32I;case 7:return _native.Engine.TEXTURE_FORMAT_R32U}break;case 7:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_RG8;case 1:return _native.Engine.TEXTURE_FORMAT_RG32F;case 2:return _native.Engine.TEXTURE_FORMAT_RG16F;case 3:return _native.Engine.TEXTURE_FORMAT_RG8S;case 4:return _native.Engine.TEXTURE_FORMAT_RG16S;case 5:return _native.Engine.TEXTURE_FORMAT_RG16U;case 6:return _native.Engine.TEXTURE_FORMAT_RG32I;case 7:return _native.Engine.TEXTURE_FORMAT_RG32U}break;case 12:if(0===t)return _native.Engine.TEXTURE_FORMAT_BGRA8}throw new jo.bu(`Unsupported texture format or type: format ${e}, type ${t}.`,jo.tG.UnsupportedTextureError)}function Qo(e){switch(e){case 1:return _native.Engine.TEXTURE_NEAREST_NEAREST;case 2:return _native.Engine.TEXTURE_LINEAR_LINEAR;case 3:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPLINEAR;case 4:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPNEAREST;case 5:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPNEAREST;case 6:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPLINEAR;case 7:return _native.Engine.TEXTURE_NEAREST_LINEAR;case 8:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPLINEAR;case 9:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPNEAREST;case 10:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPLINEAR;case 11:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPNEAREST;case 12:return _native.Engine.TEXTURE_LINEAR_NEAREST;default:throw new Error(`Unsupported sampling mode: ${e}.`)}}function Ko(e){switch(e){case 1:return _native.Engine.ADDRESS_MODE_WRAP;case 0:return _native.Engine.ADDRESS_MODE_CLAMP;case 2:return _native.Engine.ADDRESS_MODE_MIRROR;default:throw new Error("Unexpected wrap mode: "+e+".")}}function Jo(e){switch(e){case Ot.R.BYTE:return _native.Engine.ATTRIB_TYPE_INT8;case Ot.R.UNSIGNED_BYTE:return _native.Engine.ATTRIB_TYPE_UINT8;case Ot.R.SHORT:return _native.Engine.ATTRIB_TYPE_INT16;case Ot.R.UNSIGNED_SHORT:return _native.Engine.ATTRIB_TYPE_UINT16;case Ot.R.FLOAT:return _native.Engine.ATTRIB_TYPE_FLOAT;default:throw new Error(`Unsupported attribute type: ${e}.`)}}var ea=i(85102);class ta{constructor(){this.vertexBufferKindToNumberOfComponents={},this.remappedAttributeNames={},this.injectInVertexMain=""}}var ia=i(18454);const ra=new s.cP;if("undefined"!=typeof self&&!Object.prototype.hasOwnProperty.call(self,"_native")){let e;Object.defineProperty(self,"_native",{get:()=>e,set:t=>{e=t,e&&ra.notifyObservers(e)}})}function sa(){return new Promise((e=>{"undefined"==typeof _native?ra.addOnce((t=>e(t))):e(_native)}))}async function na(e,t){(await sa())[e]=t}class oa extends wt.n{}class aa{constructor(e){this._engine=e,this._pending=new Array,this._isCommandBufferScopeActive=!1,this._commandStream=ha._createNativeDataStream(),this._engine.setCommandDataStream(this._commandStream)}beginCommandScope(){if(this._isCommandBufferScopeActive)throw new Error("Command scope already active.");this._isCommandBufferScopeActive=!0}endCommandScope(){if(!this._isCommandBufferScopeActive)throw new Error("Command scope is not active.");this._isCommandBufferScopeActive=!1,this._submit()}startEncodingCommand(e){this._commandStream.writeNativeData(e)}encodeCommandArgAsUInt32(e){this._commandStream.writeUint32(e)}encodeCommandArgAsUInt32s(e){this._commandStream.writeUint32Array(e)}encodeCommandArgAsInt32(e){this._commandStream.writeInt32(e)}encodeCommandArgAsInt32s(e){this._commandStream.writeInt32Array(e)}encodeCommandArgAsFloat32(e){this._commandStream.writeFloat32(e)}encodeCommandArgAsFloat32s(e){this._commandStream.writeFloat32Array(e)}encodeCommandArgAsNativeData(e){this._commandStream.writeNativeData(e),this._pending.push(e)}finishEncodingCommand(){this._isCommandBufferScopeActive||this._submit()}_submit(){this._engine.submitCommands(),this._pending.length=0}}const la=[];class ha extends Vi.Engine{setHardwareScalingLevel(e){super.setHardwareScalingLevel(e),this._engine.setHardwareScalingLevel(e)}constructor(e={}){if(super(null,!1,void 0,e.adaptToDeviceRatio),this._engine=new _native.Engine({version:Vi.Engine.Version,nonFloatVertexBuffers:!0}),this._camera=_native.Camera?new _native.Camera:null,this._commandBufferEncoder=new aa(this._engine),this._frameStats={gpuTimeNs:Number.NaN},this._boundBuffersVertexArray=null,this._currentDepthTest=_native.Engine.DEPTH_TEST_LEQUAL,this._stencilTest=!1,this._stencilMask=255,this._stencilFunc=519,this._stencilFuncRef=0,this._stencilFuncMask=255,this._stencilOpStencilFail=7680,this._stencilOpDepthFail=7680,this._stencilOpStencilDepthPass=7681,this._zOffset=0,this._zOffsetUnits=0,this._depthWrite=!0,this._fillModeWarningDisplayed=!1,_native.Engine.PROTOCOL_VERSION!==ha.PROTOCOL_VERSION)throw new Error(`Protocol version mismatch: ${_native.Engine.PROTOCOL_VERSION} (Native) !== ${ha.PROTOCOL_VERSION} (JS)`);this._engine.setDeviceLostCallback&&this._engine.setDeviceLostCallback((()=>{this.onContextLostObservable.notifyObservers(this),this._contextWasLost=!0,this._restoreEngineAfterContextLost()})),this._webGLVersion=2,this.disableUniformBuffers=!0,this._shaderPlatformName="NATIVE",this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_SIZE,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxDrawBuffers:8,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!0,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,textureFloat:!0,textureFloatLinearFiltering:!0,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,texelFetch:!1,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!0,instancedArrays:!0,supportOcclusionQuery:!1,canUseTimestampForTimerQuery:!1,blendMinMax:!1,maxMSAASamples:16,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!1,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!1,texture2DArrayMaxLayerCount:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_LAYERS,disableMorphTargetTexture:!1,parallelShaderCompile:{COMPLETION_STATUS_KHR:0},textureNorm16:!1},this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!0,supportSSAO2:!1,supportIBLShadows:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!0,supportSpriteInstancing:!1,forceVertexBufferStrideAndOffsetMultiple4Bytes:!0,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1},H.S0.Log("Babylon Native (v"+Vi.Engine.Version+") launched"),H.S0.LoadScript=function(e,t,i,r){H.S0.LoadFile(e,(e=>{Function(e).apply(null),t&&t()}),void 0,void 0,!1,((e,t)=>{i&&i("LoadScript Error",t)}))},"undefined"==typeof URL&&(window.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),"undefined"==typeof Blob&&(window.Blob=function(e){return e}),Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function e(){const t=isNaN(arguments[0])?1:Number(arguments[0]);return t?Array.prototype.reduce.call(this,(function(i,r){return Array.isArray(r)?i.push.apply(i,e.call(r,t-1)):i.push(r),i}),[]):Array.prototype.slice.call(this)},writable:!0});const t=window&&window.devicePixelRatio||1;this._hardwareScalingLevel=e.adaptToDeviceRatio?1/t:1,this._engine.setHardwareScalingLevel(this._hardwareScalingLevel),this._lastDevicePixelRatio=t,this.resize();const i=this.getDepthFunction();i&&this.setDepthFunction(i),this._shaderProcessor=new $o,this.onNewSceneAddedObservable.add((e=>{const t=e.render;e.render=(...i)=>{this._commandBufferEncoder.beginCommandScope(),t.apply(e,i),this._commandBufferEncoder.endCommandScope()}}))}dispose(){super.dispose(),this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._engine.dispose()}static _createNativeDataStream(){return new Go}_queueNewFrame(e,t){return t.requestAnimationFrame&&t!==window?t.requestAnimationFrame(e):this._engine.requestAnimationFrame(e),0}_restoreEngineAfterContextLost(){this._clearEmptyResources();const e=this._depthCullingState.depthTest,t=this._depthCullingState.depthFunc,i=this._depthCullingState.depthMask,r=this._stencilState.stencilTest;this._rebuildGraphicsResources(),this._depthCullingState.depthTest=e,this._depthCullingState.depthFunc=t,this._depthCullingState.depthMask=i,this._stencilState.stencilTest=r,this._flagContextRestored()}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._currentFramebuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNBINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(this._currentFramebuffer),this._commandBufferEncoder.finishEncodingCommand()),e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()),this._currentFramebuffer=e)}getHostDocument(){return null}clear(e,t,i,r=!1){if(this.useReverseDepthBuffer)throw new Error("reverse depth buffer is not currently implemented");this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_CLEAR),this._commandBufferEncoder.encodeCommandArgAsUInt32(t&&e?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.r:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.g:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.b:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.a:1),this._commandBufferEncoder.encodeCommandArgAsUInt32(i?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(1),this._commandBufferEncoder.encodeCommandArgAsUInt32(r?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(0),this._commandBufferEncoder.finishEncodingCommand()}createIndexBuffer(e,t,i){const r=this._normalizeIndexData(e),s=new oa;return s.references=1,s.is32Bits=4===r.BYTES_PER_ELEMENT,r.byteLength&&(s.nativeIndexBuffer=this._engine.createIndexBuffer(r.buffer,r.byteOffset,r.byteLength,s.is32Bits,t??!1)),s}createVertexBuffer(e,t,i){const r=ArrayBuffer.isView(e)?e:new Float32Array(e),s=new oa;return s.references=1,r.byteLength&&(s.nativeVertexBuffer=this._engine.createVertexBuffer(r.buffer,r.byteOffset,r.byteLength,t??!1)),s}_recordVertexArrayObject(e,t,i,r,s){r._checkedNonFloatVertexBuffers||((0,ea.z)(t,r),r._checkedNonFloatVertexBuffers=!0),i&&this._engine.recordIndexBuffer(e,i.nativeIndexBuffer);const n=r.getAttributesNames();for(let i=0;i<n.length;i++){const o=r.getAttributeLocation(i);if(o>=0){const r=n[i];let a=null;if(s&&(a=s[r]),a||(a=t[r]),a){const t=a.effectiveBuffer;t&&t.nativeVertexBuffer&&this._engine.recordVertexBuffer(e,t.nativeVertexBuffer,o,a.effectiveByteOffset,a.effectiveByteStride,a.getSize(),Jo(a.type),a.normalized,a.getInstanceDivisor())}}}}bindBuffers(e,t,i){this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._boundBuffersVertexArray=this._engine.createVertexArray(),this._recordVertexArrayObject(this._boundBuffersVertexArray,e,t,i),this.bindVertexArrayObject(this._boundBuffersVertexArray)}recordVertexArrayObject(e,t,i,r){const s=this._engine.createVertexArray();return this._recordVertexArrayObject(s,e,t,i,r),s}_deleteVertexArray(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()}bindVertexArrayObject(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()}releaseVertexArrayObject(e){this._deleteVertexArray(e)}getAttributes(e,t){const i=e,r=i.shaderProcessingContext;la.length=0;for(let e=0;e<t.length;e++){const i=t[e],s=r.remappedAttributeNames[i]??i;la[e]=s}return this._engine.getAttributes(i.program,la)}_checkSupportedFillMode(e){return 5!=e&&8!=e||(this._fillModeWarningDisplayed||(m.V.Warn("Line Loop and Triangle Fan are not supported fill modes with Babylon Native. Elements with these fill mode will not be visible."),this._fillModeWarningDisplayed=!0),!1)}drawElementsType(e,t,i,r){this._checkSupportedFillMode(e)&&(this._drawCalls.addCount(1,!1),r&&_native.Engine.COMMAND_DRAWINDEXEDINSTANCED?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXEDINSTANCED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r)):(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i)),this._commandBufferEncoder.finishEncodingCommand())}drawArraysType(e,t,i,r){this._checkSupportedFillMode(e)&&(this._drawCalls.addCount(1,!1),r&&_native.Engine.COMMAND_DRAWINSTANCED?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINSTANCED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r)):(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAW),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i)),this._commandBufferEncoder.finishEncodingCommand())}createPipelineContext(e){const t=!(!this._caps.parallelShaderCompile||!this._engine.createProgramAsync);return new qo(this,t,e)}createMaterialContext(){}createDrawContext(){}_preparePipelineContext(e,t,i,r,s,n,o,a,l,h,c){r?this.createRawShaderProgram():this.createShaderProgram(e,t,i,a),c()}_getShaderProcessingContext(e){return new ta}_executeWhenRenderingStateIsCompiled(e,t){const i=e;if(i.isAsync)if(i.onCompiled){const e=i.onCompiled;i.onCompiled=()=>{e(),t()}}else i.onCompiled=t;else t()}createRawShaderProgram(){throw new Error("Not Supported")}createShaderProgram(e,t,i,r){const s=e;this.onBeforeShaderCompilationObservable.notifyObservers(this);const n=new Uo.Y(t);n.processCode(),t=n.code;const o=new Uo.Y(i);o.processCode(),i=o.code,t=Pr.ThinEngine._ConcatenateShader(t,r),i=Pr.ThinEngine._ConcatenateShader(i,r);const a=()=>{s.isCompiled=!0,s.onCompiled?.(),this.onAfterShaderCompilationObservable.notifyObservers(this)};if(e.isAsync)s.program=this._engine.createProgramAsync(t,i,a,(e=>{s.compilationError=e}));else try{s.program=this._engine.createProgram(t,i),a()}catch(e){const t=e?.message;throw new Error("SHADER ERROR"+("string"==typeof t?"\n"+t:""))}return s.program}inlineShaderCode(e){const t=new Uo.Y(e);return t.debug=!1,t.processCode(),t.code}_setProgram(e){this._currentProgram!==e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand(),this._currentProgram=e)}_deletePipelineContext(e){const t=e;t&&t.program&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(t.program),this._commandBufferEncoder.finishEncodingCommand())}getUniforms(e,t){const i=e;return this._engine.getUniforms(i.program,t)}bindUniformBlock(e,t,i){throw new Error("Not Implemented")}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.program);const i=e.getSamplers();for(let t=0;t<i.length;t++){const r=e.getUniform(i[t]);r&&(this._boundUniforms[t]=r)}this._currentEffect=null}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._engine.getRenderWidth()}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._engine.getRenderHeight()}setViewport(e,t,i){this._cachedViewport=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETVIEWPORT),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.x),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.y),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.width),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.height),this._commandBufferEncoder.finishEncodingCommand()}enableScissor(e,t,i,r){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSCISSOR),this._commandBufferEncoder.encodeCommandArgAsFloat32(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.finishEncodingCommand()}disableScissor(){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSCISSOR),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.finishEncodingCommand()}setStateCullFaceType(e,t){throw new Error("setStateCullFaceType: Not Implemented")}setState(e,t=0,i,r=!1,s,n,o=0){this._zOffset=t,this._zOffsetUnits=o,0!==this._zOffset&&H.S0.Warn("zOffset is not supported in Native engine."),this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTATE),this._commandBufferEncoder.encodeCommandArgAsUInt32(e?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(o),this._commandBufferEncoder.encodeCommandArgAsUInt32(this.cullBackFaces??s??1?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(r?1:0),this._commandBufferEncoder.finishEncodingCommand()}getInputElementClientRect(){return{bottom:this.getRenderHeight(),height:this.getRenderHeight(),left:0,right:this.getRenderWidth(),top:0,width:this.getRenderWidth(),x:0,y:0,toJSON:()=>{}}}setZOffset(e){e!==this._zOffset&&(this._zOffset=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSET),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-e:e),this._commandBufferEncoder.finishEncodingCommand())}getZOffset(){return this._zOffset}setZOffsetUnits(e){e!==this._zOffsetUnits&&(this._zOffsetUnits=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSETUNITS),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-e:e),this._commandBufferEncoder.finishEncodingCommand())}getZOffsetUnits(){return this._zOffsetUnits}setDepthBuffer(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(e?this._currentDepthTest:_native.Engine.DEPTH_TEST_ALWAYS),this._commandBufferEncoder.finishEncodingCommand()}getDepthWrite(){return this._depthWrite}getDepthFunction(){switch(this._currentDepthTest){case _native.Engine.DEPTH_TEST_NEVER:return 512;case _native.Engine.DEPTH_TEST_ALWAYS:return 519;case _native.Engine.DEPTH_TEST_GREATER:return 516;case _native.Engine.DEPTH_TEST_GEQUAL:return 518;case _native.Engine.DEPTH_TEST_NOTEQUAL:return 517;case _native.Engine.DEPTH_TEST_EQUAL:return 514;case _native.Engine.DEPTH_TEST_LESS:return 513;case _native.Engine.DEPTH_TEST_LEQUAL:return 515}return null}setDepthFunction(e){let t=0;switch(e){case 512:t=_native.Engine.DEPTH_TEST_NEVER;break;case 519:t=_native.Engine.DEPTH_TEST_ALWAYS;break;case 516:t=_native.Engine.DEPTH_TEST_GREATER;break;case 518:t=_native.Engine.DEPTH_TEST_GEQUAL;break;case 517:t=_native.Engine.DEPTH_TEST_NOTEQUAL;break;case 514:t=_native.Engine.DEPTH_TEST_EQUAL;break;case 513:t=_native.Engine.DEPTH_TEST_LESS;break;case 515:t=_native.Engine.DEPTH_TEST_LEQUAL}this._currentDepthTest=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(this._currentDepthTest),this._commandBufferEncoder.finishEncodingCommand()}setDepthWrite(e){this._depthWrite=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(e)),this._commandBufferEncoder.finishEncodingCommand()}setColorWrite(e){this._colorWrite=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETCOLORWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(e)),this._commandBufferEncoder.finishEncodingCommand()}getColorWrite(){return this._colorWrite}applyStencil(){this._setStencil(this._stencilMask,function(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_FAIL_S_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_S_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_S_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_S_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_S_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_S_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_S_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_S_DECRSAT;default:throw new Error(`Unsupported stencil OpFail mode: ${e}.`)}}(this._stencilOpStencilFail),function(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_FAIL_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_Z_DECRSAT;default:throw new Error(`Unsupported stencil depthFail mode: ${e}.`)}}(this._stencilOpDepthFail),function(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_PASS_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_PASS_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_PASS_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_PASS_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_PASS_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_PASS_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_PASS_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_PASS_Z_DECRSAT;default:throw new Error(`Unsupported stencil opPass mode: ${e}.`)}}(this._stencilOpStencilDepthPass),function(e){switch(e){case 513:return _native.Engine.STENCIL_TEST_LESS;case 515:return _native.Engine.STENCIL_TEST_LEQUAL;case 514:return _native.Engine.STENCIL_TEST_EQUAL;case 518:return _native.Engine.STENCIL_TEST_GEQUAL;case 516:return _native.Engine.STENCIL_TEST_GREATER;case 517:return _native.Engine.STENCIL_TEST_NOTEQUAL;case 512:return _native.Engine.STENCIL_TEST_NEVER;case 519:return _native.Engine.STENCIL_TEST_ALWAYS;default:throw new Error(`Unsupported stencil func mode: ${e}.`)}}(this._stencilFunc),this._stencilFuncRef)}_setStencil(e,t,i,r,s,n){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTENCIL),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.finishEncodingCommand()}setStencilBuffer(e){this._stencilTest=e,e?this.applyStencil():this._setStencil(255,_native.Engine.STENCIL_OP_FAIL_S_KEEP,_native.Engine.STENCIL_OP_FAIL_Z_KEEP,_native.Engine.STENCIL_OP_PASS_Z_KEEP,_native.Engine.STENCIL_TEST_ALWAYS,0)}getStencilBuffer(){return this._stencilTest}getStencilOperationPass(){return this._stencilOpStencilDepthPass}setStencilOperationPass(e){this._stencilOpStencilDepthPass=e,this.applyStencil()}setStencilMask(e){this._stencilMask=e,this.applyStencil()}setStencilFunction(e){this._stencilFunc=e,this.applyStencil()}setStencilFunctionReference(e){this._stencilFuncRef=e,this.applyStencil()}setStencilFunctionMask(e){this._stencilFuncMask=e}setStencilOperationFail(e){this._stencilOpStencilFail=e,this.applyStencil()}setStencilOperationDepthFail(e){this._stencilOpDepthFail=e,this.applyStencil()}getStencilMask(){return this._stencilMask}getStencilFunction(){return this._stencilFunc}getStencilFunctionReference(){return this._stencilFuncRef}getStencilFunctionMask(){return this._stencilFuncMask}getStencilOperationFail(){return this._stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilOpDepthFail}setAlphaConstants(e,t,i,r){throw new Error("Setting alpha blend constant color not yet implemented.")}setAlphaMode(e,t=!1){if(this._alphaMode===e)return;const i=function(e){switch(e){case 0:return _native.Engine.ALPHA_DISABLE;case 1:return _native.Engine.ALPHA_ADD;case 2:return _native.Engine.ALPHA_COMBINE;case 3:return _native.Engine.ALPHA_SUBTRACT;case 4:return _native.Engine.ALPHA_MULTIPLY;case 5:return _native.Engine.ALPHA_MAXIMIZED;case 6:return _native.Engine.ALPHA_ONEONE;case 7:return _native.Engine.ALPHA_PREMULTIPLIED;case 8:return _native.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;case 9:return _native.Engine.ALPHA_INTERPOLATE;case 10:return _native.Engine.ALPHA_SCREENMODE;default:throw new Error(`Unsupported alpha mode: ${e}.`)}}(e);this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETBLENDMODE),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand(),t||this.setDepthWrite(0===e),this._alphaMode=e}setInt(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINT),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray2(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray3(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray4(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray2(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray3(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray4(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setArray(e,t){return!!e&&this.setFloatArray(e,new Float32Array(t))}setArray2(e,t){return!!e&&this.setFloatArray2(e,new Float32Array(t))}setArray3(e,t){return!!e&&this.setFloatArray3(e,new Float32Array(t))}setArray4(e,t){return!!e&&this.setFloatArray4(e,new Float32Array(t))}setMatrices(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRICES),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setMatrix3x3(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX3X3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setMatrix2x2(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX2X2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat2(e,t,i){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat3(e,t,i,r){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat4(e,t,i,r,s){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.encodeCommandArgAsFloat32(s),this._commandBufferEncoder.finishEncodingCommand(),!0)}setColor3(e,t){return!!e&&(this.setFloat3(e,t.r,t.g,t.b),!0)}setColor4(e,t,i){return!!e&&(this.setFloat4(e,t.r,t.g,t.b,i),!0)}wipeCaches(e){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,e&&(this._currentProgram=null,this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}_createTexture(){return this._engine.createTexture()}_deleteTexture(e){e&&this._engine.deleteTexture(e.underlyingResource)}updateDynamicTexture(e,t,i,r=!1,s){if(void 0===r&&(r=!1),e&&e._hardwareTexture){const i=t.getCanvasTexture(),r=e._hardwareTexture.underlyingResource;this._engine.copyTexture(r,i),e.isReady=!0}}createDynamicTexture(e,t,i,r){return e=Math.max(e,1),t=Math.max(t,1),this.createRawTexture(new Uint8Array(e*t*4),e,t,5,!1,!1,r)}createVideoElement(e){return this._camera?this._camera.createVideo(e):null}updateVideoTexture(e,t,i){if(e&&e._hardwareTexture&&this._camera){const r=e._hardwareTexture.underlyingResource;this._camera.updateVideoTexture(r,t,i)}}createRawTexture(e,t,i,r,s,n,o,a=null,l=0,h=0,c=!1){const u=new lr.h(this,3);if(u.format=r,u.generateMipMaps=s,u.samplingMode=o,u.invertY=n,u.baseWidth=t,u.baseHeight=i,u.width=u.baseWidth,u.height=u.baseHeight,u._compression=a,u.type=l,u._useSRGBBuffer=this._getUseSRGBBuffer(c,!s),this.updateRawTexture(u,e,r,n,a,l,u._useSRGBBuffer),u._hardwareTexture){const e=u._hardwareTexture.underlyingResource,t=Qo(o);this._setTextureSampling(e,t)}return this._internalTexturesCache.push(u),u}createRawTexture2DArray(e,t,i,r,s,n,o,a,l=null,h=0){const c=new lr.h(this,11);if(c.baseWidth=t,c.baseHeight=i,c.baseDepth=r,c.width=t,c.height=i,c.depth=r,c.format=s,c.type=h,c.generateMipMaps=n,c.samplingMode=a,c.is2DArray=!0,c._hardwareTexture){const l=c._hardwareTexture.underlyingResource;this._engine.loadRawTexture2DArray(l,e,t,i,r,Zo(s,h),n,o);const u=Qo(a);this._setTextureSampling(l,u)}return c.isReady=!0,this._internalTexturesCache.push(c),c}updateRawTexture(e,t,i,r,s=null,n=0,o=!1){if(e){if(t&&e._hardwareTexture){const r=e._hardwareTexture.underlyingResource;this._engine.loadRawTexture(r,t,e.width,e.height,Zo(i,n),e.generateMipMaps,e.invertY)}e.isReady=!0}}createTexture(e,t,i,r,s=3,n=null,o=null,a=null,l=null,h=null,c=null,u,d,p,f=!1){const _="data:"===(e=e||"").substring(0,5),g=_&&-1!==e.indexOf(";base64,"),x=l||new lr.h(this,1),v=e;!this._transformTextureUrl||g||l||a||(e=this._transformTextureUrl(e));const S=e.lastIndexOf("."),b=c||(S>-1?e.substring(S).toLowerCase():"");let y=null;(b.endsWith(".basis")||b.endsWith(".ktx")||b.endsWith(".ktx2")||"image/ktx"===u||"image/ktx2"===u)&&(y=(0,ia.gT)(b)),r&&r.addPendingData(x),x.url=e,x.generateMipMaps=!t,x.samplingMode=s,x.invertY=i,x._useSRGBBuffer=this._getUseSRGBBuffer(f,t),this.doNotHandleContextLost||(x._buffer=a);let P=null;n&&!l&&(P=x.onLoadedObservable.add(n)),l||this._internalTexturesCache.push(x);const T=(i,l)=>{r&&r.removePendingData(x),e===v?(P&&x.onLoadedObservable.remove(P),C.q.UseFallbackTexture&&this.createTexture(C.q.FallbackTexture,t,x.invertY,r,s,null,o,a,x),o&&o((i||"Unknown error")+(C.q.UseFallbackTexture?" - Fallback texture was used":""),l)):(m.V.Warn(`Failed to load ${e}, falling back to ${v}`),this.createTexture(v,t,x.invertY,r,s,n,o,a,x,h,c,u,d))};if(y)throw new Error("Loading textures from IInternalTextureLoader not yet implemented.");{const n=e=>{if(!x._hardwareTexture)return void(r&&r.removePendingData(x));const n=x._hardwareTexture.underlyingResource;this._engine.loadTexture(n,e,!t,i,x._useSRGBBuffer,(()=>{x.baseWidth=this._engine.getTextureWidth(n),x.baseHeight=this._engine.getTextureHeight(n),x.width=x.baseWidth,x.height=x.baseHeight,x.isReady=!0;const e=Qo(s);this._setTextureSampling(n,e),r&&r.removePendingData(x),x.onLoadedObservable.notifyObservers(x),x.onLoadedObservable.clear()}),(()=>{throw new Error("Could not load a native texture.")}))};if(_&&a)if(a instanceof ArrayBuffer)n(new Uint8Array(a));else if(ArrayBuffer.isView(a))n(a);else{if("string"!=typeof a)throw new Error("Unsupported buffer type");n(new Uint8Array(H.S0.DecodeBase64(a)))}else g?n(new Uint8Array(H.S0.DecodeBase64(e))):this._loadFile(e,(e=>n(new Uint8Array(e))),void 0,void 0,!0,((e,t)=>{T("Unable to load "+(e&&e.responseURL,t))}))}return x}wrapNativeTexture(e,t=!1,i=3){const r=new Xo(e,this._engine),s=new lr.h(this,0,!0);return s._hardwareTexture=r,s.baseWidth=this._engine.getTextureWidth(e),s.baseHeight=this._engine.getTextureHeight(e),s.width=s.baseWidth,s.height=s.baseHeight,s.isReady=!0,s.useMipMaps=t,this.updateTextureSamplingMode(i,s),s}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapNativeTexture instead.")}_createDepthStencilTexture(e,t,i){const r=t.generateStencil||!1,s=t.samples||1,n=i,o=new lr.h(this,12),a=e.width??e,l=e.height??e,h=this._engine.createFrameBuffer(o._hardwareTexture.underlyingResource,a,l,r,!0,s);return n._framebufferDepthStencil=h,o}_releaseFramebufferObjects(e){e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand())}_createImageBitmapFromSource(e,t){const i=new Promise(((t,i)=>{const r=this.createCanvasImage();r.onload=()=>{try{const e=this._engine.createImageBitmap(r);t(e)}catch(e){i(`Error loading image ${r.src} with exception: ${e}`)}},r.onerror=e=>{i(`Error loading image ${r.src} with exception: ${e}`)},r.src=e}));return i}createImageBitmap(e,t){return new Promise(((t,i)=>{if(Array.isArray(e)){const i=e;if(i.length){const e=this._engine.createImageBitmap(i[0]);if(e)return void t(e)}}i("Unsupported data for createImageBitmap.")}))}resizeImageBitmap(e,t,i){return this._engine.resizeImageBitmap(e,t,i)}createCubeTexture(e,t,i,r,s=null,n=null,o,a=null,l=!1,h=0,c=0,u=null,d,p=!1,m=null){const f=u||new lr.h(this,7);f.isCube=!0,f.url=e,f.generateMipMaps=!r,f._lodGenerationScale=h,f._lodGenerationOffset=c,f._useSRGBBuffer=this._getUseSRGBBuffer(p,!!r),this._doNotHandleContextLost||(f._extension=a,f._files=i,f._buffer=m);const _=e.lastIndexOf(".");if(".env"===(a||(_>-1?e.substring(_).toLowerCase():""))){const t=e=>{const t=(0,zo.cU)(e);f.width=t.width,f.height=t.width,(0,zo.ow)(f,t);const i=t.specular;if(!i)throw new Error("Nothing else parsed so far");f._lodGenerationScale=i.lodGenerationScale;const r=(0,zo.ux)(e,t);f.format=5,f.type=0,f.generateMipMaps=!0,f.getEngine().updateTextureSamplingMode($e.g.TRILINEAR_SAMPLINGMODE,f),f._isRGBD=!0,f.invertY=!0,this._engine.loadCubeTextureWithMips(f._hardwareTexture.underlyingResource,r,!1,f._useSRGBBuffer,(()=>{f.isReady=!0,s&&s()}),(()=>{throw new Error("Could not load a native cube texture.")}))};if(m)t(m);else{if(i&&6===i.length)throw new Error("Multi-file loading not allowed on env files.");{const i=(e,t)=>{n&&e&&n(e.status+" "+e.statusText,t)};this._loadFile(e,(e=>{t(new Uint8Array(e,0,e.byteLength))}),void 0,void 0,!0,i)}}}else{if(!i||6!==i.length)throw new Error("Cannot load cubemap because 6 files were not defined");const e=[i[0],i[3],i[1],i[4],i[2],i[5]];Promise.all(e.map((e=>this._loadFileAsync(e,void 0,!0).then((e=>new Uint8Array(e,0,e.byteLength)))))).then((e=>new Promise(((t,i)=>{this._engine.loadCubeTexture(f._hardwareTexture.underlyingResource,e,!r,!0,f._useSRGBBuffer,t,i)})))).then((()=>{f.isReady=!0,s&&s()}),(e=>{n&&n(`Failed to load cubemap: ${e.message}`,e)}))}return this._internalTexturesCache.push(f),f}_createHardwareTexture(){return new Xo(this._createTexture(),this._engine)}_createHardwareRenderTargetWrapper(e,t,i){const r=new Yo(e,t,i,this);return this._renderTargetWrapperCache.push(r),r}_createInternalTexture(e,t,i=!0,r=0){let s,n=!1,o=0,a=3,l=5,h=!1,c=1;void 0!==t&&"object"==typeof t?(n=!!t.generateMipMaps,o=void 0===t.type?0:t.type,a=void 0===t.samplingMode?3:t.samplingMode,l=void 0===t.format?5:t.format,h=void 0!==t.useSRGBBuffer&&t.useSRGBBuffer,c=t.samples??1,s=t.label):n=!!t,h=this._getUseSRGBBuffer(h,!n),(1!==o||this._caps.textureFloatLinearFiltering)&&(2!==o||this._caps.textureHalfFloatLinearFiltering)||(a=1),1!==o||this._caps.textureFloat||(o=0,m.V.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const u=new lr.h(this,r),d=e.width??e,p=e.height??e,f=e.layers||0;if(0!==f)throw new Error("Texture layers are not supported in Babylon Native");const _=u._hardwareTexture.underlyingResource,g=Zo(l,o);return this._engine.initializeTexture(_,d,p,n,g,!0,h,c),this._setTextureSampling(_,Qo(a)),u._useSRGBBuffer=h,u.baseWidth=d,u.baseHeight=p,u.width=d,u.height=p,u.depth=f,u.isReady=!0,u.samples=c,u.generateMipMaps=n,u.samplingMode=a,u.type=o,u.format=l,u.label=s,this._internalTexturesCache.push(u),u}createRenderTargetTexture(e,t){const i=this._createHardwareRenderTargetWrapper(!1,!1,e);let r,s=!0,n=!1,o=!1,a=1;void 0!==t&&"object"==typeof t&&(s=t.generateDepthBuffer??!0,n=!!t.generateStencilBuffer,o=!!t.noColorAttachment,r=t.colorAttachment,a=t.samples??1);const l=r||(o?null:this._createInternalTexture(e,t,!0,5)),h=e.width??e,c=e.height??e,u=this._engine.createFrameBuffer(l?l._hardwareTexture.underlyingResource:null,h,c,n,s,a);return i._framebuffer=u,i._generateDepthBuffer=s,i._generateStencilBuffer=n,i._samples=a,i.setTextures(l),i}updateRenderTargetTextureSampleCount(e,t){return m.V.Warn("Updating render target sample count is not currently supported"),e.samples}updateTextureSamplingMode(e,t){if(t._hardwareTexture){const i=Qo(e);this._setTextureSampling(t._hardwareTexture.underlyingResource,i)}t.samplingMode=e}bindFramebuffer(e,t,i,r,s){const n=e;if(this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,t)throw new Error("Cuboid frame buffers are not yet supported in NativeEngine.");if(i||r)throw new Error("Required width/height for frame buffers not yet supported in NativeEngine.");n._framebufferDepthStencil?this._bindUnboundFramebuffer(n._framebufferDepthStencil):this._bindUnboundFramebuffer(n._framebuffer)}unBindFramebuffer(e,t=!1,i){this._currentRenderTarget=null,i&&i(),this._bindUnboundFramebuffer(null)}createDynamicVertexBuffer(e){return this.createVertexBuffer(e,!0)}updateDynamicIndexBuffer(e,t,i=0){const r=e,s=this._normalizeIndexData(t);r.is32Bits=4===s.BYTES_PER_ELEMENT,this._engine.updateDynamicIndexBuffer(r.nativeIndexBuffer,s.buffer,s.byteOffset,s.byteLength,i)}updateDynamicVertexBuffer(e,t,i=0,r){const s=e,n=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,o=new Uint8Array(n.buffer,n.byteOffset,r??n.byteLength);this._engine.updateDynamicVertexBuffer(s.nativeVertexBuffer,o.buffer,o.byteOffset,o.byteLength,i)}_setTexture(e,t,i=!1,r=!1){const s=this._boundUniforms[e];if(!s)return!1;if(!t)return null!=this._boundTexturesCache[e]&&(this._activeChannel=e,this._boundTexturesCache[e]=null,this._unsetNativeTexture(s)),!1;if(t.video)this._activeChannel=e,t.update();else if(4===t.delayLoadState)return t.delayLoad(),!1;let n;return n=r?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:t.is2DArray?this.emptyTexture2DArray:this.emptyTexture,this._activeChannel=e,!(!n||!n._hardwareTexture)&&(this._setTextureWrapMode(n._hardwareTexture.underlyingResource,Ko(t.wrapU),Ko(t.wrapV),Ko(t.wrapR)),this._updateAnisotropicLevel(t),this._setNativeTexture(s,n._hardwareTexture.underlyingResource),!0)}_setTextureSampling(e,t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURESAMPLING),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.finishEncodingCommand()}_setTextureWrapMode(e,t,i,r){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREWRAPMODE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.finishEncodingCommand()}_setNativeTexture(e,t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()}_unsetNativeTexture(e){_native.Engine.COMMAND_UNSETTEXTURE&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNSETTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand())}_updateAnisotropicLevel(e){const t=e.getInternalTexture(),i=e.anisotropicFilteringLevel;t&&t._hardwareTexture&&t._cachedAnisotropicFilteringLevel!==i&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREANISOTROPICLEVEL),this._commandBufferEncoder.encodeCommandArgAsNativeData(t._hardwareTexture.underlyingResource),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand(),t._cachedAnisotropicFilteringLevel=i)}_bindTexture(e,t){const i=this._boundUniforms[e];if(i)if(t&&t._hardwareTexture){const e=t._hardwareTexture.underlyingResource;this._setNativeTexture(i,e)}else this._unsetNativeTexture(i)}unbindAllTextures(){_native.Engine.COMMAND_DISCARDALLTEXTURES&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DISCARDALLTEXTURES),this._commandBufferEncoder.finishEncodingCommand())}_deleteBuffer(e){e.nativeIndexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEINDEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e.nativeIndexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete e.nativeIndexBuffer),e.nativeVertexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e.nativeVertexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete e.nativeVertexBuffer)}createCanvas(e,t){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");const i=new _native.Canvas;return i.width=e,i.height=t,i}createCanvasImage(){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");return new _native.Image}createCanvasPath2D(e){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");return new _native.Path2D(e)}updateTextureData(e,t,i,r,s,n,o=0,a=0,l=!1){throw new Error("updateTextureData not implemented.")}_uploadCompressedDataToTextureDirectly(e,t,i,r,s,n=0,o=0){throw new Error("_uploadCompressedDataToTextureDirectly not implemented.")}_uploadDataToTextureDirectly(e,t,i=0,r=0){throw new Error("_uploadDataToTextureDirectly not implemented.")}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}_uploadImageToTexture(e,t,i=0,r=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}getFontOffset(e){return{ascent:0,height:0,descent:0}}flushFramebuffer(){}_readTexturePixels(e,t,i,r,s,n,o,a,l,h){if(void 0!==r&&-1!==r)throw new Error(`Reading cubemap faces is not supported, but faceIndex is ${r}.`);return this._engine.readTexture(e._hardwareTexture?.underlyingResource,s??0,l??0,h??0,t,i,n?.buffer??null,n?.byteOffset??0,n?.byteLength??0).then((e=>(n||(n=new Uint8Array(e)),n)))}startTimeQuery(){return this._gpuFrameTimeToken||(this._gpuFrameTimeToken=new Fo),this._gpuFrameTimeToken}endTimeQuery(e){return this._engine.populateFrameStats?.(this._frameStats),this._frameStats.gpuTimeNs}}ha.PROTOCOL_VERSION=8,ha._createNativeDataStream=function(){return _native.NativeDataStream.VALIDATION_ENABLED?new ca:new Go};class ca extends Go{constructor(){super()}writeUint32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32),super.writeUint32(e)}writeInt32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32),super.writeInt32(e)}writeFloat32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32),super.writeFloat32(e)}writeUint32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32_ARRAY),super.writeUint32Array(e)}writeInt32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32_ARRAY),super.writeInt32Array(e)}writeFloat32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32_ARRAY),super.writeFloat32Array(e)}writeNativeData(e){super.writeUint32(_native.NativeDataStream.VALIDATION_NATIVE_DATA),super.writeNativeData(e)}writeBoolean(e){super.writeUint32(_native.NativeDataStream.VALIDATION_BOOLEAN),super.writeBoolean(e)}}i(73858);var ua=i(66960);class da{getBindGroups(e,t,i){if(!i)throw new Error("WebGPUComputeContext.getBindGroups: bindingsMapping is required until browsers support reflection for wgsl shaders!");if(0===this._bindGroups.length){const r=this._bindGroupEntries.length>0;for(const t in e){const s=e[t],n=i[t],o=n.group,a=n.binding,l=s.type,h=s.object;let c=s.indexInGroupEntries,u=this._bindGroupEntries[o];switch(u||(u=this._bindGroupEntries[o]=[]),l){case 5:{const e=h;void 0!==c&&r?u[c].resource=this._cacheSampler.getSampler(e):(s.indexInGroupEntries=u.length,u.push({binding:a,resource:this._cacheSampler.getSampler(e)}));break}case 0:case 4:{const e=h,t=e._texture._hardwareTexture;void 0!==c&&r?(0===l&&(u[c++].resource=this._cacheSampler.getSampler(e._texture)),u[c].resource=t.view):(s.indexInGroupEntries=u.length,0===l&&u.push({binding:a-1,resource:this._cacheSampler.getSampler(e._texture)}),u.push({binding:a,resource:t.view}));break}case 1:{const e=h,t=e._texture._hardwareTexture;8&t.textureAdditionalUsages||m.V.Error(`computeDispatch: The texture (name=${e.name}, uniqueId=${e.uniqueId}) is not a storage texture!`,50),void 0!==c&&r?u[c].resource=t.viewForWriting:(s.indexInGroupEntries=u.length,u.push({binding:a,resource:t.viewForWriting}));break}case 6:{const e=h.underlyingResource;void 0!==c&&r?u[c].resource=this._device.importExternalTexture({source:e}):(s.indexInGroupEntries=u.length,u.push({binding:a,resource:this._device.importExternalTexture({source:e})}));break}case 2:case 3:case 7:{const e=7===l?h:h.getBuffer(),t=e.underlyingResource;void 0!==c&&r?(u[c].resource.buffer=t,u[c].resource.size=e.capacity):(s.indexInGroupEntries=u.length,u.push({binding:a,resource:{buffer:t,offset:0,size:e.capacity}}));break}}}for(let e=0;e<this._bindGroupEntries.length;++e){const i=this._bindGroupEntries[e];i?this._bindGroups[e]=this._device.createBindGroup({layout:t.getBindGroupLayout(e),entries:i}):this._bindGroups[e]=void 0}this._bindGroups.length=this._bindGroupEntries.length}return this._bindGroups}constructor(e,t){this._device=e,this._cacheSampler=t,this.uniqueId=da._Counter++,this._bindGroupEntries=[],this.clear()}clear(){this._bindGroups=[]}}da._Counter=0;class pa{get isAsync(){return!1}get isReady(){return this.isAsync,!1}constructor(e){this._name="unnamed",this.engine=e}_getComputeShaderCode(){return this.sources?.compute}dispose(){}}const ma={};ua.WebGPUEngine.prototype.createComputeContext=function(){return new da(this._device,this._cacheSampler)},ua.WebGPUEngine.prototype.createComputeEffect=function(e,t){const i=("string"==typeof e?e:e.computeToken||e.computeSource||e.computeElement||e.compute)+"@"+t.defines;if(this._compiledComputeEffects[i]){const e=this._compiledComputeEffects[i];return t.onCompiled&&e.isReady()&&t.onCompiled(e),e}const r=new ds(e,t,this,i);return this._compiledComputeEffects[i]=r,r},ua.WebGPUEngine.prototype.createComputePipelineContext=function(){return new pa(this)},ua.WebGPUEngine.prototype.areAllComputeEffectsReady=function(){for(const e in this._compiledComputeEffects){if(!this._compiledComputeEffects[e].isReady())return!1}return!0},ua.WebGPUEngine.prototype.computeDispatch=function(e,t,i,r,s=1,n=1,o,a){this._computeDispatch(e,t,i,r,s,n,void 0,void 0,o,a)},ua.WebGPUEngine.prototype.computeDispatchIndirect=function(e,t,i,r,s=0,n,o){this._computeDispatch(e,t,i,void 0,void 0,void 0,r,s,n,o)},ua.WebGPUEngine.prototype._computeDispatch=function(e,t,i,r,s,n,o,a,l,h){this._endCurrentRenderPass();const c=e._pipelineContext,u=t;c.computePipeline||(c.computePipeline=this._device.createComputePipeline({layout:"auto",compute:c.stage})),h&&this._timestampQuery.startPass(ma,this._timestampIndex);const d=this._renderEncoder.beginComputePass(ma);d.setPipeline(c.computePipeline);const p=u.getBindGroups(i,c.computePipeline,l);for(let e=0;e<p.length;++e){const t=p[e];t&&d.setBindGroup(e,t)}void 0!==o?d.dispatchWorkgroupsIndirect(o.underlyingResource,a):r+s+n>0&&d.dispatchWorkgroups(r,s,n),d.end(),h&&(this._timestampQuery.endPass(this._timestampIndex,h),this._timestampIndex+=2)},ua.WebGPUEngine.prototype.releaseComputeEffects=function(){for(const e in this._compiledComputeEffects){const t=this._compiledComputeEffects[e].getPipelineContext();this._deleteComputePipelineContext(t)}this._compiledComputeEffects={}},ua.WebGPUEngine.prototype._prepareComputePipelineContext=function(e,t,i,r,s){const n=e;this.dbgShowShaderCode&&(m.V.Log(r),m.V.Log(t)),n.sources={compute:t,rawCompute:i},n.stage=this._createComputePipelineStageDescriptor(t,r,s)},ua.WebGPUEngine.prototype._releaseComputeEffect=function(e){this._compiledComputeEffects[e._key]&&(delete this._compiledComputeEffects[e._key],this._deleteComputePipelineContext(e.getPipelineContext()))},ua.WebGPUEngine.prototype._rebuildComputeEffects=function(){for(const e in this._compiledComputeEffects){const t=this._compiledComputeEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}},ua.WebGPUEngine.prototype._executeWhenComputeStateIsCompiled=function(e,t){e.stage.module.getCompilationInfo().then((e=>{const i={numErrors:0,messages:[]};for(const t of e.messages)"error"===t.type&&i.numErrors++,i.messages.push({type:t.type,text:t.message,line:t.lineNum,column:t.linePos,length:t.length,offset:t.offset});t(i)}))},ua.WebGPUEngine.prototype._deleteComputePipelineContext=function(e){e&&e.dispose()},ua.WebGPUEngine.prototype._createComputePipelineStageDescriptor=function(e,t,i){return t=t?"//"+t.split("\n").join("\n//")+"\n":"",{module:this._device.createShaderModule({code:t+e}),entryPoint:i}};i(24398);ua.WebGPUEngine.prototype._debugPushGroup=function(e,t){this._options.enableGPUDebugMarkers&&(0===t||1===t?(1===t&&(this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass()),this._renderEncoder.pushDebugGroup(e)):this._currentRenderPass?(this._currentRenderPass.pushDebugGroup(e),this._debugStackRenderPass.push(e)):this._pendingDebugCommands.push(["push",e,t]))},ua.WebGPUEngine.prototype._debugPopGroup=function(e){this._options.enableGPUDebugMarkers&&(0===e||1===e?(1===e&&(this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass()),this._renderEncoder.popDebugGroup()):this._currentRenderPass?(this._currentRenderPass.popDebugGroup(),this._debugStackRenderPass.pop()):this._pendingDebugCommands.push(["pop",null,e]))},ua.WebGPUEngine.prototype._debugInsertMarker=function(e,t){this._options.enableGPUDebugMarkers&&(0===t||1===t?(1===t&&(this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass()),this._renderEncoder.insertDebugMarker(e)):this._currentRenderPass?this._currentRenderPass.insertDebugMarker(e):this._pendingDebugCommands.push(["insert",e,t]))},ua.WebGPUEngine.prototype._debugFlushPendingCommands=function(){if(0!==this._debugStackRenderPass.length){const e=this._debugStackRenderPass.slice();this._debugStackRenderPass.length=0;for(let t=0;t<e.length;++t)this._debugPushGroup(e[t],2)}for(let e=0;e<this._pendingDebugCommands.length;++e){const[t,i,r]=this._pendingDebugCommands[e];switch(t){case"push":this._debugPushGroup(i,r);break;case"pop":this._debugPopGroup(r);break;case"insert":this._debugInsertMarker(i,r)}}this._pendingDebugCommands.length=0},ua.WebGPUEngine.prototype.createDynamicTexture=function(e,t,i,r){const s=new lr.h(this,4);return s.baseWidth=e,s.baseHeight=t,i&&(e=this.needPOTTextures?(0,yr.R)(e,this._caps.maxTextureSize):e,t=this.needPOTTextures?(0,yr.R)(t,this._caps.maxTextureSize):t),s.width=e,s.height=t,s.isReady=!1,s.generateMipMaps=i,s.samplingMode=r,this.updateTextureSamplingMode(r,s),this._internalTexturesCache.push(s),e&&t&&this._textureHelper.createGPUTextureForInternalTexture(s,e,t),s},ua.WebGPUEngine.prototype.updateDynamicTexture=function(e,t,i,r=!1,s,n,o){if(!e)return;const a=t.width,l=t.height;let h=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(h=this._textureHelper.createGPUTextureForInternalTexture(e,a,l)),this._textureHelper.updateTexture(t,e,a,l,e.depth,h.format,0,0,i,r,0,0,o),e.generateMipMaps&&this._generateMipmaps(e),e._dynamicTextureSource=t,e._premulAlpha=r,e.invertY=i||!1,e.isReady=!0},ua.WebGPUEngine.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t=!1,i){i&&i(),this._endCurrentRenderPass(),t||this.generateMipMapsMultiFramebuffer(e),this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)},ua.WebGPUEngine.prototype.createMultipleRenderTarget=function(e,t,i){let r=!1,s=!0,n=!1,o=!1,a=15,l=1,h=1;let c=[],u=[],d=[],p=[],f=[],_=[],g=[],x=[],v=[],S=[],b=!1;const y=this._createHardwareRenderTargetWrapper(!0,!1,e);void 0!==t&&(r=t.generateMipMaps??!1,s=t.generateDepthBuffer??!0,n=t.generateStencilBuffer??!1,o=t.generateDepthTexture??!1,l=t.textureCount??1,a=t.depthTextureFormat??15,c=t.types||c,u=t.samplingModes||u,d=t.useSRGBBuffers||d,p=t.formats||p,f=t.targetTypes||f,_=t.faceIndex||_,g=t.layerIndex||g,x=t.layerCounts||x,v=t.labels||v,S=t.creationFlags||S,h=t.samples??h,b=t.dontCreateTextures??!1);const P=e.width??e,T=e.height??e,C=[],E=[],A=[];y.label=t?.label??"MultiRenderTargetWrapper",y._generateDepthBuffer=s,y._generateStencilBuffer=n,y._attachments=E,y._defaultAttachments=A;let I=null;(s||n||o)&&!b&&(o||(a=s&&n?13:s?14:19),I=y.createDepthStencilTexture(0,!1,n,1,a,y.label+"-DepthStencil"));const R=void 0!==t&&"object"==typeof t&&t.createMipMaps&&!r;for(let e=0;e<l;e++){let t=u[e]||3,s=c[e]||0;const n=p[e]||5,o=!!d[e]&&this._caps.supportSRGBBuffers,a=f[e]||3553,l=x[e]??1,h=S[e];if((1!==s||this._caps.textureFloatLinearFiltering)&&(2!==s||this._caps.textureHalfFloatLinearFiltering)||(t=1),1!==s||this._caps.textureFloat||(s=0,m.V.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),E.push(e+1),A.push(i?e+1:0===e?1:0),-1===a||b)continue;const _=new lr.h(this,6);switch(C[e]=_,a){case 34067:_.isCube=!0;break;case 32879:_.is3D=!0,_.baseDepth=_.depth=l;break;case 35866:_.is2DArray=!0,_.baseDepth=_.depth=l}_.baseWidth=P,_.baseHeight=T,_.width=P,_.height=T,_.isReady=!0,_.samples=1,_.generateMipMaps=r,_.samplingMode=t,_.type=s,_._cachedWrapU=0,_._cachedWrapV=0,_._useSRGBBuffer=o,_.format=n,_.label=v[e]??y.label+"-Texture"+e,this._internalTexturesCache.push(_),R&&(_.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(_,void 0,void 0,void 0,h,!0),R&&(_.generateMipMaps=!1)}return I&&(I.incrementReferences(),C[l]=I,this._internalTexturesCache.push(I)),y.setTextures(C),y.setLayerAndFaceIndices(g,_),b?y._samples=h:this.updateMultipleRenderTargetTextureSampleCount(y,h),y},ua.WebGPUEngine.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t){if(!e||!e.textures||0===e.textures.length||e.textures[0].samples===t)return t;const i=e.textures.length;if(0===i)return 1;t=Math.min(t,this.getCaps().maxMSAASamples);for(let t=0;t<i;++t){const i=e.textures[t]._hardwareTexture;i?.releaseMSAATexture(e.getBaseArrayLayer(t))}const r=e._depthStencilTexture===e.textures[i-1];for(let r=0;r<i;++r){const i=e.textures[r];this._textureHelper.createMSAATexture(i,t,!1,e.getBaseArrayLayer(r)),i.samples=t}return e._depthStencilTexture&&!r&&(this._textureHelper.createMSAATexture(e._depthStencilTexture,t),e._depthStencilTexture.samples=t),e._samples=t,t},ua.WebGPUEngine.prototype.generateMipMapsMultiFramebuffer=function(e){const t=e;if(!t.isMulti)return;const i=t._attachments.length;for(let e=0;e<i;e++){const i=t.textures[e];!i.generateMipMaps||i.isCube||i.is3D||this._generateMipmaps(i)}},ua.WebGPUEngine.prototype.resolveMultiFramebuffer=function(e){throw new Error("resolveMultiFramebuffer is not yet implemented in WebGPU!")},ua.WebGPUEngine.prototype.bindAttachments=function(e){0!==e.length&&this._currentRenderTarget&&(this._mrtAttachments=e,this._currentRenderPass&&this._cacheRenderPipeline.setMRTAttachments(e))},ua.WebGPUEngine.prototype.buildTextureLayout=function(e){const t=[];for(let i=0;i<e.length;i++)e[i]?t.push(i+1):t.push(0);return t},ua.WebGPUEngine.prototype.restoreSingleAttachment=function(){},ua.WebGPUEngine.prototype.restoreSingleAttachmentForRenderTarget=function(){};i(14118),i(9457),i(17085),i(98345),i(40080),i(46938);ua.WebGPUEngine.prototype.updateVideoTexture=function(e,t,i){if(!e||e._isDisabled)return;void 0===this._videoTextureSupported&&(this._videoTextureSupported=!0);let r=e._hardwareTexture;if(e._hardwareTexture?.underlyingResource||(r=this._textureHelper.createGPUTextureForInternalTexture(e)),function(e){return!(!e||void 0===e.underlyingResource)}(t)){if(t.isReady()){try{this._textureHelper.copyVideoToTexture(t,e,r.format,!i),e.generateMipMaps&&this._generateMipmaps(e)}catch(e){}e.isReady=!0}}else t&&this.createImageBitmap(t).then((t=>{this._textureHelper.updateTexture(t,e,e.width,e.height,e.depth,r.format,0,0,!i,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e),e.isReady=!0})).catch((()=>{e.isReady=!0}))};var fa=i(1886),_a=i(98408),ga=i(18505),xa=i(31821),va=i(93100),Sa=i(29087),ba=i(85644),ya=i(69324),Pa=i(85729),Ta=i(82894),Ca=i(74360),Ea=i(58349);class Aa{static async CreateAsync(e,t){return await ua.WebGPUEngine.IsSupportedAsync?ua.WebGPUEngine.CreateAsync(e,t):Vi.Engine.IsSupported?new Vi.Engine(e,void 0,t):new Ro(t)}}var Ia=i(79161);class Ra{}Ra.COPY=1,Ra.CUT=2,Ra.PASTE=3;class Ma{constructor(e,t){this.type=e,this.event=t}static GetTypeFromCharacter(e){switch(e){case 67:return Ra.COPY;case 86:return Ra.PASTE;case 88:return Ra.CUT;default:return-1}}}var Da=i(38123),Oa=i(78854),Na=i(71294),wa=i(22767),Fa=i(16972),Ba=i(22086),Va=i(4720),La=i(5788),ka=i(84813),Ga=i(54011),za=i(60707),Ua=i(10403),Wa=i(85048);class Ha{constructor(e,t="/"){this._context=e,this._separator=t}convert(e){const t=e.split(this._separator);if(t.length<2)throw new Error(`Path ${e} is invalid`);let i=this._context.getVariable(t[0]);const r=t[t.length-1];for(let e=1;e<t.length-1;e++)i=i[t[e]];return{object:i,info:{type:"object",get:()=>i[r],set:e=>i[r]=e,getTarget:()=>i,getPropertyName:[()=>r]}}}}var $a,qa=i(92579),Ya=i(27439),Xa=i(59693),ja=i(55144),Za=i(84679),Qa=i(99515),Ka=i(50452),Ja=i(714),el=i(79720),tl=i(880),il=i(53696),rl=i(87593),sl=i(63145),nl=i(66154),ol=i(78855),al=i(8993),ll=i(11995),hl=i(52047),cl=i(64353),ul=i(87641),dl=i(41665),pl=i(3126),ml=i(9938),fl=i(10362),_l=i(50926),gl=i(15682),xl=i(24676),vl=i(98285),Sl=i(481),bl=i(44190),yl=i(69486),Pl=i(96022),Tl=i(68587),Cl=i(59816),El=i(62703),Al=i(19181),Il=i(13433),Rl=i(17399),Ml=i(10833),Dl=i(16797),Ol=i(23051),Nl=i(25595),wl=i(71271),Fl=i(72536),Bl=i(15583),Vl=i(33314),Ll=i(62661),kl=i(69569),Gl=i(45499),zl=i(86951),Ul=i(85715);!function(e){e.PlayAnimation="FlowGraphPlayAnimationBlock",e.StopAnimation="FlowGraphStopAnimationBlock",e.PauseAnimation="FlowGraphPauseAnimationBlock",e.ValueInterpolation="FlowGraphInterpolationBlock",e.SceneReadyEvent="FlowGraphSceneReadyEventBlock",e.SceneTickEvent="FlowGraphSceneTickEventBlock",e.SendCustomEvent="FlowGraphSendCustomEventBlock",e.ReceiveCustomEvent="FlowGraphReceiveCustomEventBlock",e.MeshPickEvent="FlowGraphMeshPickEventBlock",e.PointerEvent="FlowGraphPointerEventBlock",e.PointerDownEvent="FlowGraphPointerDownEventBlock",e.PointerUpEvent="FlowGraphPointerUpEventBlock",e.PointerMoveEvent="FlowGraphPointerMoveEventBlock",e.PointerOverEvent="FlowGraphPointerOverEventBlock",e.PointerOutEvent="FlowGraphPointerOutEventBlock",e.E="FlowGraphEBlock",e.PI="FlowGraphPIBlock",e.Inf="FlowGraphInfBlock",e.NaN="FlowGraphNaNBlock",e.Random="FlowGraphRandomBlock",e.Add="FlowGraphAddBlock",e.Subtract="FlowGraphSubtractBlock",e.Multiply="FlowGraphMultiplyBlock",e.Divide="FlowGraphDivideBlock",e.Abs="FlowGraphAbsBlock",e.Sign="FlowGraphSignBlock",e.Trunc="FlowGraphTruncBlock",e.Floor="FlowGraphFloorBlock",e.Ceil="FlowGraphCeilBlock",e.Round="FlowGraphRoundBlock",e.Fraction="FlowGraphFractBlock",e.Negation="FlowGraphNegationBlock",e.Modulo="FlowGraphModuloBlock",e.Min="FlowGraphMinBlock",e.Max="FlowGraphMaxBlock",e.Clamp="FlowGraphClampBlock",e.Saturate="FlowGraphSaturateBlock",e.MathInterpolation="FlowGraphMathInterpolationBlock",e.Equality="FlowGraphEqualityBlock",e.LessThan="FlowGraphLessThanBlock",e.LessThanOrEqual="FlowGraphLessThanOrEqualBlock",e.GreaterThan="FlowGraphGreaterThanBlock",e.GreaterThanOrEqual="FlowGraphGreaterThanOrEqualBlock",e.IsNaN="FlowGraphIsNaNBlock",e.IsInfinity="FlowGraphIsInfBlock",e.DegToRad="FlowGraphDegToRadBlock",e.RadToDeg="FlowGraphRadToDegBlock",e.Sin="FlowGraphSinBlock",e.Cos="FlowGraphCosBlock",e.Tan="FlowGraphTanBlock",e.Asin="FlowGraphASinBlock",e.Acos="FlowGraphACosBlock",e.Atan="FlowGraphATanBlock",e.Atan2="FlowGraphATan2Block",e.Sinh="FlowGraphSinhBlock",e.Cosh="FlowGraphCoshBlock",e.Tanh="FlowGraphTanhBlock",e.Asinh="FlowGraphASinhBlock",e.Acosh="FlowGraphACoshBlock",e.Atanh="FlowGraphATanhBlock",e.Exponential="FlowGraphExponentialBlock",e.Log="FlowGraphLogBlock",e.Log2="FlowGraphLog2Block",e.Log10="FlowGraphLog10Block",e.SquareRoot="FlowGraphSquareRootBlock",e.CubeRoot="FlowGraphCubeRootBlock",e.Power="FlowGraphPowerBlock",e.Length="FlowGraphLengthBlock",e.Normalize="FlowGraphNormalizeBlock",e.Dot="FlowGraphDotBlock",e.Cross="FlowGraphCrossBlock",e.Rotate2D="FlowGraphRotate2DBlock",e.Rotate3D="FlowGraphRotate3DBlock",e.Transpose="FlowGraphTransposeBlock",e.Determinant="FlowGraphDeterminantBlock",e.InvertMatrix="FlowGraphInvertMatrixBlock",e.MatrixMultiplication="FlowGraphMatrixMultiplicationBlock",e.BitwiseAnd="FlowGraphBitwiseAndBlock",e.BitwiseOr="FlowGraphBitwiseOrBlock",e.BitwiseXor="FlowGraphBitwiseXorBlock",e.BitwiseNot="FlowGraphBitwiseNotBlock",e.BitwiseLeftShift="FlowGraphBitwiseLeftShiftBlock",e.BitwiseRightShift="FlowGraphBitwiseRightShiftBlock",e.LeadingZeros="FlowGraphLeadingZerosBlock",e.TrailingZeros="FlowGraphTrailingZerosBlock",e.OneBitsCounter="FlowGraphOneBitsCounterBlock",e.Branch="FlowGraphBranchBlock",e.SetDelay="FlowGraphSetDelayBlock",e.CancelDelay="FlowGraphCancelDelayBlock",e.CallCounter="FlowGraphCallCounterBlock",e.Debounce="FlowGraphDebounceBlock",e.Throttle="FlowGraphThrottleBlock",e.DoN="FlowGraphDoNBlock",e.FlipFlop="FlowGraphFlipFlopBlock",e.ForLoop="FlowGraphForLoopBlock",e.MultiGate="FlowGraphMultiGateBlock",e.Sequence="FlowGraphSequenceBlock",e.Switch="FlowGraphSwitchBlock",e.WaitAll="FlowGraphWaitAllBlock",e.WhileLoop="FlowGraphWhileLoopBlock",e.ConsoleLog="FlowGraphConsoleLogBlock",e.Conditional="FlowGraphConditionalBlock",e.Constant="FlowGraphConstantBlock",e.TransformCoordinatesSystem="FlowGraphTransformCoordinatesSystemBlock",e.GetAsset="FlowGraphGetAssetBlock",e.GetProperty="FlowGraphGetPropertyBlock",e.SetProperty="FlowGraphSetPropertyBlock",e.GetVariable="FlowGraphGetVariableBlock",e.SetVariable="FlowGraphSetVariableBlock",e.JsonPointerParser="FlowGraphJsonPointerParserBlock",e.CombineVector2="FlowGraphCombineVector2Block",e.CombineVector3="FlowGraphCombineVector3Block",e.CombineVector4="FlowGraphCombineVector4Block",e.CombineMatrix="FlowGraphCombineMatrixBlock",e.CombineMatrix2D="FlowGraphCombineMatrix2DBlock",e.CombineMatrix3D="FlowGraphCombineMatrix3DBlock",e.ExtractVector2="FlowGraphExtractVector2Block",e.ExtractVector3="FlowGraphExtractVector3Block",e.ExtractVector4="FlowGraphExtractVector4Block",e.ExtractMatrix="FlowGraphExtractMatrixBlock",e.ExtractMatrix2D="FlowGraphExtractMatrix2DBlock",e.ExtractMatrix3D="FlowGraphExtractMatrix3DBlock",e.TransformVector="FlowGraphTransformVectorBlock",e.TransformCoordinates="FlowGraphTransformCoordinatesBlock",e.MatrixDecompose="FlowGraphMatrixDecompose",e.MatrixCompose="FlowGraphMatrixCompose",e.BooleanToFloat="FlowGraphBooleanToFloat",e.BooleanToInt="FlowGraphBooleanToInt",e.FloatToBoolean="FlowGraphFloatToBoolean",e.IntToBoolean="FlowGraphIntToBoolean",e.IntToFloat="FlowGraphIntToFloat",e.FloatToInt="FlowGraphFloatToInt",e.Easing="FlowGraphEasingBlock",e.Context="FlowGraphContextBlock",e.ArrayIndex="FlowGraphArrayIndexBlock",e.CodeExecution="FlowGraphCodeExecutionBlock",e.IndexOf="FlowGraphIndexOfBlock",e.FunctionReference="FlowGraphFunctionReference",e.BezierCurveEasing="FlowGraphBezierCurveEasing",e.DataSwitch="FlowGraphDataSwitchBlock"}($a||($a={}));var Wl,Hl,$l,ql=i(90868),Yl=i(57565),Xl=i(82678);!function(e){e[e.Texture=1]="Texture",e[e.TextureBackBuffer=2]="TextureBackBuffer",e[e.TextureBackBufferDepthStencilAttachment=4]="TextureBackBufferDepthStencilAttachment",e[e.TextureDepthStencilAttachment=8]="TextureDepthStencilAttachment",e[e.TextureViewDepth=16]="TextureViewDepth",e[e.TextureViewNormal=32]="TextureViewNormal",e[e.TextureAlbedo=64]="TextureAlbedo",e[e.TextureReflectivity=128]="TextureReflectivity",e[e.TextureWorldPosition=256]="TextureWorldPosition",e[e.TextureVelocity=512]="TextureVelocity",e[e.TextureIrradiance=1024]="TextureIrradiance",e[e.TextureAlbedoSqrt=2048]="TextureAlbedoSqrt",e[e.TextureScreenDepth=4096]="TextureScreenDepth",e[e.TextureWorldNormal=8192]="TextureWorldNormal",e[e.TextureLocalPosition=16384]="TextureLocalPosition",e[e.TextureLinearVelocity=32768]="TextureLinearVelocity",e[e.TextureAllButBackBufferDepthStencil=1048571]="TextureAllButBackBufferDepthStencil",e[e.TextureAllButBackBuffer=1048569]="TextureAllButBackBuffer",e[e.TextureAll=1048575]="TextureAll",e[e.ResourceContainer=1048576]="ResourceContainer",e[e.ShadowGenerator=2097152]="ShadowGenerator",e[e.ShadowLight=4194304]="ShadowLight",e[e.Camera=16777216]="Camera",e[e.ObjectList=33554432]="ObjectList",e[e.AutoDetect=268435456]="AutoDetect",e[e.BasedOnInput=536870912]="BasedOnInput",e[e.Undefined=1073741824]="Undefined",e[e.Object=2147483648]="Object",e[e.All=4294967295]="All"}(Wl||(Wl={})),function(e){e[e.Compatible=0]="Compatible",e[e.TypeIncompatible=1]="TypeIncompatible",e[e.HierarchyIssue=2]="HierarchyIssue"}(Hl||(Hl={})),function(e){e[e.Input=0]="Input",e[e.Output=1]="Output"}($l||($l={}));class jl{get direction(){return this._direction}static IsTextureHandle(e){return void 0!==e&&Number.isFinite(e)}static IsShadowGenerator(e){return void 0!==e&&void 0!==e.mapSize}static IsShadowLight(e){return void 0!==e&&void 0!==e.setShadowProjectionMatrix}get type(){if(this._type===Wl.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource){if(this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type;if(this._linkedConnectionSource._defaultConnectionPointType)return this._linkedConnectionSource._defaultConnectionPointType}if(this._defaultConnectionPointType)return this._defaultConnectionPointType}if(this._type===Wl.BasedOnInput){if(this._typeConnectionSource){const e="function"==typeof this._typeConnectionSource?this._typeConnectionSource():this._typeConnectionSource;return e.isConnected?e._connectedPoint.type:this._defaultConnectionPointType??e.type}if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get isConnected(){return null!==this.connectedPoint||this.hasEndpoints}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return 0===this._endpoints.length?[]:this._endpoints.map((e=>e.ownerBlock))}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get innerType(){return this._linkedConnectionSource&&!this._isMainLinkSource&&this._linkedConnectionSource.isConnected?this.type:this._type}createCustomInputBlock(){return null}constructor(e,t,i){this._connectedPoint=null,this._acceptedConnectionPointType=null,this._endpoints=new Array,this._type=Wl.Undefined,this._linkedConnectionSource=null,this._isMainLinkSource=!1,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new s.cP,this.onDisconnectionObservable=new s.cP,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeRenderGraphConnectionPoint"}canConnectTo(e){return 0===this.checkCompatibilityState(e)}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(this.type!==e.type&&e.innerType!==Wl.AutoDetect)return e.acceptedConnectionPointTypes&&-1!==e.acceptedConnectionPointTypes.indexOf(this.type)?0:1;if(e.excludedConnectionPointTypes&&-1!==e.excludedConnectionPointTypes.indexOf(this.type))return 1;let r=i,s=t;return 0===this.direction&&(r=t,s=i),r.isAnAncestorOf(s)?2:0}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return-1===t||(this._endpoints.splice(t,1),e._connectedPoint=null,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this)),this}addExcludedConnectionPointFromAllowedTypes(e){let t=0,i=2**t;for(;i<Wl.All;)e&i||this.excludedConnectionPointTypes.push(i),t++,i=2**t}addAcceptedConnectionPointTypes(e){let t=0,i=2**t;for(;i<Wl.All;)e&i&&-1===this.acceptedConnectionPointTypes.indexOf(i)&&this.acceptedConnectionPointTypes.push(i),t++,i=2**t}serialize(e=!0){const t={};return t.name=this.name,t.displayName=this.displayName,e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear()}}class Zl{get disabled(){return!!this._frameGraphTask?.disabled}set disabled(e){this._frameGraphTask&&(this._frameGraphTask.disabled=e)}get task(){return this._frameGraphTask}get inputs(){return this._inputs}get outputs(){return this._outputs}get name(){return this._name}set name(e){this._name=e}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isDebug(){return this._isDebug}get isUnique(){return this._isUnique}getClassName(){return"NodeRenderGraphBlock"}_inputRename(e){return e}_outputRename(e){return e}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints){if(i.ownerBlock===e)return!0;if(i.ownerBlock.isAnAncestorOf(e))return!0}return!1}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints)if(i.ownerBlock.isAnAncestorOfType(e))return!0;return!1}getDescendantOfPredicate(e){if(e(this))return this;for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints){const t=i.ownerBlock.getDescendantOfPredicate(e);if(t)return t}return null}constructor(e,t,i,...r){this._name="",this._isInput=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._isDebug=!1,this._isUnique=!1,this.onBuildObservable=new s.cP,this._inputs=new Array,this._outputs=new Array,this._codeVariableName="",this._additionalConstructionParameters=null,this.visibleOnFrame=!1,this._name=e,this._frameGraph=t,this._scene=i,this._engine=i.getEngine(),this.uniqueId=Xl.K.UniqueId}registerInput(e,t,i=!1,r){return(r=r??new jl(e,this,0)).type=t,r.isOptional=i,this._inputs.push(r),this}registerOutput(e,t,i){return(i=i??new jl(e,this,1)).type=t,this._outputs.push(i),this}_addDependenciesInput(){this.registerInput("dependencies",Wl.Texture,!0);const e=this.getInputByName("dependencies");return e.addAcceptedConnectionPointTypes(Wl.TextureAllButBackBuffer|Wl.ResourceContainer|Wl.ShadowGenerator),e}_buildBlock(e){}_customBuildStep(e){}_propagateInputValueToOutput(e,t){e.connectedPoint&&(t.value=e.connectedPoint.value)}build(e){if(this._buildId===e.buildId)return!0;this._buildId=e.buildId;for(const t of this._inputs){if(!t.connectedPoint){t.isOptional||e._notConnectedNonOptionalInputs.push(t);continue}const i=t.connectedPoint.ownerBlock;i&&i!==this&&i.build(e)}if(this._customBuildStep(e),e.verbose&&m.V.Log(`Building ${this.name} [${this.getClassName()}]`),this._frameGraphTask&&(this._frameGraphTask.name=this.name),this._buildBlock(e),this._frameGraphTask){this._frameGraphTask.dependencies=void 0;const e=this.getInputByName("dependencies")?.connectedPoint;if(e)if(e.type===Wl.ResourceContainer){const t=e.ownerBlock;for(let e=0;e<t.inputs.length;e++){const i=t.inputs[e];i.connectedPoint&&void 0!==i.connectedPoint.value&&jl.IsTextureHandle(i.connectedPoint.value)&&(this._frameGraphTask.dependencies=this._frameGraphTask.dependencies||new Set,this._frameGraphTask.dependencies.add(i.connectedPoint.value))}}else jl.IsTextureHandle(e.value)&&(this._frameGraphTask.dependencies=this._frameGraphTask.dependencies||new Set,this._frameGraphTask.dependencies.add(e.value));this._frameGraph.addTask(this._frameGraphTask)}return this.onBuildObservable.notifyObservers(this),!1}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:(this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[e]._isMainLinkSource=!0),this._inputs[t]._linkedConnectionSource=this._inputs[e]}initialize(){}autoConfigure(){}getInputByName(e){const t=this._inputs.filter((t=>t.name===e));return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter((t=>t.name===e));return t.length?t[0]:null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.visibleOnFrame=this.visibleOnFrame,e.disabled=this.disabled,this._additionalConstructionParameters&&(e.additionalConstructionParameters=this._additionalConstructionParameters),e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e){this._name=e.name,this.comments=e.comments,this.visibleOnFrame=e.visibleOnFrame,this.disabled=e.disabled,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;t&&t.forEach((e=>{const t=this.inputs.find((t=>t.name===e.name));t&&(e.displayName&&(t.displayName=e.displayName),e.isExposedOnFrame&&(t.isExposedOnFrame=e.isExposedOnFrame,t.exposedPortPosition=e.exposedPortPosition))})),i&&i.forEach(((e,t)=>{e.displayName&&(this.outputs[t].displayName=e.displayName),e.isExposedOnFrame&&(this.outputs[t].isExposedOnFrame=e.isExposedOnFrame,this.outputs[t].exposedPortPosition=e.exposedPortPosition)}))}_dumpPropertiesCode(){const e=this._codeVariableName;return`${e}.visibleOnFrame = ${this.visibleOnFrame};\n${e}.disabled = ${this.disabled};\n`}_dumpCodeForOutputConnections(e){let t="";if(-1!==e.indexOf(this))return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const r=i.connectedPoint,s=r.ownerBlock;t+=s._dumpCodeForOutputConnections(e),t+=`${s._codeVariableName}.${s._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});\n`}return t}_dumpCode(e,t){t.push(this);const i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,-1!==e.indexOf(this._codeVariableName)){let t=0;do{t++,this._codeVariableName=i+t}while(-1!==e.indexOf(this._codeVariableName))}e.push(this._codeVariableName);let r=`\n// ${this.getClassName()}\n`;this.comments&&(r+=`// ${this.comments}\n`);const s=this.getClassName();if("RenderGraphInputBlock"===s){const e=this.type;r+=`var ${this._codeVariableName} = new BABYLON.NodeRenderGraphInputBlock("${this.name}", nodeRenderGraph.frameGraph, scene, BABYLON.NodeRenderGraphBlockConnectionPointTypes.${Wl[e]});\n`}else this._additionalConstructionParameters?r+=`var ${this._codeVariableName} = new BABYLON.${s}("${this.name}", nodeRenderGraph.frameGraph, scene, ...${JSON.stringify(this._additionalConstructionParameters)});\n`:r+=`var ${this._codeVariableName} = new BABYLON.${s}("${this.name}", nodeRenderGraph.frameGraph, scene);\n`;r+=this._dumpPropertiesCode()+"\n";for(const i of this.inputs){if(!i.isConnected)continue;const s=i.connectedPoint.ownerBlock;-1===t.indexOf(s)&&(r+=s._dumpCode(e,t))}for(const i of this.outputs)if(i.hasEndpoints)for(const s of i.endpoints){const i=s.ownerBlock;i&&-1===t.indexOf(i)&&(r+=i._dumpCode(e,t))}return r}clone(){const e=this.serialize(),t=(0,a.n9)(e.customType);if(t){const i=e.additionalConstructionParameters,r=i?new t("",this._frameGraph,this._scene,...i):new t("",this._frameGraph,this._scene);return r._deserialize(e),r}return null}dispose(){for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose();this._frameGraphTask?.dispose(),this._frameGraphTask=void 0,this.onBuildObservable.clear()}}(0,Ge.Cg)([(0,ze.lK)("comment")],Zl.prototype,"comments",void 0);const Ql=0,Kl=1;class Jl{constructor(e,t,i){this.name=e,this._parentTask=t,this._context=i,this.disabled=!1}setExecuteFunc(e){this._executeFunc=e}_execute(){this.disabled||this._executeFunc(this._context)}_isValid(){return void 0!==this._executeFunc?null:"Execute function is not set (call setExecuteFunc to set it)"}}class eh extends Jl{static IsCullPass(e){return void 0!==e.setObjectList}get objectList(){return this._objectList}setObjectList(e){this._objectList=e}constructor(e,t,i,r){super(e,t,i),this._engine=r}_isValid(){const e=super._isValid();return e||(void 0!==this._objectList?null:"Object list is not set (call setObjectList to set it)")}}class th extends Jl{static IsRenderPass(e){return void 0!==e.setRenderTarget}get renderTarget(){return this._renderTarget}get renderTargetDepth(){return this._renderTargetDepth}constructor(e,t,i,r){super(e,t,i),this._dependencies=new Set,this._engine=r}setRenderTarget(e){this._renderTarget=e}setRenderTargetDepth(e){this._renderTargetDepth=e}addDependencies(e){if(Array.isArray(e))for(const t of e)this._dependencies.add(t);else this._dependencies.add(e)}collectDependencies(e){const t=this._dependencies.keys();for(let i=t.next();!0!==i.done;i=t.next())e.add(i.value);if(this._renderTarget)if(Array.isArray(this._renderTarget))for(const t of this._renderTarget)void 0!==t&&e.add(t);else e.add(this._renderTarget);this._renderTargetDepth&&e.add(this._renderTargetDepth)}_execute(){this._frameGraphRenderTarget=this._frameGraphRenderTarget||this._context.createRenderTarget(this.name,this._renderTarget,this._renderTargetDepth),this._context.bindRenderTarget(this._frameGraphRenderTarget,`frame graph render pass - ${this.name}`),super._execute(),this._context._flushDebugMessages()}_isValid(){const e=super._isValid();return e||(void 0!==this._renderTarget||void 0!==this.renderTargetDepth?null:"Render target and render target depth cannot both be undefined.")}}class ih{get name(){return this._name}set name(e){this._name=e}get disabled(){return this._disabled}set disabled(e){this._disabled=e}get passes(){return this._passes}get passesDisabled(){return this._passesDisabled}isReady(){return!0}dispose(){this._reset(),this.onTexturesAllocatedObservable.clear()}constructor(e,t){this._passes=[],this._passesDisabled=[],this._disabled=!1,this.onTexturesAllocatedObservable=new s.cP,this.name=e,this._frameGraph=t,this._reset()}_reset(){this._passes.length=0,this._passesDisabled.length=0}_addPass(e,t){t?this._passesDisabled.push(e):this._passes.push(e)}_checkTask(){let e,t=null,i=null;for(const r of this._passes){const s=r._isValid();if(s)throw new Error(`Pass "${r.name}" is not valid. ${s}`);if(th.IsRenderPass(r)){const e=Array.isArray(r.renderTarget)?r.renderTarget:[r.renderTarget];t=[];for(const i of e)void 0!==i&&t.push(this._frameGraph.textureManager.getTextureFromHandle(i));i=void 0!==r.renderTargetDepth?this._frameGraph.textureManager.getTextureFromHandle(r.renderTargetDepth):null}else eh.IsCullPass(r)&&(e=r.objectList)}let r,s=null,n=[],o=null;for(const e of this._passesDisabled){const t=e._isValid();if(t)throw new Error(`Pass "${e.name}" is not valid. ${t}`);if(th.IsRenderPass(e)){const t=Array.isArray(e.renderTarget)?e.renderTarget:[e.renderTarget];s=[];for(const e of t)void 0!==e&&s.push(this._frameGraph.textureManager.getTextureFromHandle(e));n=t,o=void 0!==e.renderTargetDepth?this._frameGraph.textureManager.getTextureFromHandle(e.renderTargetDepth):null}else eh.IsCullPass(e)&&(r=e.objectList)}if(this._passesDisabled.length>0){if(!this._checkSameRenderTarget(t,s)){let e=!0;for(const t of n)if(void 0!==t&&!this._frameGraph.textureManager.isHistoryTexture(t)){e=!1;break}if(!e)throw new Error(`The output texture of the task "${this.name}" is different when it is enabled or disabled.`)}if(i!==o)throw new Error(`The output depth texture of the task "${this.name}" is different when it is enabled or disabled.`);if(e!==r)throw new Error(`The output object list of the task "${this.name}" is different when it is enabled or disabled.`)}}_getPasses(){return this.disabled&&this._passesDisabled.length>0?this._passesDisabled:this._passes}_checkSameRenderTarget(e,t){if(null===e||null===t)return e===t;if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}}class rh extends ih{record(){if(void 0===this.sourceTexture)throw new Error(`FrameGraphCopyToBackbufferColorTask "${this.name}": sourceTexture is required`);const e=this._frameGraph.addRenderPass(this.name);e.addDependencies(this.sourceTexture),e.setRenderTarget(Ql),e.setExecuteFunc((e=>{e.isBackbuffer(this.sourceTexture)||e.copyTexture(this.sourceTexture)}));const t=this._frameGraph.addRenderPass(this.name+"_disabled",!0);t.setRenderTarget(Ql),t.setExecuteFunc((e=>{}))}}class sh extends Zl{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._isUnique=!0,this.registerInput("texture",Wl.Texture),this.texture.addAcceptedConnectionPointTypes(Wl.TextureAll),this._frameGraphTask=new rh(e,t)}getClassName(){return"NodeRenderGraphOutputBlock"}get texture(){return this._inputs[0]}_buildBlock(e){super._buildBlock(e),this._frameGraphTask.name=this.name;const t=this.texture.connectedPoint;t&&(this._frameGraphTask.sourceTexture=t.value)}}var nh;(0,a.Y5)("BABYLON.NodeRenderGraphOutputBlock",sh),function(e){e[e.None=0]="None",e[e.ToLinearSpace=1]="ToLinearSpace",e[e.ToGammaSpace=2]="ToGammaSpace"}(nh||(nh={}));class oh{get shaderLanguage(){return this._shaderLanguage}_textureIsInternal(e){return void 0===e.getInternalTexture}constructor(e,t=!1){this._shaderLanguage=0,this._shadersLoaded=!1,this._engine=e,this._isDepthTexture=t,this._renderer=new Bi.J(e),this._initShaderSourceAsync(t)}async _initShaderSourceAsync(e){const t=this._engine;t.isWebGPU?(this._shaderLanguage=1,await Promise.resolve().then(i.bind(i,17770))):await Promise.resolve().then(i.bind(i,45963)),this._shadersLoaded=!0,this._effectWrapper=new Bi.$({engine:t,name:"CopyTextureToTexture",fragmentShader:"copyTextureToTexture",useShaderStore:!0,uniformNames:["conversion"],samplerNames:["textureSampler"],defines:e?["#define DEPTH_TEXTURE"]:[],shaderLanguage:this._shaderLanguage}),this._effectWrapper.onApplyObservable.add((()=>{e?(t.setState(!1),t.setDepthBuffer(!0),t.depthCullingState.depthMask=!0,t.depthCullingState.depthFunc=519):t.depthCullingState.depthMask=!1,this._textureIsInternal(this._source)?this._effectWrapper.effect._bindTexture("textureSampler",this._source):this._effectWrapper.effect.setTexture("textureSampler",this._source),this._effectWrapper.effect.setFloat("conversion",this._conversion)}))}isReady(){return this._shadersLoaded&&!!this._effectWrapper?.effect?.isReady()}copy(e,t=null,i=0){if(!this.isReady())return!1;this._source=e,this._conversion=i;const r=this._engine.getDepthFunction(),s=this._engine.getDepthWrite();return this._renderer.render(this._effectWrapper,t),this._engine.setDepthWrite(s),this._isDepthTexture&&r&&this._engine.setDepthFunction(r),!0}dispose(){this._effectWrapper?.dispose(),this._renderer.dispose()}}class ah{}class lh extends ah{static _IsObjectRenderer(e){return void 0!==e.initRender}constructor(e,t,i){super(),this._engine=e,this._textureManager=t,this._scene=i,this._debugMessageHasBeenPushed=!1,this._renderTargetIsBound=!0,this._effectRenderer=new Bi.J(this._engine),this._copyTexture=new oh(this._engine)}isBackbuffer(e){return this._textureManager.isBackbuffer(e)}isBackbufferColor(e){return this._textureManager.isBackbufferColor(e)}isBackbufferDepthStencil(e){return this._textureManager.isBackbufferDepthStencil(e)}createRenderTarget(e,t,i){return this._textureManager.createRenderTarget(e,t,i)}clear(e,t,i,r){this._applyRenderTarget(),this._engine.clear(e,t,i,r)}clearColorAttachments(e,t){this._applyRenderTarget(),this._engine.bindAttachments(t),this._engine.clear(e,!0,!1,!1)}bindAttachments(e){this._applyRenderTarget(),this._engine.bindAttachments(e)}generateMipMaps(){if(void 0===this._currentRenderTarget?.renderTargetWrapper)return;this._renderTargetIsBound&&this._engine._currentRenderTarget&&(this._flushDebugMessages(),this._engine.unBindFramebuffer(this._engine._currentRenderTarget),this._renderTargetIsBound=!1);const e=this._currentRenderTarget.renderTargetWrapper.textures;if(e)for(const t of e)this._engine.generateMipmaps(t)}setTextureSamplingMode(e,t){const i=this._textureManager.getTextureFromHandle(e);i&&i.samplingMode!==t&&this._engine.updateTextureSamplingMode(t,i)}bindTextureHandle(e,t,i){let r;const s=this._textureManager._historyTextures.get(i);s?(r=s.textures[s.index],void 0!==this._currentRenderTarget&&void 0!==this._currentRenderTarget.renderTargetWrapper&&this._currentRenderTarget.renderTargetWrapper.textures.includes(r)&&(r=s.textures[1^s.index])):r=this._textureManager._textures.get(i).texture,e._bindTexture(t,r)}saveDepthStates(){this._depthTest=this._engine.getDepthBuffer(),this._depthWrite=this._engine.getDepthWrite()}restoreDepthStates(){this._engine.setDepthBuffer(this._depthTest),this._engine.setDepthWrite(this._depthWrite)}setDepthStates(e,t){this._engine.setDepthBuffer(e),this._engine.setDepthWrite(t)}applyFullScreenEffect(e,t){if(!e.effect?.isReady())return!1;this._applyRenderTarget();const i=this._engine.getDepthWrite();return this._effectRenderer.saveStates(),this._effectRenderer.setViewport(),this._engine.enableEffect(e),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._effectRenderer.bindBuffers(e.effect),t?.(),this._effectRenderer.draw(),this._effectRenderer.restoreStates(),this._engine.setDepthWrite(i),this._engine.setAlphaMode(0),!0}copyTexture(e,t=!1){t&&this.bindRenderTarget(),this._applyRenderTarget(),this._copyTexture.copy(this._textureManager.getTextureFromHandle(e))}render(e,t,i){lh._IsObjectRenderer(e)?e.shouldRender()&&(this._scene.incrementRenderId(),this._scene.resetCachedMaterial(),this._applyRenderTarget(),e.prepareRenderList(),e.initRender(t,i),e.render(),e.finishRender()):(this._applyRenderTarget(),e.render())}bindRenderTarget(e,t){if(void 0===e?.renderTargetWrapper&&void 0===this._currentRenderTarget||e&&this._currentRenderTarget&&e.equals(this._currentRenderTarget))return this._flushDebugMessages(),void(void 0!==t&&(this._engine._debugPushGroup?.(t,2),this._debugMessageWhenTargetBound=void 0,this._debugMessageHasBeenPushed=!0));this._currentRenderTarget=void 0===e?.renderTargetWrapper?void 0:e,this._debugMessageWhenTargetBound=t,this._renderTargetIsBound=!1}_flushDebugMessages(){this._debugMessageHasBeenPushed&&(this._engine._debugPopGroup?.(2),this._debugMessageHasBeenPushed=!1)}_applyRenderTarget(){if(this._renderTargetIsBound)return;this._flushDebugMessages();const e=this._currentRenderTarget?.renderTargetWrapper;void 0===e?this._engine.restoreDefaultFramebuffer():(this._engine._currentRenderTarget&&this._engine.unBindFramebuffer(this._engine._currentRenderTarget),this._engine.bindFramebuffer(e)),void 0!==this._debugMessageWhenTargetBound&&(this._engine._debugPushGroup?.(this._debugMessageWhenTargetBound,2),this._debugMessageWhenTargetBound=void 0,this._debugMessageHasBeenPushed=!0),this._renderTargetIsBound=!0}_isReady(){return this._copyTexture.isReady()}_dispose(){this._effectRenderer.dispose(),this._copyTexture.dispose()}}function hh(e){return void 0!==e.width}function ch(e){return hh(e)?{width:e.width,height:e.height}:{width:e,height:e}}class uh{constructor(e,t,i,r){this._isBackBuffer=!1,this.name=e,this._textureManager=t,this._renderTargets=void 0===i?void 0:Array.isArray(i)?i:[i],this._renderTargetDepth=r}get renderTargetWrapper(){if(!this._isBackBuffer){if(!this._renderTargetWrapper){const e=this._textureManager.engine,t=void 0===this._renderTargets?this._renderTargetDepth:this._renderTargets[0];if(this._textureManager.isBackbuffer(t))return void(this._isBackBuffer=!0);const i=this._textureManager.getTextureDescription(t),r={textureCount:this._renderTargets?.length??0,generateDepthBuffer:!1,label:this.name,samples:i.options.samples??1,dontCreateTextures:!0};this._renderTargetWrapper=e.createMultipleRenderTarget(i.size,r,!0);for(let e=0;e<r.textureCount;e++){const t=this._renderTargets[e],i=this._textureManager.getTextureFromHandle(t);if(!i)throw new Error(`FrameGraphRenderTarget.renderTargetWrapper: Failed to get texture from handle. handle: ${t}, name: ${this.name}, index: ${e}, renderTargets: ${this._renderTargets}`);this._renderTargetWrapper.setTexture(i,e,!1)}void 0!==this._renderTargetDepth&&this._renderTargetWrapper.setDepthStencilTexture(this._textureManager.getTextureFromHandle(this._renderTargetDepth),!1)}return this._renderTargetWrapper}}equals(e){const t=this._renderTargets,i=e._renderTargets;if(void 0!==t&&void 0!==i){if(t.length!==i.length)return!1;for(let e=0;e<t.length;e++)if(t[e]!==i[e])return!1}else if(void 0===t&&void 0!==i||void 0!==t&&void 0===i)return!1;return this._renderTargetDepth===e._renderTargetDepth}}var dh,ph,mh,fh=i(28086);!function(e){e[e.Task=0]="Task",e[e.Graph=1]="Graph",e[e.External=2]="External"}(dh||(dh={}));class _h{constructor(e,t=!1,i){this.engine=e,this._debugTextures=t,this._scene=i,this._textures=new Map,this._historyTextures=new Map,this._isRecordingTask=!1,this.showDebugLogsForTextureAllcationOptimization=!1,this._addSystemTextures()}isBackbuffer(e){if(e===Ql||e===Kl)return!0;const t=this._textures.get(e);return!!t&&(t.refHandle===Ql||t.refHandle===Kl)}isBackbufferColor(e){if(e===Ql)return!0;const t=this._textures.get(e);return!!t&&t.refHandle===Ql}isBackbufferDepthStencil(e){if(e===Kl)return!0;const t=this._textures.get(e);return!!t&&t.refHandle===Kl}isHistoryTexture(e){const t=this._textures.get(e);return!!t&&(e=t.refHandle??e,this._historyTextures.has(e))}getTextureCreationOptions(e){const t=this._textures.get(e),i=t.creationOptions;return{size:hh(i.size)?{...i.size}:i.size,sizeIsPercentage:i.sizeIsPercentage,options:_h.CloneTextureOptions(i.options,t.textureIndex),isHistoryTexture:i.isHistoryTexture}}getTextureDescription(e){const t=this.getTextureCreationOptions(e);return{size:t.sizeIsPercentage?this.getAbsoluteDimensions(t.size):hh(t.size)?t.size:{width:t.size,height:t.size},options:t.options}}getTextureHandleOrCreateTexture(e,t,i){if(void 0===e){if(void 0===t||void 0===i)throw new Error("getTextureHandleOrCreateTexture: Either handle or newTextureName and creationOptions must be provided.");return this.createRenderTargetTexture(t,i)}return e}getTextureFromHandle(e){const t=this._historyTextures.get(e);return t?t.textures[1^t.index]:this._textures.get(e).texture}importTexture(e,t,i){void 0!==i&&this._freeEntry(i);const r={size:{width:t.width,height:t.height},sizeIsPercentage:!1,isHistoryTexture:!1,options:{createMipMaps:t.generateMipMaps,samples:t.samples,types:[t.type],formats:[t.format],useSRGBBuffers:[t._useSRGBBuffer],creationFlags:[t._creationFlags],labels:t.label?[t.label]:["imported"]}};return this._createHandleForTexture(e,t,r,dh.External,i)}createRenderTargetTexture(e,t,i){return this._createHandleForTexture(e,null,{size:hh(t.size)?{...t.size}:t.size,sizeIsPercentage:t.sizeIsPercentage,isHistoryTexture:t.isHistoryTexture,options:_h.CloneTextureOptions(t.options,void 0,!0)},this._isRecordingTask?dh.Task:dh.Graph,i)}createRenderTarget(e,t,i){const r=new uh(e,this,t,i),s=r.renderTargetWrapper;if(void 0!==s&&t){const e=Array.isArray(t)?t:[t];for(let t=0;t<e.length;t++){let i=e[t];i=this._textures.get(i)?.refHandle??i;const r=this._historyTextures.get(i);r&&(r.references.push({renderTargetWrapper:s,textureIndex:t}),s.setTexture(r.textures[r.index],t,!1))}}return r}createDanglingHandle(){return _h._Counter++}resolveDanglingHandle(e,t,i,r){if(void 0===t){if(void 0===i||void 0===r)throw new Error("resolveDanglingHandle: Either handle or newTextureName and creationOptions must be provided.");return void this.createRenderTargetTexture(i,r,e)}const s=this._textures.get(t);if(void 0===s)throw new Error(`resolveDanglingHandle: Handle ${t} does not exist!`);this._textures.set(e,{texture:s.texture,refHandle:t,name:s.name,creationOptions:{size:{...s.creationOptions.size},options:_h.CloneTextureOptions(s.creationOptions.options),sizeIsPercentage:s.creationOptions.sizeIsPercentage,isHistoryTexture:!1},namespace:s.namespace,textureIndex:s.textureIndex})}getAbsoluteDimensions(e,t=this.engine.getRenderWidth(!0),i=this.engine.getRenderHeight(!0)){const{width:r,height:s}=ch(e);return{width:Math.floor(r*t/100),height:Math.floor(s*i/100)}}computeTotalTextureSize(e,t,i){let r=0;return this._textures.forEach(((s,n)=>{if(n===Ql||n===Kl||void 0!==s.refHandle)return;if(e&&void 0!==s.aliasHandle)return;const o=s.creationOptions,a=s.textureIndex||0,l=o.sizeIsPercentage?this.getAbsoluteDimensions(o.size,t,i):ch(o.size),h=_h._GetTextureBlockInformation(o.options.types?.[a]??0,o.options.formats[a]),c=Math.ceil(l.width/h.width)*Math.ceil(l.height/h.height)*h.length;let u=c;o.options.createMipMaps&&(u=Math.floor(4*u/3)),(o.options.samples||1)>1&&(u+=c),r+=u})),r}_dispose(){this._releaseTextures()}_allocateTextures(e){e&&this._optimizeTextureAllocation(e),this._textures.forEach((e=>{if(!e.texture)if(void 0!==e.refHandle){const t=this._textures.get(e.refHandle);e.texture=t.texture,t.refHandle===Ql&&(e.refHandle=Ql),t.refHandle===Kl&&(e.refHandle=Kl)}else if(e.namespace!==dh.External)if(void 0!==e.aliasHandle){const t=this._textures.get(e.aliasHandle);e.texture=t.texture,e.texture.incrementReferences()}else{const t=e.creationOptions,i=t.sizeIsPercentage?this.getAbsoluteDimensions(t.size):t.size,r=e.textureIndex||0,s={createMipMaps:t.options.createMipMaps,samples:t.options.samples,type:t.options.types?.[r],format:t.options.formats?.[r],useSRGBBuffer:t.options.useSRGBBuffers?.[r],creationFlags:t.options.creationFlags?.[r],label:t.options.labels?.[r]??`${e.name}${r>0?"#"+r:""}`,samplingMode:1,createMSAATexture:t.options.samples>1},n=(0,fh.vl)(s.format),o=(0,fh.$l)(s.format),a=n&&o?12:n||o?14:5,l=this.engine._createInternalTexture(i,s,!1,a);n&&(l.type=(0,fh.GX)(l.format)),e.texture=l}e.texture&&void 0===e.refHandle&&(e.debug?.dispose(),e.debug=this._createDebugTexture(e.name,e.texture))})),this._historyTextures.forEach((e=>{for(let t=0;t<e.handles.length;t++)e.textures[t]=this._textures.get(e.handles[t]).texture}))}_releaseTextures(e=!0){this._textures.forEach(((t,i)=>{t.lifespan&&(t.lifespan.firstTask=Number.MAX_VALUE,t.lifespan.lastTask=0),t.aliasHandle=void 0,(e||t.namespace!==dh.External)&&(t.debug?.dispose(),t.debug=void 0),t.namespace!==dh.External&&(t.texture?.dispose(),t.texture=null,(e||t.namespace===dh.Task)&&this._textures.delete(i))})),this._historyTextures.forEach((e=>{for(let t=0;t<e.handles.length;t++)e.textures[t]=null})),e&&(this._textures.clear(),this._historyTextures.clear(),this._addSystemTextures())}_updateHistoryTextures(){this._historyTextures.forEach((e=>{e.index=1^e.index;const t=e.textures[e.index];if(t)for(const{renderTargetWrapper:i,textureIndex:r}of e.references)i.setTexture(t,r,!1)}))}_addSystemTextures(){const e={width:this.engine.getRenderWidth(!0),height:this.engine.getRenderHeight(!0)};this._textures.set(Ql,{name:"backbuffer color",texture:null,creationOptions:{size:e,options:{createMipMaps:!1,samples:this.engine.getCreationOptions().antialias?4:1,types:[0],formats:[5],useSRGBBuffers:[!1],creationFlags:[0],labels:["backbuffer color"]},sizeIsPercentage:!1},namespace:dh.External}),this._textures.set(Kl,{name:"backbuffer depth/stencil",texture:null,creationOptions:{size:e,options:{createMipMaps:!1,samples:this.engine.getCreationOptions().antialias?4:1,types:[0],formats:[16],useSRGBBuffers:[!1],creationFlags:[0],labels:["backbuffer depth/stencil"]},sizeIsPercentage:!1},namespace:dh.External})}_createDebugTexture(e,t){if(!this._debugTextures)return;const i=new $e.g(null,this._scene);return i.name=e,i._texture=t,i._texture.incrementReferences(),i}_freeEntry(e){const t=this._textures.get(e);t&&(t.debug?.dispose(),this._textures.delete(e))}_createHandleForTexture(e,t,i,r,s,n){s=s??_h._Counter++,n=n||0;const o=i.isHistoryTexture?`${e} ping`:e;let a=i.options.labels?.[n]??"";a===o&&(a="");const l={texture:t,name:`${o}${a?" "+a:""}`,creationOptions:{size:hh(i.size)?i.size:{width:i.size,height:i.size},options:i.options,sizeIsPercentage:i.sizeIsPercentage,isHistoryTexture:i.isHistoryTexture},namespace:r,textureIndex:n,textureDescriptionHash:this._createTextureDescriptionHash(i),lifespan:{firstTask:Number.MAX_VALUE,lastTask:0}};if(this._textures.set(s,l),r===dh.External)return s;if(i.isHistoryTexture){const t={size:{...l.creationOptions.size},options:{...l.creationOptions.options},sizeIsPercentage:l.creationOptions.sizeIsPercentage,isHistoryTexture:!1},i=this._createHandleForTexture(`${e} pong`,null,t,r);return this._historyTextures.set(s,{textures:[null,null],handles:[s,i],index:0,references:[]}),s}if(i.options.types&&i.options.types.length>1&&0===n){const e=i.options.types.length,t={size:hh(i.size)?i.size:{width:i.size,height:i.size},options:i.options,sizeIsPercentage:i.sizeIsPercentage};for(let i=1;i<e;i++)this._createHandleForTexture(o,null,t,r,s+i,i);_h._Counter+=e-1}return s}_createTextureDescriptionHash(e){const t=[];return t.push(hh(e.size)?`${e.size.width}_${e.size.height}`:`${e.size}`),t.push(e.sizeIsPercentage?"%":"A"),t.push(e.options.createMipMaps?"M":"N"),t.push(e.options.samples?`${e.options.samples}`:"S1"),t.push(e.options.types?e.options.types.join("_"):"0"),t.push(e.options.formats?e.options.formats.join("_"):"5"),t.push(e.options.useSRGBBuffers?e.options.useSRGBBuffers.join("_"):"false"),t.push(e.options.creationFlags?e.options.creationFlags.join("_"):"0"),t.join("_")}_optimizeTextureAllocation(e){this._computeTextureLifespan(e),this.showDebugLogsForTextureAllcationOptimization&&m.V.Log("================== Optimization of texture allocation ==================");const t=new Map,i=this._textures.keys();for(let e=i.next();!0!==e.done;e=i.next()){const i=e.value,r=this._textures.get(i);if(void 0!==r.refHandle||r.namespace===dh.External||this._historyTextures.has(i))continue;const s=r.textureDescriptionHash,n=r.lifespan,o=t.get(s);if(o){let e=!1;for(const t of o){const[s,o]=t;let a=!1;for(const e of o)if(e.firstTask<=n.lastTask&&e.lastTask>=n.firstTask){a=!0;break}if(!a){this.showDebugLogsForTextureAllcationOptimization&&m.V.Log(`Texture ${i} (${r.name}) reuses cache entry ${s}`),o.push(n),r.aliasHandle=s,e=!0;break}}e||o.push([i,[n]])}else t.set(s,[[i,[n]]])}}_computeTextureLifespan(e){this.showDebugLogsForTextureAllcationOptimization&&m.V.Log("================== Dump of texture dependencies for all tasks/passes ==================");for(let t=0;t<e.length;++t){const i=e[t];i.passes.length>0&&this._computeTextureLifespanForPasses(i,t,i.passes),i.passesDisabled.length>0&&this._computeTextureLifespanForPasses(i,t,i.passesDisabled),i.dependencies&&(this.showDebugLogsForTextureAllcationOptimization&&m.V.Log(`task#${t} (${i.name}), global dependencies`),this._updateLifespan(100*t+99,i.dependencies))}if(this.showDebugLogsForTextureAllcationOptimization){m.V.Log("================== Texture lifespans ==================");const e=this._textures.keys();for(let t=e.next();!0!==t.done;t=e.next()){const e=t.value,i=this._textures.get(e);void 0!==i.refHandle||i.namespace===dh.External||this._historyTextures.has(e)||m.V.Log(`${e} (${i.name}): ${i.lifespan.firstTask} - ${i.lifespan.lastTask}`)}}}_computeTextureLifespanForPasses(e,t,i){for(let r=0;r<i.length;++r){const s=new Set,n=i[r];th.IsRenderPass(n)&&(n.collectDependencies(s),this.showDebugLogsForTextureAllcationOptimization&&m.V.Log(`task#${t} (${e.name}), pass#${r} (${n.name})`),this._updateLifespan(100*t+r,s))}}_updateLifespan(e,t){const i=t.keys();for(let t=i.next();!0!==t.done;t=i.next()){const i=t.value;let r=this._textures.get(i);if(!r)throw new Error(`FrameGraph._computeTextureLifespan: Texture handle "${i}" not found in the texture manager.`);let s=i;for(;void 0!==r.refHandle;)if(s=r.refHandle,r=this._textures.get(s),!r)throw new Error(`FrameGraph._computeTextureLifespan: Texture handle "${s}" not found in the texture manager (source handle="${i}").`);r.namespace===dh.External||this._historyTextures.has(s)||(this.showDebugLogsForTextureAllcationOptimization&&m.V.Log(`    ${s} (${r.name})`),r.lifespan.firstTask=Math.min(r.lifespan.firstTask,e),r.lifespan.lastTask=Math.max(r.lifespan.lastTask,e))}}static CloneTextureOptions(e,t,i){return void 0!==t?{createMipMaps:e.createMipMaps,samples:e.samples,types:e.types?[e.types[t]]:void 0,formats:e.formats?[e.formats[t]]:void 0,useSRGBBuffers:e.useSRGBBuffers?[e.useSRGBBuffers[t]]:void 0,creationFlags:e.creationFlags?[e.creationFlags[t]]:void 0,labels:e.labels?[e.labels[t]]:void 0}:{createMipMaps:e.createMipMaps,samples:e.samples,types:e.types?[...e.types]:void 0,formats:e.formats?[...e.formats]:void 0,useSRGBBuffers:e.useSRGBBuffers?[...e.useSRGBBuffers]:void 0,creationFlags:e.creationFlags?[...e.creationFlags]:void 0,labels:e.labels&&i?[...e.labels]:void 0}}static _GetTextureBlockInformation(e,t){switch(t){case 15:return{width:1,height:1,length:2};case 16:return{width:1,height:1,length:3};case 13:case 14:return{width:1,height:1,length:4};case 18:return{width:1,height:1,length:5};case 19:return{width:1,height:1,length:1};case 36492:case 36495:case 36494:case 33779:case 33778:case 37808:case 37496:return{width:4,height:4,length:16};case 33777:case 33776:case 36196:case 37492:return{width:4,height:4,length:8}}switch(e){case 3:case 0:switch(t){case 6:case 8:case 0:case 1:case 2:return{width:1,height:1,length:1};case 7:case 9:return{width:1,height:1,length:2};case 4:case 10:return{width:1,height:1,length:3};default:return{width:1,height:1,length:4}}case 4:case 5:switch(t){case 8:return{width:1,height:1,length:2};case 9:return{width:1,height:1,length:4};case 10:return{width:1,height:1,length:6};default:return{width:1,height:1,length:8}}case 6:case 7:switch(t){case 8:return{width:1,height:1,length:4};case 9:return{width:1,height:1,length:8};case 10:return{width:1,height:1,length:12};default:return{width:1,height:1,length:16}}case 1:switch(t){case 6:return{width:1,height:1,length:4};case 7:return{width:1,height:1,length:8};case 4:return{width:1,height:1,length:12};default:return{width:1,height:1,length:16}}case 2:switch(t){case 6:return{width:1,height:1,length:2};case 7:return{width:1,height:1,length:4};case 4:return{width:1,height:1,length:6};default:return{width:1,height:1,length:8}}case 10:return{width:1,height:1,length:2};case 13:case 14:return{width:1,height:1,length:4};case 8:case 9:return{width:1,height:1,length:2};case 11:return{width:1,height:1,length:4}}return{width:1,height:1,length:4}}}_h._Counter=2,function(e){e[e.Normal=0]="Normal",e[e.Render=1]="Render",e[e.Cull=2]="Cull"}(ph||(ph={}));class gh{get engine(){return this._engine}get scene(){return this._scene}get tasks(){return this._tasks}constructor(e,t=!1){this._tasks=[],this._currentProcessedTask=null,this._whenReadyAsyncCancel=null,this.optimizeTextureAllocation=!0,this.onBuildObservable=new s.cP,this._scene=e,this._engine=e.getEngine(),this.textureManager=new _h(this._engine,t,e),this._passContext=new ah,this._renderContext=new lh(this._engine,this.textureManager,e)}getTaskByName(e){return this._tasks.find((t=>t.name===e))}addTask(e){if(null!==this._currentProcessedTask)throw new Error(`FrameGraph.addTask: Can't add the task "${e.name}" while another task is currently building (task: ${this._currentProcessedTask.name}).`);this._tasks.push(e)}addPass(e,t=!1){return this._addPass(e,ph.Normal,t)}addRenderPass(e,t=!1){return this._addPass(e,ph.Render,t)}addCullPass(e,t=!1){return this._addPass(e,ph.Cull,t)}_addPass(e,t,i=!1){if(!this._currentProcessedTask)throw new Error("FrameGraph: A pass must be created during a Task.record execution only.");let r;switch(t){case ph.Render:r=new th(e,this._currentProcessedTask,this._renderContext,this._engine);break;case ph.Cull:r=new eh(e,this._currentProcessedTask,this._passContext,this._engine);break;default:r=new Jl(e,this._currentProcessedTask,this._passContext)}return this._currentProcessedTask._addPass(r,i),r}build(){this.textureManager._releaseTextures(!1);try{for(const e of this._tasks)e._reset(),this._currentProcessedTask=e,this.textureManager._isRecordingTask=!0,e.record(),this.textureManager._isRecordingTask=!1,this._currentProcessedTask=null;this.textureManager._allocateTextures(this.optimizeTextureAllocation?this._tasks:void 0);for(const e of this._tasks)e._checkTask();for(const e of this._tasks)e.onTexturesAllocatedObservable.notifyObservers(this._renderContext);this.onBuildObservable.notifyObservers(this)}catch(e){throw this._tasks.length=0,this._currentProcessedTask=null,this.textureManager._isRecordingTask=!1,e}}whenReadyAsync(e=16,t=3e4){let i=null;return new Promise((r=>{this._whenReadyAsyncCancel=(0,us.F)((()=>{let e=this._renderContext._isReady();for(const t of this._tasks){const r=t.isReady();r||i||(i=t),e&&(e=r)}return e}),(()=>{this._whenReadyAsyncCancel=null,r()}),((e,t)=>{this._whenReadyAsyncCancel=null,t?(m.V.Error("FrameGraph: Timeout while waiting for the frame graph to be ready."+(i?` First task not ready: ${i.name}`:"")),e&&m.V.Error(e)):(m.V.Error("FrameGraph: An unexpected error occurred while waiting for the frame graph to be ready."),e&&(m.V.Error(e),e.stack&&m.V.Error(e.stack)))}),e,t)}))}execute(){this._renderContext.bindRenderTarget(),this.textureManager._updateHistoryTextures();for(const e of this._tasks){const t=e._getPasses();for(const e of t)e._execute()}}clear(){this._whenReadyAsyncCancel?.(),this._whenReadyAsyncCancel=null;for(const e of this._tasks)e._reset();this._tasks.length=0,this.textureManager._releaseTextures(),this._currentProcessedTask=null}dispose(){this._whenReadyAsyncCancel?.(),this._whenReadyAsyncCancel=null,this.clear(),this.textureManager._dispose(),this._renderContext._dispose()}}function xh(e,t=0,i="PROPERTIES",r){return(s,n)=>{let o=s._propStore;o||(o=[],s._propStore=o),o.push({propertyName:n,displayName:e,type:t,groupName:i,options:r??{},className:s.getClassName()})}}!function(e){e[e.Boolean=0]="Boolean",e[e.Float=1]="Float",e[e.Int=2]="Int",e[e.Vector2=3]="Vector2",e[e.List=4]="List",e[e.Color4=5]="Color4",e[e.SamplingMode=6]="SamplingMode",e[e.TextureFormat=7]="TextureFormat",e[e.TextureType=8]="TextureType"}(mh||(mh={}));class vh extends Zl{get type(){return this._type}constructor(e,t,i,r=Wl.Undefined){super(e,t,i),this._storedValue=null,this._type=Wl.Undefined,this.onValueChangedObservable=new s.cP,this.isExternal=!1,this._type=r,this._isInput=!0,this.registerOutput("output",r),this.setDefaultValue()}setDefaultValue(){switch(this.type){case Wl.Texture:case Wl.TextureViewDepth:case Wl.TextureScreenDepth:case Wl.TextureViewNormal:case Wl.TextureWorldNormal:case Wl.TextureAlbedo:case Wl.TextureReflectivity:case Wl.TextureLocalPosition:case Wl.TextureWorldPosition:case Wl.TextureVelocity:case Wl.TextureLinearVelocity:case Wl.TextureIrradiance:case Wl.TextureAlbedoSqrt:{const e={size:{width:100,height:100},options:{createMipMaps:!1,types:[0],formats:[5],samples:1,useSRGBBuffers:[!1]},sizeIsPercentage:!0};this.creationOptions=e;break}case Wl.TextureDepthStencilAttachment:{const e={size:{width:100,height:100},options:{createMipMaps:!1,types:[0],formats:[13],useSRGBBuffers:[!1],labels:[this.name],samples:1},sizeIsPercentage:!0};this.creationOptions=e;break}case Wl.ObjectList:this.value={meshes:[],particleSystems:[]},this.isExternal=!0;break;case Wl.Camera:this.value=this._scene.cameras[0],this.isExternal=!0;break;default:this.isExternal=!0}}get value(){return this._storedValue}set value(e){this._storedValue=e,this.output.value=void 0,this.onValueChangedObservable.notifyObservers(this)}getTypedValue(){return this._storedValue}getInternalTextureFromValue(){return this._storedValue._swapAndDie?this._storedValue:null}getClassName(){return"NodeRenderGraphInputBlock"}get output(){return this._outputs[0]}isAnyTexture(){return!!(this.type&Wl.TextureAll)}isBackBuffer(){return!!(this.type&Wl.TextureBackBuffer)}isBackBufferDepthStencilAttachment(){return!!(this.type&Wl.TextureBackBufferDepthStencilAttachment)}isCamera(){return!!(this.type&Wl.Camera)}isObjectList(){return!!(this.type&Wl.ObjectList)}isShadowLight(){return!!(this.type&Wl.ShadowLight)}_buildBlock(e){if(super._buildBlock(e),this.isExternal)if(this.isBackBuffer())this.output.value=Ql;else if(this.isBackBufferDepthStencilAttachment())this.output.value=Kl;else if(this.isCamera())this.output.value=this.getTypedValue();else if(this.isObjectList())this.output.value=this.getTypedValue();else if(this.isShadowLight())this.output.value=this.getTypedValue();else{if(void 0===this._storedValue||null===this._storedValue)throw new Error(`NodeRenderGraphInputBlock: External input "${this.name}" is not set`);const e=this.getInternalTextureFromValue();e&&(this.output.value=this._frameGraph.textureManager.importTexture(this.name,e,this.output.value))}else if(this.type&Wl.TextureAllButBackBuffer){const e=this.creationOptions;if(!e)throw new Error(`NodeRenderGraphInputBlock: Creation options are missing for texture "${this.name}"`);this.output.value=this._frameGraph.textureManager.createRenderTargetTexture(this.name,e)}}dispose(){this._storedValue=null,this.onValueChangedObservable.clear(),super.dispose()}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.isExternal = ${this.isExternal};`),this.isAnyTexture()?this.isExternal?e.push(`${this._codeVariableName}.value = EXTERNAL_TEXTURE; // TODO: set the external texture`):e.push(`${this._codeVariableName}.creationOptions = ${JSON.stringify(this.creationOptions)};`):this.isCamera()?e.push(`${this._codeVariableName}.value = EXTERNAL_CAMERA; // TODO: set the external camera`):this.isObjectList()?e.push(`${this._codeVariableName}.value = EXTERNAL_OBJECT_LIST; // TODO: set the external object list`):this.isShadowLight()&&e.push(`${this._codeVariableName}.value = EXTERNAL_SHADOW_LIGHT; // TODO: set the external shadow light`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.type=this.type,e.isExternal=this.isExternal,this.creationOptions&&(e.creationOptions=this.creationOptions),e}_deserialize(e){super._deserialize(e),this._type=e.type,this.output.type=this._type,this.isExternal=e.isExternal,e.creationOptions&&(void 0!==e.creationOptions.options.depthTextureFormat&&(e.creationOptions.options.formats=[e.creationOptions.options.depthTextureFormat]),this.creationOptions=e.creationOptions)}}(0,Ge.Cg)([xh("Is external",0,"PROPERTIES")],vh.prototype,"isExternal",void 0),(0,a.Y5)("BABYLON.NodeRenderGraphInputBlock",vh);class Sh extends ih{constructor(e,t){super(e,t),this.color=new o.ov(.2,.2,.3,1),this.clearColor=!0,this.clearDepth=!1,this.clearStencil=!1,this.outputTexture=this._frameGraph.textureManager.createDanglingHandle(),this.outputDepthTexture=this._frameGraph.textureManager.createDanglingHandle()}record(){if(void 0===this.targetTexture&&void 0===this.depthTexture)throw new Error(`FrameGraphClearTextureTask ${this.name}: targetTexture and depthTexture can't both be undefined.`);let e=0,t=0;if(void 0!==this.targetTexture&&(e=this._frameGraph.textureManager.getTextureDescription(this.targetTexture).options.samples||1,this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture)),void 0!==this.depthTexture&&(t=this._frameGraph.textureManager.getTextureDescription(this.depthTexture).options.samples||1,this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthTexture,this.depthTexture)),e!==t&&0!==e&&0!==t)throw new Error(`FrameGraphClearTextureTask ${this.name}: the depth texture and the target texture must have the same number of samples.`);const i=this._frameGraph.addRenderPass(this.name);i.setRenderTarget(this.targetTexture),i.setRenderTargetDepth(this.depthTexture),i.setExecuteFunc((e=>{e.clear(this.color,!!this.clearColor,!!this.clearDepth,!!this.clearStencil)}));const r=this._frameGraph.addRenderPass(this.name+"_disabled",!0);return r.setRenderTarget(this.targetTexture),r.setRenderTargetDepth(this.depthTexture),r.setExecuteFunc((e=>{})),i}}class bh extends Zl{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("target",Wl.Texture,!0),this.registerInput("depth",Wl.TextureBackBufferDepthStencilAttachment,!0),this._addDependenciesInput(),this.registerOutput("output",Wl.BasedOnInput),this.registerOutput("outputDepth",Wl.BasedOnInput),this.target.addAcceptedConnectionPointTypes(Wl.TextureAll),this.depth.addAcceptedConnectionPointTypes(Wl.TextureDepthStencilAttachment),this.output._typeConnectionSource=this.target,this.outputDepth._typeConnectionSource=this.depth,this._frameGraphTask=new Sh(e,t)}get color(){return this._frameGraphTask.color}set color(e){this._frameGraphTask.color=e}get clearColor(){return!!this._frameGraphTask.clearColor}set clearColor(e){this._frameGraphTask.clearColor=e}get clearDepth(){return!!this._frameGraphTask.clearDepth}set clearDepth(e){this._frameGraphTask.clearDepth=e}get clearStencil(){return!!this._frameGraphTask.clearStencil}set clearStencil(e){this._frameGraphTask.clearStencil=e}getClassName(){return"NodeRenderGraphClearBlock"}get target(){return this._inputs[0]}get depth(){return this._inputs[1]}get output(){return this._outputs[0]}get outputDepth(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e),this._propagateInputValueToOutput(this.target,this.output),this._propagateInputValueToOutput(this.depth,this.outputDepth),this._frameGraphTask.targetTexture=this.target.connectedPoint?.value,this._frameGraphTask.depthTexture=this.depth.connectedPoint?.value}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.color = new BABYLON.Color4(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.color.a});`),e.push(`${this._codeVariableName}.clearColor = ${this.clearColor};`),e.push(`${this._codeVariableName}.clearDepth = ${this.clearDepth};`),e.push(`${this._codeVariableName}.clearStencil = ${this.clearStencil};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.color=this.color.asArray(),e.clearColor=this.clearColor,e.clearDepth=this.clearDepth,e.clearStencil=this.clearStencil,e}_deserialize(e){super._deserialize(e),this.color=o.ov.FromArray(e.color),this.clearColor=e.clearColor,this.clearDepth=e.clearDepth,this.clearStencil=e.clearStencil}}(0,Ge.Cg)([xh("Color",5)],bh.prototype,"color",null),(0,Ge.Cg)([xh("Clear color",0,void 0,{embedded:!0})],bh.prototype,"clearColor",null),(0,Ge.Cg)([xh("Clear depth",0,void 0,{embedded:!0})],bh.prototype,"clearDepth",null),(0,Ge.Cg)([xh("Clear stencil",0,void 0,{embedded:!0})],bh.prototype,"clearStencil",null),(0,a.Y5)("BABYLON.NodeRenderGraphClearBlock",bh);var yh=i(81283),Ph=i(45503);class Th extends Bi.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,12850)),Promise.resolve().then(i.bind(i,85417))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,54509)),Promise.resolve().then(i.bind(i,83802))]))}constructor(e,t=null,i,r,s){const n=!!s?.blockCompilation;super({...s,name:e,engine:t||Vi.Engine.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Th.FragmentUrl,uniforms:Th.Uniforms,samplers:Th.Samplers,vertexUrl:Th.VertexUrl,blockCompilation:!0}),this._packedFloat=!1,this._staticDefines="",this.textureWidth=0,this.textureHeight=0,this.options.blockCompilation=n,void 0!==i&&(this.direction=i),void 0!==r&&(this.kernel=r)}set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this.options.blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this.options.blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}bind(){super.bind(),this._drawWrapper.effect.setFloat2("delta",1/this.textureWidth*this.direction.x,1/this.textureHeight*this.direction.y)}_updateParameters(e,t){const i=this._kernel,r=(i-1)/2;let s=[],n=[],o=0;for(let e=0;e<i;e++){const t=e/(i-1),a=this._gaussianWeight(2*t-1);s[e]=e-r,n[e]=a,o+=a}for(let e=0;e<n.length;e++)n[e]/=o;const a=[],l=[],h=[];for(let e=0;e<=r;e+=2){const t=Math.min(e+1,Math.floor(r));if(e===t)h.push({o:s[e],w:n[e]});else{const i=t===r,o=n[e]+n[t]*(i?.5:1),a=s[e]+1/(1+n[e]/n[t]);0===a?(h.push({o:s[e],w:n[e]}),h.push({o:s[e+1],w:n[e+1]})):(h.push({o:a,w:o}),h.push({o:-a,w:o}))}}for(let e=0;e<h.length;e++)l[e]=h[e].o,a[e]=h[e].w;s=l,n=a;const c=this.options.engine.getCaps().maxVaryingVectors-(1===this.options.shaderLanguage?1:0),u=Math.max(c,0)-1;let d=Math.min(s.length,u),p="";p+=this._staticDefines,-1!=this._staticDefines.indexOf("DOF")&&(p+=`#define CENTER_WEIGHT ${this._glslFloat(n[d-1])}\n`,d--);for(let e=0;e<d;e++)p+=`#define KERNEL_OFFSET${e} ${this._glslFloat(s[e])}\n`,p+=`#define KERNEL_WEIGHT${e} ${this._glslFloat(n[e])}\n`;let m=0;for(let e=u;e<s.length;e++)p+=`#define KERNEL_DEP_OFFSET${m} ${this._glslFloat(s[e])}\n`,p+=`#define KERNEL_DEP_WEIGHT${m} ${this._glslFloat(n[e])}\n`,m++;this.packedFloat&&(p+="#define PACKEDFLOAT 1"),this.options.blockCompilation=!1,this.updateEffect(p,null,null,{varyingCount:d,depCount:m},e,t)}_nearestBestKernel(e){const t=Math.round(e);for(const e of[t,t-1,t+1,t-2,t+2])if(e%2!=0&&Math.floor(e/2)%2==0&&e>0)return Math.max(e,3);return Math.max(t,3)}_gaussianWeight(e){const t=1/3,i=-e*e/(2*t*t);return 1/(Math.sqrt(2*Math.PI)*t)*Math.exp(i)}_glslFloat(e,t=8){return e.toFixed(t).replace(/0+$/,"")}}Th.VertexUrl="kernelBlur",Th.FragmentUrl="kernelBlur",Th.Uniforms=["delta","direction"],Th.Samplers=["circleOfConfusionSampler"];class Ch extends Fi.w{get direction(){return this._effectWrapper.direction}set direction(e){this._effectWrapper.direction=e}set kernel(e){this._effectWrapper.kernel=e}get kernel(){return this._effectWrapper.kernel}set packedFloat(e){this._effectWrapper.packedFloat=e}get packedFloat(){return this._effectWrapper.packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,t,i,r,s=null,n=$e.g.BILINEAR_SAMPLINGMODE,o,a,l=0,h="",c=!1,u=5){const d="number"==typeof r?c:!!r.blockCompilation,p={uniforms:Th.Uniforms,samplers:Th.Samplers,size:"number"==typeof r?r:void 0,camera:s,samplingMode:n,engine:o,reusable:a,textureType:l,vertexUrl:Th.VertexUrl,indexParameters:{varyingCount:0,depCount:0},textureFormat:u,defines:h,...r,blockCompilation:!0};super(e,Th.FragmentUrl,{effectWrapper:"number"!=typeof r&&r.effectWrapper?void 0:new Th(e,o,void 0,void 0,p),...p}),this._effectWrapper.options.blockCompilation=d,this.direction=t,this.onApplyObservable.add((()=>{this._effectWrapper.textureWidth=this._outputTexture?this._outputTexture.width:this.width,this._effectWrapper.textureHeight=this._outputTexture?this._outputTexture.height:this.height})),this.kernel=i}updateEffect(e=null,t=null,i=null,r,s,n){this._effectWrapper._updateParameters(s,n)}static _Parse(e,t,i,r){return Ue.p.Parse((()=>new Ch(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,void 0,!1)),e,i,r)}}(0,Ge.Cg)([(0,ze.WM)()],Ch.prototype,"direction",null),(0,Ge.Cg)([(0,ze.lK)()],Ch.prototype,"kernel",null),(0,Ge.Cg)([(0,ze.lK)()],Ch.prototype,"packedFloat",null),(0,a.Y5)("BABYLON.BlurPostProcess",Ch);var Eh=i(15808),Ah=i(35476);class Ih{get bias(){return this._bias}set bias(e){this._bias=e}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())}get depthScale(){return void 0!==this._depthScale?this._depthScale:this._light.getDepthScale()}set depthScale(e){this._depthScale=e}_validateFilter(e){return e}get filter(){return this._filter}set filter(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===Ih.FILTER_BLUREXPONENTIALSHADOWMAP)return void(this.useExponentialShadowMap=!0);if(e===Ih.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)return void(this.useCloseExponentialShadowMap=!0);if(e===Ih.FILTER_PCF||e===Ih.FILTER_PCSS)return void(this.usePoissonSampling=!0)}e!==Ih.FILTER_PCF&&e!==Ih.FILTER_PCSS||this._scene.getEngine()._features.supportShadowSamplers?this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty()):this.usePoissonSampling=!0}get usePoissonSampling(){return this.filter===Ih.FILTER_POISSONSAMPLING}set usePoissonSampling(e){const t=this._validateFilter(Ih.FILTER_POISSONSAMPLING);(e||this.filter===Ih.FILTER_POISSONSAMPLING)&&(this.filter=e?t:Ih.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===Ih.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(e){const t=this._validateFilter(Ih.FILTER_EXPONENTIALSHADOWMAP);(e||this.filter===Ih.FILTER_EXPONENTIALSHADOWMAP)&&(this.filter=e?t:Ih.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===Ih.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(e){const t=this._validateFilter(Ih.FILTER_BLUREXPONENTIALSHADOWMAP);(e||this.filter===Ih.FILTER_BLUREXPONENTIALSHADOWMAP)&&(this.filter=e?t:Ih.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===Ih.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(e){const t=this._validateFilter(Ih.FILTER_CLOSEEXPONENTIALSHADOWMAP);(e||this.filter===Ih.FILTER_CLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:Ih.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===Ih.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(e){const t=this._validateFilter(Ih.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);(e||this.filter===Ih.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:Ih.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===Ih.FILTER_PCF}set usePercentageCloserFiltering(e){const t=this._validateFilter(Ih.FILTER_PCF);(e||this.filter===Ih.FILTER_PCF)&&(this.filter=e?t:Ih.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===Ih.FILTER_PCSS}set useContactHardeningShadow(e){const t=this._validateFilter(Ih.FILTER_PCSS);(e||this.filter===Ih.FILTER_PCSS)&&(this.filter=e?t:Ih.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(e){this._contactHardeningLightSizeUVRatio=e}get darkness(){return this._darkness}set darkness(e){this.setDarkness(e)}getDarkness(){return this._darkness}setDarkness(e){return this._darkness=e>=1?1:e<=0?0:e,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){this.setTransparencyShadow(e)}setTransparencyShadow(e){return this._transparencyShadow=e,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return Ih.CLASSNAME}addShadowCaster(e,t=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),-1===this._shadowMap.renderList.indexOf(e)&&this._shadowMap.renderList.push(e),t)for(const t of e.getChildMeshes())-1===this._shadowMap.renderList.indexOf(t)&&this._shadowMap.renderList.push(t);return this}removeShadowCaster(e,t=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;const i=this._shadowMap.renderList.indexOf(e);if(-1!==i&&this._shadowMap.renderList.splice(i,1),t)for(const t of e.getChildren())this.removeShadowCaster(t);return this}getLight(){return this._light}get shaderLanguage(){return this._shaderLanguage}_getCamera(){return this._camera??this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}constructor(e,t,i,r,o,a=!1){this.onBeforeShadowMapRenderObservable=new s.cP,this.onAfterShadowMapRenderObservable=new s.cP,this.onBeforeShadowMapRenderMeshObservable=new s.cP,this.onAfterShadowMapRenderMeshObservable=new s.cP,this.doNotSerialize=!1,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=Ih.FILTER_NONE,this._filteringQuality=Ih.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this._shaderLanguage=0,this.forceBackFacesOnly=!1,this._lightDirection=n.Pq.Zero(),this._viewMatrix=n.uq.Zero(),this._projectionMatrix=n.uq.Zero(),this._transformMatrix=n.uq.Zero(),this._cachedPosition=new n.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new n.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=n.uq.Identity(),this._shadersLoaded=!1,this._mapSize=e,this._light=t,this._scene=t.getScene(),this._camera=r??null,this._useRedTextureType=!!o,this._initShaderSourceAsync(a);let l=t._shadowGenerators;l||(l=t._shadowGenerators=new Map),l.set(this._camera,this),this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),Ih._SceneComponentInitialization(this._scene);const h=this._scene.getEngine().getCaps();i?h.textureFloatRender&&h.textureFloatLinearFiltering?this._textureType=1:h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering?this._textureType=2:h.textureFloatRender&&h.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){const e=this._scene.getEngine();e._features.supportDepthStencilTexture?(this._shadowMap=new cr.$(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,`DepthStencilForShadowGenerator-${this._light.name}`)):this._shadowMap=new cr.$(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube()),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(this._createTargetRenderTexture(),null===this._shadowMap)return;this._shadowMap.wrapU=$e.g.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=$e.g.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode($e.g.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=(e,t,i,r)=>this._renderForShadowMap(e,t,i,r),this._shadowMap.customIsReadyFunction=(e,t,i)=>{if(!i||!e.subMeshes)return!0;let r=!0;for(const t of e.subMeshes){const e=t.getRenderingMesh(),i=this._scene.getEngine(),s=t.getMaterial();if(!s||0===t.verticesCount||this.customAllowRendering&&!this.customAllowRendering(t))continue;const n=e._getInstancesRenderList(t._id,!!t.getReplacementMesh());if(n.mustReturn)continue;const o=i.getCaps().instancedArrays&&(null!==n.visibleInstances[t._id]&&void 0!==n.visibleInstances[t._id]||e.hasThinInstances),a=s.needAlphaBlendingForMesh(e);r=this.isReady(t,o,a)&&r}return r};const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add((()=>{this._currentSceneUBO=this._scene.getSceneUniformBuffer(),e._debugPushGroup?.(`shadow map generation for pass id ${e.currentRenderPassId}`,1)})),this._shadowMap.onBeforeRenderObservable.add((t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=t,this._filter===Ih.FILTER_PCF&&e.setColorWrite(!1),this.getTransformMatrix(),this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())})),this._shadowMap.onAfterUnbindObservable.add((()=>{if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._scene.updateTransformMatrix(),this._filter===Ih.FILTER_PCF&&e.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap)return void e._debugPopGroup?.(1);const t=this.getShadowMapForRendering();t&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,t.renderTarget,!0),e.unBindFramebuffer(t.renderTarget,!0)),e._debugPopGroup?.(1)}));const t=new o.ov(0,0,0,0),i=new o.ov(1,1,1,1);this._shadowMap.onClearObservable.add((e=>{this._filter===Ih.FILTER_PCF?e.clear(i,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e.clear(t,!0,!0,!1):e.clear(i,!0,!0,!1)})),this._shadowMap.onResizeObservable.add((e=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=e.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}));for(let e=Eh.m.MIN_RENDERINGGROUPS;e<Eh.m.MAX_RENDERINGGROUPS;e++)this._shadowMap.setRenderingAutoClearDepthStencil(e,!1)}async _initShaderSourceAsync(e=!1){!this._scene.getEngine().isWebGPU||e||Ih.ForceGLSL?await Promise.all([Promise.resolve().then(i.bind(i,70169)),Promise.resolve().then(i.bind(i,29468)),Promise.resolve().then(i.bind(i,69386)),Promise.resolve().then(i.bind(i,85426))]):(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,87428)),Promise.resolve().then(i.bind(i,32303)),Promise.resolve().then(i.bind(i,10355)),Promise.resolve().then(i.bind(i,95799))])),this._shadersLoaded=!0}_initializeBlurRTTAndPostProcesses(){const e=this._scene.getEngine(),t=this._mapSize/this.blurScale;this.useKernelBlur&&1===this.blurScale||(this._shadowMap2=new cr.$(this._light.name+"_shadowMap2",t,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=$e.g.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=$e.g.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode($e.g.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new Ch(this._light.name+"KernelBlurX",new n.I9(1,0),this.blurKernel,1,null,$e.g.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.width=t,this._kernelBlurXPostprocess.height=t,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._shadowMap)})),this._kernelBlurYPostprocess=new Ch(this._light.name+"KernelBlurY",new n.I9(0,1),this.blurKernel,1,null,$e.g.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,0===this._textureType&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new Fi.w(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,$e.g.BILINEAR_SAMPLINGMODE,e,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType,void 0,void 0,void 0,void 0,this._shaderLanguage),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add((e=>{e.setFloat2("screenSize",t,t),e.setTexture("textureSampler",this._shadowMap)})),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(e,t,i,r){let s;if(r.length)for(s=0;s<r.length;s++)this._renderSubMeshForShadowMap(r.data[s]);for(s=0;s<e.length;s++)this._renderSubMeshForShadowMap(e.data[s]);for(s=0;s<t.length;s++)this._renderSubMeshForShadowMap(t.data[s]);if(this._transparencyShadow)for(s=0;s<i.length;s++)this._renderSubMeshForShadowMap(i.data[s],!0);else for(s=0;s<i.length;s++)i.data[s].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(e,t,i){t.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(e,t=!1){const i=e.getRenderingMesh(),r=e.getEffectiveMesh(),s=this._scene,n=s.getEngine(),o=e.getMaterial();if(r._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!o||0===e.verticesCount||e._renderId===s.getRenderId())return;const a=s.useRightHandedSystem,l=r._getWorldMatrixDeterminant()<0;let h=o._getEffectiveOrientation(i);(l&&!a||!l&&a)&&(h=0===h?1:0);const c=0===h;n.setState(o.backFaceCulling,void 0,void 0,c,o.cullBackFaces);const u=i._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(u.mustReturn)return;const d=n.getCaps().instancedArrays&&(null!==u.visibleInstances[e._id]&&void 0!==u.visibleInstances[e._id]||i.hasThinInstances);if(!this.customAllowRendering||this.customAllowRendering(e))if(this.isReady(e,d,t)){e._renderId=s.getRenderId();const a=o.shadowDepthWrapper,l=a?.getEffect(e,this,n.currentRenderPassId)??e._getDrawWrapper(),h=Ah.E.GetEffect(l);n.enableEffect(l),d||i._bind(e,h,o.fillMode),this.getTransformMatrix(),h.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===Ns.v.LIGHTTYPEID_DIRECTIONALLIGHT?h.setVector3("lightDataSM",this._cachedDirection):h.setVector3("lightDataSM",this._cachedPosition);const c=this._getCamera();if(h.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(c),this.getLight().getDepthMinZ(c)+this.getLight().getDepthMaxZ(c)),t&&this.enableSoftTransparentShadow&&h.setFloat2("softTransparentShadowSM",r.visibility*o.alpha,this._opacityTexture?.getAlphaFromRGB?1:0),a)e._setMainDrawWrapperOverride(l),a.standalone?a.baseMaterial.bindForSubMesh(r.getWorldMatrix(),i,e):o.bindForSubMesh(r.getWorldMatrix(),i,e),e._setMainDrawWrapperOverride(null);else{if(this._opacityTexture&&(h.setTexture("diffuseSampler",this._opacityTexture),h.setMatrix("diffuseMatrix",this._opacityTexture.getTextureMatrix()||this._defaultTextureMatrix)),i.useBones&&i.computeBonesUsingShaders&&i.skeleton){const e=i.skeleton;if(e.isUsingTextureForMatrices){const t=e.getTransformMatrixTexture(i);if(!t)return;h.setTexture("boneSampler",t),h.setFloat("boneTextureWidth",4*(e.bones.length+1))}else h.setMatrices("mBones",e.getTransformMatrices(i))}(0,ts.nR)(i,h),i.morphTargetManager&&i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(h);const t=e.getMesh().bakedVertexAnimationManager;t&&t.isEnabled&&t.bind(h,d),(0,es.gS)(h,o,s)}this._useUBO||a||this._bindCustomEffectForRenderSubMeshForShadowMap(e,h,r),(0,ts._8)(h,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();const p=r.getWorldMatrix();d&&(r.getMeshUniformBuffer().bindToEffect(h,"Mesh"),r.transferToEffect(p)),this.forceBackFacesOnly&&n.setState(!0,0,!1,!0,o.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(i),this.onBeforeShadowMapRenderObservable.notifyObservers(h),i._processRendering(r,e,h,o.fillMode,u,d,((e,t)=>{r===i||e?(r.getMeshUniformBuffer().bindToEffect(h,"Mesh"),r.transferToEffect(e?t:p)):(i.getMeshUniformBuffer().bindToEffect(h,"Mesh"),i.transferToEffect(t))})),this.forceBackFacesOnly&&n.setState(!0,0,!1,!1,o.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(h),this.onAfterShadowMapRenderMeshObservable.notifyObservers(i)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){this._shadowMap&&(this.filter===Ih.FILTER_NONE||this.filter===Ih.FILTER_PCSS?this._shadowMap.updateSamplingMode($e.g.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode($e.g.BILINEAR_SAMPLINGMODE))}forceCompilation(e,t){const i={useInstances:!1,...t},r=this.getShadowMap();if(!r)return void(e&&e(this));const s=r.renderList;if(!s)return void(e&&e(this));const n=[];for(const e of s)n.push(...e.subMeshes);if(0===n.length)return void(e&&e(this));let o=0;const a=()=>{if(this._scene&&this._scene.getEngine()){for(;this.isReady(n[o],i.useInstances,n[o].getMaterial()?.needAlphaBlendingForMesh(n[o].getMesh())??!1);)if(o++,o>=n.length)return void(e&&e(this));setTimeout(a,16)}};a()}forceCompilationAsync(e){return new Promise((t=>{this.forceCompilation((()=>{t()}),e)}))}_isReadyCustomDefines(e,t,i){}_prepareShadowDefines(e,t,i,r){i.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),i.push("#define SM_FLOAT "+(0!==this._textureType?"1":"0")),i.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),i.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));const s=e.getMesh();return i.push("#define SM_NORMALBIAS "+(this.normalBias&&s.isVerticesDataPresent(Ot.R.NormalKind)?"1":"0")),i.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===Ns.v.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),i.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),i.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&r?"1":"0")),this._isReadyCustomDefines(i,e,t),i}isReady(e,t,i){if(!this._shadersLoaded)return!1;const r=e.getMaterial(),s=r?.shadowDepthWrapper;if(this._opacityTexture=null,!r)return!1;const n=[];if(this._prepareShadowDefines(e,t,n,i),s){if(!s.isReadyForSubMesh(e,n,this,t,this._scene.getEngine().currentRenderPassId))return!1}else{const i=e._getDrawWrapper(void 0,!0);let s=i.effect,o=i.defines;const a=[Ot.R.PositionKind],l=e.getMesh();let h=!1,c=!1,u=!1;const d=!1;this.normalBias&&l.isVerticesDataPresent(Ot.R.NormalKind)&&(a.push(Ot.R.NormalKind),n.push("#define NORMAL"),h=!0,l.nonUniformScaling&&n.push("#define NONUNIFORMSCALING"));const p=r.needAlphaTestingForMesh(l);if((p||r.needAlphaBlendingForMesh(l))&&(this.useOpacityTextureForTransparentShadow?this._opacityTexture=r.opacityTexture:this._opacityTexture=r.getAlphaTestTexture(),this._opacityTexture)){if(!this._opacityTexture.isReady())return!1;const e=r.alphaCutOff??Ih.DEFAULT_ALPHA_CUTOFF;n.push("#define ALPHATEXTURE"),p&&n.push(`#define ALPHATESTVALUE ${e}${e%1==0?".":""}`),l.isVerticesDataPresent(Ot.R.UVKind)&&(a.push(Ot.R.UVKind),n.push("#define UV1"),c=!0),l.isVerticesDataPresent(Ot.R.UV2Kind)&&1===this._opacityTexture.coordinatesIndex&&(a.push(Ot.R.UV2Kind),n.push("#define UV2"),u=!0)}const m=new Qr.J;if(l.useBones&&l.computeBonesUsingShaders&&l.skeleton){a.push(Ot.R.MatricesIndicesKind),a.push(Ot.R.MatricesWeightsKind),l.numBoneInfluencers>4&&(a.push(Ot.R.MatricesIndicesExtraKind),a.push(Ot.R.MatricesWeightsExtraKind));const e=l.skeleton;n.push("#define NUM_BONE_INFLUENCERS "+l.numBoneInfluencers),l.numBoneInfluencers>0&&m.addCPUSkinningFallback(0,l),e.isUsingTextureForMatrices?n.push("#define BONETEXTURE"):n.push("#define BonesPerMesh "+(e.bones.length+1))}else n.push("#define NUM_BONE_INFLUENCERS 0");const f=l.morphTargetManager?(0,ts.Dk)(l.morphTargetManager,n,a,l,!0,h,!1,c,u,d):0;if((0,es.tv)(r,this._scene,n),t&&(n.push("#define INSTANCES"),(0,ts.te)(a),e.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(const e of this.customShaderOptions.defines)-1===n.indexOf(e)&&n.push(e);const _=l.bakedVertexAnimationManager;_&&_.isEnabled&&(n.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&a.push("bakedVertexAnimationSettingsInstanced"));const g=n.join("\n");if(o!==g){o=g;let e="shadowMap";const t=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","morphTargetCount","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],r=["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"],n=["Scene","Mesh"];if((0,es.TV)(t),this.customShaderOptions){if(e=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(const e of this.customShaderOptions.attributes)-1===a.indexOf(e)&&a.push(e);if(this.customShaderOptions.uniforms)for(const e of this.customShaderOptions.uniforms)-1===t.indexOf(e)&&t.push(e);if(this.customShaderOptions.samplers)for(const e of this.customShaderOptions.samplers)-1===r.indexOf(e)&&r.push(e)}const l=this._scene.getEngine();s=l.createEffect(e,{attributes:a,uniformsNames:t,uniformBuffersNames:n,samplers:r,defines:g,fallbacks:m,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:f},shaderLanguage:this._shaderLanguage},l),i.setEffect(s,o)}if(!s.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(this._blurPostProcesses&&this._blurPostProcesses.length||this._initializeBlurRTTAndPostProcesses()),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady())&&(!(this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady())&&!(this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady()))}prepareDefines(e,t){const i=this._scene,r=this._light;i.shadowsEnabled&&r.shadowEnabled&&(e["SHADOW"+t]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=!0,this._filteringQuality===Ih.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===Ih.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=!0,this._filteringQuality===Ih.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===Ih.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=!0),r.needCube()&&(e["SHADOWCUBE"+t]=!0))}bindShadowLight(e,t){const i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;const r=this._getCamera(),s=this.getShadowMap();if(!s)return;i.needCube()||t.setMatrix("lightMatrix"+e,this.getTransformMatrix());const n=this.getShadowMapForRendering();this._filter===Ih.FILTER_PCF?(t.setDepthStencilTexture("shadowTexture"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),s.getSize().width,1/s.getSize().width,this.frustumEdgeFalloff,e)):this._filter===Ih.FILTER_PCSS?(t.setDepthStencilTexture("shadowTexture"+e,n),t.setTexture("depthTexture"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/s.getSize().width,this._contactHardeningLightSizeUVRatio*s.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowTexture"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/s.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(r),this.getLight().getDepthMinZ(r)+this.getLight().getDepthMaxZ(r),e)}get viewMatrix(){return this._viewMatrix}get projectionMatrix(){return this._projectionMatrix}getTransformMatrix(){const e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),n.Pq.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),1===Math.abs(n.Pq.Dot(this._lightDirection,n.Pq.Up()))&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),n.uq.LookAtLHToRef(t,t.add(this._lightDirection),n.Pq.Up(),this._viewMatrix);const e=this.getShadowMap();if(e){const t=e.renderList;t&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,t)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){const e=this._shadowMap;if(!e)return;const t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(const e of t)this._shadowMap.renderList.push(e)}else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){const e=this._light._shadowGenerators.entries();for(let t=e.next();!0!==t.done;t=e.next()){const[e,i]=t.value;i===this&&this._light._shadowGenerators.delete(e)}0===this._light._shadowGenerators.size&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){const e={},t=this.getShadowMap();if(!t)return e;if(e.className=this.getClassName(),e.lightId=this._light.id,e.cameraId=this._camera?.id,e.id=this.id,e.mapSize=t.getRenderSize(),e.forceBackFacesOnly=this.forceBackFacesOnly,e.darkness=this.getDarkness(),e.transparencyShadow=this._transparencyShadow,e.frustumEdgeFalloff=this.frustumEdgeFalloff,e.bias=this.bias,e.normalBias=this.normalBias,e.usePercentageCloserFiltering=this.usePercentageCloserFiltering,e.useContactHardeningShadow=this.useContactHardeningShadow,e.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,e.filteringQuality=this.filteringQuality,e.useExponentialShadowMap=this.useExponentialShadowMap,e.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,e.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.usePoissonSampling=this.usePoissonSampling,e.depthScale=this.depthScale,e.blurBoxOffset=this.blurBoxOffset,e.blurKernel=this.blurKernel,e.blurScale=this.blurScale,e.useKernelBlur=this.useKernelBlur,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){const r=t.renderList[i];e.renderList.push(r.id)}return e}static Parse(e,t,i){const r=t.getLightById(e.lightId),s=void 0!==e.cameraId?t.getCameraById(e.cameraId):null,n=i?i(e.mapSize,r,s):new Ih(e.mapSize,r,void 0,s),o=n.getShadowMap();for(let i=0;i<e.renderList.length;i++){t.getMeshesById(e.renderList[i]).forEach((function(e){o&&(o.renderList||(o.renderList=[]),o.renderList.push(e))}))}return void 0!==e.id&&(n.id=e.id),n.forceBackFacesOnly=!!e.forceBackFacesOnly,void 0!==e.darkness&&n.setDarkness(e.darkness),e.transparencyShadow&&n.setTransparencyShadow(!0),void 0!==e.frustumEdgeFalloff&&(n.frustumEdgeFalloff=e.frustumEdgeFalloff),void 0!==e.bias&&(n.bias=e.bias),void 0!==e.normalBias&&(n.normalBias=e.normalBias),e.usePercentageCloserFiltering?n.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?n.useContactHardeningShadow=!0:e.usePoissonSampling?n.usePoissonSampling=!0:e.useExponentialShadowMap?n.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?n.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?n.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?n.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?n.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(n.useBlurExponentialShadowMap=!0),void 0!==e.contactHardeningLightSizeUVRatio&&(n.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),void 0!==e.filteringQuality&&(n.filteringQuality=e.filteringQuality),e.depthScale&&(n.depthScale=e.depthScale),e.blurScale&&(n.blurScale=e.blurScale),e.blurBoxOffset&&(n.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(n.useKernelBlur=e.useKernelBlur),e.blurKernel&&(n.blurKernel=e.blurKernel),n}}Ih.CLASSNAME="ShadowGenerator",Ih.ForceGLSL=!1,Ih.FILTER_NONE=0,Ih.FILTER_EXPONENTIALSHADOWMAP=1,Ih.FILTER_POISSONSAMPLING=2,Ih.FILTER_BLUREXPONENTIALSHADOWMAP=3,Ih.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,Ih.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,Ih.FILTER_PCF=6,Ih.FILTER_PCSS=7,Ih.QUALITY_HIGH=0,Ih.QUALITY_MEDIUM=1,Ih.QUALITY_LOW=2,Ih.DEFAULT_ALPHA_CUTOFF=.5,Ih._SceneComponentInitialization=e=>{throw(0,Ph.n)("ShadowGeneratorSceneComponent")};var Rh=i(88852),Mh=i(9977);class Dh{get shaderLanguage(){return this._shaderLanguage}setMaterialForRendering(e,t){this._depthMap.setMaterialForRendering(e,t)}constructor(e,t=1,i=null,r=!1,s=$e.g.TRILINEAR_SAMPLINGMODE,n=!1,a){this._shaderLanguage=0,this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this.reverseCulling=!1,this._shadersLoaded=!1,this._scene=e,this._storeNonLinearDepth=r,this._storeCameraSpaceZ=n,this.isPacked=0===t,this.isPacked?this.clearColor=new o.ov(1,1,1,1):this.clearColor=new o.ov(n?1e8:1,0,0,1),this._initShaderSourceAsync(),Dh._SceneComponentInitialization(this._scene);const l=e.getEngine();this._camera=i,s!==$e.g.NEAREST_SAMPLINGMODE&&(1!==t||l._caps.textureFloatLinearFiltering||(s=$e.g.NEAREST_SAMPLINGMODE),2!==t||l._caps.textureHalfFloatLinearFiltering||(s=$e.g.NEAREST_SAMPLINGMODE));const h=this.isPacked||!l._features.supportExtendedTextureFormats?5:6;this._depthMap=new cr.$(a??"DepthRenderer",{width:l.getRenderWidth(),height:l.getRenderHeight()},this._scene,!1,!0,t,!1,s,void 0,void 0,void 0,h),this._depthMap.wrapU=$e.g.CLAMP_ADDRESSMODE,this._depthMap.wrapV=$e.g.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.noPrePassRenderer=!0,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add((e=>{e.clear(this.clearColor,!0,!0,!0)})),this._depthMap.onBeforeBindObservable.add((()=>{l._debugPushGroup?.("depth renderer",1)})),this._depthMap.onAfterUnbindObservable.add((()=>{l._debugPopGroup?.(1)})),this._depthMap.customIsReadyFunction=(e,t,i)=>{if((i||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){const i=e.subMeshes[t],r=i.getRenderingMesh(),s=r._getInstancesRenderList(i._id,!!i.getReplacementMesh()),n=l.getCaps().instancedArrays&&(null!==s.visibleInstances[i._id]&&void 0!==s.visibleInstances[i._id]||r.hasThinInstances);if(!this.isReady(i,n))return!1}return!0};const c=e=>{const t=e.getRenderingMesh(),i=e.getEffectiveMesh(),r=this._scene,s=r.getEngine(),n=e.getMaterial();if(i._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!n||i.infiniteDistance||n.disableDepthWrite||0===e.verticesCount||e._renderId===r.getRenderId())return;const o=i._getWorldMatrixDeterminant()<0;let a=n._getEffectiveOrientation(t);o&&(a=0===a?1:0);const l=0===a;s.setState(n.backFaceCulling,0,!1,l,this.reverseCulling?!n.cullBackFaces:n.cullBackFaces);const h=t._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(h.mustReturn)return;const c=s.getCaps().instancedArrays&&(null!==h.visibleInstances[e._id]&&void 0!==h.visibleInstances[e._id]||t.hasThinInstances),u=this._camera||r.activeCamera;if(this.isReady(e,c)&&u){e._renderId=r.getRenderId();const o=i._internalAbstractMeshDataInfo._materialForRenderPass?.[s.currentRenderPassId];let a=e._getDrawWrapper();!a&&o&&(a=o._getDrawWrapper());const l=u.mode===ft.i.ORTHOGRAPHIC_CAMERA;if(!a)return;const d=a.effect;let p,m;if(s.enableEffect(a),c||t._bind(e,d,n.fillMode),o?o.bindForSubMesh(i.getWorldMatrix(),i,e):(d.setMatrix("viewProjection",r.getTransformMatrix()),d.setMatrix("world",i.getWorldMatrix()),this._storeCameraSpaceZ&&d.setMatrix("view",r.getViewMatrix())),l?(p=!s.useReverseDepthBuffer&&s.isNDCHalfZRange?0:1,m=s.useReverseDepthBuffer&&s.isNDCHalfZRange?0:1):(p=s.useReverseDepthBuffer&&s.isNDCHalfZRange?u.minZ:s.isNDCHalfZRange?0:u.minZ,m=s.useReverseDepthBuffer&&s.isNDCHalfZRange?0:u.maxZ),d.setFloat2("depthValues",p,p+m),!o){if(n.needAlphaTestingForMesh(i)){const e=n.getAlphaTestTexture();e&&(d.setTexture("diffuseSampler",e),d.setMatrix("diffuseMatrix",e.getTextureMatrix()))}(0,ts.f$)(t,d),(0,es.gS)(d,n,r),(0,ts.nR)(t,d),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(d);const s=e.getMesh().bakedVertexAnimationManager;s&&s.isEnabled&&s.bind(d,c),n.pointsCloud&&d.setFloat("pointSize",n.pointSize)}t._processRendering(i,e,d,n.fillMode,h,c,((e,t)=>d.setMatrix("world",t)))}};this._depthMap.customRenderFunction=(e,t,i,r)=>{let s;if(r.length)for(s=0;s<r.length;s++)c(r.data[s]);for(s=0;s<e.length;s++)c(e.data[s]);for(s=0;s<t.length;s++)c(t.data[s]);if(this.forceDepthWriteTransparentMeshes)for(s=0;s<i.length;s++)c(i.data[s]);else for(s=0;s<i.length;s++)i.data[s].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}async _initShaderSourceAsync(e=!1){!this._scene.getEngine().isWebGPU||e||Dh.ForceGLSL?await Promise.all([Promise.resolve().then(i.bind(i,9977)),Promise.resolve().then(i.bind(i,88852))]):(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,48453)),Promise.resolve().then(i.bind(i,38939))])),this._shadersLoaded=!0}isReady(e,t){if(!this._shadersLoaded)return!1;const i=this._scene.getEngine(),r=e.getMesh(),s=r.getScene(),n=r._internalAbstractMeshDataInfo._materialForRenderPass?.[i.currentRenderPassId];if(n)return n.isReadyForSubMesh(r,e,t);const o=e.getMaterial();if(!o||o.disableDepthWrite)return!1;const a=[],l=[Ot.R.PositionKind];let h=!1,c=!1;o.needAlphaTestingForMesh(r)&&o.getAlphaTestTexture()&&(a.push("#define ALPHATEST"),r.isVerticesDataPresent(Ot.R.UVKind)&&(l.push(Ot.R.UVKind),a.push("#define UV1"),h=!0),r.isVerticesDataPresent(Ot.R.UV2Kind)&&(l.push(Ot.R.UV2Kind),a.push("#define UV2"),c=!0));const u=new Qr.J;if(r.useBones&&r.computeBonesUsingShaders&&r.skeleton){l.push(Ot.R.MatricesIndicesKind),l.push(Ot.R.MatricesWeightsKind),r.numBoneInfluencers>4&&(l.push(Ot.R.MatricesIndicesExtraKind),l.push(Ot.R.MatricesWeightsExtraKind)),a.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers),r.numBoneInfluencers>0&&u.addCPUSkinningFallback(0,r);const e=r.skeleton;e.isUsingTextureForMatrices?a.push("#define BONETEXTURE"):a.push("#define BonesPerMesh "+(e.bones.length+1))}else a.push("#define NUM_BONE_INFLUENCERS 0");const d=r.morphTargetManager?(0,ts.Dk)(r.morphTargetManager,a,l,r,!0,!1,!1,h,c,!1):0;o.pointsCloud&&a.push("#define POINTSIZE"),t&&(a.push("#define INSTANCES"),(0,ts.te)(l),e.getRenderingMesh().hasThinInstances&&a.push("#define THIN_INSTANCES"));const p=r.bakedVertexAnimationManager;p&&p.isEnabled&&(a.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&l.push("bakedVertexAnimationSettingsInstanced")),this._storeNonLinearDepth&&a.push("#define NONLINEARDEPTH"),this._storeCameraSpaceZ&&a.push("#define STORE_CAMERASPACE_Z"),this.isPacked&&a.push("#define PACKED"),(0,es.tv)(o,s,a);const m=e._getDrawWrapper(void 0,!0),f=m.defines,_=a.join("\n");if(f!==_){const e=["world","mBones","boneTextureWidth","pointSize","viewProjection","view","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],t=["diffuseSampler","morphTargets","boneSampler","bakedVertexAnimationTexture"];(0,es.TV)(e),m.setEffect(i.createEffect("depth",{attributes:l,uniformsNames:e,uniformBuffersNames:[],samplers:t,defines:_,fallbacks:u,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:d},shaderLanguage:this._shaderLanguage},i),_)}return m.effect.isReady()}getDepthMap(){return this._depthMap}dispose(){const e=[];for(const t in this._scene._depthRenderer){this._scene._depthRenderer[t]===this&&e.push(t)}if(e.length>0){this._depthMap.dispose();for(const t of e)delete this._scene._depthRenderer[t]}}}Dh.ForceGLSL=!1,Dh._SceneComponentInitialization=e=>{throw(0,Ph.n)("DepthRendererSceneComponent")};var Oh=i(36096);const Nh="minmaxReduxPixelShader",wh="varying vec2 vUV;uniform sampler2D textureSampler;\n#if defined(INITIAL)\nuniform sampler2D sourceTexture;uniform vec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*(texSize-1.0));float f1=texelFetch(sourceTexture,coord,0).r;float f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;float f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;float f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;float minz=min(min(min(f1,f2),f3),f4);\n#ifdef DEPTH_REDUX\nfloat maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);\n#else\nfloat maxz=max(max(max(f1,f2),f3),f4);\n#endif\nglFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(MAIN)\nuniform vec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*(texSize-1.0));vec2 f1=texelFetch(textureSampler,coord,0).rg;vec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;vec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;vec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);glFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(ONEBEFORELAST)\nuniform ivec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*vec2(texSize-1));vec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;vec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;vec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;vec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;float minz=min(f1.x,f2.x);float maxz=max(f1.y,f2.y);glFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(LAST)\nvoid main(void)\n{glFragColor=vec4(0.);if (true) { \ndiscard;}}\n#endif\n";qi.l.ShadersStore[Nh]=wh;class Fh{constructor(e){this.onAfterReductionPerformed=new s.cP,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=e,this._postProcessManager=new Oh.X(e.getScene()),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add((()=>{this._postProcessManager._rebuild()}))}get sourceTexture(){return this._sourceTexture}setSourceTexture(e,t,i=2,r=!0){if(e===this._sourceTexture)return;this.dispose(!1),this._sourceTexture=e,this._reductionSteps=[],this._forceFullscreenViewport=r;const s=this._camera.getScene(),n=new Fi.w("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,s.getEngine(),!1,"#define INITIAL"+(t?"\n#define DEPTH_REDUX":""),i,void 0,void 0,void 0,7);n.autoClear=!1,n.forceFullscreenViewport=r;let o=this._sourceTexture.getRenderWidth(),a=this._sourceTexture.getRenderHeight();n.onApply=((e,t)=>i=>{i.setTexture("sourceTexture",this._sourceTexture),i.setFloat2("texSize",e,t)})(o,a),this._reductionSteps.push(n);let l=1;for(;o>1||a>1;){o=Math.max(Math.round(o/2),1),a=Math.max(Math.round(a/2),1);const e=new Fi.w("Reduction phase "+l,"minmaxRedux",["texSize"],null,{width:o,height:a},null,1,s.getEngine(),!1,"#define "+(1==o&&1==a?"LAST":1==o||1==a?"ONEBEFORELAST":"MAIN"),i,void 0,void 0,void 0,7);if(e.autoClear=!1,e.forceFullscreenViewport=r,e.onApply=((e,t)=>i=>{1==e||1==t?i.setInt2("texSize",e,t):i.setFloat2("texSize",e,t)})(o,a),this._reductionSteps.push(e),l++,1==o&&1==a){const t=(e,t,i)=>{const r=new Float32Array(4*e*t),n={min:0,max:0};return()=>{s.getEngine()._readTexturePixels(i.inputTexture.texture,e,t,-1,0,r,!1),n.min=r[0],n.max=r[1],this.onAfterReductionPerformed.notifyObservers(n)}};e.onAfterRenderObservable.add(t(o,a,e))}}}get refreshRate(){return this._sourceTexture?this._sourceTexture.refreshRate:-1}set refreshRate(e){this._sourceTexture&&(this._sourceTexture.refreshRate=e)}get activated(){return this._activated}activate(){!this._onAfterUnbindObserver&&this._sourceTexture&&(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add((()=>{const e=this._camera.getScene().getEngine();e._debugPushGroup?.("min max reduction",1),this._reductionSteps[0].activate(this._camera),this._postProcessManager.directRender(this._reductionSteps,this._reductionSteps[0].inputTexture,this._forceFullscreenViewport),e.unBindFramebuffer(this._reductionSteps[0].inputTexture,!1),e._debugPopGroup?.(1)})),this._activated=!0)}deactivate(){this._onAfterUnbindObserver&&this._sourceTexture&&(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)}dispose(e=!0){if(e&&(this.onAfterReductionPerformed.clear(),this._onContextRestoredObserver&&(this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)),this.deactivate(),this._reductionSteps){for(let e=0;e<this._reductionSteps.length;++e)this._reductionSteps[e].dispose();this._reductionSteps=null}this._postProcessManager&&e&&this._postProcessManager.dispose(),this._sourceTexture=null}}class Bh extends Fh{get depthRenderer(){return this._depthRenderer}constructor(e){super(e)}setDepthRenderer(e=null,t=2,i=!0){const r=this._camera.getScene();this._depthRenderer&&(delete r._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),null===e&&(r._depthRenderer||(r._depthRenderer={}),(e=this._depthRenderer=new Dh(r,t,this._camera,!1,1)).enabled=!1,this._depthRendererId="minmax"+this._camera.id,r._depthRenderer[this._depthRendererId]=e),super.setSourceTexture(e.getDepthMap(),!0,t,i)}setSourceTexture(e,t,i=2,r=!0){super.setSourceTexture(e,t,i,r)}activate(){this._depthRenderer&&(this._depthRenderer.enabled=!0),super.activate()}deactivate(){super.deactivate(),this._depthRenderer&&(this._depthRenderer.enabled=!1)}dispose(e=!0){if(super.dispose(e),this._depthRenderer&&e){const e=this._depthRenderer.getDepthMap().getScene();e&&delete e._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}}}const Vh=n.Pq.Up(),Lh=n.Pq.Zero(),kh=new n.Pq,Gh=new n.Pq,zh=new n.uq;class Uh extends Ih{_validateFilter(e){return e===Ih.FILTER_NONE||e===Ih.FILTER_PCF||e===Ih.FILTER_PCSS?e:(m.V.Error('Unsupported filter "'+e+'"!'),Ih.FILTER_NONE)}get numCascades(){return this._numCascades}set numCascades(e){(e=Math.min(Math.max(e,Uh.MIN_CASCADES_COUNT),Uh.MAX_CASCADES_COUNT))!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs())}get freezeShadowCastersBoundingInfo(){return this._freezeShadowCastersBoundingInfo}set freezeShadowCastersBoundingInfo(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._freezeShadowCastersBoundingInfoObservable||e||(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add((()=>this._computeShadowCastersBoundingInfo()))),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo()}_computeShadowCastersBoundingInfo(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._shadowMap&&this._shadowMap.renderList){const e=this._shadowMap.renderList;for(let t=0;t<e.length;t++){const i=e[t];if(!i)continue;const r=i.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(r.minimumWorld),this._scbiMax.maximizeInPlace(r.maximumWorld)}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)}get shadowCastersBoundingInfo(){return this._shadowCastersBoundingInfo}set shadowCastersBoundingInfo(e){this._shadowCastersBoundingInfo=e}setMinMaxDistance(e,t){this._minDistance===e&&this._maxDistance===t||(e>t&&(e=0,t=1),e<0&&(e=0),t>1&&(t=1),this._minDistance=e,this._maxDistance=t,this._breaksAreDirty=!0)}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}getClassName(){return Uh.CLASSNAME}getCascadeMinExtents(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null}getCascadeMaxExtents(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null}get shadowMaxZ(){return this._getCamera()?this._shadowMaxZ:0}set shadowMaxZ(e){const t=this._getCamera();t?this._shadowMaxZ===e||e<t.minZ||e>t.maxZ&&0!==t.maxZ||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0):this._shadowMaxZ=e}get debug(){return this._debug}set debug(e){this._debug=e,this._light._markMeshesAsLightDirty()}get depthClamp(){return this._depthClamp}set depthClamp(e){this._depthClamp=e}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty()}get lambda(){return this._lambda}set lambda(e){const t=Math.min(Math.max(e,0),1);this._lambda!=t&&(this._lambda=t,this._breaksAreDirty=!0)}getCascadeViewMatrix(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null}getCascadeProjectionMatrix(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null}getCascadeTransformMatrix(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null}setDepthRenderer(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){const t=this._getCamera();if(t){if(this._autoCalcDepthBounds=e,!e)return this._depthReducer&&this._depthReducer.deactivate(),void this.setMinMaxDistance(0,1);this._depthReducer||(this._depthReducer=new Bh(t),this._depthReducer.onAfterReductionPerformed.add((e=>{let t=e.min,i=e.max;t>=i&&(t=0,i=1),t==this._minDistance&&i==this._maxDistance||this.setMinMaxDistance(t,i)})),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}}get autoCalcDepthBoundsRefreshRate(){return this._depthReducer?.depthRenderer?.getDepthMap().refreshRate??-1}set autoCalcDepthBoundsRefreshRate(e){this._depthReducer?.depthRenderer&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e)}splitFrustum(){this._breaksAreDirty=!0}_splitFrustum(){const e=this._getCamera();if(!e)return;const t=e.minZ,i=e.maxZ||this._shadowMaxZ,r=i-t,s=this._minDistance,n=t+s*r,o=t+(this._shadowMaxZ<i&&this._shadowMaxZ>=t?Math.min((this._shadowMaxZ-t)/(i-t),this._maxDistance):this._maxDistance)*r,a=o-n,l=o/n;for(let e=0;e<this._cascades.length;++e){const i=(e+1)/this._numCascades,o=n*l**i,h=n+a*i,c=this._lambda*(o-h)+h;this._cascades[e].prevBreakDistance=0===e?s:this._cascades[e-1].breakDistance,this._cascades[e].breakDistance=(c-t)/r,this._viewSpaceFrustumsZ[e]=c,this._frustumLengths[e]=(this._cascades[e].breakDistance-this._cascades[e].prevBreakDistance)*r}this._breaksAreDirty=!1}_computeMatrices(){const e=this._scene;if(!this._getCamera())return;n.Pq.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),1===Math.abs(n.Pq.Dot(this._lightDirection,n.Pq.Up()))&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);const t=e.getEngine().useReverseDepthBuffer;for(let i=0;i<this._numCascades;++i){this._computeFrustumInWorldSpace(i),this._computeCascadeFrustum(i),this._cascadeMaxExtents[i].subtractToRef(this._cascadeMinExtents[i],kh),this._frustumCenter[i].addToRef(this._lightDirection.scale(this._cascadeMinExtents[i].z),this._shadowCameraPos[i]),n.uq.LookAtLHToRef(this._shadowCameraPos[i],this._frustumCenter[i],Vh,this._viewMatrices[i]);let r=0,s=kh.z;const o=this._shadowCastersBoundingInfo;o.update(this._viewMatrices[i]);const a=o.boundingBox.minimumWorld.z,l=o.boundingBox.maximumWorld.z;a>s||(this._depthClamp&&this.filter!==Ih.FILTER_PCSS?(s=Math.min(s,l),r=Math.max(r,a),s=Math.max(r+1,s)):(r=Math.min(r,a),this.filter!==Ih.FILTER_PCSS&&(s=Math.min(s,l)))),n.uq.OrthoOffCenterLHToRef(this._cascadeMinExtents[i].x,this._cascadeMaxExtents[i].x,this._cascadeMinExtents[i].y,this._cascadeMaxExtents[i].y,t?s:r,t?r:s,this._projectionMatrices[i],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[i].z=r,this._cascadeMaxExtents[i].z=s,this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),n.Pq.TransformCoordinatesToRef(Lh,this._transformMatrices[i],kh),kh.scaleInPlace(this._mapSize/2),Gh.copyFromFloats(Math.round(kh.x),Math.round(kh.y),Math.round(kh.z)),Gh.subtractInPlace(kh).scaleInPlace(2/this._mapSize),n.uq.TranslationToRef(Gh.x,Gh.y,0,zh),this._projectionMatrices[i].multiplyToRef(zh,this._projectionMatrices[i]),this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),this._transformMatrices[i].copyToArray(this._transformMatricesAsArray,16*i)}}_computeFrustumInWorldSpace(e){const t=this._getCamera();if(!t)return;const i=this._cascades[e].prevBreakDistance,r=this._cascades[e].breakDistance,s=this._scene.getEngine().isNDCHalfZRange;t.getViewMatrix();const o=0===t.maxZ,a=t.maxZ;o&&(t.maxZ=this._shadowMaxZ,t.getProjectionMatrix(!0));const l=n.uq.Invert(t.getTransformationMatrix());o&&(t.maxZ=a,t.getProjectionMatrix(!0));const h=this._scene.getEngine().useReverseDepthBuffer?4:0;for(let t=0;t<Uh._FrustumCornersNDCSpace.length;++t)kh.copyFrom(Uh._FrustumCornersNDCSpace[(t+h)%Uh._FrustumCornersNDCSpace.length]),s&&-1===kh.z&&(kh.z=0),n.Pq.TransformCoordinatesToRef(kh,l,this._frustumCornersWorldSpace[e][t]);for(let t=0;t<Uh._FrustumCornersNDCSpace.length/2;++t)kh.copyFrom(this._frustumCornersWorldSpace[e][t+4]).subtractInPlace(this._frustumCornersWorldSpace[e][t]),Gh.copyFrom(kh).scaleInPlace(i),kh.scaleInPlace(r),kh.addInPlace(this._frustumCornersWorldSpace[e][t]),this._frustumCornersWorldSpace[e][t+4].copyFrom(kh),this._frustumCornersWorldSpace[e][t].addInPlace(Gh)}_computeCascadeFrustum(e){this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0);if(this._getCamera()){for(let t=0;t<this._frustumCornersWorldSpace[e].length;++t)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][t]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){let t=0;for(let i=0;i<this._frustumCornersWorldSpace[e].length;++i){const r=this._frustumCornersWorldSpace[e][i].subtractToRef(this._frustumCenter[e],kh).length();t=Math.max(t,r)}t=Math.ceil(16*t)/16,this._cascadeMaxExtents[e].copyFromFloats(t,t,t),this._cascadeMinExtents[e].copyFromFloats(-t,-t,-t)}else{const t=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,kh),n.uq.LookAtLHToRef(t,kh,Vh,zh);for(let t=0;t<this._frustumCornersWorldSpace[e].length;++t)n.Pq.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][t],zh,kh),this._cascadeMinExtents[e].minimizeInPlace(kh),this._cascadeMaxExtents[e].maximizeInPlace(kh)}}}_recreateSceneUBOs(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(let e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for CSM Shadow Generator (light "${this._light.name}" cascade #${e})`))}static get IsSupported(){const e=C.q.LastCreatedEngine;return!!e&&e._features.supportCSM}constructor(e,t,i,r,s=!0){Uh.IsSupported?(super(e,t,i,r,s),this.usePercentageCloserFiltering=!0):m.V.Error("CascadedShadowMap is not supported by the current engine.")}_initializeGenerator(){this.penumbraDarkness=this.penumbraDarkness??1,this._numCascades=this._numCascades??Uh.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=this.stabilizeCascades??!1,this._freezeShadowCastersBoundingInfoObservable=this._freezeShadowCastersBoundingInfoObservable??null,this.freezeShadowCastersBoundingInfo=this.freezeShadowCastersBoundingInfo??!1,this._scbiMin=this._scbiMin??new n.Pq(0,0,0),this._scbiMax=this._scbiMax??new n.Pq(0,0,0),this._shadowCastersBoundingInfo=this._shadowCastersBoundingInfo??new fs.j(new n.Pq(0,0,0),new n.Pq(0,0,0)),this._breaksAreDirty=this._breaksAreDirty??!0,this._minDistance=this._minDistance??0,this._maxDistance=this._maxDistance??1,this._currentLayer=this._currentLayer??0,this._shadowMaxZ=this._shadowMaxZ??this._getCamera()?.maxZ??1e4,this._debug=this._debug??!1,this._depthClamp=this._depthClamp??!0,this._cascadeBlendPercentage=this._cascadeBlendPercentage??.1,this._lambda=this._lambda??.5,this._autoCalcDepthBounds=this._autoCalcDepthBounds??!1,this._recreateSceneUBOs(),super._initializeGenerator()}_createTargetRenderTexture(){const e=this._scene.getEngine(),t={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new cr.$(this._light.name+"_CSMShadowMap",t,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,`DepthStencilForCSMShadowGenerator-${this._light.name}`),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(super._initializeShadowMap(),null===this._shadowMap)return;this._transformMatricesAsArray=new Float32Array(16*this._numCascades),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(2*this._numCascades),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(let e=0;e<this._numCascades;++e){this._cascades[e]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[e]=n.uq.Zero(),this._projectionMatrices[e]=n.uq.Zero(),this._transformMatrices[e]=n.uq.Zero(),this._cascadeMinExtents[e]=new n.Pq,this._cascadeMaxExtents[e]=new n.Pq,this._frustumCenter[e]=new n.Pq,this._shadowCameraPos[e]=new n.Pq,this._frustumCornersWorldSpace[e]=new Array(Uh._FrustumCornersNDCSpace.length);for(let t=0;t<Uh._FrustumCornersNDCSpace.length;++t)this._frustumCornersWorldSpace[e][t]=new n.Pq}const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add((t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[t]),this._currentLayer=t,this._filter===Ih.FILTER_PCF&&e.setColorWrite(!1),this._scene.setTransformMatrix(this.getCascadeViewMatrix(t),this.getCascadeProjectionMatrix(t)),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())})),this._shadowMap.onBeforeBindObservable.add((()=>{this._currentSceneUBO=this._scene.getSceneUniformBuffer(),e._debugPushGroup?.(`cascaded shadow map generation for pass id ${e.currentRenderPassId}`,1),this._breaksAreDirty&&this._splitFrustum(),this._computeMatrices()})),this._splitFrustum()}_bindCustomEffectForRenderSubMeshForShadowMap(e,t){t.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))}_isReadyCustomDefines(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==Ih.FILTER_PCSS?"1":"0"))}prepareDefines(e,t){super.prepareDefines(e,t);const i=this._scene,r=this._light;if(!i.shadowsEnabled||!r.shadowEnabled)return;e["SHADOWCSM"+t]=!0,e["SHADOWCSMDEBUG"+t]=this.debug,e["SHADOWCSMNUM_CASCADES"+t]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+t]=i.useRightHandedSystem;const s=this._getCamera();s&&this._shadowMaxZ<=(s.maxZ||this._shadowMaxZ)&&(e["SHADOWCSMUSESHADOWMAXZ"+t]=!0),0===this.cascadeBlendPercentage&&(e["SHADOWCSMNOBLEND"+t]=!0)}bindShadowLight(e,t){const i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;const r=this._getCamera();if(!r)return;const s=this.getShadowMap();if(!s)return;const n=s.getSize().width;if(t.setMatrices("lightMatrix"+e,this._transformMatricesAsArray),t.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),t.setFloat("cascadeBlendFactor"+e,0===this.cascadeBlendPercentage?1e4:1/this.cascadeBlendPercentage),t.setArray("frustumLengths"+e,this._frustumLengths),this._filter===Ih.FILTER_PCF)t.setDepthStencilTexture("shadowTexture"+e,s),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),n,1/n,this.frustumEdgeFalloff,e);else if(this._filter===Ih.FILTER_PCSS){for(let e=0;e<this._numCascades;++e)this._lightSizeUVCorrection[2*e+0]=0===e?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[e].x-this._cascadeMinExtents[e].x),this._lightSizeUVCorrection[2*e+1]=0===e?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[e].y-this._cascadeMinExtents[e].y),this._depthCorrection[e]=0===e?1:(this._cascadeMaxExtents[e].z-this._cascadeMinExtents[e].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);t.setDepthStencilTexture("shadowTexture"+e,s),t.setTexture("depthTexture"+e,s),t.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),t.setArray("depthCorrection"+e,this._depthCorrection),t.setFloat("penumbraDarkness"+e,this.penumbraDarkness),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/n,this._contactHardeningLightSizeUVRatio*n,this.frustumEdgeFalloff,e)}else t.setTexture("shadowTexture"+e,s),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),n,1/n,this.frustumEdgeFalloff,e);i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(r),this.getLight().getDepthMinZ(r)+this.getLight().getDepthMaxZ(r),e)}getTransformMatrix(){return this.getCascadeTransformMatrix(0)}dispose(){super.dispose(),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)}serialize(){const e=super.serialize(),t=this.getShadowMap();if(!t)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){const r=t.renderList[i];e.renderList.push(r.id)}return e}static Parse(e,t){const i=Ih.Parse(e,t,((e,t,i)=>new Uh(e,t,void 0,i)));return void 0!==e.numCascades&&(i.numCascades=e.numCascades),void 0!==e.debug&&(i.debug=e.debug),void 0!==e.stabilizeCascades&&(i.stabilizeCascades=e.stabilizeCascades),void 0!==e.lambda&&(i.lambda=e.lambda),void 0!==e.cascadeBlendPercentage&&(i.cascadeBlendPercentage=e.cascadeBlendPercentage),void 0!==e.depthClamp&&(i.depthClamp=e.depthClamp),void 0!==e.autoCalcDepthBounds&&(i.autoCalcDepthBounds=e.autoCalcDepthBounds),void 0!==e.shadowMaxZ&&(i.shadowMaxZ=e.shadowMaxZ),void 0!==e.penumbraDarkness&&(i.penumbraDarkness=e.penumbraDarkness),void 0!==e.freezeShadowCastersBoundingInfo&&(i.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),void 0!==e.minDistance&&void 0!==e.maxDistance&&i.setMinMaxDistance(e.minDistance,e.maxDistance),i}}Uh._FrustumCornersNDCSpace=[new n.Pq(-1,1,-1),new n.Pq(1,1,-1),new n.Pq(1,-1,-1),new n.Pq(-1,-1,-1),new n.Pq(-1,1,1),new n.Pq(1,1,1),new n.Pq(1,-1,1),new n.Pq(-1,-1,1)],Uh.CLASSNAME="CascadedShadowGenerator",Uh.DEFAULT_CASCADES_COUNT=4,Uh.MIN_CASCADES_COUNT=2,Uh.MAX_CASCADES_COUNT=4,Uh._SceneComponentInitialization=e=>{throw(0,Ph.n)("ShadowGeneratorSceneComponent")};class Wh extends ih{get light(){return this._light}set light(e){e!==this._light&&(this._light=e,this._setupShadowGenerator())}get camera(){return this._camera}set camera(e){this._camera=e,this._setupShadowGenerator()}get mapSize(){return this._mapSize}set mapSize(e){e!==this._mapSize&&(this._mapSize=e,this._setupShadowGenerator())}get useFloat32TextureType(){return this._useFloat32TextureType}set useFloat32TextureType(e){e!==this._useFloat32TextureType&&(this._useFloat32TextureType=e,this._setupShadowGenerator())}get useRedTextureFormat(){return this._useRedTextureFormat}set useRedTextureFormat(e){e!==this._useRedTextureFormat&&(this._useRedTextureFormat=e,this._setupShadowGenerator())}get bias(){return this._bias}set bias(e){e!==this._bias&&(this._bias=e,this._shadowGenerator&&(this._shadowGenerator.bias=e))}get normalBias(){return this._normalBias}set normalBias(e){e!==this._normalBias&&(this._normalBias=e,this._shadowGenerator&&(this._shadowGenerator.normalBias=e))}get darkness(){return this._darkness}set darkness(e){e!==this._darkness&&(this._darkness=e,this._shadowGenerator&&(this._shadowGenerator.darkness=e))}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){e!==this._transparencyShadow&&(this._transparencyShadow=e,this._shadowGenerator&&(this._shadowGenerator.transparencyShadow=e))}get enableSoftTransparentShadow(){return this._enableSoftTransparentShadow}set enableSoftTransparentShadow(e){e!==this._enableSoftTransparentShadow&&(this._enableSoftTransparentShadow=e,this._shadowGenerator&&(this._shadowGenerator.enableSoftTransparentShadow=e))}get useOpacityTextureForTransparentShadow(){return this._useOpacityTextureForTransparentShadow}set useOpacityTextureForTransparentShadow(e){e!==this._useOpacityTextureForTransparentShadow&&(this._useOpacityTextureForTransparentShadow=e,this._shadowGenerator&&(this._shadowGenerator.useOpacityTextureForTransparentShadow=e))}get filter(){return this._filter}set filter(e){e!==this._filter&&(this._filter=e,this._shadowGenerator&&(this._shadowGenerator.filter=e))}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){e!==this._filteringQuality&&(this._filteringQuality=e,this._shadowGenerator&&(this._shadowGenerator.filteringQuality=e))}_createShadowGenerator(){this._shadowGenerator=new Ih(this._mapSize,this._light,this._useFloat32TextureType,void 0,this._useRedTextureFormat)}_setupShadowGenerator(){if(this._shadowGenerator?.dispose(),this._shadowGenerator=void 0,void 0!==this._light){this._createShadowGenerator();const e=this._shadowGenerator;if(void 0===e)return;e.bias=this._bias,e.normalBias=this._normalBias,e.darkness=this._darkness,e.transparencyShadow=this._transparencyShadow,e.enableSoftTransparentShadow=this._enableSoftTransparentShadow,e.useOpacityTextureForTransparentShadow=this._useOpacityTextureForTransparentShadow,e.filter=this._filter,e.filteringQuality=this._filteringQuality;const t=e.getShadowMap();t._disableEngineStages=!0,t.cameraForLOD=this._camera,this.shadowGenerator=e}}isReady(){return!!this._shadowGenerator&&!!this._shadowGenerator.getShadowMap()?.isReadyForRendering()}constructor(e,t,i){super(e,t),this._mapSize=1024,this._useFloat32TextureType=!1,this._useRedTextureFormat=!0,this._bias=.01,this._normalBias=0,this._darkness=0,this._transparencyShadow=!1,this._enableSoftTransparentShadow=!1,this._useOpacityTextureForTransparentShadow=!1,this._filter=Ih.FILTER_PCF,this._filteringQuality=Ih.QUALITY_HIGH,this._engine=i.getEngine(),this._scene=i,this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}record(){if(void 0===this.light||void 0===this.objectList||void 0===this.camera)throw new Error(`FrameGraphShadowGeneratorTask ${this.name}: light, objectList and camera are required`);const e=this._shadowGenerator.getShadowMap();e.renderList=this.objectList.meshes,e.particleSystemList=this.objectList.particleSystems;const t=this._frameGraph.textureManager.importTexture(`${this.name} shadowmap`,this._shadowGenerator.getShadowMap().getInternalTexture());this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,t);this._frameGraph.addPass(this.name).setExecuteFunc((e=>{if(!this.light.isEnabled()||!this.light.shadowEnabled)return;const t=this._shadowGenerator.getShadowMap();t.renderList=this.objectList.meshes,t.particleSystemList=this.objectList.particleSystems;const i=this._engine._currentRenderTarget;this._scene.incrementRenderId(),this._scene.resetCachedMaterial(),t.render(),this._engine._currentRenderTarget!==i&&(i?this._engine.bindFramebuffer(i):this._engine.restoreDefaultFramebuffer())}));this._frameGraph.addPass(this.name+"_disabled",!0).setExecuteFunc((e=>{}))}dispose(){this._shadowGenerator?.dispose(),this._shadowGenerator=void 0}}var Hh=i(52046);class $h extends Wh{constructor(){super(...arguments),this._numCascades=Uh.DEFAULT_CASCADES_COUNT,this._debug=!1,this._stabilizeCascades=!1,this._lambda=.5,this._cascadeBlendPercentage=.1,this._depthClamp=!0,this._autoCalcDepthBounds=!1,this._shadowMaxZ=1e4}static IsCascadedShadowGenerator(e){return void 0!==e.numCascades}get numCascades(){return this._numCascades}set numCascades(e){e!==this._numCascades&&(this._numCascades=e,this._setupShadowGenerator())}get debug(){return this._debug}set debug(e){e!==this._debug&&(this._debug=e,this._shadowGenerator&&(this._shadowGenerator.debug=e))}get stabilizeCascades(){return this._stabilizeCascades}set stabilizeCascades(e){e!==this._stabilizeCascades&&(this._stabilizeCascades=e,this._shadowGenerator&&(this._shadowGenerator.stabilizeCascades=e))}get lambda(){return this._lambda}set lambda(e){e!==this._lambda&&(this._lambda=e,this._shadowGenerator&&(this._shadowGenerator.lambda=e))}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){e!==this._cascadeBlendPercentage&&(this._cascadeBlendPercentage=e,this._shadowGenerator&&(this._shadowGenerator.cascadeBlendPercentage=e))}get depthClamp(){return this._depthClamp}set depthClamp(e){e!==this._depthClamp&&(this._depthClamp=e,this._shadowGenerator&&(this._shadowGenerator.depthClamp=e))}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){e!==this._autoCalcDepthBounds&&(this._autoCalcDepthBounds=e,this._shadowGenerator&&(this._shadowGenerator.autoCalcDepthBounds=e))}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){e!==this._shadowMaxZ&&(this._shadowMaxZ=e,this._shadowGenerator&&(this._shadowGenerator.shadowMaxZ=e))}_createShadowGenerator(){if(!(this.light instanceof Hh.Z))throw new Error(`FrameGraphCascadedShadowGeneratorTask ${this.name}: the CSM shadow generator only supports directional lights.`);this._shadowGenerator=new Uh(this.mapSize,this.light,this.useFloat32TextureType,this.camera,this.useRedTextureFormat),this._shadowGenerator.numCascades=this._numCascades}_setupShadowGenerator(){super._setupShadowGenerator();const e=this._shadowGenerator;void 0!==e&&(e.debug=this._debug,e.stabilizeCascades=this._stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this._cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this._autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ)}}class qh extends ih{get camera(){return this._camera}set camera(e){this._camera=e,this._renderer.activeCamera=this.camera}get objectRenderer(){return this._renderer}get name(){return this._name}set name(e){this._name=e,this._renderer&&(this._renderer.name=e)}constructor(e,t,i,r,s){super(e,t),this.shadowGenerators=[],this.depthTest=!0,this.depthWrite=!0,this.disableShadows=!1,this._onBeforeRenderObservable=null,this._onAfterRenderObservable=null,this._externalObjectRenderer=!1,this._scene=i,this._externalObjectRenderer=!!s,this._renderer=s??new yh.P(e,i,r),this.name=e,this._externalObjectRenderer||this._renderer.onBeforeRenderingManagerRenderObservable.add((()=>{this._renderer.options.doNotChangeAspectRatio||i.updateTransformMatrix(!0)})),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle(),this.outputDepthTexture=this._frameGraph.textureManager.createDanglingHandle()}isReady(){return this._renderer.isReadyForRendering(this._textureWidth,this._textureHeight)}record(e=!1,t){if(void 0===this.targetTexture||void 0===this.objectList)throw new Error(`FrameGraphObjectRendererTask ${this.name}: targetTexture and objectList are required`);this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems;const i=this._frameGraph.textureManager.getTextureDescription(this.targetTexture);let r=!1;if(void 0!==this.depthTexture){if(this.depthTexture===Kl&&this.targetTexture!==Ql)throw new Error(`FrameGraphObjectRendererTask ${this.name}: the back buffer color texture is the only color texture allowed when the depth is the back buffer depth/stencil`);if(this.depthTexture!==Kl&&this.targetTexture===Ql)throw new Error(`FrameGraphObjectRendererTask ${this.name}: the back buffer depth/stencil texture is the only depth texture allowed when the target is the back buffer color`);if(this._frameGraph.textureManager.getTextureDescription(this.depthTexture).options.samples!==i.options.samples)throw new Error(`FrameGraphObjectRendererTask ${this.name}: the depth texture and the output texture must have the same number of samples`);r=!0}this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture),void 0!==this.depthTexture&&this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthTexture,this.depthTexture),this._textureWidth=i.size.width,this._textureHeight=i.size.height,this._setLightsForShadow();const s=this._frameGraph.addRenderPass(this.name);if(s.setRenderTarget(this.targetTexture),s.setRenderTargetDepth(this.depthTexture),s.setExecuteFunc((e=>{this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems,e.setDepthStates(this.depthTest&&r,this.depthWrite&&r),e.render(this._renderer,this._textureWidth,this._textureHeight),t?.(e)})),!e){const e=this._frameGraph.addRenderPass(this.name+"_disabled",!0);e.setRenderTarget(this.targetTexture),e.setRenderTargetDepth(this.depthTexture),e.setExecuteFunc((e=>{}))}return s}dispose(){this._renderer.onBeforeRenderObservable.remove(this._onBeforeRenderObservable),this._renderer.onAfterRenderObservable.remove(this._onAfterRenderObservable),this._externalObjectRenderer||this._renderer.dispose(),super.dispose()}_setLightsForShadow(){const e=new Set,t=new Map;if(this.shadowGenerators)for(const t of this.shadowGenerators){const i=t.shadowGenerator,r=i.getLight();r.isEnabled()&&r.shadowEnabled&&(e.add(r),$h.IsCascadedShadowGenerator(t)?r._shadowGenerators.set(t.camera,i):r._shadowGenerators.set(null,i))}this._renderer.onBeforeRenderObservable.remove(this._onBeforeRenderObservable),this._onBeforeRenderObservable=this._renderer.onBeforeRenderObservable.add((()=>{for(let i=0;i<this._scene.lights.length;i++){const r=this._scene.lights[i];t.set(r,r.shadowEnabled),r.shadowEnabled=!this.disableShadows&&e.has(r)}})),this._renderer.onAfterRenderObservable.remove(this._onAfterRenderObservable),this._onAfterRenderObservable=this._renderer.onAfterRenderObservable.add((()=>{for(let e=0;e<this._scene.lights.length;e++){const i=this._scene.lights[e];i.shadowEnabled=t.get(i)}}))}}class Yh extends jl{constructor(e,t,i,r,s){super(e,t,i),this._blockType=r,this._blockName=s,this.needDualDirectionValidation=!0}checkCompatibilityState(e){return e instanceof Yh&&e._blockName===this._blockName?0:1}createCustomInputBlock(){return[new this._blockType(this._blockName),this.name]}}class Xh extends Zl{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("target",Wl.Texture),this.registerInput("depth",Wl.TextureBackBufferDepthStencilAttachment,!0),this.registerInput("camera",Wl.Camera),this.registerInput("objects",Wl.ObjectList),this._addDependenciesInput(),this.registerInput("shadowGenerators",Wl.ShadowGenerator,!0),this.registerOutput("output",Wl.BasedOnInput),this.registerOutput("outputDepth",Wl.BasedOnInput),this.registerOutput("objectRenderer",Wl.Object,new Yh("objectRenderer",this,1,Xh,"NodeRenderGraphBaseObjectRendererBlock")),this.target.addAcceptedConnectionPointTypes(Wl.TextureAllButBackBufferDepthStencil),this.depth.addAcceptedConnectionPointTypes(Wl.TextureDepthStencilAttachment),this.shadowGenerators.addAcceptedConnectionPointTypes(Wl.ResourceContainer),this.output._typeConnectionSource=this.target,this.outputDepth._typeConnectionSource=this.depth}get depthTest(){return this._frameGraphTask.depthTest}set depthTest(e){this._frameGraphTask.depthTest=e}get depthWrite(){return this._frameGraphTask.depthWrite}set depthWrite(e){this._frameGraphTask.depthWrite=e}get disableShadows(){return this._frameGraphTask.disableShadows}set disableShadows(e){this._frameGraphTask.disableShadows=e}getClassName(){return"NodeRenderGraphBaseObjectRendererBlock"}get target(){return this._inputs[0]}get depth(){return this._inputs[1]}get camera(){return this._inputs[2]}get objects(){return this._inputs[3]}get dependencies(){return this._inputs[4]}get shadowGenerators(){return this._inputs[5]}get output(){return this._outputs[0]}get outputDepth(){return this._outputs[1]}get objectRenderer(){return this._outputs[2]}_buildBlock(e){super._buildBlock(e),this.output.value=this._frameGraphTask.outputTexture,this.outputDepth.value=this._frameGraphTask.outputDepthTexture,this.objectRenderer.value=this._frameGraphTask,this._frameGraphTask.targetTexture=this.target.connectedPoint?.value,this._frameGraphTask.depthTexture=this.depth.connectedPoint?.value,this._frameGraphTask.camera=this.camera.connectedPoint?.value,this._frameGraphTask.objectList=this.objects.connectedPoint?.value,this._frameGraphTask.shadowGenerators=[];const t=this.shadowGenerators.connectedPoint;if(t)if(t.type===Wl.ResourceContainer){t.ownerBlock.inputs.forEach((e=>{e.connectedPoint&&void 0!==e.connectedPoint.value&&jl.IsShadowGenerator(e.connectedPoint.value)&&this._frameGraphTask.shadowGenerators.push(e.connectedPoint.value)}))}else jl.IsShadowGenerator(t.value)&&(this._frameGraphTask.shadowGenerators[0]=t.value)}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.depthTest = ${this.depthTest};`),e.push(`${this._codeVariableName}.depthWrite = ${this.depthWrite};`),e.push(`${this._codeVariableName}.disableShadows = ${this.disableShadows};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.disableShadows=this.disableShadows,e}_deserialize(e){super._deserialize(e),this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.disableShadows=e.disableShadows}}(0,Ge.Cg)([xh("Depth test",0,"PROPERTIES")],Xh.prototype,"depthTest",null),(0,Ge.Cg)([xh("Depth write",0,"PROPERTIES")],Xh.prototype,"depthWrite",null),(0,Ge.Cg)([xh("Disable shadows",0,"PROPERTIES")],Xh.prototype,"disableShadows",null);class jh extends Xh{constructor(e,t,i,r=!0){super(e,t,i),this._additionalConstructionParameters=[r],this._frameGraphTask=new qh(this.name,t,i,{doNotChangeAspectRatio:r})}get doNotChangeAspectRatio(){return this._frameGraphTask.objectRenderer.options.doNotChangeAspectRatio}set doNotChangeAspectRatio(e){this._frameGraphTask.dispose(),this._frameGraphTask=new qh(this.name,this._frameGraph,this._scene,{doNotChangeAspectRatio:e}),this._additionalConstructionParameters=[e]}getClassName(){return"NodeRenderGraphObjectRendererBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.doNotChangeAspectRatio = ${this.doNotChangeAspectRatio};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.doNotChangeAspectRatio=this.doNotChangeAspectRatio,e}_deserialize(e){super._deserialize(e),this.doNotChangeAspectRatio=e.doNotChangeAspectRatio}}(0,Ge.Cg)([xh("Do not change aspect ratio",0,"PROPERTIES")],jh.prototype,"doNotChangeAspectRatio",null),(0,a.Y5)("BABYLON.NodeRenderGraphObjectRendererBlock",jh);class Zh{constructor(){this.verbose=!1,this._notConnectedNonOptionalInputs=[]}emitErrors(e=null){let t="";for(const e of this._notConnectedNonOptionalInputs)t+=`input "${e.name}" from block "${e.ownerBlock.name}"[${e.ownerBlock.getClassName()}] is not connected and is not optional.\n`;return!t||(e&&e.notifyObservers(t),m.V.Error("Build of node render graph failed:\n"+t),!1)}}class Qh{_getGlobalNodeRenderGraphEditor(){return"undefined"!=typeof NODERENDERGRAPHEDITOR?NODERENDERGRAPHEDITOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.NodeRenderGraphEditor?BABYLON:void 0}get frameGraph(){return this._frameGraph}getScene(){return this._scene}constructor(e,t,i){this._buildId=Qh._BuildIdGenerator++,this.BJSNODERENDERGRAPHEDITOR=this._getGlobalNodeRenderGraphEditor(),this.editorData=null,this.attachedBlocks=[],this.onBuildObservable=new s.cP,this.onBuildErrorObservable=new s.cP,this.outputBlock=null,this._resizeObserver=null,this.name=e,this._scene=t,this._engine=t.getEngine(),i={debugTextures:!1,autoConfigure:!1,verbose:!1,rebuildGraphOnEngineResize:!0,autoFillExternalInputs:!0,...i},this._options=i,this._frameGraph=new gh(this._scene,i.debugTextures),i.rebuildGraphOnEngineResize&&(this._resizeObserver=this._engine.onResizeObservable.add((()=>{this.build()})))}getClassName(){return"NodeRenderGraph"}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e){if(t)return H.S0.Warn("More than one block was found with the name `"+e+"`"),t;t=i}return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getBlocksByPredicate(e){const t=[];for(const i of this.attachedBlocks)e(i)&&t.push(i);return t}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}edit(e){return new Promise((t=>{if(this.BJSNODERENDERGRAPHEDITOR=this.BJSNODERENDERGRAPHEDITOR||this._getGlobalNodeRenderGraphEditor(),void 0===this.BJSNODERENDERGRAPHEDITOR){const i=e&&e.editorURL?e.editorURL:Qh.EditorURL;H.S0.LoadBabylonScript(i,(()=>{this.BJSNODERENDERGRAPHEDITOR=this.BJSNODERENDERGRAPHEDITOR||this._getGlobalNodeRenderGraphEditor(),this._createNodeEditor(e?.nodeRenderGraphEditorConfig),t()}))}else this._createNodeEditor(e?.nodeRenderGraphEditorConfig),t()}))}_createNodeEditor(e){const t={nodeRenderGraph:this,...e};this.BJSNODERENDERGRAPHEDITOR.NodeRenderGraphEditor.Show(t)}build(){if(!this.outputBlock)throw new Error("You must define the outputBlock property before building the node render graph");this._initializeBlock(this.outputBlock),this._frameGraph.clear();const e=new Zh;e.buildId=this._buildId,e.verbose=this._options.verbose,this._options.autoFillExternalInputs&&this._autoFillExternalInputs();try{this.outputBlock.build(e),this._frameGraph.build()}finally{this._buildId=Qh._BuildIdGenerator++,e.emitErrors(this.onBuildErrorObservable)&&this.onBuildObservable.notifyObservers(this)}}_autoFillExternalInputs(){const e=this.getInputBlocks(),t=[];for(const e of this._scene.lights)void 0!==e.setShadowProjectionMatrix&&t.push(e);let i=0,r=0;for(const s of e)if(s.isExternal&&s.isAnAncestorOfType("NodeRenderGraphOutputBlock"))if(s.type&Wl.TextureAllButBackBuffer);else if(s.isCamera()){const e=this._scene.cameras[i++]||this._scene.cameras[0];this._scene.cameraToUseForPointers||(this._scene.cameraToUseForPointers=e),s.value=e}else s.isObjectList()?s.value={meshes:this._scene.meshes,particleSystems:this._scene.particleSystems}:s.isShadowLight()&&r<t.length&&(s.value=t[r++],r%=t.length)}whenReadyAsync(e=16,t=3e4){return this._frameGraph.whenReadyAsync(e,t)}execute(){this._frameGraph.execute()}_initializeBlock(e){e.initialize(),this._options.autoConfigure&&e.autoConfigure(),-1===this.attachedBlocks.indexOf(e)&&this.attachedBlocks.push(e);for(const t of e.inputs){const i=t.connectedPoint;if(i){const t=i.ownerBlock;t!==e&&this._initializeBlock(t)}}}clear(){this.outputBlock=null,this.attachedBlocks.length=0}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e===this.outputBlock&&(this.outputBlock=null)}parseSerializedObject(e,t=!1){t||this.clear();const i={};for(const t of e.blocks){const e=(0,a.n9)(t.customType);if(e){const r=t.additionalConstructionParameters,s=r?new e("",this._frameGraph,this._scene,...r):new e("",this._frameGraph,this._scene);s._deserialize(t),i[t.id]=s,this.attachedBlocks.push(s)}}for(const e of this.attachedBlocks)if(e.isTeleportOut){const t=e,r=t._tempEntryPointUniqueId;if(r){const e=i[r];e&&e.attachToEndpoint(t)}}for(let r=0;r<e.blocks.length;r++){const s=e.blocks[r],n=i[s.id];n&&(n.inputs.length&&s.inputs.some((e=>e.targetConnectionName))&&!t||this._restoreConnections(n,e,i))}if(e.outputNodeId&&(this.outputBlock=i[e.outputNodeId]),e.locations||e.editorData&&e.editorData.locations){const r=e.locations||e.editorData.locations;for(const e of r)i[e.blockId]&&(e.blockId=i[e.blockId].uniqueId);t&&this.editorData&&this.editorData.locations&&r.concat(this.editorData.locations),e.locations?this.editorData={locations:r}:(this.editorData=e.editorData,this.editorData.locations=r);const s=[];for(const e in i)s[e]=i[e].uniqueId;this.editorData.map=s}this.comment=e.comment}_restoreConnections(e,t,i){for(const r of e.outputs)for(const s of t.blocks){const n=i[s.id];if(n)for(const o of s.inputs)if(i[o.targetBlockId]!==e||o.targetConnectionName!==r.name);else{const e=n.getInputByName(o.inputName);if(!e||e.isConnected)continue;r.connectTo(e,!0),this._restoreConnections(n,t,i)}}}generateCode(){let e=[];const t=[],i=["const","var","let"];this.outputBlock&&this._gatherBlocks(this.outputBlock,t);const r=JSON.stringify(this._options);let s=`let nodeRenderGraph = new BABYLON.NodeRenderGraph("${this.name||"render graph"}", scene, ${r});\n`;for(const r of t)r.isInput&&-1===e.indexOf(r)&&(s+=r._dumpCode(i,e)+"\n");return this.outputBlock&&(e=[],s+="// Connections\n",s+=this.outputBlock._dumpCodeForOutputConnections(e),s+="// Output nodes\n",s+=`nodeRenderGraph.outputBlock = ${this.outputBlock._codeVariableName};\n`,s+="nodeRenderGraph.build();\n"),s}_gatherBlocks(e,t){if(-1===t.indexOf(e)){t.push(e);for(const i of e.inputs){const r=i.connectedPoint;if(r){const i=r.ownerBlock;i!==e&&this._gatherBlocks(i,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}setToDefault(){this.clear(),this.editorData=null;const e=new vh("Color Texture",this._frameGraph,this._scene,Wl.Texture);e.creationOptions.options.samples=4;const t=new vh("Depth Texture",this._frameGraph,this._scene,Wl.TextureDepthStencilAttachment);t.creationOptions.options.samples=4;const i=new bh("Clear",this._frameGraph,this._scene);i.clearDepth=!0,i.clearStencil=!0,e.output.connectTo(i.target),t.output.connectTo(i.depth);const r=new vh("Camera",this._frameGraph,this._scene,Wl.Camera),s=new vh("Object List",this._frameGraph,this._scene,Wl.ObjectList),n=new jh("Main Rendering",this._frameGraph,this._scene);r.output.connectTo(n.camera),s.output.connectTo(n.objects),i.output.connectTo(n.target),i.outputDepth.connectTo(n.depth);const o=new sh("Output",this._frameGraph,this._scene);n.output.connectTo(o.texture),this.outputBlock=o}clone(e){const t=this.serialize(),i=Ue.p.Clone((()=>new Qh(e,this._scene)),this);return i.name=e,i.parseSerializedObject(t),i._buildId=this._buildId,i.build(),i}serialize(e){const t=e?{}:Ue.p.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];e?i=e:(t.customType="BABYLON.NodeRenderGraph",this.outputBlock&&(t.outputNodeId=this.outputBlock.uniqueId)),t.blocks=[];for(const e of i)t.blocks.push(e.serialize());if(!e)for(const e of this.attachedBlocks)-1===i.indexOf(e)&&t.blocks.push(e.serialize());return t}dispose(){for(const e of this.attachedBlocks)e.dispose();this._frameGraph.dispose(),this._frameGraph=void 0,this._engine.onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null,this.attachedBlocks.length=0,this.onBuildObservable.clear(),this.onBuildErrorObservable.clear()}static CreateDefault(e,t,i){const r=new Qh(e,t,i);return r.setToDefault(),r.build(),r}static Parse(e,t,i,r=!0){const s=Ue.p.Parse((()=>new Qh(e.name,t,i)),e,null);return s.parseSerializedObject(e),r||s.build(),s}static ParseFromSnippetAsync(e,t,i,r,s=!0){return"_BLANK"===e?Promise.resolve(Qh.CreateDefault("blank",t,i)):new Promise(((n,o)=>{const a=new Kr.u;a.addEventListener("readystatechange",(()=>{if(4==a.readyState)if(200==a.status){const l=JSON.parse(JSON.parse(a.responseText).jsonPayload),h=JSON.parse(l.nodeRenderGraph);r||(r=Ue.p.Parse((()=>new Qh(e,t,i)),h,null)),r.parseSerializedObject(h),r.snippetId=e;try{s||r.build(),n(r)}catch(e){o(e)}}else o("Unable to load the snippet "+e)})),a.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),a.send()}))}}Qh._BuildIdGenerator=0,Qh.EditorURL=`${H.S0._DefaultCdnUrl}/v${Vi.Engine.Version}/NodeRenderGraph/babylon.nodeRenderGraph.js`,Qh.SnippetUrl="https://snippet.babylonjs.com",(0,Ge.Cg)([(0,ze.lK)()],Qh.prototype,"name",void 0),(0,Ge.Cg)([(0,ze.lK)("comment")],Qh.prototype,"comment",void 0);class Kh extends Zl{constructor(e,t,i){super(e,t,i),this.registerInput("input",Wl.AutoDetect),this.registerOutput("output",Wl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NodeRenderGraphElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];this._propagateInputValueToOutput(i,t)}}(0,a.Y5)("BABYLON.NodeRenderGraphElbowBlock",Kh);class Jh extends ih{constructor(e,t){super(e,t)}record(){if(!this.func)throw new Error("FrameGraphExecuteTask: Execute task must have a function.");const e=this._frameGraph.addPass(this.name);e.setExecuteFunc((e=>{this.func(e)}));return this._frameGraph.addPass(this.name+"_disabled",!0).setExecuteFunc((e=>{this.funcDisabled?.(e)})),e}}class ec extends Zl{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i);this._addDependenciesInput().addAcceptedConnectionPointTypes(Wl.Camera|Wl.ShadowLight|Wl.ObjectList),this.registerOutput("output",Wl.ResourceContainer),this._frameGraphTask=new Jh(e,t)}getClassName(){return"NodeRenderGraphExecuteBlock"}get output(){return this._outputs[0]}}(0,a.Y5)("BABYLON.NodeRenderGraphExecuteBlock",ec);class tc extends Zl{constructor(e,t,i){super(e,t,i),this.registerInput("resource0",Wl.Texture,!0),this.registerInput("resource1",Wl.Texture,!0),this.registerInput("resource2",Wl.Texture,!0),this.registerInput("resource3",Wl.Texture,!0),this.registerInput("resource4",Wl.Texture,!0),this.registerInput("resource5",Wl.Texture,!0),this.registerInput("resource6",Wl.Texture,!0),this.registerInput("resource7",Wl.Texture,!0),this.registerOutput("output",Wl.ResourceContainer),this.resource0.addAcceptedConnectionPointTypes(Wl.TextureAllButBackBuffer|Wl.ShadowGenerator),this.resource1.addAcceptedConnectionPointTypes(Wl.TextureAllButBackBuffer|Wl.ShadowGenerator),this.resource2.addAcceptedConnectionPointTypes(Wl.TextureAllButBackBuffer|Wl.ShadowGenerator),this.resource3.addAcceptedConnectionPointTypes(Wl.TextureAllButBackBuffer|Wl.ShadowGenerator),this.resource4.addAcceptedConnectionPointTypes(Wl.TextureAllButBackBuffer|Wl.ShadowGenerator),this.resource5.addAcceptedConnectionPointTypes(Wl.TextureAllButBackBuffer|Wl.ShadowGenerator),this.resource6.addAcceptedConnectionPointTypes(Wl.TextureAllButBackBuffer|Wl.ShadowGenerator),this.resource7.addAcceptedConnectionPointTypes(Wl.TextureAllButBackBuffer|Wl.ShadowGenerator)}getClassName(){return"NodeRenderGraphResourceContainerBlock"}get resource0(){return this._inputs[0]}get resource1(){return this._inputs[1]}get resource2(){return this._inputs[2]}get resource3(){return this._inputs[3]}get resource4(){return this._inputs[4]}get resource5(){return this._inputs[5]}get resource6(){return this._inputs[6]}get resource7(){return this._inputs[7]}get output(){return this._outputs[0]}}(0,a.Y5)("BABYLON.NodeRenderGraphResourceContainerBlock",tc);class ic extends Bi.${constructor(e,t=null,i,r,s){super({...s,name:e,engine:t||Vi.Engine.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:ic.FragmentUrl,uniforms:ic.Uniforms}),this.direction=i,this.kernel=r,this.textureWidth=0,this.textureHeight=0}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,82937)))):t.push(Promise.resolve().then(i.bind(i,57094))),super._gatherImports(e,t)}bind(){super.bind(),this._drawWrapper.effect.setFloat2("screenSize",this.textureWidth,this.textureHeight),this._drawWrapper.effect.setVector2("direction",this.direction),this._drawWrapper.effect.setFloat("blurWidth",this.kernel)}}ic.FragmentUrl="glowBlurPostProcess",ic.Uniforms=["screenSize","direction","blurWidth"];class rc{get camera(){return this._options.camera}set camera(e){this._options.camera=e}get renderingGroupId(){return this._options.renderingGroupId}set renderingGroupId(e){this._options.renderingGroupId=e}get objectRenderer(){return this._objectRenderer}get shaderLanguage(){return this._shaderLanguage}setMaterialForRendering(e,t){if(this._objectRenderer.setMaterialForRendering(e,t),Array.isArray(e))for(let i=0;i<e.length;++i){const r=e[i];t?this._materialForRendering[r.uniqueId]=[r,t]:delete this._materialForRendering[r.uniqueId]}else t?this._materialForRendering[e.uniqueId]=[e,t]:delete this._materialForRendering[e.uniqueId]}getEffectIntensity(e){return this._effectIntensity[e.uniqueId]??1}setEffectIntensity(e,t){this._effectIntensity[e.uniqueId]=t}constructor(e,t,i=!1,r=!1,n){this._additionalImportShadersAsync=n,this._vertexBuffers={},this._dontCheckIfReady=!1,this._shouldRender=!0,this._emissiveTextureAndColor={texture:null,color:new o.ov},this._effectIntensity={},this._postProcesses=[],this.neutralColor=new o.ov,this.isEnabled=!0,this.disableBoundingBoxesFromEffectLayer=!1,this.onDisposeObservable=new s.cP,this.onBeforeRenderLayerObservable=new s.cP,this.onBeforeComposeObservable=new s.cP,this.onBeforeRenderMeshToEffect=new s.cP,this.onAfterRenderMeshToEffect=new s.cP,this.onAfterComposeObservable=new s.cP,this.onBeforeBlurObservable=new s.cP,this.onAfterBlurObservable=new s.cP,this._shaderLanguage=0,this._materialForRendering={},this._shadersLoaded=!1,this.name=e,this._scene=t||C.q.LastCreatedScene,this._dontCheckIfReady=r;!this._scene.getEngine().isWebGPU||i||rc.ForceGLSL||(this._shaderLanguage=1),this._engine=this._scene.getEngine(),this._mergeDrawWrapper=[],this._generateIndexBuffer(),this._generateVertexBuffer()}getEffectName(){return""}isReady(e,t){return!0}needStencil(){return!1}_createMergeEffect(){throw new Error("Effect Layer: no merge effect defined")}_createTextureAndPostProcesses(){}_internalCompose(e,t){}_setEmissiveTextureAndColor(e,t,i){}_numInternalDraws(){return 1}_init(e){this._options={mainTextureRatio:.5,mainTextureFixedSize:0,mainTextureType:0,alphaBlendingMode:2,camera:null,renderingGroupId:-1,...e},this._createObjectRenderer()}_generateIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._engine.createIndexBuffer(e)}_generateVertexBuffer(){const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1);const t=new Ot.R(this._engine,e,Ot.R.PositionKind,!1,!1,2);this._vertexBuffers[Ot.R.PositionKind]=t}_createObjectRenderer(){this._objectRenderer=new yh.P(`ObjectRenderer for thin effect layer ${this.name}`,this._scene,{doNotChangeAspectRatio:!0}),this._objectRenderer.activeCamera=this._options.camera,this._objectRenderer.renderParticles=!1,this._objectRenderer.renderList=null;const e=!!this._scene.getBoundingBoxRenderer;let t=!1;e&&(this._objectRenderer.onBeforeRenderObservable.add((()=>{t=this._scene.getBoundingBoxRenderer().enabled,this._scene.getBoundingBoxRenderer().enabled=!this.disableBoundingBoxesFromEffectLayer&&t})),this._objectRenderer.onAfterRenderObservable.add((()=>{this._scene.getBoundingBoxRenderer().enabled=t}))),this._objectRenderer.customIsReadyFunction=(e,t,i)=>{if((i||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){const i=e.subMeshes[t],r=i.getMaterial(),s=i.getRenderingMesh();if(!r)continue;const n=s._getInstancesRenderList(i._id,!!i.getReplacementMesh()).hardwareInstancedRendering[i._id]||s.hasThinInstances;if(this._setEmissiveTextureAndColor(s,i,r),!this._isSubMeshReady(i,n,this._emissiveTextureAndColor.texture))return!1}return!0},this._objectRenderer.customRenderFunction=(e,t,i,r)=>{let s;this.onBeforeRenderLayerObservable.notifyObservers(this);const n=this._scene.getEngine();if(r.length){for(n.setColorWrite(!1),s=0;s<r.length;s++)this._renderSubMesh(r.data[s]);n.setColorWrite(!0)}for(s=0;s<e.length;s++)this._renderSubMesh(e.data[s]);for(s=0;s<t.length;s++)this._renderSubMesh(t.data[s]);const o=n.getAlphaMode();for(s=0;s<i.length;s++){const e=i.data[s],t=e.getMaterial();if(t&&t.needDepthPrePass){const i=t.getScene().getEngine();i.setColorWrite(!1),this._renderSubMesh(e),i.setColorWrite(!0)}this._renderSubMesh(e,!0)}n.setAlphaMode(o)}}_addCustomEffectDefines(e){}_internalIsSubMeshReady(e,t,i){const r=this._scene.getEngine(),s=e.getMesh(),n=s._internalAbstractMeshDataInfo._materialForRenderPass?.[r.currentRenderPassId];if(n)return n.isReadyForSubMesh(s,e,t);const o=e.getMaterial();if(!o)return!1;if(this._useMeshMaterial(e.getRenderingMesh()))return o.isReadyForSubMesh(e.getMesh(),e,t);const a=[],l=[Ot.R.PositionKind];let h=!1,c=!1;if(o){const e=o.needAlphaTestingForMesh(s),t=o.getAlphaTestTexture(),i=t&&t.hasAlpha&&(o.useAlphaFromDiffuseTexture||o._useAlphaFromAlbedoTexture);t&&(e||i)&&(a.push("#define DIFFUSE"),s.isVerticesDataPresent(Ot.R.UV2Kind)&&1===t.coordinatesIndex?(a.push("#define DIFFUSEUV2"),c=!0):s.isVerticesDataPresent(Ot.R.UVKind)&&(a.push("#define DIFFUSEUV1"),h=!0),e&&(a.push("#define ALPHATEST"),a.push("#define ALPHATESTVALUE 0.4")),t.gammaSpace||a.push("#define DIFFUSE_ISLINEAR"));const r=o.opacityTexture;r&&(a.push("#define OPACITY"),s.isVerticesDataPresent(Ot.R.UV2Kind)&&1===r.coordinatesIndex?(a.push("#define OPACITYUV2"),c=!0):s.isVerticesDataPresent(Ot.R.UVKind)&&(a.push("#define OPACITYUV1"),h=!0))}i&&(a.push("#define EMISSIVE"),s.isVerticesDataPresent(Ot.R.UV2Kind)&&1===i.coordinatesIndex?(a.push("#define EMISSIVEUV2"),c=!0):s.isVerticesDataPresent(Ot.R.UVKind)&&(a.push("#define EMISSIVEUV1"),h=!0),i.gammaSpace||a.push("#define EMISSIVE_ISLINEAR")),s.useVertexColors&&s.isVerticesDataPresent(Ot.R.ColorKind)&&s.hasVertexAlpha&&o.transparencyMode!==fn.i.MATERIAL_OPAQUE&&(l.push(Ot.R.ColorKind),a.push("#define VERTEXALPHA")),h&&(l.push(Ot.R.UVKind),a.push("#define UV1")),c&&(l.push(Ot.R.UV2Kind),a.push("#define UV2"));const u=new Qr.J;if(s.useBones&&s.computeBonesUsingShaders){l.push(Ot.R.MatricesIndicesKind),l.push(Ot.R.MatricesWeightsKind),s.numBoneInfluencers>4&&(l.push(Ot.R.MatricesIndicesExtraKind),l.push(Ot.R.MatricesWeightsExtraKind)),a.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers);const e=s.skeleton;e&&e.isUsingTextureForMatrices?a.push("#define BONETEXTURE"):a.push("#define BonesPerMesh "+(e?e.bones.length+1:0)),s.numBoneInfluencers>0&&u.addCPUSkinningFallback(0,s)}else a.push("#define NUM_BONE_INFLUENCERS 0");const d=s.morphTargetManager?(0,ts.Dk)(s.morphTargetManager,a,l,s,!0,!1,!1,h,c,!1):0;t&&(a.push("#define INSTANCES"),(0,ts.te)(l),e.getRenderingMesh().hasThinInstances&&a.push("#define THIN_INSTANCES")),(0,es.tv)(o,this._scene,a),this._addCustomEffectDefines(a);const p=e._getDrawWrapper(void 0,!0),m=p.defines,f=a.join("\n");if(m!==f){const e=["world","mBones","viewProjection","glowColor","morphTargetInfluences","morphTargetCount","boneTextureWidth","diffuseMatrix","emissiveMatrix","opacityMatrix","opacityIntensity","morphTargetTextureInfo","morphTargetTextureIndices","glowIntensity"];(0,es.TV)(e),p.setEffect(this._engine.createEffect("glowMapGeneration",l,e,["diffuseSampler","emissiveSampler","opacitySampler","boneSampler","morphTargets"],f,u,void 0,void 0,{maxSimultaneousMorphTargets:d},this._shaderLanguage,this._shadersLoaded?void 0:async()=>{await this._importShadersAsync(),this._shadersLoaded=!0}),f)}return p.effect.isReady()&&(this._dontCheckIfReady||!this._dontCheckIfReady&&this.isLayerReady())}_isSubMeshReady(e,t,i){return this._internalIsSubMeshReady(e,t,i)}async _importShadersAsync(){1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,48267)),Promise.resolve().then(i.bind(i,19073))]):await Promise.all([Promise.resolve().then(i.bind(i,50136)),Promise.resolve().then(i.bind(i,83234))]),this._additionalImportShadersAsync?.()}_internalIsLayerReady(){let e=!0;for(let t=0;t<this._postProcesses.length;t++)e=this._postProcesses[t].isReady()&&e;const t=this._numInternalDraws();for(let i=0;i<t;++i){let t=this._mergeDrawWrapper[i];t||(t=this._mergeDrawWrapper[i]=new Ah.E(this._engine),t.setEffect(this._createMergeEffect())),e=t.effect.isReady()&&e}return e}isLayerReady(){return this._internalIsLayerReady()}compose(){if(!this._dontCheckIfReady&&!this.isLayerReady())return!1;const e=this._scene.getEngine(),t=this._numInternalDraws();this.onBeforeComposeObservable.notifyObservers(this);const i=e.getAlphaMode();for(let i=0;i<t;++i){const t=this._mergeDrawWrapper[i];e.enableEffect(t),e.setState(!1),e.bindBuffers(this._vertexBuffers,this._indexBuffer,t.effect),e.setAlphaMode(this._options.alphaBlendingMode),this._internalCompose(t.effect,i)}return e.setAlphaMode(i),this.onAfterComposeObservable.notifyObservers(this),!0}_internalHasMesh(e){return-1===this.renderingGroupId||e.renderingGroupId===this.renderingGroupId}hasMesh(e){return this._internalHasMesh(e)}_internalShouldRender(){return this.isEnabled&&this._shouldRender}shouldRender(){return this._internalShouldRender()}_shouldRenderMesh(e){return!0}_internalCanRenderMesh(e,t){return!t.needAlphaBlendingForMesh(e)}_canRenderMesh(e,t){return this._internalCanRenderMesh(e,t)}_renderSubMesh(e,t=!1){if(!this._internalShouldRender())return;const i=e.getMaterial(),r=e.getMesh(),s=e.getReplacementMesh(),n=e.getRenderingMesh(),o=e.getEffectiveMesh(),a=this._scene,l=a.getEngine();if(o._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!i)return;if(!this._canRenderMesh(n,i))return;let h=i._getEffectiveOrientation(n);o._getWorldMatrixDeterminant()<0&&(h=h===fn.i.ClockWiseSideOrientation?fn.i.CounterClockWiseSideOrientation:fn.i.ClockWiseSideOrientation);const c=h===fn.i.ClockWiseSideOrientation;l.setState(i.backFaceCulling,i.zOffset,void 0,c,i.cullBackFaces,void 0,i.zOffsetUnits);const u=n._getInstancesRenderList(e._id,!!s);if(u.mustReturn)return;if(!this._shouldRenderMesh(n))return;const d=u.hardwareInstancedRendering[e._id]||n.hasThinInstances;if(this._setEmissiveTextureAndColor(n,e,i),this.onBeforeRenderMeshToEffect.notifyObservers(r),this._useMeshMaterial(n))e.getMaterial()._glowModeEnabled=!0,n.render(e,t,s||void 0),e.getMaterial()._glowModeEnabled=!1;else if(this._isSubMeshReady(e,d,this._emissiveTextureAndColor.texture)){const r=o._internalAbstractMeshDataInfo._materialForRenderPass?.[l.currentRenderPassId];let s=e._getDrawWrapper();if(!s&&r&&(s=r._getDrawWrapper()),!s)return;const h=s.effect;if(l.enableEffect(s),d||n._bind(e,h,i.fillMode),r?r.bindForSubMesh(o.getWorldMatrix(),o,e):(h.setMatrix("viewProjection",a.getTransformMatrix()),h.setMatrix("world",o.getWorldMatrix()),h.setFloat4("glowColor",this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,this._emissiveTextureAndColor.color.a)),!r){const e=i.needAlphaTestingForMesh(o),r=i.getAlphaTestTexture(),s=r&&r.hasAlpha&&(i.useAlphaFromDiffuseTexture||i._useAlphaFromAlbedoTexture);if(r&&(e||s)){h.setTexture("diffuseSampler",r);const e=r.getTextureMatrix();e&&h.setMatrix("diffuseMatrix",e)}const c=i.opacityTexture;if(c){h.setTexture("opacitySampler",c),h.setFloat("opacityIntensity",c.level);const e=c.getTextureMatrix();e&&h.setMatrix("opacityMatrix",e)}if(this._emissiveTextureAndColor.texture&&(h.setTexture("emissiveSampler",this._emissiveTextureAndColor.texture),h.setMatrix("emissiveMatrix",this._emissiveTextureAndColor.texture.getTextureMatrix())),n.useBones&&n.computeBonesUsingShaders&&n.skeleton){const e=n.skeleton;if(e.isUsingTextureForMatrices){const t=e.getTransformMatrixTexture(n);if(!t)return;h.setTexture("boneSampler",t),h.setFloat("boneTextureWidth",4*(e.bones.length+1))}else h.setMatrices("mBones",e.getTransformMatrices(n))}(0,ts.nR)(n,h),n.morphTargetManager&&n.morphTargetManager.isUsingTextureForTargets&&n.morphTargetManager._bind(h),t&&l.setAlphaMode(i.alphaMode),h.setFloat("glowIntensity",this.getEffectIntensity(n)),(0,es.gS)(h,i,a)}n._processRendering(o,e,h,i.fillMode,u,d,((e,t)=>h.setMatrix("world",t)))}else this._objectRenderer.resetRefreshCounter();this.onAfterRenderMeshToEffect.notifyObservers(r)}_useMeshMaterial(e){return!1}_rebuild(){const e=this._vertexBuffers[Ot.R.PositionKind];e&&e._rebuild(),this._generateIndexBuffer()}dispose(){const e=this._vertexBuffers[Ot.R.PositionKind];e&&(e.dispose(),this._vertexBuffers[Ot.R.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);for(const e of this._mergeDrawWrapper)e.dispose();this._mergeDrawWrapper=[],this._objectRenderer.dispose(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderLayerObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear()}}rc.ForceGLSL=!1;class sc extends rc{get ldrMerge(){return this._options.ldrMerge}set blurKernelSize(e){if(e===this._options.blurKernelSize)return;this._options.blurKernelSize=e;const t=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1.kernel=t,this._verticalBlurPostprocess1.kernel=t,this._horizontalBlurPostprocess2.kernel=t,this._verticalBlurPostprocess2.kernel=t}get blurKernelSize(){return this._options.blurKernelSize}set intensity(e){this._intensity=e}get intensity(){return this._intensity}constructor(e,t,i,r=!1){super(e,t,!1,r),this._intensity=1,this._includedOnlyMeshes=[],this._excludedMeshes=[],this._meshesUsingTheirOwnMaterials=[],this._renderPassId=0,this.neutralColor=new o.ov(0,0,0,1),this._options={mainTextureRatio:.5,mainTextureFixedSize:0,mainTextureType:0,blurKernelSize:32,camera:null,renderingGroupId:-1,ldrMerge:!1,alphaBlendingMode:1,...i},this._init(this._options),r&&this._createTextureAndPostProcesses()}getClassName(){return"GlowLayer"}async _importShadersAsync(){1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,22147)),Promise.resolve().then(i.bind(i,7101)),Promise.resolve().then(i.bind(i,82937))]):await Promise.all([Promise.resolve().then(i.bind(i,99858)),Promise.resolve().then(i.bind(i,41288)),Promise.resolve().then(i.bind(i,57094))]),await super._importShadersAsync()}getEffectName(){return sc.EffectName}_createMergeEffect(){let e="#define EMISSIVE \n";return this._options.ldrMerge&&(e+="#define LDR \n"),this._engine.createEffect("glowMapMerge",[Ot.R.PositionKind],["offset"],["textureSampler","textureSampler2"],e,void 0,void 0,void 0,void 0,this.shaderLanguage,this._shadersLoaded?void 0:async()=>{await this._importShadersAsync(),this._shadersLoaded=!0})}_createTextureAndPostProcesses(){const e=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1=new Th("GlowLayerHBP1",this._scene.getEngine(),new n.I9(1,0),e),this._verticalBlurPostprocess1=new Th("GlowLayerVBP1",this._scene.getEngine(),new n.I9(0,1),e),this._horizontalBlurPostprocess2=new Th("GlowLayerHBP2",this._scene.getEngine(),new n.I9(1,0),e),this._verticalBlurPostprocess2=new Th("GlowLayerVBP2",this._scene.getEngine(),new n.I9(0,1),e),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2]}_getEffectiveBlurKernelSize(){return this._options.blurKernelSize/2}isReady(e,t){const i=e.getMaterial(),r=e.getRenderingMesh();if(!i||!r)return!1;const s=i.emissiveTexture;return super._isSubMeshReady(e,t,s)}_canRenderMesh(e,t){return!0}_internalCompose(e){this.bindTexturesForCompose(e),e.setFloat("offset",this._intensity);const t=this._engine,i=t.getStencilBuffer();t.setStencilBuffer(!1),t.drawElementsType(fn.i.TriangleFillMode,0,6),t.setStencilBuffer(i)}_setEmissiveTextureAndColor(e,t,i){let r=1;if(this.customEmissiveTextureSelector?this._emissiveTextureAndColor.texture=this.customEmissiveTextureSelector(e,t,i):i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.texture&&(r=this._emissiveTextureAndColor.texture.level)):this._emissiveTextureAndColor.texture=null,this.customEmissiveColorSelector)this.customEmissiveColorSelector(e,t,i,this._emissiveTextureAndColor.color);else if(i.emissiveColor){r*=i.emissiveIntensity??1,this._emissiveTextureAndColor.color.set(i.emissiveColor.r*r,i.emissiveColor.g*r,i.emissiveColor.b*r,i.alpha)}else this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)}_shouldRenderMesh(e){return this.hasMesh(e)}_addCustomEffectDefines(e){e.push("#define GLOW")}addExcludedMesh(e){-1===this._excludedMeshes.indexOf(e.uniqueId)&&this._excludedMeshes.push(e.uniqueId)}removeExcludedMesh(e){const t=this._excludedMeshes.indexOf(e.uniqueId);-1!==t&&this._excludedMeshes.splice(t,1)}addIncludedOnlyMesh(e){-1===this._includedOnlyMeshes.indexOf(e.uniqueId)&&this._includedOnlyMeshes.push(e.uniqueId)}removeIncludedOnlyMesh(e){const t=this._includedOnlyMeshes.indexOf(e.uniqueId);-1!==t&&this._includedOnlyMeshes.splice(t,1)}hasMesh(e){return!!super.hasMesh(e)&&(this._includedOnlyMeshes.length?-1!==this._includedOnlyMeshes.indexOf(e.uniqueId):!this._excludedMeshes.length||-1===this._excludedMeshes.indexOf(e.uniqueId))}_useMeshMaterial(e){return!!e.material?._supportGlowLayer||0!=this._meshesUsingTheirOwnMaterials.length&&this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId)>-1}referenceMeshToUseItsOwnMaterial(e){e.resetDrawCache(this._renderPassId),this._meshesUsingTheirOwnMaterials.push(e.uniqueId),e.onDisposeObservable.add((()=>{this._disposeMesh(e)}))}unReferenceMeshFromUsingItsOwnMaterial(e,t){let i=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);for(;i>=0;)this._meshesUsingTheirOwnMaterials.splice(i,1),i=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);e.resetDrawCache(t)}_disposeMesh(e){this.removeIncludedOnlyMesh(e),this.removeExcludedMesh(e)}}sc.EffectName="GlowLayer",sc.DefaultBlurKernelSize=32;class nc extends ih{get drawWrapper(){return this._postProcessDrawWrapper}constructor(e,t,i){super(e,t),this.sourceSamplingMode=2,this.postProcess=i,this._postProcessDrawWrapper=this.postProcess.drawWrapper,this.outputTexture=this._frameGraph.textureManager.createDanglingHandle(),this.onTexturesAllocatedObservable.add((e=>{e.setTextureSamplingMode(this.sourceTexture,this.sourceSamplingMode)}))}isReady(){return this.postProcess.isReady()}record(e=!1,t,i){if(void 0===this.sourceTexture)throw new Error(`FrameGraphPostProcessTask "${this.name}": sourceTexture is required`);const r=this._frameGraph.textureManager.getTextureCreationOptions(this.sourceTexture);r.options.samples=1,this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture,this.name,r);const s=r.sizeIsPercentage?this._frameGraph.textureManager.getAbsoluteDimensions(r.size):hh(r.size)?r.size:{width:r.size,height:r.size};this._sourceWidth=s.width,this._sourceHeight=s.height;const n=this._frameGraph.textureManager.getTextureDescription(this.outputTexture);this._outputWidth=n.size.width,this._outputHeight=n.size.height;const o=this._frameGraph.addRenderPass(this.name);if(o.addDependencies(this.sourceTexture),o.setRenderTarget(this.outputTexture),o.setExecuteFunc((e=>{t?.(e),e.applyFullScreenEffect(this._postProcessDrawWrapper,(()=>{e.bindTextureHandle(this._postProcessDrawWrapper.effect,"textureSampler",this.sourceTexture),i?.(e),this.postProcess.bind()}))})),!e){const e=this._frameGraph.addRenderPass(this.name+"_disabled",!0);e.addDependencies(this.sourceTexture),e.setRenderTarget(this.outputTexture),e.setExecuteFunc((e=>{e.copyTexture(this.sourceTexture)}))}return o}dispose(){this.postProcess.dispose(),super.dispose()}}class oc extends nc{constructor(e,t,i){super(e,t,i||new Th(e,t.engine,new n.I9(1,0),10))}record(e=!1,t,i){const r=super.record(e,t,i);return this.postProcess.textureWidth=this._outputWidth,this.postProcess.textureHeight=this._outputHeight,r}}class ac extends nc{constructor(e,t,i){super(e,t,i||new ic(e,t.engine,new n.I9(1,0),1))}record(e=!1,t,i){const r=super.record(e,t,i);return this.postProcess.textureWidth=this._outputWidth,this.postProcess.textureHeight=this._outputHeight,r}}class lc extends ih{get name(){return this._name}set name(e){if(this._name=e,this._blurX)for(let t=0;t<this._blurX.length;t++)this._blurX[t].name=`${e} Blur X${t}`,this._blurY[t].name=`${e} Blur Y${t}`;this._clearLayerTextures&&(this._clearLayerTextures.name=e+" Clear Layer"),this._objectRendererForLayer&&(this._objectRendererForLayer.name=e+" Render to Layer")}constructor(e,t,i,r,s,n=!1,o=!1,a=!1){super(e,t),this._setRenderTargetDepth=o,this._notifyBlurObservable=a,this._blurX=[],this._blurY=[],this._onBeforeBlurTask=null,this._onAfterBlurTask=null,this._onBeforeObservableObserver=null,this._onAfterObservableObserver=null,this._onAfterRenderingGroupObserver=null,this._scene=i,this._engine=i.getEngine(),this.layer=r;for(let t=0;t<s;t++)n?(this._blurX.push(new ac(`${e} Blur X${t}`,this._frameGraph,this.layer._postProcesses[1+2*t+0])),this._blurY.push(new ac(`${e} Blur Y${t}`,this._frameGraph,this.layer._postProcesses[1+2*t+1]))):(this._blurX.push(new oc(`${e} Blur X${t}`,this._frameGraph,this.layer._postProcesses[2*t+0])),this._blurY.push(new oc(`${e} Blur Y${t}`,this._frameGraph,this.layer._postProcesses[2*t+1])));this._clearLayerTextures=new Sh(e+" Clear Layer",t),this._clearLayerTextures.clearColor=!0,this._clearLayerTextures.clearDepth=!0,this._objectRendererForLayer=new qh(e+" Render to Layer",t,i,void 0,this.layer.objectRenderer),this._notifyBlurObservable&&(this._onBeforeBlurTask=new Jh(e+" On Before Blur",t),this._onAfterBlurTask=new Jh(e+" On After Blur",t),this._onBeforeBlurTask.func=()=>{this.layer.onBeforeBlurObservable.hasObservers()&&this.layer.onBeforeBlurObservable.notifyObservers(this.layer)},this._onAfterBlurTask.func=()=>{this.layer.onAfterBlurObservable.hasObservers()&&this.layer.onAfterBlurObservable.notifyObservers(this.layer)}),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle(),this.onTexturesAllocatedObservable.add((e=>{for(let t=0;t<this._blurX.length;t++)this._blurX[t].onTexturesAllocatedObservable.notifyObservers(e),this._blurY[t].onTexturesAllocatedObservable.notifyObservers(e);e.setTextureSamplingMode(this._blurY[this._blurY.length-1].targetTexture,2)}))}isReady(){return this._objectRendererForLayer.isReady()&&this.layer.isLayerReady()}record(){if(void 0===this.targetTexture||void 0===this.objectRendererTask)throw new Error(`${this.constructor.name} "${this.name}": targetTexture and objectRendererTask are required`);let e,t,i;if(this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture),this.layerTexture)i=this.layerTexture,t=this._frameGraph.textureManager.getTextureCreationOptions(this.layerTexture),e=ch(t.size),t.size=e;else{const r=this._frameGraph.textureManager.getTextureCreationOptions(this.targetTexture),s=this.layer._options.mainTextureFixedSize?Math.max(2,this.layer._options.mainTextureFixedSize):0;e=ch(r.size),e.width=s||Math.floor(e.width*(this.layer._options.mainTextureRatio||.1)),e.height=s||Math.floor(e.height*(this.layer._options.mainTextureRatio||.1)),t={size:e,options:{createMipMaps:!1,types:[this.layer._options.mainTextureType],formats:[5],samples:1,useSRGBBuffers:[!1],creationFlags:[0]},sizeIsPercentage:!this.layer._options.mainTextureFixedSize&&r.sizeIsPercentage},i=this._frameGraph.textureManager.createRenderTargetTexture(`${this.name} Color`,t)}const r={size:e,options:_h.CloneTextureOptions(t.options),sizeIsPercentage:t.sizeIsPercentage};r.options.formats[0]=14;const s=this._frameGraph.textureManager.createRenderTargetTexture(`${this.name} Depth`,r);this._clearLayerTextures.targetTexture=i,this._clearLayerTextures.depthTexture=s,this._clearLayerTextures.color=this.layer.neutralColor,this._clearLayerTextures.clearDepth=!0;const n=this._clearLayerTextures.record();this._objectRendererForLayer.targetTexture=this._clearLayerTextures.outputTexture,this._objectRendererForLayer.depthTexture=this._clearLayerTextures.outputDepthTexture,this._objectRendererForLayer.camera=this.objectRendererTask.camera,this._objectRendererForLayer.objectList=this.objectRendererTask.objectList,this._objectRendererForLayer.disableShadows=!0;const o=this._objectRendererForLayer.record();let a=0;a=this._engine.getCaps().textureHalfFloatRender?2:0,t.options.types[0]=a;const l=void 0!==this.layer._options.blurTextureSizeRatio?this.layer._options.blurTextureSizeRatio||.1:void 0;void 0!==l&&(e.width=Math.floor(e.width*l),e.height=Math.floor(e.height*l));const h=this._onBeforeBlurTask?.record(),c=[];for(let i=0;i<this._blurX.length;i++){const r=this._frameGraph.textureManager.createRenderTargetTexture(this._blurX[i].name,t);this._blurX[i].sourceTexture=0===i?this._objectRendererForLayer.outputTexture:this._blurY[i-1].outputTexture,this._blurX[i].sourceSamplingMode=2,this._blurX[i].targetTexture=r,c.push(this._blurX[i].record(!0));const s=this._frameGraph.textureManager.createRenderTargetTexture(this._blurY[i].name,t);this._blurY[i].sourceTexture=this._blurX[i].outputTexture,this._blurY[i].sourceSamplingMode=2,this._blurY[i].targetTexture=s,c.push(this._blurY[i].record(!0)),e.width=e.width>>1,e.height=e.height>>1}const u=this._onAfterBlurTask?.record();this.objectRendererTask.objectRenderer.onBeforeRenderObservable.remove(this._onBeforeObservableObserver),this._onBeforeObservableObserver=this.objectRendererTask.objectRenderer.onBeforeRenderObservable.add((()=>{const e=this.layer.shouldRender();n.disabled=!e,o.disabled=!e,h&&(h.disabled=!e);for(let t=0;t<c.length;t++)c[t].disabled=!e;u&&(u.disabled=!e),e&&this.layer.needStencil()&&(this._engine.setStencilBuffer(!0),this._engine.setStencilFunctionReference(1))})),this.objectRendererTask.objectRenderer.onAfterRenderObservable.remove(this._onAfterObservableObserver),this._onAfterObservableObserver=this.objectRendererTask.objectRenderer.onAfterRenderObservable.add((()=>{this.layer.shouldRender()&&this.layer.needStencil()&&this._engine.setStencilBuffer(!1)})),this.layer.bindTexturesForCompose=void 0,this._clearAfterRenderingGroupObserver();const d=this._frameGraph.addRenderPass(this.name);for(let e=0;e<this._blurY.length;e++)d.addDependencies(this._blurY[e].outputTexture);d.setRenderTarget(this.outputTexture),this._setRenderTargetDepth&&d.setRenderTargetDepth(this.objectRendererTask.depthTexture),d.setExecuteFunc((e=>{this.layer.bindTexturesForCompose||(this.layer.bindTexturesForCompose=t=>{for(let i=0;i<this._blurY.length;i++)e.bindTextureHandle(t,`textureSampler${i>0?i+1:""}`,this._blurY[i].outputTexture)}),-1!==this.layer._options.renderingGroupId?this._onAfterRenderingGroupObserver||(this._onAfterRenderingGroupObserver=this._scene.onAfterRenderingGroupObservable.add((t=>{this.layer.shouldRender()&&t.renderingGroupId===this.layer._options.renderingGroupId&&t.renderingManager===this.objectRendererTask.objectRenderer._renderingManager&&(this._objectRendererForLayer.objectList=this.objectRendererTask.objectList,e.saveDepthStates(),e.setDepthStates(!1,!1),e._applyRenderTarget(),this.layer.compose(),e.restoreDepthStates())}))):(this._clearAfterRenderingGroupObserver(),this.layer.shouldRender()&&(this._objectRendererForLayer.objectList=this.objectRendererTask.objectList,e.setDepthStates(!1,!1),e._applyRenderTarget(),this.layer.compose()))}));const p=this._frameGraph.addRenderPass(this.name+"_disabled",!0);p.setRenderTarget(this.outputTexture),this._setRenderTargetDepth&&p.setRenderTargetDepth(this.objectRendererTask.depthTexture),p.setExecuteFunc((e=>{}))}_clearAfterRenderingGroupObserver(){this._scene.onAfterRenderingGroupObservable.remove(this._onAfterRenderingGroupObserver),this._onAfterRenderingGroupObserver=null}dispose(){this._clearAfterRenderingGroupObserver(),this._clearLayerTextures.dispose(),this._objectRendererForLayer.dispose(),this._onBeforeBlurTask?.dispose(),this._onAfterBlurTask?.dispose(),this.layer.dispose();for(let e=0;e<this._blurX.length;e++)this._blurX[e].dispose(),this._blurY[e].dispose();super.dispose()}}class hc extends lc{constructor(e,t,i,r){super(e,t,i,new sc(e,i,r,!0),2),this.layer._renderPassId=this._objectRendererForLayer.objectRenderer.renderPassId}}class cc extends Zl{get task(){return this._frameGraphTask}constructor(e,t,i,r=!1,s=.5,n,o=0){super(e,t,i),this._additionalConstructionParameters=[r,s,n,o],this.registerInput("target",Wl.Texture),this.registerInput("layer",Wl.Texture,!0),this.registerInput("objectRenderer",Wl.Object,!0,new Yh("objectRenderer",this,0,Xh,"NodeRenderGraphBaseObjectRendererBlock")),this._addDependenciesInput(),this.registerOutput("output",Wl.BasedOnInput),this.target.addAcceptedConnectionPointTypes(Wl.TextureAllButBackBufferDepthStencil),this.layer.addAcceptedConnectionPointTypes(Wl.TextureAllButBackBuffer),this.output._typeConnectionSource=this.target,this._frameGraphTask=new hc(this.name,this._frameGraph,this._scene,{ldrMerge:r,mainTextureRatio:s,mainTextureFixedSize:n,mainTextureType:o})}_createTask(e,t,i,r){const s=this.blurKernelSize,n=this.intensity;this._frameGraphTask?.dispose(),this._frameGraphTask=new hc(this.name,this._frameGraph,this._scene,{ldrMerge:e,mainTextureRatio:t,mainTextureFixedSize:i,mainTextureType:r}),this.blurKernelSize=s,this.intensity=n,this._additionalConstructionParameters=[e,t,i,r]}get ldrMerge(){return this._frameGraphTask.layer.ldrMerge}set ldrMerge(e){const t=this._frameGraphTask.layer._options;this._createTask(e,t.mainTextureRatio,t.mainTextureFixedSize,t.mainTextureType)}get layerTextureRatio(){return this._frameGraphTask.layer._options.mainTextureRatio}set layerTextureRatio(e){const t=this._frameGraphTask.layer._options;this._createTask(t.ldrMerge,e,t.mainTextureFixedSize,t.mainTextureType)}get layerTextureFixedSize(){return this._frameGraphTask.layer._options.mainTextureFixedSize}set layerTextureFixedSize(e){const t=this._frameGraphTask.layer._options;this._createTask(t.ldrMerge,t.mainTextureRatio,e,t.mainTextureType)}get layerTextureType(){return this._frameGraphTask.layer._options.mainTextureType}set layerTextureType(e){const t=this._frameGraphTask.layer._options;this._createTask(t.ldrMerge,t.mainTextureRatio,t.mainTextureFixedSize,e)}get blurKernelSize(){return this._frameGraphTask.layer.blurKernelSize}set blurKernelSize(e){this._frameGraphTask.layer.blurKernelSize=e}get intensity(){return this._frameGraphTask.layer.intensity}set intensity(e){this._frameGraphTask.layer.intensity=e}getClassName(){return"NodeRenderGraphGlowLayerBlock"}get target(){return this._inputs[0]}get layer(){return this._inputs[1]}get objectRenderer(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.output.value=this._frameGraphTask.outputTexture,this._frameGraphTask.targetTexture=this.target.connectedPoint?.value,this._frameGraphTask.layerTexture=this.layer.connectedPoint?.value,this._frameGraphTask.objectRendererTask=this.objectRenderer.connectedPoint?.value}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.blurKernelSize = ${this.blurKernelSize};`),e.push(`${this._codeVariableName}.intensity = ${this.intensity};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.blurKernelSize=this.blurKernelSize,e.intensity=this.intensity,e}_deserialize(e){super._deserialize(e),this.blurKernelSize=e.blurKernelSize,this.intensity=e.intensity}}(0,Ge.Cg)([xh("LDR merge",0,"PROPERTIES")],cc.prototype,"ldrMerge",null),(0,Ge.Cg)([xh("Layer texture ratio",1,"PROPERTIES")],cc.prototype,"layerTextureRatio",null),(0,Ge.Cg)([xh("Layer texture fixed size",1,"PROPERTIES")],cc.prototype,"layerTextureFixedSize",null),(0,Ge.Cg)([xh("Layer texture type",8,"PROPERTIES")],cc.prototype,"layerTextureType",null),(0,Ge.Cg)([xh("Blur kernel size",2,"PROPERTIES",{min:1,max:256})],cc.prototype,"blurKernelSize",null),(0,Ge.Cg)([xh("Intensity",1,"PROPERTIES",{min:0,max:5})],cc.prototype,"intensity",null),(0,a.Y5)("BABYLON.NodeRenderGraphGlowLayerBlock",cc);var uc,dc=i(50341);class pc extends rc{set blurHorizontalSize(e){this._horizontalBlurPostprocess.kernel=e,this._options.blurHorizontalSize=e}set blurVerticalSize(e){this._verticalBlurPostprocess.kernel=e,this._options.blurVerticalSize=e}get blurHorizontalSize(){return this._horizontalBlurPostprocess.kernel}get blurVerticalSize(){return this._verticalBlurPostprocess.kernel}constructor(e,t,i,r=!1){super(e,t,void 0!==i&&!!i.forceGLSL),this.innerGlow=!0,this.outerGlow=!0,this._instanceGlowingMeshStencilReference=pc.GlowingMeshStencilReference++,this._meshes={},this._excludedMeshes={},this._mainObjectRendererRenderPassId=-1,this.neutralColor=pc.NeutralColor,this._options={mainTextureRatio:.5,blurTextureSizeRatio:.5,mainTextureFixedSize:0,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1,forceGLSL:!1,mainTextureType:0,isStroke:!1,...i},this._init(this._options),this._shouldRender=!1,r&&this._createTextureAndPostProcesses()}getClassName(){return"HighlightLayer"}async _importShadersAsync(){1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,22147)),Promise.resolve().then(i.bind(i,7101)),Promise.resolve().then(i.bind(i,82937))]):await Promise.all([Promise.resolve().then(i.bind(i,99858)),Promise.resolve().then(i.bind(i,41288)),Promise.resolve().then(i.bind(i,57094))]),await super._importShadersAsync()}getEffectName(){return pc.EffectName}_numInternalDraws(){return 2}_createMergeEffect(){return this._engine.createEffect("glowMapMerge",[Ot.R.PositionKind],["offset"],["textureSampler"],this._options.isStroke?"#define STROKE \n":void 0,void 0,void 0,void 0,void 0,this._shaderLanguage,this._shadersLoaded?void 0:async()=>{await this._importShadersAsync(),this._shadersLoaded=!0})}_createTextureAndPostProcesses(){2===this._options.alphaBlendingMode?(this._downSamplePostprocess=new dc.m("HighlightLayerPPP",this._scene.getEngine()),this._horizontalBlurPostprocess=new ic("HighlightLayerHBP",this._scene.getEngine(),new n.I9(1,0),this._options.blurHorizontalSize),this._verticalBlurPostprocess=new ic("HighlightLayerVBP",this._scene.getEngine(),new n.I9(0,1),this._options.blurVerticalSize),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess]):(this._horizontalBlurPostprocess=new Th("HighlightLayerHBP",this._scene.getEngine(),new n.I9(1,0),this._options.blurHorizontalSize/2),this._verticalBlurPostprocess=new Th("HighlightLayerVBP",this._scene.getEngine(),new n.I9(0,1),this._options.blurVerticalSize/2),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess])}needStencil(){return!0}isReady(e,t){const i=e.getMaterial(),r=e.getRenderingMesh();if(!i||!r||!this._meshes)return!1;let s=null;const n=this._meshes[r.uniqueId];return n&&n.glowEmissiveOnly&&i&&(s=i.emissiveTexture),super._isSubMeshReady(e,t,s)}_canRenderMesh(e,t){return!0}_internalCompose(e,t){this.bindTexturesForCompose(e);const i=this._engine;i.cacheStencilState(),i.setStencilOperationPass(7681),i.setStencilOperationFail(7680),i.setStencilOperationDepthFail(7680),i.setStencilMask(0),i.setStencilBuffer(!0),i.setStencilFunctionReference(this._instanceGlowingMeshStencilReference),this.outerGlow&&0===t&&(e.setFloat("offset",0),i.setStencilFunction(517),i.drawElementsType(fn.i.TriangleFillMode,0,6)),this.innerGlow&&1===t&&(e.setFloat("offset",1),i.setStencilFunction(514),i.drawElementsType(fn.i.TriangleFillMode,0,6)),i.restoreStencilState()}_setEmissiveTextureAndColor(e,t,i){const r=this._meshes[e.uniqueId];r?this._emissiveTextureAndColor.color.set(r.color.r,r.color.g,r.color.b,1):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a),r&&r.glowEmissiveOnly&&i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.color.set(1,1,1,1)):this._emissiveTextureAndColor.texture=null}shouldRender(){return!(!this._meshes||!super.shouldRender())}_shouldRenderMesh(e){return(!this._excludedMeshes||!this._excludedMeshes[e.uniqueId])&&super.hasMesh(e)}_addCustomEffectDefines(e){e.push("#define HIGHLIGHT")}addExcludedMesh(e){if(!this._excludedMeshes)return;if(!this._excludedMeshes[e.uniqueId]){const t={mesh:e,beforeBind:null,afterRender:null,stencilState:!1};t.beforeBind=e.onBeforeBindObservable.add((e=>{-1!==this._mainObjectRendererRenderPassId&&this._mainObjectRendererRenderPassId!==this._engine.currentRenderPassId||(t.stencilState=e.getEngine().getStencilBuffer(),e.getEngine().setStencilBuffer(!1))})),t.afterRender=e.onAfterRenderObservable.add((e=>{-1!==this._mainObjectRendererRenderPassId&&this._mainObjectRendererRenderPassId!==this._engine.currentRenderPassId||e.getEngine().setStencilBuffer(t.stencilState)})),this._excludedMeshes[e.uniqueId]=t}}removeExcludedMesh(e){if(!this._excludedMeshes)return;const t=this._excludedMeshes[e.uniqueId];t&&(t.beforeBind&&e.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&e.onAfterRenderObservable.remove(t.afterRender)),this._excludedMeshes[e.uniqueId]=null}hasMesh(e){return!(!this._meshes||!super.hasMesh(e))&&!!this._meshes[e.uniqueId]}addMesh(e,t,i=!1){if(!this._meshes)return;const r=this._meshes[e.uniqueId];r?r.color=t:(this._meshes[e.uniqueId]={mesh:e,color:t,observerHighlight:e.onBeforeBindObservable.add((e=>{-1!==this._mainObjectRendererRenderPassId&&this._mainObjectRendererRenderPassId!==this._engine.currentRenderPassId||this.isEnabled&&(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]?this._defaultStencilReference(e):e.getScene().getEngine().setStencilFunctionReference(this._instanceGlowingMeshStencilReference))})),observerDefault:e.onAfterRenderObservable.add((e=>{-1!==this._mainObjectRendererRenderPassId&&this._mainObjectRendererRenderPassId!==this._engine.currentRenderPassId||this.isEnabled&&this._defaultStencilReference(e)})),glowEmissiveOnly:i},e.onDisposeObservable.add((()=>{this._disposeMesh(e)}))),this._shouldRender=!0}removeMesh(e){if(!this._meshes)return;const t=this._meshes[e.uniqueId];t&&(t.observerHighlight&&e.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&e.onAfterRenderObservable.remove(t.observerDefault),delete this._meshes[e.uniqueId]),this._shouldRender=!1;for(const e in this._meshes)if(this._meshes[e]){this._shouldRender=!0;break}}removeAllMeshes(){if(this._meshes)for(const e in this._meshes)if(Object.prototype.hasOwnProperty.call(this._meshes,e)){const t=this._meshes[e];t&&this.removeMesh(t.mesh)}}_defaultStencilReference(e){e.getScene().getEngine().setStencilFunctionReference(pc.NormalMeshStencilReference)}_disposeMesh(e){this.removeMesh(e),this.removeExcludedMesh(e)}dispose(){if(this._meshes){for(const e in this._meshes){const t=this._meshes[e];t&&t.mesh&&(t.observerHighlight&&t.mesh.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&t.mesh.onAfterRenderObservable.remove(t.observerDefault))}this._meshes=null}if(this._excludedMeshes){for(const e in this._excludedMeshes){const t=this._excludedMeshes[e];t&&(t.beforeBind&&t.mesh.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&t.mesh.onAfterRenderObservable.remove(t.afterRender))}this._excludedMeshes=null}super.dispose()}}pc.EffectName="HighlightLayer",pc.NeutralColor=new o.ov(0,0,0,0),pc.GlowingMeshStencilReference=2,pc.NormalMeshStencilReference=1;class mc extends lc{constructor(e,t,i,r){const s=r?.alphaBlendingMode??2;super(e,t,i,new pc(e,i,r,!0),1,2===s,!0,!0)}record(){if(!this.objectRendererTask.depthTexture)throw new Error(`FrameGraphHighlightLayerTask "${this.name}": objectRendererTask must have a depthTexture input`);const e=this._frameGraph.textureManager.getTextureCreationOptions(this.objectRendererTask.depthTexture);if(!e.options.formats||!(0,fh.$l)(e.options.formats[0]))throw new Error(`FrameGraphHighlightLayerTask "${this.name}": objectRendererTask depthTexture must have a stencil aspect`);super.record(),this.layer._mainObjectRendererRenderPassId=this.objectRendererTask.objectRenderer.renderPassId}}class fc extends Zl{get task(){return this._frameGraphTask}constructor(e,t,i,r=.5,s,n=.5,o=!1,a=0){super(e,t,i),this._additionalConstructionParameters=[r,s,n,o,a],this.registerInput("target",Wl.Texture),this.registerInput("layer",Wl.Texture,!0),this.registerInput("objectRenderer",Wl.Object,!0,new Yh("objectRenderer",this,0,Xh,"NodeRenderGraphBaseObjectRendererBlock")),this._addDependenciesInput(),this.registerOutput("output",Wl.BasedOnInput),this.target.addAcceptedConnectionPointTypes(Wl.TextureAllButBackBufferDepthStencil),this.layer.addAcceptedConnectionPointTypes(Wl.TextureAllButBackBuffer),this.output._typeConnectionSource=this.target,this._frameGraphTask=new mc(this.name,this._frameGraph,this._scene,{mainTextureRatio:r,mainTextureFixedSize:s,blurTextureSizeRatio:n,isStroke:o,mainTextureType:a})}_createTask(e,t,i,r,s){const n=this.blurHorizontalSize,o=this.blurVerticalSize;this._frameGraphTask?.dispose(),this._frameGraphTask=new mc(this.name,this._frameGraph,this._scene,{mainTextureRatio:e,mainTextureFixedSize:t,blurTextureSizeRatio:i,isStroke:r,mainTextureType:s}),this.blurHorizontalSize=n,this.blurVerticalSize=o,this._additionalConstructionParameters=[e,t,i,r,s]}get layerTextureRatio(){return this._frameGraphTask.layer._options.mainTextureRatio}set layerTextureRatio(e){const t=this._frameGraphTask.layer._options;this._createTask(e,t.mainTextureFixedSize,t.blurTextureSizeRatio,t.isStroke,t.mainTextureType)}get layerTextureFixedSize(){return this._frameGraphTask.layer._options.mainTextureFixedSize}set layerTextureFixedSize(e){const t=this._frameGraphTask.layer._options;this._createTask(t.mainTextureRatio,e,t.blurTextureSizeRatio,t.isStroke,t.mainTextureType)}get blurTextureSizeRatio(){return this._frameGraphTask.layer._options.blurTextureSizeRatio}set blurTextureSizeRatio(e){const t=this._frameGraphTask.layer._options;this._createTask(t.mainTextureRatio,t.mainTextureFixedSize,e,t.isStroke,t.mainTextureType)}get isStroke(){return this._frameGraphTask.layer._options.isStroke}set isStroke(e){const t=this._frameGraphTask.layer._options;this._createTask(t.mainTextureRatio,t.mainTextureFixedSize,t.blurTextureSizeRatio,e,t.mainTextureType)}get layerTextureType(){return this._frameGraphTask.layer._options.mainTextureType}set layerTextureType(e){const t=this._frameGraphTask.layer._options;this._createTask(t.mainTextureRatio,t.mainTextureFixedSize,t.blurTextureSizeRatio,t.isStroke,e)}get blurHorizontalSize(){return this._frameGraphTask.layer.blurHorizontalSize}set blurHorizontalSize(e){this._frameGraphTask.layer.blurHorizontalSize=e}get blurVerticalSize(){return this._frameGraphTask.layer.blurVerticalSize}set blurVerticalSize(e){this._frameGraphTask.layer.blurVerticalSize=e}getClassName(){return"NodeRenderGraphHighlightLayerBlock"}get target(){return this._inputs[0]}get layer(){return this._inputs[1]}get objectRenderer(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.output.value=this._frameGraphTask.outputTexture,this._frameGraphTask.targetTexture=this.target.connectedPoint?.value,this._frameGraphTask.layerTexture=this.layer.connectedPoint?.value,this._frameGraphTask.objectRendererTask=this.objectRenderer.connectedPoint?.value}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.blurHorizontalSize = ${this.blurHorizontalSize};`),e.push(`${this._codeVariableName}.blurVerticalSize = ${this.blurVerticalSize};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.blurHorizontalSize=this.blurHorizontalSize,e.blurVerticalSize=this.blurVerticalSize,e}_deserialize(e){super._deserialize(e),this.blurHorizontalSize=e.blurHorizontalSize,this.blurVerticalSize=e.blurVerticalSize}}(0,Ge.Cg)([xh("Layer texture ratio",1,"PROPERTIES")],fc.prototype,"layerTextureRatio",null),(0,Ge.Cg)([xh("Layer texture fixed size",1,"PROPERTIES")],fc.prototype,"layerTextureFixedSize",null),(0,Ge.Cg)([xh("Blur texture size ratio",1,"PROPERTIES")],fc.prototype,"blurTextureSizeRatio",null),(0,Ge.Cg)([xh("Is stroke",0,"PROPERTIES")],fc.prototype,"isStroke",null),(0,Ge.Cg)([xh("Layer texture type",8,"PROPERTIES")],fc.prototype,"layerTextureType",null),(0,Ge.Cg)([xh("Blur horizontal size",1,"PROPERTIES",{min:0,max:4})],fc.prototype,"blurHorizontalSize",null),(0,Ge.Cg)([xh("Blur vertical size",1,"PROPERTIES",{min:0,max:4})],fc.prototype,"blurVerticalSize",null),(0,a.Y5)("BABYLON.NodeRenderGraphHighlightLayerBlock",fc);class _c extends nc{constructor(e,t,i){super(e,t,i||new Li(e,t.engine))}record(e=!1){if(void 0===this.sourceTexture||void 0===this.leftTexture)throw new Error(`FrameGraphAnaglyphTask "${this.name}": sourceTexture and leftTexture are required`);const t=super.record(e,void 0,(e=>{e.bindTextureHandle(this._postProcessDrawWrapper.effect,"leftSampler",this.leftTexture)}));return t.addDependencies(this.leftTexture),t}}class gc extends Zl{constructor(e,t,i){super(e,t,i),this.registerInput("source",Wl.Texture),this.registerInput("target",Wl.Texture,!0),this.source.addAcceptedConnectionPointTypes(Wl.TextureAllButBackBuffer),this.target.addAcceptedConnectionPointTypes(Wl.TextureAll)}_finalizeInputOutputRegistering(){this._addDependenciesInput(),this.registerOutput("output",Wl.BasedOnInput),this.output._typeConnectionSource=()=>this.target.isConnected?this.target:this.source}get sourceSamplingMode(){return this._frameGraphTask.sourceSamplingMode}set sourceSamplingMode(e){this._frameGraphTask.sourceSamplingMode=e}getClassName(){return"NodeRenderGraphBasePostProcessBlock"}get source(){return this._inputs[0]}get target(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.output.value=this._frameGraphTask.outputTexture,this._frameGraphTask.sourceTexture=this.source.connectedPoint?.value,this._frameGraphTask.targetTexture=this.target.connectedPoint?.value}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.sourceSamplingMode = ${this.sourceSamplingMode};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.sourceSamplingMode=this.sourceSamplingMode,e}_deserialize(e){super._deserialize(e),this.sourceSamplingMode=e.sourceSamplingMode}}(0,Ge.Cg)([xh("Source sampling mode",6,"PROPERTIES")],gc.prototype,"sourceSamplingMode",null);class xc extends gc{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("leftTexture",Wl.Texture),this.leftTexture.addAcceptedConnectionPointTypes(Wl.TextureAllButBackBuffer),this._finalizeInputOutputRegistering(),this._frameGraphTask=new _c(this.name,t,new Li(e,i.getEngine()))}getClassName(){return"NodeRenderGraphAnaglyphPostProcessBlock"}get leftTexture(){return this._inputs[2]}_buildBlock(e){super._buildBlock(e),this._frameGraphTask.leftTexture=this.leftTexture.connectedPoint?.value}}(0,a.Y5)("BABYLON.NodeRenderGraphAnaglyphPostProcessBlock",xc);class vc extends Bi.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,65783)))):t.push(Promise.resolve().then(i.bind(i,3996)))}constructor(e,t=null,i){super({...i,name:e,engine:t||Vi.Engine.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:vc.FragmentUrl,uniforms:vc.Uniforms}),this.degree=1}bind(){super.bind(),this._drawWrapper.effect.setFloat("degree",this.degree)}}vc.FragmentUrl="blackAndWhite",vc.Uniforms=["degree"];class Sc extends nc{constructor(e,t,i){super(e,t,i||new vc(e,t.engine))}}class bc extends gc{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._finalizeInputOutputRegistering(),this._frameGraphTask=new Sc(this.name,t,new vc(e,i.getEngine()))}get degree(){return this._frameGraphTask.postProcess.degree}set degree(e){this._frameGraphTask.postProcess.degree=e}getClassName(){return"NodeRenderGraphBlackAndWhitePostProcessBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.degree = ${this.degree};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.degree=this.degree,e}_deserialize(e){super._deserialize(e),this.degree=e.degree}}(0,Ge.Cg)([xh("Degree",1,"PROPERTIES",{min:0,max:1})],bc.prototype,"degree",null),(0,a.Y5)("BABYLON.NodeRenderGraphBlackAndWhitePostProcessBlock",bc);class yc extends Bi.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,96645)))):t.push(Promise.resolve().then(i.bind(i,39336)))}constructor(e,t=null,i){super({...i,name:e,engine:t||Vi.Engine.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:yc.FragmentUrl,uniforms:yc.Uniforms,samplers:yc.Samplers}),this.weight=1}bind(){super.bind(),this._drawWrapper.effect.setFloat("bloomWeight",this.weight)}}yc.FragmentUrl="bloomMerge",yc.Uniforms=["bloomWeight"],yc.Samplers=["bloomBlur"];class Pc extends nc{constructor(e,t,i){super(e,t,i||new yc(e,t.engine))}record(e=!1){if(void 0===this.sourceTexture||void 0===this.blurTexture)throw new Error(`FrameGraphBloomMergeTask "${this.name}": sourceTexture and blurTexture are required`);const t=super.record(e,void 0,(e=>{e.bindTextureHandle(this._postProcessDrawWrapper.effect,"bloomBlur",this.blurTexture)}));return t.addDependencies(this.blurTexture),t}}class Tc extends Bi.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,95516)))):t.push(Promise.resolve().then(i.bind(i,55491)))}constructor(e,t=null,i){super({...i,name:e,engine:t||Vi.Engine.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Tc.FragmentUrl,uniforms:Tc.Uniforms}),this.threshold=.9,this._exposure=1}bind(){super.bind();const e=this._drawWrapper.effect;e.setFloat("threshold",Math.pow(this.threshold,ut.rv)),e.setFloat("exposure",this._exposure)}}Tc.FragmentUrl="extractHighlights",Tc.Uniforms=["threshold","exposure"];class Cc{get threshold(){return this._downscale.threshold}set threshold(e){this._downscale.threshold=e}get weight(){return this._merge.weight}set weight(e){this._merge.weight=e}get kernel(){return this._blurX.kernel/this.scale}set kernel(e){this._blurX.kernel=e*this.scale,this._blurY.kernel=e*this.scale}constructor(e,t,i,r=!1){this.scale=i,this._downscale=new Tc(e+"_downscale",t,{blockCompilation:r}),this._blurX=new Th(e+"_blurX",t,new n.I9(1,0),10,{blockCompilation:r}),this._blurY=new Th(e+"_blurY",t,new n.I9(0,1),10,{blockCompilation:r}),this._merge=new yc(e+"_merge",t,{blockCompilation:r})}isReady(){return this._downscale.isReady()&&this._blurX.isReady()&&this._blurY.isReady()&&this._merge.isReady()}}class Ec extends nc{constructor(e,t,i){super(e,t,i||new Tc(e,t.engine))}}class Ac extends ih{get name(){return this._name}set name(e){this._name=e,this._downscale&&(this._downscale.name=`${e} Downscale`),this._blurX&&(this._blurX.name=`${e} Blur X`),this._blurY&&(this._blurY.name=`${e} Blur Y`),this._merge&&(this._merge.name=`${e} Merge`)}constructor(e,t,i,r,s,n=!1,o=.5){if(super(e,t),this.sourceSamplingMode=2,this.hdr=n,this._defaultPipelineTextureType=0,n){const e=t.engine.getCaps();e.textureHalfFloatRender?this._defaultPipelineTextureType=2:e.textureFloatRender&&(this._defaultPipelineTextureType=1)}this.bloom=new Cc(e,t.engine,o),this.bloom.threshold=s,this.bloom.kernel=r,this.bloom.weight=i,this._downscale=new Ec(`${e} Downscale`,this._frameGraph,this.bloom._downscale),this._blurX=new oc(`${e} Blur X`,this._frameGraph,this.bloom._blurX),this._blurY=new oc(`${e} Blur Y`,this._frameGraph,this.bloom._blurY),this._merge=new Pc(`${e} Merge`,this._frameGraph,this.bloom._merge),this.onTexturesAllocatedObservable.add((e=>{this._downscale.onTexturesAllocatedObservable.notifyObservers(e),this._blurX.onTexturesAllocatedObservable.notifyObservers(e),this._blurY.onTexturesAllocatedObservable.notifyObservers(e),this._merge.onTexturesAllocatedObservable.notifyObservers(e)})),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}isReady(){return this.bloom.isReady()}record(){if(void 0===this.sourceTexture)throw new Error("FrameGraphBloomTask: sourceTexture is required");const e=this._frameGraph.textureManager.getTextureDescription(this.sourceTexture),t={size:{width:Math.floor(e.size.width*this.bloom.scale),height:Math.floor(e.size.height*this.bloom.scale)},options:{createMipMaps:!1,types:[this._defaultPipelineTextureType],formats:[5],samples:1,useSRGBBuffers:[!1],labels:[""]},sizeIsPercentage:!1},i=this._frameGraph.textureManager.createRenderTargetTexture(this._downscale.name,t);this._downscale.sourceTexture=this.sourceTexture,this._downscale.sourceSamplingMode=2,this._downscale.targetTexture=i,this._downscale.record(!0);const r=this._frameGraph.textureManager.createRenderTargetTexture(this._blurX.name,t);this._blurX.sourceTexture=i,this._blurX.sourceSamplingMode=2,this._blurX.targetTexture=r,this._blurX.record(!0);const s=this._frameGraph.textureManager.createRenderTargetTexture(this._blurY.name,t);this._blurY.sourceTexture=r,this._blurY.sourceSamplingMode=2,this._blurY.targetTexture=s,this._blurY.record(!0);const n=this._frameGraph.textureManager.getTextureCreationOptions(this.sourceTexture);this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture,this._merge.name,n),this._merge.sourceTexture=this.sourceTexture,this._merge.sourceSamplingMode=this.sourceSamplingMode,this._merge.blurTexture=s,this._merge.targetTexture=this.outputTexture,this._merge.record(!0);const o=this._frameGraph.addRenderPass(this.name+"_disabled",!0);o.addDependencies(this.sourceTexture),o.setRenderTarget(this.outputTexture),o.setExecuteFunc((e=>{e.copyTexture(this.sourceTexture)}))}dispose(){this._downscale.dispose(),this._blurX.dispose(),this._blurY.dispose(),this._merge.dispose(),super.dispose()}}class Ic extends gc{get task(){return this._frameGraphTask}constructor(e,t,i,r=!1,s=.5){super(e,t,i),this._additionalConstructionParameters=[r,s],this._finalizeInputOutputRegistering(),this._frameGraphTask=new Ac(this.name,t,.75,64,.2,r,s)}_createTask(e,t){const i=this._frameGraphTask.sourceSamplingMode,r=this._frameGraphTask.bloom.threshold,s=this._frameGraphTask.bloom.weight,n=this._frameGraphTask.bloom.kernel;this._frameGraphTask.dispose(),this._frameGraphTask=new Ac(this.name,this._frameGraph,s,n,r,t,e),this._frameGraphTask.sourceSamplingMode=i,this._additionalConstructionParameters=[t,e]}get bloomScale(){return this._frameGraphTask.bloom.scale}set bloomScale(e){this._createTask(e,this._frameGraphTask.hdr)}get hdr(){return this._frameGraphTask.hdr}set hdr(e){this._createTask(this._frameGraphTask.bloom.scale,e)}get threshold(){return this._frameGraphTask.bloom.threshold}set threshold(e){this._frameGraphTask.bloom.threshold=e}get weight(){return this._frameGraphTask.bloom.weight}set weight(e){this._frameGraphTask.bloom.weight=e}get kernel(){return this._frameGraphTask.bloom.kernel}set kernel(e){this._frameGraphTask.bloom.kernel=e}getClassName(){return"NodeRenderGraphBloomPostProcessBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.threshold = ${this.threshold};`),e.push(`${this._codeVariableName}.weight = ${this.weight};`),e.push(`${this._codeVariableName}.kernel = ${this.kernel};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.threshold=this.threshold,e.weight=this.weight,e.kernel=this.kernel,e}_deserialize(e){super._deserialize(e),this.threshold=e.threshold,this.weight=e.weight,this.kernel=e.kernel}}(0,Ge.Cg)([xh("Bloom scale",1,"PROPERTIES")],Ic.prototype,"bloomScale",null),(0,Ge.Cg)([xh("HDR",0,"PROPERTIES")],Ic.prototype,"hdr",null),(0,Ge.Cg)([xh("Threshold",1,"PROPERTIES",{min:0,max:2})],Ic.prototype,"threshold",null),(0,Ge.Cg)([xh("Weight",1,"PROPERTIES",{min:0,max:3})],Ic.prototype,"weight",null),(0,Ge.Cg)([xh("Kernel",2,"PROPERTIES",{min:1,max:128})],Ic.prototype,"kernel",null),(0,a.Y5)("BABYLON.NodeRenderGraphBloomPostProcessBlock",Ic);class Rc extends gc{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._finalizeInputOutputRegistering(),this._frameGraphTask=new oc(this.name,t,new Th(e,i.getEngine(),new n.I9(1,0),32))}get direction(){return this._frameGraphTask.postProcess.direction}set direction(e){this._frameGraphTask.postProcess.direction=e}get kernel(){return this._frameGraphTask.postProcess.kernel}set kernel(e){this._frameGraphTask.postProcess.kernel=e}getClassName(){return"NodeRenderGraphBlurPostProcessBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.direction = new BABYLON.Vector2(${this.direction.x}, ${this.direction.y});`),e.push(`${this._codeVariableName}.kernel = ${this.kernel};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.direction=this.direction.asArray(),e.kernel=this.kernel,e}_deserialize(e){super._deserialize(e),this.direction.fromArray(e.direction),this.kernel=e.kernel}}(0,Ge.Cg)([xh("Direction",3,"PROPERTIES")],Rc.prototype,"direction",null),(0,Ge.Cg)([xh("Kernel",2,"PROPERTIES",{min:1,max:256})],Rc.prototype,"kernel",null),(0,a.Y5)("BABYLON.NodeRenderGraphBlurPostProcessBlock",Rc);class Mc extends Bi.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,89619)))):t.push(Promise.resolve().then(i.bind(i,32048)))}constructor(e,t=null,i){super({...i,name:e,engine:t||Vi.Engine.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Mc.FragmentUrl,uniforms:Mc.Uniforms}),this.aberrationAmount=30,this.radialIntensity=0,this.direction=new n.I9(.707,.707),this.centerPosition=new n.I9(.5,.5)}bind(){super.bind();const e=this._drawWrapper.effect;e.setFloat("chromatic_aberration",this.aberrationAmount),e.setFloat("screen_width",this.screenWidth),e.setFloat("screen_height",this.screenHeight),e.setFloat("radialIntensity",this.radialIntensity),e.setFloat2("direction",this.direction.x,this.direction.y),e.setFloat2("centerPosition",this.centerPosition.x,this.centerPosition.y)}}Mc.FragmentUrl="chromaticAberration",Mc.Uniforms=["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"];class Dc extends nc{constructor(e,t,i){super(e,t,i||new Mc(e,t.engine))}record(e=!1,t,i){const r=super.record(e,t,i);return this.postProcess.screenWidth=this._sourceWidth,this.postProcess.screenHeight=this._sourceHeight,r}}class Oc extends gc{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._finalizeInputOutputRegistering(),this._frameGraphTask=new Dc(this.name,t,new Mc(e,i.getEngine()))}get aberrationAmount(){return this._frameGraphTask.postProcess.aberrationAmount}set aberrationAmount(e){this._frameGraphTask.postProcess.aberrationAmount=e}get radialIntensity(){return this._frameGraphTask.postProcess.radialIntensity}set radialIntensity(e){this._frameGraphTask.postProcess.radialIntensity=e}get direction(){return this._frameGraphTask.postProcess.direction}set direction(e){this._frameGraphTask.postProcess.direction=e}getClassName(){return"NodeRenderGraphChromaticAberrationPostProcessBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.aberrationAmount = ${this.aberrationAmount};`),e.push(`${this._codeVariableName}.radialIntensity = ${this.radialIntensity};`),e.push(`${this._codeVariableName}.direction = new BABYLON.Vector2(${this.direction.x}, ${this.direction.y});`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.aberrationAmount=this.aberrationAmount,e.radialIntensity=this.radialIntensity,e.direction=this.direction.asArray(),e}_deserialize(e){super._deserialize(e),this.aberrationAmount=e.aberrationAmount,this.radialIntensity=e.radialIntensity,this.direction=n.I9.FromArray(e.direction)}}(0,Ge.Cg)([xh("Amount",1,"PROPERTIES",{min:-1e3,max:1e3})],Oc.prototype,"aberrationAmount",null),(0,Ge.Cg)([xh("Radial intensity",1,"PROPERTIES",{min:.1,max:5})],Oc.prototype,"radialIntensity",null),(0,Ge.Cg)([xh("Direction",3,"PROPERTIES")],Oc.prototype,"direction",null),(0,a.Y5)("BABYLON.NodeRenderGraphChromaticAberrationPostProcessBlock",Oc);class Nc extends Bi.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,22217)))):t.push(Promise.resolve().then(i.bind(i,97694)))}constructor(e,t=null,i){super({...i,name:e,engine:t||Vi.Engine.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Nc.FragmentUrl,uniforms:Nc.Uniforms,samplers:Nc.Samplers,defines:i?.depthNotNormalized?Nc.DefinesDepthNotNormalized:void 0}),this.lensSize=50,this.fStop=1.4,this.focusDistance=2e3,this.focalLength=50}bind(){super.bind();const e=this.options,t=this._drawWrapper.effect;e.depthNotNormalized||t.setFloat2("cameraMinMaxZ",this.camera.minZ,this.camera.maxZ-this.camera.minZ);const i=this.lensSize/this.fStop*this.focalLength/(this.focusDistance-this.focalLength);t.setFloat("focusDistance",this.focusDistance),t.setFloat("cocPrecalculation",i)}}Nc.FragmentUrl="circleOfConfusion",Nc.Uniforms=["cameraMinMaxZ","focusDistance","cocPrecalculation"],Nc.Samplers=["depthSampler"],Nc.DefinesDepthNotNormalized="#define COC_DEPTH_NOT_NORMALIZED";class wc extends nc{constructor(e,t,i){super(e,t,i||new Nc(e,t.engine)),this.depthSamplingMode=2,this.onTexturesAllocatedObservable.add((e=>{e.setTextureSamplingMode(this.depthTexture,this.depthSamplingMode)}))}record(e=!1){if(void 0===this.sourceTexture||void 0===this.depthTexture||void 0===this.camera)throw new Error(`FrameGraphCircleOfConfusionTask "${this.name}": sourceTexture, depthTexture and camera are required`);const t=super.record(e,void 0,(e=>{this.postProcess.camera=this.camera,e.bindTextureHandle(this._postProcessDrawWrapper.effect,"depthSampler",this.depthTexture)}));return t.addDependencies(this.depthTexture),t}}class Fc extends gc{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("geomViewDepth",Wl.TextureViewDepth),this.registerInput("camera",Wl.Camera),this._finalizeInputOutputRegistering(),this._frameGraphTask=new wc(this.name,t,new Nc(e,i.getEngine(),{depthNotNormalized:!0}))}get depthSamplingMode(){return this._frameGraphTask.depthSamplingMode}set depthSamplingMode(e){this._frameGraphTask.depthSamplingMode=e}get lensSize(){return this._frameGraphTask.postProcess.lensSize}set lensSize(e){this._frameGraphTask.postProcess.lensSize=e}get fStop(){return this._frameGraphTask.postProcess.fStop}set fStop(e){this._frameGraphTask.postProcess.fStop=e}get focusDistance(){return this._frameGraphTask.postProcess.focusDistance}set focusDistance(e){this._frameGraphTask.postProcess.focusDistance=e}get focalLength(){return this._frameGraphTask.postProcess.focalLength}set focalLength(e){this._frameGraphTask.postProcess.focalLength=e}getClassName(){return"NodeRenderGraphCircleOfConfusionPostProcessBlock"}get geomViewDepth(){return this._inputs[2]}get camera(){return this._inputs[3]}_buildBlock(e){super._buildBlock(e),this._frameGraphTask.depthTexture=this.geomViewDepth.connectedPoint?.value,this._frameGraphTask.camera=this.camera.connectedPoint?.value}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.lensSize = ${this.lensSize};`),e.push(`${this._codeVariableName}.fStop = ${this.fStop};`),e.push(`${this._codeVariableName}.focusDistance = ${this.focusDistance};`),e.push(`${this._codeVariableName}.focalLength = ${this.focalLength};`),e.push(`${this._codeVariableName}.depthSamplingMode = ${this.depthSamplingMode};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.lensSize=this.lensSize,e.fStop=this.fStop,e.focusDistance=this.focusDistance,e.focalLength=this.focalLength,e.depthSamplingMode=this.depthSamplingMode,e}_deserialize(e){super._deserialize(e),this.lensSize=e.lensSize,this.fStop=e.fStop,this.focusDistance=e.focusDistance,this.focalLength=e.focalLength,this.depthSamplingMode=e.depthSamplingMode}}(0,Ge.Cg)([xh("Depth sampling mode",6,"PROPERTIES")],Fc.prototype,"depthSamplingMode",null),(0,Ge.Cg)([xh("Lens size",1,"PROPERTIES")],Fc.prototype,"lensSize",null),(0,Ge.Cg)([xh("F-Stop",1,"PROPERTIES")],Fc.prototype,"fStop",null),(0,Ge.Cg)([xh("Focus distance",1,"PROPERTIES")],Fc.prototype,"focusDistance",null),(0,Ge.Cg)([xh("Focal length",1,"PROPERTIES")],Fc.prototype,"focalLength",null),(0,a.Y5)("BABYLON.NodeRenderGraphCircleOfConfusionPostProcessBlock",Fc);class Bc extends Bi.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,89480)))):t.push(Promise.resolve().then(i.bind(i,19411)))}constructor(e,t=null,i){super({...i,name:e,engine:t||Vi.Engine.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Bc.FragmentUrl,samplers:Bc.Samplers})}}Bc.FragmentUrl="depthOfFieldMerge",Bc.Samplers=["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2"];class Vc extends nc{constructor(e,t,i){super(e,t,i||new Bc(e,t.engine)),this.blurSteps=[],this.onTexturesAllocatedObservable.add((e=>{e.setTextureSamplingMode(this.blurSteps[this.blurSteps.length-1],2)}))}record(e=!1){if(void 0===this.sourceTexture||void 0===this.circleOfConfusionTexture||0===this.blurSteps.length)throw new Error(`FrameGraphBloomMergeTask "${this.name}": sourceTexture, circleOfConfusionTexture and blurSteps are required`);this.postProcess.updateEffect("#define BLUR_LEVEL "+(this.blurSteps.length-1)+"\n");const t=super.record(e,void 0,(e=>{e.bindTextureHandle(this._postProcessDrawWrapper.effect,"circleOfConfusionSampler",this.circleOfConfusionTexture),this.blurSteps.forEach(((t,i)=>{e.bindTextureHandle(this._postProcessDrawWrapper.effect,"blurStep"+(this.blurSteps.length-i-1),t)}))}));return t.addDependencies(this.circleOfConfusionTexture),t.addDependencies(this.blurSteps),t}}class Lc extends Th{constructor(e,t=null,i,r,s){super(e,t,i,r,{...s,defines:"#define DOF 1\n"})}}class kc extends oc{constructor(e,t,i){super(e,t,i||new Lc(e,t.engine,new n.I9(1,0),10)),this.circleOfConfusionSamplingMode=2,this.onTexturesAllocatedObservable.add((e=>{e.setTextureSamplingMode(this.circleOfConfusionTexture,this.circleOfConfusionSamplingMode)}))}record(e=!1){if(void 0===this.sourceTexture||void 0===this.circleOfConfusionTexture)throw new Error(`FrameGraphDepthOfFieldBlurTask "${this.name}": sourceTexture and circleOfConfusionTexture are required`);const t=super.record(e,void 0,(e=>{e.bindTextureHandle(this._postProcessDrawWrapper.effect,"circleOfConfusionSampler",this.circleOfConfusionTexture)}));return t.addDependencies(this.circleOfConfusionTexture),t}}!function(e){e[e.Low=0]="Low",e[e.Medium=1]="Medium",e[e.High=2]="High"}(uc||(uc={}));class Gc{set focalLength(e){this._circleOfConfusion.focalLength=e}get focalLength(){return this._circleOfConfusion.focalLength}set fStop(e){this._circleOfConfusion.fStop=e}get fStop(){return this._circleOfConfusion.fStop}set focusDistance(e){this._circleOfConfusion.focusDistance=e}get focusDistance(){return this._circleOfConfusion.focusDistance}set lensSize(e){this._circleOfConfusion.lensSize=e}get lensSize(){return this._circleOfConfusion.lensSize}constructor(e,t,i=0,r=!1,s=!1){this._depthOfFieldBlurX=[],this._depthOfFieldBlurY=[],this._circleOfConfusion=new Nc(e,t,{depthNotNormalized:r,blockCompilation:s}),this.blurLevel=i;let o=1,a=15;switch(i){case 2:o=3,a=51;break;case 1:o=2,a=31;break;default:a=15,o=1}const l=a/Math.pow(2,o-1);let h=1;for(let i=0;i<o;i++)this._depthOfFieldBlurY.push([new Th(e,t,new n.I9(0,1),l,{blockCompilation:s}),h]),h=.75/Math.pow(2,i),this._depthOfFieldBlurX.push([new Th(e,t,new n.I9(1,0),l,{blockCompilation:s}),h]);this._dofMerge=new Bc(e,t,{blockCompilation:s})}isReady(){let e=this._circleOfConfusion.isReady()&&this._dofMerge.isReady();for(let t=0;t<this._depthOfFieldBlurX.length;t++)e=e&&this._depthOfFieldBlurX[t][0].isReady()&&this._depthOfFieldBlurY[t][0].isReady();return e}}class zc extends ih{get name(){return this._name}set name(e){if(this._name=e,this._circleOfConfusion&&(this._circleOfConfusion.name=`${e} Circle of Confusion`),this._blurX)for(let t=0;t<this._blurX.length;t++)this._blurX[t].name=`${e} Blur X${t}`,this._blurY[t].name=`${e} Blur Y${t}`;this._merge&&(this._merge.name=`${e} Merge`)}constructor(e,t,i=0,r=!1){if(super(e,t),this.sourceSamplingMode=2,this.depthSamplingMode=2,this._blurX=[],this._blurY=[],this._engine=t.engine,this.hdr=r,this._defaultPipelineTextureType=0,r){const e=t.engine.getCaps();e.textureHalfFloatRender?this._defaultPipelineTextureType=2:e.textureFloatRender&&(this._defaultPipelineTextureType=1)}this.depthOfField=new Gc(e,t.engine,i,!0),this._circleOfConfusion=new wc(`${e} Circle of Confusion`,this._frameGraph,this.depthOfField._circleOfConfusion);const s=this.depthOfField._depthOfFieldBlurX.length;for(let t=0;t<s;t++)this._blurX.push(new kc(`${e} Blur X${t}`,this._frameGraph,this.depthOfField._depthOfFieldBlurX[t][0])),this._blurY.push(new kc(`${e} Blur Y${t}`,this._frameGraph,this.depthOfField._depthOfFieldBlurY[t][0]));this._merge=new Vc(`${e} Merge`,this._frameGraph,this.depthOfField._dofMerge),this.onTexturesAllocatedObservable.add((e=>{this._circleOfConfusion.onTexturesAllocatedObservable.notifyObservers(e);for(let t=0;t<s;t++)this._blurX[t].onTexturesAllocatedObservable.notifyObservers(e),this._blurY[t].onTexturesAllocatedObservable.notifyObservers(e);this._merge.onTexturesAllocatedObservable.notifyObservers(e)})),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}isReady(){return this.depthOfField.isReady()}record(){if(void 0===this.sourceTexture||void 0===this.depthTexture||void 0===this.camera)throw new Error("FrameGraphDepthOfFieldTask: sourceTexture, depthTexture and camera are required");const e=this._frameGraph.textureManager.getTextureDescription(this.sourceTexture),t={width:e.size.width,height:e.size.height},i=this._engine.isWebGPU||this._engine.version>1?6:5,r={size:t,options:{createMipMaps:!1,types:[this._defaultPipelineTextureType],formats:[i],samples:1,useSRGBBuffers:[!1],labels:[""]},sizeIsPercentage:!1},s=this._frameGraph.textureManager.createRenderTargetTexture(this._circleOfConfusion.name,r);this._circleOfConfusion.sourceTexture=this.sourceTexture,this._circleOfConfusion.depthTexture=this.depthTexture,this._circleOfConfusion.depthSamplingMode=this.depthSamplingMode,this._circleOfConfusion.camera=this.camera,this._circleOfConfusion.targetTexture=s,this._circleOfConfusion.record(!0),r.options.formats=[5];const n=[];for(let i=0;i<this._blurX.length;i++){const o=this.depthOfField._depthOfFieldBlurX[i][1];t.width=Math.floor(e.size.width*o),t.height=Math.floor(e.size.height*o),r.options.labels[0]="step "+(i+1);const a=this._frameGraph.textureManager.createRenderTargetTexture(this._blurY[i].name,r);this._blurY[i].sourceTexture=0===i?this.sourceTexture:this._blurX[i-1].outputTexture,this._blurY[i].sourceSamplingMode=2,this._blurY[i].circleOfConfusionTexture=s,this._blurY[i].targetTexture=a,this._blurY[i].record(!0);const l=this._frameGraph.textureManager.createRenderTargetTexture(this._blurX[i].name,r);this._blurX[i].sourceTexture=this._blurY[i].outputTexture,this._blurX[i].sourceSamplingMode=2,this._blurX[i].circleOfConfusionTexture=s,this._blurX[i].targetTexture=l,this._blurX[i].record(!0),n.push(l)}const o=this._frameGraph.textureManager.getTextureCreationOptions(this.sourceTexture);this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture,this._merge.name,o),this._merge.sourceTexture=this.sourceTexture,this._merge.sourceSamplingMode=this.sourceSamplingMode,this._merge.circleOfConfusionTexture=s,this._merge.blurSteps=n,this._merge.targetTexture=this.outputTexture,this._merge.record(!0);const a=this._frameGraph.addRenderPass(this.name+"_disabled",!0);a.addDependencies(this.sourceTexture),a.setRenderTarget(this.outputTexture),a.setExecuteFunc((e=>{e.copyTexture(this.sourceTexture)}))}dispose(){this._circleOfConfusion.dispose();for(let e=0;e<this._blurX.length;e++)this._blurX[e].dispose(),this._blurY[e].dispose();this._merge.dispose(),super.dispose()}}class Uc extends gc{get task(){return this._frameGraphTask}constructor(e,t,i,r=0,s=!1){super(e,t,i),this._additionalConstructionParameters=[r,s],this.registerInput("geomViewDepth",Wl.TextureViewDepth),this.registerInput("camera",Wl.Camera),this._finalizeInputOutputRegistering(),this._frameGraphTask=new zc(this.name,t,r,s)}_createTask(e,t){const i=this._frameGraphTask.sourceSamplingMode,r=this._frameGraphTask.depthSamplingMode,s=this._frameGraphTask.depthOfField.focalLength,n=this._frameGraphTask.depthOfField.fStop,o=this._frameGraphTask.depthOfField.focusDistance,a=this._frameGraphTask.depthOfField.lensSize;this._frameGraphTask.dispose(),this._frameGraphTask=new zc(this.name,this._frameGraph,e,t),this._frameGraphTask.sourceSamplingMode=i,this._frameGraphTask.depthSamplingMode=r,this._frameGraphTask.depthOfField.focalLength=s,this._frameGraphTask.depthOfField.fStop=n,this._frameGraphTask.depthOfField.focusDistance=o,this._frameGraphTask.depthOfField.lensSize=a,this._additionalConstructionParameters=[e,t]}get blurLevel(){return this._frameGraphTask.depthOfField.blurLevel}set blurLevel(e){this._createTask(e,this._frameGraphTask.hdr)}get hdr(){return this._frameGraphTask.hdr}set hdr(e){this._createTask(this._frameGraphTask.depthOfField.blurLevel,e)}get depthSamplingMode(){return this._frameGraphTask.depthSamplingMode}set depthSamplingMode(e){this._frameGraphTask.depthSamplingMode=e}get focalLength(){return this._frameGraphTask.depthOfField.focalLength}set focalLength(e){this._frameGraphTask.depthOfField.focalLength=e}get fStop(){return this._frameGraphTask.depthOfField.fStop}set fStop(e){this._frameGraphTask.depthOfField.fStop=e}get focusDistance(){return this._frameGraphTask.depthOfField.focusDistance}set focusDistance(e){this._frameGraphTask.depthOfField.focusDistance=e}get lensSize(){return this._frameGraphTask.depthOfField.lensSize}set lensSize(e){this._frameGraphTask.depthOfField.lensSize=e}getClassName(){return"NodeRenderGraphDepthOfFieldPostProcessBlock"}get geomViewDepth(){return this._inputs[2]}get camera(){return this._inputs[3]}_buildBlock(e){super._buildBlock(e),this.output.value=this._frameGraphTask.outputTexture,this._frameGraphTask.depthTexture=this.geomViewDepth.connectedPoint?.value,this._frameGraphTask.camera=this.camera.connectedPoint?.value}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.lensSize = ${this.lensSize};`),e.push(`${this._codeVariableName}.fStop = ${this.fStop};`),e.push(`${this._codeVariableName}.focusDistance = ${this.focusDistance};`),e.push(`${this._codeVariableName}.focalLength = ${this.focalLength};`),e.push(`${this._codeVariableName}.depthSamplingMode = ${this.depthSamplingMode};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.lensSize=this.lensSize,e.fStop=this.fStop,e.focusDistance=this.focusDistance,e.focalLength=this.focalLength,e.depthSamplingMode=this.depthSamplingMode,e}_deserialize(e){super._deserialize(e),this.lensSize=e.lensSize,this.fStop=e.fStop,this.focusDistance=e.focusDistance,this.focalLength=e.focalLength,this.depthSamplingMode=e.depthSamplingMode}}(0,Ge.Cg)([xh("Blur level",4,"PROPERTIES",{options:[{label:"Low",value:0},{label:"Medium",value:1},{label:"High",value:2}]})],Uc.prototype,"blurLevel",null),(0,Ge.Cg)([xh("HDR",0,"PROPERTIES")],Uc.prototype,"hdr",null),(0,Ge.Cg)([xh("Depth sampling mode",6,"PROPERTIES")],Uc.prototype,"depthSamplingMode",null),(0,Ge.Cg)([xh("Focal length",1,"PROPERTIES")],Uc.prototype,"focalLength",null),(0,Ge.Cg)([xh("F-Stop",1,"PROPERTIES")],Uc.prototype,"fStop",null),(0,Ge.Cg)([xh("Focus distance",1,"PROPERTIES")],Uc.prototype,"focusDistance",null),(0,Ge.Cg)([xh("Lens size",1,"PROPERTIES")],Uc.prototype,"lensSize",null),(0,a.Y5)("BABYLON.NodeRenderGraphDepthOfFieldPostProcessBlock",Uc);class Wc extends gc{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._finalizeInputOutputRegistering(),this._frameGraphTask=new Ec(this.name,t,new Tc(e,i.getEngine()))}get threshold(){return this._frameGraphTask.postProcess.threshold}set threshold(e){this._frameGraphTask.postProcess.threshold=e}getClassName(){return"NodeRenderGraphExtractHighlightsPostProcessBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.threshold = ${this.threshold};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.threshold=this.threshold,e}_deserialize(e){super._deserialize(e),this.threshold=e.threshold}}(0,Ge.Cg)([xh("Threshold",1,"PROPERTIES",{min:0,max:1})],Wc.prototype,"threshold",null),(0,a.Y5)("BABYLON.NodeRenderGraphExtractHighlightsPostProcessBlock",Wc);class Hc extends nc{constructor(e,t,i){super(e,t,i||new dc.m(e,t.engine))}}class $c extends nc{constructor(e,t,i){super(e,t,i||new dc.V(e,t.engine))}}class qc extends gc{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._finalizeInputOutputRegistering(),this._frameGraphTask=new Hc(this.name,t,new dc.m(e,i.getEngine()))}getClassName(){return"NodeRenderGraphPassPostProcessBlock"}}(0,a.Y5)("BABYLON.NodeRenderGraphPassPostProcessBlock",qc);class Yc extends gc{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._finalizeInputOutputRegistering(),this._frameGraphTask=new $c(this.name,t,new dc.V(e,i.getEngine()))}getClassName(){return"NodeRenderGraphPassCubePostProcessBlock"}}(0,a.Y5)("BABYLON.NodeRenderGraphPassCubePostProcessBlock",Yc);const Xc=n.uq.Compose(new n.Pq(.5,.5,.5),n.PT.Identity(),new n.Pq(.5,.5,.5)),jc=n.uq.Compose(new n.Pq(.5,.5,1),n.PT.Identity(),new n.Pq(.5,.5,0));class Zc extends Bi.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,85423)))):t.push(Promise.resolve().then(i.bind(i,94354)))}get reflectivityThreshold(){return this._reflectivityThreshold}set reflectivityThreshold(e){e!==this._reflectivityThreshold&&(0===e&&0!==this._reflectivityThreshold||0!==e&&0===this._reflectivityThreshold?(this._reflectivityThreshold=e,this._updateEffectDefines()):this._reflectivityThreshold=e)}get useBlur(){return this._useBlur}set useBlur(e){this._useBlur!==e&&(this._useBlur=e,this._updateEffectDefines())}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e,this._updateEffectDefines()}get environmentTextureIsProbe(){return this._environmentTextureIsProbe}set environmentTextureIsProbe(e){this._environmentTextureIsProbe=e,this._updateEffectDefines()}get attenuateScreenBorders(){return this._attenuateScreenBorders}set attenuateScreenBorders(e){this._attenuateScreenBorders!==e&&(this._attenuateScreenBorders=e,this._updateEffectDefines())}get attenuateIntersectionDistance(){return this._attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._attenuateIntersectionDistance!==e&&(this._attenuateIntersectionDistance=e,this._updateEffectDefines())}get attenuateIntersectionIterations(){return this._attenuateIntersectionIterations}set attenuateIntersectionIterations(e){this._attenuateIntersectionIterations!==e&&(this._attenuateIntersectionIterations=e,this._updateEffectDefines())}get attenuateFacingCamera(){return this._attenuateFacingCamera}set attenuateFacingCamera(e){this._attenuateFacingCamera!==e&&(this._attenuateFacingCamera=e,this._updateEffectDefines())}get attenuateBackfaceReflection(){return this._attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._attenuateBackfaceReflection!==e&&(this._attenuateBackfaceReflection=e,this._updateEffectDefines())}get clipToFrustum(){return this._clipToFrustum}set clipToFrustum(e){this._clipToFrustum!==e&&(this._clipToFrustum=e,this._updateEffectDefines())}get useFresnel(){return this._useFresnel}set useFresnel(e){this._useFresnel!==e&&(this._useFresnel=e,this._updateEffectDefines())}get enableAutomaticThicknessComputation(){return this._enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._enableAutomaticThicknessComputation!==e&&(this._enableAutomaticThicknessComputation=e,this._updateEffectDefines())}get inputTextureColorIsInGammaSpace(){return this._inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._inputTextureColorIsInGammaSpace!==e&&(this._inputTextureColorIsInGammaSpace=e,this._updateEffectDefines())}get generateOutputInGammaSpace(){return this._generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._generateOutputInGammaSpace!==e&&(this._generateOutputInGammaSpace=e,this._updateEffectDefines())}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._updateEffectDefines())}get textureWidth(){return this._textureWidth}set textureWidth(e){this._textureWidth!==e&&(this._textureWidth=e)}get textureHeight(){return this._textureHeight}set textureHeight(e){this._textureHeight!==e&&(this._textureHeight=e)}get useScreenspaceDepth(){return this._useScreenspaceDepth}set useScreenspaceDepth(e){this._useScreenspaceDepth!==e&&(this._useScreenspaceDepth=e,this._updateEffectDefines())}get normalsAreInWorldSpace(){return this._normalsAreInWorldSpace}set normalsAreInWorldSpace(e){this._normalsAreInWorldSpace!==e&&(this._normalsAreInWorldSpace=e,this._updateEffectDefines())}get normalsAreUnsigned(){return this._normalsAreUnsigned}set normalsAreUnsigned(e){this._normalsAreUnsigned!==e&&(this._normalsAreUnsigned=e,this._updateEffectDefines())}constructor(e,t,i){super({...i,name:e,engine:t.getEngine()||Vi.Engine.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Zc.FragmentUrl,uniforms:Zc.Uniforms,samplers:Zc.Samplers,shaderLanguage:t.getEngine().isWebGPU?1:0}),this.isSSRSupported=!0,this.maxDistance=1e3,this.step=1,this.thickness=.5,this.strength=1,this.reflectionSpecularFalloffExponent=1,this.maxSteps=1e3,this.roughnessFactor=.2,this.selfCollisionNumSkip=1,this._reflectivityThreshold=.04,this._useBlur=!1,this._enableSmoothReflections=!1,this._environmentTextureIsProbe=!1,this._attenuateScreenBorders=!0,this._attenuateIntersectionDistance=!0,this._attenuateIntersectionIterations=!0,this._attenuateFacingCamera=!1,this._attenuateBackfaceReflection=!1,this._clipToFrustum=!0,this._useFresnel=!1,this._enableAutomaticThicknessComputation=!1,this._inputTextureColorIsInGammaSpace=!0,this._generateOutputInGammaSpace=!0,this._debug=!1,this._textureWidth=0,this._textureHeight=0,this.camera=null,this._useScreenspaceDepth=!1,this._normalsAreInWorldSpace=!1,this._normalsAreUnsigned=!1,this._scene=t,this._updateEffectDefines()}bind(){super.bind();const e=this._drawWrapper.effect,t=this.camera;if(!t)return;const i=t.getViewMatrix(),r=t.getProjectionMatrix();r.invertToRef(n.AA.Matrix[0]),i.invertToRef(n.AA.Matrix[1]),e.setMatrix("projection",r),e.setMatrix("view",i),e.setMatrix("invView",n.AA.Matrix[1]),e.setMatrix("invProjectionMatrix",n.AA.Matrix[0]),e.setFloat("thickness",this.thickness),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("strength",this.strength),e.setFloat("stepSize",this.step),e.setFloat("maxSteps",this.maxSteps),e.setFloat("roughnessFactor",this.roughnessFactor),e.setFloat("nearPlaneZ",t.minZ),e.setFloat("farPlaneZ",t.maxZ),e.setFloat("maxDistance",this.maxDistance),e.setFloat("selfCollisionNumSkip",this.selfCollisionNumSkip),e.setFloat("reflectivityThreshold",this._reflectivityThreshold),n.uq.ScalingToRef(this.textureWidth,this.textureHeight,1,n.AA.Matrix[2]),r.multiplyToRef(this._scene.getEngine().isWebGPU?jc:Xc,n.AA.Matrix[3]),n.AA.Matrix[3].multiplyToRef(n.AA.Matrix[2],n.AA.Matrix[4]),e.setMatrix("projectionPixel",n.AA.Matrix[4]),this._environmentTexture&&(e.setTexture("envCubeSampler",this._environmentTexture),this._environmentTexture.boundingBoxSize&&(e.setVector3("vReflectionPosition",this._environmentTexture.boundingBoxPosition),e.setVector3("vReflectionSize",this._environmentTexture.boundingBoxSize)))}_updateEffectDefines(){const e=[];this.isSSRSupported&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define SSRAYTRACE_ENABLE_REFINEMENT"),this._scene.useRightHandedSystem&&e.push("#define SSRAYTRACE_RIGHT_HANDED_SCENE"),this._useScreenspaceDepth&&e.push("#define SSRAYTRACE_SCREENSPACE_DEPTH"),this._environmentTexture&&(e.push("#define SSR_USE_ENVIRONMENT_CUBE"),this._environmentTexture.boundingBoxSize&&e.push("#define SSR_USE_LOCAL_REFLECTIONMAP_CUBIC"),this._environmentTexture.gammaSpace&&e.push("#define SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE")),this._environmentTextureIsProbe&&e.push("#define SSR_INVERTCUBICMAP"),this._enableAutomaticThicknessComputation&&e.push("#define SSRAYTRACE_USE_BACK_DEPTHBUFFER"),this._attenuateScreenBorders&&e.push("#define SSR_ATTENUATE_SCREEN_BORDERS"),this._attenuateIntersectionDistance&&e.push("#define SSR_ATTENUATE_INTERSECTION_DISTANCE"),this._attenuateIntersectionIterations&&e.push("#define SSR_ATTENUATE_INTERSECTION_NUMITERATIONS"),this._attenuateFacingCamera&&e.push("#define SSR_ATTENUATE_FACING_CAMERA"),this._attenuateBackfaceReflection&&e.push("#define SSR_ATTENUATE_BACKFACE_REFLECTION"),this._clipToFrustum&&e.push("#define SSRAYTRACE_CLIP_TO_FRUSTUM"),this.useBlur&&e.push("#define SSR_USE_BLUR"),this._debug&&e.push("#define SSRAYTRACE_DEBUG"),this._inputTextureColorIsInGammaSpace&&e.push("#define SSR_INPUT_IS_GAMMA_SPACE"),this._generateOutputInGammaSpace&&e.push("#define SSR_OUTPUT_IS_GAMMA_SPACE"),this._useFresnel&&e.push("#define SSR_BLEND_WITH_FRESNEL"),0===this._reflectivityThreshold&&e.push("#define SSR_DISABLE_REFLECTIVITY_TEST"),this._normalsAreInWorldSpace&&e.push("#define SSR_NORMAL_IS_IN_WORLDSPACE"),this._normalsAreUnsigned&&e.push("#define SSR_DECODE_NORMAL"),this.camera&&1===this.camera.mode&&e.push("#define ORTHOGRAPHIC_CAMERA"),this.updateEffect(e.join("\n"))}}Zc.FragmentUrl="screenSpaceReflection2",Zc.Uniforms=["projection","invProjectionMatrix","view","invView","thickness","reflectionSpecularFalloffExponent","strength","stepSize","maxSteps","roughnessFactor","projectionPixel","nearPlaneZ","farPlaneZ","maxDistance","selfCollisionNumSkip","vReflectionPosition","vReflectionSize","backSizeFactor","reflectivityThreshold"],Zc.Samplers=["textureSampler","normalSampler","reflectivitySampler","depthSampler","envCubeSampler","backDepthSampler"];class Qc extends Bi.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,66584)))):t.push(Promise.resolve().then(i.bind(i,68133)))}constructor(e,t=null,i,r,s){super({...s,name:e,engine:t||Vi.Engine.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Qc.FragmentUrl,uniforms:Qc.Uniforms,samplers:Qc.Samplers}),this.textureWidth=0,this.textureHeight=0,this.direction=new n.I9(1,0),this.blurStrength=.03,void 0!==i&&(this.direction=i),void 0!==r&&(this.blurStrength=r)}bind(){super.bind(),this._drawWrapper.effect.setFloat2("texelOffsetScale",1/this.textureWidth*this.direction.x*this.blurStrength,1/this.textureHeight*this.direction.y*this.blurStrength)}}Qc.FragmentUrl="screenSpaceReflection2Blur",Qc.Uniforms=["texelOffsetScale"],Qc.Samplers=["textureSampler"];class Kc extends Bi.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,44143)))):t.push(Promise.resolve().then(i.bind(i,17406)))}constructor(e,t=null,i){super({...i,name:e,engine:t||Vi.Engine.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Kc.FragmentUrl,uniforms:Kc.Uniforms,samplers:Kc.Samplers}),this.strength=1,this.reflectionSpecularFalloffExponent=1,this.camera=null,this._useFresnel=!1,this._useScreenspaceDepth=!1,this._inputTextureColorIsInGammaSpace=!0,this._generateOutputInGammaSpace=!0,this._debug=!1,this._reflectivityThreshold=.04,this._normalsAreInWorldSpace=!1,this._normalsAreUnsigned=!1,this._updateEffectDefines()}get useFresnel(){return this._useFresnel}set useFresnel(e){this._useFresnel!==e&&(this._useFresnel=e,this._updateEffectDefines())}get useScreenspaceDepth(){return this._useScreenspaceDepth}set useScreenspaceDepth(e){this._useScreenspaceDepth!==e&&(this._useScreenspaceDepth=e,this._updateEffectDefines())}get inputTextureColorIsInGammaSpace(){return this._inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._inputTextureColorIsInGammaSpace!==e&&(this._inputTextureColorIsInGammaSpace=e,this._updateEffectDefines())}get generateOutputInGammaSpace(){return this._generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._generateOutputInGammaSpace!==e&&(this._generateOutputInGammaSpace=e,this._updateEffectDefines())}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._updateEffectDefines())}get reflectivityThreshold(){return this._reflectivityThreshold}set reflectivityThreshold(e){e!==this._reflectivityThreshold&&(0===e&&0!==this._reflectivityThreshold||0!==e&&0===this._reflectivityThreshold?(this._reflectivityThreshold=e,this._updateEffectDefines()):this._reflectivityThreshold=e)}get normalsAreInWorldSpace(){return this._normalsAreInWorldSpace}set normalsAreInWorldSpace(e){this._normalsAreInWorldSpace!==e&&(this._normalsAreInWorldSpace=e,this._updateEffectDefines())}get normalsAreUnsigned(){return this._normalsAreUnsigned}set normalsAreUnsigned(e){this._normalsAreUnsigned!==e&&(this._normalsAreUnsigned=e,this._updateEffectDefines())}bind(){super.bind();const e=this._drawWrapper.effect;if(e.setFloat("strength",this.strength),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("reflectivityThreshold",this.reflectivityThreshold),this.useFresnel&&this.camera){const t=this.camera.getProjectionMatrix();t.invertToRef(n.AA.Matrix[0]),e.setMatrix("projection",t),e.setMatrix("invProjectionMatrix",n.AA.Matrix[0]),e.setMatrix("view",this.camera.getViewMatrix()),this.useScreenspaceDepth&&(e.setFloat("nearPlaneZ",this.camera.minZ),e.setFloat("farPlaneZ",this.camera.maxZ))}}_updateEffectDefines(){let e="";this._debug&&(e+="#define SSRAYTRACE_DEBUG\n"),this._inputTextureColorIsInGammaSpace&&(e+="#define SSR_INPUT_IS_GAMMA_SPACE\n"),this._generateOutputInGammaSpace&&(e+="#define SSR_OUTPUT_IS_GAMMA_SPACE\n"),this._useFresnel&&(e+="#define SSR_BLEND_WITH_FRESNEL\n"),this._useScreenspaceDepth&&(e+="#define SSRAYTRACE_SCREENSPACE_DEPTH\n"),0===this._reflectivityThreshold&&(e+="#define SSR_DISABLE_REFLECTIVITY_TEST\n"),this._normalsAreInWorldSpace&&(e+="#define SSR_NORMAL_IS_IN_WORLDSPACE\n"),this._normalsAreUnsigned&&(e+="#define SSR_DECODE_NORMAL\n"),this.updateEffect(e)}}Kc.FragmentUrl="screenSpaceReflection2BlurCombiner",Kc.Uniforms=["strength","reflectionSpecularFalloffExponent","reflectivityThreshold","projection","invProjectionMatrix","nearPlaneZ","farPlaneZ","view"],Kc.Samplers=["textureSampler","depthSampler","normalSampler","mainSampler","reflectivitySampler"];class Jc{get isSSRSupported(){return this._ssrPostProcess.isSSRSupported}set isSSRSupported(e){this._ssrPostProcess.isSSRSupported=e}get maxDistance(){return this._ssrPostProcess.maxDistance}set maxDistance(e){this._ssrPostProcess.maxDistance=e}get step(){return this._ssrPostProcess.step}set step(e){this._ssrPostProcess.step=e}get thickness(){return this._ssrPostProcess.thickness}set thickness(e){this._ssrPostProcess.thickness=e}get strength(){return this._ssrPostProcess.strength}set strength(e){this._ssrPostProcess.strength=e,this._ssrBlurCombinerPostProcess.strength=e}get reflectionSpecularFalloffExponent(){return this._ssrPostProcess.reflectionSpecularFalloffExponent}set reflectionSpecularFalloffExponent(e){this._ssrPostProcess.reflectionSpecularFalloffExponent=e,this._ssrBlurCombinerPostProcess.reflectionSpecularFalloffExponent=e}get maxSteps(){return this._ssrPostProcess.maxSteps}set maxSteps(e){this._ssrPostProcess.maxSteps=e}get roughnessFactor(){return this._ssrPostProcess.roughnessFactor}set roughnessFactor(e){this._ssrPostProcess.roughnessFactor=e}get selfCollisionNumSkip(){return this._ssrPostProcess.selfCollisionNumSkip}set selfCollisionNumSkip(e){this._ssrPostProcess.selfCollisionNumSkip=e}get reflectivityThreshold(){return this._ssrPostProcess.reflectivityThreshold}set reflectivityThreshold(e){e!==this._ssrPostProcess.reflectivityThreshold&&(this._ssrPostProcess.reflectivityThreshold=e,this._ssrBlurCombinerPostProcess.reflectivityThreshold=e)}get blurDispersionStrength(){return this._ssrBlurXPostProcess.blurStrength}set blurDispersionStrength(e){e!==this._ssrBlurXPostProcess.blurStrength&&(this._ssrPostProcess.useBlur=e>0,this._ssrBlurXPostProcess.blurStrength=e,this._ssrBlurYPostProcess.blurStrength=e)}get enableSmoothReflections(){return this._ssrPostProcess.enableSmoothReflections}set enableSmoothReflections(e){this._ssrPostProcess.enableSmoothReflections=e}get environmentTexture(){return this._ssrPostProcess.environmentTexture}set environmentTexture(e){this._ssrPostProcess.environmentTexture=e}get environmentTextureIsProbe(){return this._ssrPostProcess.environmentTextureIsProbe}set environmentTextureIsProbe(e){this._ssrPostProcess.environmentTextureIsProbe=e}get attenuateScreenBorders(){return this._ssrPostProcess.attenuateScreenBorders}set attenuateScreenBorders(e){this._ssrPostProcess.attenuateScreenBorders=e}get attenuateIntersectionDistance(){return this._ssrPostProcess.attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._ssrPostProcess.attenuateIntersectionDistance=e}get attenuateIntersectionIterations(){return this._ssrPostProcess.attenuateIntersectionIterations}set attenuateIntersectionIterations(e){this._ssrPostProcess.attenuateIntersectionIterations=e}get attenuateFacingCamera(){return this._ssrPostProcess.attenuateFacingCamera}set attenuateFacingCamera(e){this._ssrPostProcess.attenuateFacingCamera=e}get attenuateBackfaceReflection(){return this._ssrPostProcess.attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._ssrPostProcess.attenuateBackfaceReflection=e}get clipToFrustum(){return this._ssrPostProcess.clipToFrustum}set clipToFrustum(e){this._ssrPostProcess.clipToFrustum=e}get useFresnel(){return this._ssrPostProcess.useFresnel}set useFresnel(e){this._ssrPostProcess.useFresnel=e,this._ssrBlurCombinerPostProcess.useFresnel=e}get enableAutomaticThicknessComputation(){return this._ssrPostProcess.enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._ssrPostProcess.enableAutomaticThicknessComputation!==e&&(this._ssrPostProcess.enableAutomaticThicknessComputation=e)}get inputTextureColorIsInGammaSpace(){return this._ssrPostProcess.inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._ssrPostProcess.inputTextureColorIsInGammaSpace!==e&&(this._ssrPostProcess.inputTextureColorIsInGammaSpace=e,this._ssrBlurCombinerPostProcess.inputTextureColorIsInGammaSpace=e)}get generateOutputInGammaSpace(){return this._ssrPostProcess.generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._ssrPostProcess.generateOutputInGammaSpace!==e&&(this._ssrPostProcess.generateOutputInGammaSpace=e,this._ssrBlurCombinerPostProcess.generateOutputInGammaSpace=e)}get debug(){return this._ssrPostProcess.debug}set debug(e){this._ssrPostProcess.debug!==e&&(this._ssrPostProcess.debug=e,this._ssrBlurCombinerPostProcess.debug=e)}get camera(){return this._ssrPostProcess.camera}set camera(e){this._ssrPostProcess.camera=e,this._ssrBlurCombinerPostProcess.camera=e}get useScreenspaceDepth(){return this._ssrPostProcess.useScreenspaceDepth}set useScreenspaceDepth(e){this._ssrPostProcess.useScreenspaceDepth=e,this._ssrBlurCombinerPostProcess.useScreenspaceDepth=e}get normalsAreInWorldSpace(){return this._ssrPostProcess.normalsAreInWorldSpace}set normalsAreInWorldSpace(e){this._ssrPostProcess.normalsAreInWorldSpace=e,this._ssrBlurCombinerPostProcess.normalsAreInWorldSpace=e}get normalsAreUnsigned(){return this._ssrPostProcess.normalsAreUnsigned}set normalsAreUnsigned(e){this._ssrPostProcess.normalsAreUnsigned=e,this._ssrBlurCombinerPostProcess.normalsAreUnsigned=e}isReady(){return this._ssrPostProcess.isReady()&&this._ssrBlurXPostProcess.isReady()&&this._ssrBlurYPostProcess.isReady()&&this._ssrBlurCombinerPostProcess.isReady()}constructor(e,t){this.ssrDownsample=0,this.blurDownsample=0,this.name=e,this._scene=t,this._ssrPostProcess=new Zc(this.name,this._scene),this._ssrBlurXPostProcess=new Qc(this.name+" BlurX",this._scene.getEngine(),new n.I9(1,0)),this._ssrBlurYPostProcess=new Qc(this.name+" BlurY",this._scene.getEngine(),new n.I9(0,1)),this._ssrBlurCombinerPostProcess=new Kc(this.name+" BlurCombiner",this._scene.getEngine()),this._ssrPostProcess.useBlur=this._ssrBlurXPostProcess.blurStrength>0}dispose(){this._ssrPostProcess?.dispose(),this._ssrBlurXPostProcess?.dispose(),this._ssrBlurYPostProcess?.dispose(),this._ssrBlurCombinerPostProcess?.dispose()}}class eu extends nc{constructor(e,t,i){super(e,t,i||new Zc(e,t.scene)),this.onTexturesAllocatedObservable.add((e=>{e.setTextureSamplingMode(this.normalTexture,2),e.setTextureSamplingMode(this.depthTexture,2),e.setTextureSamplingMode(this.reflectivityTexture,2),this.backDepthTexture&&e.setTextureSamplingMode(this.backDepthTexture,1)}))}record(e=!1){if(void 0===this.sourceTexture||void 0===this.normalTexture||void 0===this.depthTexture||void 0===this.reflectivityTexture||void 0===this.camera)throw new Error(`FrameGraphSSRTask "${this.name}": sourceTexture, normalTexture, depthTexture, reflectivityTexture and camera are required`);const t=super.record(e,void 0,(e=>{this.postProcess.camera=this.camera,e.bindTextureHandle(this._postProcessDrawWrapper.effect,"normalSampler",this.normalTexture),e.bindTextureHandle(this._postProcessDrawWrapper.effect,"depthSampler",this.depthTexture),e.bindTextureHandle(this._postProcessDrawWrapper.effect,"reflectivitySampler",this.reflectivityTexture),this.backDepthTexture&&e.bindTextureHandle(this._postProcessDrawWrapper.effect,"backDepthSampler",this.backDepthTexture),this.postProcess.enableAutomaticThicknessComputation&&this._postProcessDrawWrapper.effect.setFloat("backSizeFactor",1)}));return t.addDependencies([this.normalTexture,this.depthTexture,this.reflectivityTexture]),this.postProcess.textureWidth=this._sourceWidth,this.postProcess.textureHeight=this._sourceHeight,t}}class tu extends nc{constructor(e,t,i){super(e,t,i||new Qc(e,t.engine,new n.I9(1,0),.03))}record(e=!1,t,i){const r=super.record(e,t,i);return this.postProcess.textureWidth=this._sourceWidth,this.postProcess.textureHeight=this._sourceHeight,r}}class iu extends ih{get camera(){return this._camera}set camera(e){e!==this._camera&&(this._camera=e,this.ssr.camera=e)}get name(){return this._name}set name(e){this._name=e,this._ssr&&(this._ssr.name=`${e} SSR`),this._ssrBlurX&&(this._ssrBlurX.name=`${e} SSR Blur X`),this._ssrBlurY&&(this._ssrBlurY.name=`${e} SSR Blur Y`),this._ssrBlurCombiner&&(this._ssrBlurCombiner.name=`${e} SSR Blur Combiner`)}constructor(e,t,i=0){super(e,t),this.sourceSamplingMode=2,this.textureType=i,this.ssr=new Jc(e,t.scene),this._ssr=new eu(`${e} SSR`,this._frameGraph,this.ssr._ssrPostProcess),this._ssrBlurX=new tu(`${e} SSR Blur X`,this._frameGraph,this.ssr._ssrBlurXPostProcess),this._ssrBlurY=new tu(`${e} SSR Blur Y`,this._frameGraph,this.ssr._ssrBlurYPostProcess),this._ssrBlurCombiner=new nc(`${e} SSR Blur Combiner`,this._frameGraph,this.ssr._ssrBlurCombinerPostProcess),this.onTexturesAllocatedObservable.add((e=>{this._ssr.onTexturesAllocatedObservable.notifyObservers(e),0!==this.ssr.blurDispersionStrength&&(this._ssrBlurX.onTexturesAllocatedObservable.notifyObservers(e),this._ssrBlurY.onTexturesAllocatedObservable.notifyObservers(e),this._ssrBlurCombiner.onTexturesAllocatedObservable.notifyObservers(e))})),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}isReady(){return this.ssr.isReady()}record(){if(void 0===this.sourceTexture||void 0===this.normalTexture||void 0===this.depthTexture||void 0===this.reflectivityTexture||void 0===this.camera)throw new Error(`FrameGraphSSRRenderingPipelineTask "${this.name}": sourceTexture, normalTexture, depthTexture, reflectivityTexture and camera are required`);const e=this._frameGraph.textureManager.getTextureDescription(this.sourceTexture);let t;this._ssr.sourceTexture=this.sourceTexture,this._ssr.sourceSamplingMode=this.sourceSamplingMode,this._ssr.camera=this.camera,this._ssr.normalTexture=this.normalTexture,this._ssr.depthTexture=this.depthTexture,this._ssr.backDepthTexture=this.backDepthTexture,this._ssr.reflectivityTexture=this.reflectivityTexture;const i={width:Math.floor(e.size.width/(this.ssr.ssrDownsample+1)),height:Math.floor(e.size.height/(this.ssr.ssrDownsample+1))},r={size:i,options:{createMipMaps:!1,types:[this.textureType],formats:[5],samples:1,useSRGBBuffers:[!1],labels:[""]},sizeIsPercentage:!1};if((this.ssr.blurDispersionStrength>0||!this.targetTexture)&&(t=this._frameGraph.textureManager.createRenderTargetTexture(this._ssr.name,r)),0===this.ssr.blurDispersionStrength)this._ssr.targetTexture=this.outputTexture,void 0!==t?this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,t):this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture),this._ssr.record(!0);else{this._ssr.targetTexture=t,this._ssr.record(!0),i.width=Math.floor(e.size.width/(this.ssr.blurDownsample+1)),i.height=Math.floor(e.size.height/(this.ssr.blurDownsample+1));const s=this._frameGraph.textureManager.getTextureCreationOptions(this.sourceTexture);this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture,this.name+" Output",s);const n=this._frameGraph.textureManager.createRenderTargetTexture(this._ssrBlurX.name,r);this._ssrBlurX.sourceTexture=t,this._ssrBlurX.sourceSamplingMode=2,this._ssrBlurX.targetTexture=n,this._ssrBlurX.record(!0);const o=this._frameGraph.textureManager.createRenderTargetTexture(this._ssrBlurY.name,r);this._ssrBlurY.sourceTexture=n,this._ssrBlurY.sourceSamplingMode=2,this._ssrBlurY.targetTexture=o,this._ssrBlurY.record(!0),this._ssrBlurCombiner.sourceTexture=this.sourceTexture,this._ssrBlurCombiner.sourceSamplingMode=this.sourceSamplingMode,this._ssrBlurCombiner.targetTexture=this.outputTexture;this._ssrBlurCombiner.record(!0,void 0,(e=>{e.bindTextureHandle(this._ssrBlurCombiner.drawWrapper.effect,"mainSampler",this.sourceTexture),e.bindTextureHandle(this._ssrBlurCombiner.drawWrapper.effect,"textureSampler",o),e.bindTextureHandle(this._ssrBlurCombiner.drawWrapper.effect,"reflectivitySampler",this.reflectivityTexture),this.ssr.useFresnel&&(e.bindTextureHandle(this._ssrBlurCombiner.drawWrapper.effect,"normalSampler",this.normalTexture),e.bindTextureHandle(this._ssrBlurCombiner.drawWrapper.effect,"depthSampler",this.depthTexture))})).addDependencies(o)}const s=this._frameGraph.addRenderPass(this.name+"_disabled",!0);s.addDependencies(this.sourceTexture),s.setRenderTarget(this.outputTexture),s.setExecuteFunc((e=>{e.copyTexture(this.sourceTexture)}))}dispose(){this._ssr.dispose(),this._ssrBlurX.dispose(),this._ssrBlurY.dispose(),this._ssrBlurCombiner.dispose(),this.ssr.dispose(),super.dispose()}}class ru extends gc{get task(){return this._frameGraphTask}constructor(e,t,i,r=0){super(e,t,i),this._additionalConstructionParameters=[r],this.registerInput("camera",Wl.Camera),this.registerInput("geomDepth",Wl.TextureViewDepth),this.registerInput("geomNormal",Wl.TextureViewNormal),this.registerInput("geomReflectivity",Wl.TextureReflectivity),this.registerInput("geomBackDepth",Wl.TextureViewDepth,!0),this.geomNormal.addAcceptedConnectionPointTypes(Wl.TextureWorldNormal),this.geomDepth.addAcceptedConnectionPointTypes(Wl.TextureScreenDepth),this.geomBackDepth.addAcceptedConnectionPointTypes(Wl.TextureScreenDepth),this._finalizeInputOutputRegistering(),this._frameGraphTask=new iu(this.name,t,r)}_createTask(e){const t=this.sourceSamplingMode,i=this.maxDistance,r=this.step,s=this.thickness,n=this.strength,o=this.reflectionSpecularFalloffExponent,a=this.maxSteps,l=this.roughnessFactor,h=this.selfCollisionNumSkip,c=this.reflectivityThreshold,u=this.ssrDownsample,d=this.blurDispersionStrength,p=this.blurDownsample,m=this.enableSmoothReflections,f=this.attenuateScreenBorders,_=this.attenuateIntersectionDistance,g=this.attenuateIntersectionIterations,x=this.attenuateFacingCamera,v=this.attenuateBackfaceReflection,S=this.clipToFrustum,b=this.enableAutomaticThicknessComputation,y=this.useFresnel,P=this.inputTextureColorIsInGammaSpace,T=this.generateOutputInGammaSpace,C=this.debug;this._frameGraphTask.dispose(),this._frameGraphTask=new iu(this.name,this._frameGraph,e),this.sourceSamplingMode=t,this.maxDistance=i,this.step=r,this.thickness=s,this.strength=n,this.reflectionSpecularFalloffExponent=o,this.maxSteps=a,this.roughnessFactor=l,this.selfCollisionNumSkip=h,this.reflectivityThreshold=c,this.ssrDownsample=u,this.blurDispersionStrength=d,this.blurDownsample=p,this.enableSmoothReflections=m,this.attenuateScreenBorders=f,this.attenuateIntersectionDistance=_,this.attenuateIntersectionIterations=g,this.attenuateFacingCamera=x,this.attenuateBackfaceReflection=v,this.clipToFrustum=S,this.useFresnel=y,this.enableAutomaticThicknessComputation=b,this.inputTextureColorIsInGammaSpace=P,this.generateOutputInGammaSpace=T,this.debug=C,this._additionalConstructionParameters=[e]}get textureType(){return this._frameGraphTask.textureType}set textureType(e){this._createTask(e)}get debug(){return this._frameGraphTask.ssr.debug}set debug(e){this._frameGraphTask.ssr.debug=e}get strength(){return this._frameGraphTask.ssr.strength}set strength(e){this._frameGraphTask.ssr.strength=e}get reflectionSpecularFalloffExponent(){return this._frameGraphTask.ssr.reflectionSpecularFalloffExponent}set reflectionSpecularFalloffExponent(e){this._frameGraphTask.ssr.reflectionSpecularFalloffExponent=e}get reflectivityThreshold(){return this._frameGraphTask.ssr.reflectivityThreshold}set reflectivityThreshold(e){this._frameGraphTask.ssr.reflectivityThreshold=e}get thickness(){return this._frameGraphTask.ssr.thickness}set thickness(e){this._frameGraphTask.ssr.thickness=e}get step(){return this._frameGraphTask.ssr.step}set step(e){this._frameGraphTask.ssr.step=e}get enableSmoothReflections(){return this._frameGraphTask.ssr.enableSmoothReflections}set enableSmoothReflections(e){this._frameGraphTask.ssr.enableSmoothReflections=e}get maxSteps(){return this._frameGraphTask.ssr.maxSteps}set maxSteps(e){this._frameGraphTask.ssr.maxSteps=e}get maxDistance(){return this._frameGraphTask.ssr.maxDistance}set maxDistance(e){this._frameGraphTask.ssr.maxDistance=e}get roughnessFactor(){return this._frameGraphTask.ssr.roughnessFactor}set roughnessFactor(e){this._frameGraphTask.ssr.roughnessFactor=e}get selfCollisionNumSkip(){return this._frameGraphTask.ssr.selfCollisionNumSkip}set selfCollisionNumSkip(e){this._frameGraphTask.ssr.selfCollisionNumSkip=e}get ssrDownsample(){return this._frameGraphTask.ssr.ssrDownsample}set ssrDownsample(e){this._frameGraphTask.ssr.ssrDownsample=e}get clipToFrustum(){return this._frameGraphTask.ssr.clipToFrustum}set clipToFrustum(e){this._frameGraphTask.ssr.clipToFrustum=e}get enableAutomaticThicknessComputation(){return this._frameGraphTask.ssr.enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._frameGraphTask.ssr.enableAutomaticThicknessComputation=e}get useFresnel(){return this._frameGraphTask.ssr.useFresnel}set useFresnel(e){this._frameGraphTask.ssr.useFresnel=e}get blurDispersionStrength(){return this._frameGraphTask.ssr.blurDispersionStrength}set blurDispersionStrength(e){this._frameGraphTask.ssr.blurDispersionStrength=e}get blurDownsample(){return this._frameGraphTask.ssr.blurDownsample}set blurDownsample(e){this._frameGraphTask.ssr.blurDownsample=e}get attenuateScreenBorders(){return this._frameGraphTask.ssr.attenuateScreenBorders}set attenuateScreenBorders(e){this._frameGraphTask.ssr.attenuateScreenBorders=e}get attenuateIntersectionDistance(){return this._frameGraphTask.ssr.attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._frameGraphTask.ssr.attenuateIntersectionDistance=e}get attenuateIntersectionIterations(){return this._frameGraphTask.ssr.attenuateIntersectionIterations}set attenuateIntersectionIterations(e){this._frameGraphTask.ssr.attenuateIntersectionIterations=e}get attenuateFacingCamera(){return this._frameGraphTask.ssr.attenuateFacingCamera}set attenuateFacingCamera(e){this._frameGraphTask.ssr.attenuateFacingCamera=e}get attenuateBackfaceReflection(){return this._frameGraphTask.ssr.attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._frameGraphTask.ssr.attenuateBackfaceReflection=e}get inputTextureColorIsInGammaSpace(){return this._frameGraphTask.ssr.inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._frameGraphTask.ssr.inputTextureColorIsInGammaSpace=e}get generateOutputInGammaSpace(){return this._frameGraphTask.ssr.generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._frameGraphTask.ssr.generateOutputInGammaSpace=e}getClassName(){return"NodeRenderGraphSSRPostProcessBlock"}get camera(){return this._inputs[2]}get geomDepth(){return this._inputs[3]}get geomNormal(){return this._inputs[4]}get geomReflectivity(){return this._inputs[5]}get geomBackDepth(){return this._inputs[6]}_buildBlock(e){if(super._buildBlock(e),this._frameGraphTask.normalTexture=this.geomNormal.connectedPoint?.value,this._frameGraphTask.depthTexture=this.geomDepth.connectedPoint?.value,this._frameGraphTask.reflectivityTexture=this.geomReflectivity.connectedPoint?.value,this._frameGraphTask.backDepthTexture=this.geomBackDepth.connectedPoint?.value,this._frameGraphTask.camera=this.camera.connectedPoint?.value,this.enableAutomaticThicknessComputation){if(!this._frameGraphTask.backDepthTexture)throw new Error(`SSR post process "${this.name}": Automatic thickness computation requires a back depth texture to be connected!`);const e=this.geomBackDepth.connectedPoint.ownerBlock;if("NodeRenderGraphGeometryRendererBlock"===e.getClassName()){if(!e.reverseCulling)throw new Error(`SSR post process "${this.name}": Automatic thickness computation requires the geometry renderer block for the back depth texture to have reverse culling enabled!`)}}this.geomNormal.connectedPoint&&this.geomNormal.connectedPoint.type===Wl.TextureWorldNormal&&(this._frameGraphTask.ssr.normalsAreInWorldSpace=!0,this._frameGraphTask.ssr.normalsAreUnsigned=!0),this.geomDepth.connectedPoint&&this.geomDepth.connectedPoint.type===Wl.TextureScreenDepth&&(this._frameGraphTask.ssr.useScreenspaceDepth=!0)}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.debug = ${this.debug};`),e.push(`${this._codeVariableName}.strength = ${this.strength};`),e.push(`${this._codeVariableName}.reflectionSpecularFalloffExponent = ${this.reflectionSpecularFalloffExponent};`),e.push(`${this._codeVariableName}.reflectivityThreshold = ${this.reflectivityThreshold};`),e.push(`${this._codeVariableName}.thickness = ${this.thickness};`),e.push(`${this._codeVariableName}.step = ${this.step};`),e.push(`${this._codeVariableName}.enableSmoothReflections = ${this.enableSmoothReflections};`),e.push(`${this._codeVariableName}.maxSteps = ${this.maxSteps};`),e.push(`${this._codeVariableName}.maxDistance = ${this.maxDistance};`),e.push(`${this._codeVariableName}.roughnessFactor = ${this.roughnessFactor};`),e.push(`${this._codeVariableName}.selfCollisionNumSkip = ${this.selfCollisionNumSkip};`),e.push(`${this._codeVariableName}.ssrDownsample = ${this.ssrDownsample};`),e.push(`${this._codeVariableName}.clipToFrustum = ${this.clipToFrustum};`),e.push(`${this._codeVariableName}.useFresnel = ${this.useFresnel};`),e.push(`${this._codeVariableName}.enableAutomaticThicknessComputation = ${this.enableAutomaticThicknessComputation};`),e.push(`${this._codeVariableName}.blurDispersionStrength = ${this.blurDispersionStrength};`),e.push(`${this._codeVariableName}.blurDownsample = ${this.blurDownsample};`),e.push(`${this._codeVariableName}.attenuateScreenBorders = ${this.attenuateScreenBorders};`),e.push(`${this._codeVariableName}.attenuateIntersectionDistance = ${this.attenuateIntersectionDistance};`),e.push(`${this._codeVariableName}.attenuateIntersectionIterations = ${this.attenuateIntersectionIterations};`),e.push(`${this._codeVariableName}.attenuateFacingCamera = ${this.attenuateFacingCamera};`),e.push(`${this._codeVariableName}.attenuateBackfaceReflection = ${this.attenuateBackfaceReflection};`),e.push(`${this._codeVariableName}.inputTextureColorIsInGammaSpace = ${this.inputTextureColorIsInGammaSpace};`),e.push(`${this._codeVariableName}.generateOutputInGammaSpace = ${this.generateOutputInGammaSpace};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.debug=this.debug,e.strength=this.strength,e.reflectionSpecularFalloffExponent=this.reflectionSpecularFalloffExponent,e.reflectivityThreshold=this.reflectivityThreshold,e.thickness=this.thickness,e.step=this.step,e.enableSmoothReflections=this.enableSmoothReflections,e.maxSteps=this.maxSteps,e.maxDistance=this.maxDistance,e.roughnessFactor=this.roughnessFactor,e.selfCollisionNumSkip=this.selfCollisionNumSkip,e.ssrDownsample=this.ssrDownsample,e.clipToFrustum=this.clipToFrustum,e.useFresnel=this.useFresnel,e.enableAutomaticThicknessComputation=this.enableAutomaticThicknessComputation,e.blurDispersionStrength=this.blurDispersionStrength,e.blurDownsample=this.blurDownsample,e.attenuateScreenBorders=this.attenuateScreenBorders,e.attenuateIntersectionDistance=this.attenuateIntersectionDistance,e.attenuateIntersectionIterations=this.attenuateIntersectionIterations,e.attenuateFacingCamera=this.attenuateFacingCamera,e.attenuateBackfaceReflection=this.attenuateBackfaceReflection,e.inputTextureColorIsInGammaSpace=this.inputTextureColorIsInGammaSpace,e.generateOutputInGammaSpace=this.generateOutputInGammaSpace,e}_deserialize(e){super._deserialize(e),this.debug=e.debug,this.strength=e.strength,this.reflectionSpecularFalloffExponent=e.reflectionSpecularFalloffExponent,this.reflectivityThreshold=e.reflectivityThreshold,this.thickness=e.thickness,this.step=e.step,this.enableSmoothReflections=e.enableSmoothReflections,this.maxSteps=e.maxSteps,this.maxDistance=e.maxDistance,this.roughnessFactor=e.roughnessFactor,this.selfCollisionNumSkip=e.selfCollisionNumSkip,this.ssrDownsample=e.ssrDownsample,this.clipToFrustum=e.clipToFrustum,this.useFresnel=e.useFresnel,this.enableAutomaticThicknessComputation=e.enableAutomaticThicknessComputation,this.blurDispersionStrength=e.blurDispersionStrength,this.blurDownsample=e.blurDownsample,this.attenuateScreenBorders=e.attenuateScreenBorders,this.attenuateIntersectionDistance=e.attenuateIntersectionDistance,this.attenuateIntersectionIterations=e.attenuateIntersectionIterations,this.attenuateFacingCamera=e.attenuateFacingCamera,this.attenuateBackfaceReflection=e.attenuateBackfaceReflection,this.inputTextureColorIsInGammaSpace=e.inputTextureColorIsInGammaSpace,this.generateOutputInGammaSpace=e.generateOutputInGammaSpace}}(0,Ge.Cg)([xh("Texture type",8,"SSR")],ru.prototype,"textureType",null),(0,Ge.Cg)([xh("Debug",0,"SSR")],ru.prototype,"debug",null),(0,Ge.Cg)([xh("Strength",1,"SSR",{min:0,max:5})],ru.prototype,"strength",null),(0,Ge.Cg)([xh("Reflection exponent",1,"SSR",{min:0,max:5})],ru.prototype,"reflectionSpecularFalloffExponent",null),(0,Ge.Cg)([xh("Reflectivity threshold",1,"SSR",{min:0,max:1})],ru.prototype,"reflectivityThreshold",null),(0,Ge.Cg)([xh("Thickness",1,"SSR",{min:0,max:10})],ru.prototype,"thickness",null),(0,Ge.Cg)([xh("Step",2,"SSR",{min:1,max:50})],ru.prototype,"step",null),(0,Ge.Cg)([xh("Smooth reflections",0,"SSR")],ru.prototype,"enableSmoothReflections",null),(0,Ge.Cg)([xh("Max steps",2,"SSR",{min:1,max:3e3})],ru.prototype,"maxSteps",null),(0,Ge.Cg)([xh("Max distance",1,"SSR",{min:1,max:3e3})],ru.prototype,"maxDistance",null),(0,Ge.Cg)([xh("Roughness factor",1,"SSR",{min:0,max:1})],ru.prototype,"roughnessFactor",null),(0,Ge.Cg)([xh("Self collision skips",2,"SSR",{min:1,max:10})],ru.prototype,"selfCollisionNumSkip",null),(0,Ge.Cg)([xh("SSR downsample",2,"SSR",{min:0,max:5})],ru.prototype,"ssrDownsample",null),(0,Ge.Cg)([xh("Clip to frustum",0,"SSR")],ru.prototype,"clipToFrustum",null),(0,Ge.Cg)([xh("Automatic thickness computation",0,"SSR")],ru.prototype,"enableAutomaticThicknessComputation",null),(0,Ge.Cg)([xh("Use Fresnel",0,"SSR")],ru.prototype,"useFresnel",null),(0,Ge.Cg)([xh("Strength",1,"Blur",{min:0,max:.15})],ru.prototype,"blurDispersionStrength",null),(0,Ge.Cg)([xh("Blur downsample",2,"Blur",{min:0,max:5})],ru.prototype,"blurDownsample",null),(0,Ge.Cg)([xh("Screen borders",0,"ATTENUATIONS")],ru.prototype,"attenuateScreenBorders",null),(0,Ge.Cg)([xh("Distance",0,"ATTENUATIONS")],ru.prototype,"attenuateIntersectionDistance",null),(0,Ge.Cg)([xh("Step iterations",0,"ATTENUATIONS")],ru.prototype,"attenuateIntersectionIterations",null),(0,Ge.Cg)([xh("Facing camera",0,"ATTENUATIONS")],ru.prototype,"attenuateFacingCamera",null),(0,Ge.Cg)([xh("Backface reflections",0,"ATTENUATIONS")],ru.prototype,"attenuateBackfaceReflection",null),(0,Ge.Cg)([xh("Input is in gamma space",0,"Color space")],ru.prototype,"inputTextureColorIsInGammaSpace",null),(0,Ge.Cg)([xh("Output to gamma space",0,"Color space")],ru.prototype,"generateOutputInGammaSpace",null),(0,a.Y5)("BABYLON.NodeRenderGraphSSRPostProcessBlock",ru);class su extends Zl{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("light",Wl.ShadowLight),this.registerInput("objects",Wl.ObjectList),this.registerInput("camera",Wl.Camera),this._addDependenciesInput(),this.registerOutput("generator",Wl.ShadowGenerator),this.registerOutput("output",Wl.Texture)}get mapSize(){return this._frameGraphTask.mapSize}set mapSize(e){this._frameGraphTask.mapSize=e}get useFloat32TextureType(){return this._frameGraphTask.useFloat32TextureType}set useFloat32TextureType(e){this._frameGraphTask.useFloat32TextureType=e}get useRedTextureFormat(){return this._frameGraphTask.useRedTextureFormat}set useRedTextureFormat(e){this._frameGraphTask.useRedTextureFormat=e}get bias(){return this._frameGraphTask.bias}set bias(e){this._frameGraphTask.bias=e}get normalBias(){return this._frameGraphTask.normalBias}set normalBias(e){this._frameGraphTask.normalBias=e}get darkness(){return this._frameGraphTask.darkness}set darkness(e){this._frameGraphTask.darkness=e}get filter(){return this._frameGraphTask.filter}set filter(e){this._frameGraphTask.filter=e}get filteringQuality(){return this._frameGraphTask.filteringQuality}set filteringQuality(e){this._frameGraphTask.filteringQuality=e}get transparencyShadow(){return this._frameGraphTask.transparencyShadow}set transparencyShadow(e){this._frameGraphTask.transparencyShadow=e}get enableSoftTransparentShadow(){return this._frameGraphTask.enableSoftTransparentShadow}set enableSoftTransparentShadow(e){this._frameGraphTask.enableSoftTransparentShadow=e}get useOpacityTextureForTransparentShadow(){return this._frameGraphTask.useOpacityTextureForTransparentShadow}set useOpacityTextureForTransparentShadow(e){this._frameGraphTask.useOpacityTextureForTransparentShadow=e}getClassName(){return"NodeRenderGraphBaseShadowGeneratorBlock"}get light(){return this._inputs[0]}get objects(){return this._inputs[1]}get camera(){return this._inputs[2]}get generator(){return this._outputs[0]}get output(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e),this._frameGraphTask.light=this.light.connectedPoint?.value,this._frameGraphTask.objectList=this.objects.connectedPoint?.value,this._frameGraphTask.camera=this.camera.connectedPoint?.value,this.generator.value=this._frameGraphTask,this.output.value=this._frameGraphTask.outputTexture}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.mapSize = ${this.mapSize};`),e.push(`${this._codeVariableName}.useFloat32TextureType = ${this.useFloat32TextureType};`),e.push(`${this._codeVariableName}.useRedTextureFormat = ${this.useRedTextureFormat};`),e.push(`${this._codeVariableName}.bias = ${this.bias};`),e.push(`${this._codeVariableName}.normalBias = ${this.normalBias};`),e.push(`${this._codeVariableName}.darkness = ${this.darkness};`),e.push(`${this._codeVariableName}.filter = ${this.filter};`),e.push(`${this._codeVariableName}.filteringQuality = ${this.filteringQuality};`),e.push(`${this._codeVariableName}.transparencyShadow = ${this.transparencyShadow};`),e.push(`${this._codeVariableName}.enableSoftTransparentShadow = ${this.enableSoftTransparentShadow};`),e.push(`${this._codeVariableName}.useOpacityTextureForTransparentShadow = ${this.useOpacityTextureForTransparentShadow};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.mapSize=this.mapSize,e.useFloat32TextureType=this.useFloat32TextureType,e.useRedTextureFormat=this.useRedTextureFormat,e.bias=this.bias,e.normalBias=this.normalBias,e.darkness=this.darkness,e.filter=this.filter,e.filteringQuality=this.filteringQuality,e.transparencyShadow=this.transparencyShadow,e.enableSoftTransparentShadow=this.enableSoftTransparentShadow,e.useOpacityTextureForTransparentShadow=this.useOpacityTextureForTransparentShadow,e}_deserialize(e){super._deserialize(e),this.mapSize=e.mapSize,this.useFloat32TextureType=e.useFloat32TextureType,this.useRedTextureFormat=e.useRedTextureFormat,this.bias=e.bias,this.normalBias=e.normalBias,this.darkness=e.darkness,this.filter=e.filter,this.filteringQuality=e.filteringQuality,this.transparencyShadow=e.transparencyShadow,this.enableSoftTransparentShadow=e.enableSoftTransparentShadow,this.useOpacityTextureForTransparentShadow=e.useOpacityTextureForTransparentShadow}}(0,Ge.Cg)([xh("Map size",4,"PROPERTIES",{options:[{label:"128",value:128},{label:"256",value:256},{label:"512",value:512},{label:"1024",value:1024},{label:"2048",value:2048},{label:"4096",value:4096},{label:"8192",value:8192}]})],su.prototype,"mapSize",null),(0,Ge.Cg)([xh("Use 32 bits float texture type",0,"PROPERTIES")],su.prototype,"useFloat32TextureType",null),(0,Ge.Cg)([xh("Use red texture format",0,"PROPERTIES")],su.prototype,"useRedTextureFormat",null),(0,Ge.Cg)([xh("Bias",1,"PROPERTIES",{min:0,max:1})],su.prototype,"bias",null),(0,Ge.Cg)([xh("Normal bias",1,"PROPERTIES",{min:0,max:1})],su.prototype,"normalBias",null),(0,Ge.Cg)([xh("Darkness",1,"PROPERTIES",{min:0,max:1})],su.prototype,"darkness",null),(0,Ge.Cg)([xh("Filter",4,"PROPERTIES",{options:[{label:"None",value:Ih.FILTER_NONE},{label:"Exponential",value:Ih.FILTER_EXPONENTIALSHADOWMAP},{label:"Poisson Sampling",value:Ih.FILTER_POISSONSAMPLING},{label:"Blur exponential",value:Ih.FILTER_BLUREXPONENTIALSHADOWMAP},{label:"Close exponential",value:Ih.FILTER_CLOSEEXPONENTIALSHADOWMAP},{label:"Blur close exponential",value:Ih.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP},{label:"PCF",value:Ih.FILTER_PCF},{label:"PCSS",value:Ih.FILTER_PCSS}]})],su.prototype,"filter",null),(0,Ge.Cg)([xh("Filter quality",4,"PROPERTIES",{options:[{label:"Low",value:Ih.QUALITY_LOW},{label:"Medium",value:Ih.QUALITY_MEDIUM},{label:"High",value:Ih.QUALITY_HIGH}]})],su.prototype,"filteringQuality",null),(0,Ge.Cg)([xh("Transparency shadow",0,"PROPERTIES")],su.prototype,"transparencyShadow",null),(0,Ge.Cg)([xh("Enable soft transparent shadows",0,"PROPERTIES")],su.prototype,"enableSoftTransparentShadow",null),(0,Ge.Cg)([xh("Use opacity texture for transparent shadows",0,"PROPERTIES")],su.prototype,"useOpacityTextureForTransparentShadow",null);class nu extends su{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._frameGraphTask=new $h(this.name,t,i)}get numCascades(){return this._frameGraphTask.numCascades}set numCascades(e){this._frameGraphTask.numCascades=e}get debug(){return this._frameGraphTask.debug}set debug(e){this._frameGraphTask.debug=e}get stabilizeCascades(){return this._frameGraphTask.stabilizeCascades}set stabilizeCascades(e){this._frameGraphTask.stabilizeCascades=e}get lambda(){return this._frameGraphTask.lambda}set lambda(e){this._frameGraphTask.lambda=e}get cascadeBlendPercentage(){return this._frameGraphTask.cascadeBlendPercentage}set cascadeBlendPercentage(e){this._frameGraphTask.cascadeBlendPercentage=e}get depthClamp(){return this._frameGraphTask.depthClamp}set depthClamp(e){this._frameGraphTask.depthClamp=e}get autoCalcDepthBounds(){return this._frameGraphTask.autoCalcDepthBounds}set autoCalcDepthBounds(e){this._frameGraphTask.autoCalcDepthBounds=e}get shadowMaxZ(){return this._frameGraphTask.shadowMaxZ}set shadowMaxZ(e){this._frameGraphTask.shadowMaxZ=e}getClassName(){return"NodeRenderGraphCascadedShadowGeneratorBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.numCascades = ${this.numCascades};`),e.push(`${this._codeVariableName}.debug = ${this.debug};`),e.push(`${this._codeVariableName}.stabilizeCascades = ${this.stabilizeCascades};`),e.push(`${this._codeVariableName}.lambda = ${this.lambda};`),e.push(`${this._codeVariableName}.cascadeBlendPercentage = ${this.cascadeBlendPercentage};`),e.push(`${this._codeVariableName}.depthClamp = ${this.depthClamp};`),e.push(`${this._codeVariableName}.autoCalcDepthBounds = ${this.autoCalcDepthBounds};`),e.push(`${this._codeVariableName}.shadowMaxZ = ${this.shadowMaxZ};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.numCascades=this.numCascades,e.debug=this.debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this.lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this.depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this.shadowMaxZ,e}_deserialize(e){super._deserialize(e),this.numCascades=e.numCascades,this.debug=e.debug,this.stabilizeCascades=e.stabilizeCascades,this.lambda=e.lambda,this.cascadeBlendPercentage=e.cascadeBlendPercentage,this.depthClamp=e.depthClamp,this.autoCalcDepthBounds=e.autoCalcDepthBounds,this.shadowMaxZ=e.shadowMaxZ}}(0,Ge.Cg)([xh("Number of cascades",4,"CSM PROPERTIES",{options:[{label:"2",value:2},{label:"3",value:3},{label:"4",value:4}]})],nu.prototype,"numCascades",null),(0,Ge.Cg)([xh("Debug mode",0,"CSM PROPERTIES")],nu.prototype,"debug",null),(0,Ge.Cg)([xh("Stabilize cascades",0,"CSM PROPERTIES")],nu.prototype,"stabilizeCascades",null),(0,Ge.Cg)([xh("Lambda",1,"CSM PROPERTIES",{min:0,max:1})],nu.prototype,"lambda",null),(0,Ge.Cg)([xh("Cascade blend",1,"CSM PROPERTIES",{min:0,max:1})],nu.prototype,"cascadeBlendPercentage",null),(0,Ge.Cg)([xh("Depth clamp",0,"CSM PROPERTIES")],nu.prototype,"depthClamp",null),(0,Ge.Cg)([xh("Auto-Calc depth bounds",0,"CSM PROPERTIES")],nu.prototype,"autoCalcDepthBounds",null),(0,Ge.Cg)([xh("Shadow maxZ",1,"CSM PROPERTIES")],nu.prototype,"shadowMaxZ",null),(0,a.Y5)("BABYLON.NodeRenderGraphCascadedShadowGeneratorBlock",nu);class ou extends ih{constructor(e,t,i){super(e,t),this._scene=i,this.outputObjectList={meshes:[],particleSystems:[]}}record(){if(void 0===this.objectList||void 0===this.camera)throw new Error(`FrameGraphCullObjectsTask ${this.name}: objectList and camera are required`);const e=this._frameGraph.addCullPass(this.name);e.setObjectList(this.outputObjectList),e.setExecuteFunc((e=>{this.outputObjectList.meshes=[],this.camera._updateFrustumPlanes();const t=this.camera._frustumPlanes,i=this.objectList.meshes||this._scene.meshes;for(let e=0;e<i.length;e++){const r=i[e];!r.isBlocked&&r.isReady()&&r.isEnabled()&&!r.scaling.hasAZeroComponent&&(r.isVisible&&r.visibility>0&&r.layerMask&this.camera.layerMask&&(this._scene.skipFrustumClipping||r.alwaysSelectAsActiveMesh||r.isInFrustum(t))&&this.outputObjectList.meshes.push(r))}}));const t=this._frameGraph.addCullPass(this.name+"_disabled",!0);t.setObjectList(this.outputObjectList),t.setExecuteFunc((e=>{this.outputObjectList.meshes=this.objectList.meshes,this.outputObjectList.particleSystems=this.objectList.particleSystems}))}}class au extends Zl{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("camera",Wl.Camera),this.registerInput("objects",Wl.ObjectList),this._addDependenciesInput(),this.registerOutput("output",Wl.ObjectList),this._frameGraphTask=new ou(this.name,t,i)}getClassName(){return"NodeRenderGraphCullObjectsBlock"}get camera(){return this._inputs[0]}get objects(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.output.value=this._frameGraphTask.outputObjectList,this._frameGraphTask.camera=this.camera.connectedPoint?.value,this._frameGraphTask.objectList=this.objects.connectedPoint?.value}_dumpPropertiesCode(){return super._dumpPropertiesCode()+[].join("\n")}serialize(){return super.serialize()}_deserialize(e){super._deserialize(e)}}(0,a.Y5)("BABYLON.NodeRenderGraphCullObjectsBlock",au);var lu=i(18598);const hu=[new o.ov(0,0,0,0),new o.ov(1,1,1,1),new o.ov(1e8,1e8,1e8,1e8)];class cu extends ih{get camera(){return this._camera}set camera(e){this._camera=e,this._renderer.activeCamera=this.camera}get reverseCulling(){return this._reverseCulling}set reverseCulling(e){this._reverseCulling=e;const t=lu.m.GetConfiguration(this._renderer.renderPassId);t&&(t.reverseCulling=e)}get objectRenderer(){return this._renderer}get name(){return this._name}set name(e){this._name=e,this._renderer&&(this._renderer.name=e)}constructor(e,t,i,r){super(e,t),this.depthTest=!0,this.depthWrite=!0,this.size={width:100,height:100},this.sizeIsPercentage=!0,this.samples=1,this._reverseCulling=!1,this.dontRenderWhenMaterialDepthWriteIsDisabled=!0,this.textureDescriptions=[],this._scene=i,this._engine=this._scene.getEngine(),this._renderer=new yh.P(e,i,r),this._renderer.renderSprites=!1,this._renderer.renderParticles=!1,this._renderer.customIsReadyFunction=(e,t,i)=>this.dontRenderWhenMaterialDepthWriteIsDisabled&&e.material&&e.material.disableDepthWrite?!!i:e.isReady(0===t),this._renderer.onBeforeRenderingManagerRenderObservable.add((()=>{this._renderer.options.doNotChangeAspectRatio||i.updateTransformMatrix(!0)})),this.name=e,this._clearAttachmentsLayout=new Map,this._allAttachmentsLayout=[],this.outputDepthTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryViewDepthTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryScreenDepthTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryViewNormalTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryWorldNormalTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryLocalPositionTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryWorldPositionTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryAlbedoTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryReflectivityTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryVelocityTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryLinearVelocityTexture=this._frameGraph.textureManager.createDanglingHandle()}get excludedSkinnedMeshFromVelocityTexture(){return lu.m.GetConfiguration(this._renderer.renderPassId).excludedSkinnedMesh}isReady(){return this._renderer.isReadyForRendering(this._textureWidth,this._textureHeight)}record(){if(0===this.textureDescriptions.length||void 0===this.objectList)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: object list and at least one geometry texture description must be provided`);this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems;const e=this._createMultiRenderTargetTexture(),t=this._checkDepthTextureCompatibility();this._buildClearAttachmentsLayout(),this._registerForRenderPassId(this._renderer.renderPassId);const i=this._frameGraph.textureManager.getTextureDescription(e[0]);this._textureWidth=i.size.width,this._textureHeight=i.size.height,lu.m.MarkAsDirty(this._renderer.renderPassId,this.objectList.meshes||this._scene.meshes);const r=this._frameGraph.addRenderPass(this.name);r.setRenderTarget(e);for(let t=0;t<this.textureDescriptions.length;t++){const i=this.textureDescriptions[t],r=e[t],s=lu.m.GeometryTextureDescriptions.findIndex((e=>e.type===i.type));switch(lu.m.GeometryTextureDescriptions[s].type){case 5:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryViewDepthTexture,r);break;case 10:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryScreenDepthTexture,r);break;case 6:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryViewNormalTexture,r);break;case 8:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryWorldNormalTexture,r);break;case 9:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryLocalPositionTexture,r);break;case 1:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryWorldPositionTexture,r);break;case 12:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryAlbedoTexture,r);break;case 3:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryReflectivityTexture,r);break;case 2:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryVelocityTexture,r);break;case 11:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryLinearVelocityTexture,r)}}r.setRenderTargetDepth(this.depthTexture),r.setExecuteFunc((e=>{this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems,e.setDepthStates(this.depthTest&&t,this.depthWrite&&t),this._clearAttachmentsLayout.forEach(((t,i)=>{e.clearColorAttachments(hu[i],t)})),e.bindAttachments(this._allAttachmentsLayout),e.render(this._renderer,this._textureWidth,this._textureHeight)}));const s=this._frameGraph.addRenderPass(this.name+"_disabled",!0);s.setRenderTarget(e),s.setRenderTargetDepth(this.depthTexture),s.setExecuteFunc((e=>{}))}dispose(){lu.m.DeleteConfiguration(this._renderer.renderPassId),this._renderer.dispose(),super.dispose()}_createMultiRenderTargetTexture(){const e=[],t=[],i=[],r=[];for(let s=0;s<this.textureDescriptions.length;s++){const n=this.textureDescriptions[s],o=lu.m.GeometryTextureDescriptions.findIndex((e=>e.type===n.type));if(-1===o)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: unknown texture type ${n.type}`);e[s]=n.textureType,t[s]=n.textureFormat,i[s]=lu.m.GeometryTextureDescriptions[o].name,r[s]=!1}const s=this._frameGraph.textureManager.createRenderTargetTexture(this.name,{size:this.size,sizeIsPercentage:this.sizeIsPercentage,options:{createMipMaps:!1,samples:this.samples,types:e,formats:t,useSRGBBuffers:r,labels:i}}),n=[];for(let e=0;e<this.textureDescriptions.length;e++)n.push(s+e);return n}_checkDepthTextureCompatibility(){let e=!1;if(void 0!==this.depthTexture){if(this.depthTexture===Kl)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: the depth/stencil back buffer is not allowed as a depth texture`);if(this._frameGraph.textureManager.getTextureDescription(this.depthTexture).options.samples!==this.samples)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: the depth texture and the output texture must have the same number of samples`);this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthTexture,this.depthTexture),e=!0}return e}_buildClearAttachmentsLayout(){const e=new Map,t=[];for(let i=0;i<this.textureDescriptions.length;i++){const r=this.textureDescriptions[i],s=lu.m.GeometryTextureDescriptions.findIndex((e=>e.type===r.type)),n=lu.m.GeometryTextureDescriptions[s];let o=e.get(n.clearType);if(void 0===o){o=[],e.set(n.clearType,o);for(let e=0;e<i;e++)o[e]=!1}e.forEach(((e,t)=>{e.push(t===n.clearType)})),t.push(!0)}this._clearAttachmentsLayout=new Map,e.forEach(((e,t)=>{this._clearAttachmentsLayout.set(t,this._engine.buildTextureLayout(e))})),this._allAttachmentsLayout=this._engine.buildTextureLayout(t)}_registerForRenderPassId(e){const t=lu.m.CreateConfiguration(e);for(let e=0;e<this.textureDescriptions.length;e++){const i=this.textureDescriptions[e],r=lu.m.GeometryTextureDescriptions.findIndex((e=>e.type===i.type)),s=lu.m.GeometryTextureDescriptions[r];t.defines[s.defineIndex]=e}t.reverseCulling=this.reverseCulling}}class uu extends Zl{get task(){return this._frameGraphTask}constructor(e,t,i,r=!0){super(e,t,i),this.viewDepthFormat=6,this.viewDepthType=1,this.screenDepthFormat=6,this.screenDepthType=1,this.viewNormalFormat=5,this.viewNormalType=2,this.worldNormalFormat=5,this.worldNormalType=0,this.localPositionFormat=5,this.localPositionType=2,this.worldPositionFormat=5,this.worldPositionType=2,this.albedoFormat=5,this.albedoType=0,this.reflectivityFormat=5,this.reflectivityType=0,this.velocityFormat=5,this.velocityType=0,this.linearVelocityFormat=5,this.linearVelocityType=0,this._additionalConstructionParameters=[r],this.registerInput("depth",Wl.TextureBackBufferDepthStencilAttachment,!0),this.registerInput("camera",Wl.Camera),this.registerInput("objects",Wl.ObjectList),this._addDependenciesInput(),this.registerOutput("outputDepth",Wl.BasedOnInput),this.registerOutput("geomViewDepth",Wl.TextureViewDepth),this.registerOutput("geomScreenDepth",Wl.TextureScreenDepth),this.registerOutput("geomViewNormal",Wl.TextureViewNormal),this.registerOutput("geomWorldNormal",Wl.TextureWorldNormal),this.registerOutput("geomLocalPosition",Wl.TextureLocalPosition),this.registerOutput("geomWorldPosition",Wl.TextureWorldPosition),this.registerOutput("geomAlbedo",Wl.TextureAlbedo),this.registerOutput("geomReflectivity",Wl.TextureReflectivity),this.registerOutput("geomVelocity",Wl.TextureVelocity),this.registerOutput("geomLinearVelocity",Wl.TextureLinearVelocity),this.depth.addAcceptedConnectionPointTypes(Wl.TextureDepthStencilAttachment),this.outputDepth._typeConnectionSource=this.depth,this._frameGraphTask=new cu(this.name,t,i,{doNotChangeAspectRatio:r})}get depthTest(){return this._frameGraphTask.depthTest}set depthTest(e){this._frameGraphTask.depthTest=e}get depthWrite(){return this._frameGraphTask.depthWrite}set depthWrite(e){this._frameGraphTask.depthWrite=e}get doNotChangeAspectRatio(){return this._frameGraphTask.objectRenderer.options.doNotChangeAspectRatio}set doNotChangeAspectRatio(e){this._frameGraphTask.dispose(),this._frameGraphTask=new cu(this.name,this._frameGraph,this._scene,{doNotChangeAspectRatio:e}),this._additionalConstructionParameters=[e]}get width(){return this._frameGraphTask.size.width}set width(e){this._frameGraphTask.size.width=e}get height(){return this._frameGraphTask.size.height}set height(e){this._frameGraphTask.size.height=e}get sizeInPercentage(){return this._frameGraphTask.sizeIsPercentage}set sizeInPercentage(e){this._frameGraphTask.sizeIsPercentage=e}get samples(){return this._frameGraphTask.samples}set samples(e){this._frameGraphTask.samples=e}get reverseCulling(){return this._frameGraphTask.reverseCulling}set reverseCulling(e){this._frameGraphTask.reverseCulling=e}get dontRenderWhenMaterialDepthWriteIsDisabled(){return this._frameGraphTask.dontRenderWhenMaterialDepthWriteIsDisabled}set dontRenderWhenMaterialDepthWriteIsDisabled(e){this._frameGraphTask.dontRenderWhenMaterialDepthWriteIsDisabled=e}getClassName(){return"NodeRenderGraphGeometryRendererBlock"}get depth(){return this._inputs[0]}get camera(){return this._inputs[1]}get objects(){return this._inputs[2]}get outputDepth(){return this._outputs[0]}get geomViewDepth(){return this._outputs[1]}get geomScreenDepth(){return this._outputs[2]}get geomViewNormal(){return this._outputs[3]}get geomWorldNormal(){return this._outputs[4]}get geomLocalPosition(){return this._outputs[5]}get geomWorldPosition(){return this._outputs[6]}get geomAlbedo(){return this._outputs[7]}get geomReflectivity(){return this._outputs[8]}get geomVelocity(){return this._outputs[9]}get geomLinearVelocity(){return this._outputs[10]}_buildBlock(e){super._buildBlock(e);const t=[this.geomViewDepth.isConnected,this.geomScreenDepth.isConnected,this.geomViewNormal.isConnected,this.geomWorldNormal.isConnected,this.geomLocalPosition.isConnected,this.geomWorldPosition.isConnected,this.geomAlbedo.isConnected,this.geomReflectivity.isConnected,this.geomVelocity.isConnected,this.geomLinearVelocity.isConnected];if(t.every((e=>!e)))throw new Error("NodeRenderGraphGeometryRendererBlock: At least one output geometry buffer must be connected");this.outputDepth.value=this._frameGraphTask.outputDepthTexture,this.geomViewDepth.value=this._frameGraphTask.geometryViewDepthTexture,this.geomScreenDepth.value=this._frameGraphTask.geometryScreenDepthTexture,this.geomViewNormal.value=this._frameGraphTask.geometryViewNormalTexture,this.geomWorldNormal.value=this._frameGraphTask.geometryWorldNormalTexture,this.geomLocalPosition.value=this._frameGraphTask.geometryLocalPositionTexture,this.geomWorldPosition.value=this._frameGraphTask.geometryWorldPositionTexture,this.geomAlbedo.value=this._frameGraphTask.geometryAlbedoTexture,this.geomReflectivity.value=this._frameGraphTask.geometryReflectivityTexture,this.geomVelocity.value=this._frameGraphTask.geometryVelocityTexture,this.geomLinearVelocity.value=this._frameGraphTask.geometryLinearVelocityTexture,this._frameGraphTask.depthTexture=this.depth.connectedPoint?.value,this._frameGraphTask.camera=this.camera.connectedPoint?.value,this._frameGraphTask.objectList=this.objects.connectedPoint?.value,this._frameGraphTask.textureDescriptions=[];const i=[this.viewDepthFormat,this.screenDepthFormat,this.viewNormalFormat,this.worldNormalFormat,this.localPositionFormat,this.worldPositionFormat,this.albedoFormat,this.reflectivityFormat,this.velocityFormat,this.linearVelocityFormat],r=[this.viewDepthType,this.screenDepthType,this.viewNormalType,this.worldNormalType,this.localPositionType,this.worldPositionType,this.albedoType,this.reflectivityType,this.velocityType,this.linearVelocityType],s=[5,10,6,8,9,1,12,3,2,11];for(let e=0;e<t.length;e++)t[e]&&this._frameGraphTask.textureDescriptions.push({textureFormat:i[e],textureType:r[e],type:s[e]})}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.depthTest = ${this.depthTest};`),e.push(`${this._codeVariableName}.depthWrite = ${this.depthWrite};`),e.push(`${this._codeVariableName}.samples = ${this.samples};`),e.push(`${this._codeVariableName}.reverseCulling = ${this.reverseCulling};`),e.push(`${this._codeVariableName}.dontRenderWhenMaterialDepthWriteIsDisabled = ${this.dontRenderWhenMaterialDepthWriteIsDisabled};`),e.push(`${this._codeVariableName}.viewDepthFormat = ${this.viewDepthFormat};`),e.push(`${this._codeVariableName}.viewDepthType = ${this.viewDepthType};`),e.push(`${this._codeVariableName}.screenDepthFormat = ${this.screenDepthFormat};`),e.push(`${this._codeVariableName}.screenDepthType = ${this.screenDepthType};`),e.push(`${this._codeVariableName}.localPositionFormat = ${this.localPositionFormat};`),e.push(`${this._codeVariableName}.localPositionType = ${this.localPositionType};`),e.push(`${this._codeVariableName}.worldPositionFormat = ${this.worldPositionFormat};`),e.push(`${this._codeVariableName}.worldPositionType = ${this.worldPositionType};`),e.push(`${this._codeVariableName}.viewNormalFormat = ${this.viewNormalFormat};`),e.push(`${this._codeVariableName}.viewNormalType = ${this.viewNormalType};`),e.push(`${this._codeVariableName}.worldNormalFormat = ${this.worldNormalFormat};`),e.push(`${this._codeVariableName}.worldNormalType = ${this.worldNormalType};`),e.push(`${this._codeVariableName}.albedoFormat = ${this.albedoFormat};`),e.push(`${this._codeVariableName}.albedoType = ${this.albedoType};`),e.push(`${this._codeVariableName}.reflectivityFormat = ${this.reflectivityFormat};`),e.push(`${this._codeVariableName}.reflectivityType = ${this.reflectivityType};`),e.push(`${this._codeVariableName}.velocityFormat = ${this.velocityFormat};`),e.push(`${this._codeVariableName}.velocityType = ${this.velocityType};`),e.push(`${this._codeVariableName}.linearVelocityFormat = ${this.linearVelocityFormat};`),e.push(`${this._codeVariableName}.linearVelocityType = ${this.linearVelocityType};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.samples=this.samples,e.reverseCulling=this.reverseCulling,e.dontRenderWhenMaterialDepthWriteIsDisabled=this.dontRenderWhenMaterialDepthWriteIsDisabled,e.viewDepthFormat=this.viewDepthFormat,e.viewDepthType=this.viewDepthType,e.screenDepthFormat=this.screenDepthFormat,e.screenDepthType=this.screenDepthType,e.localPositionFormat=this.localPositionFormat,e.localPositionType=this.localPositionType,e.worldPositionFormat=this.worldPositionFormat,e.worldPositionType=this.worldPositionType,e.viewNormalFormat=this.viewNormalFormat,e.viewNormalType=this.viewNormalType,e.worldNormalFormat=this.worldNormalFormat,e.worldNormalType=this.worldNormalType,e.albedoFormat=this.albedoFormat,e.albedoType=this.albedoType,e.reflectivityFormat=this.reflectivityFormat,e.reflectivityType=this.reflectivityType,e.velocityFormat=this.velocityFormat,e.velocityType=this.velocityType,e.linearVelocityFormat=this.linearVelocityFormat,e.linearVelocityType=this.linearVelocityType,e}_deserialize(e){super._deserialize(e),this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.samples=e.samples,this.reverseCulling=e.reverseCulling,this.dontRenderWhenMaterialDepthWriteIsDisabled=e.dontRenderWhenMaterialDepthWriteIsDisabled,this.viewDepthFormat=e.viewDepthFormat,this.viewDepthType=e.viewDepthType,this.screenDepthFormat=e.screenDepthFormat,this.screenDepthType=e.screenDepthType,this.localPositionFormat=e.localPositionFormat,this.localPositionType=e.localPositionType,this.worldPositionFormat=e.worldPositionFormat,this.worldPositionType=e.worldPositionType,this.viewNormalFormat=e.viewNormalFormat,this.viewNormalType=e.viewNormalType,this.worldNormalFormat=e.worldNormalFormat,this.worldNormalType=e.worldNormalType,this.albedoFormat=e.albedoFormat,this.albedoType=e.albedoType,this.reflectivityFormat=e.reflectivityFormat,this.reflectivityType=e.reflectivityType,this.velocityFormat=e.velocityFormat,this.velocityType=e.velocityType,this.linearVelocityFormat=e.linearVelocityFormat,this.linearVelocityType=e.linearVelocityType}}(0,Ge.Cg)([xh("Depth test",0,"PROPERTIES")],uu.prototype,"depthTest",null),(0,Ge.Cg)([xh("Depth write",0,"PROPERTIES")],uu.prototype,"depthWrite",null),(0,Ge.Cg)([xh("Do not change aspect ratio",0,"PROPERTIES")],uu.prototype,"doNotChangeAspectRatio",null),(0,Ge.Cg)([xh("Texture width",2,"PROPERTIES")],uu.prototype,"width",null),(0,Ge.Cg)([xh("Texture height",2,"PROPERTIES")],uu.prototype,"height",null),(0,Ge.Cg)([xh("Size is in percentage",0,"PROPERTIES")],uu.prototype,"sizeInPercentage",null),(0,Ge.Cg)([xh("Samples",2,"PROPERTIES",{min:1,max:8})],uu.prototype,"samples",null),(0,Ge.Cg)([xh("Reverse culling",0,"PROPERTIES")],uu.prototype,"reverseCulling",null),(0,Ge.Cg)([xh("Don't render if material depth write is disabled",0,"PROPERTIES")],uu.prototype,"dontRenderWhenMaterialDepthWriteIsDisabled",null),(0,Ge.Cg)([xh("View depth format",7,"GEOMETRY BUFFERS")],uu.prototype,"viewDepthFormat",void 0),(0,Ge.Cg)([xh("View depth type",8,"GEOMETRY BUFFERS")],uu.prototype,"viewDepthType",void 0),(0,Ge.Cg)([xh("Screen depth format",7,"GEOMETRY BUFFERS")],uu.prototype,"screenDepthFormat",void 0),(0,Ge.Cg)([xh("Screen depth type",8,"GEOMETRY BUFFERS")],uu.prototype,"screenDepthType",void 0),(0,Ge.Cg)([xh("View normal format",7,"GEOMETRY BUFFERS")],uu.prototype,"viewNormalFormat",void 0),(0,Ge.Cg)([xh("View normal type",8,"GEOMETRY BUFFERS")],uu.prototype,"viewNormalType",void 0),(0,Ge.Cg)([xh("World normal format",7,"GEOMETRY BUFFERS")],uu.prototype,"worldNormalFormat",void 0),(0,Ge.Cg)([xh("World normal type",8,"GEOMETRY BUFFERS")],uu.prototype,"worldNormalType",void 0),(0,Ge.Cg)([xh("Local position format",7,"GEOMETRY BUFFERS")],uu.prototype,"localPositionFormat",void 0),(0,Ge.Cg)([xh("Local position type",8,"GEOMETRY BUFFERS")],uu.prototype,"localPositionType",void 0),(0,Ge.Cg)([xh("World position format",7,"GEOMETRY BUFFERS")],uu.prototype,"worldPositionFormat",void 0),(0,Ge.Cg)([xh("World position type",8,"GEOMETRY BUFFERS")],uu.prototype,"worldPositionType",void 0),(0,Ge.Cg)([xh("Albedo format",7,"GEOMETRY BUFFERS")],uu.prototype,"albedoFormat",void 0),(0,Ge.Cg)([xh("Albedo type",8,"GEOMETRY BUFFERS")],uu.prototype,"albedoType",void 0),(0,Ge.Cg)([xh("Reflectivity format",7,"GEOMETRY BUFFERS")],uu.prototype,"reflectivityFormat",void 0),(0,Ge.Cg)([xh("Reflectivity type",8,"GEOMETRY BUFFERS")],uu.prototype,"reflectivityType",void 0),(0,Ge.Cg)([xh("Velocity format",7,"GEOMETRY BUFFERS")],uu.prototype,"velocityFormat",void 0),(0,Ge.Cg)([xh("Velocity type",8,"GEOMETRY BUFFERS")],uu.prototype,"velocityType",void 0),(0,Ge.Cg)([xh("Linear velocity format",7,"GEOMETRY BUFFERS")],uu.prototype,"linearVelocityFormat",void 0),(0,Ge.Cg)([xh("Linear velocity type",8,"GEOMETRY BUFFERS")],uu.prototype,"linearVelocityType",void 0),(0,a.Y5)("BABYLON.NodeRenderGraphGeometryRendererBlock",uu);class du extends su{constructor(e,t,i){super(e,t,i),this._frameGraphTask=new Wh(this.name,t,i)}getClassName(){return"NodeRenderGraphShadowGeneratorBlock"}}(0,a.Y5)("BABYLON.NodeRenderGraphShadowGeneratorBlock",du);class pu{constructor(e,t=2,i=3,r=1,s=1){this._curIndex=0,this._sequence=[],this._numSamples=0,this.x=0,this.y=0,this._width=r,this._height=s,this._baseX=t,this._baseY=i,this._generateSequence(e),this.next()}regenerate(e){this._generateSequence(e),this.next()}setDimensions(e,t){this._width=e,this._height=t}next(){this.x=this._sequence[this._curIndex]/this._width,this.y=this._sequence[this._curIndex+1]/this._height,this._curIndex+=2,this._curIndex>=2*this._numSamples&&(this._curIndex=0)}_generateSequence(e){this._sequence=[],this._curIndex=0,this._numSamples=e;for(let t=1;t<=e;++t)this._sequence.push(this._halton(t,this._baseX)-.5,this._halton(t,this._baseY)-.5)}_halton(e,t){let i=1,r=0;for(;e>0;)i/=t,r+=i*(e%t),e=~~(e/t);return r}}class mu extends Bi.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,37706)))):t.push(Promise.resolve().then(i.bind(i,71405)))}set samples(e){this._samples!==e&&(this._samples=e,this._hs.regenerate(e))}get samples(){return this._samples}get disabled(){return this._disabled}set disabled(e){this._disabled!==e&&(this._disabled=e,this._reset())}get textureWidth(){return this._textureWidth}set textureWidth(e){this._textureWidth!==e&&(this._textureWidth=e,this._reset())}get textureHeight(){return this._textureHeight}set textureHeight(e){this._textureHeight!==e&&(this._textureHeight=e,this._reset())}constructor(e,t=null,i){super({...i,name:e,engine:t||Vi.Engine.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:mu.FragmentUrl,uniforms:mu.Uniforms,samplers:mu.Samplers}),this._samples=8,this.factor=.05,this._disabled=!1,this._textureWidth=0,this._textureHeight=0,this.disableOnCameraMove=!0,this._firstUpdate=!0,this._hs=new pu(this.samples)}_reset(){this._hs.setDimensions(this._textureWidth/2,this._textureHeight/2),this._hs.next(),this._firstUpdate=!0}updateProjectionMatrix(){if(!this.disabled){if(this.camera&&!this.camera.hasMoved)if(this.camera.mode===ft.i.PERSPECTIVE_CAMERA){const e=this.camera.getProjectionMatrix();e.setRowFromFloats(2,this._hs.x,this._hs.y,e.m[10],e.m[11])}else{const e=this.camera.getProjectionMatrix(!0);e.setRowFromFloats(3,this._hs.x+e.m[12],this._hs.y+e.m[13],e.m[14],e.m[15])}this._hs.next()}}bind(){if(super.bind(),this.disabled)return;this._drawWrapper.effect.setFloat("factor",this.camera?.hasMoved&&this.disableOnCameraMove||this._firstUpdate?1:this.factor),this._firstUpdate=!1}}mu.FragmentUrl="taa",mu.Uniforms=["factor"],mu.Samplers=["historySampler"];class fu extends qh{constructor(e,t,i,r){super(e,t,i,r),this.postProcess=new mu(`${e} post-process`,i.getEngine()),this._postProcessDrawWrapper=this.postProcess.drawWrapper}record(){if(void 0===this.targetTexture||void 0===this.objectList)throw new Error(`FrameGraphTAAObjectRendererTask ${this.name}: destinationTexture and objectList are required`);if(this.targetTexture===Ql||this.depthTexture===Kl)throw new Error(`FrameGraphTAAObjectRendererTask ${this.name}: the back buffer color/depth textures are not allowed. Use regular textures instead.`);this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems;const e=this._frameGraph.textureManager.getTextureDescription(this.targetTexture);let t=!1;if(void 0!==this.depthTexture){if(this._frameGraph.textureManager.getTextureDescription(this.depthTexture).options.samples!==e.options.samples)throw new Error(`FrameGraphTAAObjectRendererTask ${this.name}: the depth texture and the output texture must have the same number of samples`);t=!0}this.postProcess.camera=this.camera,this.postProcess.textureWidth=e.size.width,this.postProcess.textureHeight=e.size.height;const i={size:e.size,options:{createMipMaps:e.options.createMipMaps,types:[2],formats:[5],samples:1,useSRGBBuffers:[!1],creationFlags:[0],labels:[""]},sizeIsPercentage:!1,isHistoryTexture:!0},r=this._frameGraph.textureManager.createRenderTargetTexture(`${this.name} history`,i);let s;this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,r),void 0!==this.depthTexture&&this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthTexture,this.depthTexture),this._textureWidth=e.size.width,this._textureHeight=e.size.height,this._setLightsForShadow();const n=this._frameGraph.addRenderPass(this.name);n.setRenderTarget(this.targetTexture),n.setRenderTargetDepth(this.depthTexture),n.setExecuteFunc((e=>{this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems,this.postProcess.updateProjectionMatrix(),e.setDepthStates(this.depthTest&&t,this.depthWrite&&t),this.postProcess.disabled||(this._scene.activeCamera=this.camera,this._scene.setTransformMatrix(this.camera.getViewMatrix(),this.camera.getProjectionMatrix())),e.render(this._renderer,this._textureWidth,this._textureHeight),this._scene.activeCamera=null,s=s||e.createRenderTarget(`${this.name} ping/pong`,r),e.bindRenderTarget(s,"frame graph - TAA merge with history texture"),this.postProcess.disabled?e.copyTexture(this.targetTexture):e.applyFullScreenEffect(this._postProcessDrawWrapper,(()=>{this.postProcess.bind(),e.bindTextureHandle(this._postProcessDrawWrapper.effect,"textureSampler",this.targetTexture),e.bindTextureHandle(this._postProcessDrawWrapper.effect,"historySampler",r)}))}));const o=this._frameGraph.addRenderPass(this.name+"_disabled",!0);return o.setRenderTarget(this.outputTexture),o.setRenderTargetDepth(this.depthTexture),o.setExecuteFunc((e=>{e.copyTexture(this.targetTexture)})),n}}class _u extends Xh{get task(){return this._frameGraphTask}constructor(e,t,i,r=!0){super(e,t,i),this._additionalConstructionParameters=[r],this._frameGraphTask=new fu(this.name,t,i,{doNotChangeAspectRatio:r})}get doNotChangeAspectRatio(){return this._frameGraphTask.objectRenderer.options.doNotChangeAspectRatio}set doNotChangeAspectRatio(e){this._frameGraphTask.dispose(),this._frameGraphTask=new fu(this.name,this._frameGraph,this._scene,{doNotChangeAspectRatio:e}),this._additionalConstructionParameters=[e]}get samples(){return this._frameGraphTask.postProcess.samples}set samples(e){this._frameGraphTask.postProcess.samples=e}get factor(){return this._frameGraphTask.postProcess.factor}set factor(e){this._frameGraphTask.postProcess.factor=e}get disableOnCameraMove(){return this._frameGraphTask.postProcess.disableOnCameraMove}set disableOnCameraMove(e){this._frameGraphTask.postProcess.disableOnCameraMove=e}get disableTAA(){return this._frameGraphTask.postProcess.disabled}set disableTAA(e){this._frameGraphTask.postProcess.disabled=e}getClassName(){return"NodeRenderGraphTAAObjectRendererBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.doNotChangeAspectRatio = ${this.doNotChangeAspectRatio};`),e.push(`${this._codeVariableName}.samples = ${this.samples};`),e.push(`${this._codeVariableName}.factor = ${this.factor};`),e.push(`${this._codeVariableName}.disableOnCameraMove = ${this.disableOnCameraMove};`),e.push(`${this._codeVariableName}.disableTAA = ${this.disableTAA};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.doNotChangeAspectRatio=this.doNotChangeAspectRatio,e.samples=this.samples,e.factor=this.factor,e.disableOnCameraMove=this.disableOnCameraMove,e.disableTAA=this.disableTAA,e}_deserialize(e){super._deserialize(e),this.doNotChangeAspectRatio=e.doNotChangeAspectRatio,this.samples=e.samples,this.factor=e.factor,this.disableOnCameraMove=e.disableOnCameraMove,this.disableTAA=e.disableTAA}}(0,Ge.Cg)([xh("Do not change aspect ratio",0,"PROPERTIES")],_u.prototype,"doNotChangeAspectRatio",null),(0,Ge.Cg)([xh("Samples",2,"TEMPORAL ANTI-ALIASING")],_u.prototype,"samples",null),(0,Ge.Cg)([xh("Factor",1,"TEMPORAL ANTI-ALIASING")],_u.prototype,"factor",null),(0,Ge.Cg)([xh("Disable on camera move",0,"TEMPORAL ANTI-ALIASING")],_u.prototype,"disableOnCameraMove",null),(0,Ge.Cg)([xh("Disable TAA",0,"TEMPORAL ANTI-ALIASING")],_u.prototype,"disableTAA",null),(0,a.Y5)("BABYLON.NodeRenderGraphTAAObjectRendererBlock",_u);class gu extends ih{constructor(e,t,i,r=!0){super(e,t),this.layer=new Rs(i,r,!0),this.layer.utilityLayerScene._useCurrentFrameBuffer=!0,this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}record(){if(!this.targetTexture||!this.camera)throw new Error("FrameGraphUtilityLayerRendererTask: targetTexture and camera are required");this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture);const e=this._frameGraph.addRenderPass(this.name);e.setRenderTarget(this.outputTexture),e.setExecuteFunc((e=>{this.layer.setRenderCamera(this.camera),e.render(this.layer)}));const t=this._frameGraph.addRenderPass(this.name+"_disabled",!0);t.setRenderTarget(this.outputTexture),t.setExecuteFunc((e=>{}))}dispose(){this.layer.dispose(),super.dispose()}}class xu extends Zl{get task(){return this._frameGraphTask}constructor(e,t,i,r=!0){super(e,t,i),this._additionalConstructionParameters=[r],this.registerInput("target",Wl.Texture),this.registerInput("camera",Wl.Camera),this._addDependenciesInput(),this.registerOutput("output",Wl.BasedOnInput),this.target.addAcceptedConnectionPointTypes(Wl.TextureAll),this.output._typeConnectionSource=this.target,this._frameGraphTask=new gu(e,t,i,r)}_createTask(e){this._frameGraphTask.dispose(),this._frameGraphTask=new gu(this.name,this._frameGraph,this._scene,e),this._additionalConstructionParameters=[e]}get handleEvents(){return this._frameGraphTask.layer.handleEvents}set handleEvents(e){this._createTask(e)}getClassName(){return"NodeRenderGraphUtilityLayerRendererBlock"}get target(){return this._inputs[0]}get camera(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.output.value=this._frameGraphTask.outputTexture,this._frameGraphTask.targetTexture=this.target.connectedPoint?.value,this._frameGraphTask.camera=this.camera.connectedPoint?.value}}(0,Ge.Cg)([xh("Handle events",0,"PROPERTIES")],xu.prototype,"handleEvents",null),(0,a.Y5)("BABYLON.NodeRenderGraphUtilityLayerRendererBlock",xu);class vu extends Zl{get endpoints(){return this._endpoints}constructor(e,t,i){super(e,t,i),this._endpoints=[],this._isTeleportIn=!0,this.registerInput("input",Wl.AutoDetect)}getClassName(){return"NodeRenderGraphTeleportInBlock"}get input(){return this._inputs[0]}_dumpCode(e,t){let i=super._dumpCode(e,t);for(const r of this.endpoints)-1===t.indexOf(r)&&(i+=r._dumpCode(e,t));return i}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(const t of this.endpoints)if(t.isAnAncestorOfType(e))return!0;return!1}isAnAncestorOf(e){for(const t of this.endpoints){if(t===e)return!0;if(t.isAnAncestorOf(e))return!0}return!1}getDescendantOfPredicate(e){if(e(this))return this;for(const t of this.endpoints){const i=t.getDescendantOfPredicate(e);if(i)return i}return null}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name}detachFromEndpoint(e){const t=this._endpoints.indexOf(e);-1!==t&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null)}dispose(){super.dispose();for(const e of this._endpoints)this.detachFromEndpoint(e);this._endpoints=[]}}(0,a.Y5)("BABYLON.NodeRenderGraphTeleportInBlock",vu);class Su extends Zl{constructor(e,t,i){super(e,t,i),this._entryPoint=null,this._tempEntryPointUniqueId=null,this._isTeleportOut=!0,this.registerOutput("output",Wl.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"NodeRenderGraphTeleportOutBlock"}get output(){return this._outputs[0]}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(){}_customBuildStep(e){this.entryPoint&&this.entryPoint.build(e)}_dumpCode(e,t){let i="";return this.entryPoint&&-1===t.indexOf(this.entryPoint)&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}clone(){const e=super.clone();return this.entryPoint&&this.entryPoint.attachToEndpoint(e),e}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});\n`),e}serialize(){const e=super.serialize();return e.entryPoint=this.entryPoint?.uniqueId??"",e}_deserialize(e){super._deserialize(e),this._tempEntryPointUniqueId=e.entryPoint}}(0,a.Y5)("BABYLON.NodeRenderGraphTeleportOutBlock",Su);class bu extends ih{constructor(e,t){super(e,t),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}record(){if(void 0===this.sourceTexture||void 0===this.targetTexture)throw new Error(`FrameGraphCopyToTextureTask "${this.name}": sourceTexture and targetTexture are required`);this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture);const e=this._frameGraph.addRenderPass(this.name);e.addDependencies(this.sourceTexture),e.setRenderTarget(this.outputTexture),e.setExecuteFunc((e=>{e.copyTexture(this.sourceTexture)}));const t=this._frameGraph.addRenderPass(this.name+"_disabled",!0);t.setRenderTarget(this.outputTexture),t.setExecuteFunc((e=>{}))}}class yu extends Zl{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("source",Wl.Texture),this.registerInput("target",Wl.Texture),this._addDependenciesInput(),this.registerOutput("output",Wl.BasedOnInput),this.source.addAcceptedConnectionPointTypes(Wl.TextureAllButBackBuffer),this.target.addAcceptedConnectionPointTypes(Wl.TextureAll),this.output._typeConnectionSource=this.target,this._frameGraphTask=new bu(e,t)}getClassName(){return"NodeRenderGraphCopyTextureBlock"}get source(){return this._inputs[0]}get target(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.output.value=this._frameGraphTask.outputTexture,this._frameGraphTask.sourceTexture=this.source.connectedPoint?.value,this._frameGraphTask.targetTexture=this.target.connectedPoint?.value}}(0,a.Y5)("BABYLON.NodeRenderGraphCopyTextureBlock",yu);class Pu extends ih{constructor(e,t){super(e,t),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}record(){if(void 0===this.targetTexture)throw new Error(`FrameGraphGenerateMipMapsTask ${this.name}: targetTexture is required`);this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture);if(!this._frameGraph.textureManager.getTextureDescription(this.targetTexture).options.createMipMaps)throw new Error(`FrameGraphGenerateMipMapsTask ${this.name}: targetTexture must have createMipMaps set to true`);const e=this._frameGraph.addRenderPass(this.name);e.setRenderTarget(this.outputTexture),e.setExecuteFunc((e=>{e.generateMipMaps()}));const t=this._frameGraph.addRenderPass(this.name+"_disabled",!0);t.setRenderTarget(this.outputTexture),t.setExecuteFunc((e=>{}))}}class Tu extends Zl{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("target",Wl.Texture),this._addDependenciesInput(),this.registerOutput("output",Wl.BasedOnInput),this.target.addAcceptedConnectionPointTypes(Wl.TextureAllButBackBuffer),this.output._typeConnectionSource=this.target,this._frameGraphTask=new Pu(e,t)}getClassName(){return"NodeRenderGraphGenerateMipmapsBlock"}get target(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this._propagateInputValueToOutput(this.target,this.output),this._frameGraphTask.targetTexture=this.target.connectedPoint?.value}}(0,a.Y5)("BABYLON.NodeRenderGraphGenerateMipmapsBlock",Tu);class Cu{}class Eu extends ws{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}constructor(e,t=o.v9.Gray(),i=Rs.DefaultUtilityLayer,r=null,a=1,l=o.v9.Yellow(),h=o.v9.Gray()){super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new s.cP,this.uniformScaling=!1,this.sensitivity=1,this.dragScale=1,this.incrementalSnap=!1,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._tmpVector=new n.Pq(0,0,0),this._incrementalStartupValue=n.Pq.Zero(),this._parent=r,this._coloredMaterial=new br.F("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new o.v9(.1,.1,.1)),this._hoverMaterial=new br.F("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=l,this._disableMaterial=new br.F("",i.utilityLayerScene),this._disableMaterial.diffuseColor=h,this._disableMaterial.alpha=.4,this._gizmoMesh=new tt.e("axis",i.utilityLayerScene);const{arrowMesh:c,arrowTail:u}=this._createGizmoMesh(this._gizmoMesh,a),d=this._createGizmoMesh(this._gizmoMesh,a+4,!0);this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._rootMesh.addChild(this._gizmoMesh,ws.PreserveScaling),this._gizmoMesh.scaling.scaleInPlace(1/3);const p=c.position.clone(),m=u.position.clone(),f=u.scaling.clone(),_=e=>{const t=e*(3/this._rootMesh.scaling.length())*6;c.position.z+=t/3.5,u.scaling.y+=t,this.dragScale=u.scaling.y,u.position.z=c.position.z/2},g=()=>{c.position.set(p.x,p.y,p.z),u.position.set(m.x,m.y,m.z),u.scaling.set(f.x,f.y,f.z),this.dragScale=u.scaling.y,this._dragging=!1};this.dragBehavior=new dt({dragAxis:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.updateDragPlane=!1,this._rootMesh.addBehavior(this.dragBehavior);let x=0,v=0;const S={snapDistance:0};this.dragBehavior.onDragObservable.add((t=>{if(this.attachedNode){const i=this.sensitivity*t.dragDistance*(3*this.scaleRatio/this._rootMesh.scaling.length()),r=this._tmpVector;let s=!1,o=0;if(this.uniformScaling?r.setAll(.57735):r.copyFrom(e),0==this.snapDistance)r.scaleToRef(i,r);else{x+=i,v+=i;const e=this.incrementalSnap?v:x;Math.abs(e)>this.snapDistance?(o=Math.floor(Math.abs(e)/this.snapDistance),e<0&&(o*=-1),x%=this.snapDistance,r.scaleToRef(this.snapDistance*o,r),s=!0):r.scaleInPlace(0)}r.addInPlaceFromFloats(1,1,1),r.x=Math.abs(r.x)<Eu.MinimumAbsoluteScale?Eu.MinimumAbsoluteScale*(r.x<0?-1:1):r.x,r.y=Math.abs(r.y)<Eu.MinimumAbsoluteScale?Eu.MinimumAbsoluteScale*(r.y<0?-1:1):r.y,r.z=Math.abs(r.z)<Eu.MinimumAbsoluteScale?Eu.MinimumAbsoluteScale*(r.z<0?-1:1):r.z;const a=this.attachedNode._isMesh?this.attachedNode:void 0;Math.abs(this.snapDistance)>0&&this.incrementalSnap?(this.attachedNode.getWorldMatrix().decompose(void 0,n.AA.Quaternion[0],n.AA.Vector3[2],ws.PreserveScaling?a:void 0),r.addInPlace(this._incrementalStartupValue),r.addInPlaceFromFloats(-1,-1,-1),r.x=Math.abs(r.x)*(this._incrementalStartupValue.x>0?1:-1),r.y=Math.abs(r.y)*(this._incrementalStartupValue.y>0?1:-1),r.z=Math.abs(r.z)*(this._incrementalStartupValue.z>0?1:-1),n.uq.ComposeToRef(r,n.AA.Quaternion[0],n.AA.Vector3[2],n.AA.Matrix[1])):(n.uq.ScalingToRef(r.x,r.y,r.z,n.AA.Matrix[2]),n.AA.Matrix[2].multiplyToRef(this.attachedNode.getWorldMatrix(),n.AA.Matrix[1])),n.AA.Matrix[1].decompose(n.AA.Vector3[1],void 0,void 0,ws.PreserveScaling?a:void 0);const l=1e5;Math.abs(n.AA.Vector3[1].x)<l&&Math.abs(n.AA.Vector3[1].y)<l&&Math.abs(n.AA.Vector3[1].z)<l&&this.attachedNode.getWorldMatrix().copyFrom(n.AA.Matrix[1]),s&&(S.snapDistance=this.snapDistance*o,this.onSnapObservable.notifyObservers(S)),this._matrixChanged()}})),this.dragBehavior.onDragStartObservable.add((()=>{this._dragging=!0;const e=this.attachedNode._isMesh?this.attachedNode:void 0;this.attachedNode?.getWorldMatrix().decompose(this._incrementalStartupValue,void 0,void 0,ws.PreserveScaling?e:void 0),x=0,v=0})),this.dragBehavior.onDragObservable.add((e=>_(e.dragDistance))),this.dragBehavior.onDragEndObservable.add(g),r?.uniformScaleGizmo?.dragBehavior?.onDragObservable?.add((e=>_(e.delta.y))),r?.uniformScaleGizmo?.dragBehavior?.onDragEndObservable?.add(g);const b={gizmoMeshes:[c,u],colliderMeshes:[d.arrowMesh,d.arrowTail],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};this._parent?.addToAxisCache(this._gizmoMesh,b),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((e=>{if(this._customMeshSet)return;let t=this._parent?.getAxisCache(this._gizmoMesh);if(this._isHovered=!(!t||-1==t.colliderMeshes.indexOf(e?.pickInfo?.pickedMesh)),t=this._parent?.getAxisCache(this._rootMesh),this._isHovered||(this._isHovered=!(!t||-1==t.colliderMeshes.indexOf(e?.pickInfo?.pickedMesh))),!this._parent){const e=this.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(b.gizmoMeshes,e)}})),this.dragBehavior.onEnabledObservable.add((e=>{this._setGizmoMeshMaterial(b.gizmoMeshes,e?this._coloredMaterial:this._disableMaterial)}));const y=i._getSharedGizmoLight();y.includedOnlyMeshes=y.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes())}_createGizmoMesh(e,t,i=!1){const r=(0,ks.an)("yPosMesh",{size:.4*(1+(t-1)/4)},this.gizmoLayer.utilityLayerScene),s=Es("cylinder",{diameterTop:.005*t,height:.275,diameterBottom:.005*t,tessellation:96},this.gizmoLayer.utilityLayerScene);return r.scaling.scaleInPlace(.1),r.material=this._coloredMaterial,r.rotation.x=Math.PI/2,r.position.z+=.3,s.material=this._coloredMaterial,s.position.z+=.1375,s.rotation.x=Math.PI/2,i&&(r.visibility=0,s.visibility=0),e.addChild(r),e.addChild(s),{arrowMesh:r,arrowTail:s}}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()})),super.dispose()}setCustomMesh(e,t=!1){super.setCustomMesh(e),t&&(this._rootMesh.getChildMeshes().forEach((e=>{e.material=this._coloredMaterial,e.color&&(e.color=this._coloredMaterial.diffuseColor)})),this._customMeshSet=!1)}}var Au;Eu.MinimumAbsoluteScale=ut.bH,function(e){e[e.Rotation=0]="Rotation",e[e.Scaling=1]="Scaling"}(Au||(Au={}));class Iu extends ws{set axisFactor(e){this._axisFactor=e;const t=this._scaleBoxesParent.getChildMeshes();let i=0;for(let e=0;e<3;e++)for(let r=0;r<3;r++)for(let s=0;s<3;s++){const o=(1===e?1:0)+(1===r?1:0)+(1===s?1:0);if(1!==o&&3!==o){if(t[i]){const o=new n.Pq(e-1,r-1,s-1);o.multiplyInPlace(this._axisFactor),t[i].setEnabled(o.lengthSquared()>ut.bH)}i++}}}get axisFactor(){return this._axisFactor}set scaleDragSpeed(e){this._scaleDragSpeed=e}get scaleDragSpeed(){return this._scaleDragSpeed}get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverColoredMaterial}get pointerDragBehavior(){return this._pointerDragBehavior}get isDragging(){return this._dragging||this._pointerDragBehavior.dragging}setColor(e){this._coloredMaterial.emissiveColor=e,this._hoverColoredMaterial.emissiveColor=e.clone().add(new o.v9(.3,.3,.3)),this._lineBoundingBox.getChildren().forEach((t=>{t.color&&(t.color=e)}))}constructor(e=o.v9.Gray(),t=Rs.DefaultKeepDepthUtilityLayer){super(t),this._boundingDimensions=new n.Pq(1,1,1),this._renderObserver=null,this._pointerObserver=null,this._scaleDragSpeed=.2,this._rotateAnchorsDragBehaviors=[],this._scaleBoxesDragBehaviors=[],this._dragging=!1,this._tmpQuaternion=new n.PT,this._tmpVector=new n.Pq(0,0,0),this._tmpRotationMatrix=new n.uq,this._incrementalStartupValue=n.Pq.Zero(),this._incrementalAnchorStartupValue=n.Pq.Zero(),this.ignoreChildren=!1,this.includeChildPredicate=null,this.rotationSphereSize=.1,this.scaleBoxSize=.1,this.fixedDragMeshScreenSize=!1,this.fixedDragMeshBoundsSize=!1,this.fixedDragMeshScreenSizeDistanceFactor=10,this.scalingSnapDistance=0,this.rotationSnapDistance=0,this.onDragStartObservable=new s.cP,this.onHoverStartObservable=new s.cP,this.onHoverEndObservable=new s.cP,this.onScaleBoxDragObservable=new s.cP,this.onScaleBoxDragEndObservable=new s.cP,this.onRotationSphereDragObservable=new s.cP,this.onRotationSphereDragEndObservable=new s.cP,this.scalePivot=null,this._axisFactor=new n.Pq(1,1,1),this.incrementalSnap=!1,this._existingMeshScale=new n.Pq,this._dragMesh=null,this._pointerDragBehavior=new dt,this._cornerMesh=null,this.updateScale=!1,this._anchorMesh=new mt.V("anchor",t.utilityLayerScene),this._coloredMaterial=new br.F("",t.utilityLayerScene),this._coloredMaterial.disableLighting=!0,this._hoverColoredMaterial=new br.F("",t.utilityLayerScene),this._hoverColoredMaterial.disableLighting=!0,this._lineBoundingBox=new mt.V("",t.utilityLayerScene),this._lineBoundingBox.rotationQuaternion=new n.PT;const i=[];i.push(bn("lines",{points:[new n.Pq(0,0,0),new n.Pq(this._boundingDimensions.x,0,0)]},t.utilityLayerScene)),i.push(bn("lines",{points:[new n.Pq(0,0,0),new n.Pq(0,this._boundingDimensions.y,0)]},t.utilityLayerScene)),i.push(bn("lines",{points:[new n.Pq(0,0,0),new n.Pq(0,0,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push(bn("lines",{points:[new n.Pq(this._boundingDimensions.x,0,0),new n.Pq(this._boundingDimensions.x,this._boundingDimensions.y,0)]},t.utilityLayerScene)),i.push(bn("lines",{points:[new n.Pq(this._boundingDimensions.x,0,0),new n.Pq(this._boundingDimensions.x,0,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push(bn("lines",{points:[new n.Pq(0,this._boundingDimensions.y,0),new n.Pq(this._boundingDimensions.x,this._boundingDimensions.y,0)]},t.utilityLayerScene)),i.push(bn("lines",{points:[new n.Pq(0,this._boundingDimensions.y,0),new n.Pq(0,this._boundingDimensions.y,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push(bn("lines",{points:[new n.Pq(0,0,this._boundingDimensions.z),new n.Pq(this._boundingDimensions.x,0,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push(bn("lines",{points:[new n.Pq(0,0,this._boundingDimensions.z),new n.Pq(0,this._boundingDimensions.y,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push(bn("lines",{points:[new n.Pq(this._boundingDimensions.x,this._boundingDimensions.y,this._boundingDimensions.z),new n.Pq(0,this._boundingDimensions.y,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push(bn("lines",{points:[new n.Pq(this._boundingDimensions.x,this._boundingDimensions.y,this._boundingDimensions.z),new n.Pq(this._boundingDimensions.x,0,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push(bn("lines",{points:[new n.Pq(this._boundingDimensions.x,this._boundingDimensions.y,this._boundingDimensions.z),new n.Pq(this._boundingDimensions.x,this._boundingDimensions.y,0)]},t.utilityLayerScene)),i.forEach((t=>{t.color=e,t.position.addInPlace(new n.Pq(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),t.isPickable=!1,this._lineBoundingBox.addChild(t)})),this._rootMesh.addChild(this._lineBoundingBox),this.setColor(e),this._rotateAnchorsParent=new mt.V("",t.utilityLayerScene),this._rotateAnchorsParent.rotationQuaternion=new n.PT;for(let e=0;e<12;e++){const i=(0,ks.an)("",{width:e<4||e>=8?1.6:.4,height:e>=4&&e<8?1.6:.4,depth:.4},t.utilityLayerScene);i.rotation.x=e<4||e>=8?.25*Math.PI:0,i.rotation.y=e>=4&&e<8?.25*Math.PI:0,i.bakeTransformIntoVertices(i.computeWorldMatrix(!0)),i.rotationQuaternion=new n.PT,i.material=this._coloredMaterial,i.isNearGrabbable=!0;const r=new dt({});r.moveAttached=!1,r.updateDragPlane=!1,i.addBehavior(r);const s=new n.Pq(1,0,0);let o=0,a=0;r.onDragStartObservable.add((()=>{s.copyFrom(i.forward),o=0,a=0}));const l=function(){const t=Math.floor(e/4);return n.AA.Vector3[0].set(0==t?1:0,1==t?1:0,2==t?1:0),n.AA.Vector3[0]};r.onDragObservable.add((t=>{if(this.onRotationSphereDragObservable.notifyObservers({dragOperation:0,dragAxis:l().clone()}),this.attachedMesh){const i=this.attachedMesh.parent;if(i&&i.scaling&&i.scaling.isNonUniformWithinEpsilon(.001))return void m.V.Warn("BoundingBoxGizmo controls are not supported on child meshes with non-uniform parent scaling");nt._RemoveAndStorePivotPoint(this.attachedMesh);const r=s,l=t.dragPlaneNormal.scale(n.Pq.Dot(t.dragPlaneNormal,r)),h=r.subtract(l).normalizeToNew();let c=n.Pq.Dot(h,t.delta)<0?Math.abs(t.delta.length()):-Math.abs(t.delta.length());if(c=c/this._boundingDimensions.length()*this._anchorMesh.scaling.length(),this.attachedMesh.rotationQuaternion||(this.attachedMesh.rotationQuaternion=n.PT.RotationYawPitchRoll(this.attachedMesh.rotation.y,this.attachedMesh.rotation.x,this.attachedMesh.rotation.z)),this._anchorMesh.rotationQuaternion||(this._anchorMesh.rotationQuaternion=n.PT.RotationYawPitchRoll(this._anchorMesh.rotation.y,this._anchorMesh.rotation.x,this._anchorMesh.rotation.z)),o+=c,Math.abs(o)<=2*Math.PI){if(this.rotationSnapDistance>0){const e=Math.floor(Math.abs(o)/this.rotationSnapDistance)*(o<0?-1:1),t=this.rotationSnapDistance*e;c=t-a,a=t}e>=8?n.PT.RotationYawPitchRollToRef(0,0,c,this._tmpQuaternion):e>=4?n.PT.RotationYawPitchRollToRef(c,0,0,this._tmpQuaternion):n.PT.RotationYawPitchRollToRef(0,c,0,this._tmpQuaternion),this.attachedMesh.isUsingPivotMatrix()&&this._anchorMesh.position.copyFrom(this.attachedMesh.position),this._anchorMesh.addChild(this.attachedMesh),this._anchorMesh.getScene().useRightHandedSystem&&this._tmpQuaternion.conjugateInPlace(),this._tmpQuaternion.normalize(),this._anchorMesh.rotationQuaternion.multiplyToRef(this._tmpQuaternion,this._anchorMesh.rotationQuaternion),this._anchorMesh.rotationQuaternion.normalize(),this._anchorMesh.removeChild(this.attachedMesh),this.attachedMesh.setParent(i)}this.updateBoundingBox(),nt._RestorePivotPoint(this.attachedMesh)}this._updateDummy()})),r.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({dragOperation:0,dragAxis:l().clone()}),this._dragging=!0,this._selectNode(i)})),r.onDragEndObservable.add((e=>{this.onRotationSphereDragEndObservable.notifyObservers({dragOperation:0,dragAxis:l().clone()}),this._dragging=!1,this._selectNode(null),this._updateDummy(),this._unhoverMeshOnTouchUp(e.pointerInfo,i)})),this._rotateAnchorsDragBehaviors.push(r),this._rotateAnchorsParent.addChild(i)}this._rootMesh.addChild(this._rotateAnchorsParent),this._scaleBoxesParent=new mt.V("",t.utilityLayerScene),this._scaleBoxesParent.rotationQuaternion=new n.PT;for(let e=0;e<3;e++)for(let i=0;i<3;i++)for(let r=0;r<3;r++){const s=(1===e?1:0)+(1===i?1:0)+(1===r?1:0);if(1===s||3===s)continue;const o=2===s?(0,ks.an)("",{size:1},t.utilityLayerScene):this._getCornerMesh(t);0===s&&(o.rotationQuaternion=n.PT.FromEulerAngles(.25*i*Math.PI,.25*(r+3*e-e*r)*Math.PI,0)),o.material=this._coloredMaterial,o._internalMetadata=2===s,o.isNearGrabbable=!0,n.AA.Vector3[0].set(e-1,i-1,r-1),n.AA.Vector3[0].normalize(),o.computeWorldMatrix(!0).invertToRef(n.AA.Matrix[0]);const a=n.Pq.TransformCoordinates(n.AA.Vector3[0],n.AA.Matrix[0]);a.normalize();const l=new dt({dragAxis:a});l.updateDragPlane=!1,l.moveAttached=!1;let h=0,c=0;o.addBehavior(l),l.onDragObservable.add((t=>{if(this.onScaleBoxDragObservable.notifyObservers({dragOperation:1,dragAxis:new n.Pq(e-1,i-1,r-1)}),this.attachedMesh){const e=this.attachedMesh.parent;if(e&&e.scaling&&e.scaling.isNonUniformWithinEpsilon(.001))return void m.V.Warn("BoundingBoxGizmo controls are not supported on child meshes with non-uniform parent scaling");nt._RemoveAndStorePivotPoint(this.attachedMesh);let i=t.dragDistance/this._boundingDimensions.length()*this._anchorMesh.scaling.length();if(h+=i,this.scalingSnapDistance>0){const e=Math.floor(Math.abs(h)/this.scalingSnapDistance)*(h<0?-1:1),t=this.scalingSnapDistance*e;i=t-c,c=t}const r=new n.Pq(i,i,i),l=new n.Pq(c,c,c);2===s&&(r.x*=Math.abs(a.x),r.y*=Math.abs(a.y),r.z*=Math.abs(a.z)),r.scaleInPlace(this._scaleDragSpeed),r.multiplyInPlace(this._axisFactor),l.scaleInPlace(this._scaleDragSpeed),l.multiplyInPlace(this._axisFactor),l.addInPlace(this._incrementalStartupValue),this.updateBoundingBox(),this.scalePivot?(this.attachedMesh.getWorldMatrix().getRotationMatrixToRef(this._tmpRotationMatrix),this._boundingDimensions.scaleToRef(.5,this._tmpVector),n.Pq.TransformCoordinatesToRef(this._tmpVector,this._tmpRotationMatrix,this._tmpVector),this._anchorMesh.position.subtractInPlace(this._tmpVector),this._boundingDimensions.multiplyToRef(this.scalePivot,this._tmpVector),n.Pq.TransformCoordinatesToRef(this._tmpVector,this._tmpRotationMatrix,this._tmpVector),this._anchorMesh.position.addInPlace(this._tmpVector)):(o.absolutePosition.subtractToRef(this._anchorMesh.position,this._tmpVector),this._anchorMesh.position.subtractInPlace(this._tmpVector),this.attachedMesh.isUsingPivotMatrix()&&this._anchorMesh.position.subtractInPlace(this.attachedMesh.getPivotPoint())),this._anchorMesh.addChild(this.attachedMesh),this.incrementalSnap?(l.x/=Math.abs(this._incrementalStartupValue.x)<ut.bH?1:this._incrementalStartupValue.x,l.y/=Math.abs(this._incrementalStartupValue.y)<ut.bH?1:this._incrementalStartupValue.y,l.z/=Math.abs(this._incrementalStartupValue.z)<ut.bH?1:this._incrementalStartupValue.z,l.x=Math.max(this._incrementalAnchorStartupValue.x*l.x,this.scalingSnapDistance),l.y=Math.max(this._incrementalAnchorStartupValue.y*l.y,this.scalingSnapDistance),l.z=Math.max(this._incrementalAnchorStartupValue.z*l.z,this.scalingSnapDistance),this._anchorMesh.scaling.x+=(l.x-this._anchorMesh.scaling.x)*Math.abs(a.x),this._anchorMesh.scaling.y+=(l.y-this._anchorMesh.scaling.y)*Math.abs(a.y),this._anchorMesh.scaling.z+=(l.z-this._anchorMesh.scaling.z)*Math.abs(a.z)):(this._anchorMesh.scaling.addInPlace(r),(this._anchorMesh.scaling.x<0||this._anchorMesh.scaling.y<0||this._anchorMesh.scaling.z<0)&&this._anchorMesh.scaling.subtractInPlace(r)),this._anchorMesh.removeChild(this.attachedMesh),this.attachedMesh.setParent(e),nt._RestorePivotPoint(this.attachedMesh)}this._updateDummy()})),l.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({dragOperation:1,dragAxis:new n.Pq(e-1,i-1,r-1)}),this._dragging=!0,this._selectNode(o),h=0,c=0,this._incrementalStartupValue.copyFrom(this.attachedMesh.scaling),this._incrementalAnchorStartupValue.copyFrom(this._anchorMesh.scaling)})),l.onDragEndObservable.add((t=>{this.onScaleBoxDragEndObservable.notifyObservers({dragOperation:1,dragAxis:new n.Pq(e-1,i-1,r-1)}),this._dragging=!1,this._selectNode(null),this._updateDummy(),this._unhoverMeshOnTouchUp(t.pointerInfo,o)})),this._scaleBoxesParent.addChild(o),this._scaleBoxesDragBehaviors.push(l)}this._rootMesh.addChild(this._scaleBoxesParent);const r=[];this._pointerObserver=t.utilityLayerScene.onPointerObservable.add((e=>{r[e.event.pointerId]?e.pickInfo&&e.pickInfo.pickedMesh!=r[e.event.pointerId]&&(r[e.event.pointerId].material=this._coloredMaterial,delete r[e.event.pointerId],this.onHoverEndObservable.notifyObservers(),this._isHovered=!1):this._rotateAnchorsParent.getChildMeshes().concat(this._scaleBoxesParent.getChildMeshes()).forEach((t=>{e.pickInfo&&e.pickInfo.pickedMesh==t&&(r[e.event.pointerId]=t,t.material=this._hoverColoredMaterial,this.onHoverStartObservable.notifyObservers(),this._isHovered=!0)}))})),this._renderObserver=this.gizmoLayer.originalScene.onBeforeRenderObservable.add((()=>{this.attachedMesh&&!this._existingMeshScale.equals(this.attachedMesh.scaling)?this.updateBoundingBox():(this.fixedDragMeshScreenSize||this.fixedDragMeshBoundsSize)&&(this._updateRotationAnchors(),this._updateScaleBoxes()),this._dragMesh&&this.attachedMesh&&this._pointerDragBehavior.dragging&&(this._lineBoundingBox.position.rotateByQuaternionToRef(this._rootMesh.rotationQuaternion,this._tmpVector),this.attachedMesh.setAbsolutePosition(this._dragMesh.position.add(this._tmpVector.scale(-1))))})),this.updateBoundingBox()}_getCornerMesh(e){if(!this._cornerMesh){const t=(0,ks.an)("",{width:.4,height:.4,depth:1.6},e.utilityLayerScene);t.position.z=.6;const i=(0,ks.an)("",{width:.4,height:1.6,depth:.4},e.utilityLayerScene);i.position.y=.6;const r=(0,ks.an)("",{width:1.6,height:.4,depth:.4},e.utilityLayerScene);return r.position.x=.6,this._cornerMesh=tt.e.MergeMeshes([r,i,t],!0),this._cornerMesh}return this._cornerMesh.clone()}_attachedNodeChanged(e){if(e){this._anchorMesh.scaling.setAll(1),nt._RemoveAndStorePivotPoint(e);const t=e.parent;this._anchorMesh.addChild(e),this._anchorMesh.removeChild(e),e.setParent(t),nt._RestorePivotPoint(e),this.updateBoundingBox(),e.getChildMeshes(!1).forEach((e=>{e.markAsDirty("scaling")})),this.gizmoLayer.utilityLayerScene.onAfterRenderObservable.addOnce((()=>{this._updateDummy()}))}}_selectNode(e){this._rotateAnchorsParent.getChildMeshes().concat(this._scaleBoxesParent.getChildMeshes()).forEach((t=>{t.isVisible=!e||t==e}))}_unhoverMeshOnTouchUp(e,t){e?.event instanceof PointerEvent&&"touch"===e?.event.pointerType&&(t.material=this._coloredMaterial)}getScaleBoxes(){return this._scaleBoxesParent.getChildMeshes()}updateBoundingBox(){if(this.attachedMesh){nt._RemoveAndStorePivotPoint(this.attachedMesh);const e=this.attachedMesh.parent;this.attachedMesh.setParent(null),this._update(),this.attachedMesh.rotationQuaternion||(this.attachedMesh.rotationQuaternion=n.PT.RotationYawPitchRoll(this.attachedMesh.rotation.y,this.attachedMesh.rotation.x,this.attachedMesh.rotation.z)),this._anchorMesh.rotationQuaternion||(this._anchorMesh.rotationQuaternion=n.PT.RotationYawPitchRoll(this._anchorMesh.rotation.y,this._anchorMesh.rotation.x,this._anchorMesh.rotation.z)),this._anchorMesh.rotationQuaternion.copyFrom(this.attachedMesh.rotationQuaternion),this._tmpQuaternion.copyFrom(this.attachedMesh.rotationQuaternion),this._tmpVector.copyFrom(this.attachedMesh.position),this.attachedMesh.rotationQuaternion.set(0,0,0,1),this.attachedMesh.position.set(0,0,0);const t=this.attachedMesh.getHierarchyBoundingVectors(!this.ignoreChildren,this.includeChildPredicate);t.max.subtractToRef(t.min,this._boundingDimensions),this._lineBoundingBox.scaling.copyFrom(this._boundingDimensions),this._lineBoundingBox.position.set((t.max.x+t.min.x)/2,(t.max.y+t.min.y)/2,(t.max.z+t.min.z)/2),this._rotateAnchorsParent.position.copyFrom(this._lineBoundingBox.position),this._scaleBoxesParent.position.copyFrom(this._lineBoundingBox.position),this._lineBoundingBox.computeWorldMatrix(),this._anchorMesh.position.copyFrom(this._lineBoundingBox.absolutePosition),this.attachedMesh.rotationQuaternion.copyFrom(this._tmpQuaternion),this.attachedMesh.position.copyFrom(this._tmpVector),this.attachedMesh.setParent(e)}this._updateRotationAnchors(),this._updateScaleBoxes(),this.attachedMesh&&(this._existingMeshScale.copyFrom(this.attachedMesh.scaling),nt._RestorePivotPoint(this.attachedMesh))}_updateRotationAnchors(){const e=this._rotateAnchorsParent.getChildMeshes();for(let t=0;t<3;t++)for(let i=0;i<2;i++)for(let r=0;r<2;r++){const s=4*t+2*i+r;e[s].position.normalizeToRef(n.AA.Vector3[0]),0==t&&(e[s].position.set(0,this._boundingDimensions.y*(i-.5),this._boundingDimensions.z*(r-.5)),n.AA.Vector3[1].set(1,0,0)),1==t&&(e[s].position.set(this._boundingDimensions.x*(i-.5),0,this._boundingDimensions.z*(r-.5)),n.AA.Vector3[1].set(0,1,0)),2==t&&(e[s].position.set(this._boundingDimensions.x*(i-.5),this._boundingDimensions.y*(r-.5),0),n.AA.Vector3[1].set(0,0,1));const o=n.AA.Vector3[2];if(n.Pq.CrossToRef(n.AA.Vector3[0],n.AA.Vector3[1],o),o.normalize(),o.addInPlace(e[s].position),e[s].lookAt(o),this.fixedDragMeshScreenSize&&this.gizmoLayer.utilityLayerScene.activeCamera){e[s].absolutePosition.subtractToRef(this.gizmoLayer.utilityLayerScene.activeCamera.position,this._tmpVector);const t=this.rotationSphereSize*this._tmpVector.length()/this.fixedDragMeshScreenSizeDistanceFactor;e[s].scaling.set(t,t,t)}else this.fixedDragMeshBoundsSize?e[s].scaling.set(this.rotationSphereSize*this._boundingDimensions.x,this.rotationSphereSize*this._boundingDimensions.y,this.rotationSphereSize*this._boundingDimensions.z):e[s].scaling.set(this.rotationSphereSize,this.rotationSphereSize,this.rotationSphereSize)}}_updateScaleBoxes(){const e=this._scaleBoxesParent.getChildMeshes();let t=0;for(let i=0;i<3;i++)for(let r=0;r<3;r++)for(let s=0;s<3;s++){const o=(1===i?1:0)+(1===r?1:0)+(1===s?1:0);if(1!==o&&3!==o){if(e[t])if(e[t].position.set(this._boundingDimensions.x*(i/2),this._boundingDimensions.y*(r/2),this._boundingDimensions.z*(s/2)),e[t].position.addInPlace(new n.Pq(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),this.fixedDragMeshScreenSize&&this.gizmoLayer.utilityLayerScene.activeCamera){e[t].absolutePosition.subtractToRef(this.gizmoLayer.utilityLayerScene.activeCamera.globalPosition,this._tmpVector);const i=this.scaleBoxSize*this._tmpVector.length()/this.fixedDragMeshScreenSizeDistanceFactor;e[t].scaling.set(i,i,i)}else this.fixedDragMeshBoundsSize?e[t].scaling.set(this.scaleBoxSize*this._boundingDimensions.x,this.scaleBoxSize*this._boundingDimensions.y,this.scaleBoxSize*this._boundingDimensions.z):e[t].scaling.set(this.scaleBoxSize,this.scaleBoxSize,this.scaleBoxSize);t++}}}setEnabledRotationAxis(e){this._rotateAnchorsParent.getChildMeshes().forEach(((t,i)=>{i<4?t.setEnabled(-1!=e.indexOf("x")):i<8?t.setEnabled(-1!=e.indexOf("y")):t.setEnabled(-1!=e.indexOf("z"))}))}setEnabledScaling(e,t=!1){this._scaleBoxesParent.getChildMeshes().forEach((i=>{let r=e;t&&!0===i._internalMetadata&&(r=!1),i.setEnabled(r)}))}_updateDummy(){this._dragMesh&&(this._dragMesh.position.copyFrom(this._lineBoundingBox.getAbsolutePosition()),this._dragMesh.scaling.copyFrom(this._lineBoundingBox.scaling),this._dragMesh.rotationQuaternion.copyFrom(this._rootMesh.rotationQuaternion))}enableDragBehavior(){this._dragMesh=(0,ks.an)("dummy",{size:1},this.gizmoLayer.utilityLayerScene),this._dragMesh.visibility=0,this._dragMesh.rotationQuaternion=new n.PT,this._pointerDragBehavior.useObjectOrientationForDragging=!1,this._dragMesh.addBehavior(this._pointerDragBehavior)}releaseDrag(){this._scaleBoxesDragBehaviors.forEach((e=>{e.releaseDrag()})),this._rotateAnchorsDragBehaviors.forEach((e=>{e.releaseDrag()})),this._pointerDragBehavior.releaseDrag()}dispose(){this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.gizmoLayer.originalScene.onBeforeRenderObservable.remove(this._renderObserver),this._lineBoundingBox.dispose(),this._rotateAnchorsParent.dispose(),this._scaleBoxesParent.dispose(),this._dragMesh&&this._dragMesh.dispose(),this._scaleBoxesDragBehaviors.length=0,this._rotateAnchorsDragBehaviors.length=0,this.onDragStartObservable.clear(),this.onHoverStartObservable.clear(),this.onHoverEndObservable.clear(),this.onScaleBoxDragObservable.clear(),this.onScaleBoxDragEndObservable.clear(),this.onRotationSphereDragObservable.clear(),this.onRotationSphereDragEndObservable.clear(),super.dispose()}static MakeNotPickableAndWrapInBoundingBox(e){const t=e=>{e.isPickable=!1,e.getChildMeshes().forEach((e=>{t(e)}))};t(e),e.rotationQuaternion||(e.rotationQuaternion=n.PT.RotationYawPitchRoll(e.rotation.y,e.rotation.x,e.rotation.z));const i=e.position.clone(),r=e.rotationQuaternion.clone();e.rotationQuaternion.set(0,0,0,1),e.position.set(0,0,0);const s=(0,ks.an)("box",{size:1},e.getScene()),o=e.getHierarchyBoundingVectors();return o.max.subtractToRef(o.min,s.scaling),0===s.scaling.y&&(s.scaling.y=ut.bH),0===s.scaling.x&&(s.scaling.x=ut.bH),0===s.scaling.z&&(s.scaling.z=ut.bH),s.position.set((o.max.x+o.min.x)/2,(o.max.y+o.min.y)/2,(o.max.z+o.min.z)/2),e.addChild(s),e.rotationQuaternion.copyFrom(r),e.position.copyFrom(i),e.removeChild(s),s.addChild(e),s.visibility=0,s}setCustomMesh(){m.V.Error("Custom meshes are not supported on this gizmo")}}class Ru extends ws{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}set rotationColor(e){this._rotationShaderMaterial.setColor3("rotationColor",e)}get disableMaterial(){return this._disableMaterial}constructor(e,t=o.v9.Gray(),i=Rs.DefaultUtilityLayer,r=32,a=null,l=!1,h=1,c=o.v9.Yellow(),u=o.v9.Gray()){super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new s.cP,this.angle=0,this.sensitivity=1,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._angles=new n.Pq,this._parent=a,this._coloredMaterial=new br.F("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new o.v9(.1,.1,.1)),this._hoverMaterial=new br.F("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=c,this._hoverMaterial.specularColor=c,this._disableMaterial=new br.F("",i.utilityLayerScene),this._disableMaterial.diffuseColor=u,this._disableMaterial.alpha=.4,this._gizmoMesh=new tt.e("",i.utilityLayerScene);const{rotationMesh:d,collider:p}=this._createGizmoMesh(this._gizmoMesh,h,r);this._rotationDisplayPlane=ht("rotationDisplay",{size:.6,updatable:!1},this.gizmoLayer.utilityLayerScene),this._rotationDisplayPlane.rotation.z=.5*Math.PI,this._rotationDisplayPlane.parent=this._gizmoMesh,this._rotationDisplayPlane.setEnabled(!1),xo.M.ShadersStore.rotationGizmoVertexShader=Ru._RotationGizmoVertexShader,xo.M.ShadersStore.rotationGizmoFragmentShader=Ru._RotationGizmoFragmentShader,this._rotationShaderMaterial=new rs("shader",this.gizmoLayer.utilityLayerScene,{vertex:"rotationGizmo",fragment:"rotationGizmo"},{attributes:["position","uv"],uniforms:["worldViewProjection","angles","rotationColor"]}),this._rotationShaderMaterial.backFaceCulling=!1,this.rotationColor=c,this._rotationDisplayPlane.material=this._rotationShaderMaterial,this._rotationDisplayPlane.visibility=.999,this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._rootMesh.addChild(this._gizmoMesh,ws.PreserveScaling),this._gizmoMesh.scaling.scaleInPlace(1/3),this.dragBehavior=new dt({dragPlaneNormal:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.maxDragAngle=Ru.MaxDragAngle,this.dragBehavior._useAlternatePickedPointAboveMaxDragAngle=!0,this._rootMesh.addBehavior(this.dragBehavior);const f=new n.Pq,_=new n.uq,g=new n.Pq;let x=new n.Pq;this.dragBehavior.onDragStartObservable.add((e=>{this.attachedNode&&(f.copyFrom(e.dragPlanePoint),this._rotationDisplayPlane.setEnabled(!0),this._rotationDisplayPlane.getWorldMatrix().invertToRef(_),n.Pq.TransformCoordinatesToRef(e.dragPlanePoint,_,f),this._angles.x=Math.atan2(f.y,f.x)+Math.PI,this._angles.y=0,this._angles.z=this.updateGizmoRotationToMatchAttachedMesh?1:0,this._dragging=!0,f.copyFrom(e.dragPlanePoint),this._rotationShaderMaterial.setVector3("angles",this._angles),this.angle=0)})),this.dragBehavior.onDragEndObservable.add((()=>{this._dragging=!1,this._rotationDisplayPlane.setEnabled(!1)}));const v={snapDistance:0};let S=0;const b=new n.uq,y=new n.PT;this.dragBehavior.onDragObservable.add((t=>{if(this.attachedNode){const r=new n.Pq(1,1,1),s=new n.PT(0,0,0,1),o=new n.Pq(0,0,0),a=this._attachedNode;a&&a.isUsingPivotMatrix&&a.isUsingPivotMatrix()&&a.position&&a.getWorldMatrix().setTranslation(a.position),this.attachedNode.getWorldMatrix().decompose(r,s,o);if(!(Math.abs(Math.abs(r.x)-Math.abs(r.y))<=ut.bH&&Math.abs(Math.abs(r.x)-Math.abs(r.z))<=ut.bH)&&this.updateGizmoRotationToMatchAttachedMesh)return void m.V.Warn("Unable to use a rotation gizmo matching mesh rotation with non uniform scaling. Use uniform scaling or set updateGizmoRotationToMatchAttachedMesh to false.");s.normalize();const l=this.updateGizmoPositionToMatchAttachedMesh?o:this._rootMesh.absolutePosition,h=t.dragPlanePoint.subtract(l).normalize(),c=f.subtract(l).normalize(),u=n.Pq.Cross(h,c),d=n.Pq.Dot(h,c);let p=Math.atan2(u.length(),d)*this.sensitivity;g.copyFrom(e),x.copyFrom(e),this.updateGizmoRotationToMatchAttachedMesh&&(s.toRotationMatrix(_),x=n.Pq.TransformCoordinates(g,_));let P=!1;if(i.utilityLayerScene.activeCamera){const e=i.utilityLayerScene.activeCamera.position.subtract(l).normalize();n.Pq.Dot(e,x)>0&&(g.scaleInPlace(-1),x.scaleInPlace(-1),P=!0)}n.Pq.Dot(x,u)>0&&(p=-p),n.AA.Vector3[0].set(p,0,0),this.dragBehavior.validateDrag(n.AA.Vector3[0])||(p=0);let T=!1;if(0!=this.snapDistance)if(S+=p,Math.abs(S)>this.snapDistance){let e=Math.floor(Math.abs(S)/this.snapDistance);S<0&&(e*=-1),S%=this.snapDistance,p=this.snapDistance*e,T=!0}else p=0;const C=Math.sin(p/2);if(y.set(g.x*C,g.y*C,g.z*C,Math.cos(p/2)),b.determinant()>0){const e=new n.Pq;y.toEulerAnglesToRef(e),n.PT.RotationYawPitchRollToRef(e.y,-e.x,-e.z,y)}if(this.updateGizmoRotationToMatchAttachedMesh)s.multiplyToRef(y,s),s.normalize(),n.uq.ComposeToRef(r,s,o,this.attachedNode.getWorldMatrix());else{y.toRotationMatrix(n.AA.Matrix[0]);const e=this.attachedNode.getWorldMatrix().getTranslation();this.attachedNode.getWorldMatrix().multiplyToRef(n.AA.Matrix[0],this.attachedNode.getWorldMatrix()),this.attachedNode.getWorldMatrix().setTranslation(e)}f.copyFrom(t.dragPlanePoint),T&&(v.snapDistance=p,this.onSnapObservable.notifyObservers(v)),this._angles.y+=p,this.angle+=P?-p:p,this._rotationShaderMaterial.setVector3("angles",this._angles),this._matrixChanged()}}));const P=i._getSharedGizmoLight();P.includedOnlyMeshes=P.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes(!1));const T={colliderMeshes:[p],gizmoMeshes:[d],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};this._parent?.addToAxisCache(this._gizmoMesh,T),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((e=>{if(!this._customMeshSet&&(this.dragBehavior.maxDragAngle=Ru.MaxDragAngle,this._isHovered=!(-1==T.colliderMeshes.indexOf(e?.pickInfo?.pickedMesh)),!this._parent)){const e=T.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(T.gizmoMeshes,e)}})),this.dragBehavior.onEnabledObservable.add((e=>{this._setGizmoMeshMaterial(T.gizmoMeshes,e?this._coloredMaterial:this._disableMaterial)}))}_createGizmoMesh(e,t,i){const r=Lr("ignore",{diameter:.6,thickness:.03*t,tessellation:i},this.gizmoLayer.utilityLayerScene);r.visibility=0;const s=Lr("",{diameter:.6,thickness:.005*t,tessellation:i},this.gizmoLayer.utilityLayerScene);return s.material=this._coloredMaterial,s.rotation.x=Math.PI/2,r.rotation.x=Math.PI/2,e.addChild(s,ws.PreserveScaling),e.addChild(r,ws.PreserveScaling),{rotationMesh:s,collider:r}}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh):this.attachedMesh=null}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),this._rotationDisplayPlane&&this._rotationDisplayPlane.dispose(),this._rotationShaderMaterial&&this._rotationShaderMaterial.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()})),super.dispose()}}Ru.MaxDragAngle=9*Math.PI/20,Ru._RotationGizmoVertexShader="\n        precision highp float;\n        attribute vec3 position;\n        attribute vec2 uv;\n        uniform mat4 worldViewProjection;\n        varying vec3 vPosition;\n        varying vec2 vUV;\n\n        void main(void) {\n            gl_Position = worldViewProjection * vec4(position, 1.0);\n            vUV = uv;\n        }",Ru._RotationGizmoFragmentShader="\n        precision highp float;\n        varying vec2 vUV;\n        varying vec3 vPosition;\n        uniform vec3 angles;\n        uniform vec3 rotationColor;\n\n        #define twopi 6.283185307\n\n        void main(void) {\n            vec2 uv = vUV - vec2(0.5);\n            float angle = atan(uv.y, uv.x) + 3.141592;\n            float delta = gl_FrontFacing ? angles.y : -angles.y;\n            float begin = angles.x - delta * angles.z;\n            float start = (begin < (begin + delta)) ? begin : (begin + delta);\n            float end = (begin > (begin + delta)) ? begin : (begin + delta);\n            float len = sqrt(dot(uv,uv));\n            float opacity = 1. - step(0.5, len);\n\n            float base = abs(floor(start / twopi)) * twopi;\n            start += base;\n            end += base;\n\n            float intensity = 0.;\n            for (int i = 0; i < 5; i++)\n            {\n                intensity += max(step(start, angle) - step(end, angle), 0.);\n                angle += twopi;\n            }\n            gl_FragColor = vec4(rotationColor, min(intensity * 0.25, 0.8)) * opacity;\n        }\n    ";class Mu extends ws{get attachedMesh(){return this._meshAttached}set attachedMesh(e){this._meshAttached=e,this._nodeAttached=e,this._checkBillboardTransform(),[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t.isEnabled?t.attachedMesh=e:t.attachedMesh=null}))}get attachedNode(){return this._nodeAttached}set attachedNode(e){this._meshAttached=null,this._nodeAttached=e,this._checkBillboardTransform(),[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t.isEnabled?t.attachedNode=e:t.attachedNode=null}))}_checkBillboardTransform(){this._nodeAttached&&this._nodeAttached.billboardMode&&m.V.Log("Rotation Gizmo will not work with transforms in billboard mode.")}set sensitivity(e){this._sensitivity=e,[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t&&(t.sensitivity=e)}))}get sensitivity(){return this._sensitivity}get isHovered(){return this.xGizmo.isHovered||this.yGizmo.isHovered||this.zGizmo.isHovered}get isDragging(){return this.xGizmo.dragBehavior.dragging||this.yGizmo.dragBehavior.dragging||this.zGizmo.dragBehavior.dragging}get additionalTransformNode(){return this._additionalTransformNode}set additionalTransformNode(e){[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t.additionalTransformNode=e}))}constructor(e=Rs.DefaultUtilityLayer,t=32,i=!1,r=1,a,l){super(e),this.onDragStartObservable=new s.cP,this.onDragObservable=new s.cP,this.onDragEndObservable=new s.cP,this._observables=[],this._sensitivity=1,this._gizmoAxisCache=new Map;const h=l&&l.xOptions&&l.xOptions.color?l.xOptions.color:o.v9.Red().scale(.5),c=l&&l.yOptions&&l.yOptions.color?l.yOptions.color:o.v9.Green().scale(.5),u=l&&l.zOptions&&l.zOptions.color?l.zOptions.color:o.v9.Blue().scale(.5);this.xGizmo=new Ru(new n.Pq(1,0,0),h,e,t,this,i,r),this.yGizmo=new Ru(new n.Pq(0,1,0),c,e,t,this,i,r),this.zGizmo=new Ru(new n.Pq(0,0,1),u,e,t,this,i,r),this.additionalTransformNode=l?.additionalTransformNode,[this.xGizmo,this.yGizmo,this.zGizmo].forEach((e=>{l&&null!=l.updateScale&&(e.updateScale=l.updateScale),e.dragBehavior.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({})})),e.dragBehavior.onDragObservable.add((()=>{this.onDragObservable.notifyObservers({})})),e.dragBehavior.onDragEndObservable.add((()=>{this.onDragEndObservable.notifyObservers({})}))})),this.attachedMesh=null,this.attachedNode=null,a?a.addToAxisCache(this._gizmoAxisCache):ws.GizmoAxisPointerObserver(e,this._gizmoAxisCache)}set updateGizmoRotationToMatchAttachedMesh(e){this.xGizmo&&(this.xGizmo.updateGizmoRotationToMatchAttachedMesh=e,this.yGizmo.updateGizmoRotationToMatchAttachedMesh=e,this.zGizmo.updateGizmoRotationToMatchAttachedMesh=e)}get updateGizmoRotationToMatchAttachedMesh(){return this.xGizmo.updateGizmoRotationToMatchAttachedMesh}set updateGizmoPositionToMatchAttachedMesh(e){this.xGizmo&&(this.xGizmo.updateGizmoPositionToMatchAttachedMesh=e,this.yGizmo.updateGizmoPositionToMatchAttachedMesh=e,this.zGizmo.updateGizmoPositionToMatchAttachedMesh=e)}get updateGizmoPositionToMatchAttachedMesh(){return this.xGizmo.updateGizmoPositionToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e,[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t.anchorPoint=e}))}get anchorPoint(){return this._anchorPoint}set coordinatesMode(e){[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t.coordinatesMode=e}))}set updateScale(e){this.xGizmo&&(this.xGizmo.updateScale=e,this.yGizmo.updateScale=e,this.zGizmo.updateScale=e)}get updateScale(){return this.xGizmo.updateScale}set snapDistance(e){this.xGizmo&&(this.xGizmo.snapDistance=e,this.yGizmo.snapDistance=e,this.zGizmo.snapDistance=e)}get snapDistance(){return this.xGizmo.snapDistance}set scaleRatio(e){this.xGizmo&&(this.xGizmo.scaleRatio=e,this.yGizmo.scaleRatio=e,this.zGizmo.scaleRatio=e)}get scaleRatio(){return this.xGizmo.scaleRatio}get customRotationQuaternion(){return this._customRotationQuaternion}set customRotationQuaternion(e){this._customRotationQuaternion=e,[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t&&(t.customRotationQuaternion=e)}))}addToAxisCache(e,t){this._gizmoAxisCache.set(e,t)}releaseDrag(){this.xGizmo.dragBehavior.releaseDrag(),this.yGizmo.dragBehavior.releaseDrag(),this.zGizmo.dragBehavior.releaseDrag()}dispose(){this.xGizmo.dispose(),this.yGizmo.dispose(),this.zGizmo.dispose(),this.onDragStartObservable.clear(),this.onDragObservable.clear(),this.onDragEndObservable.clear(),this._observables.forEach((e=>{this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(e)})),super.dispose()}setCustomMesh(){m.V.Error("Custom meshes are not supported on this gizmo, please set the custom meshes on the gizmos contained within this one (gizmo.xGizmo, gizmo.yGizmo, gizmo.zGizmo)")}}class Du extends ws{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}static _CreatePlane(e,t){const i=new mt.V("plane",e),r=ht("dragPlane",{width:.1375,height:.1375,sideOrientation:2},e);return r.material=t,r.parent=i,i}constructor(e,t=o.v9.Gray(),i=Rs.DefaultUtilityLayer,r=null,a=o.v9.Yellow(),l=o.v9.Gray()){super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new s.cP,this._isEnabled=!1,this._parent=null,this._dragging=!1,this._parent=r,this._coloredMaterial=new br.F("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new o.v9(.1,.1,.1)),this._hoverMaterial=new br.F("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=a,this._disableMaterial=new br.F("",i.utilityLayerScene),this._disableMaterial.diffuseColor=l,this._disableMaterial.alpha=.4,this._gizmoMesh=Du._CreatePlane(i.utilityLayerScene,this._coloredMaterial),this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._gizmoMesh.scaling.scaleInPlace(1/3),this._gizmoMesh.parent=this._rootMesh;let h=0;const c=new n.Pq,u={snapDistance:0};this.dragBehavior=new dt({dragPlaneNormal:e}),this.dragBehavior.moveAttached=!1,this._rootMesh.addBehavior(this.dragBehavior),this.dragBehavior.onDragObservable.add((e=>{if(this.attachedNode){if(0==this.snapDistance)this.attachedNode.getWorldMatrix().getTranslationToRef(n.AA.Vector3[0]),n.AA.Vector3[0].addToRef(e.delta,n.AA.Vector3[0]),this.dragBehavior.validateDrag(n.AA.Vector3[0])&&this.attachedNode.getWorldMatrix().addTranslationFromFloats(e.delta.x,e.delta.y,e.delta.z);else if(h+=e.dragDistance,Math.abs(h)>this.snapDistance){const t=Math.floor(Math.abs(h)/this.snapDistance);h%=this.snapDistance,e.delta.normalizeToRef(c),c.scaleInPlace(this.snapDistance*t),this.attachedNode.getWorldMatrix().getTranslationToRef(n.AA.Vector3[0]),n.AA.Vector3[0].addToRef(c,n.AA.Vector3[0]),this.dragBehavior.validateDrag(n.AA.Vector3[0])&&(this.attachedNode.getWorldMatrix().addTranslationFromFloats(c.x,c.y,c.z),u.snapDistance=this.snapDistance*t,this.onSnapObservable.notifyObservers(u))}this._matrixChanged()}})),this.dragBehavior.onDragStartObservable.add((()=>{this._dragging=!0})),this.dragBehavior.onDragEndObservable.add((()=>{this._dragging=!1}));const d=i._getSharedGizmoLight();d.includedOnlyMeshes=d.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes(!1));const p={gizmoMeshes:this._gizmoMesh.getChildMeshes(),colliderMeshes:this._gizmoMesh.getChildMeshes(),material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};this._parent?.addToAxisCache(this._gizmoMesh,p),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((e=>{if(!this._customMeshSet&&(this._isHovered=!(-1==p.colliderMeshes.indexOf(e?.pickInfo?.pickedMesh)),!this._parent)){const e=p.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(p.gizmoMeshes,e)}})),this.dragBehavior.onEnabledObservable.add((e=>{this._setGizmoMeshMaterial(p.gizmoMeshes,e?this._coloredMaterial:this._disableMaterial)}))}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedNode=this._parent.attachedNode):this.attachedNode=null}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),super.dispose(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()}))}}class Ou extends ws{get attachedMesh(){return this._meshAttached}set attachedMesh(e){this._meshAttached=e,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t.isEnabled?t.attachedMesh=e:t.attachedMesh=null}))}get attachedNode(){return this._nodeAttached}set attachedNode(e){this._meshAttached=null,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t.isEnabled?t.attachedNode=e:t.attachedNode=null}))}get isHovered(){return this.xGizmo.isHovered||this.yGizmo.isHovered||this.zGizmo.isHovered||this.xPlaneGizmo.isHovered||this.yPlaneGizmo.isHovered||this.zPlaneGizmo.isHovered}get isDragging(){return this.xGizmo.dragBehavior.dragging||this.yGizmo.dragBehavior.dragging||this.zGizmo.dragBehavior.dragging||this.xPlaneGizmo.dragBehavior.dragging||this.yPlaneGizmo.dragBehavior.dragging||this.zPlaneGizmo.dragBehavior.dragging}get additionalTransformNode(){return this._additionalTransformNode}set additionalTransformNode(e){[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t.additionalTransformNode=e}))}constructor(e=Rs.DefaultUtilityLayer,t=1,i,r){super(e),this._meshAttached=null,this._nodeAttached=null,this._observables=[],this._gizmoAxisCache=new Map,this.onDragStartObservable=new s.cP,this.onDragObservable=new s.cP,this.onDragEndObservable=new s.cP,this._planarGizmoEnabled=!1,this.xGizmo=new Fs(new n.Pq(1,0,0),o.v9.Red().scale(.5),e,this,t),this.yGizmo=new Fs(new n.Pq(0,1,0),o.v9.Green().scale(.5),e,this,t),this.zGizmo=new Fs(new n.Pq(0,0,1),o.v9.Blue().scale(.5),e,this,t),this.xPlaneGizmo=new Du(new n.Pq(1,0,0),o.v9.Red().scale(.5),this.gizmoLayer,this),this.yPlaneGizmo=new Du(new n.Pq(0,1,0),o.v9.Green().scale(.5),this.gizmoLayer,this),this.zPlaneGizmo=new Du(new n.Pq(0,0,1),o.v9.Blue().scale(.5),this.gizmoLayer,this),this.additionalTransformNode=r?.additionalTransformNode,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((e=>{e.dragBehavior.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({})})),e.dragBehavior.onDragObservable.add((()=>{this.onDragObservable.notifyObservers({})})),e.dragBehavior.onDragEndObservable.add((()=>{this.onDragEndObservable.notifyObservers({})}))})),this.attachedMesh=null,i?i.addToAxisCache(this._gizmoAxisCache):ws.GizmoAxisPointerObserver(e,this._gizmoAxisCache)}set planarGizmoEnabled(e){this._planarGizmoEnabled=e,[this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.isEnabled=e,e&&(t.attachedMesh?t.attachedMesh=this.attachedMesh:t.attachedNode=this.attachedNode))}),this)}get planarGizmoEnabled(){return this._planarGizmoEnabled}get customRotationQuaternion(){return this._customRotationQuaternion}set customRotationQuaternion(e){this._customRotationQuaternion=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.customRotationQuaternion=e)}))}set updateGizmoRotationToMatchAttachedMesh(e){this._updateGizmoRotationToMatchAttachedMesh=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.updateGizmoRotationToMatchAttachedMesh=e)}))}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set updateGizmoPositionToMatchAttachedMesh(e){this._updateGizmoPositionToMatchAttachedMesh=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.updateGizmoPositionToMatchAttachedMesh=e)}))}get updateGizmoPositionToMatchAttachedMesh(){return this._updateGizmoPositionToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t.anchorPoint=e}))}get anchorPoint(){return this._anchorPoint}set coordinatesMode(e){[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t.coordinatesMode=e}))}set updateScale(e){this.xGizmo&&(this.xGizmo.updateScale=e,this.yGizmo.updateScale=e,this.zGizmo.updateScale=e)}get updateScale(){return this.xGizmo.updateScale}set snapDistance(e){this._snapDistance=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.snapDistance=e)}))}get snapDistance(){return this._snapDistance}set scaleRatio(e){this._scaleRatio=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.scaleRatio=e)}))}get scaleRatio(){return this._scaleRatio}addToAxisCache(e,t){this._gizmoAxisCache.set(e,t)}releaseDrag(){this.xGizmo.dragBehavior.releaseDrag(),this.yGizmo.dragBehavior.releaseDrag(),this.zGizmo.dragBehavior.releaseDrag(),this.xPlaneGizmo.dragBehavior.releaseDrag(),this.yPlaneGizmo.dragBehavior.releaseDrag(),this.zPlaneGizmo.dragBehavior.releaseDrag()}dispose(){[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((e=>{e&&e.dispose()})),this._observables.forEach((e=>{this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(e)})),this.onDragStartObservable.clear(),this.onDragObservable.clear(),this.onDragEndObservable.clear(),super.dispose()}setCustomMesh(){m.V.Error("Custom meshes are not supported on this gizmo, please set the custom meshes on the gizmos contained within this one (gizmo.xGizmo, gizmo.yGizmo, gizmo.zGizmo,gizmo.xPlaneGizmo, gizmo.yPlaneGizmo, gizmo.zPlaneGizmo)")}}class Nu extends ws{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}get attachedMesh(){return this._meshAttached}set attachedMesh(e){this._meshAttached=e,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t.isEnabled?t.attachedMesh=e:t.attachedMesh=null}))}get attachedNode(){return this._nodeAttached}set attachedNode(e){this._meshAttached=null,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t.isEnabled?t.attachedNode=e:t.attachedNode=null}))}set updateScale(e){this.xGizmo&&(this.xGizmo.updateScale=e,this.yGizmo.updateScale=e,this.zGizmo.updateScale=e)}get updateScale(){return this.xGizmo.updateScale}get isHovered(){return this.xGizmo.isHovered||this.yGizmo.isHovered||this.zGizmo.isHovered||this.uniformScaleGizmo.isHovered}get isDragging(){return this.xGizmo.dragBehavior.dragging||this.yGizmo.dragBehavior.dragging||this.zGizmo.dragBehavior.dragging||this.uniformScaleGizmo.dragBehavior.dragging}get additionalTransformNode(){return this._additionalTransformNode}set additionalTransformNode(e){[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t.additionalTransformNode=e}))}constructor(e=Rs.DefaultUtilityLayer,t=1,i,r){super(e),this._meshAttached=null,this._nodeAttached=null,this._incrementalSnap=!1,this._sensitivity=1,this._observables=[],this._gizmoAxisCache=new Map,this.onDragStartObservable=new s.cP,this.onDragObservable=new s.cP,this.onDragEndObservable=new s.cP,this.uniformScaleGizmo=this._createUniformScaleMesh(),this.xGizmo=new Eu(new n.Pq(1,0,0),o.v9.Red().scale(.5),e,this,t),this.yGizmo=new Eu(new n.Pq(0,1,0),o.v9.Green().scale(.5),e,this,t),this.zGizmo=new Eu(new n.Pq(0,0,1),o.v9.Blue().scale(.5),e,this,t),this.additionalTransformNode=r?.additionalTransformNode,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((e=>{e.dragBehavior.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({})})),e.dragBehavior.onDragObservable.add((()=>{this.onDragObservable.notifyObservers({})})),e.dragBehavior.onDragEndObservable.add((()=>{this.onDragEndObservable.notifyObservers({})}))})),this.attachedMesh=null,this.attachedNode=null,i?i.addToAxisCache(this._gizmoAxisCache):ws.GizmoAxisPointerObserver(e,this._gizmoAxisCache)}_createUniformScaleMesh(){this._coloredMaterial=new br.F("",this.gizmoLayer.utilityLayerScene),this._coloredMaterial.diffuseColor=o.v9.Gray(),this._hoverMaterial=new br.F("",this.gizmoLayer.utilityLayerScene),this._hoverMaterial.diffuseColor=o.v9.Yellow(),this._disableMaterial=new br.F("",this.gizmoLayer.utilityLayerScene),this._disableMaterial.diffuseColor=o.v9.Gray(),this._disableMaterial.alpha=.4;const e=new Eu(new n.Pq(0,1,0),o.v9.Gray().scale(.5),this.gizmoLayer,this);e.updateGizmoRotationToMatchAttachedMesh=!1,e.uniformScaling=!0,this._uniformScalingMesh=Un("uniform",{type:1},e.gizmoLayer.utilityLayerScene),this._uniformScalingMesh.scaling.scaleInPlace(.01),this._uniformScalingMesh.visibility=0,this._octahedron=Un("",{type:1},e.gizmoLayer.utilityLayerScene),this._octahedron.scaling.scaleInPlace(.007),this._uniformScalingMesh.addChild(this._octahedron),e.setCustomMesh(this._uniformScalingMesh,!0);const t=this.gizmoLayer._getSharedGizmoLight();t.includedOnlyMeshes=t.includedOnlyMeshes.concat(this._octahedron);const i={gizmoMeshes:[this._octahedron,this._uniformScalingMesh],colliderMeshes:[this._octahedron,this._uniformScalingMesh],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:e.dragBehavior};return this.addToAxisCache(e._rootMesh,i),e}set updateGizmoRotationToMatchAttachedMesh(e){e?(this._updateGizmoRotationToMatchAttachedMesh=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t&&(t.updateGizmoRotationToMatchAttachedMesh=e)}))):m.V.Warn("Setting updateGizmoRotationToMatchAttachedMesh = false on scaling gizmo is not supported.")}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t&&(t.anchorPoint=e)}))}get anchorPoint(){return this._anchorPoint}get customRotationQuaternion(){return this._customRotationQuaternion}set customRotationQuaternion(e){this._customRotationQuaternion=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t&&(t.customRotationQuaternion=e)}))}set coordinatesMode(e){0==e&&m.V.Warn("Setting coordinates Mode to world on scaling gizmo is not supported."),[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((e=>{e.coordinatesMode=1}))}set snapDistance(e){this._snapDistance=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t&&(t.snapDistance=e)}))}get snapDistance(){return this._snapDistance}set incrementalSnap(e){this._incrementalSnap=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t&&(t.incrementalSnap=e)}))}get incrementalSnap(){return this._incrementalSnap}set scaleRatio(e){this._scaleRatio=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t&&(t.scaleRatio=e)}))}get scaleRatio(){return this._scaleRatio}set sensitivity(e){this._sensitivity=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t&&(t.sensitivity=e)}))}get sensitivity(){return this._sensitivity}addToAxisCache(e,t){this._gizmoAxisCache.set(e,t)}getAxisCache(e){return this._gizmoAxisCache.get(e)}releaseDrag(){this.xGizmo.dragBehavior.releaseDrag(),this.yGizmo.dragBehavior.releaseDrag(),this.zGizmo.dragBehavior.releaseDrag(),this.uniformScaleGizmo.dragBehavior.releaseDrag()}dispose(){[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((e=>{e&&e.dispose()})),this._observables.forEach((e=>{this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(e)})),this.onDragStartObservable.clear(),this.onDragObservable.clear(),this.onDragEndObservable.clear(),[this._uniformScalingMesh,this._octahedron].forEach((e=>{e&&e.dispose()})),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()}))}}class wu{get keepDepthUtilityLayer(){return this._defaultKeepDepthUtilityLayer}get utilityLayer(){return this._defaultUtilityLayer}get isHovered(){let e=!1;for(const t in this.gizmos){const i=this.gizmos[t];if(i&&i.isHovered){e=!0;break}}return e}get isDragging(){let e=!1;return[this.gizmos.positionGizmo,this.gizmos.rotationGizmo,this.gizmos.scaleGizmo,this.gizmos.boundingBoxGizmo].forEach((t=>{t&&t.isDragging&&(e=!0)})),e}set scaleRatio(e){this._scaleRatio=e,[this.gizmos.positionGizmo,this.gizmos.rotationGizmo,this.gizmos.scaleGizmo].forEach((t=>{t&&(t.scaleRatio=e)}))}get scaleRatio(){return this._scaleRatio}set coordinatesMode(e){this._coordinatesMode=e,[this.gizmos.positionGizmo,this.gizmos.rotationGizmo,this.gizmos.scaleGizmo].forEach((t=>{t&&(t.coordinatesMode=e)}))}get coordinatesMode(){return this._coordinatesMode}get attachedMesh(){return this._attachedMesh}get attachedNode(){return this._attachedNode}get additionalTransformNode(){return this._additionalTransformNode}constructor(e,t=1,i=Rs.DefaultUtilityLayer,r=Rs.DefaultKeepDepthUtilityLayer){this._scene=e,this.clearGizmoOnEmptyPointerEvent=!1,this.enableAutoPicking=!0,this.onAttachedToMeshObservable=new s.cP,this.onAttachedToNodeObservable=new s.cP,this._gizmosEnabled={positionGizmo:!1,rotationGizmo:!1,scaleGizmo:!1,boundingBoxGizmo:!1},this._pointerObservers=[],this._attachedMesh=null,this._attachedNode=null,this._boundingBoxColor=o.v9.FromHexString("#0984e3"),this._thickness=1,this._scaleRatio=1,this._coordinatesMode=1,this._gizmoAxisCache=new Map,this.boundingBoxDragBehavior=new gt,this.attachableMeshes=null,this.attachableNodes=null,this.usePointerToAttachGizmos=!0,this._defaultUtilityLayer=i,this._defaultKeepDepthUtilityLayer=r,this._defaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,this._thickness=t,this.gizmos={positionGizmo:null,rotationGizmo:null,scaleGizmo:null,boundingBoxGizmo:null};const n=this._attachToMeshPointerObserver(e),a=ws.GizmoAxisPointerObserver(this._defaultUtilityLayer,this._gizmoAxisCache);this._pointerObservers=[n,a]}_attachToMeshPointerObserver(e){const t=e.onPointerObservable.add((e=>{if(this.usePointerToAttachGizmos&&e.type==rt.Zp.POINTERDOWN)if(e.pickInfo&&e.pickInfo.pickedMesh){if(this.enableAutoPicking){let t=e.pickInfo.pickedMesh;if(null==this.attachableMeshes)for(;t&&null!=t.parent;)t=t.parent;else{let e=!1;this.attachableMeshes.forEach((i=>{t&&(t==i||t.isDescendantOf(i))&&(t=i,e=!0)})),e||(t=null)}t instanceof Ps.u?this._attachedMesh!=t&&this.attachToMesh(t):this.clearGizmoOnEmptyPointerEvent&&this.attachToMesh(null)}}else this.clearGizmoOnEmptyPointerEvent&&this.attachToMesh(null)}));return t}attachToMesh(e){this._attachedMesh&&this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh=e,this._attachedNode=null;for(const t in this.gizmos){const i=this.gizmos[t];i&&this._gizmosEnabled[t]&&(i.attachedMesh=e)}this.boundingBoxGizmoEnabled&&this._attachedMesh&&this._attachedMesh.addBehavior(this.boundingBoxDragBehavior),this.onAttachedToMeshObservable.notifyObservers(e)}attachToNode(e){this._attachedMesh&&this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh=null,this._attachedNode=e;for(const t in this.gizmos){const i=this.gizmos[t];i&&this._gizmosEnabled[t]&&(i.attachedNode=e)}this.boundingBoxGizmoEnabled&&this._attachedNode&&this._attachedNode.addBehavior(this.boundingBoxDragBehavior),this.onAttachedToNodeObservable.notifyObservers(e)}set positionGizmoEnabled(e){e?(this.gizmos.positionGizmo||(this.gizmos.positionGizmo=new Ou(this._defaultUtilityLayer,this._thickness,this)),this._attachedNode?this.gizmos.positionGizmo.attachedNode=this._attachedNode:this.gizmos.positionGizmo.attachedMesh=this._attachedMesh):this.gizmos.positionGizmo&&(this.gizmos.positionGizmo.attachedNode=null),this._gizmosEnabled.positionGizmo=e,this._setAdditionalTransformNode()}get positionGizmoEnabled(){return this._gizmosEnabled.positionGizmo}set rotationGizmoEnabled(e){e?(this.gizmos.rotationGizmo||(this.gizmos.rotationGizmo=new Mu(this._defaultUtilityLayer,32,!1,this._thickness,this)),this._attachedNode?this.gizmos.rotationGizmo.attachedNode=this._attachedNode:this.gizmos.rotationGizmo.attachedMesh=this._attachedMesh):this.gizmos.rotationGizmo&&(this.gizmos.rotationGizmo.attachedNode=null),this._gizmosEnabled.rotationGizmo=e,this._setAdditionalTransformNode()}get rotationGizmoEnabled(){return this._gizmosEnabled.rotationGizmo}set scaleGizmoEnabled(e){e?(this.gizmos.scaleGizmo=this.gizmos.scaleGizmo||new Nu(this._defaultUtilityLayer,this._thickness,this),this._attachedNode?this.gizmos.scaleGizmo.attachedNode=this._attachedNode:this.gizmos.scaleGizmo.attachedMesh=this._attachedMesh):this.gizmos.scaleGizmo&&(this.gizmos.scaleGizmo.attachedNode=null),this._gizmosEnabled.scaleGizmo=e,this._setAdditionalTransformNode()}get scaleGizmoEnabled(){return this._gizmosEnabled.scaleGizmo}set boundingBoxGizmoEnabled(e){e?(this.gizmos.boundingBoxGizmo=this.gizmos.boundingBoxGizmo||new Iu(this._boundingBoxColor,this._defaultKeepDepthUtilityLayer),this._attachedMesh?this.gizmos.boundingBoxGizmo.attachedMesh=this._attachedMesh:this.gizmos.boundingBoxGizmo.attachedNode=this._attachedNode,this._attachedMesh?(this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh.addBehavior(this.boundingBoxDragBehavior)):this._attachedNode&&(this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode.addBehavior(this.boundingBoxDragBehavior))):this.gizmos.boundingBoxGizmo&&(this._attachedMesh?this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior):this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this.gizmos.boundingBoxGizmo.attachedNode=null),this._gizmosEnabled.boundingBoxGizmo=e,this._setAdditionalTransformNode()}get boundingBoxGizmoEnabled(){return this._gizmosEnabled.boundingBoxGizmo}set additionalTransformNode(e){this._additionalTransformNode=e,this._setAdditionalTransformNode()}_setAdditionalTransformNode(){for(const e in this.gizmos){const t=this.gizmos[e];t&&this._gizmosEnabled[e]&&(t.additionalTransformNode=this._additionalTransformNode)}}addToAxisCache(e){e.size>0&&e.forEach(((e,t)=>{this._gizmoAxisCache.set(t,e)}))}releaseDrag(){[this.gizmos.positionGizmo,this.gizmos.rotationGizmo,this.gizmos.scaleGizmo,this.gizmos.boundingBoxGizmo].forEach((e=>{e?.releaseDrag()}))}dispose(){this._pointerObservers.forEach((e=>{this._scene.onPointerObservable.remove(e)}));for(const e in this.gizmos){const t=this.gizmos[e];t&&t.dispose()}this._defaultKeepDepthUtilityLayer!==Rs._DefaultKeepDepthUtilityLayer&&this._defaultKeepDepthUtilityLayer?.dispose(),this._defaultUtilityLayer!==Rs._DefaultUtilityLayer&&this._defaultUtilityLayer?.dispose(),this.boundingBoxDragBehavior.detach(),this.onAttachedToMeshObservable.clear()}}function Fu(e,t={},i){t.diameter||(t.diameter=1),t.segments||(t.segments=16);const r=zs("",{slice:.5,diameter:t.diameter,segments:t.segments},i),s=rn("",{radius:t.diameter/2,tessellation:3*t.segments+(4-t.segments)},i);s.rotation.x=-Math.PI/2,s.parent=r;const n=tt.e.MergeMeshes([s,r],!0);return n.name=e,n}const Bu={CreateHemisphere:Fu};tt.e.CreateHemisphere=(e,t,i,r)=>Fu(e,{segments:t,diameter:i},r);var Vu=i(40136);class Lu extends ws{constructor(e=Rs.DefaultUtilityLayer){super(e),this._cachedPosition=new n.Pq,this._cachedForward=new n.Pq(0,0,1),this._pointerObserver=null,this.onClickedObservable=new s.cP,this._light=null,this.attachedMesh=new tt.e("",this.gizmoLayer.utilityLayerScene),this._attachedMeshParent=new mt.V("parent",this.gizmoLayer.utilityLayerScene),this.attachedMesh.parent=this._attachedMeshParent,this._material=new br.F("light",this.gizmoLayer.utilityLayerScene),this._material.diffuseColor=new o.v9(.5,.5,.5),this._material.specularColor=new o.v9(.1,.1,.1),this._pointerObserver=e.utilityLayerScene.onPointerObservable.add((e=>{this._light&&(this._isHovered=!(!e.pickInfo||-1==this._rootMesh.getChildMeshes().indexOf(e.pickInfo.pickedMesh)),this._isHovered&&0===e.event.button&&this.onClickedObservable.notifyObservers(this._light))}),rt.Zp.POINTERDOWN)}get attachedNode(){return this.attachedMesh}set attachedNode(e){m.V.Warn("Nodes cannot be attached to LightGizmo. Attach to a mesh instead.")}set light(e){if(this._light=e,e){this._lightMesh&&this._lightMesh.dispose(),e instanceof Is.g?this._lightMesh=Lu._CreateHemisphericLightMesh(this.gizmoLayer.utilityLayerScene):e instanceof Hh.Z?this._lightMesh=Lu._CreateDirectionalLightMesh(this.gizmoLayer.utilityLayerScene):e instanceof Vu.n?this._lightMesh=Lu._CreateSpotLightMesh(this.gizmoLayer.utilityLayerScene):this._lightMesh=Lu._CreatePointLightMesh(this.gizmoLayer.utilityLayerScene),this._lightMesh.getChildMeshes(!1).forEach((e=>{e.material=this._material})),this._lightMesh.parent=this._rootMesh;const t=this.gizmoLayer._getSharedGizmoLight();if(t.includedOnlyMeshes=t.includedOnlyMeshes.concat(this._lightMesh.getChildMeshes(!1)),this._lightMesh.rotationQuaternion=new n.PT,this.attachedMesh.reservedDataStore||(this.attachedMesh.reservedDataStore={}),this.attachedMesh.reservedDataStore.lightGizmo=this,e.parent&&this._attachedMeshParent.freezeWorldMatrix(e.parent.getWorldMatrix()),e.position&&(this.attachedMesh.position.copyFrom(e.position),this.attachedMesh.computeWorldMatrix(!0),this._cachedPosition.copyFrom(this.attachedMesh.position)),e.direction){this.attachedMesh.setDirection(e.direction),this.attachedMesh.computeWorldMatrix(!0);const t=this._getMeshForward();this._cachedForward.copyFrom(t)}this._update()}}get light(){return this._light}get material(){return this._material}_getMeshForward(){let e=this.attachedMesh.forward;return this.attachedMesh.getScene().useRightHandedSystem&&(e.negateToRef(n.AA.Vector3[0]),e=n.AA.Vector3[0]),e}_update(){if(super._update(),this._light){if(this._light.parent&&this._attachedMeshParent.freezeWorldMatrix(this._light.parent.getWorldMatrix()),this._light.position)if(this.attachedMesh.position.equals(this._cachedPosition))this.attachedMesh.position.copyFrom(this._light.position),this.attachedMesh.computeWorldMatrix(!0),this._cachedPosition.copyFrom(this.attachedMesh.position);else{const e=this.attachedMesh.position;this._light.position=new n.Pq(e.x,e.y,e.z),this._cachedPosition.copyFrom(this.attachedMesh.position)}if(this._light.direction){const e=this._getMeshForward();if(n.Pq.DistanceSquared(e,this._cachedForward)>1e-4){const t=e;this._light.direction=new n.Pq(t.x,t.y,t.z),this._cachedForward.copyFrom(e)}else n.Pq.DistanceSquared(e,this._light.direction)>1e-4&&(this.attachedMesh.setDirection(this._light.direction),this.attachedMesh.computeWorldMatrix(!0),this._cachedForward.copyFrom(e))}}}dispose(){this.onClickedObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this._material.dispose(),super.dispose(),this._attachedMeshParent.dispose()}static _CreateHemisphericLightMesh(e){const t=new tt.e("hemisphereLight",e),i=Fu(t.name,{segments:10,diameter:1},e);i.position.z=-.15,i.rotation.x=Math.PI/2,i.parent=t;return this._CreateLightLines(3,e).parent=t,t.scaling.scaleInPlace(Lu._Scale),t.rotation.x=Math.PI/2,t}static _CreatePointLightMesh(e){const t=new tt.e("pointLight",e),i=zs(t.name,{segments:10,diameter:1},e);i.rotation.x=Math.PI/2,i.parent=t;return this._CreateLightLines(5,e).parent=t,t.scaling.scaleInPlace(Lu._Scale),t.rotation.x=Math.PI/2,t}static _CreateSpotLightMesh(e){const t=new tt.e("spotLight",e);zs(t.name,{segments:10,diameter:1},e).parent=t;const i=Fu(t.name,{segments:10,diameter:2},e);i.parent=t,i.rotation.x=-Math.PI/2;return this._CreateLightLines(2,e).parent=t,t.scaling.scaleInPlace(Lu._Scale),t.rotation.x=Math.PI/2,t}static _CreateDirectionalLightMesh(e){const t=new tt.e("directionalLight",e),i=new tt.e(t.name,e);i.parent=t;zs(t.name,{diameter:1.2,segments:10},e).parent=i;const r=Es(t.name,{updatable:!1,height:6,diameterTop:.3,diameterBottom:.3,tessellation:6,subdivisions:1},e);r.parent=i;let s=r.clone(t.name);s.scaling.y=.5,s.position.x+=1.25;let n=r.clone(t.name);n.scaling.y=.5,n.position.x+=-1.25;const o=Es(t.name,{updatable:!1,height:1,diameterTop:0,diameterBottom:.6,tessellation:6,subdivisions:1},e);return o.position.y+=3,o.parent=i,s=o.clone(t.name),s.position.y=1.5,s.position.x+=1.25,n=o.clone(t.name),n.position.y=1.5,n.position.x+=-1.25,i.scaling.scaleInPlace(Lu._Scale),i.rotation.z=Math.PI/2,i.rotation.y=Math.PI/2,t}}Lu._Scale=.007,Lu._CreateLightLines=(e,t)=>{const i=new tt.e("root",t);i.rotation.x=Math.PI/2;const r=new tt.e("linePivot",t);r.parent=i;const s=Es("line",{updatable:!1,height:2,diameterTop:.2,diameterBottom:.3,tessellation:6,subdivisions:1},t);if(s.position.y=s.scaling.y/2+1.2,s.parent=r,e<2)return r;for(let e=0;e<4;e++){const t=r.clone("lineParentClone");t.rotation.z=Math.PI/4,t.rotation.y=Math.PI/2+Math.PI/2*e,t.getChildMeshes()[0].scaling.y=.5,t.getChildMeshes()[0].scaling.x=t.getChildMeshes()[0].scaling.z=.8,t.getChildMeshes()[0].position.y=t.getChildMeshes()[0].scaling.y/2+1.2}if(e<3)return i;for(let e=0;e<4;e++){const t=r.clone("linePivotClone");t.rotation.z=Math.PI/2,t.rotation.y=Math.PI/2*e}if(e<4)return i;for(let e=0;e<4;e++){const t=r.clone("linePivotClone");t.rotation.z=Math.PI+Math.PI/4,t.rotation.y=Math.PI/2+Math.PI/2*e,t.getChildMeshes()[0].scaling.y=.5,t.getChildMeshes()[0].scaling.x=t.getChildMeshes()[0].scaling.z=.8,t.getChildMeshes()[0].position.y=t.getChildMeshes()[0].scaling.y/2+1.2}if(e<5)return i;return r.clone("linePivotClone").rotation.z=Math.PI,i};var ku=i(62956);class Gu extends ws{constructor(e=Rs.DefaultUtilityLayer,t,i){super(e),this._pointerObserver=null,this.onClickedObservable=new s.cP,this._camera=null,this._invProjection=new ku.uq,this._material=new br.F("cameraGizmoMaterial",this.gizmoLayer.utilityLayerScene),this._frustumLinesColor=i,this._material.diffuseColor=t??new o.v9(.5,.5,.5),this._material.specularColor=new o.v9(.1,.1,.1),this._pointerObserver=e.utilityLayerScene.onPointerObservable.add((e=>{this._camera&&(this._isHovered=!(!e.pickInfo||-1==this._rootMesh.getChildMeshes().indexOf(e.pickInfo.pickedMesh)),this._isHovered&&0===e.event.button&&this.onClickedObservable.notifyObservers(this._camera))}),rt.Zp.POINTERDOWN)}get displayFrustum(){return this._cameraLinesMesh.isEnabled()}set displayFrustum(e){this._cameraLinesMesh.setEnabled(e)}set camera(e){if(this._camera=e,this.attachedNode=e,e){this._customMeshSet||(this._cameraMesh&&this._cameraMesh.dispose(),this._cameraMesh=Gu._CreateCameraMesh(this.gizmoLayer.utilityLayerScene),this._cameraMesh.getChildMeshes(!1).forEach((e=>{e.material=this._material})),this._cameraMesh.parent=this._rootMesh),this._cameraLinesMesh&&this._cameraLinesMesh.dispose();const t=this._frustumLinesColor?.toColor4(1)??new o.ov(1,1,1,1);this._cameraLinesMesh=Gu._CreateCameraFrustum(this.gizmoLayer.utilityLayerScene,t),this._cameraLinesMesh.parent=this._rootMesh,this.gizmoLayer.utilityLayerScene.activeCamera&&this.gizmoLayer.utilityLayerScene.activeCamera.maxZ<1.5*e.maxZ&&(this.gizmoLayer.utilityLayerScene.activeCamera.maxZ=1.5*e.maxZ),this.attachedNode.reservedDataStore||(this.attachedNode.reservedDataStore={}),this.attachedNode.reservedDataStore.cameraGizmo=this;const i=this.gizmoLayer._getSharedGizmoLight();i.includedOnlyMeshes=i.includedOnlyMeshes.concat(this._cameraMesh.getChildMeshes(!1)),this._update()}}get camera(){return this._camera}get material(){return this._material}_update(){super._update(),this._camera&&(this._camera.getProjectionMatrix().invertToRef(this._invProjection),this._cameraLinesMesh.setPivotMatrix(this._invProjection,!1),this._cameraLinesMesh.scaling.x=1/this._rootMesh.scaling.x,this._cameraLinesMesh.scaling.y=1/this._rootMesh.scaling.y,this._cameraLinesMesh.scaling.z=1/this._rootMesh.scaling.z,this._cameraMesh.parent=null,this._cameraMesh.rotation.y=.5*Math.PI*(this._camera.getScene().useRightHandedSystem?1:-1),this._cameraMesh.parent=this._rootMesh)}setCustomMesh(e){if(e.getScene()!=this.gizmoLayer.utilityLayerScene)throw"When setting a custom mesh on a gizmo, the custom meshes scene must be the same as the gizmos (eg. gizmo.gizmoLayer.utilityLayerScene)";this._cameraMesh&&this._cameraMesh.dispose(),this._cameraMesh=e,this._cameraMesh.parent=this._rootMesh,this._customMeshSet=!0}dispose(){this.onClickedObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this._cameraMesh&&this._cameraMesh.dispose(),this._cameraLinesMesh&&this._cameraLinesMesh.dispose(),this._material.dispose(),super.dispose()}static _CreateCameraMesh(e){const t=new tt.e("rootCameraGizmo",e),i=new tt.e(t.name,e);i.parent=t;(0,ks.an)(t.name,{width:1,height:.8,depth:.5},e).parent=i;const r=Es(t.name,{height:.5,diameterTop:.8,diameterBottom:.8},e);r.parent=i,r.position.y=.3,r.position.x=-.6,r.rotation.x=.5*Math.PI;const s=Es(t.name,{height:.5,diameterTop:.6,diameterBottom:.6},e);s.parent=i,s.position.y=.5,s.position.x=.4,s.rotation.x=.5*Math.PI;const n=Es(t.name,{height:.5,diameterTop:.5,diameterBottom:.5},e);return n.parent=i,n.position.y=0,n.position.x=.6,n.rotation.z=.5*Math.PI,t.scaling.scaleInPlace(Gu._Scale),i.position.x=-.9,t}static _CreateCameraFrustum(e,t){const i=new tt.e("rootCameraGizmo",e),r=new tt.e(i.name,e);r.parent=i;for(let i=0;i<4;i+=2)for(let s=0;s<4;s+=2){let o=bn("lines",{points:[new n.Pq(-1+s,-1+i,-1),new n.Pq(-1+s,-1+i,1)],colors:[t,t]},e);o.parent=r,o.alwaysSelectAsActiveMesh=!0,o.isPickable=!1,o=bn("lines",{points:[new n.Pq(-1,-1+s,-1+i),new n.Pq(1,-1+s,-1+i)],colors:[t,t]},e),o.parent=r,o.alwaysSelectAsActiveMesh=!0,o.isPickable=!1,o=bn("lines",{points:[new n.Pq(-1+s,-1,-1+i),new n.Pq(-1+s,1,-1+i)],colors:[t,t]},e),o.parent=r,o.alwaysSelectAsActiveMesh=!0,o.isPickable=!1}return i}}Gu._Scale=.05;var zu=i(56526);class Uu extends cr.${set blurRatio(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())}get blurRatio(){return this._blurRatio}set adaptiveBlurKernel(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()}set blurKernel(e){this.blurKernelX=e,this.blurKernelY=e}set blurKernelX(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())}get blurKernelX(){return this._blurKernelX}set blurKernelY(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())}get blurKernelY(){return this._blurKernelY}_autoComputeBlurKernel(){const e=this.getScene().getEngine(),t=this.getRenderWidth()/e.getRenderWidth(),i=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*t,this.blurKernelY=this._adaptiveBlurKernel*i}_onRatioRescale(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()}_updateGammaSpace(){const e=this.getScene();e&&(this.gammaSpace=!e.imageProcessingConfiguration.isEnabled||!e.imageProcessingConfiguration.applyByPostProcess)}constructor(e,t,i,r,s=0,o=$e.g.BILINEAR_SAMPLINGMODE,a=!0){if(super(e,t,i,r,!0,s,!1,o,a),this.mirrorPlane=new Hr.Z(0,1,0,1),this._transformMatrix=n.uq.Zero(),this._mirrorMatrix=n.uq.Zero(),this._adaptiveBlurKernel=0,this._blurKernelX=0,this._blurKernelY=0,this._blurRatio=1,!(i=this.getScene()))return this;this.ignoreCameraViewport=!0,this._updateGammaSpace(),this._imageProcessingConfigChangeObserver=i.imageProcessingConfiguration.onUpdateParameters.add((()=>{this._updateGammaSpace()}));let l;i.getEngine().supportsUniformBuffers&&(this._sceneUBO=i.createSceneUniformBuffer(`Scene for Mirror Texture (name "${e}")`)),this.onBeforeRenderObservable.add((()=>{this._sceneUBO&&(this._currentSceneUBO=i.getSceneUniformBuffer(),i.setSceneUniformBuffer(this._sceneUBO),i.getSceneUniformBuffer().unbindEffect()),n.uq.ReflectionToRef(this.mirrorPlane,this._mirrorMatrix),this._mirrorMatrix.multiplyToRef(i.getViewMatrix(),this._transformMatrix),i.setTransformMatrix(this._transformMatrix,i.getProjectionMatrix()),l=i.clipPlane,i.clipPlane=this.mirrorPlane,i._mirroredCameraPosition=n.Pq.TransformCoordinates(i.activeCamera.globalPosition,this._mirrorMatrix)})),this.onAfterRenderObservable.add((()=>{this._sceneUBO&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(),i._mirroredCameraPosition=null,i.clipPlane=l}))}_preparePostProcesses(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){const e=this.getScene().getEngine(),t=e.getCaps().textureFloatRender&&e.getCaps().textureFloatLinearFiltering?1:2;this._blurX=new Ch("horizontal blur",new n.I9(1,0),this._blurKernelX,this._blurRatio,null,$e.g.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurX.autoClear=!1,1===this._blurRatio&&this.samples<2&&this._texture?this._blurX.inputTexture=this._renderTarget:this._blurX.alwaysForcePOT=!0,this._blurY=new Ch("vertical blur",new n.I9(0,1),this._blurKernelY,this._blurRatio,null,$e.g.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=1!==this._blurRatio,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new Uu(this.name,t.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;const e=super.serialize();return e.mirrorPlane=this.mirrorPlane.asArray(),e}dispose(){super.dispose();const e=this.getScene();e&&e.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver),this._sceneUBO?.dispose()}}$e.g._CreateMirror=(e,t,i,r)=>new Uu(e,t,i,r);var Wu=i(34294),Hu=i(79526),$u=i(10633);class qu extends Hu.M{constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.PROJECTED_GROUND=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}}class Yu extends Jr.E{get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}set reflectionStandardFresnelWeight(e){let t=e;t<.5?(t*=2,this.reflectionReflectance0=Yu.StandardReflectance0*t,this.reflectionReflectance90=Yu.StandardReflectance90*t):(t=2*t-1,this.reflectionReflectance0=Yu.StandardReflectance0+(1-Yu.StandardReflectance0)*t,this.reflectionReflectance90=Yu.StandardReflectance90+(1-Yu.StandardReflectance90)*t)}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsImageProcessingDirty()}))))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this.imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this.imageProcessingConfiguration.colorCurves=e}constructor(e,t,i=!1){super(e,t,void 0,i),this.primaryColor=o.v9.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=n.Pq.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this._fovMultiplier=1,this.useEquirectangularFOV=!1,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=!1,this.shadowOnly=!1,this._imageProcessingObserver=null,this.switchToBGR=!1,this._enableGroundProjection=!1,this.enableGroundProjection=!1,this.projectedGroundRadius=1e3,this.projectedGroundHeight=10,this._renderTargets=new Ss.L(16),this._reflectionControls=n.IU.Zero(),this._white=o.v9.White(),this._primaryShadowColor=o.v9.Black(),this._primaryHighlightColor=o.v9.Black(),this._shadersLoaded=!1,this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets)}get hasRenderTargetTextures(){return!(!this._diffuseTexture||!this._diffuseTexture.isRenderTarget)||!(!this._reflectionTexture||!this._reflectionTexture.isRenderTarget)}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,t,r=!1){const s=t._drawWrapper;if(s.effect&&this.isFrozen&&s._wasPreviouslyReady&&s._wasPreviouslyUsingInstances===r)return!0;t.materialDefines||(t.materialDefines=new qu);const n=this.getScene(),o=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const a=n.getEngine();if((0,ts.az)(n,e,o,!1,this._maxSimultaneousLights),o._needNormals=!0,(0,ts.VO)(n,o),o._areTexturesDirty){if(o._needUVs=!1,n.texturesEnabled){if(n.getEngine().getCaps().textureLOD&&(o.TEXTURELODSUPPORT=!0),this._diffuseTexture&&$u.h.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;(0,ts.YT)(this._diffuseTexture,o,"DIFFUSE"),o.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,o.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,o.OPACITYFRESNEL=this._opacityFresnel}else o.DIFFUSE=!1,o.DIFFUSEDIRECTUV=0,o.DIFFUSEHASALPHA=!1,o.GAMMADIFFUSE=!1,o.OPACITYFRESNEL=!1;const e=this._reflectionTexture;if(e&&$u.h.ReflectionTextureEnabled){if(!e.isReadyOrNotBlocking())return!1;switch(o.REFLECTION=!0,o.GAMMAREFLECTION=e.gammaSpace,o.RGBDREFLECTION=e.isRGBD,o.REFLECTIONBLUR=this._reflectionBlur>0,o.LODINREFLECTIONALPHA=e.lodLevelInAlpha,o.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,o.REFLECTIONBGR=this.switchToBGR,e.coordinatesMode===$e.g.INVCUBIC_MODE&&(o.INVERTCUBICMAP=!0),o.REFLECTIONMAP_3D=e.isCube,o.REFLECTIONMAP_OPPOSITEZ=o.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!e.invertZ:e.invertZ,e.coordinatesMode){case $e.g.EXPLICIT_MODE:o.REFLECTIONMAP_EXPLICIT=!0;break;case $e.g.PLANAR_MODE:o.REFLECTIONMAP_PLANAR=!0;break;case $e.g.PROJECTION_MODE:o.REFLECTIONMAP_PROJECTION=!0;break;case $e.g.SKYBOX_MODE:o.REFLECTIONMAP_SKYBOX=!0;break;case $e.g.SPHERICAL_MODE:o.REFLECTIONMAP_SPHERICAL=!0;break;case $e.g.EQUIRECTANGULAR_MODE:o.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case $e.g.FIXED_EQUIRECTANGULAR_MODE:o.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case $e.g.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:o.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case $e.g.CUBIC_MODE:case $e.g.INVCUBIC_MODE:default:o.REFLECTIONMAP_CUBIC=!0}this.reflectionFresnel?(o.REFLECTIONFRESNEL=!0,o.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(o.REFLECTIONFRESNEL=!1,o.REFLECTIONFALLOFF=!1)}else o.REFLECTION=!1,o.REFLECTIONFRESNEL=!1,o.REFLECTIONFALLOFF=!1,o.REFLECTIONBLUR=!1,o.REFLECTIONMAP_3D=!1,o.REFLECTIONMAP_SPHERICAL=!1,o.REFLECTIONMAP_PLANAR=!1,o.REFLECTIONMAP_CUBIC=!1,o.REFLECTIONMAP_PROJECTION=!1,o.REFLECTIONMAP_SKYBOX=!1,o.REFLECTIONMAP_EXPLICIT=!1,o.REFLECTIONMAP_EQUIRECTANGULAR=!1,o.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,o.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,o.INVERTCUBICMAP=!1,o.REFLECTIONMAP_OPPOSITEZ=!1,o.LODINREFLECTIONALPHA=!1,o.GAMMAREFLECTION=!1,o.RGBDREFLECTION=!1}o.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,o.USERGBCOLOR=this._useRGBColor,o.NOISE=this._enableNoise}if(o._areLightsDirty&&(o.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(0!==this._primaryColorShadowLevel||0!==this._primaryColorHighlightLevel),o.BACKMAT_SHADOWONLY=this._shadowOnly),o._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(o)}if(o._areMiscDirty&&(o.REFLECTIONMAP_3D&&this._enableGroundProjection?(o.PROJECTED_GROUND=!0,o.REFLECTIONMAP_SKYBOX=!0):o.PROJECTED_GROUND=!1),(0,ts.fm)(e,n,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),o),(0,ts.OR)(n,a,this,o,r,null,t.getRenderingMesh().hasThinInstances),(0,ts.qB)(e,o,!1,!0,!1)&&e&&(n.getEngine().getCaps().standardDerivatives||e.isVerticesDataPresent(Ot.R.NormalKind)||(e.createNormals(!0),m.V.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name))),o.isDirty){o.markAsProcessed(),n.resetCachedMaterial();const r=new Qr.J;o.FOG&&r.addFallback(0,"FOG"),o.POINTSIZE&&r.addFallback(1,"POINTSIZE"),o.MULTIVIEW&&r.addFallback(0,"MULTIVIEW"),(0,ts.c4)(o,r,this._maxSimultaneousLights);const s=[Ot.R.PositionKind];o.NORMAL&&s.push(Ot.R.NormalKind),o.UV1&&s.push(Ot.R.UVKind),o.UV2&&s.push(Ot.R.UV2Kind),(0,ts.ni)(s,e,o,r),(0,ts.ER)(s,o);const l=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix","projectedGroundInfos","logarithmicDepthConstant"];(0,es.TV)(l);const h=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],c=["Material","Scene"];Sr.p&&(Sr.p.PrepareUniforms(l,o),Sr.p.PrepareSamplers(h,o)),(0,ts.Bb)({uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:o,maxSimultaneousLights:this._maxSimultaneousLights});const u=o.toString(),d=n.getEngine().createEffect("background",{attributes:s,uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:u,fallbacks:r,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{1===this.shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,35616)),Promise.resolve().then(i.bind(i,92321))]):await Promise.all([Promise.resolve().then(i.bind(i,11114)),Promise.resolve().then(i.bind(i,58057))]),this._shadersLoaded=!0}},a);t.setEffect(d,o,this._materialContext),this.buildUniformLayout()}return!(!t.effect||!t.effect.isReady())&&(o._renderId=n.getRenderId(),s._wasPreviouslyReady=!0,s._wasPreviouslyUsingInstances=r,this._checkScenePerformancePriority(),!0)}_computePrimaryColorFromPerceptualColor(){this.__perceptualColor&&(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor,this.getScene().getEngine().useExactSrgbConversions),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())}_computePrimaryColors(){0===this._primaryColorShadowLevel&&0===this._primaryColorHighlightLevel||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.addUniform("projectedGroundInfos",2),this._uniformBuffer.create()}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindForSubMesh(e,t,i){const r=this.getScene(),s=i.materialDefines;if(!s)return;const n=i.effect;if(!n)return;this._activeEffect=n,this.bindOnlyWorldMatrix(e),(0,ts.f$)(t,this._activeEffect);const o=this._mustRebind(r,n,i,t.visibility);if(o){this._uniformBuffer.bindToEffect(n,"Material"),this.bindViewProjection(n);const e=this._reflectionTexture;this._uniformBuffer.useUbo&&this.isFrozen&&this._uniformBuffer.isSync&&!i._drawWrapper._forceRebindOnNextCall||(r.texturesEnabled&&(this._diffuseTexture&&$u.h.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),(0,ts.mA)(this._diffuseTexture,this._uniformBuffer,"diffuse")),e&&$u.h.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",e.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",e.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",e.getSize().width,e.lodGenerationScale,e.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),s.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),r.texturesEnabled&&(this._diffuseTexture&&$u.h.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),e&&$u.h.ReflectionTextureEnabled&&(s.REFLECTIONBLUR&&s.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",e):s.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",e._lodTextureMid||e),this._uniformBuffer.setTexture("reflectionSamplerLow",e._lodTextureLow||e),this._uniformBuffer.setTexture("reflectionSamplerHigh",e._lodTextureHigh||e)):this._uniformBuffer.setTexture("reflectionSampler",e),s.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w))),s.PROJECTED_GROUND&&this._uniformBuffer.updateFloat2("projectedGroundInfos",this.projectedGroundRadius,this.projectedGroundHeight)),(0,es.gS)(this._activeEffect,this,r),r.bindEyePosition(n)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(n,"Material"),this._needToBindSceneUbo=!0);!o&&this.isFrozen||(r.lightsEnabled&&(0,ts.RL)(r,t,this._activeEffect,s,this._maxSimultaneousLights),this.bindView(n),(0,ts.Yy)(r,t,this._activeEffect,!0),this._useLogarithmicDepth&&(0,ts.DL)(s,n,r),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,i),this._uniformBuffer.update()}hasTexture(e){return!!super.hasTexture(e)||(this._reflectionTexture===e||this._diffuseTexture===e)}dispose(e=!1,t=!1){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e)}clone(e){return Ue.p.Clone((()=>new Yu(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return"BackgroundMaterial"}static Parse(e,t,i){return Ue.p.Parse((()=>new Yu(e.name,t)),e,t,i)}}Yu.StandardReflectance0=.05,Yu.StandardReflectance90=.5,(0,Ge.Cg)([(0,ze.jT)()],Yu.prototype,"_primaryColor",void 0),(0,Ge.Cg)([(0,ze.$z)("_markAllSubMeshesAsLightsDirty")],Yu.prototype,"primaryColor",void 0),(0,Ge.Cg)([(0,ze.jT)()],Yu.prototype,"__perceptualColor",void 0),(0,Ge.Cg)([(0,ze.lK)()],Yu.prototype,"_primaryColorShadowLevel",void 0),(0,Ge.Cg)([(0,ze.lK)()],Yu.prototype,"_primaryColorHighlightLevel",void 0),(0,Ge.Cg)([(0,ze.$z)("_markAllSubMeshesAsLightsDirty")],Yu.prototype,"primaryColorHighlightLevel",null),(0,Ge.Cg)([(0,ze.uM)()],Yu.prototype,"_reflectionTexture",void 0),(0,Ge.Cg)([(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],Yu.prototype,"reflectionTexture",void 0),(0,Ge.Cg)([(0,ze.lK)()],Yu.prototype,"_reflectionBlur",void 0),(0,Ge.Cg)([(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],Yu.prototype,"reflectionBlur",void 0),(0,Ge.Cg)([(0,ze.uM)()],Yu.prototype,"_diffuseTexture",void 0),(0,Ge.Cg)([(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],Yu.prototype,"diffuseTexture",void 0),(0,Ge.Cg)([(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],Yu.prototype,"shadowLights",void 0),(0,Ge.Cg)([(0,ze.lK)()],Yu.prototype,"_shadowLevel",void 0),(0,Ge.Cg)([(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],Yu.prototype,"shadowLevel",void 0),(0,Ge.Cg)([(0,ze.P_)()],Yu.prototype,"_sceneCenter",void 0),(0,Ge.Cg)([(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],Yu.prototype,"sceneCenter",void 0),(0,Ge.Cg)([(0,ze.lK)()],Yu.prototype,"_opacityFresnel",void 0),(0,Ge.Cg)([(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],Yu.prototype,"opacityFresnel",void 0),(0,Ge.Cg)([(0,ze.lK)()],Yu.prototype,"_reflectionFresnel",void 0),(0,Ge.Cg)([(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],Yu.prototype,"reflectionFresnel",void 0),(0,Ge.Cg)([(0,ze.lK)()],Yu.prototype,"_reflectionFalloffDistance",void 0),(0,Ge.Cg)([(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],Yu.prototype,"reflectionFalloffDistance",void 0),(0,Ge.Cg)([(0,ze.lK)()],Yu.prototype,"_reflectionAmount",void 0),(0,Ge.Cg)([(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],Yu.prototype,"reflectionAmount",void 0),(0,Ge.Cg)([(0,ze.lK)()],Yu.prototype,"_reflectionReflectance0",void 0),(0,Ge.Cg)([(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],Yu.prototype,"reflectionReflectance0",void 0),(0,Ge.Cg)([(0,ze.lK)()],Yu.prototype,"_reflectionReflectance90",void 0),(0,Ge.Cg)([(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],Yu.prototype,"reflectionReflectance90",void 0),(0,Ge.Cg)([(0,ze.lK)()],Yu.prototype,"_useRGBColor",void 0),(0,Ge.Cg)([(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],Yu.prototype,"useRGBColor",void 0),(0,Ge.Cg)([(0,ze.lK)()],Yu.prototype,"_enableNoise",void 0),(0,Ge.Cg)([(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],Yu.prototype,"enableNoise",void 0),(0,Ge.Cg)([(0,ze.lK)()],Yu.prototype,"_maxSimultaneousLights",void 0),(0,Ge.Cg)([(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],Yu.prototype,"maxSimultaneousLights",void 0),(0,Ge.Cg)([(0,ze.lK)()],Yu.prototype,"_shadowOnly",void 0),(0,Ge.Cg)([(0,ze.$z)("_markAllSubMeshesAsLightsDirty")],Yu.prototype,"shadowOnly",void 0),(0,Ge.Cg)([(0,ze.n1)()],Yu.prototype,"_imageProcessingConfiguration",void 0),(0,Ge.Cg)([(0,ze.lK)(),(0,ze.$z)("_markAllSubMeshesAsMiscDirty")],Yu.prototype,"enableGroundProjection",void 0),(0,Ge.Cg)([(0,ze.lK)()],Yu.prototype,"projectedGroundRadius",void 0),(0,Ge.Cg)([(0,ze.lK)()],Yu.prototype,"projectedGroundHeight",void 0),(0,a.Y5)("BABYLON.BackgroundMaterial",Yu);class Xu{static _GetDefaultOptions(e){return{createGround:!0,groundSize:15,groundTexture:H.S0.GetAssetUrl(this._GroundTextureCDNUrl),groundColor:new o.v9(.2,.2,.3).toLinearSpace(e.getEngine().useExactSrgbConversions).scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:H.S0.GetAssetUrl(this._SkyboxTextureCDNUrl),skyboxColor:new o.v9(.2,.2,.3).toLinearSpace(e.getEngine().useExactSrgbConversions).scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:n.Pq.Zero(),setupImageProcessing:!0,environmentTexture:H.S0.GetAssetUrl(this._EnvironmentTextureCDNUrl),cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}}get rootMesh(){return this._rootMesh}get skybox(){return this._skybox}get skyboxTexture(){return this._skyboxTexture}get skyboxMaterial(){return this._skyboxMaterial}get ground(){return this._ground}get groundTexture(){return this._groundTexture}get groundMirror(){return this._groundMirror}get groundMirrorRenderList(){return this._groundMirror?this._groundMirror.renderList:null}get groundMaterial(){return this._groundMaterial}constructor(e,t){this._errorHandler=(e,t)=>{this.onErrorObservable.notifyObservers({message:e,exception:t})},this._options={...Xu._GetDefaultOptions(t),...e},this._scene=t,this.onErrorObservable=new s.cP,this._setupBackground(),this._setupImageProcessing()}updateOptions(e){const t={...this._options,...e};this._ground&&!t.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!t.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=t.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!t.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!t.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=t.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!t.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=t.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=t,this._setupBackground(),this._setupImageProcessing()}setMainColor(e){this.groundMaterial&&(this.groundMaterial.primaryColor=e),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=e),this.groundMirror&&(this.groundMirror.clearColor=new o.ov(e.r,e.g,e.b,1))}_setupImageProcessing(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())}_setupEnvironmentTexture(){if(this._scene.environmentTexture)return;if(this._options.environmentTexture instanceof zu.t)return void(this._scene.environmentTexture=this._options.environmentTexture);const e=Wu.CubeTexture.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=e}_setupBackground(){this._rootMesh||(this._rootMesh=new tt.e("BackgroundHelper",this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;const e=this._getSceneSize();this._options.createGround&&(this._setupGround(e),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(e),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(e),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=e.rootPosition.x,this._rootMesh.position.z=e.rootPosition.z,this._rootMesh.position.y=e.rootPosition.y}_getSceneSize(){let e=this._options.groundSize,t=this._options.skyboxSize,i=this._options.rootPosition;if(!this._scene.meshes||1===this._scene.meshes.length)return{groundSize:e,skyboxSize:t,rootPosition:i};const r=this._scene.getWorldExtends((e=>e!==this._ground&&e!==this._rootMesh&&e!==this._skybox)),s=r.max.subtract(r.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof fi.Lq&&this._scene.activeCamera.upperRadiusLimit&&(e=2*this._scene.activeCamera.upperRadiusLimit,t=e);const n=s.length();n>e&&(e=2*n,t=e),e*=1.1,t*=1.5,i=r.min.add(s.scale(.5)),i.y=r.min.y-this._options.groundYBias}return{groundSize:e,skyboxSize:t,rootPosition:i}}_setupGround(e){this._ground&&!this._ground.isDisposed()||(this._ground=ht("BackgroundPlane",{size:e.groundSize},this._scene),this._ground.rotation.x=Math.PI/2,this._ground.isPickable=!1,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add((()=>{this._ground=null}))),this._ground.receiveShadows=this._options.enableGroundShadow}_setupGroundMaterial(){this._groundMaterial||(this._groundMaterial=new Yu("BackgroundPlaneMaterial",this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=8,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)}_setupGroundDiffuseTexture(){this._groundMaterial&&(this._groundTexture||(this._options.groundTexture instanceof zu.t?this._groundMaterial.diffuseTexture=this._options.groundTexture:(this._groundTexture=new $e.g(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._groundTexture.gammaSpace=!1,this._groundTexture.hasAlpha=!0,this._groundMaterial.diffuseTexture=this._groundTexture)))}_setupGroundMirrorTexture(e){const t=$e.g.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new Uu("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,$e.g.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new Hr.Z(0,-1,0,e.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=t,this._groundMirror.wrapV=t,this._groundMirror.renderList))for(let e=0;e<this._scene.meshes.length;e++){const t=this._scene.meshes[e];t!==this._ground&&t!==this._skybox&&t!==this._rootMesh&&this._groundMirror.renderList.push(t)}const i=this._options.groundColor.toGammaSpace(this._scene.getEngine().useExactSrgbConversions);this._groundMirror.clearColor=new o.ov(i.r,i.g,i.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel}_setupMirrorInGroundMaterial(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)}_setupSkybox(e){this._skybox&&!this._skybox.isDisposed()||(this._skybox=(0,ks.an)("BackgroundSkybox",{size:e.skyboxSize,sideOrientation:tt.e.BACKSIDE},this._scene),this._skybox.isPickable=!1,this._skybox.onDisposeObservable.add((()=>{this._skybox=null}))),this._skybox.parent=this._rootMesh}_setupSkyboxMaterial(){this._skybox&&(this._skyboxMaterial||(this._skyboxMaterial=new Yu("BackgroundSkyboxMaterial",this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)}_setupSkyboxReflectionTexture(){this._skyboxMaterial&&(this._skyboxTexture||(this._options.skyboxTexture instanceof zu.t?this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture:(this._skyboxTexture=new Wu.CubeTexture(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=$e.g.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture)))}dispose(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)}}Xu._GroundTextureCDNUrl="https://assets.babylonjs.com/core/environments/backgroundGround.png",Xu._SkyboxTextureCDNUrl="https://assets.babylonjs.com/core/environments/backgroundSkybox.dds",Xu._EnvironmentTextureCDNUrl="https://assets.babylonjs.com/core/environments/environmentSpecular.env";class ju extends mt.V{get texture(){return this._texture}set texture(e){this._texture!==e&&(this._texture=e,this._useDirectMapping?(this._texture.wrapU=$e.g.CLAMP_ADDRESSMODE,this._texture.wrapV=$e.g.CLAMP_ADDRESSMODE,this._material.diffuseTexture=this._texture):(this._texture.coordinatesMode=$e.g.FIXED_EQUIRECTANGULAR_MIRRORED_MODE,this._texture.wrapV=$e.g.CLAMP_ADDRESSMODE,this._material.reflectionTexture=this._texture),this._changeTextureMode(this._textureMode))}get mesh(){return this._mesh}get fovMultiplier(){return this._material.fovMultiplier}set fovMultiplier(e){this._material.fovMultiplier=e}get textureMode(){return this._textureMode}set textureMode(e){this._textureMode!==e&&this._changeTextureMode(e)}get halfDome(){return this._halfDome}set halfDome(e){this._halfDome=e,this._halfDomeMask.setEnabled(e),this._changeTextureMode(this._textureMode)}set crossEye(e){this._crossEye=e,this._changeTextureMode(this._textureMode)}get crossEye(){return this._crossEye}get material(){return this._material}constructor(e,t,i,r,o=null){super(e,r),this.onError=o,this._halfDome=!1,this._crossEye=!1,this._useDirectMapping=!1,this._textureMode=ju.MODE_MONOSCOPIC,this._onBeforeCameraRenderObserver=null,this.onLoadErrorObservable=new s.cP,this.onLoadObservable=new s.cP,r=this.getScene(),e=e||"textureDome",i.resolution=0|Math.abs(i.resolution)||32,i.clickToPlay=Boolean(i.clickToPlay),i.autoPlay=void 0===i.autoPlay||Boolean(i.autoPlay),i.loop=void 0===i.loop||Boolean(i.loop),i.size=Math.abs(i.size)||(r.activeCamera?.48*r.activeCamera.maxZ:1e3),void 0===i.useDirectMapping?this._useDirectMapping=!0:this._useDirectMapping=i.useDirectMapping,void 0===i.faceForward&&(i.faceForward=!0),this._setReady(!1),i.mesh?this._mesh=i.mesh:this._mesh=zs(e+"_mesh",{segments:i.resolution,diameter:i.size,updatable:!1,sideOrientation:tt.e.BACKSIDE},r);const a=this._material=new Yu(e+"_material",r);a.useEquirectangularFOV=!0,a.fovMultiplier=1,a.opacityFresnel=!1;const l=this._initTexture(t,r,i);if(this.texture=l,this._mesh.material=a,this._mesh.parent=this,this._halfDomeMask=zs("",{slice:.5,diameter:.98*i.size,segments:2*i.resolution,sideOrientation:tt.e.BACKSIDE},r),this._halfDomeMask.rotate(ku._0.X,-Math.PI/2),this._halfDomeMask.parent=this._mesh,this._halfDome=!!i.halfDomeMode,this._halfDomeMask.setEnabled(this._halfDome),this._crossEye=!!i.crossEyeMode,this._texture.anisotropicFilteringLevel=1,this._texture.onLoadObservable.addOnce((()=>{this._setReady(!0)})),i.faceForward&&r.activeCamera){const e=r.activeCamera,t=n.Pq.Forward(),i=n.Pq.TransformNormal(t,e.getViewMatrix());i.normalize(),this.rotation.y=Math.acos(n.Pq.Dot(t,i))}this._changeTextureMode(this._textureMode)}_changeTextureMode(e){switch(this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._textureMode=e,this._texture.uScale=1,this._texture.vScale=1,this._texture.uOffset=0,this._texture.vOffset=0,this._texture.vAng=0,e){case ju.MODE_MONOSCOPIC:this._halfDome&&(this._texture.uScale=2,this._texture.uOffset=-1);break;case ju.MODE_SIDEBYSIDE:{this._texture.uScale=this._halfDome?.99999:.5;const e=this._halfDome?0:.5,t=this._halfDome?-.5:0;this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add((i=>{let r=i.isRightCamera;this._crossEye&&(r=!r),this._texture.uOffset=r?e:t}));break}case ju.MODE_TOPBOTTOM:this._texture.vScale=this._halfDome?.99999:.5,this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add((e=>{let t=e.isRightCamera;this._crossEye&&(t=!t),this._texture.vOffset=t?.5:0}))}}dispose(e,t=!1){this._texture.dispose(),this._mesh.dispose(),this._material.dispose(),this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this.onLoadErrorObservable.clear(),this.onLoadObservable.clear(),super.dispose(e,t)}}ju.MODE_MONOSCOPIC=0,ju.MODE_TOPBOTTOM=1,ju.MODE_SIDEBYSIDE=2;class Zu extends ju{get photoTexture(){return this.texture}set photoTexture(e){this.texture=e}get imageMode(){return this.textureMode}set imageMode(e){this.textureMode=e}_initTexture(e,t,i){return new $e.g(e,t,!i.generateMipMaps,!this._useDirectMapping,void 0,(()=>{this.onLoadObservable.notifyObservers()}),((e,t)=>{this.onLoadErrorObservable.notifyObservers(e||"Unknown error occured"),this.onError&&this.onError(e,t)}))}}Zu.MODE_MONOSCOPIC=ju.MODE_MONOSCOPIC,Zu.MODE_TOPBOTTOM=ju.MODE_TOPBOTTOM,Zu.MODE_SIDEBYSIDE=ju.MODE_SIDEBYSIDE;var Qu=i(23975),Ku=i(50994),Ju=i(17136),ed=i(29158);class td extends di.S{constructor(e,t,i){super(e,n.Pq.Zero(),t),this._xrSessionManager=i,this._firstFrame=!1,this._referenceQuaternion=n.PT.Identity(),this._referencedPosition=new n.Pq,this._trackingState=0,this.onXRCameraInitializedObservable=new s.cP,this.onBeforeCameraTeleport=new s.cP,this.onAfterCameraTeleport=new s.cP,this.onTrackingStateChanged=new s.cP,this.compensateOnFirstFrame=!0,this._rotate180=new n.PT(0,1,0,0),this.minZ=.1,this.rotationQuaternion=new n.PT,this.cameraRigMode=ft.i.RIG_MODE_CUSTOM,this.updateUpVectorFromRotation=!0,this._updateNumberOfRigCameras(1),this.freezeProjectionMatrix(),this._deferOnly=!0,this._xrSessionManager.onXRSessionInit.add((()=>{this._referencedPosition.copyFromFloats(0,0,0),this._referenceQuaternion.copyFromFloats(0,0,0,1),this._firstFrame=this.compensateOnFirstFrame,this._xrSessionManager.onWorldScaleFactorChangedObservable.add((()=>{this._xrSessionManager.currentFrame&&this._updateDepthNearFar()}))})),this._xrSessionManager.onXRFrameObservable.add((()=>{this._firstFrame&&this._updateFromXRSession(),this.onXRCameraInitializedObservable.hasObservers()&&(this.onXRCameraInitializedObservable.notifyObservers(this),this.onXRCameraInitializedObservable.clear()),this._deferredUpdated&&(this.position.copyFrom(this._deferredPositionUpdate),this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate)),this._updateReferenceSpace(),this._updateFromXRSession()}),void 0,!0)}get trackingState(){return this._trackingState}_setTrackingState(e){this._trackingState!==e&&(this._trackingState=e,this.onTrackingStateChanged.notifyObservers(e))}get realWorldHeight(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.baseReferenceSpace);return e&&e.transform?e.transform.position.y*this._xrSessionManager.worldScalingFactor:0}_updateForDualEyeDebugging(){this._updateNumberOfRigCameras(2),this.rigCameras[0].viewport=new $i.L(0,0,.5,1),this.rigCameras[0].outputRenderTarget=null,this.rigCameras[1].viewport=new $i.L(.5,0,.5,1),this.rigCameras[1].outputRenderTarget=null}setTransformationFromNonVRCamera(e=this.getScene().activeCamera,t=!0){if(!e||e===this)return;e.computeWorldMatrix().decompose(void 0,this.rotationQuaternion,this.position),this.position.y=0,n.PT.FromEulerAnglesToRef(0,this.rotationQuaternion.toEulerAngles().y,0,this.rotationQuaternion),this._firstFrame=!0,t&&this._xrSessionManager.resetReferenceSpace()}getClassName(){return"WebXRCamera"}setTarget(e){const t=n.AA.Vector3[1];e.subtractToRef(this.position,t),t.y=0,t.normalize();const i=Math.atan2(t.x,t.z);this.rotationQuaternion.toEulerAnglesToRef(t),n.PT.FromEulerAnglesToRef(t.x,i,t.z,this.rotationQuaternion)}dispose(){super.dispose(),this._lastXRViewerPose=void 0,this.onTrackingStateChanged.clear()}_updateDepthNearFar(){const e=(this.maxZ||1e4)*this._xrSessionManager.worldScalingFactor,t={depthFar:e,depthNear:this.minZ};this._xrSessionManager.updateRenderState(t),this._cache.minZ=this.minZ,this._cache.maxZ=e}_updateFromXRSession(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.referenceSpace);if(this._lastXRViewerPose=e||void 0,!e)return void this._setTrackingState(0);const t=e.emulatedPosition?1:2;if(this._setTrackingState(t),this.minZ===this._cache.minZ&&this.maxZ===this._cache.maxZ||this._updateDepthNearFar(),e.transform){const t=e.transform.orientation;if(void 0===e.transform.orientation.x)return;const i=e.transform.position;this._referencedPosition.set(i.x,i.y,i.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),this._referenceQuaternion.set(t.x,t.y,t.z,t.w),this._scene.useRightHandedSystem?this._referenceQuaternion.multiplyInPlace(this._rotate180):(this._referencedPosition.z*=-1,this._referenceQuaternion.z*=-1,this._referenceQuaternion.w*=-1),this._firstFrame?(this._firstFrame=!1,this.position.y+=this._referencedPosition.y,this._referenceQuaternion.copyFromFloats(0,0,0,1)):(this.rotationQuaternion.copyFrom(this._referenceQuaternion),this.position.copyFrom(this._referencedPosition))}this.rigCameras.length!==e.views.length&&this._updateNumberOfRigCameras(e.views.length),e.views.forEach(((e,t)=>{const i=this.rigCameras[t];i.isLeftCamera||i.isRightCamera||("right"===e.eye?i._isRightCamera=!0:"left"===e.eye&&(i._isLeftCamera=!0));const r=this.getScene().customRenderTargets;for(let e=0;e<r.length;e++){const t=r[e];-1===i.customRenderTargets.indexOf(t)&&i.customRenderTargets.push(t)}const s=e.transform.position,o=e.transform.orientation;i.parent=this.parent,i.position.set(s.x,s.y,s.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),i.rotationQuaternion.set(o.x,o.y,o.z,o.w),this._scene.useRightHandedSystem?i.rotationQuaternion.multiplyInPlace(this._rotate180):(i.position.z*=-1,i.rotationQuaternion.z*=-1,i.rotationQuaternion.w*=-1),n.uq.FromFloat32ArrayToRefScaled(e.projectionMatrix,0,1,i._projectionMatrix),this._scene.useRightHandedSystem||i._projectionMatrix.toggleProjectionMatrixHandInPlace();const a=2*Math.atan2(1,e.projectionMatrix[5]);i.fov=a,0===t&&(this.fov=a,this._projectionMatrix.copyFrom(i._projectionMatrix));const l=this._xrSessionManager.getRenderTargetTextureForView(e);this._renderingMultiview=l?._texture?.isMultiview||!1,this._renderingMultiview?0==t&&(this._xrSessionManager.trySetViewportForView(this.viewport,e),this.outputRenderTarget=l):(this._xrSessionManager.trySetViewportForView(i.viewport,e),i.outputRenderTarget=l||this._xrSessionManager.getRenderTargetTextureForView(e)),i.layerMask=this.layerMask}))}_updateNumberOfRigCameras(e=1){for(;this.rigCameras.length<e;){const e=new ui.F("XR-RigCamera: "+this.rigCameras.length,n.Pq.Zero(),this.getScene());e.minZ=.1,e.rotationQuaternion=new n.PT,e.updateUpVectorFromRotation=!0,e.isRigCamera=!0,e.rigParent=this,e.freezeProjectionMatrix(),this.rigCameras.push(e)}for(;this.rigCameras.length>e;){const e=this.rigCameras.pop();e&&e.dispose()}}_updateReferenceSpace(){if(!this.position.equals(this._referencedPosition)||!this.rotationQuaternion.equals(this._referenceQuaternion)){const e=n.AA.Matrix[0],t=n.AA.Matrix[1],i=n.AA.Matrix[2];n.uq.ComposeToRef(td._ScaleReadOnly,this._referenceQuaternion,this._referencedPosition,e),n.uq.ComposeToRef(td._ScaleReadOnly,this.rotationQuaternion,this.position,t),e.invert().multiplyToRef(t,i),i.invert(),this._scene.useRightHandedSystem||i.toggleModelMatrixHandInPlace(),i.decompose(void 0,this._referenceQuaternion,this._referencedPosition);const r=new XRRigidTransform({x:this._referencedPosition.x/this._xrSessionManager.worldScalingFactor,y:this._referencedPosition.y/this._xrSessionManager.worldScalingFactor,z:this._referencedPosition.z/this._xrSessionManager.worldScalingFactor},{x:this._referenceQuaternion.x,y:this._referenceQuaternion.y,z:this._referenceQuaternion.z,w:this._referenceQuaternion.w});this._xrSessionManager.referenceSpace=this._xrSessionManager.referenceSpace.getOffsetReferenceSpace(r)}}}td._ScaleReadOnly=n.Pq.One();class id{constructor(e){this._scene=e,this._nonVRCamera=null,this._attachedToElement=!1,this._spectatorCamera=null,this._originalSceneAutoClear=!0,this._supported=!1,this._spectatorMode=!1,this._lastTimestamp=0,this.onInitialXRPoseSetObservable=new s.cP,this.onStateChangedObservable=new s.cP,this.state=3,this.sessionManager=new Fr(e),this.camera=new td("webxr",e,this.sessionManager),this.featuresManager=new Ct(this.sessionManager),e.onDisposeObservable.addOnce((()=>{this.dispose()}))}static CreateAsync(e){const t=new id(e);return t.sessionManager.initializeAsync().then((()=>(t._supported=!0,t))).catch((e=>{throw t._setState(3),t.dispose(),e}))}dispose(){this.exitXRAsync(),this.camera.dispose(),this.onStateChangedObservable.clear(),this.onInitialXRPoseSetObservable.clear(),this.sessionManager.dispose(),this._spectatorCamera?.dispose(),this._nonVRCamera&&(this._scene.activeCamera=this._nonVRCamera)}async enterXRAsync(e,t,i=this.sessionManager.getWebXRRenderTarget(),r={}){if(!this._supported)throw"WebXR not supported in this browser or environment";this._setState(0),"viewer"!==t&&"local"!==t&&(r.optionalFeatures=r.optionalFeatures||[],r.optionalFeatures.push(t)),r=await this.featuresManager._extendXRSessionInitObject(r),"immersive-ar"===e&&"unbounded"!==t&&m.V.Warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode");try{await this.sessionManager.initializeSessionAsync(e,r),await this.sessionManager.setReferenceSpaceTypeAsync(t);const s={depthFar:this.camera.maxZ||1e4,depthNear:this.camera.minZ};if(!this.featuresManager.getEnabledFeature(Tt.LAYERS)){const e=await i.initializeXRLayerAsync(this.sessionManager.session);s.baseLayer=e}return this.sessionManager.updateRenderState(s),this.sessionManager.runXRRenderLoop(),this._originalSceneAutoClear=this._scene.autoClear,this._nonVRCamera=this._scene.activeCamera,this._attachedToElement=!!this._nonVRCamera?.inputs?.attachedToElement,this._nonVRCamera?.detachControl(),this._scene.activeCamera=this.camera,"immersive-ar"!==e?this._nonXRToXRCamera():(this._scene.autoClear=!1,this.camera.compensateOnFirstFrame=!1,this.camera.position.set(0,0,0),this.camera.rotationQuaternion.set(0,0,0,1),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)),$.$.audioEngine?._resumeAudioContextOnStateChange(),this.sessionManager.onXRSessionEnded.addOnce((()=>{1!==this.state&&this._setState(1),this.camera.rigCameras.forEach((e=>{e.outputRenderTarget=null})),this._scene.autoClear=this._originalSceneAutoClear,this._scene.activeCamera=this._nonVRCamera,this._attachedToElement&&this._nonVRCamera&&this._nonVRCamera.attachControl(!!this._nonVRCamera.inputs.noPreventDefault),"immersive-ar"!==e&&this.camera.compensateOnFirstFrame&&(this._nonVRCamera.setPosition?this._nonVRCamera.setPosition(this.camera.position):this._nonVRCamera.position.copyFrom(this.camera.position)),this._setState(3)})),this.sessionManager.onXRFrameObservable.addOnce((()=>{this._setState(2)})),this.sessionManager}catch(e){throw m.V.Log(e),m.V.Log(e.message),this._setState(3),e}}exitXRAsync(){return 2!==this.state?Promise.resolve():(this._setState(1),this.sessionManager.exitXRAsync())}enableSpectatorMode(e){this._spectatorMode||(this._spectatorMode=!0,this._switchSpectatorMode(e))}disableSpecatatorMode(){this._spectatorMode&&(this._spectatorMode=!1,this._switchSpectatorMode())}_switchSpectatorMode(e){const t=1/(e?.fps?e.fps:1e3)*1e3,i=e?.preferredCameraIndex?e?.preferredCameraIndex:0,r=()=>{if(this._spectatorCamera){this.sessionManager.currentTimestamp-this._lastTimestamp>=t&&(this._lastTimestamp=this.sessionManager.currentTimestamp,this._spectatorCamera.position.copyFrom(this.camera.rigCameras[i].globalPosition),this._spectatorCamera.rotationQuaternion.copyFrom(this.camera.rigCameras[i].absoluteRotation))}};if(this._spectatorMode){if(i>=this.camera.rigCameras.length)throw new Error("the preferred camera index is beyond the length of rig camera array.");const e=()=>{2===this.state?(this._spectatorCamera=new Oi("webxr-spectator",n.Pq.Zero(),this._scene),this._spectatorCamera.rotationQuaternion=new n.PT,this._scene.activeCameras=[this.camera,this._spectatorCamera],this.sessionManager.onXRFrameObservable.add(r),this._scene.onAfterRenderCameraObservable.add((e=>{e===this.camera&&(this._scene.getEngine().framebufferDimensionsObject=null)}))):1===this.state&&(this.sessionManager.onXRFrameObservable.removeCallback(r),this._scene.activeCameras=null)};this.onStateChangedObservable.add(e),e()}else this.sessionManager.onXRFrameObservable.removeCallback(r),this._scene.activeCameras=[this.camera]}_nonXRToXRCamera(){this.camera.setTransformationFromNonVRCamera(this._nonVRCamera),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)}_setState(e){this.state!==e&&(this.state=e,this.onStateChangedObservable.notifyObservers(this.state))}}class rd{constructor(e,t,i=-1,r=[]){this.id=e,this.type=t,this._buttonIndex=i,this._axesIndices=r,this._axes={x:0,y:0},this._changes={},this._currentValue=0,this._hasChanges=!1,this._pressed=!1,this._touched=!1,this.onAxisValueChangedObservable=new s.cP,this.onButtonStateChangedObservable=new s.cP}get axes(){return this._axes}get changes(){return this._changes}get hasChanges(){return this._hasChanges}get pressed(){return this._pressed}get touched(){return this._touched}get value(){return this._currentValue}dispose(){this.onAxisValueChangedObservable.clear(),this.onButtonStateChangedObservable.clear()}isAxes(){return 0!==this._axesIndices.length}isButton(){return-1!==this._buttonIndex}update(e){let t=!1,i=!1;if(this._hasChanges=!1,this._changes={},this.isButton()){const i=e.buttons[this._buttonIndex];if(!i)return;this._currentValue!==i.value&&(this.changes.value={current:i.value,previous:this._currentValue},t=!0,this._currentValue=i.value),this._touched!==i.touched&&(this.changes.touched={current:i.touched,previous:this._touched},t=!0,this._touched=i.touched),this._pressed!==i.pressed&&(this.changes.pressed={current:i.pressed,previous:this._pressed},t=!0,this._pressed=i.pressed)}this.isAxes()&&(this._axes.x!==e.axes[this._axesIndices[0]]&&(this.changes.axes={current:{x:e.axes[this._axesIndices[0]],y:this._axes.y},previous:{x:this._axes.x,y:this._axes.y}},this._axes.x=e.axes[this._axesIndices[0]],i=!0),this._axes.y!==e.axes[this._axesIndices[1]]&&(this.changes.axes?this.changes.axes.current.y=e.axes[this._axesIndices[1]]:this.changes.axes={current:{x:this._axes.x,y:e.axes[this._axesIndices[1]]},previous:{x:this._axes.x,y:this._axes.y}},this._axes.y=e.axes[this._axesIndices[1]],i=!0)),t&&(this._hasChanges=!0,this.onButtonStateChangedObservable.notifyObservers(this)),i&&(this._hasChanges=!0,this.onAxisValueChangedObservable.notifyObservers(this._axes))}}rd.BUTTON_TYPE="button",rd.SQUEEZE_TYPE="squeeze",rd.THUMBSTICK_TYPE="thumbstick",rd.TOUCHPAD_TYPE="touchpad",rd.TRIGGER_TYPE="trigger";var sd=i(15909);class nd{constructor(e,t,i,r,n=!1,o){this.scene=e,this.layout=t,this.gamepadObject=i,this.handedness=r,this._doNotLoadControllerMesh=n,this._controllerCache=o,this._initComponent=e=>{if(!e)return;const t=this.layout.components[e],i=t.type,r=t.gamepadIndices.button,s=[];void 0!==t.gamepadIndices.xAxis&&void 0!==t.gamepadIndices.yAxis&&s.push(t.gamepadIndices.xAxis,t.gamepadIndices.yAxis),this.components[e]=new rd(e,i,r,s)},this._modelReady=!1,this.components={},this.disableAnimation=!1,this.onModelLoadedObservable=new s.cP,t.components&&Object.keys(t.components).forEach(this._initComponent)}dispose(){this.getComponentIds().forEach((e=>this.getComponent(e).dispose())),this.rootMesh&&(this.rootMesh.getChildren(void 0,!0).forEach((e=>{e.setEnabled(!1)})),this.rootMesh.dispose(!!this._controllerCache,!this._controllerCache)),this.onModelLoadedObservable.clear()}getAllComponentsOfType(e){return this.getComponentIds().map((e=>this.components[e])).filter((t=>t.type===e))}getComponent(e){return this.components[e]}getComponentIds(){return Object.keys(this.components)}getComponentOfType(e){return this.getAllComponentsOfType(e)[0]||null}getMainComponent(){return this.getComponent(this.layout.selectComponentId)}async loadModel(){const e=!this._getModelLoadingConstraints();let t=this._getGenericFilenameAndPath();return e?m.V.Warn("Falling back to generic models"):t=this._getFilenameAndPath(),new Promise(((i,r)=>{const s=t=>{e?this._getGenericParentMesh(t):this._setRootMesh(t),this._processLoadedModel(t),this._modelReady=!0,this.onModelLoadedObservable.notifyObservers(this),i(!0)};if(this._controllerCache){const e=this._controllerCache.filter((e=>e.filename===t.filename&&e.path===t.path));if(e[0])return e[0].meshes.forEach((e=>e.setEnabled(!0))),void s(e[0].meshes)}sd.cn.ImportMesh("",t.path,t.filename,this.scene,(e=>{this._controllerCache&&this._controllerCache.push({...t,meshes:e}),s(e)}),null,((e,i)=>{m.V.Log(i),m.V.Warn(`Failed to retrieve controller model of type ${this.profileId} from the remote server: ${t.path}${t.filename}`),r(i)}))}))}updateFromXRFrame(e){this.getComponentIds().forEach((e=>this.getComponent(e).update(this.gamepadObject))),this.updateModel(e)}get handness(){return this.handedness}pulse(e,t,i=0){return this.gamepadObject.hapticActuators&&this.gamepadObject.hapticActuators[i]?this.gamepadObject.hapticActuators[i].pulse(e,t):Promise.resolve(!1)}_getChildByName(e,t){return e.getChildren((e=>e.name===t),!1)[0]}_getImmediateChildByName(e,t){return e.getChildren((e=>e.name==t),!0)[0]}_lerpTransform(e,t,i){if(!e.minMesh||!e.maxMesh||!e.valueMesh)return;if(!e.minMesh.rotationQuaternion||!e.maxMesh.rotationQuaternion||!e.valueMesh.rotationQuaternion)return;const r=i?.5*t+.5:t;n.PT.SlerpToRef(e.minMesh.rotationQuaternion,e.maxMesh.rotationQuaternion,r,e.valueMesh.rotationQuaternion),n.Pq.LerpToRef(e.minMesh.position,e.maxMesh.position,r,e.valueMesh.position)}updateModel(e){this._modelReady&&this._updateModel(e)}_getGenericFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getGenericParentMesh(e){this.rootMesh=new tt.e(this.profileId+" "+this.handedness,this.scene),e.forEach((e=>{e.parent||(e.isPickable=!1,e.setParent(this.rootMesh))})),this.rootMesh.rotationQuaternion=n.PT.FromEulerAngles(0,Math.PI,0)}}class od extends nd{constructor(e,t,i){super(e,ad[i],t,i),this.profileId=od.ProfileId}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){this.rootMesh=new tt.e(this.profileId+" "+this.handedness,this.scene),e.forEach((e=>{e.isPickable=!1,e.parent||e.setParent(this.rootMesh)})),this.rootMesh.rotationQuaternion=n.PT.FromEulerAngles(0,Math.PI,0)}_updateModel(){}}od.ProfileId="generic-trigger";const ad={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-none",assetPath:"none.glb"}};class ld extends nd{constructor(e,t,i,r,s){super(e,i.layouts[t.handedness||"none"],t.gamepad,t.handedness,void 0,s),this._repositoryUrl=r,this.controllerCache=s,this._buttonMeshMapping={},this._touchDots={},this.profileId=i.profileId}dispose(){super.dispose(),this.controllerCache||Object.keys(this._touchDots).forEach((e=>{this._touchDots[e].dispose()}))}_getFilenameAndPath(){return{filename:this.layout.assetPath,path:`${this._repositoryUrl}/profiles/${this.profileId}/`}}_getModelLoadingConstraints(){const e=sd.cn.IsPluginForExtensionAvailable(".glb");return e||m.V.Warn("glTF / glb loader was not registered, using generic controller instead"),e}_processLoadedModel(e){this.getComponentIds().forEach((e=>{const t=this.layout.components[e];this._buttonMeshMapping[e]={mainMesh:this._getChildByName(this.rootMesh,t.rootNodeName),states:{}},Object.keys(t.visualResponses).forEach((i=>{const r=t.visualResponses[i];if("transform"===r.valueNodeProperty)this._buttonMeshMapping[e].states[i]={valueMesh:this._getChildByName(this.rootMesh,r.valueNodeName),minMesh:this._getChildByName(this.rootMesh,r.minNodeName),maxMesh:this._getChildByName(this.rootMesh,r.maxNodeName)};else{const s=t.type===rd.TOUCHPAD_TYPE&&t.touchPointNodeName?t.touchPointNodeName:r.valueNodeName;if(this._buttonMeshMapping[e].states[i]={valueMesh:this._getChildByName(this.rootMesh,s)},t.type===rd.TOUCHPAD_TYPE&&!this._touchDots[i]){const t=zs(i+"dot",{diameter:.0015,segments:8},this.scene);t.material=new br.F(i+"mat",this.scene),t.material.diffuseColor=o.v9.Red(),t.parent=this._buttonMeshMapping[e].states[i].valueMesh||null,t.isVisible=!1,this._touchDots[i]=t}}}))}))}_setRootMesh(e){let t;this.rootMesh=new tt.e(this.profileId+"-"+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(let i=0;i<e.length;i++){const r=e[i];r.isPickable=!1,r.parent||(t=r)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||this.rootMesh.rotate(Mt._0.Y,Math.PI,1)}_updateModel(e){this.disableAnimation||this.getComponentIds().forEach((e=>{const t=this.getComponent(e);if(!t.hasChanges)return;const i=this._buttonMeshMapping[e],r=this.layout.components[e];Object.keys(r.visualResponses).forEach((e=>{const s=r.visualResponses[e];let n=t.value;if("xAxis"===s.componentProperty?n=t.axes.x:"yAxis"===s.componentProperty&&(n=t.axes.y),"transform"===s.valueNodeProperty)this._lerpTransform(i.states[e],n,"button"!==s.componentProperty);else{const r=i.states[e].valueMesh;r&&(r.isVisible=t.touched||t.pressed),this._touchDots[e]&&(this._touchDots[e].isVisible=t.touched||t.pressed)}}))}))}}const hd=[];class cd{static ClearProfilesCache(){this._ProfilesList=null,this._ProfileLoadingPromises={}}static DefaultFallbacks(){this.RegisterFallbacksForProfileId("google-daydream",["generic-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive-focus",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("magicleap-one",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("windows-mixed-reality",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("microsoft-mixed-reality",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-go",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("oculus-touch-v2",["oculus-touch","generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-touch",["generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-gearvr",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-odyssey",["generic-touchpad"]),this.RegisterFallbacksForProfileId("valve-index",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("generic-hand-select",["generic-trigger"])}static FindFallbackWithProfileId(e){const t=this._Fallbacks[e]||[];return t.unshift(e),t}static GetMotionControllerWithXRInput(e,t,i){const r=[];if(i&&r.push(i),r.push(...e.profiles||[]),r.length&&!r[0]&&r.pop(),e.gamepad&&e.gamepad.id&&e.gamepad.id===(e.gamepad.id.match(/oculus touch/gi)?e.gamepad.id:void 0))r.push("oculus-touch-v2");const s=r.indexOf("windows-mixed-reality");if(-1!==s&&r.splice(s,0,"microsoft-mixed-reality"),r.length||r.push("generic-trigger"),this.UseOnlineRepository){const i=this.PrioritizeOnlineRepository?this._LoadProfileFromRepository:this._LoadProfilesFromAvailableControllers,s=this.PrioritizeOnlineRepository?this._LoadProfilesFromAvailableControllers:this._LoadProfileFromRepository;return i.call(this,r,e,t).catch((()=>s.call(this,r,e,t)))}return this._LoadProfilesFromAvailableControllers(r,e,t)}static RegisterController(e,t){this._AvailableControllers[e]=t}static RegisterFallbacksForProfileId(e,t){this._Fallbacks[e]?this._Fallbacks[e].push(...t):this._Fallbacks[e]=t}static UpdateProfilesList(){return this._ProfilesList=H.S0.LoadFileAsync(this.BaseRepositoryUrl+"/profiles/profilesList.json",!1).then((e=>JSON.parse(e))),this._ProfilesList}static ClearControllerCache(){hd.forEach((e=>{e.meshes.forEach((e=>{e.dispose(!1,!0)}))})),hd.length=0}static _LoadProfileFromRepository(e,t,i){return Promise.resolve().then((()=>this._ProfilesList?this._ProfilesList:this.UpdateProfilesList())).then((t=>{for(let i=0;i<e.length;++i)if(e[i]&&t[e[i]])return e[i];throw new Error(`neither controller ${e[0]} nor all fallbacks were found in the repository,`)})).then((e=>(this._ProfileLoadingPromises[e]||(this._ProfileLoadingPromises[e]=H.S0.LoadFileAsync(`${this.BaseRepositoryUrl}/profiles/${e}/profile.json`,!1).then((e=>JSON.parse(e)))),this._ProfileLoadingPromises[e]))).then((e=>new ld(i,t,e,this.BaseRepositoryUrl,this.DisableControllerCache?void 0:hd)))}static _LoadProfilesFromAvailableControllers(e,t,i){for(let r=0;r<e.length;++r){if(!e[r])continue;const s=this.FindFallbackWithProfileId(e[r]);for(let e=0;e<s.length;++e){const r=this._AvailableControllers[s[e]];if(r)return Promise.resolve(r(t,i))}}throw new Error("no controller requested was found in the available controllers list")}}cd._AvailableControllers={},cd._Fallbacks={},cd._ProfileLoadingPromises={},cd.BaseRepositoryUrl="https://immersive-web.github.io/webxr-input-profiles/packages/viewer/dist",cd.PrioritizeOnlineRepository=!0,cd.UseOnlineRepository=!0,cd.DisableControllerCache=!0,cd.RegisterController(od.ProfileId,((e,t)=>new od(t,e.gamepad,e.handedness))),cd.DefaultFallbacks();let ud=0;class dd{constructor(e,t,i={}){this._scene=e,this.inputSource=t,this._options=i,this._tmpVector=new n.Pq,this._disposed=!1,this.onDisposeObservable=new s.cP,this.onMeshLoadedObservable=new s.cP,this.onMotionControllerInitObservable=new s.cP,this._uniqueId=`controller-${ud++}-${t.targetRayMode}-${t.handedness}`,this.pointer=new tt.e(`${this._uniqueId}-pointer`,e),this.pointer.rotationQuaternion=new n.PT,this.inputSource.gripSpace&&(this.grip=new tt.e(`${this._uniqueId}-grip`,this._scene),this.grip.rotationQuaternion=new n.PT),this._tmpVector.set(0,0,this._scene.useRightHandedSystem?-1:1),this.inputSource.gamepad&&"tracked-pointer"===this.inputSource.targetRayMode&&cd.GetMotionControllerWithXRInput(t,e,this._options.forceControllerProfile).then((e=>{this.motionController=e,this.onMotionControllerInitObservable.notifyObservers(e),this._options.doNotLoadControllerMesh||this.motionController._doNotLoadControllerMesh||this.motionController.loadModel().then((e=>{e&&this.motionController&&this.motionController.rootMesh&&(this._options.renderingGroupId&&(this.motionController.rootMesh.renderingGroupId=this._options.renderingGroupId,this.motionController.rootMesh.getChildMeshes(!1).forEach((e=>e.renderingGroupId=this._options.renderingGroupId))),this.onMeshLoadedObservable.notifyObservers(this.motionController.rootMesh),this.motionController.rootMesh.parent=this.grip||this.pointer,this.motionController.disableAnimation=!!this._options.disableMotionControllerAnimation),this._disposed&&this.motionController?.dispose()}))}),(()=>{H.S0.Warn("Could not find a matching motion controller for the registered input source")}))}get uniqueId(){return this._uniqueId}dispose(){this.grip&&this.grip.dispose(!0),this.motionController&&this.motionController.dispose(),this.pointer.dispose(!0),this.onMotionControllerInitObservable.clear(),this.onMeshLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._disposed=!0}getWorldPointerRayToRef(e,t=!1){const i=t&&this.grip?this.grip:this.pointer;n.Pq.TransformNormalToRef(this._tmpVector,i.getWorldMatrix(),e.direction),e.direction.normalize(),e.origin.copyFrom(i.absolutePosition),e.length=1e3}updateFromXRFrame(e,t,i,r){const s=e.getPose(this.inputSource.targetRaySpace,t);if(this._lastXRPose=s,s){const e=s.transform.position;this.pointer.position.set(e.x,e.y,e.z).scaleInPlace(r.worldScalingFactor);const t=s.transform.orientation;this.pointer.rotationQuaternion.set(t.x,t.y,t.z,t.w),this._scene.useRightHandedSystem||(this.pointer.position.z*=-1,this.pointer.rotationQuaternion.z*=-1,this.pointer.rotationQuaternion.w*=-1),this.pointer.parent=i.parent,this.pointer.scaling.setAll(r.worldScalingFactor)}if(this.inputSource.gripSpace&&this.grip){const s=e.getPose(this.inputSource.gripSpace,t);if(s){const e=s.transform.position,t=s.transform.orientation;this.grip.position.set(e.x,e.y,e.z).scaleInPlace(r.worldScalingFactor),this.grip.rotationQuaternion.set(t.x,t.y,t.z,t.w),this._scene.useRightHandedSystem||(this.grip.position.z*=-1,this.grip.rotationQuaternion.z*=-1,this.grip.rotationQuaternion.w*=-1)}this.grip.parent=i.parent,this.grip.scaling.setAll(r.worldScalingFactor)}this.motionController&&this.motionController.updateFromXRFrame(e)}}class pd{constructor(e,t,i={}){if(this.xrSessionManager=e,this.xrCamera=t,this._options=i,this.controllers=[],this.onControllerAddedObservable=new s.cP,this.onControllerRemovedObservable=new s.cP,this._onInputSourcesChange=e=>{this._addAndRemoveControllers(e.added,e.removed)},this._sessionEndedObserver=this.xrSessionManager.onXRSessionEnded.add((()=>{this._addAndRemoveControllers([],this.controllers.map((e=>e.inputSource)))})),this._sessionInitObserver=this.xrSessionManager.onXRSessionInit.add((e=>{e.addEventListener("inputsourceschange",this._onInputSourcesChange)})),this._frameObserver=this.xrSessionManager.onXRFrameObservable.add((e=>{this.controllers.forEach((t=>{t.updateFromXRFrame(e,this.xrSessionManager.referenceSpace,this.xrCamera,this.xrSessionManager)}))})),this._options.customControllersRepositoryURL&&(cd.BaseRepositoryUrl=this._options.customControllersRepositoryURL),cd.UseOnlineRepository=!this._options.disableOnlineControllerRepository,cd.UseOnlineRepository)try{cd.UpdateProfilesList().catch((()=>{cd.UseOnlineRepository=!1}))}catch(e){cd.UseOnlineRepository=!1}}_addAndRemoveControllers(e,t){const i=this.controllers.map((e=>e.inputSource));for(const t of e)if(-1===i.indexOf(t)){const e=new dd(this.xrSessionManager.scene,t,{...this._options.controllerOptions||{},forceControllerProfile:this._options.forceInputProfile,doNotLoadControllerMesh:this._options.doNotLoadControllerMeshes,disableMotionControllerAnimation:this._options.disableControllerAnimation});this.controllers.push(e),this.onControllerAddedObservable.notifyObservers(e)}const r=[],s=[];this.controllers.forEach((e=>{-1===t.indexOf(e.inputSource)?r.push(e):s.push(e)})),this.controllers=r,s.forEach((e=>{this.onControllerRemovedObservable.notifyObservers(e),e.dispose()}))}dispose(){this.controllers.forEach((e=>{e.dispose()})),this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver),this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver),this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver),this.onControllerAddedObservable.clear(),this.onControllerRemovedObservable.clear(),cd.ClearControllerCache()}}class md{get xrNativeFeatureName(){return this._xrNativeFeatureName}set xrNativeFeatureName(e){!this._xrSessionManager.isNative&&e&&this._xrSessionManager.inXRSession&&-1===this._xrSessionManager.enabledFeatures?.indexOf(e)&&m.V.Warn(`The feature ${e} needs to be enabled before starting the XR session. Note - It is still possible it is not supported.`),this._xrNativeFeatureName=e}constructor(e){this._xrSessionManager=e,this._attached=!1,this._removeOnDetach=[],this.isDisposed=!1,this.disableAutoAttach=!1,this._xrNativeFeatureName="",this.onFeatureAttachObservable=new s.cP,this.onFeatureDetachObservable=new s.cP}get attached(){return this._attached}attach(e){if(this.isDisposed)return!1;if(e)this.attached&&this.detach();else if(this.attached)return!1;if(this._xrSessionManager.enabledFeatures){if(!this._xrSessionManager.isNative&&this.xrNativeFeatureName&&-1===this._xrSessionManager.enabledFeatures.indexOf(this.xrNativeFeatureName))return!1}else m.V.Warn("session.enabledFeatures is not available on this device. It is possible that this feature is not supported.");return this._attached=!0,this._addNewAttachObserver(this._xrSessionManager.onXRFrameObservable,(e=>this._onXRFrame(e))),this.onFeatureAttachObservable.notifyObservers(this),!0}detach(){return this._attached?(this._attached=!1,this._removeOnDetach.forEach((e=>{e.observable.remove(e.observer)})),this.onFeatureDetachObservable.notifyObservers(this),!0):(this.disableAutoAttach=!0,!1)}dispose(){this.detach(),this.isDisposed=!0,this.onFeatureAttachObservable.clear(),this.onFeatureDetachObservable.clear()}isCompatible(){return!0}_addNewAttachObserver(e,t,i){this._removeOnDetach.push({observable:e,observer:e.add(t,void 0,i)})}}class fd extends md{constructor(e,t){super(e),this._options=t,this._attachController=e=>{if(this._controllers[e.uniqueId])return;const{laserPointer:t,selectionMesh:i}=this._generateNewMeshPair(this._options.forceGripIfAvailable&&e.grip?e.grip:e.pointer);switch(this._controllers[e.uniqueId]={xrController:e,laserPointer:t,selectionMesh:i,meshUnderPointer:null,pick:null,tmpRay:new st.Ray(new n.Pq,new n.Pq),disabledByNearInteraction:!1,id:fd._IdCounter++},this._attachedController?!this._options.enablePointerSelectionOnAllControllers&&this._options.preferredHandedness&&e.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=e.uniqueId):this._options.enablePointerSelectionOnAllControllers||(this._attachedController=e.uniqueId),e.inputSource.targetRayMode){case"tracked-pointer":return this._attachTrackedPointerRayMode(e);case"gaze":return this._attachGazeMode(e);case"screen":case"transient-pointer":return this._attachScreenRayMode(e)}},this._controllers={},this._tmpVectorForPickCompare=new n.Pq,this.disablePointerLighting=!0,this.disableSelectionMeshLighting=!0,this.displayLaserPointer=!0,this.displaySelectionMesh=!0,this.laserPointerPickedColor=new o.v9(.9,.9,.9),this.laserPointerDefaultColor=new o.v9(.7,.7,.7),this.selectionMeshDefaultColor=new o.v9(.8,.8,.8),this.selectionMeshPickedColor=new o.v9(.3,.3,1),this._identityMatrix=n.uq.Identity(),this._screenCoordinatesRef=n.Pq.Zero(),this._viewportRef=new $i.L(0,0,0,0),this._scene=this._xrSessionManager.scene,void 0===this._options.lookAndPickMode&&(this._scene.getEngine()._badDesktopOS||this._scene.getEngine()._badOS)&&(this._options.lookAndPickMode=!0),this._options.lookAndPickMode&&(this._options.enablePointerSelectionOnAllControllers=!0,this.displayLaserPointer=!1)}attach(){if(!super.attach())return!1;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController,!0),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)}),!0),this._scene.constantlyUpdateMeshUnderPointer=!0,this._options.gazeCamera){const e=this._options.gazeCamera,{laserPointer:t,selectionMesh:i}=this._generateNewMeshPair(e);this._controllers.camera={webXRCamera:e,laserPointer:t,selectionMesh:i,meshUnderPointer:null,pick:null,tmpRay:new st.Ray(new n.Pq,new n.Pq),disabledByNearInteraction:!1,id:fd._IdCounter++},this._attachGazeMode()}return!0}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),!0)}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}_getPointerSelectionDisabledByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].disabledByNearInteraction;return!0}_setPointerSelectionDisabledByPointerId(e,t){const i=Object.keys(this._controllers);for(let r=0;r<i.length;++r)if(this._controllers[i[r]].id===e)return void(this._controllers[i[r]].disabledByNearInteraction=t)}_onXRFrame(e){Object.keys(this._controllers).forEach((e=>{const t=this._controllers[e];if(this._options.lookAndPickMode&&"transient-pointer"!==t.xrController?.inputSource.targetRayMode)return;if(!this._options.enablePointerSelectionOnAllControllers&&e!==this._attachedController||t.disabledByNearInteraction)return t.selectionMesh.isVisible=!1,t.laserPointer.isVisible=!1,void(t.pick=null);let i;if(t.laserPointer.isVisible=this.displayLaserPointer,t.xrController)i=this._options.forceGripIfAvailable&&t.xrController.grip?t.xrController.grip.position:t.xrController.pointer.position,t.xrController.getWorldPointerRayToRef(t.tmpRay,this._options.forceGripIfAvailable);else{if(!t.webXRCamera)return;i=t.webXRCamera.position,t.webXRCamera.getForwardRayToRef(t.tmpRay)}if(this._options.maxPointerDistance&&(t.tmpRay.length=this._options.maxPointerDistance),!this._options.disableScenePointerVectorUpdate&&i){const e=this._xrSessionManager.scene,r=this._options.xrInput.xrCamera;r&&(r.viewport.toGlobalToRef(e.getEngine().getRenderWidth()/r.rigCameras.length,e.getEngine().getRenderHeight(),this._viewportRef),n.Pq.ProjectToRef(i,this._identityMatrix,r.getTransformationMatrix(),this._viewportRef,this._screenCoordinatesRef),"number"!=typeof this._screenCoordinatesRef.x||"number"!=typeof this._screenCoordinatesRef.y||isNaN(this._screenCoordinatesRef.x)||isNaN(this._screenCoordinatesRef.y)||this._screenCoordinatesRef.x===1/0||this._screenCoordinatesRef.y===1/0||(e.pointerX=this._screenCoordinatesRef.x,e.pointerY=this._screenCoordinatesRef.y,t.screenCoordinates={x:this._screenCoordinatesRef.x,y:this._screenCoordinatesRef.y}))}let r=null;this._utilityLayerScene&&(r=this._utilityLayerScene.pickWithRay(t.tmpRay,this._utilityLayerScene.pointerMovePredicate||this.raySelectionPredicate));const s=this._scene.pickWithRay(t.tmpRay,this._scene.pointerMovePredicate||this.raySelectionPredicate);r&&r.hit?s&&s.hit?r.distance<s.distance?t.pick=r:t.pick=s:t.pick=r:t.pick=s,t.pick&&t.xrController&&(t.pick.aimTransform=t.xrController.pointer,t.pick.gripTransform=t.xrController.grip||null,t.pick.originMesh=t.xrController.pointer,t.tmpRay.length=t.pick.distance);const o=t.pick;if(o&&o.pickedPoint&&o.hit){this._updatePointerDistance(t.laserPointer,o.distance),t.selectionMesh.position.copyFrom(o.pickedPoint),t.selectionMesh.scaling.x=Math.sqrt(o.distance),t.selectionMesh.scaling.y=Math.sqrt(o.distance),t.selectionMesh.scaling.z=Math.sqrt(o.distance);const e=this._convertNormalToDirectionOfRay(o.getNormal(!0),t.tmpRay),i=.001;if(t.selectionMesh.position.copyFrom(o.pickedPoint),e){const r=n.Pq.Cross(Mt._0.Y,e),s=n.Pq.Cross(e,r);n.Pq.RotationFromAxisToRef(s,e,r,t.selectionMesh.rotation),t.selectionMesh.position.addInPlace(e.scale(i))}t.selectionMesh.isVisible=this.displaySelectionMesh,t.meshUnderPointer=o.pickedMesh}else t.selectionMesh.isVisible=!1,this._updatePointerDistance(t.laserPointer,1),t.meshUnderPointer=null}))}get _utilityLayerScene(){return this._options.customUtilityLayerScene||Rs.DefaultUtilityLayer.utilityLayerScene}_attachGazeMode(e){const t=this._controllers[e&&e.uniqueId||"camera"],i=this._options.timeToSelect||3e3,r=this._options.useUtilityLayer?this._utilityLayerScene:this._scene;let s=new Xr.G;const n=Lr("selection",{diameter:.0525,thickness:.015,tessellation:20},r);n.isVisible=!1,n.isPickable=!1,n.parent=t.selectionMesh;let o=0,a=!1;const l={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{if(t.pick){if(this._augmentPointerInit(l,t.id,t.screenCoordinates),t.laserPointer.material.alpha=0,n.isVisible=!1,t.pick.hit)if(this._pickingMoved(s,t.pick))a&&(this._options.disablePointerUpOnTouchOut||this._scene.simulatePointerUp(t.pick,l)),a=!1,o=0;else if(o>i/10&&(n.isVisible=!0),o+=this._scene.getEngine().getDeltaTime(),o>=i)this._scene.simulatePointerDown(t.pick,l),a=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,l),n.isVisible=!1;else{const e=1-o/i;n.scaling.set(e,e,e)}else a=!1,o=0;this._scene.simulatePointerMove(t.pick,l),s=t.pick}})),void 0!==this._options.renderingGroupId&&(n.renderingGroupId=this._options.renderingGroupId),e&&e.onDisposeObservable.addOnce((()=>{t.pick&&!this._options.disablePointerUpOnTouchOut&&a&&(this._scene.simulatePointerUp(t.pick,l),t.finalPointerUpTriggered=!0),n.dispose()}))}_attachScreenRayMode(e){const t=this._controllers[e.uniqueId];let i=!1;const r={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{this._augmentPointerInit(r,t.id,t.screenCoordinates),!t.pick||this._options.disablePointerUpOnTouchOut&&i||(i?this._scene.simulatePointerMove(t.pick,r):(this._scene.simulatePointerDown(t.pick,r),t.pointerDownTriggered=!0,i=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,r)))})),e.onDisposeObservable.addOnce((()=>{this._augmentPointerInit(r,t.id,t.screenCoordinates),this._xrSessionManager.runInXRFrame((()=>{t.pick&&!t.finalPointerUpTriggered&&i&&!this._options.disablePointerUpOnTouchOut&&(this._scene.simulatePointerUp(t.pick,r),t.finalPointerUpTriggered=!0)}))}))}_attachTrackedPointerRayMode(e){const t=this._controllers[e.uniqueId];if(this._options.forceGazeMode)return this._attachGazeMode(e);const i={pointerId:t.id,pointerType:"xr"};if(t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{t.laserPointer.material.disableLighting=this.disablePointerLighting,t.selectionMesh.material.disableLighting=this.disableSelectionMeshLighting,t.pick&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerMove(t.pick,i))})),e.inputSource.gamepad){const r=r=>{this._options.overrideButtonId&&(t.selectionComponent=r.getComponent(this._options.overrideButtonId)),t.selectionComponent||(t.selectionComponent=r.getMainComponent()),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add((r=>{if(r.changes.pressed){const s=r.changes.pressed.current;if(t.pick)(this._options.enablePointerSelectionOnAllControllers||e.uniqueId===this._attachedController)&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),s?(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor):(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor));else if(s&&!this._options.enablePointerSelectionOnAllControllers&&!this._options.disableSwitchOnClick){const t=this._controllers[this._attachedController];t&&t.pointerDownTriggered&&!t.finalPointerUpTriggered&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerUp(new Xr.G,{pointerId:t.id,pointerType:"xr"}),t.finalPointerUpTriggered=!0),this._attachedController=e.uniqueId}}}))};e.motionController?r(e.motionController):e.onMotionControllerInitObservable.add(r)}else{const e=e=>{this._xrSessionManager.onXRFrameObservable.addOnce((()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor)}))},r=e=>{this._xrSessionManager.onXRFrameObservable.addOnce((()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)}))};t.eventListeners={selectend:r,selectstart:e},this._xrSessionManager.session.addEventListener("selectstart",e),this._xrSessionManager.session.addEventListener("selectend",r)}}_convertNormalToDirectionOfRay(e,t){if(e){Math.acos(n.Pq.Dot(e,t.direction))<Math.PI/2&&e.scaleInPlace(-1)}return e}_detachController(e){const t=this._controllers[e];if(t){if(t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach((e=>{const i=t.eventListeners&&t.eventListeners[e];i&&this._xrSessionManager.session.removeEventListener(e,i)})),!t.finalPointerUpTriggered&&t.pointerDownTriggered){const e={pointerId:t.id,pointerType:"xr"};this._xrSessionManager.runInXRFrame((()=>{this._augmentPointerInit(e,t.id,t.screenCoordinates),this._scene.simulatePointerUp(t.pick||new Xr.G,e),t.finalPointerUpTriggered=!0}))}this._xrSessionManager.scene.onBeforeRenderObservable.addOnce((()=>{try{if(t.selectionMesh.dispose(),t.laserPointer.dispose(),delete this._controllers[e],this._attachedController===e){const e=Object.keys(this._controllers);e.length?this._attachedController=e[0]:this._attachedController=""}}catch(e){H.S0.Warn("controller already detached.")}}))}}_generateNewMeshPair(e){const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Rs.DefaultUtilityLayer.utilityLayerScene:this._scene,i=this._options.customLasterPointerMeshGenerator?this._options.customLasterPointerMeshGenerator():Es("laserPointer",{height:1,diameterTop:2e-4,diameterBottom:.004,tessellation:20,subdivisions:1},t);i.parent=e;const r=new br.F("laserPointerMat",t);r.emissiveColor=this.laserPointerDefaultColor,r.alpha=.7,i.material=r,i.rotation.x=Math.PI/2,this._updatePointerDistance(i,1),i.isPickable=!1,i.isVisible=!1;const s=this._options.customSelectionMeshGenerator?this._options.customSelectionMeshGenerator():Lr("gazeTracker",{diameter:.0105,thickness:.0075,tessellation:20},t);s.bakeCurrentTransformIntoVertices(),s.isPickable=!1,s.isVisible=!1;const n=new br.F("targetMat",t);return n.specularColor=o.v9.Black(),n.emissiveColor=this.selectionMeshDefaultColor,n.backFaceCulling=!1,s.material=n,void 0!==this._options.renderingGroupId&&(i.renderingGroupId=this._options.renderingGroupId,s.renderingGroupId=this._options.renderingGroupId),{laserPointer:i,selectionMesh:s}}_pickingMoved(e,t){if(!e.hit||!t.hit)return!0;if(!(e.pickedMesh&&e.pickedPoint&&t.pickedMesh&&t.pickedPoint))return!0;if(e.pickedMesh!==t.pickedMesh)return!0;e.pickedPoint?.subtractToRef(t.pickedPoint,this._tmpVectorForPickCompare),this._tmpVectorForPickCompare.set(Math.abs(this._tmpVectorForPickCompare.x),Math.abs(this._tmpVectorForPickCompare.y),Math.abs(this._tmpVectorForPickCompare.z));const i=.01*(this._options.gazeModePointerMovedFactor||1)*t.distance;return this._tmpVectorForPickCompare.length()>i}_updatePointerDistance(e,t=100){e.scaling.y=t,this._scene.useRightHandedSystem&&(t*=-1),e.position.z=t/2+.05}_augmentPointerInit(e,t,i){e.pointerId=t,e.pointerType="xr",i&&(e.screenX=i.x,e.screenY=i.y)}get lasterPointerDefaultColor(){return this.laserPointerDefaultColor}}var _d,gd,xd,vd,Sd,bd,yd;fd._IdCounter=200,fd.Name=Tt.POINTER_SELECTION,fd.Version=1,Ct.AddWebXRFeature(fd.Name,((e,t)=>()=>new fd(e,t)),fd.Version,!0),function(e){e[e.Float=1]="Float",e[e.Int=2]="Int",e[e.Vector2=4]="Vector2",e[e.Vector3=8]="Vector3",e[e.Vector4=16]="Vector4",e[e.Color3=32]="Color3",e[e.Color4=64]="Color4",e[e.Matrix=128]="Matrix",e[e.Object=256]="Object",e[e.AutoDetect=1024]="AutoDetect",e[e.BasedOnInput=2048]="BasedOnInput",e[e.All=4095]="All"}(_d||(_d={})),function(e){e[e.Vertex=1]="Vertex",e[e.Fragment=2]="Fragment",e[e.Neutral=4]="Neutral",e[e.VertexAndFragment=3]="VertexAndFragment"}(gd||(gd={}));class Pd{constructor(){this.supportUniformBuffers=!1,this.attributes=[],this.uniforms=[],this.constants=[],this.samplers=[],this.functions={},this.extensions={},this.prePassOutput={},this.counters={},this._terminalBlocks=new Set,this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}get shaderLanguage(){return this.sharedData.nodeMaterial.shaderLanguage}get fSuffix(){return 1===this.shaderLanguage?"f":""}finalize(e){const t=e.sharedData.emitComments,i=this.target===gd.Fragment;1===this.shaderLanguage?this.compilationString=i?`\n${t?"//Entry point\n":""}@fragment\nfn main(input: FragmentInputs) -> FragmentOutputs {\n${this.compilationString}`:`\n${t?"//Entry point\n":""}@vertex\nfn main(input: VertexInputs) -> FragmentInputs{\n${this.compilationString}`:this.compilationString=`\n${t?"//Entry point\n":""}void main(void) {\n${this.compilationString}`,this._constantDeclaration&&(this.compilationString=`\n${t?"//Constants\n":""}${this._constantDeclaration}\n${this.compilationString}`);let r="";for(const e in this.functions)r+=this.functions[e]+"\n";if(this.compilationString=`\n${r}\n${this.compilationString}`,!i&&this._varyingTransfer&&(this.compilationString=`${this.compilationString}\n${this._varyingTransfer}`),this._injectAtEnd&&(this.compilationString=`${this.compilationString}\n${this._injectAtEnd}`),this.compilationString=`${this.compilationString}\n}`,this.sharedData.varyingDeclaration&&(this.compilationString=`\n${t?"//Varyings\n":""}${this.sharedData.varyingDeclaration}\n${this.compilationString}`),this._samplerDeclaration&&(this.compilationString=`\n${t?"//Samplers\n":""}${this._samplerDeclaration}\n${this.compilationString}`),this._uniformDeclaration&&(this.compilationString=`\n${t?"//Uniforms\n":""}${this._uniformDeclaration}\n${this.compilationString}`),this._attributeDeclaration&&!i&&(this.compilationString=`\n${t?"//Attributes\n":""}${this._attributeDeclaration}\n${this.compilationString}`),1!==this.shaderLanguage){this.compilationString="precision highp float;\n"+this.compilationString,this.compilationString="#if defined(WEBGL2) || defined(WEBGPU)\nprecision highp sampler2DArray;\n#endif\n"+this.compilationString,i&&(this.compilationString="#if defined(PREPASS)\r\n#extension GL_EXT_draw_buffers : require\r\nlayout(location = 0) out highp vec4 glFragData[SCENE_MRT_COUNT];\r\nhighp vec4 gl_FragColor;\r\n#endif\r\n"+this.compilationString);for(const e in this.extensions){const t=this.extensions[e];this.compilationString=`\n${t}\n${this.compilationString}`}}this._builtCompilationString=this.compilationString}get _repeatableContentAnchor(){return`###___ANCHOR${this._repeatableContentAnchorIndex++}___###`}_getFreeVariableName(e){return e=e.replace(/[^a-zA-Z_]+/g,""),void 0===this.sharedData.variableNames[e]?(this.sharedData.variableNames[e]=0,"output"===e||"texture"===e?e+this.sharedData.variableNames[e]:e):(this.sharedData.variableNames[e]++,e+this.sharedData.variableNames[e])}_getFreeDefineName(e){return void 0===this.sharedData.defineNames[e]?this.sharedData.defineNames[e]=0:this.sharedData.defineNames[e]++,e+this.sharedData.defineNames[e]}_excludeVariableName(e){this.sharedData.variableNames[e]=0}_emit2DSampler(e,t="",i=!1){(this.samplers.indexOf(e)<0||i)&&(t&&(this._samplerDeclaration+=`#if ${t}\n`),1===this.shaderLanguage?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;\n`,this._samplerDeclaration+=`var ${e}: texture_2d<f32>;\n`):this._samplerDeclaration+=`uniform sampler2D ${e};\n`,t&&(this._samplerDeclaration+="#endif\n"),i||this.samplers.push(e))}_emitCubeSampler(e,t="",i=!1){(this.samplers.indexOf(e)<0||i)&&(t&&(this._samplerDeclaration+=`#if ${t}\n`),1===this.shaderLanguage?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;\n`,this._samplerDeclaration+=`var ${e}: texture_cube<f32>;\n`):this._samplerDeclaration+=`uniform samplerCube ${e};\n`,t&&(this._samplerDeclaration+="#endif\n"),i||this.samplers.push(e))}_emit2DArraySampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2DArray ${e};\n`,this.samplers.push(e))}_getGLType(e){switch(e){case _d.Float:return"float";case _d.Int:return"int";case _d.Vector2:return"vec2";case _d.Color3:case _d.Vector3:return"vec3";case _d.Color4:case _d.Vector4:return"vec4";case _d.Matrix:return"mat4"}return""}_getShaderType(e){const t=1===this.shaderLanguage;switch(e){case _d.Float:return t?"f32":"float";case _d.Int:return t?"i32":"int";case _d.Vector2:return t?"vec2f":"vec2";case _d.Color3:case _d.Vector3:return t?"vec3f":"vec3";case _d.Color4:case _d.Vector4:return t?"vec4f":"vec4";case _d.Matrix:return t?"mat4x4f":"mat4"}return""}_emitExtension(e,t,i=""){this.extensions[e]||(i&&(t=`#if ${i}\n${t}\n#endif`),this.extensions[e]=t)}_emitFunction(e,t,i){this.functions[e]||(this.sharedData.emitComments&&(t=i+"\n"+t),this.functions[e]=t)}_emitCodeFromInclude(e,t,i){const r=qi.l.GetIncludesShadersStore(this.shaderLanguage);if(i&&i.repeatKey)return`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]\n`;let s=r[e]+"\n";if(this.sharedData.emitComments&&(s=t+"\n"+s),!i)return s;if(i.replaceStrings)for(let e=0;e<i.replaceStrings.length;e++){const t=i.replaceStrings[e];s=s.replace(t.search,t.replace)}return s}_emitFunctionFromInclude(e,t,i,r=""){const s=e+r;if(this.functions[s])return;const n=qi.l.GetIncludesShadersStore(this.shaderLanguage);if(!(i&&(i.removeAttributes||i.removeUniforms||i.removeVaryings||i.removeIfDef||i.replaceStrings)))return i&&i.repeatKey?this.functions[s]=`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]\n`:this.functions[s]=`#include<${e}>${i?.substitutionVars?"("+i?.substitutionVars+")":""}\n`,void(this.sharedData.emitComments&&(this.functions[s]=t+"\n"+this.functions[s]));if(this.functions[s]=n[e],this.sharedData.emitComments&&(this.functions[s]=t+"\n"+this.functions[s]),i.removeIfDef&&(this.functions[s]=this.functions[s].replace(/^\s*?#ifdef.+$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#endif.*$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#else.*$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#elif.*$/gm,"")),i.removeAttributes&&(this.functions[s]=this.functions[s].replace(/\s*?attribute .+?;/g,"\n")),i.removeUniforms&&(this.functions[s]=this.functions[s].replace(/\s*?uniform .*?;/g,"\n")),i.removeVaryings&&(this.functions[s]=this.functions[s].replace(/\s*?(varying|in) .+?;/g,"\n")),i.replaceStrings)for(let e=0;e<i.replaceStrings.length;e++){const t=i.replaceStrings[e];this.functions[s]=this.functions[s].replace(t.search,t.replace)}}_registerTempVariable(e){return-1===this.sharedData.temps.indexOf(e)&&(this.sharedData.temps.push(e),!0)}_emitVaryingFromString(e,t,i="",r=!1){if(-1!==this.sharedData.varyings.indexOf(e))return!1;this.sharedData.varyings.push(e),i&&(i.startsWith("defined(")?this.sharedData.varyingDeclaration+=`#if ${i}\n`:this.sharedData.varyingDeclaration+=`${r?"#ifndef":"#ifdef"} ${i}\n`);const s=this._getShaderType(t);return 1===this.shaderLanguage?this.sharedData.varyingDeclaration+=`varying ${e}: ${s};\n`:this.sharedData.varyingDeclaration+=`varying ${s} ${e};\n`,i&&(this.sharedData.varyingDeclaration+="#endif\n"),!0}_getVaryingName(e){return 1===this.shaderLanguage?(this.target!==gd.Fragment?"vertexOutputs.":"fragmentInputs.")+e:e}_emitUniformFromString(e,t,i="",r=!1){if(-1!==this.uniforms.indexOf(e))return;this.uniforms.push(e),i&&(i.startsWith("defined(")?this._uniformDeclaration+=`#if ${i}\n`:this._uniformDeclaration+=`${r?"#ifndef":"#ifdef"} ${i}\n`);const s=this._getShaderType(t);1===this.shaderLanguage?this._uniformDeclaration+=`uniform ${e}: ${s};\n`:this._uniformDeclaration+=`uniform ${s} ${e};\n`,i&&(this._uniformDeclaration+="#endif\n")}_generateTernary(e,t,i){return 1===this.shaderLanguage?`select(${t}, ${e}, ${i})`:`(${i}) ? ${e} : ${t}`}_emitFloat(e){return e.toString()===e.toFixed(0)?`${e}.0`:e.toString()}_declareOutput(e,t){return this._declareLocalVar(e.associatedVariableName,e.type,t)}_declareLocalVar(e,t,i){return 1===this.shaderLanguage?`${i?"const":"var"} ${e}: ${this._getShaderType(t)}`:`${this._getShaderType(t)} ${e}`}_samplerCubeFunc(){return 1===this.shaderLanguage?"textureSample":"textureCube"}_samplerFunc(){return 1===this.shaderLanguage?"textureSample":"texture2D"}_samplerLODFunc(){return 1===this.shaderLanguage?"textureSampleLevel":"texture2DLodEXT"}_toLinearSpace(e){return 1===this.shaderLanguage&&(e.type===_d.Color3||e.type===_d.Vector3)?`toLinearSpaceVec3(${e.associatedVariableName})`:`toLinearSpace(${e.associatedVariableName})`}_generateTextureSample(e,t){return 1===this.shaderLanguage?`${this._samplerFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerFunc()}(${t}, ${e})`}_generateTextureSampleLOD(e,t,i){return 1===this.shaderLanguage?`${this._samplerLODFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerLODFunc()}(${t}, ${e}, ${i})`}_generateTextureSampleCube(e,t){return 1===this.shaderLanguage?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerCubeFunc()}(${t}, ${e})`}_generateTextureSampleCubeLOD(e,t,i){return 1===this.shaderLanguage?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerCubeFunc()}(${t}, ${e}, ${i})`}_convertVariableDeclarationToWGSL(e,t,i){return i.replace(new RegExp(`(${e})\\s+(\\w+)`,"g"),`var $2: ${t}`)}_convertVariableConstructorsToWGSL(e,t,i){return i.replace(new RegExp(`(${e})\\(`,"g"),` ${t}(`)}_convertOutParametersToWGSL(e){return e.replace(new RegExp("out\\s+var\\s+(\\w+)\\s*:\\s*(\\w+)","g"),"$1: ptr<function, $2>")}_convertTernaryOperandsToWGSL(e){return e.replace(new RegExp("\\[(.*?)\\?(.*?):(.*)\\]","g"),((e,t,i,r)=>`select(${r}, ${i}, ${t})`))}_convertModOperatorsToWGSL(e){return e.replace(new RegExp("mod\\((.+?),\\s*(.+?)\\)","g"),((e,t,i)=>`((${t})%(${i}))`))}_convertConstToWGSL(e){return e.replace(new RegExp("const var","g"),"const")}_convertInnerFunctionsToWGSL(e){return e.replace(new RegExp("inversesqrt","g"),"inverseSqrt")}_convertFunctionsToWGSL(e){const t=/var\s+(\w+)\s*:\s*(\w+)\((.*)\)/g;let i;for(;null!==(i=t.exec(e));){const t=i[1],r=i[2],s=i[3].replace(/var\s/g,"");e=e.replace(i[0],`fn ${t}(${s}) -> ${r}`)}return e}_babylonSLtoWGSL(e){return e=this._convertVariableDeclarationToWGSL("void","voidnull",e),e=this._convertVariableDeclarationToWGSL("bool","bool",e),e=this._convertVariableDeclarationToWGSL("int","i32",e),e=this._convertVariableDeclarationToWGSL("uint","u32",e),e=this._convertVariableDeclarationToWGSL("float","f32",e),e=this._convertVariableDeclarationToWGSL("vec2","vec2f",e),e=this._convertVariableDeclarationToWGSL("vec3","vec3f",e),e=this._convertVariableDeclarationToWGSL("vec4","vec4f",e),e=this._convertVariableDeclarationToWGSL("mat2","mat2x2f",e),e=this._convertVariableDeclarationToWGSL("mat3","mat3x3f",e),e=this._convertVariableDeclarationToWGSL("mat4","mat4x4f",e),e=this._convertVariableConstructorsToWGSL("float","f32",e),e=this._convertVariableConstructorsToWGSL("vec2","vec2f",e),e=this._convertVariableConstructorsToWGSL("vec3","vec3f",e),e=this._convertVariableConstructorsToWGSL("vec4","vec4f",e),e=this._convertVariableConstructorsToWGSL("mat2","mat2x2f",e),e=this._convertVariableConstructorsToWGSL("mat3","mat3x3f",e),e=this._convertVariableConstructorsToWGSL("mat4","mat4x4f",e),e=this._convertTernaryOperandsToWGSL(e),e=this._convertModOperatorsToWGSL(e),e=this._convertConstToWGSL(e),e=this._convertInnerFunctionsToWGSL(e),e=(e=this._convertOutParametersToWGSL(e)).replace(/\[\*\]/g,"*"),e=(e=(e=(e=this._convertFunctionsToWGSL(e)).replace(/\s->\svoidnull/g,"")).replace(/dFdx/g,"dpdx")).replace(/dFdy/g,"dpdy")}_convertTernaryOperandsToGLSL(e){return e.replace(new RegExp("\\[(.+?)\\?(.+?):(.+)\\]","g"),((e,t,i,r)=>`${t} ? ${i} : ${r}`))}_babylonSLtoGLSL(e){return e=e.replace(/\[\*\]/g,""),e=this._convertTernaryOperandsToGLSL(e)}}class Td{constructor(){this.temps=[],this.varyings=[],this.varyingDeclaration="",this.inputBlocks=[],this.textureBlocks=[],this.bindableBlocks=[],this.forcedBindableBlocks=[],this.blocksWithFallbacks=[],this.blocksWithDefines=[],this.repeatableContentBlocks=[],this.dynamicUniformBlocks=[],this.blockingBlocks=[],this.animatedInputs=[],this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}emitErrors(e=null){let t="";this.checks.emitVertex||this.allowEmptyVertexProgram||(t+="NodeMaterial does not have a vertex output. You need to at least add a block that generates a position value.\n"),this.checks.emitFragment||(t+="NodeMaterial does not have a fragment output. You need to at least add a block that generates a color value.\n");for(const e of this.checks.notConnectedNonOptionalInputs)t+=`input ${e.name} from block ${e.ownerBlock.name}[${e.ownerBlock.getClassName()}] is not connected and is not optional.\n`;return!t||(e&&e.notifyObservers(t),m.V.Error("Build of NodeMaterial failed:\n"+t),!1)}}!function(e){e[e.Compatible=0]="Compatible",e[e.TypeIncompatible=1]="TypeIncompatible",e[e.TargetIncompatible=2]="TargetIncompatible",e[e.HierarchyIssue=3]="HierarchyIssue"}(xd||(xd={})),function(e){e[e.Input=0]="Input",e[e.Output=1]="Output"}(vd||(vd={}));class Cd{static AreEquivalentTypes(e,t){switch(e){case _d.Vector3:if(t===_d.Color3)return!0;break;case _d.Vector4:if(t===_d.Color4)return!0;break;case _d.Color3:if(t===_d.Vector3)return!0;break;case _d.Color4:if(t===_d.Vector4)return!0}return!1}get _connectedPoint(){return this._connectedPointBackingField}set _connectedPoint(e){this._connectedPointBackingField!==e&&(this._connectedPointTypeChangedObserver?.remove(),this._updateTypeDependentState((()=>this._connectedPointBackingField=e)),this._connectedPointBackingField&&(this._connectedPointTypeChangedObserver=this._connectedPointBackingField.onTypeChangedObservable.add((()=>{this._notifyTypeChanged()}))))}get _typeConnectionSource(){return this._typeConnectionSourceBackingField}set _typeConnectionSource(e){this._typeConnectionSourceBackingField!==e&&(this._typeConnectionSourceTypeChangedObserver?.remove(),this._updateTypeDependentState((()=>this._typeConnectionSourceBackingField=e)),this._typeConnectionSourceBackingField&&(this._typeConnectionSourceTypeChangedObserver=this._typeConnectionSourceBackingField.onTypeChangedObservable.add((()=>{this._notifyTypeChanged()}))))}get _defaultConnectionPointType(){return this._defaultConnectionPointTypeBackingField}set _defaultConnectionPointType(e){this._updateTypeDependentState((()=>this._defaultConnectionPointTypeBackingField=e))}get _linkedConnectionSource(){return this._linkedConnectionSourceBackingField}set _linkedConnectionSource(e){this._linkedConnectionSourceBackingField!==e&&(this._linkedConnectionSourceTypeChangedObserver?.remove(),this._updateTypeDependentState((()=>this._linkedConnectionSourceBackingField=e)),this._isMainLinkSource=!1,this._linkedConnectionSourceBackingField&&(this._linkedConnectionSourceTypeChangedObserver=this._linkedConnectionSourceBackingField.onTypeChangedObservable.add((()=>{this._notifyTypeChanged()}))))}get direction(){return this._direction}get declarationVariableName(){return this._ownerBlock.isInput?this._ownerBlock.declarationVariableName:this._enforceAssociatedVariableName&&this._associatedVariableName||!this._connectedPoint?this._associatedVariableName:this._connectedPoint.declarationVariableName}get associatedVariableName(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:this._enforceAssociatedVariableName&&this._associatedVariableName||!this._connectedPoint?this._associatedVariableName:this._connectedPoint.associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get innerType(){return this._linkedConnectionSource&&!this._isMainLinkSource&&this._linkedConnectionSource.isConnected?this.type:this._type}get type(){if(this._type===_d.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource){if(this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.connectedPoint._redirectedSource&&this._linkedConnectionSource.connectedPoint._redirectedSource.isConnected?this._linkedConnectionSource.connectedPoint._redirectedSource.type:this._linkedConnectionSource.type;if(this._linkedConnectionSource._defaultConnectionPointType)return this._linkedConnectionSource._defaultConnectionPointType}if(this._defaultConnectionPointType)return this._defaultConnectionPointType}if(this._type===_d.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._updateTypeDependentState((()=>this._type=e))}get target(){return this._prioritizeVertex&&this._ownerBlock?this._target!==gd.VertexAndFragment?this._target:this._ownerBlock.target===gd.Fragment?gd.Fragment:gd.Vertex:this._target}set target(e){this._target=e}get isConnected(){return null!==this.connectedPoint||this.hasEndpoints}get isConnectedToInputBlock(){return null!==this.connectedPoint&&this.connectedPoint.ownerBlock.isInput}get connectInputBlock(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return 0===this._endpoints.length?[]:this._endpoints.map((e=>e.ownerBlock))}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get isDirectlyConnectedToVertexOutput(){if(!this.hasEndpoints)return!1;for(const e of this._endpoints){if(e.ownerBlock.target===gd.Vertex)return!0;if((e.ownerBlock.target===gd.Neutral||e.ownerBlock.target===gd.VertexAndFragment)&&e.ownerBlock.outputs.some((e=>e.isDirectlyConnectedToVertexOutput)))return!0}return!1}get isConnectedInVertexShader(){if(this.target===gd.Vertex)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints){if(e.ownerBlock.target===gd.Vertex)return!0;if(e.target===gd.Vertex)return!0;if((e.ownerBlock.target===gd.Neutral||e.ownerBlock.target===gd.VertexAndFragment)&&e.ownerBlock.outputs.some((e=>e.isConnectedInVertexShader)))return!0}return!1}get isConnectedInFragmentShader(){if(this.target===gd.Fragment)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints){if(e.ownerBlock.target===gd.Fragment)return!0;if((e.ownerBlock.target===gd.Neutral||e.ownerBlock.target===gd.VertexAndFragment)&&e.ownerBlock.isConnectedInFragmentShader())return!0}return!1}createCustomInputBlock(){return null}constructor(e,t,i){this._preventBubbleUp=!1,this._connectedPointBackingField=null,this._endpoints=new Array,this._redirectedSource=null,this._typeConnectionSourceBackingField=null,this._defaultConnectionPointTypeBackingField=null,this._isMainLinkSource=!1,this._linkedConnectionSourceBackingField=null,this._acceptedConnectionPointType=null,this._type=_d.Float,this._enforceAssociatedVariableName=!1,this._forPostBuild=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new s.cP,this.onDisconnectionObservable=new s.cP,this.onTypeChangedObservable=new s.cP,this._isTypeChangeObservableNotifying=!1,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=gd.VertexAndFragment,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeMaterialConnectionPoint"}canConnectTo(e){return 0===this.checkCompatibilityState(e)}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(t.target===gd.Fragment){if(i.target===gd.Vertex)return 2;for(const e of i.outputs)if(e.ownerBlock.target!=gd.Neutral&&e.isConnectedInVertexShader)return 2}if(this.type!==e.type&&e.innerType!==_d.AutoDetect)return Cd.AreEquivalentTypes(this.type,e.type)||e.acceptedConnectionPointTypes&&-1!==e.acceptedConnectionPointTypes.indexOf(this.type)||e._acceptedConnectionPointType&&Cd.AreEquivalentTypes(e._acceptedConnectionPointType.type,this.type)?0:1;if(e.excludedConnectionPointTypes&&-1!==e.excludedConnectionPointTypes.indexOf(this.type))return 1;let r=i,s=t;return 0===this.direction&&(r=t,s=i),r.isAnAncestorOf(s)?3:0}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return-1===t||(this._endpoints.splice(t,1),e._connectedPoint=null,this._enforceAssociatedVariableName=!1,e._enforceAssociatedVariableName=!1,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this)),this}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<_d.All;)e&t||this.excludedConnectionPointTypes.push(t),t<<=1}serialize(e=!0){const t={};return t.name=this.name,this.displayName&&(t.displayName=this.displayName),e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear(),this.onTypeChangedObservable.clear(),this._connectedPoint=null,this._typeConnectionSource=null,this._linkedConnectionSource=null}_updateTypeDependentState(e){const t=this.type;e(),this.type!==t&&this._notifyTypeChanged()}_notifyTypeChanged(){this._isTypeChangeObservableNotifying||(this._isTypeChangeObservableNotifying=!0,this.onTypeChangedObservable.notifyObservers(this.type),this._isTypeChangeObservableNotifying=!1)}}class Ed{get _isFinalOutputAndActive(){return this._isFinalOutput}get _hasPrecedence(){return!1}get name(){return this._name}get codeIsReady(){return this._codeIsReady}set name(e){this.validateBlockName(e)&&(this._name=e)}get isUnique(){return this._isUnique}get isFinalMerger(){return this._isFinalMerger}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isLoop(){return this._isLoop}get buildId(){return this._buildId}set buildId(e){this._buildId=e}get target(){return this._target}set target(e){this._target&e||(this._target=e)}get inputs(){return this._inputs}get outputs(){return this._outputs}getInputByName(e){const t=this._inputs.filter((t=>t.name===e));return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter((t=>t.name===e));return t.length?t[0]:null}constructor(e,t=gd.Vertex,i=!1,r=!1){switch(this._isFinalMerger=!1,this._isInput=!1,this._isLoop=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._name="",this._isUnique=!1,this._codeIsReady=!0,this._isFinalOutput=!1,this.onCodeIsReadyObservable=new s.cP,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=t,this._originalTargetIsNeutral=t===gd.Neutral,this._isFinalMerger=i,this._isFinalOutput=r,this.getClassName()){case"InputBlock":this._isInput=!0;break;case"NodeMaterialTeleportOutBlock":this._isTeleportOut=!0;break;case"NodeMaterialTeleportInBlock":this._isTeleportIn=!0;break;case"LoopBlock":this._isLoop=!0}this._name=e,this.uniqueId=Xl.K.UniqueId}_setInitialTarget(e){this._target=e,this._originalTargetIsNeutral=e===gd.Neutral}initialize(e){}bind(e,t,i,r){}_writeVariable(e){return e.connectedPoint?`${e.associatedVariableName}`:"0."}_writeFloat(e){let t=e.toString();return-1===t.indexOf(".")&&(t+=".0"),`${t}`}getClassName(){return"NodeMaterialBlock"}isConnectedInFragmentShader(){return this.outputs.some((e=>e.isConnectedInFragmentShader))}registerInput(e,t,i=!1,r,s){return(s=s??new Cd(e,this,0)).type=t,s.isOptional=i,r&&(s.target=r),this._inputs.push(s),this}registerOutput(e,t,i,r){return(r=r??new Cd(e,this,1)).type=t,i&&(r.target=i),this._outputs.push(r),this}getFirstAvailableInput(e=null){for(const t of this._inputs)if(!(t.connectedPoint||e&&e.type!==t.type&&t.type!==_d.AutoDetect&&-1===t.acceptedConnectionPointTypes.indexOf(e.type)))return t;return null}getFirstAvailableOutput(e=null){for(const t of this._outputs)if(!e||!e.target||e.target===gd.Neutral||e.target&t.target)return t;return null}getSiblingOutput(e){const t=this._outputs.indexOf(e);return-1===t||t>=this._outputs.length?null:this._outputs[t+1]}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints){if(i.ownerBlock===e)return!0;if(i.ownerBlock.isAnAncestorOf(e))return!0}return!1}connectTo(e,t){if(0===this._outputs.length)return;let i=t&&t.output?this.getOutputByName(t.output):this.getFirstAvailableOutput(e),r=!0;for(;r;){const s=t&&t.input?e.getInputByName(t.input):e.getFirstAvailableInput(i);if(i&&s&&i.canConnectTo(s))i.connectTo(s),r=!1;else{if(!i)throw"Unable to find a compatible match";i=this.getSiblingOutput(i)}}return this}_buildBlock(e){}_postBuildBlock(e){}updateUniformsAndSamples(e,t,i,r){}provideFallbacks(e,t){}initializeDefines(e,t,i,r=!1){}prepareDefines(e,t,i,r=!1,s){}autoConfigure(e,t=()=>!0){}replaceRepeatableContent(e,t,i,r){}get willBeGeneratedIntoVertexShaderFromFragmentShader(){return!this.isInput&&!this.isFinalMerger&&(!this._outputs.some((e=>e.isDirectlyConnectedToVertexOutput))&&(this.target!==gd.Vertex&&!(this.target!==gd.VertexAndFragment&&this.target!==gd.Neutral||!this._outputs.some((e=>e.isConnectedInVertexShader)))))}isReady(e,t,i,r=!1){return!0}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:(this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[e]._isMainLinkSource=!0),this._inputs[t]._linkedConnectionSource=this._inputs[e]}_processBuild(e,t,i,r){e.build(t,r);const s=null!=t._vertexState,n=e._buildTarget===gd.Vertex&&e.target!==gd.VertexAndFragment;if(s&&(!(e.target&e._buildTarget)||!(e.target&i.target)||this.target!==gd.VertexAndFragment&&n)&&(!e.isInput&&t.target!==e._buildTarget||e.isInput&&e.isAttribute&&!e._noContextSwitch)){const e=i.connectedPoint;if(t._vertexState._emitVaryingFromString("v_"+e.declarationVariableName,e.type)){const i=1===t.shaderLanguage?"vertexOutputs.":"";t._vertexState.compilationString+=`${i}${"v_"+e.declarationVariableName} = ${e.associatedVariableName};\n`}const r=1===t.shaderLanguage?"fragmentInputs.":"";i.associatedVariableName=r+"v_"+e.declarationVariableName,i._enforceAssociatedVariableName=!0}}validateBlockName(e){const t=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"];for(const i of t)if(e===i)return!1;return!0}_customBuildStep(e,t){}build(e,t){if(this._buildId===e.sharedData.buildId)return!0;if(!this.isInput)for(const t of this._outputs)t.associatedVariableName||(t.associatedVariableName=e._getFreeVariableName(t.name));for(const i of this._inputs){if(!i.connectedPoint){i.isOptional||e.sharedData.checks.notConnectedNonOptionalInputs.push(i);continue}if(this.target!==gd.Neutral){if(!(i.target&this.target))continue;if(!(i.target&e.target))continue}const r=i.connectedPoint.ownerBlock;r&&r!==this&&this._processBuild(r,e,i,t)}if(this._customBuildStep(e,t),this._buildId===e.sharedData.buildId)return!0;if(e.sharedData.verbose&&m.V.Log(`${e.target===gd.Vertex?"Vertex shader":"Fragment shader"}: Building ${this.name} [${this.getClassName()}]`),this.isFinalMerger)switch(e.target){case gd.Vertex:e.sharedData.checks.emitVertex=!0;break;case gd.Fragment:e.sharedData.checks.emitFragment=!0}!this.isInput&&e.sharedData.emitComments&&(e.compilationString+=`\n//${this.name}\n`),this._buildBlock(e),this._buildId=e.sharedData.buildId,this._buildTarget=e.target;for(const i of this._outputs)if(!i._forPostBuild&&i.target&e.target)for(const r of i.endpoints){const i=r.ownerBlock;i&&(i.target&e.target&&-1!==t.indexOf(i)||e._terminalBlocks.has(i))&&this._processBuild(i,e,r,t)}this._postBuildBlock(e);for(const i of this._outputs)if(i._forPostBuild&&i.target&e.target)for(const r of i.endpoints){const i=r.ownerBlock;i&&i.target&e.target&&-1!==t.indexOf(i)&&this._processBuild(i,e,r,t)}return!1}_inputRename(e){return e}_outputRename(e){return e}_dumpPropertiesCode(){const e=this._codeVariableName;return`${e}.visibleInInspector = ${this.visibleInInspector};\n${e}.visibleOnFrame = ${this.visibleOnFrame};\n${e}.target = ${this.target};\n`}_dumpCode(e,t){t.push(this);const i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,-1!==e.indexOf(this._codeVariableName)){let t=0;do{t++,this._codeVariableName=i+t}while(-1!==e.indexOf(this._codeVariableName))}e.push(this._codeVariableName);let r=`\n// ${this.getClassName()}\n`;this.comments&&(r+=`// ${this.comments}\n`),r+=`var ${this._codeVariableName} = new BABYLON.${this.getClassName()}("${this.name}");\n`,r+=this._dumpPropertiesCode();for(const i of this.inputs){if(!i.isConnected)continue;const s=i.connectedPoint.ownerBlock;-1===t.indexOf(s)&&(r+=s._dumpCode(e,t))}for(const i of this.outputs)if(i.hasEndpoints)for(const s of i.endpoints){const i=s.ownerBlock;i&&-1===t.indexOf(i)&&(r+=i._dumpCode(e,t))}return r}_dumpCodeForOutputConnections(e){let t="";if(-1!==e.indexOf(this))return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const r=i.connectedPoint,s=r.ownerBlock;t+=s._dumpCodeForOutputConnections(e),t+=`${s._codeVariableName}.${s._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});\n`}return t}clone(e,t=""){const i=this.serialize(),r=(0,a.n9)(i.customType);if(r){const s=new r;return s._deserialize(i,e,t),s}return null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.comments=this.comments,e.visibleInInspector=this.visibleInInspector,e.visibleOnFrame=this.visibleOnFrame,e.target=this.target,e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e,t,i,r){this.name=e.name,this.comments=e.comments,this.visibleInInspector=!!e.visibleInInspector,this.visibleOnFrame=!!e.visibleOnFrame,this._target=e.target??this.target,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;t&&t.forEach(((e,t)=>{e.displayName&&(this.inputs[t].displayName=e.displayName),e.isExposedOnFrame&&(this.inputs[t].isExposedOnFrame=e.isExposedOnFrame,this.inputs[t].exposedPortPosition=e.exposedPortPosition)})),i&&i.forEach(((e,t)=>{e.displayName&&(this.outputs[t].displayName=e.displayName),e.isExposedOnFrame&&(this.outputs[t].isExposedOnFrame=e.isExposedOnFrame,this.outputs[t].exposedPortPosition=e.exposedPortPosition)}))}dispose(){this.onCodeIsReadyObservable.clear();for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose()}}class Ad extends Ed{get transformAsDirection(){return 0===this.complementW}set transformAsDirection(e){this.complementW=e?0:1}constructor(e){super(e,gd.Neutral),this.complementW=1,this.complementZ=0,this.target=gd.Vertex,this.registerInput("vector",_d.AutoDetect),this.registerInput("transform",_d.Matrix),this.registerOutput("output",_d.Vector4),this.registerOutput("xyz",_d.Vector3),this._inputs[0].onConnectionObservable.add((e=>{if(e.ownerBlock.isInput){const t=e.ownerBlock;"normal"!==t.name&&"tangent"!==t.name||(this.complementW=0)}}))}getClassName(){return"TransformBlock"}get vector(){return this._inputs[0]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}get transform(){return this._inputs[1]}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.transform,r=e._getShaderType(_d.Vector4),s=e._getShaderType(_d.Vector3);if(t.connectedPoint){if(0===this.complementW||this.transformAsDirection){const n=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",n),e.sharedData.blocksWithDefines.push(this);const o=e._getFreeVariableName(`${i.associatedVariableName}_NUS`);switch(1===e.shaderLanguage?e.compilationString+=`var ${o}: mat3x3f = mat3x3f(${i.associatedVariableName}[0].xyz, ${i.associatedVariableName}[1].xyz, ${i.associatedVariableName}[2].xyz);\n`:e.compilationString+=`mat3 ${o} = mat3(${i.associatedVariableName});\n`,e.compilationString+="#ifdef NONUNIFORMSCALING\n",e.compilationString+=`${o} = transposeMat3(inverseMat3(${o}));\n`,e.compilationString+="#endif\n",t.connectedPoint.type){case _d.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${o} * ${s}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}), ${this._writeFloat(this.complementW)});\n`;break;case _d.Vector3:case _d.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${o} * ${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\n`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${o} * ${t.associatedVariableName}.xyz, ${this._writeFloat(this.complementW)});\n`}}else{const s=i.associatedVariableName;switch(t.connectedPoint.type){case _d.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${s} * ${r}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}, ${this._writeFloat(this.complementW)});\n`;break;case _d.Vector3:case _d.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${s} * ${r}(${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\n`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${s} * ${t.associatedVariableName};\n`}}this.xyz.hasEndpoints&&(e.compilationString+=e._declareOutput(this.xyz)+` = ${this.output.associatedVariableName}.xyz;\n`)}return this}prepareDefines(e,t,i){e.nonUniformScaling&&i.setValue("NONUNIFORMSCALING",!0)}serialize(){const e=super.serialize();return e.complementZ=this.complementZ,e.complementW=this.complementW,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.complementZ=void 0!==e.complementZ?e.complementZ:0,this.complementW=void 0!==e.complementW?e.complementW:1}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.complementZ = ${this.complementZ};\n`;return e+=`${this._codeVariableName}.complementW = ${this.complementW};\n`,e}}(0,Ge.Cg)([xh("Transform as direction",0,void 0,{embedded:!0})],Ad.prototype,"transformAsDirection",null),(0,a.Y5)("BABYLON.TransformBlock",Ad);class Id extends Ed{constructor(e){super(e,gd.Vertex,!0),this.registerInput("vector",_d.Vector4)}getClassName(){return"VertexOutputBlock"}get vector(){return this._inputs[0]}_isLogarithmicDepthEnabled(e,t){if(t)return!0;for(const t of e)if(t.useLogarithmicDepth)return!0;return!1}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=1===e.shaderLanguage;if(1===e.shaderLanguage?e.compilationString+=`vertexOutputs.position = ${t.associatedVariableName};\n`:e.compilationString+=`gl_Position = ${t.associatedVariableName};\n`,this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes,e.sharedData.nodeMaterial.useLogarithmicDepth)){e._emitUniformFromString("logarithmicDepthConstant",_d.Float),e._emitVaryingFromString("vFragmentDepth",_d.Float);const t=i?"vertexOutputs.vFragmentDepth":"vFragmentDepth",r=i?"uniforms.":"",s=i?"vertexOutputs.position":"gl_Position";e.compilationString+=`${t} = 1.0 + ${s}.w;\n`,e.compilationString+=`${s}.z = log2(max(0.000001, ${t})) * ${r}logarithmicDepthConstant;\n`}return this}}(0,a.Y5)("BABYLON.VertexOutputBlock",Id),function(e){e[e.NoColorSpace=0]="NoColorSpace",e[e.Gamma=1]="Gamma",e[e.Linear=2]="Linear"}(Sd||(Sd={}));class Rd extends Ed{constructor(e){super(e,gd.Fragment,!0,!0),this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.useLogarithmicDepth=!1,this.registerInput("rgba",_d.Color4,!0),this.registerInput("rgb",_d.Color3,!0),this.registerInput("a",_d.Float,!0),this.registerInput("glow",_d.Color3,!0),this.rgb.acceptedConnectionPointTypes.push(_d.Vector3),this.rgb.acceptedConnectionPointTypes.push(_d.Float),this.additionalColor.acceptedConnectionPointTypes.push(_d.Vector3),this.additionalColor.acceptedConnectionPointTypes.push(_d.Float)}get colorSpace(){return this.convertToGammaSpace?Sd.Gamma:this.convertToLinearSpace?Sd.Linear:Sd.NoColorSpace}set colorSpace(e){this.convertToGammaSpace=e===Sd.Gamma,this.convertToLinearSpace=e===Sd.Linear}getClassName(){return"FragmentOutputBlock"}initialize(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")}get rgba(){return this._inputs[0]}get rgb(){return this._inputs[1]}get a(){return this._inputs[2]}get additionalColor(){return this._inputs[3]}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToLinearSpace,!0),i.setValue(this._gammaDefineName,this.convertToGammaSpace,!0),i.setValue(this._additionalColorDefineName,this.additionalColor.connectedPoint&&t._useAdditionalColor,!0)}bind(e,t,i){(this.useLogarithmicDepth||t.useLogarithmicDepth)&&i&&(0,ts.DL)(void 0,e,i.getScene())}_buildBlock(e){super._buildBlock(e);const t=this.rgba,i=this.rgb,r=this.a,s=this.additionalColor,n=1===e.shaderLanguage;e.sharedData.hints.needAlphaBlending=t.isConnected||r.isConnected,e.sharedData.blocksWithDefines.push(this),(this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth)&&(e._emitUniformFromString("logarithmicDepthConstant",_d.Float),e._emitVaryingFromString("vFragmentDepth",_d.Float),e.sharedData.bindableBlocks.push(this)),s.connectedPoint&&(e._excludeVariableName("useAdditionalColor"),e._emitUniformFromString("useAdditionalColor",_d.Float),this._additionalColorDefineName=e._getFreeDefineName("USEADDITIONALCOLOR")),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");const o=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",o);let a="gl_FragColor";1===e.shaderLanguage&&(e.compilationString+="var fragmentOutputsColor : vec4<f32>;\r\n",a="fragmentOutputsColor");const l=e._getShaderType(_d.Vector4);if(s.connectedPoint){let t="1.0";r.connectedPoint&&(t=r.associatedVariableName),e.compilationString+=`#ifdef ${this._additionalColorDefineName}\n`,s.connectedPoint.type===_d.Float?e.compilationString+=`${a}  = ${l}(${s.associatedVariableName}, ${s.associatedVariableName}, ${s.associatedVariableName}, ${t});\n`:e.compilationString+=`${a}  = ${l}(${s.associatedVariableName}, ${t});\n`,e.compilationString+="#else\n"}if(t.connectedPoint)r.isConnected?e.compilationString+=`${a} = ${l}(${t.associatedVariableName}.rgb, ${r.associatedVariableName});\n`:e.compilationString+=`${a}  = ${t.associatedVariableName};\n`;else if(i.connectedPoint){let t="1.0";r.connectedPoint&&(t=r.associatedVariableName),i.connectedPoint.type===_d.Float?e.compilationString+=`${a}  = ${l}(${i.associatedVariableName}, ${i.associatedVariableName}, ${i.associatedVariableName}, ${t});\n`:e.compilationString+=`${a}  = ${l}(${i.associatedVariableName}, ${t});\n`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(t);if(s.connectedPoint&&(e.compilationString+="#endif\n"),e.compilationString+=`#ifdef ${this._linearDefineName}\n`,e.compilationString+=`${a}  = toLinearSpace(${a});\n`,e.compilationString+="#endif\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\n`,e.compilationString+=`${a}  = toGammaSpace(${a});\n`,e.compilationString+="#endif\n",1===e.shaderLanguage&&(e.compilationString+="#if !defined(PREPASS)\r\n",e.compilationString+="fragmentOutputs.color = fragmentOutputsColor;\r\n",e.compilationString+="#endif\r\n"),this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth){const t=n?"input.vFragmentDepth":"vFragmentDepth",i=n?"uniforms.":"",r=n?"fragmentOutputs.fragDepth":"gl_FragDepthEXT";e.compilationString+=`${r} = log2(${t}) * ${i}logarithmicDepthConstant * 0.5;\n`}return e.compilationString+="#if defined(PREPASS)\r\n",e.compilationString+=`${n?"fragmentOutputs.fragData0":"gl_FragData[0]"} = ${a};\r\n`,e.compilationString+="#endif\r\n",this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\n`,e+=`${this._codeVariableName}.useLogarithmicDepth = ${this.useLogarithmicDepth};\n`,e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.useLogarithmicDepth=e.useLogarithmicDepth??!1}}(0,Ge.Cg)([xh("Use logarithmic depth",0,"PROPERTIES",{embedded:!0})],Rd.prototype,"useLogarithmicDepth",void 0),(0,Ge.Cg)([xh("Color space",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"No color space",value:Sd.NoColorSpace},{label:"Gamma",value:Sd.Gamma},{label:"Linear",value:Sd.Linear}]})],Rd.prototype,"colorSpace",null),(0,a.Y5)("BABYLON.FragmentOutputBlock",Rd),function(e){e[e.World=1]="World",e[e.View=2]="View",e[e.Projection=3]="Projection",e[e.ViewProjection=4]="ViewProjection",e[e.WorldView=5]="WorldView",e[e.WorldViewProjection=6]="WorldViewProjection",e[e.CameraPosition=7]="CameraPosition",e[e.FogColor=8]="FogColor",e[e.DeltaTime=9]="DeltaTime",e[e.CameraParameters=10]="CameraParameters",e[e.MaterialAlpha=11]="MaterialAlpha"}(bd||(bd={})),function(e){e[e.None=0]="None",e[e.Time=1]="Time",e[e.RealTime=2]="RealTime",e[e.MouseInfo=3]="MouseInfo"}(yd||(yd={}));var Md=i(76237);const Dd={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},Od={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},Nd={particle_texturemask:!0},wd={normal:"NORMAL",tangent:"TANGENT",uv:"UV1",uv2:"UV2",uv3:"UV3",uv4:"UV4",uv5:"UV5",uv6:"UV6",uv7:"UV7",uv8:"UV8"};class Fd extends Ed{get type(){if(this._type===_d.AutoDetect){if(this.isUniform&&null!=this.value){if(!isNaN(this.value))return this._type=_d.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=_d.Vector2,this._type;case"Vector3":return this._type=_d.Vector3,this._type;case"Vector4":return this._type=_d.Vector4,this._type;case"Color3":return this._type=_d.Color3,this._type;case"Color4":return this._type=_d.Color4,this._type;case"Matrix":return this._type=_d.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"splatIndex":return this._type=_d.Float,this._type;case"position":case"normal":case"particle_positionw":case"splatPosition":return this._type=_d.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":case"splatScale":return this._type=_d.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"matricesIndicesExtra":case"matricesWeightsExtra":case"world0":case"world1":case"world2":case"world3":case"tangent":return this._type=_d.Vector4,this._type;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":case"splatColor":return this._type=_d.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case bd.World:case bd.WorldView:case bd.WorldViewProjection:case bd.View:case bd.ViewProjection:case bd.Projection:return this._type=_d.Matrix,this._type;case bd.CameraPosition:return this._type=_d.Vector3,this._type;case bd.FogColor:return this._type=_d.Color3,this._type;case bd.DeltaTime:case bd.MaterialAlpha:return this._type=_d.Float,this._type;case bd.CameraParameters:return this._type=_d.Vector4,this._type}}return this._type}constructor(e,t=gd.Vertex,i=_d.AutoDetect){super(e,t,!1),this._mode=3,this._animationType=yd.None,this._prefix="",this.min=0,this.max=0,this.isBoolean=!1,this.matrixMode=0,this._systemValue=null,this.isConstant=!1,this.groupInInspector="",this.onValueChangedObservable=new s.cP,this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._type=i,this.setDefaultValue(),this.registerOutput("output",i)}validateBlockName(e){return!!this.isAttribute||super.validateBlockName(e)}get output(){return this._outputs[0]}setAsAttribute(e){return this._mode=1,e&&(this.name=e),this}setAsSystemValue(e){return this.systemValue=e,this}get value(){return this._storedValue}set value(e){this.type===_d.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=0,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e,this._mode=0}get declarationVariableName(){return this._associatedVariableName}get associatedVariableName(){return this._prefix+this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get animationType(){return this._animationType}set animationType(e){this._animationType=e}get isUndefined(){return 3===this._mode}get isUniform(){return 0===this._mode}set isUniform(e){this._mode=e?0:3,this.associatedVariableName=""}get isAttribute(){return 1===this._mode}set isAttribute(e){this._mode=e?1:3,this.associatedVariableName=""}get isVarying(){return 2===this._mode}set isVarying(e){this._mode=e?2:3,this.associatedVariableName=""}get isSystemValue(){return null!=this._systemValue}get systemValue(){return this._systemValue}set systemValue(e){this._mode=0,this.associatedVariableName="",this._systemValue=e}getClassName(){return"InputBlock"}animate(e){switch(this._animationType){case yd.Time:this.type===_d.Float&&(this.value+=.01*e.getAnimationRatio());break;case yd.RealTime:this.type===_d.Float&&(this.value=(Md.j.Now-e.getEngine().startTime)/1e3);break;case yd.MouseInfo:if(this.type===_d.Vector4){const t=e._inputManager._originMouseEvent;if(t){const e=t.offsetX,i=t.offsetY,r=1&t.buttons?1:0,s=2&t.buttons?1:0;this.value=new n.IU(e,i,r,s)}else this.value=new n.IU(0,0,0,0)}}}_emitDefine(e){return"!"===e[0]?`#ifndef ${e.substring(1)}\n`:`#ifdef ${e}\n`}initialize(){this.associatedVariableName=""}setDefaultValue(){switch(this.type){case _d.Float:this.value=0;break;case _d.Vector2:this.value=n.I9.Zero();break;case _d.Vector3:this.value=n.Pq.Zero();break;case _d.Vector4:this.value=n.IU.Zero();break;case _d.Color3:this.value=ku.v9.White();break;case _d.Color4:this.value=new ku.ov(1,1,1,1);break;case _d.Matrix:this.value=n.uq.Identity()}}_emitConstant(e){switch(this.type){case _d.Float:return`${e._emitFloat(this.value)}`;case _d.Vector2:return`vec2(${this.value.x}, ${this.value.y})`;case _d.Vector3:return`vec3(${this.value.x}, ${this.value.y}, ${this.value.z})`;case _d.Vector4:return`vec4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;case _d.Color3:return ku.IG.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&ku.IG.Color3[0].toGammaSpaceToRef(ku.IG.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&ku.IG.Color3[0].toLinearSpaceToRef(ku.IG.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec3(${ku.IG.Color3[0].r}, ${ku.IG.Color3[0].g}, ${ku.IG.Color3[0].b})`;case _d.Color4:return ku.IG.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&ku.IG.Color4[0].toGammaSpaceToRef(ku.IG.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&ku.IG.Color4[0].toLinearSpaceToRef(ku.IG.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec4(${ku.IG.Color4[0].r}, ${ku.IG.Color4[0].g}, ${ku.IG.Color4[0].b}, ${ku.IG.Color4[0].a})`}return""}get _noContextSwitch(){return Od[this.name]}_emit(e,t){if(this.isUniform){if(this._associatedVariableName||(this._associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(-1!==e.constants.indexOf(this.associatedVariableName))return;return e.constants.push(this.associatedVariableName),void(e._constantDeclaration+=e._declareOutput(this.output,!0)+` = ${this._emitConstant(e)};\n`)}if(-1!==e.uniforms.indexOf(this.associatedVariableName))return;e.uniforms.push(this.associatedVariableName),t&&(e._uniformDeclaration+=this._emitDefine(t));const i=e._getShaderType(this.type);1===e.shaderLanguage?(e._uniformDeclaration+=`uniform ${this._associatedVariableName}: ${i};\n`,this._prefix="uniforms."):e._uniformDeclaration+=`uniform ${i} ${this.associatedVariableName};\n`,t&&(e._uniformDeclaration+="#endif\n");const r=e.sharedData.hints;if(null!==this._systemValue&&void 0!==this._systemValue)switch(this._systemValue){case bd.WorldView:r.needWorldViewMatrix=!0;break;case bd.WorldViewProjection:r.needWorldViewProjectionMatrix=!0}else this._animationType!==yd.None&&e.sharedData.animatedInputs.push(this)}else if(this.isAttribute){if(this.associatedVariableName=Dd[this.name]??this.name,this.target===gd.Vertex&&e._vertexState)return void(Od[this.name]?Nd[this.name]?(e._emitUniformFromString(this.declarationVariableName,this.type,t),1===e.shaderLanguage&&(this._prefix="vertexInputs.")):e._emitVaryingFromString(this.declarationVariableName,this.type,t):this._emit(e._vertexState,t));const i=-1!==e.attributes.indexOf(this.declarationVariableName);if(i||e.attributes.push(this.declarationVariableName),Od[this.name])Nd[this.name]?(i||e._emitUniformFromString(this.declarationVariableName,this.type,t),1===e.shaderLanguage&&(this._prefix="uniforms.")):(i||e._emitVaryingFromString(this.declarationVariableName,this.type,t),1===e.shaderLanguage&&(this._prefix="fragmentInputs."));else{if(t&&!i&&(e._attributeDeclaration+=this._emitDefine(t)),1===e.shaderLanguage){if(!i){const t=wd[this.name];t?(e._attributeDeclaration+=`#ifdef ${t}\n`,e._attributeDeclaration+=`attribute ${this.declarationVariableName}: ${e._getShaderType(this.type)};\n`,e._attributeDeclaration+="#else\n",e._attributeDeclaration+=`let ${this.declarationVariableName}: ${e._getShaderType(this.type)} = ${e._getShaderType(this.type)}(0.);\n`,e._attributeDeclaration+="#endif\n"):e._attributeDeclaration+=`attribute ${this.declarationVariableName}: ${e._getShaderType(this.type)};\n`}this._prefix="vertexInputs."}else if(!i){const t=wd[this.name];t?(e._attributeDeclaration+=`#ifdef ${t}\n`,e._attributeDeclaration+=`attribute ${e._getShaderType(this.type)} ${this.declarationVariableName};\n`,e._attributeDeclaration+="#else\n",e._attributeDeclaration+=`${e._getShaderType(this.type)} ${this.declarationVariableName} = ${e._getShaderType(this.type)}(0.);\n`,e._attributeDeclaration+="#endif\n"):e._attributeDeclaration+=`attribute ${e._getShaderType(this.type)} ${this.declarationVariableName};\n`}t&&!i&&(e._attributeDeclaration+="#endif\n")}}}_transmitWorld(e,t,i,r){if(!this._systemValue)return;const s=this._associatedVariableName;switch(this._systemValue){case bd.World:e.setMatrix(s,t);break;case bd.WorldView:e.setMatrix(s,i);break;case bd.WorldViewProjection:e.setMatrix(s,r)}}_transmit(e,t,i){if(this.isAttribute)return;const r=this._associatedVariableName;if(this._systemValue){switch(this._systemValue){case bd.World:case bd.WorldView:case bd.WorldViewProjection:return;case bd.View:e.setMatrix(r,t.getViewMatrix());break;case bd.Projection:e.setMatrix(r,t.getProjectionMatrix());break;case bd.ViewProjection:e.setMatrix(r,t.getTransformMatrix());break;case bd.CameraPosition:t.bindEyePosition(e,r,!0);break;case bd.FogColor:e.setColor3(r,t.fogColor);break;case bd.DeltaTime:e.setFloat(r,t.deltaTime/1e3);break;case bd.CameraParameters:t.activeCamera&&e.setFloat4(r,t.getEngine().hasOriginBottomLeft?-1:1,t.activeCamera.minZ,t.activeCamera.maxZ,1/t.activeCamera.maxZ);break;case bd.MaterialAlpha:e.setFloat(r,i.alpha)}return}const s=this._valueCallback?this._valueCallback():this._storedValue;if(null!==s)switch(this.type){case _d.Float:e.setFloat(r,s);break;case _d.Int:e.setInt(r,s);break;case _d.Color3:ku.IG.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&ku.IG.Color3[0].toGammaSpaceToRef(ku.IG.Color3[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&ku.IG.Color3[0].toLinearSpaceToRef(ku.IG.Color3[0],t.getEngine().useExactSrgbConversions),e.setColor3(r,ku.IG.Color3[0]);break;case _d.Color4:ku.IG.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&ku.IG.Color4[0].toGammaSpaceToRef(ku.IG.Color4[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&ku.IG.Color4[0].toLinearSpaceToRef(ku.IG.Color4[0],t.getEngine().useExactSrgbConversions),e.setDirectColor4(r,ku.IG.Color4[0]);break;case _d.Vector2:e.setVector2(r,s);break;case _d.Vector3:e.setVector3(r,s);break;case _d.Vector4:e.setVector4(r,s);break;case _d.Matrix:e.setMatrix(r,s)}}_buildBlock(e){super._buildBlock(e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)}_dumpPropertiesCode(){const e=this._codeVariableName;if(this.isAttribute)return super._dumpPropertiesCode()+`${e}.setAsAttribute("${this.name}");\n`;if(this.isSystemValue)return super._dumpPropertiesCode()+`${e}.setAsSystemValue(BABYLON.NodeMaterialSystemValues.${bd[this._systemValue]});\n`;if(this.isUniform){const t=[];let i="";switch(this.type){case _d.Float:i=`${this.value}`;break;case _d.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case _d.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case _d.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break;case _d.Color3:i=`new BABYLON.Color3(${this.value.r}, ${this.value.g}, ${this.value.b})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case _d.Color4:i=`new BABYLON.Color4(${this.value.r}, ${this.value.g}, ${this.value.b}, ${this.value.a})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case _d.Matrix:i=`BABYLON.Matrix.FromArray([${this.value.m}])`}return t.push(`${e}.value = ${i}`),this.type===_d.Float&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`,`${e}.isBoolean = ${this.isBoolean}`,`${e}.matrixMode = ${this.matrixMode}`,`${e}.animationType = BABYLON.AnimatedInputBlockTypes.${yd[this.animationType]}`),t.push(`${e}.isConstant = ${this.isConstant}`),t.push(""),super._dumpPropertiesCode()+t.join(";\n")}return super._dumpPropertiesCode()}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){const e=super.serialize();return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,null!=this._storedValue&&0===this._mode&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e,t,i){if(this._mode=e.mode,super._deserialize(e,t,i),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,"tangent"===e.name&&1===e.mode&&e.type===_d.Vector3&&(this._type=_d.Vector4),e.valueType)if("number"===e.valueType)this._storedValue=e.value;else{const t=(0,a.n9)(e.valueType);t&&(this._storedValue=t.FromArray(e.value))}}}(0,a.Y5)("BABYLON.InputBlock",Fd);class Bd extends Ed{constructor(e){super(e,gd.VertexAndFragment),this._samplerName="textureSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",_d.AutoDetect,!1,gd.VertexAndFragment),this.registerOutput("rgba",_d.Color4,gd.Neutral),this.registerOutput("rgb",_d.Color3,gd.Neutral),this.registerOutput("r",_d.Float,gd.Neutral),this.registerOutput("g",_d.Float,gd.Neutral),this.registerOutput("b",_d.Float,gd.Neutral),this.registerOutput("a",_d.Float,gd.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(_d.Vector2|_d.Vector3|_d.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"CurrentScreenBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName(this._samplerName)}get target(){return this.uv.isConnected?this.uv.sourceBlock.isInput?gd.VertexAndFragment:gd.Fragment:gd.VertexAndFragment}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput){t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,_d.Vector2)}if(this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,_d.Vector2),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\n`,this._outputs.some((e=>e.isConnectedInVertexShader))){this._writeTextureRead(e,!0);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,t.name,!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===gd.Fragment)return;const t=0===e.shaderLanguage?`texture2D(${this._samplerName},`:`textureSampleLevel(${this._samplerName}, ${this._samplerName+"Sampler"},`,r=0===e.shaderLanguage?"":", 0";return void(e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,_d.Vector4)} = ${t} ${i.associatedVariableName}${r});\n`)}const r=0===e.shaderLanguage?`texture2D(${this._samplerName},`:`textureSample(${this._samplerName}, ${this._samplerName+"Sampler"},`;this.uv.ownerBlock.target!==gd.Fragment?e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,_d.Vector4)} = ${r} ${this._mainUVName});\n`:e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,_d.Vector4)} = ${r} ${i.associatedVariableName});\n`}_writeOutput(e,t,i,r=!1){if(r){if(e.target===gd.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`}else this.uv.ownerBlock.target!==gd.Fragment?(e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`,e.compilationString+=`#ifdef ${this._linearDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n"):e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`}_buildBlock(e){if(super._buildBlock(e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),e.target!==gd.Fragment)return e._emit2DSampler(this._samplerName),void this._injectVertexCode(e);if(!this._outputs.some((e=>e.isConnectedInFragmentShader)))return;e._emit2DSampler(this._samplerName),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,t.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=$e.g.Parse(e.texture,t,i))}}(0,a.Y5)("BABYLON.CurrentScreenBlock",Bd);class Vd extends Ed{constructor(e){super(e,gd.Fragment),this._samplerName="diffuseSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",_d.AutoDetect,!1,gd.VertexAndFragment),this.registerOutput("rgba",_d.Color4,gd.Neutral),this.registerOutput("rgb",_d.Color3,gd.Neutral),this.registerOutput("r",_d.Float,gd.Neutral),this.registerOutput("g",_d.Float,gd.Neutral),this.registerOutput("b",_d.Float,gd.Neutral),this.registerOutput("a",_d.Float,gd.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(_d.Vector2|_d.Vector3|_d.Vector4)}getClassName(){return"ParticleTextureBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("diffuseSampler")}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"particle_uv"===e.name&&t(e)));i||(i=new Fd("uv"),i.setAsAttribute("particle_uv")),i.output.connectTo(this.uv)}}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_writeOutput(e,t,i){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`,e.compilationString+=`#ifdef ${this._linearDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n"}_buildBlock(e){if(super._buildBlock(e),e.target===gd.Vertex)return;this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,_d.Vector4)} = ${e._generateTextureSample(this.uv.associatedVariableName,this._samplerName)};\n`;for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,t.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=$e.g.Parse(e.texture,t,i))}}(0,a.Y5)("BABYLON.ParticleTextureBlock",Vd);class Ld extends Ed{constructor(e){super(e,gd.Fragment),this._isUnique=!0,this.registerInput("color",_d.Color4,!1,gd.Fragment),this.registerOutput("rampColor",_d.Color4,gd.Fragment)}getClassName(){return"ParticleRampGradientBlock"}get color(){return this._inputs[0]}get rampColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor")}_buildBlock(e){if(super._buildBlock(e),e.target===gd.Vertex)return;e._emit2DSampler("rampSampler","RAMPGRADIENT"),e._emitVaryingFromString("remapRanges",_d.Vector4,"RAMPGRADIENT");const t=0===e.shaderLanguage?"":"fragmentInputs.";return e.compilationString+=`\n            #ifdef RAMPGRADIENT\n                ${e._declareLocalVar("baseColor",_d.Vector4)} = ${this.color.associatedVariableName};\n                ${e._declareLocalVar("alpha",_d.Float)} = ${this.color.associatedVariableName}.a;\n\n                ${e._declareLocalVar("remappedColorIndex",_d.Float)} = clamp((alpha - ${t}remapRanges.x) / ${t}remapRanges.y, 0.0, 1.0);\n\n                ${e._declareLocalVar("rampColor",_d.Vector4)} = ${e._generateTextureSample("vec2(1.0 - remappedColorIndex, 0.)","rampSampler")};\n\n                // Remapped alpha\n                ${e._declareOutput(this.rampColor)} = vec4${e.fSuffix}(baseColor.rgb * rampColor.rgb, clamp((alpha * rampColor.a - ${t}remapRanges.z) / ${t}remapRanges.w, 0.0, 1.0));\n            #else\n                ${e._declareOutput(this.rampColor)} = ${this.color.associatedVariableName};\n            #endif\n        `,this}}(0,a.Y5)("BABYLON.ParticleRampGradientBlock",Ld);class kd extends Ed{constructor(e){super(e,gd.Fragment),this._isUnique=!0,this.registerInput("color",_d.Color4,!1,gd.Fragment),this.registerInput("alphaTexture",_d.Float,!1,gd.Fragment),this.registerInput("alphaColor",_d.Float,!1,gd.Fragment),this.registerOutput("blendColor",_d.Color4,gd.Fragment)}getClassName(){return"ParticleBlendMultiplyBlock"}get color(){return this._inputs[0]}get alphaTexture(){return this._inputs[1]}get alphaColor(){return this._inputs[2]}get blendColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("sourceAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==gd.Vertex)return e.compilationString+=`\n            #ifdef BLENDMULTIPLYMODE\n                ${e._declareOutput(this.blendColor)};\n                ${e._declareLocalVar("sourceAlpha",_d.Float)}  = ${this.alphaColor.associatedVariableName} * ${this.alphaTexture.associatedVariableName};\n                ${this.blendColor.associatedVariableName} = vec4${e.fSuffix}(${this.color.associatedVariableName}.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha), ${this.color.associatedVariableName}.a);\n            #else\n                ${e._declareOutput(this.blendColor)} = ${this.color.associatedVariableName};\n            #endif\n        `,this}}(0,a.Y5)("BABYLON.ParticleBlendMultiplyBlock",kd);class Gd extends Ed{constructor(e){super(e,gd.Neutral),this.xSwizzle="x",this.ySwizzle="y",this.zSwizzle="z",this.wSwizzle="w",this.registerInput("xyzw ",_d.Vector4,!0),this.registerInput("xyz ",_d.Vector3,!0),this.registerInput("xy ",_d.Vector2,!0),this.registerInput("zw ",_d.Vector2,!0),this.registerInput("x",_d.Float,!0),this.registerInput("y",_d.Float,!0),this.registerInput("z",_d.Float,!0),this.registerInput("w",_d.Float,!0),this.registerOutput("xyzw",_d.Vector4),this.registerOutput("xyz",_d.Vector3),this.registerOutput("xy",_d.Vector2),this.registerOutput("zw",_d.Vector2)}getClassName(){return"VectorMergerBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get x(){return this._inputs[4]}get y(){return this._inputs[5]}get z(){return this._inputs[6]}get w(){return this._inputs[7]}get xyzw(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xy(){return this.xyOut}get xyz(){return this.xyzOut}_inputRename(e){return"xyzw "===e?"xyzwIn":"xyz "===e?"xyzIn":"xy "===e?"xyIn":"zw "===e?"zwIn":e}_buildSwizzle(e){return"."+(this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle).substring(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.x,i=this.y,r=this.z,s=this.w,n=this.xyIn,o=this.zwIn,a=this.xyzIn,l=this.xyzwIn,h=this._outputs[0],c=this._outputs[1],u=this._outputs[2],d=this._outputs[3],p=e._getShaderType(_d.Vector4),m=e._getShaderType(_d.Vector3),f=e._getShaderType(_d.Vector2);return l.isConnected?(h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${l.associatedVariableName}${this._buildSwizzle(4)};\n`),c.hasEndpoints&&(e.compilationString+=e._declareOutput(c)+` = ${l.associatedVariableName}${this._buildSwizzle(3)};\n`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${l.associatedVariableName}${this._buildSwizzle(2)};\n`)):a.isConnected?(h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${p}(${a.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};\n`),c.hasEndpoints&&(e.compilationString+=e._declareOutput(c)+` = ${a.associatedVariableName}${this._buildSwizzle(3)};\n`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};\n`)):n.isConnected?(h.hasEndpoints&&(o.isConnected?e.compilationString+=e._declareOutput(h)+` = ${p}(${n.associatedVariableName}, ${o.associatedVariableName})${this._buildSwizzle(4)};\n`:e.compilationString+=e._declareOutput(h)+` = ${p}(${n.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};\n`),c.hasEndpoints&&(e.compilationString+=e._declareOutput(c)+` = ${m}(${n.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};\n`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${n.associatedVariableName}${this._buildSwizzle(2)};\n`),d.hasEndpoints&&(o.isConnected?e.compilationString+=e._declareOutput(d)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};\n`:e.compilationString+=e._declareOutput(d)+` = ${f}(${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(2)};\n`)):(h.hasEndpoints&&(o.isConnected?e.compilationString+=e._declareOutput(h)+` = ${p}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${o.associatedVariableName})${this._buildSwizzle(4)};\n`:e.compilationString+=e._declareOutput(h)+` = ${p}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};\n`),c.hasEndpoints&&(e.compilationString+=e._declareOutput(c)+` = ${m}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};\n`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${f}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"})${this._buildSwizzle(2)};\n`),d.hasEndpoints&&(o.isConnected?e.compilationString+=e._declareOutput(d)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};\n`:e.compilationString+=e._declareOutput(d)+` = ${f}(${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(2)};\n`)),this}serialize(){const e=super.serialize();return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.xSwizzle=e.xSwizzle??"x",this.ySwizzle=e.ySwizzle??"y",this.zSwizzle=e.zSwizzle??"z",this.wSwizzle=e.wSwizzle??"w"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.xSwizzle = "${this.xSwizzle}";\n`,e+=`${this._codeVariableName}.ySwizzle = "${this.ySwizzle}";\n`,e+=`${this._codeVariableName}.zSwizzle = "${this.zSwizzle}";\n`,e+=`${this._codeVariableName}.wSwizzle = "${this.wSwizzle}";\n`,e}}(0,a.Y5)("BABYLON.VectorMergerBlock",Gd);class zd extends Ed{constructor(e){super(e,gd.Neutral),this.sourceRange=new n.I9(-1,1),this.targetRange=new n.I9(0,1),this.registerInput("input",_d.AutoDetect),this.registerInput("sourceMin",_d.Float,!0),this.registerInput("sourceMax",_d.Float,!0),this.registerInput("targetMin",_d.Float,!0),this.registerInput("targetMax",_d.Float,!0),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"RemapBlock"}get input(){return this._inputs[0]}get sourceMin(){return this._inputs[1]}get sourceMax(){return this._inputs[2]}get targetMin(){return this._inputs[3]}get targetMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),r=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),s=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),n=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=e._declareOutput(t)+` = ${s} + (${this._inputs[0].associatedVariableName} - ${i}) * (${n} - ${s}) / (${r} - ${i});\n`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});\n`;return e+=`${this._codeVariableName}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});\n`,e}serialize(){const e=super.serialize();return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.sourceRange=n.I9.FromArray(e.sourceRange),this.targetRange=n.I9.FromArray(e.targetRange)}}(0,Ge.Cg)([xh("From",3)],zd.prototype,"sourceRange",void 0),(0,Ge.Cg)([xh("To",3)],zd.prototype,"targetRange",void 0),(0,a.Y5)("BABYLON.RemapBlock",zd);class Ud extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("left",_d.AutoDetect),this.registerInput("right",_d.AutoDetect),this.registerOutput("output",_d.BasedOnInput),this.output._typeConnectionSource=this.left,this._linkConnectionTypes(0,1,!0),this.left.acceptedConnectionPointTypes.push(_d.Float),this.right.acceptedConnectionPointTypes.push(_d.Float),this._connectionObservers=[this.left.onTypeChangedObservable.add((()=>this._updateInputOutputTypes())),this.right.onTypeChangedObservable.add((()=>this._updateInputOutputTypes()))]}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_updateInputOutputTypes(){if(this.output._typeConnectionSource=this.left,this.left.isConnected&&this.right.isConnected?(this.left.type===_d.Int||this.left.type===_d.Float&&this.right.type!==_d.Int)&&(this.output._typeConnectionSource=this.right):this.left.isConnected!==this.right.isConnected&&(this.output._typeConnectionSource=this.left.isConnected?this.left:this.right),this.left.isConnected||this.right.isConnected)for(const[e,t]of[[this.left,this.right],[this.right,this.left]])e.acceptedConnectionPointTypes=[_d.Int,_d.Float],t.isConnected&&(e.acceptedConnectionPointTypes.push(t.type),t.type!==_d.Int&&t.type!==_d.Float||e.acceptedConnectionPointTypes.push(_d.Vector2,_d.Vector3,_d.Vector4,_d.Color3,_d.Color4,_d.Matrix))}dispose(){super.dispose(),this._connectionObservers.forEach((e=>e.remove())),this._connectionObservers.length=0}}class Wd extends Ud{constructor(e){super(e)}getClassName(){return"MultiplyBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} * ${this.right.associatedVariableName};\n`,this}}var Hd;(0,a.Y5)("BABYLON.MultiplyBlock",Wd),function(e){e[e.Material=0]="Material",e[e.PostProcess=1]="PostProcess",e[e.Particle=2]="Particle",e[e.ProceduralTexture=3]="ProceduralTexture",e[e.GaussianSplatting=4]="GaussianSplatting"}(Hd||(Hd={}));class $d extends Hu.M{constructor(){super(),this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.EXPOSURE=!1,this.SKIPFINALCOLORCLAMP=!1,this.rebuild()}}class qd{get noiseTexture(){return this._noiseTexture}set noiseTexture(e){this._noiseTexture!==e&&(this._noiseTexture=e,this._reset())}get isAnimationSheetEnabled(){return this._isAnimationSheetEnabled}set isAnimationSheetEnabled(e){this._isAnimationSheetEnabled!=e&&(this._isAnimationSheetEnabled=e,this._reset())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported}getScene(){return this._scene}_hasTargetStopDurationDependantGradient(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0}getDragGradients(){return this._dragGradients}getLimitVelocityGradients(){return this._limitVelocityGradients}getColorGradients(){return this._colorGradients}getSizeGradients(){return this._sizeGradients}getColorRemapGradients(){return this._colorRemapGradients}getAlphaRemapGradients(){return this._alphaRemapGradients}getLifeTimeGradients(){return this._lifeTimeGradients}getAngularSpeedGradients(){return this._angularSpeedGradients}getVelocityGradients(){return this._velocityGradients}getStartSizeGradients(){return this._startSizeGradients}getEmitRateGradients(){return this._emitRateGradients}get direction1(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:n.Pq.Zero()}set direction1(e){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=e)}get direction2(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:n.Pq.Zero()}set direction2(e){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=e)}get minEmitBox(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:n.Pq.Zero()}set minEmitBox(e){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=e)}get maxEmitBox(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:n.Pq.Zero()}set maxEmitBox(e){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=e)}get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._reset())}get isBillboardBased(){return this._isBillboardBased}set isBillboardBased(e){this._isBillboardBased!==e&&(this._isBillboardBased=e,this._reset())}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(!e&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=e)}_reset(){}_removeGradientAndTexture(e,t,i){if(!t)return this;let r=0;for(const i of t){if(i.gradient===e){t.splice(r,1);break}r++}return i&&i.dispose(),this}constructor(e){this.animations=[],this.renderingGroupId=0,this.emitter=n.Pq.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this.applyFog=!1,this._wasDispatched=!1,this._rootUrl="",this.noiseStrength=new n.Pq(10,10,10),this.onAnimationEnd=null,this.blendMode=qd.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new n.I9(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new n.Pq(0,0,0),this._useLogarithmicDepth=!1,this.gravity=n.Pq.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new o.ov(1,1,1,1),this.color2=new o.ov(1,1,1,1),this.colorDead=new o.ov(0,0,0,1),this.textureMask=new o.ov(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new $d,this.id=e,this.name=e}createPointEmitter(e,t){throw new Error("Method not implemented.")}createHemisphericEmitter(e=1,t=1){throw new Error("Method not implemented.")}createSphereEmitter(e=1,t=1){throw new Error("Method not implemented.")}createDirectedSphereEmitter(e=1,t=new n.Pq(0,1,0),i=new n.Pq(0,1,0)){throw new Error("Method not implemented.")}createCylinderEmitter(e=1,t=1,i=1,r=0){throw new Error("Method not implemented.")}createDirectedCylinderEmitter(e=1,t=1,i=1,r=new n.Pq(0,1,0),s=new n.Pq(0,1,0)){throw new Error("Method not implemented.")}createConeEmitter(e=1,t=Math.PI/4){throw new Error("Method not implemented.")}createDirectedConeEmitter(e=1,t=Math.PI/4,i=new n.Pq(0,1,0),r=new n.Pq(0,1,0)){throw new Error("Method not implemented.")}createBoxEmitter(e,t,i,r){throw new Error("Method not implemented.")}}qd.BLENDMODE_ONEONE=0,qd.BLENDMODE_STANDARD=1,qd.BLENDMODE_ADD=2,qd.BLENDMODE_MULTIPLY=3,qd.BLENDMODE_MULTIPLYADD=4,(0,a.Y5)("BABYLON.BaseParticleSystem",qd);class Yd extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("rgba",_d.Color4,!0),this.registerInput("rgb ",_d.Color3,!0),this.registerOutput("rgb",_d.Color3),this.registerOutput("r",_d.Float),this.registerOutput("g",_d.Float),this.registerOutput("b",_d.Float),this.registerOutput("a",_d.Float),this.inputsAreExclusive=!0}getClassName(){return"ColorSplitterBlock"}get rgba(){return this._inputs[0]}get rgbIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get r(){return this._outputs[1]}get g(){return this._outputs[2]}get b(){return this._outputs[3]}get a(){return this._outputs[4]}_inputRename(e){return"rgb "===e?"rgbIn":e}_outputRename(e){return"rgb"===e?"rgbOut":e}_buildBlock(e){super._buildBlock(e);const t=this.rgba.isConnected?this.rgba:this.rgbIn;if(!t.isConnected)return;const i=this._outputs[0],r=this._outputs[1],s=this._outputs[2],n=this._outputs[3],o=this._outputs[4];return i.hasEndpoints&&(e.compilationString+=e._declareOutput(i)+` = ${t.associatedVariableName}.rgb;\n`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName}.r;\n`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${t.associatedVariableName}.g;\n`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${t.associatedVariableName}.b;\n`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${t.associatedVariableName}.a;\n`),this}}(0,a.Y5)("BABYLON.ColorSplitterBlock",Yd);var Xd,jd=i(48963);!function(e){e[e.Cos=0]="Cos",e[e.Sin=1]="Sin",e[e.Abs=2]="Abs",e[e.Exp=3]="Exp",e[e.Exp2=4]="Exp2",e[e.Round=5]="Round",e[e.Floor=6]="Floor",e[e.Ceiling=7]="Ceiling",e[e.Sqrt=8]="Sqrt",e[e.Log=9]="Log",e[e.Tan=10]="Tan",e[e.ArcTan=11]="ArcTan",e[e.ArcCos=12]="ArcCos",e[e.ArcSin=13]="ArcSin",e[e.Fract=14]="Fract",e[e.Sign=15]="Sign",e[e.Radians=16]="Radians",e[e.Degrees=17]="Degrees",e[e.Set=18]="Set"}(Xd||(Xd={}));class Zd extends Ed{constructor(e){super(e,gd.Neutral),this.operation=Xd.Cos,this.registerInput("input",_d.AutoDetect),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"TrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="";switch(this.operation){case Xd.Cos:i="cos";break;case Xd.Sin:i="sin";break;case Xd.Abs:i="abs";break;case Xd.Exp:i="exp";break;case Xd.Exp2:i="exp2";break;case Xd.Round:i="round";break;case Xd.Floor:i="floor";break;case Xd.Ceiling:i="ceil";break;case Xd.Sqrt:i="sqrt";break;case Xd.Log:i="log";break;case Xd.Tan:i="tan";break;case Xd.ArcTan:i="atan";break;case Xd.ArcCos:i="acos";break;case Xd.ArcSin:i="asin";break;case Xd.Fract:i="fract";break;case Xd.Sign:i="sign";break;case Xd.Radians:i="radians";break;case Xd.Degrees:i="degrees";break;case Xd.Set:i=""}return e.compilationString+=e._declareOutput(t)+` = ${i}(${this.input.associatedVariableName});\n`,this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.TrigonometryBlockOperations.${Xd[this.operation]};\n`}}(0,Ge.Cg)([xh("Operation",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Cos",value:Xd.Cos},{label:"Sin",value:Xd.Sin},{label:"Abs",value:Xd.Abs},{label:"Exp",value:Xd.Exp},{label:"Exp2",value:Xd.Exp2},{label:"Round",value:Xd.Round},{label:"Floor",value:Xd.Floor},{label:"Ceiling",value:Xd.Ceiling},{label:"Sqrt",value:Xd.Sqrt},{label:"Log",value:Xd.Log},{label:"Tan",value:Xd.Tan},{label:"ArcTan",value:Xd.ArcTan},{label:"ArcCos",value:Xd.ArcCos},{label:"ArcSin",value:Xd.ArcSin},{label:"Fract",value:Xd.Fract},{label:"Sign",value:Xd.Sign},{label:"Radians",value:Xd.Radians},{label:"Degrees",value:Xd.Degrees},{label:"Set",value:Xd.Set}]})],Zd.prototype,"operation",void 0),(0,a.Y5)("BABYLON.TrigonometryBlock",Zd);const Qd={effect:null,subMesh:null};class Kd extends Hu.M{constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.VERTEXCOLOR_NME=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.PREPASS=!1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_POSITION=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.MORPHTARGETS_UV2=!1,this.MORPHTARGETS_COLOR=!1,this.MORPHTARGETTEXTURE_HASPOSITIONS=!1,this.MORPHTARGETTEXTURE_HASNORMALS=!1,this.MORPHTARGETTEXTURE_HASTANGENTS=!1,this.MORPHTARGETTEXTURE_HASUVS=!1,this.MORPHTARGETTEXTURE_HASUV2S=!1,this.MORPHTARGETTEXTURE_HASCOLORS=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.EXPOSURE=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.BUMPDIRECTUV=0,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.AREALIGHTSUPPORTED=!0,this.AREALIGHTNOROUGHTNESS=!0,this.rebuild()}setValue(e,t,i=!1){void 0===this[e]&&this._keys.push(e),i&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t}}class Jd extends Jr.E{static _BlockIsTextureBlock(e){return"TextureBlock"===e.getClassName()||"ReflectionTextureBaseBlock"===e.getClassName()||"ReflectionTextureBlock"===e.getClassName()||"ReflectionBlock"===e.getClassName()||"RefractionBlock"===e.getClassName()||"CurrentScreenBlock"===e.getClassName()||"ParticleTextureBlock"===e.getClassName()||"ImageSourceBlock"===e.getClassName()||"TriPlanarBlock"===e.getClassName()||"BiPlanarBlock"===e.getClassName()||"PrePassTextureBlock"===e.getClassName()}set _glowModeEnabled(e){this._useAdditionalColor=e}_getGlobalNodeMaterialEditor(){return"undefined"!=typeof NODEEDITOR?NODEEDITOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.NodeEditor?BABYLON:void 0}get shaderLanguage(){return this._options?.shaderLanguage||Jd.DefaultShaderLanguage}set shaderLanguage(e){this._options.shaderLanguage=e}get options(){return this._options}set options(e){this._options=e}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get mode(){return this._mode}set mode(e){this._mode=e}get buildId(){return this._buildId}set buildId(e){this._buildId=e}constructor(e,t,i={}){if(super(e,t||C.q.LastCreatedScene),this._buildId=Jd._BuildIdGenerator++,this._buildWasSuccessful=!1,this._cachedWorldViewMatrix=new n.uq,this._cachedWorldViewProjectionMatrix=new n.uq,this._optimizers=new Array,this._animationFrame=-1,this._buildIsInProgress=!1,this.BJSNODEMATERIALEDITOR=this._getGlobalNodeMaterialEditor(),this._useAdditionalColor=!1,this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new s.cP,this.onBuildErrorObservable=new s.cP,this._vertexOutputNodes=new Array,this._fragmentOutputNodes=new Array,this.attachedBlocks=[],this._mode=Hd.Material,this.forceAlphaBlending=!1,i&&1===i.shaderLanguage&&!this.getScene().getEngine().isWebGPU)throw new Error("WebGPU shader language is only supported with WebGPU engine");this._options={emitComments:!1,shaderLanguage:Jd.DefaultShaderLanguage,...i},this._attachImageProcessingConfiguration(null)}getClassName(){return"NodeMaterial"}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._markAllSubMeshesAsImageProcessingDirty()}))))}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e){if(t)return H.S0.Warn("More than one block was found with the name `"+e+"`"),t;t=i}return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlockByPredicate(e){for(const t of this.attachedBlocks)if(t.isInput&&e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}registerOptimizer(e){if(!(this._optimizers.indexOf(e)>-1))return this._optimizers.push(e),this}unregisterOptimizer(e){const t=this._optimizers.indexOf(e);if(-1!==t)return this._optimizers.splice(t,1),this}addOutputNode(e){if(null===e.target)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return e.target&gd.Vertex&&this._addVertexOutputNode(e),e.target&gd.Fragment&&this._addFragmentOutputNode(e),this}removeOutputNode(e){return null===e.target||(e.target&gd.Vertex&&this._removeVertexOutputNode(e),e.target&gd.Fragment&&this._removeFragmentOutputNode(e)),this}_addVertexOutputNode(e){if(-1===this._vertexOutputNodes.indexOf(e))return e.target=gd.Vertex,this._vertexOutputNodes.push(e),this}_removeVertexOutputNode(e){const t=this._vertexOutputNodes.indexOf(e);if(-1!==t)return this._vertexOutputNodes.splice(t,1),this}_addFragmentOutputNode(e){if(-1===this._fragmentOutputNodes.indexOf(e))return e.target=gd.Fragment,this._fragmentOutputNodes.push(e),this}_removeFragmentOutputNode(e){const t=this._fragmentOutputNodes.indexOf(e);if(-1!==t)return this._fragmentOutputNodes.splice(t,1),this}get _supportGlowLayer(){return 0!==this._fragmentOutputNodes.length&&!!this._fragmentOutputNodes.some((e=>e.additionalColor&&e.additionalColor.isConnected))}needAlphaBlending(){return!this.ignoreAlpha&&(this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending)}needAlphaTesting(){return this._sharedData&&this._sharedData.hints.needAlphaTesting}_processInitializeOnLink(e,t,i,r=!0){(e.target===gd.VertexAndFragment||t.target===gd.Fragment&&e.target===gd.Vertex&&e._preparationId!==this._buildId)&&i.push(e),this._initializeBlock(e,t,i,r)}_attachBlock(e){if(-1===this.attachedBlocks.indexOf(e)){if(e.isUnique){const t=e.getClassName();for(const e of this.attachedBlocks)if(e.getClassName()===t)throw`Cannot have multiple blocks of type ${t} in the same NodeMaterial`}this.attachedBlocks.push(e)}}_initializeBlock(e,t,i,r=!0){e.initialize(t),r&&e.autoConfigure(this),e._preparationId=this._buildId,this._attachBlock(e);for(const s of e.inputs){s.associatedVariableName="";const n=s.connectedPoint;if(n&&!n._preventBubbleUp){const s=n.ownerBlock;s!==e&&this._processInitializeOnLink(s,t,i,r)}}if(e.isLoop){const s=e;if(s.loopID.hasEndpoints)for(const e of s.loopID.endpoints){const s=e.ownerBlock;0===s.outputs.length&&(t._terminalBlocks.add(s),this._processInitializeOnLink(s,t,i,r))}}else if(e.isTeleportOut){const s=e;s.entryPoint&&this._processInitializeOnLink(s.entryPoint,t,i,r)}for(const t of e.outputs)t.associatedVariableName=""}_resetDualBlocks(e,t){e.target===gd.VertexAndFragment&&(e.buildId=t);for(const i of e.inputs){const r=i.connectedPoint;if(r&&!r._preventBubbleUp){const i=r.ownerBlock;i!==e&&this._resetDualBlocks(i,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._resetDualBlocks(i.entryPoint,t)}else if(e.isLoop){const i=e;if(i.loopID.hasEndpoints)for(const e of i.loopID.endpoints){const i=e.ownerBlock;0===i.outputs.length&&this._resetDualBlocks(i,t)}}}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)}build(e=!1,t=!0,i=!1){if(this._buildIsInProgress)return void m.V.Warn("Build is already in progress, You can use NodeMaterial.onBuildObservable to determine when the build is completed.");this._buildIsInProgress=!0,this._vertexCompilationState||i||(i=!0),this._buildWasSuccessful=!1;const r=this.getScene().getEngine(),s=this._mode===Hd.Particle;if(0===this._vertexOutputNodes.length&&!s)throw"You must define at least one vertexOutputNode";if(0===this._fragmentOutputNodes.length)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new Pd,this._vertexCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._vertexCompilationState.target=gd.Vertex,this._fragmentCompilationState=new Pd,this._fragmentCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._fragmentCompilationState.target=gd.Fragment;const n=this._fragmentOutputNodes.filter((e=>e._isFinalOutputAndActive)).length>1;let o=this._fragmentOutputNodes;n&&(o=this._fragmentOutputNodes.filter((e=>!e._isFinalOutputAndActive)),o.push(this._fragmentOutputNodes.filter((e=>e._isFinalOutputAndActive&&e._hasPrecedence))[0])),this._sharedData=new Td,this._sharedData.nodeMaterial=this,this._sharedData.fragmentOutputNodes=o,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=s;const a=[],l=[];for(const e of this._vertexOutputNodes)a.push(e),this._initializeBlock(e,this._vertexCompilationState,l,i);for(const e of o)l.push(e),this._initializeBlock(e,this._fragmentCompilationState,a,i);let h=0;for(const i of this.attachedBlocks)i.codeIsReady||(h++,i.onCodeIsReadyObservable.addOnce((()=>{h--,0===h&&this._finishBuildProcess(e,t,a,l)})));0===h&&this._finishBuildProcess(e,t,a,l)}_finishBuildProcess(e=!1,t=!0,i,r){this.optimize();for(const e of i)e.build(this._vertexCompilationState,i);this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(const e of r)this._resetDualBlocks(e,this._buildId-1);for(const e of r)e.build(this._fragmentCompilationState,r);this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=Jd._BuildIdGenerator++);const s=this._sharedData.emitErrors(this.onBuildErrorObservable);e&&(m.V.Log("Vertex shader:"),m.V.Log(this._vertexCompilationState.compilationString),m.V.Log("Fragment shader:"),m.V.Log(this._fragmentCompilationState.compilationString)),this._buildIsInProgress=!1,this._buildWasSuccessful=!0,s&&this.onBuildObservable.notifyObservers(this);const n=this.getScene().meshes;for(const e of n)if(e.subMeshes)for(const t of e.subMeshes){if(t.getMaterial()!==this)continue;if(!t.materialDefines)continue;const e=t.materialDefines;e.markAllAsDirty(),e.reset()}this.prePassTextureInputs.length&&this.getScene().enablePrePassRenderer();const o=this.getScene().prePassRenderer;o&&o.markAsDirty()}optimize(){for(const e of this._optimizers)e.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}_prepareDefinesForAttributes(e,t){const i=t.NORMAL,r=t.TANGENT,s=t.VERTEXCOLOR_NME;t.NORMAL=e.isVerticesDataPresent(Ot.R.NormalKind),t.TANGENT=e.isVerticesDataPresent(Ot.R.TangentKind);const n=e.useVertexColors&&e.isVerticesDataPresent(Ot.R.ColorKind);t.VERTEXCOLOR_NME=n;let o=!1;for(let i=1;i<=6;++i){const r=t["UV"+i];t["UV"+i]=e.isVerticesDataPresent(`uv${1===i?"":i}`),o=o||t["UV"+i]!==r}const a=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;(0,ts.N4)(this.getScene(),t,!a),lu.m.PrepareDefines(this.getScene().getEngine().currentRenderPassId,e,t),(i!==t.NORMAL||r!==t.TANGENT||s!==t.VERTEXCOLOR_NME||o)&&t.markAsAttributesDirty()}get isPrePassCapable(){return!0}get prePassTextureOutputs(){const e=this.getBlockByPredicate((e=>"PrePassOutputBlock"===e.getClassName())),t=[4];return e?(this.prePassTextureInputs.length||(e.viewDepth.isConnected&&t.push(5),e.screenDepth.isConnected&&t.push(10),e.viewNormal.isConnected&&t.push(6),e.worldNormal.isConnected&&t.push(8),e.worldPosition.isConnected&&t.push(1),e.localPosition.isConnected&&t.push(9),e.reflectivity.isConnected&&t.push(3),e.velocity.isConnected&&t.push(2),e.velocityLinear.isConnected&&t.push(11)),t):t}get prePassTextureInputs(){const e=this.getAllTextureBlocks().filter((e=>"PrePassTextureBlock"===e.getClassName())),t=[];for(const i of e)i.position.isConnected&&!t.includes(1)&&t.push(1),i.localPosition.isConnected&&!t.includes(9)&&t.push(9),i.depth.isConnected&&!t.includes(5)&&t.push(5),i.screenDepth.isConnected&&!t.includes(10)&&t.push(10),i.normal.isConnected&&!t.includes(6)&&t.push(6),i.worldNormal.isConnected&&!t.includes(8)&&t.push(8);return t}setPrePassRenderer(e){const t=this.prePassTextureInputs.concat(this.prePassTextureOutputs);if(e&&t.length>1){let i=e.getEffectConfiguration("nodeMaterial");i||(i=e.addEffectConfiguration({enabled:!0,needsImageProcessing:!1,name:"nodeMaterial",texturesRequired:[]}));for(const e of t)i.texturesRequired.includes(e)||i.texturesRequired.push(e);i.enabled=!0}return t.length>1}createPostProcess(e,t=1,i=1,r,s,n=0,o=5){return this.mode!==Hd.PostProcess?(m.V.Log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,i,r,s,n,o)}createEffectForPostProcess(e){this._createEffectForPostProcess(e)}_createEffectForPostProcess(e,t,i=1,r=1,s,n,o=0,a=5){let l=this.name+this._buildId;const h=new Kd,c=new tt.e(l+"PostProcess",this.getScene());let u=this._buildId;return this._processDefines(c,h),xo.M.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage),e?e.updateEffect(h.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,l,l):e=new Fi.w(this.name+"PostProcess",l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,i,t,r,s,n,h.toString(),o,l,{maxSimultaneousLights:this.maxSimultaneousLights},!1,a,this.shaderLanguage),e.nodeMaterialSource=this,e.onDisposeObservable.add((()=>{c.dispose()})),e.onApplyObservable.add((t=>{u!==this._buildId&&(delete xo.M.ShadersStore[l+"VertexShader"],delete xo.M.ShadersStore[l+"PixelShader"],l=this.name+this._buildId,h.markAllAsDirty(),u=this._buildId);this._processDefines(c,h)&&(xo.M.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),us._.SetImmediate((()=>e.updateEffect(h.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,l,l)))),this._checkInternals(t)})),e}createProceduralTexture(e,t){if(this.mode!==Hd.ProceduralTexture)return m.V.Log("Incompatible material mode"),null;let i=this.name+this._buildId;const r=new jd.p(i,e,null,t),s=new tt.e(i+"Procedural",this.getScene());s.reservedDataStore={hidden:!0};const n=new Kd,o=this._processDefines(s,n);xo.M.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage);let a=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[Ot.R.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString(),o?.fallbacks,void 0,void 0,void 0,this.shaderLanguage);r.nodeMaterialSource=this,r._setEffect(a);let l=this._buildId;const h=()=>{l!==this._buildId&&(delete xo.M.ShadersStore[i+"VertexShader"],delete xo.M.ShadersStore[i+"PixelShader"],i=this.name+this._buildId,n.markAllAsDirty(),l=this._buildId);const e=this._processDefines(s,n);e&&(xo.M.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage),us._.SetImmediate((()=>{a=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[Ot.R.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString(),e?.fallbacks,void 0),r._setEffect(a)}))),this._checkInternals(a)};return r.onBeforeGenerationObservable.add((()=>{h()})),this.onBuildObservable.add((()=>{h()})),r}_createEffectForParticles(e,t,i,r,s,n,o,a=""){let l=this.name+this._buildId+"_"+t;n||(n=new Kd),o||(o=this.getScene().getMeshByName(this.name+"Particle"))||((o=new tt.e(this.name+"Particle",this.getScene())).reservedDataStore={hidden:!0});let h=this._buildId;const c=[];let u=a;if(!s){const a=this._processDefines(o,n);xo.M.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),e.fillDefines(c,t,!1),u=c.join("\n"),s=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString()+"\n"+u,a?.fallbacks,i,r,e,this.shaderLanguage),e.setCustomEffect(s,t)}s.onBindObservable.add((s=>{h!==this._buildId&&(delete xo.M.ShadersStore[l+"PixelShader"],l=this.name+this._buildId+"_"+t,n.markAllAsDirty(),h=this._buildId),c.length=0,e.fillDefines(c,t,!1);const d=c.join("\n");d!==u&&(n.markAllAsDirty(),u=d);const p=this._processDefines(o,n);if(p)return xo.M.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),s=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString()+"\n"+u,p?.fallbacks,i,r,e),e.setCustomEffect(s,t),void this._createEffectForParticles(e,t,i,r,s,n,o,a);this._checkInternals(s)}))}_checkInternals(e){if(this._sharedData.animatedInputs){const e=this.getScene(),t=e.getFrameId();if(this._animationFrame!==t){for(const t of this._sharedData.animatedInputs)t.animate(e);this._animationFrame=t}}for(const t of this._sharedData.bindableBlocks)t.bind(e,this);for(const t of this._sharedData.inputBlocks)t._transmit(e,this.getScene(),this)}createEffectForParticles(e,t,i){this.mode===Hd.Particle?(this._createEffectForParticles(e,qd.BLENDMODE_ONEONE,t,i),this._createEffectForParticles(e,qd.BLENDMODE_MULTIPLY,t,i)):m.V.Log("Incompatible material mode")}createAsShadowDepthWrapper(e){this.mode===Hd.Material?e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene()):m.V.Log("Incompatible material mode")}_processDefines(e,t,i=!1,r){let s=null;const n=this.getScene();if((0,ts.Y7)(n,t)&&t.markAsMiscDirty(),this._sharedData.blocksWithDefines.forEach((r=>{r.initializeDefines(e,this,t,i)})),this._sharedData.blocksWithDefines.forEach((s=>{s.prepareDefines(e,this,t,i,r)})),t.isDirty){const i=t._areLightsDisposed;t.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach((i=>{i.replaceRepeatableContent(this._vertexCompilationState,this._fragmentCompilationState,e,t)}));const r=[];this._sharedData.dynamicUniformBlocks.forEach((e=>{e.updateUniformsAndSamples(this._vertexCompilationState,this,t,r)}));const n=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach((e=>{-1===n.indexOf(e)&&n.push(e)}));const o=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach((e=>{-1===o.indexOf(e)&&o.push(e)}));const a=new Qr.J;this._sharedData.blocksWithFallbacks.forEach((t=>{t.provideFallbacks(e,a)})),s={lightDisposed:i,uniformBuffers:r,mergedUniforms:n,mergedSamplers:o,fallbacks:a}}return s}isReadyForSubMesh(e,t,i=!1){if(!this._buildWasSuccessful)return!1;const r=this.getScene();if(this._sharedData.animatedInputs){const e=r.getFrameId();if(this._animationFrame!==e){for(const e of this._sharedData.animatedInputs)e.animate(r);this._animationFrame=e}}const s=t._drawWrapper;if(s.effect&&this.isFrozen&&s._wasPreviouslyReady&&s._wasPreviouslyUsingInstances===i)return!0;t.materialDefines&&"string"!=typeof t.materialDefines||(t.materialDefines=new Kd);const n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const o=r.getEngine();if(this._prepareDefinesForAttributes(e,n),this._sharedData.blockingBlocks.some((t=>!t.isReady(e,this,n,i))))return!1;const a=this._processDefines(e,n,i,t);if(a){const e=t.effect,i=n.toString();let s=o.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:a.mergedUniforms,uniformBuffersNames:a.uniformBuffers,samplers:a.mergedSamplers,defines:i,fallbacks:a.fallbacks,onCompiled:this.onCompiled,onError:this.onError,multiTarget:n.PREPASS,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:n.NUM_MORPH_INFLUENCERS},shaderLanguage:this.shaderLanguage},o);if(s)if(this._onEffectCreatedObservable&&(Qd.effect=s,Qd.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Qd)),this.allowShaderHotSwapping&&e&&!s.isReady()){if(s=e,n.markAsUnprocessed(),a.lightDisposed)return n._areLightsDisposed=!0,!1}else r.resetCachedMaterial(),t.setEffect(s,n,this._materialContext)}if(n.AREALIGHTUSED)for(let t=0;t<e.lightSources.length;t++)if(!e.lightSources[t]._isReady())return!1;return!(!t.effect||!t.effect.isReady())&&(n._renderId=r.getRenderId(),s._wasPreviouslyReady=!0,s._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}get compiledShaders(){return this._buildWasSuccessful||this.build(),`// Vertex shader\n${this._vertexCompilationState.compilationString}\n\n// Fragment shader\n${this._fragmentCompilationState.compilationString}`}bindOnlyWorldMatrix(e){const t=this.getScene();if(!this._activeEffect)return;const i=this._sharedData.hints;i.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(const t of this._sharedData.inputBlocks)t._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}bindForSubMesh(e,t,i){const r=this.getScene(),s=i.effect;if(!s)return;this._activeEffect=s,this.bindOnlyWorldMatrix(e);const n=this._mustRebind(r,s,i,t.visibility),o=this._sharedData;if(n){for(const e of o.bindableBlocks)e.bind(s,this,t,i);for(const e of o.forcedBindableBlocks)e.bind(s,this,t,i);for(const e of o.inputBlocks)e._transmit(s,r,this)}else if(!this.isFrozen)for(const e of o.forcedBindableBlocks)e.bind(s,this,t,i);this._afterBind(t,this._activeEffect,i)}getActiveTextures(){const e=super.getActiveTextures();return this._sharedData&&e.push(...this._sharedData.textureBlocks.filter((e=>e.texture)).map((e=>e.texture))),e}getTextureBlocks(){return this._sharedData?this._sharedData.textureBlocks:[]}getAllTextureBlocks(){const e=[];for(const t of this.attachedBlocks)Jd._BlockIsTextureBlock(t)&&e.push(t);return e}hasTexture(e){if(super.hasTexture(e))return!0;if(!this._sharedData)return!1;for(const t of this._sharedData.textureBlocks)if(t.texture===e)return!0;return!1}dispose(e,t,i){if(t)for(const e of this.getTextureBlocks().filter((e=>e.texture)).map((e=>e.texture)))e.dispose();for(const e of this.attachedBlocks)e.dispose();this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this.onBuildErrorObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),super.dispose(e,t,i)}_createNodeEditor(e){const t={nodeMaterial:this,...e};this.BJSNODEMATERIALEDITOR.NodeEditor.Show(t)}edit(e){return new Promise((t=>{if(this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),void 0===this.BJSNODEMATERIALEDITOR){const i=e&&e.editorURL?e.editorURL:Jd.EditorURL;H.S0.LoadBabylonScript(i,(()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this._createNodeEditor(e?.nodeEditorConfig),t()}))}else this._createNodeEditor(e?.nodeEditorConfig),t()}))}clear(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0,this._buildIsInProgress=!1}setToDefault(){this.clear(),this.editorData=null;const e=new Fd("Position");e.setAsAttribute("position");const t=new Fd("World");t.setAsSystemValue(bd.World);const i=new Ad("WorldPos");e.connectTo(i),t.connectTo(i);const r=new Fd("ViewProjection");r.setAsSystemValue(bd.ViewProjection);const s=new Ad("WorldPos * ViewProjectionTransform");i.connectTo(s),r.connectTo(s);const n=new Id("VertexOutput");s.connectTo(n);const a=new Fd("color");a.value=new o.ov(.8,.8,.8,1);const l=new Rd("FragmentOutput");a.connectTo(l),this.addOutputNode(n),this.addOutputNode(l),this._mode=Hd.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;const e=new Fd("Position");e.setAsAttribute("position2d");const t=new Fd("Constant1");t.isConstant=!0,t.value=1;const i=new Gd("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const r=new Id("VertexOutput");i.connectTo(r);const s=new Fd("Scale");s.visibleInInspector=!0,s.value=new n.I9(1,1);const o=new zd("uv0");e.connectTo(o);const a=new Wd("UV scale");o.connectTo(a),s.connectTo(a);const l=new Bd("CurrentScreen");a.connectTo(l);const h=H.S0.GetAssetUrl("https://assets.babylonjs.com/core/nme/currentScreenPostProcess.png");l.texture=new $e.g(h,this.getScene());const c=new Rd("FragmentOutput");l.connectTo(c,{output:"rgba"}),this.addOutputNode(r),this.addOutputNode(c),this._mode=Hd.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;const e=new Fd("Position");e.setAsAttribute("position2d");const t=new Fd("Constant1");t.isConstant=!0,t.value=1;const i=new Gd("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const r=new Id("VertexOutput");i.connectTo(r);const s=new Fd("Time");s.value=0,s.min=0,s.max=0,s.isBoolean=!1,s.matrixMode=0,s.animationType=yd.Time,s.isConstant=!1;const n=new Fd("Color3");n.value=new o.v9(1,1,1),n.isConstant=!1;const a=new Rd("FragmentOutput"),l=new Gd("VectorMerger");l.visibleInInspector=!1;const h=new Zd("Cos");h.operation=Xd.Cos,e.connectTo(l),s.output.connectTo(h.input),h.output.connectTo(l.z),l.xyzOut.connectTo(a.rgb),this.addOutputNode(r),this.addOutputNode(a),this._mode=Hd.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;const e=new Fd("uv");e.setAsAttribute("particle_uv");const t=new Vd("ParticleTexture");e.connectTo(t);const i=new Fd("Color");i.setAsAttribute("particle_color");const r=new Wd("Texture * Color");t.connectTo(r),i.connectTo(r);const s=new Ld("ParticleRampGradient");r.connectTo(s);const n=new Yd("ColorSplitter");i.connectTo(n);const o=new kd("ParticleBlendMultiply");s.connectTo(o),t.connectTo(o,{output:"a"}),n.connectTo(o,{output:"a"});const a=new Rd("FragmentOutput");o.connectTo(a),this.addOutputNode(a),this._mode=Hd.Particle}async loadAsync(e,t=""){return Jd.ParseFromFileAsync("",e,this.getScene(),t,!0,this)}_gatherBlocks(e,t){if(-1===t.indexOf(e)){t.push(e);for(const i of e.inputs){const r=i.connectedPoint;if(r){const i=r.ownerBlock;i!==e&&this._gatherBlocks(i,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}generateCode(){let e=[];const t=[],i=["const","var","let"];for(const e of this._vertexOutputNodes)this._gatherBlocks(e,t);const r=[];for(const e of this._fragmentOutputNodes)this._gatherBlocks(e,r);let s=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");\n`;s+=`nodeMaterial.mode = BABYLON.NodeMaterialModes.${Hd[this.mode]};\n`;for(const r of t)r.isInput&&-1===e.indexOf(r)&&(s+=r._dumpCode(i,e));for(const t of r)t.isInput&&-1===e.indexOf(t)&&(s+=t._dumpCode(i,e));e=[],s+="\n// Connections\n";for(const t of this._vertexOutputNodes)s+=t._dumpCodeForOutputConnections(e);for(const t of this._fragmentOutputNodes)s+=t._dumpCodeForOutputConnections(e);s+="\n// Output nodes\n";for(const e of this._vertexOutputNodes)s+=`nodeMaterial.addOutputNode(${e._codeVariableName});\n`;for(const e of this._fragmentOutputNodes)s+=`nodeMaterial.addOutputNode(${e._codeVariableName});\n`;return s+="nodeMaterial.build();\n",s}serialize(e){const t=e?{}:Ue.p.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];if(e)i=e;else{t.customType="BABYLON.NodeMaterial",t.outputNodes=[];for(const e of this._vertexOutputNodes)this._gatherBlocks(e,i),t.outputNodes.push(e.uniqueId);for(const e of this._fragmentOutputNodes)this._gatherBlocks(e,i),-1===t.outputNodes.indexOf(e.uniqueId)&&t.outputNodes.push(e.uniqueId)}t.blocks=[];for(const e of i)t.blocks.push(e.serialize());if(!e)for(const e of this.attachedBlocks)-1===i.indexOf(e)&&t.blocks.push(e.serialize());return t.uniqueId=this.uniqueId,t}_restoreConnections(e,t,i){for(const r of e.outputs)for(const s of t.blocks){const n=i[s.id];if(n)for(const o of s.inputs)if(i[o.targetBlockId]!==e||o.targetConnectionName!==r.name);else{const e=n.getInputByName(o.inputName);if(!e||e.isConnected)continue;r.connectTo(e,!0),this._restoreConnections(n,t,i)}}}parseSerializedObject(e,t="",i=!1,r){i||this.clear();const s={};for(const i of e.blocks){const e=(0,a.n9)(i.customType);if(e){const n=new e;n._deserialize(i,this.getScene(),t,r),s[i.id]=n,this.attachedBlocks.push(n)}}for(const e of this.attachedBlocks)if(e.isTeleportOut){const t=e,i=t._tempEntryPointUniqueId;if(i){s[i].attachToEndpoint(t)}}for(let t=0;t<e.blocks.length;t++){const r=s[e.blocks[t].id];r&&(r.inputs.length&&!i||this._restoreConnections(r,e,s))}if(e.outputNodes)for(const t of e.outputNodes)this.addOutputNode(s[t]);if(e.locations||e.editorData&&e.editorData.locations){const t=e.locations||e.editorData.locations;for(const e of t)s[e.blockId]&&(e.blockId=s[e.blockId].uniqueId);i&&this.editorData&&this.editorData.locations&&t.concat(this.editorData.locations),e.locations?this.editorData={locations:t}:(this.editorData=e.editorData,this.editorData.locations=t);const r=[];for(const e in s)r[e]=s[e].uniqueId;this.editorData.map=r}this.comment=e.comment,void 0!==e.forceAlphaBlending&&(this.forceAlphaBlending=e.forceAlphaBlending),void 0!==e.alphaMode&&(this.alphaMode=e.alphaMode),i||(this._mode=e.mode??Hd.Material)}loadFromSerialization(e,t="",i=!1){this.parseSerializedObject(e,t,i)}clone(e,t=!1){const i=this.serialize(),r=Ue.p.Clone((()=>new Jd(e,this.getScene(),this.options)),this);return r.id=e,r.name=e,r.parseSerializedObject(i),r._buildId=this._buildId,r.build(!1,!t),r}whenTexturesReadyAsync(){const e=[];return this.getActiveTextures().forEach((t=>{const i=t.getInternalTexture();i&&!i.isReady&&e.push(new Promise(((e,t)=>{i.onLoadedObservable.addOnce((()=>{e()})),i.onErrorObservable.addOnce((e=>{t(e)}))})))})),Promise.all(e)}static Parse(e,t,i="",r=0){const s=Ue.p.Parse((()=>new Jd(e.name,t,{shaderLanguage:r})),e,t,i);return s.parseSerializedObject(e,i),s.build(),s}static async ParseFromFileAsync(e,t,i,r="",s=!1,n,o,a){const l=n??new Jd(e,i,a),h=await i._loadFileAsync(t),c=JSON.parse(h);return l.parseSerializedObject(c,r,void 0,o),s||l.build(),l}static ParseFromSnippetAsync(e,t=C.q.LastCreatedScene,i="",r,s=!1,n=!1,o,a){return"_BLANK"===e?Promise.resolve(Jd.CreateDefault("blank",t)):new Promise(((l,h)=>{const c=new Kr.u;c.addEventListener("readystatechange",(()=>{if(4==c.readyState)if(200==c.status){const u=JSON.parse(JSON.parse(c.responseText).jsonPayload),d=JSON.parse(u.nodeMaterial);r||((r=Ue.p.Parse((()=>new Jd(e,t,a)),d,t,i)).uniqueId=t.getUniqueId()),r.parseSerializedObject(d,void 0,void 0,o),r.snippetId=e,r.sideOrientation=null;try{s||r.build()}catch(e){h(e)}n?r.whenTexturesReadyAsync().then((()=>{l(r)})).catch((e=>{h(e)})):l(r)}else h("Unable to load the snippet "+e)})),c.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),c.send()}))}static CreateDefault(e,t){const i=new Jd(e,t);return i.setToDefault(),i.build(),i}}Jd._BuildIdGenerator=0,Jd.EditorURL=`${H.S0._DefaultCdnUrl}/v${$.$.Version}/nodeEditor/babylon.nodeEditor.js`,Jd.SnippetUrl="https://snippet.babylonjs.com",Jd.IgnoreTexturesAtLoadTime=!1,Jd.DefaultShaderLanguage=0,(0,Ge.Cg)([(0,ze.lK)()],Jd.prototype,"ignoreAlpha",void 0),(0,Ge.Cg)([(0,ze.lK)()],Jd.prototype,"maxSimultaneousLights",void 0),(0,Ge.Cg)([(0,ze.lK)("mode")],Jd.prototype,"_mode",void 0),(0,Ge.Cg)([(0,ze.lK)("comment")],Jd.prototype,"comment",void 0),(0,Ge.Cg)([(0,ze.lK)()],Jd.prototype,"forceAlphaBlending",void 0),(0,a.Y5)("BABYLON.NodeMaterial",Jd);var ep,tp,ip=i(65907);ip.K.prototype._projectOnTrianglesToRef=function(e,t,i,r,s,o){const a=n.AA.Vector3[0],l=n.AA.Vector3[1];let h=1/0;for(let o=this.indexStart;o<this.indexStart+this.indexCount-(3-r);o+=r){const r=i[o],c=i[o+1],u=i[o+2];if(s&&4294967295===u){o+=2;continue}const d=t[r],p=t[c],m=t[u];if(!d||!p||!m)continue;const f=n.Pq.ProjectOnTriangleToRef(e,d,p,m,l);f<h&&(a.copyFrom(l),h=f)}return o.copyFrom(a),h},ip.K.prototype._projectOnUnIndexedTrianglesToRef=function(e,t,i,r){const s=n.AA.Vector3[0],o=n.AA.Vector3[1];let a=1/0;for(let i=this.verticesStart;i<this.verticesStart+this.verticesCount;i+=3){const r=t[i],l=t[i+1],h=t[i+2],c=n.Pq.ProjectOnTriangleToRef(e,r,l,h,o);c<a&&(s.copyFrom(o),a=c)}return r.copyFrom(s),a},ip.K.prototype.projectToRef=function(e,t,i,r){const s=this.getMaterial();if(!s)return-1;let n=3,o=!1;switch(s.fillMode){case 3:case 5:case 6:case 8:return-1;case 7:n=1,o=!0}return 4===s.fillMode?-1:!i.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(e,t,i,r):this._projectOnTrianglesToRef(e,t,i,n,o,r)},function(e){e[e.DEHYDRATED=0]="DEHYDRATED",e[e.HOVER=1]="HOVER",e[e.TOUCH=2]="TOUCH"}(ep||(ep={})),function(e){e[e.DISABLED=0]="DISABLED",e[e.CENTERED_ON_CONTROLLER=1]="CENTERED_ON_CONTROLLER",e[e.CENTERED_IN_FRONT=2]="CENTERED_IN_FRONT"}(tp||(tp={}));const rp=[new n.Pq,new n.Pq,new n.Pq,new n.Pq];class sp extends md{constructor(e,t){super(e),this._options=t,this._tmpRay=new st.Ray(new n.Pq,new n.Pq),this._attachController=e=>{if(this._controllers[e.uniqueId])return;const{touchCollisionMesh:t,touchCollisionMeshFunction:i,hydrateCollisionMeshFunction:r}=this._generateNewTouchPointMesh(),s=this._generateVisualCue();switch(this._controllers[e.uniqueId]={xrController:e,meshUnderPointer:null,nearInteractionTargetMesh:null,pick:null,stalePick:null,touchCollisionMesh:t,touchCollisionMeshFunction:i,hydrateCollisionMeshFunction:r,currentAnimationState:ep.DEHYDRATED,grabRay:new st.Ray(new n.Pq,new n.Pq),hoverInteraction:!1,nearInteraction:!1,grabInteraction:!1,downTriggered:!1,id:sp._IdCounter++,pickedPointVisualCue:s},this._controllers[e.uniqueId]._worldScaleObserver=this._controllers[e.uniqueId]._worldScaleObserver||this._xrSessionManager.onWorldScaleFactorChangedObservable.add((t=>{if(t.newScaleFactor!==t.previousScaleFactor){this._controllers[e.uniqueId].touchCollisionMesh.dispose(),this._controllers[e.uniqueId].pickedPointVisualCue.dispose();const{touchCollisionMesh:t,touchCollisionMeshFunction:i,hydrateCollisionMeshFunction:r}=this._generateNewTouchPointMesh();this._controllers[e.uniqueId].touchCollisionMesh=t,this._controllers[e.uniqueId].touchCollisionMeshFunction=i,this._controllers[e.uniqueId].hydrateCollisionMeshFunction=r,this._controllers[e.uniqueId].pickedPointVisualCue=this._generateVisualCue()}})),this._attachedController?!this._options.enableNearInteractionOnAllControllers&&this._options.preferredHandedness&&e.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=e.uniqueId):this._options.enableNearInteractionOnAllControllers||(this._attachedController=e.uniqueId),e.inputSource.targetRayMode){case"tracked-pointer":return this._attachNearInteractionMode(e);case"gaze":case"screen":return null}},this._controllers={},this._farInteractionFeature=null,this.selectionMeshDefaultColor=new o.v9(.8,.8,.8),this.selectionMeshPickedColor=new o.v9(.3,.3,1),this.alwaysHideSelectionMesh=!1,this._hoverRadius=.1,this._pickRadius=.02,this._controllerPickRadius=.03,this._nearGrabLengthScale=5,this._scene=this._xrSessionManager.scene,void 0===this._options.nearInteractionControllerMode&&(this._options.nearInteractionControllerMode=2),this._options.farInteractionFeature&&(this._farInteractionFeature=this._options.farInteractionFeature)}attach(){return!!super.attach()&&(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),this._scene.constantlyUpdateMeshUnderPointer=!0,!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),!0)}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}setFarInteractionFeature(e){this._farInteractionFeature=e}_nearPickPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearPickable}_nearGrabPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearGrabbable}_nearInteractionPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&(e.isNearPickable||e.isNearGrabbable)}_controllerAvailablePredicate(e,t){let i=e;for(;i;){if(i.reservedDataStore&&i.reservedDataStore.nearInteraction&&i.reservedDataStore.nearInteraction.excludedControllerId===t)return!1;i=i.parent}return!0}_handleTransitionAnimation(e,t){if(e.currentAnimationState!==t&&2===this._options.nearInteractionControllerMode&&!e.xrController?.inputSource.hand){if(t>e.currentAnimationState)switch(e.currentAnimationState){case ep.DEHYDRATED:if(e.hydrateCollisionMeshFunction(!0),t===ep.HOVER)break;case ep.HOVER:if(e.touchCollisionMeshFunction(!0),t===ep.TOUCH)break}else switch(e.currentAnimationState){case ep.TOUCH:if(e.touchCollisionMeshFunction(!1),t===ep.HOVER)break;case ep.HOVER:if(e.hydrateCollisionMeshFunction(!1),t===ep.DEHYDRATED)break}e.currentAnimationState=t}}_processTouchPoint(e,t,i){const r=this._controllers[e];r.grabRay.origin.copyFrom(t),i.toEulerAnglesToRef(n.AA.Vector3[0]),r.grabRay.direction.copyFrom(n.AA.Vector3[0]),2!==this._options.nearInteractionControllerMode||r.xrController?.inputSource.hand||(r.xrController.getWorldPointerRayToRef(this._tmpRay),r.grabRay.origin.addInPlace(this._tmpRay.direction.scale(.05))),r.grabRay.length=this._nearGrabLengthScale*this._hoverRadius*this._xrSessionManager.worldScalingFactor,r.touchCollisionMesh.position.copyFrom(r.grabRay.origin).scaleInPlace(this._xrSessionManager.worldScalingFactor)}_onXRFrame(e){Object.keys(this._controllers).forEach((t=>{const i=this._controllers[t],r=i.xrController?.inputSource.hand;if(!this._options.enableNearInteractionOnAllControllers&&t!==this._attachedController||!i.xrController||!r&&(!this._options.nearInteractionControllerMode||!i.xrController.inputSource.gamepad))return void(i.pick=null);if(i.hoverInteraction=!1,i.nearInteraction=!1,!i.xrController)return;if(r){const i=r.get("index-finger-tip");if(i){const r=e.getJointPose(i,this._xrSessionManager.referenceSpace);if(r&&r.transform){const e=this._scene.useRightHandedSystem?1:-1;n.AA.Vector3[0].set(r.transform.position.x,r.transform.position.y,r.transform.position.z*e),n.AA.Quaternion[0].set(r.transform.orientation.x,r.transform.orientation.y,r.transform.orientation.z*e,r.transform.orientation.w*e),this._processTouchPoint(t,n.AA.Vector3[0],n.AA.Quaternion[0])}}}else if(i.xrController.inputSource.gamepad&&0!==this._options.nearInteractionControllerMode){let e=i.xrController.pointer;i.xrController.grip&&1===this._options.nearInteractionControllerMode&&(e=i.xrController.grip),this._processTouchPoint(t,e.position,e.rotationQuaternion)}const s=(e,t)=>{let i=null;return i=t&&t.hit?e&&e.hit?t.distance<e.distance?t:e:t:e,i},o=e=>{let t=new Xr.G,i=!1;const r=e&&e.pickedPoint&&e.hit;return e?.pickedPoint&&(i=0===e.pickedPoint.x&&0===e.pickedPoint.y&&0===e.pickedPoint.z),r&&!i&&(t=e),t};if(!i.grabInteraction){let e=null,t=null;this._options.useUtilityLayer&&this._utilityLayerScene&&(t=this._pickWithSphere(i,this._hoverRadius*this._xrSessionManager.worldScalingFactor,this._utilityLayerScene,(e=>this._nearInteractionPredicate(e))));const n=s(this._pickWithSphere(i,this._hoverRadius*this._xrSessionManager.worldScalingFactor,this._scene,(e=>this._nearInteractionPredicate(e))),t);if(n&&n.hit&&(e=o(n),e.hit&&(i.hoverInteraction=!0)),i.hoverInteraction){let t=null;const n=(r?this._pickRadius:this._controllerPickRadius)*this._xrSessionManager.worldScalingFactor;this._options.useUtilityLayer&&this._utilityLayerScene&&(t=this._pickWithSphere(i,n,this._utilityLayerScene,(e=>this._nearPickPredicate(e))));const a=o(s(this._pickWithSphere(i,n,this._scene,(e=>this._nearPickPredicate(e))),t));a.hit&&(e=a,i.nearInteraction=!0)}i.stalePick=i.pick,i.pick=e,i.pick&&i.pick.pickedPoint&&i.pick.hit?(i.meshUnderPointer=i.pick.pickedMesh,i.pickedPointVisualCue.position.copyFrom(i.pick.pickedPoint),i.pickedPointVisualCue.isVisible=!this.alwaysHideSelectionMesh,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(i.id,!0)):(i.meshUnderPointer=null,i.pickedPointVisualCue.isVisible=!1,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(i.id,!1))}let a=ep.DEHYDRATED;i.grabInteraction||i.nearInteraction?a=ep.TOUCH:i.hoverInteraction&&(a=ep.HOVER),this._handleTransitionAnimation(i,a)}))}get _utilityLayerScene(){return this._options.customUtilityLayerScene||Rs.DefaultUtilityLayer.utilityLayerScene}_generateVisualCue(){const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Rs.DefaultUtilityLayer.utilityLayerScene:this._scene,t=zs("nearInteraction",{diameter:.0105*this._xrSessionManager.worldScalingFactor},e);t.bakeCurrentTransformIntoVertices(),t.isPickable=!1,t.isVisible=!1,t.rotationQuaternion=n.PT.Identity();const i=new br.F("targetMat",e);return i.specularColor=o.v9.Black(),i.emissiveColor=this.selectionMeshDefaultColor,i.backFaceCulling=!1,t.material=i,t}_isControllerReadyForNearInteraction(e){return!this._farInteractionFeature||this._farInteractionFeature._getPointerSelectionDisabledByPointerId(e)}_attachNearInteractionMode(e){const t=this._controllers[e.uniqueId],i={pointerId:t.id,pointerType:"xr-near"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{(this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController)&&t.xrController&&(t.xrController.inputSource.hand||this._options.nearInteractionControllerMode&&t.xrController.inputSource.gamepad)&&(t.pick&&(t.pick.ray=t.grabRay),t.pick&&this._isControllerReadyForNearInteraction(t.id)&&this._scene.simulatePointerMove(t.pick,i),t.nearInteraction&&t.pick&&t.pick.hit?t.nearInteractionTargetMesh||(this._scene.simulatePointerDown(t.pick,i),t.nearInteractionTargetMesh=t.meshUnderPointer,t.downTriggered=!0):t.nearInteractionTargetMesh&&t.stalePick&&(this._scene.simulatePointerUp(t.stalePick,i),t.downTriggered=!1,t.nearInteractionTargetMesh=null))}));const r=r=>{this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController&&this._isControllerReadyForNearInteraction(t.id)?(t.pick&&(t.pick.ray=t.grabRay),r&&t.pick&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)?(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i),t.downTriggered=!0):!r&&t.pick&&t.grabInteraction&&(this._scene.simulatePointerUp(t.pick,i),t.downTriggered=!1,t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!this.alwaysHideSelectionMesh)):!r||this._options.enableNearInteractionOnAllControllers||this._options.disableSwitchOnClick||(this._attachedController=e.uniqueId)};if(e.inputSource.gamepad){const i=e=>{t.squeezeComponent=e.getComponent("grasp"),t.squeezeComponent?t.onSqueezeButtonChangedObserver=t.squeezeComponent.onButtonStateChangedObservable.add((e=>{if(e.changes.pressed){const t=e.changes.pressed.current;r(t)}})):(t.selectionComponent=e.getMainComponent(),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add((e=>{if(e.changes.pressed){const t=e.changes.pressed.current;r(t)}})))};e.motionController?i(e.motionController):e.onMotionControllerInitObservable.add(i)}else{const e=e=>{t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)&&(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i),t.downTriggered=!0)},r=e=>{t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!this.alwaysHideSelectionMesh,t.downTriggered=!1)};t.eventListeners={selectend:r,selectstart:e},this._xrSessionManager.session.addEventListener("selectstart",e),this._xrSessionManager.session.addEventListener("selectend",r)}}_detachController(e){const t=this._controllers[e];if(t&&(t.squeezeComponent&&t.onSqueezeButtonChangedObserver&&t.squeezeComponent.onButtonStateChangedObservable.remove(t.onSqueezeButtonChangedObserver),t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach((e=>{const i=t.eventListeners&&t.eventListeners[e];i&&this._xrSessionManager.session.removeEventListener(e,i)})),t.touchCollisionMesh.dispose(),t.pickedPointVisualCue.dispose(),this._xrSessionManager.runInXRFrame((()=>{if(!t.downTriggered)return;const e={pointerId:t.id,pointerType:"xr-near"};this._scene.simulatePointerUp(new Xr.G,e)})),t._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(t._worldScaleObserver),delete this._controllers[e],this._attachedController===e)){const e=Object.keys(this._controllers);e.length?this._attachedController=e[0]:this._attachedController=""}}_generateNewTouchPointMesh(){const e=this._xrSessionManager.worldScalingFactor,t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Rs.DefaultUtilityLayer.utilityLayerScene:this._scene,i=zs("PickSphere",{diameter:1*e},t);if(i.isVisible=!1,this._options.motionControllerOrbMaterial)i.material=this._options.motionControllerOrbMaterial;else{let e;e=this._options.motionControllerTouchMaterialSnippetUrl?Jd.ParseFromFileAsync("motionControllerTouchMaterial",this._options.motionControllerTouchMaterialSnippetUrl,t):Jd.ParseFromSnippetAsync("8RUNKL#3",t),e.then((e=>{i.material=e})).catch((e=>{m.V.Warn(`Error creating touch material in WebXRNearInteraction: ${e}`)}))}const r=new F.fA;r.setEasingMode(F.KA.EASINGMODE_EASEINOUT);const s=new n.Pq(this._controllerPickRadius,this._controllerPickRadius,this._controllerPickRadius).scaleInPlace(e),o=this._controllerPickRadius*(4/3),a=new n.Pq(o,o,o).scaleInPlace(e),l=this._controllerPickRadius*(7/6),h=new n.Pq(l,l,l).scaleInPlace(e),c=.8*this._controllerPickRadius,u=new n.Pq(c,c,c).scaleInPlace(e),d=1.5*this._controllerPickRadius,p=[{frame:0,value:s},{frame:10,value:new n.Pq(d,d,d).scaleInPlace(e)},{frame:18,value:a}],f=[{frame:0,value:a},{frame:10,value:u},{frame:18,value:s}],_=[{frame:0,value:n.Pq.ZeroReadOnly},{frame:12,value:h},{frame:15,value:s}],g=[{frame:0,value:s},{frame:10,value:n.Pq.ZeroReadOnly},{frame:15,value:n.Pq.ZeroReadOnly}],x=new M.X5("touch","scaling",60,M.X5.ANIMATIONTYPE_VECTOR3,M.X5.ANIMATIONLOOPMODE_CONSTANT),v=new M.X5("release","scaling",60,M.X5.ANIMATIONTYPE_VECTOR3,M.X5.ANIMATIONLOOPMODE_CONSTANT),S=new M.X5("hydrate","scaling",60,M.X5.ANIMATIONTYPE_VECTOR3,M.X5.ANIMATIONLOOPMODE_CONSTANT),b=new M.X5("dehydrate","scaling",60,M.X5.ANIMATIONTYPE_VECTOR3,M.X5.ANIMATIONLOOPMODE_CONSTANT);x.setEasingFunction(r),v.setEasingFunction(r),S.setEasingFunction(r),b.setEasingFunction(r),x.setKeys(p),v.setKeys(f),S.setKeys(_),b.setKeys(g);return{touchCollisionMesh:i,touchCollisionMeshFunction:e=>{const r=e?x:v;t.beginDirectAnimation(i,[r],0,18,!1,1)},hydrateCollisionMeshFunction:e=>{const r=e?S:b;e&&(i.isVisible=!0),t.beginDirectAnimation(i,[r],0,15,!1,1,(()=>{e||(i.isVisible=!1)}))}}}_pickWithSphere(e,t,i,r){const s=new Xr.G;if(s.distance=1/0,e.touchCollisionMesh&&e.xrController){const n=e.touchCollisionMesh.position,o=vs.i.CreateFromCenterAndRadius(n,t);for(let t=0;t<i.meshes.length;t++){const n=i.meshes[t];if(!r(n)||!this._controllerAvailablePredicate(n,e.xrController.uniqueId))continue;const a=sp.PickMeshWithSphere(n,o);a&&a.hit&&a.distance<s.distance&&(s.hit=a.hit,s.pickedMesh=n,s.pickedPoint=a.pickedPoint,s.aimTransform=e.xrController.pointer,s.gripTransform=e.xrController.grip||null,s.originMesh=e.touchCollisionMesh,s.distance=a.distance,s.bu=a.bu,s.bv=a.bv,s.faceId=a.faceId,s.subMeshId=a.subMeshId)}}return s}static PickMeshWithSphere(e,t,i=!1){const r=e.subMeshes,s=new Xr.G,o=e.getBoundingInfo();if(!e._generatePointsArray())return s;if(!e.subMeshes||!o)return s;if(!i&&!vs.i.Intersects(o.boundingSphere,t))return s;const a=rp[0],l=rp[1];rp[2].setAll(0),rp[3].setAll(0);const h=new st.Ray(rp[2],rp[3],1);let c,u,d,p,m=1/0;const f=n.AA.Vector3[2],_=n.AA.Matrix[0];_.copyFrom(e.getWorldMatrix()),_.invert(),n.Pq.TransformCoordinatesToRef(t.center,_,f);for(let i=0;i<r.length;i++){r[i].projectToRef(f,e._positions,e.getIndices(),l),n.Pq.TransformCoordinatesToRef(l,e.getWorldMatrix(),l),c=n.Pq.Distance(l,t.center),d=n.Pq.DistanceSquared(l,e.getAbsolutePosition()),u=n.Pq.DistanceSquared(t.center,e.getAbsolutePosition()),-1!==u&&-1!==d&&d>u&&(c=0,l.copyFrom(t.center)),-1!==c&&c<m&&(m=c,st.Ray.CreateFromToToRef(t.center,l,h),h.length=2*m,p=h.intersectsMesh(e),a.copyFrom(l))}return m<t.radius&&(s.hit=!0,s.distance=m,s.pickedMesh=e,s.pickedPoint=a.clone(),p&&null!==p.bu&&null!==p.bv&&(s.faceId=p.faceId,s.subMeshId=p.subMeshId,s.bu=p.bu,s.bv=p.bv)),s}}sp._IdCounter=200,sp.Name=Tt.NEAR_INTERACTION,sp.Version=1,Ct.AddWebXRFeature(sp.Name,((e,t)=>()=>new sp(e,t)),sp.Version,!0);class np{constructor(e,t,i){this.element=e,this.sessionMode=t,this.referenceSpaceType=i}update(e){}}class op{}class ap{constructor(e,t){if(this._scene=e,this.options=t,this._activeButton=null,this._buttons=[],this.activeButtonChangedObservable=new s.cP,this._onSessionGranted=e=>{this._helper&&this._enterXRWithButtonIndex(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),!t.ignoreSessionGrantedEvent&&navigator.xr&&navigator.xr.addEventListener("sessiongranted",this._onSessionGranted),"undefined"!=typeof window&&window.location&&"http:"===window.location.protocol&&"localhost"!==window.location.hostname)throw H.S0.Warn("WebXR can only be served over HTTPS"),new Error("WebXR can only be served over HTTPS");if(t.customButtons)this._buttons=t.customButtons;else{this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;";const e=t.sessionMode||"immersive-vr",i=t.referenceSpaceType||"local-floor";let r=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+("undefined"==typeof SVGSVGElement?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";r+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';const s=document.createElement("style");s.appendChild(document.createTextNode(r)),document.getElementsByTagName("head")[0].appendChild(s);const n=document.createElement("button");n.className="babylonVRicon",n.title=`${e} - ${i}`,this._buttons.push(new np(n,e,i)),this._buttons[this._buttons.length-1].update=function(e){this.element.style.display=null===e||e===this?"":"none",n.className="babylonVRicon"+(e===this?" vrdisplaypresenting":"")},this._updateButtons(null)}const i=e.getEngine().getInputElement();i&&i.parentNode&&(i.parentNode.appendChild(this.overlay),e.onDisposeObservable.addOnce((()=>{this.dispose()})))}async setHelperAsync(e,t){this._helper=e,this._renderTarget=t;const i=this._buttons.map((t=>e.sessionManager.isSessionSupportedAsync(t.sessionMode)));e.onStateChangedObservable.add((e=>{3==e&&this._updateButtons(null)}));(await Promise.all(i)).forEach(((e,t)=>{e?(this.overlay.appendChild(this._buttons[t].element),this._buttons[t].element.onclick=this._enterXRWithButtonIndex.bind(this,t)):H.S0.Warn(`Session mode "${this._buttons[t].sessionMode}" not supported in browser`)}))}static async CreateAsync(e,t,i){const r=new ap(e,i);return await r.setHelperAsync(t,i.renderTarget||void 0),r}async _enterXRWithButtonIndex(e=0){if(2==this._helper.state)await this._helper.exitXRAsync(),this._updateButtons(null);else if(3==this._helper.state)try{await this._helper.enterXRAsync(this._buttons[e].sessionMode,this._buttons[e].referenceSpaceType,this._renderTarget,{optionalFeatures:this.options.optionalFeatures,requiredFeatures:this.options.requiredFeatures}),this._updateButtons(this._buttons[e])}catch(t){this._updateButtons(null);const i=this._buttons[e].element,r=i.title;i.title="Error entering XR session : "+r,i.classList.add("xr-error"),this.options.onError&&this.options.onError(t)}}dispose(){const e=this._scene.getEngine().getInputElement();e&&e.parentNode&&e.parentNode.contains(this.overlay)&&e.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this._onSessionGranted)}_updateButtons(e){this._activeButton=e,this._buttons.forEach((e=>{e.update(this._activeButton)})),this.activeButtonChangedObservable.notifyObservers(this._activeButton)}}var lp,hp;!function(e){e.WRIST="wrist",e.THUMB="thumb",e.INDEX="index",e.MIDDLE="middle",e.RING="ring",e.LITTLE="little"}(lp||(lp={})),function(e){e.WRIST="wrist",e.THUMB_METACARPAL="thumb-metacarpal",e.THUMB_PHALANX_PROXIMAL="thumb-phalanx-proximal",e.THUMB_PHALANX_DISTAL="thumb-phalanx-distal",e.THUMB_TIP="thumb-tip",e.INDEX_FINGER_METACARPAL="index-finger-metacarpal",e.INDEX_FINGER_PHALANX_PROXIMAL="index-finger-phalanx-proximal",e.INDEX_FINGER_PHALANX_INTERMEDIATE="index-finger-phalanx-intermediate",e.INDEX_FINGER_PHALANX_DISTAL="index-finger-phalanx-distal",e.INDEX_FINGER_TIP="index-finger-tip",e.MIDDLE_FINGER_METACARPAL="middle-finger-metacarpal",e.MIDDLE_FINGER_PHALANX_PROXIMAL="middle-finger-phalanx-proximal",e.MIDDLE_FINGER_PHALANX_INTERMEDIATE="middle-finger-phalanx-intermediate",e.MIDDLE_FINGER_PHALANX_DISTAL="middle-finger-phalanx-distal",e.MIDDLE_FINGER_TIP="middle-finger-tip",e.RING_FINGER_METACARPAL="ring-finger-metacarpal",e.RING_FINGER_PHALANX_PROXIMAL="ring-finger-phalanx-proximal",e.RING_FINGER_PHALANX_INTERMEDIATE="ring-finger-phalanx-intermediate",e.RING_FINGER_PHALANX_DISTAL="ring-finger-phalanx-distal",e.RING_FINGER_TIP="ring-finger-tip",e.PINKY_FINGER_METACARPAL="pinky-finger-metacarpal",e.PINKY_FINGER_PHALANX_PROXIMAL="pinky-finger-phalanx-proximal",e.PINKY_FINGER_PHALANX_INTERMEDIATE="pinky-finger-phalanx-intermediate",e.PINKY_FINGER_PHALANX_DISTAL="pinky-finger-phalanx-distal",e.PINKY_FINGER_TIP="pinky-finger-tip"}(hp||(hp={}));const cp=["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"],up={wrist:["wrist"],thumb:["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],index:["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],middle:["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],ring:["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],little:["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]};class dp{get handMesh(){return this._handMesh}getHandPartMeshes(e){return up[e].map((e=>this._jointMeshes[cp.indexOf(e)]))}getJointMesh(e){return this._jointMeshes[cp.indexOf(e)]}constructor(e,t,i,r,o=!1,a=!1,l=1){this.xrController=e,this._jointMeshes=t,this._handMesh=i,this.rigMapping=r,this._leftHandedMeshes=o,this._jointsInvisible=a,this._jointScaleFactor=l,this.onHandMeshSetObservable=new s.cP,this._jointTransforms=new Array(cp.length),this._jointTransformMatrices=new Float32Array(16*cp.length),this._tempJointMatrix=new n.uq,this._jointRadii=new Float32Array(cp.length),this._scene=t[0].getScene();for(let e=0;e<this._jointTransforms.length;e++)this._jointTransforms[e]=new mt.V(cp[e],this._scene),this._jointTransforms[e].rotationQuaternion=new n.PT,t[e].rotationQuaternion?t[e].rotationQuaternion=new n.PT:t[e].rotationQuaternion?.set(0,0,0,1);i&&this.setHandMesh(i,r),this.xrController.motionController&&this.xrController.motionController.rootMesh&&this.xrController.motionController.rootMesh.dispose(!1,!0),this.xrController.onMotionControllerInitObservable.add((e=>{e._doNotLoadControllerMesh=!0}))}setHandMesh(e,t,i){if(this._handMesh=e,e.alwaysSelectAsActiveMesh=!0,e.getChildMeshes().forEach((e=>{e.alwaysSelectAsActiveMesh=!0})),this._handMesh.skeleton){const e=this._handMesh.skeleton;cp.forEach(((i,r)=>{const s=e.getBoneIndexByName(t?t[i]:i);-1!==s&&e.bones[s].linkTransformNode(this._jointTransforms[r])}))}this.onHandMeshSetObservable.notifyObservers(this)}updateFromXRFrame(e,t){const i=this.xrController.inputSource.hand;if(!i)return;const r=i,s=cp.map((e=>r[e]||i.get(e)));let o=!1;if(e.fillPoses&&e.fillJointRadii)o=e.fillPoses(s,t,this._jointTransformMatrices)&&e.fillJointRadii(s,this._jointRadii);else if(e.getJointPose){o=!0;for(let i=0;i<s.length;i++){const r=e.getJointPose(s[i],t);if(!r){o=!1;break}this._jointTransformMatrices.set(r.transform.matrix,16*i),this._jointRadii[i]=r.radius||.008}}o&&(cp.forEach(((e,t)=>{const i=this._jointTransforms[t];n.uq.FromArrayToRef(this._jointTransformMatrices,16*t,this._tempJointMatrix),this._tempJointMatrix.decompose(void 0,i.rotationQuaternion,i.position);const r=this._jointRadii[t]*this._jointScaleFactor,s=this._jointMeshes[t];s.isVisible=!this._handMesh&&!this._jointsInvisible,s.position.copyFrom(i.position),s.rotationQuaternion.copyFrom(i.rotationQuaternion),s.scaling.setAll(r),this._scene.useRightHandedSystem||(s.position.z*=-1,s.rotationQuaternion.z*=-1,s.rotationQuaternion.w*=-1,this._leftHandedMeshes&&this._handMesh&&(i.position.z*=-1,i.rotationQuaternion.z*=-1,i.rotationQuaternion.w*=-1))})),this._handMesh&&(this._handMesh.isVisible=!0))}dispose(e=!1){this._handMesh&&(e?(this._handMesh.skeleton?.dispose(),this._handMesh.dispose(!1,!0)):this._handMesh.isVisible=!1),this._jointTransforms.forEach((e=>e.dispose())),this._jointTransforms.length=0,this.onHandMeshSetObservable.clear()}}class pp extends md{static _GenerateTrackedJointMeshes(e,t=$n("jointParent",pp._ICOSPHERE_PARAMS)){const i={};return["left","right"].map((r=>{const s=[];t.isVisible=!!e.jointMeshes?.keepOriginalVisible;for(let i=0;i<cp.length;++i){let o=t.createInstance(`${r}-handJoint-${i}`);if(e.jointMeshes?.onHandJointMeshGenerated){const t=e.jointMeshes.onHandJointMeshGenerated(o,i,r);t&&t!==o&&(o.dispose(),o=t)}if(o.isPickable=!1,e.jointMeshes?.enablePhysics){const t=e.jointMeshes?.physicsProps||{};o.scaling.setAll(.02);const i=void 0!==t.impostorType?t.impostorType:Xs.SphereImpostor;o.physicsImpostor=new Xs(o,i,{mass:0,...t})}o.rotationQuaternion=new n.PT,o.isVisible=!1,s.push(o)}i[r]=s})),{left:i.left,right:i.right}}static _GenerateDefaultHandMeshesAsync(e,t,i){return new Promise((async r=>{const s={};pp._RightHandGLB?.meshes[1]?.isDisposed()&&(pp._RightHandGLB=null),pp._LeftHandGLB?.meshes[1]?.isDisposed()&&(pp._LeftHandGLB=null);const n=!(!pp._RightHandGLB||!pp._LeftHandGLB),a=H.S0.GetAssetUrl(pp.DEFAULT_HAND_MODEL_BASE_URL),l=await Promise.all([pp._RightHandGLB||sd.cn.ImportMeshAsync("",a,pp.DEFAULT_HAND_MODEL_RIGHT_FILENAME,e),pp._LeftHandGLB||sd.cn.ImportMeshAsync("",a,pp.DEFAULT_HAND_MODEL_LEFT_FILENAME,e)]);pp._RightHandGLB=l[0],pp._LeftHandGLB=l[1];const h=H.S0.GetAssetUrl(pp.DEFAULT_HAND_MODEL_SHADER_URL),c=await Jd.ParseFromFileAsync("handShader",h,e,void 0,!0);c.needDepthPrePass=!0,c.transparencyMode=fn.i.MATERIAL_ALPHABLEND,c.alphaMode=2,c.build(!1);const u={base:o.v9.FromInts(116,63,203),fresnel:o.v9.FromInts(149,102,229),fingerColor:o.v9.FromInts(177,130,255),tipFresnel:o.v9.FromInts(220,200,255),...i?.handMeshes?.customColors},d={base:c.getBlockByName("baseColor"),fresnel:c.getBlockByName("fresnelColor"),fingerColor:c.getBlockByName("fingerColor"),tipFresnel:c.getBlockByName("tipFresnelColor")};d.base.value=u.base,d.fresnel.value=u.fresnel,d.fingerColor.value=u.fingerColor,d.tipFresnel.value=u.tipFresnel;const p=t._getBaseLayerWrapper()?.isMultiview;["left","right"].forEach((t=>{const r="left"==t?pp._LeftHandGLB:pp._RightHandGLB;if(!r)throw new Error("Could not load hand model");const o=r.meshes[1];o._internalAbstractMeshDataInfo._computeBonesUsingShaders=!0,p||i?.handMeshes?.disableHandShader||(o.material=c.clone(`${t}HandShaderClone`,!0)),o.isVisible=!1,s[t]=o,n||e.useRightHandedSystem||r.meshes[1].rotate(Mt._0.Y,Math.PI)})),c.dispose(),r({left:s.left,right:s.right})}))}static _GenerateDefaultHandMeshRigMapping(e){const t="right"==e?"R":"L";return{wrist:`wrist_${t}`,"thumb-metacarpal":`thumb_metacarpal_${t}`,"thumb-phalanx-proximal":`thumb_proxPhalanx_${t}`,"thumb-phalanx-distal":`thumb_distPhalanx_${t}`,"thumb-tip":`thumb_tip_${t}`,"index-finger-metacarpal":`index_metacarpal_${t}`,"index-finger-phalanx-proximal":`index_proxPhalanx_${t}`,"index-finger-phalanx-intermediate":`index_intPhalanx_${t}`,"index-finger-phalanx-distal":`index_distPhalanx_${t}`,"index-finger-tip":`index_tip_${t}`,"middle-finger-metacarpal":`middle_metacarpal_${t}`,"middle-finger-phalanx-proximal":`middle_proxPhalanx_${t}`,"middle-finger-phalanx-intermediate":`middle_intPhalanx_${t}`,"middle-finger-phalanx-distal":`middle_distPhalanx_${t}`,"middle-finger-tip":`middle_tip_${t}`,"ring-finger-metacarpal":`ring_metacarpal_${t}`,"ring-finger-phalanx-proximal":`ring_proxPhalanx_${t}`,"ring-finger-phalanx-intermediate":`ring_intPhalanx_${t}`,"ring-finger-phalanx-distal":`ring_distPhalanx_${t}`,"ring-finger-tip":`ring_tip_${t}`,"pinky-finger-metacarpal":`little_metacarpal_${t}`,"pinky-finger-phalanx-proximal":`little_proxPhalanx_${t}`,"pinky-finger-phalanx-intermediate":`little_intPhalanx_${t}`,"pinky-finger-phalanx-distal":`little_distPhalanx_${t}`,"pinky-finger-tip":`little_tip_${t}`}}isCompatible(){return"undefined"!=typeof XRHand}getHandByControllerId(e){return this._attachedHands[e]}getHandByHandedness(e){return"none"==e?null:this._trackingHands[e]}constructor(e,t){super(e),this.options=t,this._attachedHands={},this._trackingHands={left:null,right:null},this._handResources={jointMeshes:null,handMeshes:null,rigMappings:null},this._worldScaleObserver=null,this.onHandAddedObservable=new s.cP,this.onHandRemovedObservable=new s.cP,this._attachHand=e=>{if(!e.inputSource.hand||"none"==e.inputSource.handedness||!this._handResources.jointMeshes)return;const t=e.inputSource.handedness,i=new dp(e,this._handResources.jointMeshes[t],this._handResources.handMeshes&&this._handResources.handMeshes[t],this._handResources.rigMappings&&this._handResources.rigMappings[t],this.options.handMeshes?.meshesUseLeftHandedCoordinates,this.options.jointMeshes?.invisible,this.options.jointMeshes?.scaleFactor);this._attachedHands[e.uniqueId]=i,this._trackingHands[t]=i,this.onHandAddedObservable.notifyObservers(i)},this._detachHand=e=>{this._detachHandById(e.uniqueId)},this.xrNativeFeatureName="hand-tracking";const i=t.jointMeshes;if(i&&(void 0!==i.disableDefaultHandMesh&&(t.handMeshes=t.handMeshes||{},t.handMeshes.disableDefaultMeshes=i.disableDefaultHandMesh),void 0!==i.handMeshes&&(t.handMeshes=t.handMeshes||{},t.handMeshes.customMeshes=i.handMeshes),void 0!==i.leftHandedSystemMeshes&&(t.handMeshes=t.handMeshes||{},t.handMeshes.meshesUseLeftHandedCoordinates=i.leftHandedSystemMeshes),void 0!==i.rigMapping)){t.handMeshes=t.handMeshes||{};const e={},r={};[[i.rigMapping.left,e],[i.rigMapping.right,r]].forEach((e=>{const t=e[0],i=e[1];t.forEach(((e,t)=>{i[cp[t]]=e}))})),t.handMeshes.customRigMappings={left:e,right:r}}}attach(){return!!super.attach()&&(this._handResources.jointMeshes||(this._originalMesh=this._originalMesh||this.options.jointMeshes?.sourceMesh||$n("jointParent",pp._ICOSPHERE_PARAMS),this._originalMesh.isVisible=!1,this._handResources.jointMeshes=pp._GenerateTrackedJointMeshes(this.options,this._originalMesh)),this._handResources.handMeshes=this.options.handMeshes?.customMeshes||null,this._handResources.rigMappings=this.options.handMeshes?.customRigMappings||null,this.options.handMeshes?.customMeshes||this.options.handMeshes?.disableDefaultMeshes||(pp._GenerateDefaultHandMeshesAsync(C.q.LastCreatedScene,this._xrSessionManager,this.options).then((e=>{this._handResources.handMeshes=e,this._handResources.rigMappings={left:pp._GenerateDefaultHandMeshRigMapping("left"),right:pp._GenerateDefaultHandMeshRigMapping("right")},this._trackingHands.left?.setHandMesh(this._handResources.handMeshes.left,this._handResources.rigMappings.left,this._xrSessionManager),this._trackingHands.right?.setHandMesh(this._handResources.handMeshes.right,this._handResources.rigMappings.right,this._xrSessionManager),this._handResources.handMeshes.left.scaling.setAll(this._xrSessionManager.worldScalingFactor),this._handResources.handMeshes.right.scaling.setAll(this._xrSessionManager.worldScalingFactor)})),this._worldScaleObserver=this._xrSessionManager.onWorldScaleFactorChangedObservable.add((e=>{this._handResources.handMeshes&&(this._handResources.handMeshes.left.scaling.scaleInPlace(e.newScaleFactor/e.previousScaleFactor),this._handResources.handMeshes.right.scaling.scaleInPlace(e.newScaleFactor/e.previousScaleFactor))}))),this.options.xrInput.controllers.forEach(this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerAddedObservable,this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerRemovedObservable,this._detachHand),!0)}_onXRFrame(e){this._trackingHands.left?.updateFromXRFrame(e,this._xrSessionManager.referenceSpace),this._trackingHands.right?.updateFromXRFrame(e,this._xrSessionManager.referenceSpace)}_detachHandById(e,t){const i=this.getHandByControllerId(e);if(i){const r="left"==i.xrController.inputSource.handedness?"left":"right";this._trackingHands[r]?.xrController.uniqueId===e&&(this._trackingHands[r]=null),this.onHandRemovedObservable.notifyObservers(i),i.dispose(t),delete this._attachedHands[e]}}detach(){return!!super.detach()&&(Object.keys(this._attachedHands).forEach((e=>this._detachHandById(e,this.options.handMeshes?.disposeOnSessionEnd))),this.options.handMeshes?.disposeOnSessionEnd&&(this._handResources.jointMeshes&&(this._handResources.jointMeshes.left.forEach((e=>e.dispose())),this._handResources.jointMeshes.right.forEach((e=>e.dispose())),this._handResources.jointMeshes=null),this._handResources.handMeshes&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),this._handResources.handMeshes=null),pp._RightHandGLB?.meshes.forEach((e=>e.dispose())),pp._LeftHandGLB?.meshes.forEach((e=>e.dispose())),pp._RightHandGLB=null,pp._LeftHandGLB=null,this._originalMesh?.dispose(),this._originalMesh=void 0),this._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(this._worldScaleObserver),!0)}dispose(){super.dispose(),this.onHandAddedObservable.clear(),this.onHandRemovedObservable.clear(),this._handResources.handMeshes&&!this.options.handMeshes?.customMeshes&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),pp._RightHandGLB?.meshes.forEach((e=>e.dispose())),pp._LeftHandGLB?.meshes.forEach((e=>e.dispose())),pp._RightHandGLB=null,pp._LeftHandGLB=null),this._handResources.jointMeshes&&(this._handResources.jointMeshes.left.forEach((e=>e.dispose())),this._handResources.jointMeshes.right.forEach((e=>e.dispose())))}}pp.Name=Tt.HAND_TRACKING,pp.Version=1,pp.DEFAULT_HAND_MODEL_BASE_URL="https://assets.babylonjs.com/core/HandMeshes/",pp.DEFAULT_HAND_MODEL_RIGHT_FILENAME="r_hand_rhs.glb",pp.DEFAULT_HAND_MODEL_LEFT_FILENAME="l_hand_rhs.glb",pp.DEFAULT_HAND_MODEL_SHADER_URL="https://assets.babylonjs.com/core/HandMeshes/handsShader.json",pp._ICOSPHERE_PARAMS={radius:.5,flat:!1,subdivisions:2},pp._RightHandGLB=null,pp._LeftHandGLB=null,Ct.AddWebXRFeature(pp.Name,((e,t)=>()=>new pp(e,t)),pp.Version,!1);var mp=i(20472);class fp extends md{get rotationEnabled(){return this._rotationEnabled}set rotationEnabled(e){if(this._rotationEnabled=e,this._options.teleportationTargetMesh){const t=this._options.teleportationTargetMesh.getChildMeshes(!1,(e=>"rotationCone"===e.name));t[0]&&t[0].setEnabled(e)}}get teleportationTargetMesh(){return this._options.teleportationTargetMesh||null}constructor(e,t){super(e),this._options=t,this._controllers={},this._snappedToPoint=!1,this._cachedColor4White=new o.ov(1,1,1,1),this._tmpRay=new st.Ray(new n.Pq,new n.Pq),this._tmpVector=new n.Pq,this._tmpQuaternion=new n.PT,this._worldScaleObserver=null,this.skipNextTeleportation=!1,this.backwardsMovementEnabled=!0,this.backwardsTeleportationDistance=.7,this.parabolicCheckRadius=5,this.parabolicRayEnabled=!0,this.straightRayEnabled=!0,this.rotationAngle=Math.PI/8,this.onTargetMeshPositionUpdatedObservable=new s.cP,this.teleportationEnabled=!0,this._rotationEnabled=!0,this.onBeforeCameraTeleportRotation=new s.cP,this.onAfterCameraTeleportRotation=new s.cP,this._attachController=e=>{if(this._controllers[e.uniqueId]||this._options.forceHandedness&&e.inputSource.handedness!==this._options.forceHandedness)return;this._controllers[e.uniqueId]={xrController:e,teleportationState:{forward:!1,backwards:!1,rotating:!1,currentRotation:0,baseRotation:0,blocked:!1,initialHit:!1,mainComponentUsed:!1}};const t=this._controllers[e.uniqueId];if("tracked-pointer"===t.xrController.inputSource.targetRayMode&&t.xrController.inputSource.gamepad){const i=()=>{if(e.motionController){const i=e.motionController.getComponentOfType(rd.THUMBSTICK_TYPE)||e.motionController.getComponentOfType(rd.TOUCHPAD_TYPE);if(!i||this._options.useMainComponentOnly){const i=e.motionController.getMainComponent();if(!i)return;t.teleportationState.mainComponentUsed=!0,t.teleportationComponent=i,t.onButtonChangedObserver=i.onButtonStateChangedObservable.add((()=>{if(!this.teleportationEnabled)return;const r=()=>{t.teleportationState.forward=!0,t.teleportationState.initialHit=!1,this._currentTeleportationControllerId=t.xrController.uniqueId,t.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,t.teleportationState.currentRotation=0;const r=this._options.timeToTeleport||3e3;(0,mp.fj)({timeout:r,contextObservable:this._xrSessionManager.onXRFrameObservable,breakCondition:()=>!i.pressed,onEnded:()=>{this._currentTeleportationControllerId===t.xrController.uniqueId&&t.teleportationState.forward&&this._teleportForward(e.uniqueId)}})};i.changes.pressed&&(i.changes.pressed.current?this._options.timeToTeleportStart?(0,mp.fj)({timeout:this._options.timeToTeleportStart,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{i.pressed&&r()}}):r():(t.teleportationState.forward=!1,this._currentTeleportationControllerId=""))}))}else t.teleportationComponent=i,t.onAxisChangedObserver=i.onAxisValueChangedObservable.add((i=>{if(i.y<=.7&&t.teleportationState.backwards&&(t.teleportationState.backwards=!1),i.y>.7&&!t.teleportationState.forward&&this.backwardsMovementEnabled&&!this.snapPointsOnly&&!t.teleportationState.backwards){t.teleportationState.backwards=!0,this._tmpQuaternion.copyFrom(this._options.xrInput.xrCamera.rotationQuaternion),this._tmpQuaternion.toEulerAnglesToRef(this._tmpVector),this._tmpVector.x=0,this._tmpVector.z=0,n.PT.FromEulerVectorToRef(this._tmpVector,this._tmpQuaternion),this._tmpVector.set(0,0,this.backwardsTeleportationDistance*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),this._tmpVector.rotateByQuaternionToRef(this._tmpQuaternion,this._tmpVector),this._tmpVector.addInPlace(this._options.xrInput.xrCamera.position),this._tmpRay.origin.copyFrom(this._tmpVector),this._tmpRay.length=this._options.xrInput.xrCamera.realWorldHeight+.1,this._tmpRay.direction.set(0,-1,0);const e=this._xrSessionManager.scene.pickWithRay(this._tmpRay,(e=>-1!==this._floorMeshes.indexOf(e)));e&&e.pickedPoint&&(this._options.xrInput.xrCamera.position.x=e.pickedPoint.x,this._options.xrInput.xrCamera.position.z=e.pickedPoint.z)}if(i.y<-.7&&!this._currentTeleportationControllerId&&!t.teleportationState.rotating&&this.teleportationEnabled&&(t.teleportationState.forward=!0,this._currentTeleportationControllerId=t.xrController.uniqueId,t.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y),i.x){if(t.teleportationState.forward)this._currentTeleportationControllerId===t.xrController.uniqueId&&(this.rotationEnabled?setTimeout((()=>{t.teleportationState.currentRotation=Math.atan2(i.x,i.y*(this._xrSessionManager.scene.useRightHandedSystem?1:-1))})):t.teleportationState.currentRotation=0);else if(!t.teleportationState.rotating&&Math.abs(i.x)>.7){t.teleportationState.rotating=!0;const e=this.rotationAngle*(i.x>0?1:-1)*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);this.onBeforeCameraTeleportRotation.notifyObservers(e),n.PT.FromEulerAngles(0,e,0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this.onAfterCameraTeleportRotation.notifyObservers(this._options.xrInput.xrCamera.rotationQuaternion)}}else t.teleportationState.rotating=!1;0===i.x&&0===i.y&&(t.teleportationState.blocked&&(t.teleportationState.blocked=!1,this._setTargetMeshVisibility(!1)),t.teleportationState.forward&&this._teleportForward(e.uniqueId))}))}};e.motionController?i():e.onMotionControllerInitObservable.addOnce((()=>{i()}))}else{t.teleportationState.mainComponentUsed=!0;let i=!1;const r=()=>{this._currentTeleportationControllerId=t.xrController.uniqueId,t.teleportationState.forward=!0,t.teleportationState.initialHit=!1,t.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,t.teleportationState.currentRotation=0;const i=this._options.timeToTeleport||3e3;(0,mp.fj)({timeout:i,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===t.xrController.uniqueId&&t.teleportationState.forward&&this._teleportForward(e.uniqueId)}})};this._xrSessionManager.scene.onPointerObservable.add((e=>{e.type===rt.Zp.POINTERDOWN?(i=!1,this._options.timeToTeleportStart?(0,mp.fj)({timeout:this._options.timeToTeleportStart,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===t.xrController.uniqueId&&r()},breakCondition:()=>!!i&&(i=!1,!0)}):r()):e.type===rt.Zp.POINTERUP&&(i=!0,t.teleportationState.forward=!1,this._currentTeleportationControllerId="")}))}},this._colorArray=Array(24).fill(this._cachedColor4White),this._options.teleportationTargetMesh||this._createDefaultTargetMesh(),this._floorMeshes=this._options.floorMeshes||[],this._snapToPositions=this._options.snapPositions||[],this._blockedRayColor=this._options.blockedRayColor||new o.ov(1,0,0,.75),this._setTargetMeshVisibility(!1),this.onBeforeCameraTeleport=t.xrInput.xrCamera.onBeforeCameraTeleport,this.onAfterCameraTeleport=t.xrInput.xrCamera.onAfterCameraTeleport,this.parabolicCheckRadius*=this._xrSessionManager.worldScalingFactor,this._worldScaleObserver=e.onWorldScaleFactorChangedObservable.add((e=>{this.parabolicCheckRadius=this.parabolicCheckRadius/e.previousScaleFactor*e.newScaleFactor,this._options.teleportationTargetMesh?.scaling.scaleInPlace(e.newScaleFactor/e.previousScaleFactor)}))}get snapPointsOnly(){return!!this._options.snapPointsOnly}set snapPointsOnly(e){this._options.snapPointsOnly=e}addFloorMesh(e){this._floorMeshes.push(e)}addBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[],this._options.pickBlockerMeshes.push(e)}addSnapPoint(e){this._snapToPositions.push(e)}attach(){return!!super.attach()&&(this._currentTeleportationControllerId="",this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),this._setTargetMeshVisibility(!1),this._currentTeleportationControllerId="",this._controllers={},!0)}dispose(){super.dispose(),this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.dispose(!1,!0),this._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(this._worldScaleObserver),this.onTargetMeshPositionUpdatedObservable.clear(),this.onTargetMeshPositionUpdatedObservable.clear(),this.onBeforeCameraTeleportRotation.clear(),this.onAfterCameraTeleportRotation.clear(),this.onBeforeCameraTeleport.clear(),this.onAfterCameraTeleport.clear()}removeFloorMesh(e){const t=this._floorMeshes.indexOf(e);-1!==t&&this._floorMeshes.splice(t,1)}removeBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[];const t=this._options.pickBlockerMeshes.indexOf(e);-1!==t&&this._options.pickBlockerMeshes.splice(t,1)}removeFloorMeshByName(e){const t=this._xrSessionManager.scene.getMeshByName(e);t&&this.removeFloorMesh(t)}removeSnapPoint(e){let t=this._snapToPositions.indexOf(e);if(-1===t)for(let i=0;i<this._snapToPositions.length;++i)if(this._snapToPositions[i].equals(e)){t=i;break}return-1!==t&&(this._snapToPositions.splice(t,1),!0)}setSelectionFeature(e){this._selectionFeature=e}_onXRFrame(e){const t=this._xrSessionManager.currentFrame,i=this._xrSessionManager.scene;if(!this.attach||!t)return;const r=this._options.teleportationTargetMesh;if(this._currentTeleportationControllerId){if(!r)return;r.rotationQuaternion=r.rotationQuaternion||new n.PT;const e=this._controllers[this._currentTeleportationControllerId];if(e&&e.teleportationState.forward){n.PT.RotationYawPitchRollToRef(e.teleportationState.currentRotation+e.teleportationState.baseRotation,0,0,r.rotationQuaternion);let t=!1;const s="transient-pointer"!==e.xrController.inputSource.targetRayMode;if(e.xrController.getWorldPointerRayToRef(this._tmpRay),this.straightRayEnabled){const r=i.pickWithRay(this._tmpRay,(e=>{if(this._options.blockerMeshesPredicate&&this._options.blockerMeshesPredicate(e))return!0;if(this._options.blockAllPickableMeshes&&e.isPickable)return!0;if(this._options.pickBlockerMeshes&&-1!==this._options.pickBlockerMeshes.indexOf(e))return!0;const t=this._floorMeshes.indexOf(e);return-1!==t&&this._floorMeshes[t].absolutePosition.y<this._options.xrInput.xrCamera.globalPosition.y})),n=r&&r.pickedMesh&&-1!==this._floorMeshes.indexOf(r.pickedMesh);if(r&&r.pickedMesh&&!n)return e.teleportationState.mainComponentUsed&&!e.teleportationState.initialHit?void(e.teleportationState.forward=!1):(e.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1,!1,s),void this._showParabolicPath(r));r&&r.pickedPoint&&(e.teleportationState.initialHit=!0,e.teleportationState.blocked=!1,t=!0,this._setTargetMeshPosition(r),this._setTargetMeshVisibility(!0,!1,s),this._showParabolicPath(r))}if(this.parabolicRayEnabled&&!t){const r=e.xrController.pointer.rotationQuaternion.toEulerAngles().x,n=Math.PI/2-Math.abs(r)+1,o=this.parabolicCheckRadius*n;this._tmpRay.origin.addToRef(this._tmpRay.direction.scale(2*o),this._tmpVector),this._tmpVector.y=this._tmpRay.origin.y,this._tmpRay.origin.addInPlace(this._tmpRay.direction.scale(o)),this._tmpVector.subtractToRef(this._tmpRay.origin,this._tmpRay.direction),this._tmpRay.direction.normalize();const a=i.pickWithRay(this._tmpRay,(e=>!(!this._options.blockerMeshesPredicate||!this._options.blockerMeshesPredicate(e))||(!(!this._options.blockAllPickableMeshes||!e.isPickable)||(!(!this._options.pickBlockerMeshes||-1===this._options.pickBlockerMeshes.indexOf(e))||-1!==this._floorMeshes.indexOf(e))))),l=a&&a.pickedMesh&&-1!==this._floorMeshes.indexOf(a.pickedMesh);if(a&&a.pickedMesh&&!l)return e.teleportationState.mainComponentUsed&&!e.teleportationState.initialHit?void(e.teleportationState.forward=!1):(e.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1,!1,s),void this._showParabolicPath(a));a&&a.pickedPoint&&(e.teleportationState.initialHit=!0,e.teleportationState.blocked=!1,t=!0,this._setTargetMeshPosition(a),this._setTargetMeshVisibility(!0,!1,s),this._showParabolicPath(a))}this._setTargetMeshVisibility(t,!1,s)}else this._setTargetMeshVisibility(!1,!1,!0)}else this._disposeBezierCurve(),this._setTargetMeshVisibility(!1,!1,!0)}_createDefaultTargetMesh(){this._options.defaultTargetMeshOptions=this._options.defaultTargetMeshOptions||{};const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Rs.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,t=(0,Br.km)("teleportationTarget",{width:2,height:2,subdivisions:2},e);if(t.isPickable=!1,this._options.defaultTargetMeshOptions.teleportationCircleMaterial)t.material=this._options.defaultTargetMeshOptions.teleportationCircleMaterial;else{const i=512,r=new Tr("teleportationPlaneDynamicTexture",i,e,!0);r.hasAlpha=!0;const s=r.getContext(),n=i/2,o=i/2,a=200;s.beginPath(),s.arc(n,o,a,0,2*Math.PI,!1),s.fillStyle=this._options.defaultTargetMeshOptions.teleportationFillColor||"#444444",s.fill(),s.lineWidth=10,s.strokeStyle=this._options.defaultTargetMeshOptions.teleportationBorderColor||"#FFFFFF",s.stroke(),s.closePath(),r.update();const l=new br.F("teleportationPlaneMaterial",e);l.diffuseTexture=r,t.material=l}const i=Lr("torusTeleportation",{diameter:.75,thickness:.1,tessellation:20},e);if(i.isPickable=!1,i.parent=t,!this._options.defaultTargetMeshOptions.disableAnimation){const t=new M.X5("animationInnerCircle","position.y",30,M.X5.ANIMATIONTYPE_FLOAT,M.X5.ANIMATIONLOOPMODE_CYCLE),r=[];r.push({frame:0,value:0}),r.push({frame:30,value:.4}),r.push({frame:60,value:0}),t.setKeys(r);const s=new F.kc;s.setEasingMode(F.KA.EASINGMODE_EASEINOUT),t.setEasingFunction(s),i.animations=[],i.animations.push(t),e.beginAnimation(i,0,60,!0)}const r=Es("rotationCone",{diameterTop:0,tessellation:4},e);if(r.isPickable=!1,r.scaling.set(.5,.12,.2),r.rotate(Mt._0.X,Math.PI/2),r.position.z=.6,r.parent=i,this._options.defaultTargetMeshOptions.torusArrowMaterial)i.material=this._options.defaultTargetMeshOptions.torusArrowMaterial,r.material=this._options.defaultTargetMeshOptions.torusArrowMaterial;else{const t=new br.F("torusConsMat",e);t.disableLighting=!!this._options.defaultTargetMeshOptions.disableLighting,t.disableLighting?t.emissiveColor=new o.v9(.3,.3,1):t.diffuseColor=new o.v9(.3,.3,1),t.alpha=.9,i.material=t,r.material=t,this._teleportationRingMaterial=t}void 0!==this._options.renderingGroupId&&(t.renderingGroupId=this._options.renderingGroupId,i.renderingGroupId=this._options.renderingGroupId,r.renderingGroupId=this._options.renderingGroupId),this._options.teleportationTargetMesh=t,this._options.teleportationTargetMesh.scaling.setAll(this._xrSessionManager.worldScalingFactor),this._setTargetMeshVisibility(!1)}_detachController(e){const t=this._controllers[e];t&&(t.teleportationComponent&&(t.onAxisChangedObserver&&t.teleportationComponent.onAxisValueChangedObservable.remove(t.onAxisChangedObserver),t.onButtonChangedObserver&&t.teleportationComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver)),delete this._controllers[e])}_findClosestSnapPointWithRadius(e,t=this._options.snapToPositionRadius||.8){let i=null,r=Number.MAX_VALUE;if(this._snapToPositions.length){const s=t*t;this._snapToPositions.forEach((t=>{const o=n.Pq.DistanceSquared(t,e);o<=s&&o<r&&(r=o,i=t)}))}return i}_setTargetMeshPosition(e){const t=e.pickedPoint;if(!this._options.teleportationTargetMesh||!t)return;const i=this._findClosestSnapPointWithRadius(t);this._snappedToPoint=!!i,this.snapPointsOnly&&!this._snappedToPoint&&this._teleportationRingMaterial?this._teleportationRingMaterial.diffuseColor.set(1,.3,.3):this.snapPointsOnly&&this._snappedToPoint&&this._teleportationRingMaterial&&this._teleportationRingMaterial.diffuseColor.set(.3,.3,1),this._options.teleportationTargetMesh.position.copyFrom(i||t),this._options.teleportationTargetMesh.position.y+=.01,this.onTargetMeshPositionUpdatedObservable.notifyObservers(e)}_setTargetMeshVisibility(e,t,i){this._options.teleportationTargetMesh&&(this._options.teleportationTargetMesh.isVisible!==e||t)&&(this._options.teleportationTargetMesh.isVisible=e,this._options.teleportationTargetMesh.getChildren(void 0,!1).forEach((t=>{t.isVisible=e})),e?this._selectionFeature&&i&&this._selectionFeature.detach():(this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null),this._selectionFeature&&i&&this._selectionFeature.attach()))}_disposeBezierCurve(){this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null)}_showParabolicPath(e){if(!e.pickedPoint||!this._currentTeleportationControllerId)return;const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Rs.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,i=this._controllers[this._currentTeleportationControllerId],r=Tn.jj.CreateQuadraticBezier(i.xrController.pointer.absolutePosition,e.ray.origin,e.pickedPoint,25),s=i.teleportationState.blocked?this._blockedRayColor:void 0,n=this._colorArray.fill(s||this._cachedColor4White),o=r.getPoints();o.shift(),o.shift(),this._options.generateRayPathMesh?this._quadraticBezierCurve=this._options.generateRayPathMesh(r.getPoints(),e):this._quadraticBezierCurve=bn("teleportation path line",{points:o,instance:this._quadraticBezierCurve,updatable:!0,colors:n},t),this._quadraticBezierCurve.isPickable=!1,void 0!==this._options.renderingGroupId&&(this._quadraticBezierCurve.renderingGroupId=this._options.renderingGroupId)}_teleportForward(e){const t=this._controllers[e];if(t&&t.teleportationState.forward&&this.teleportationEnabled&&(t.teleportationState.forward=!1,this._currentTeleportationControllerId="",!this.snapPointsOnly||this._snappedToPoint))if(this.skipNextTeleportation)this.skipNextTeleportation=!1;else if(this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.isVisible){const e=this._options.xrInput.xrCamera.realWorldHeight;this.onBeforeCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position),this._options.xrInput.xrCamera.position.copyFrom(this._options.teleportationTargetMesh.position),this._options.xrInput.xrCamera.position.y+=e,n.PT.FromEulerAngles(0,t.teleportationState.currentRotation-(this._xrSessionManager.scene.useRightHandedSystem?Math.PI:0),0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this.onAfterCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position)}}}fp.Name=Tt.TELEPORTATION,fp.Version=1,Ct.AddWebXRFeature(fp.Name,((e,t)=>()=>new fp(e,t)),fp.Version,!0);class _p{}class gp{constructor(){}static CreateAsync(e,t={}){const i=new gp;if(e.onDisposeObservable.addOnce((()=>{i.dispose()})),!t.disableDefaultUI){const r={renderTarget:i.renderTarget,...t.uiOptions||{}};t.optionalFeatures&&("boolean"==typeof t.optionalFeatures?r.optionalFeatures=["hit-test","anchors","plane-detection","hand-tracking"]:r.optionalFeatures=t.optionalFeatures),i.enterExitUI=new ap(e,r)}return id.CreateAsync(e).then((e=>{if(i.baseExperience=e,t.ignoreNativeCameraTransformation&&(i.baseExperience.camera.compensateOnFirstFrame=!1),i.input=new pd(e.sessionManager,e.camera,{controllerOptions:{renderingGroupId:t.renderingGroupId},...t.inputOptions||{}}),!t.disablePointerSelection){const e={...t.pointerSelectionOptions,xrInput:i.input,renderingGroupId:t.renderingGroupId};i.pointerSelection=i.baseExperience.featuresManager.enableFeature(fd.Name,t.useStablePlugins?"stable":"latest",e),t.disableTeleportation||(i.teleportation=i.baseExperience.featuresManager.enableFeature(fp.Name,t.useStablePlugins?"stable":"latest",{floorMeshes:t.floorMeshes,xrInput:i.input,renderingGroupId:t.renderingGroupId,...t.teleportationOptions}),i.teleportation.setSelectionFeature(i.pointerSelection))}return t.disableNearInteraction||(i.nearInteraction=i.baseExperience.featuresManager.enableFeature(sp.Name,t.useStablePlugins?"stable":"latest",{xrInput:i.input,farInteractionFeature:i.pointerSelection,renderingGroupId:t.renderingGroupId,useUtilityLayer:!0,enableNearInteractionOnAllControllers:!0,...t.nearInteractionOptions})),t.disableHandTracking||i.baseExperience.featuresManager.enableFeature(pp.Name,t.useStablePlugins?"stable":"latest",{xrInput:i.input,...t.handSupportOptions},void 0,!1),i.renderTarget=i.baseExperience.sessionManager.getWebXRRenderTarget(t.outputCanvasOptions),t.disableDefaultUI?void 0:i.enterExitUI.setHelperAsync(i.baseExperience,i.renderTarget)})).then((()=>i)).catch((e=>(m.V.Error("Error initializing XR"),m.V.Error(e),i)))}dispose(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()}}var xp=!0;function vp(e){for(;e.firstChild;)e.removeChild(e.firstChild);e.srcObject=null,e.src="",e.removeAttribute("src")}it.Z.prototype.createDefaultLight=function(e=!1){if(e&&this.lights)for(let e=0;e<this.lights.length;e++)this.lights[e].dispose();0===this.lights.length&&new Is.g("default light",n.Pq.Up(),this)},it.Z.prototype.createDefaultCamera=function(e=!1,t=!1,i=!1){if(t&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){const t=this.getWorldExtends((e=>e.isVisible&&e.isEnabled())),r=t.max.subtract(t.min),s=t.min.add(r.scale(.5));let o,a=1.5*r.length();if(isFinite(a)||(a=1,s.copyFromFloats(0,0,0)),e){const e=new fi.Lq("default camera",-Math.PI/2,Math.PI/2,a,s,this);e.lowerRadiusLimit=.01*a,e.wheelPrecision=100/a,o=e}else{const e=new di.S("default camera",new n.Pq(s.x,s.y,-a),this);e.setTarget(s),o=e}o.minZ=.01*a,o.maxZ=1e3*a,o.speed=.2*a,this.activeCamera=o,i&&o.attachControl()}},it.Z.prototype.createDefaultCameraOrLight=function(e=!1,t=!1,i=!1){this.createDefaultLight(t),this.createDefaultCamera(e,t,i)},it.Z.prototype.createDefaultSkybox=function(e,t=!1,i=1e3,r=0,s=!0){if(!e)return m.V.Warn("Can not create default skybox without environment texture."),null;s&&e&&(this.environmentTexture=e);const n=(0,ks.an)("hdrSkyBox",{size:i},this);if(t){const t=new Qu.Y("skyBox",this);t.backFaceCulling=!1,t.reflectionTexture=e.clone(),t.reflectionTexture&&(t.reflectionTexture.coordinatesMode=$e.g.SKYBOX_MODE),t.microSurface=1-r,t.disableLighting=!0,t.twoSidedLighting=!0,n.material=t}else{const t=new br.F("skyBox",this);t.backFaceCulling=!1,t.reflectionTexture=e.clone(),t.reflectionTexture&&(t.reflectionTexture.coordinatesMode=$e.g.SKYBOX_MODE),t.disableLighting=!0,n.material=t}return n.isPickable=!1,n.infiniteDistance=!0,n.ignoreCameraMaxZ=!0,n},it.Z.prototype.createDefaultEnvironment=function(e){return Xu?new Xu(e,this):null},it.Z.prototype.createDefaultVRExperience=function(e={}){return new Wr(this,e)},it.Z.prototype.createDefaultXRExperienceAsync=function(e={}){return gp.CreateAsync(this,e).then((e=>e))};class Sp extends $e.g{get onUserActionRequestedObservable(){return this._onUserActionRequestedObservable||(this._onUserActionRequestedObservable=new s.cP),this._onUserActionRequestedObservable}_processError(e){this._errorFound=!0,this._onError?this._onError(e?.message):m.V.Error(e?.message)}_handlePlay(){this._errorFound=!1,this.video.play().catch((e=>{if("NotAllowedError"===e?.name){if(this._onUserActionRequestedObservable&&this._onUserActionRequestedObservable.hasObservers())return void this._onUserActionRequestedObservable.notifyObservers(this);if(!this.video.muted)return m.V.Warn("Unable to autoplay a video with sound. Trying again with muted turned true"),this.video.muted=!0,this._errorFound=!1,void this.video.play().catch((e=>{this._processError(e)}))}this._processError(e)}))}constructor(e,t,i,r=!1,s=!1,n=$e.g.TRILINEAR_SAMPLINGMODE,o={},a,l=5){super(null,i,!r,s),this._externalTexture=null,this._onUserActionRequestedObservable=null,this._stillImageCaptured=!1,this._displayingPosterTexture=!1,this._frameId=-1,this._currentSrc=null,this._errorFound=!1,this.isVideo=!0,this._resizeInternalTexture=()=>{null!=this._texture&&this._texture.dispose(),!this._getEngine().needPOTTextures||H.S0.IsExponentOfTwo(this.video.videoWidth)&&H.S0.IsExponentOfTwo(this.video.videoHeight)?(this.wrapU=$e.g.WRAP_ADDRESSMODE,this.wrapV=$e.g.WRAP_ADDRESSMODE):(this.wrapU=$e.g.CLAMP_ADDRESSMODE,this.wrapV=$e.g.CLAMP_ADDRESSMODE,this._generateMipMaps=!1),this._texture=this._getEngine().createDynamicTexture(this.video.videoWidth,this.video.videoHeight,this._generateMipMaps,this.samplingMode),this._texture.format=this._format??5,this._frameId=-1,this._updateInternalTexture()},this._createInternalTexture=()=>{if(null!=this._texture){if(!this._displayingPosterTexture)return;this._displayingPosterTexture=!1}if(this.video.addEventListener("resize",this._resizeInternalTexture),this._resizeInternalTexture(),this.video.autoplay||this._settings.poster||this._settings.independentVideoSource)this._updateInternalTexture(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this);else{const e=this.video.onplaying,t=this.video.muted;this.video.muted=!0,this.video.onplaying=()=>{this.video.muted=t,this.video.onplaying=e,this._updateInternalTexture(),this._errorFound||this.video.pause(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this)},this._handlePlay()}},this._reset=()=>{null!=this._texture&&(this._displayingPosterTexture||(this._texture.dispose(),this._texture=null))},this._updateInternalTexture=()=>{if(null==this._texture)return;if(this.video.readyState<this.video.HAVE_CURRENT_DATA)return;if(this._displayingPosterTexture)return;const e=this.getScene().getFrameId();this._frameId!==e&&(this._frameId=e,this._getEngine().updateVideoTexture(this._texture,this._externalTexture?this._externalTexture:this.video,this._invertY))},this._settings={autoPlay:!0,loop:!0,autoUpdateTexture:!0,...o},this._onError=a,this._generateMipMaps=r,this._initialSamplingMode=n,this.autoUpdateTexture=this._settings.autoUpdateTexture,this._currentSrc=t,this.name=e||this._getName(t),this.video=this._getVideo(t);const h=this._engine,c=h?.createExternalTexture;c&&(this._externalTexture=c.call(h,this.video)),this._settings.independentVideoSource||(this._settings.poster&&(this.video.poster=this._settings.poster),void 0!==this._settings.autoPlay&&(this.video.autoplay=this._settings.autoPlay),void 0!==this._settings.loop&&(this.video.loop=this._settings.loop),void 0!==this._settings.muted&&(this.video.muted=this._settings.muted),this.video.setAttribute("playsinline",""),this.video.addEventListener("paused",this._updateInternalTexture),this.video.addEventListener("seeked",this._updateInternalTexture),this.video.addEventListener("loadeddata",this._updateInternalTexture),this.video.addEventListener("emptied",this._reset),this._settings.autoPlay&&this._handlePlay()),this._createInternalTextureOnEvent=this._settings.poster&&!this._settings.autoPlay?"play":"canplay",this.video.addEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._format=l;const u=this.video.readyState>=this.video.HAVE_CURRENT_DATA;!this._settings.poster||this._settings.autoPlay&&u?u&&this._createInternalTexture():(this._texture=this._getEngine().createTexture(this._settings.poster,!1,!this.invertY,i),this._displayingPosterTexture=!0)}getClassName(){return"VideoTexture"}_getName(e){return e instanceof HTMLVideoElement?e.currentSrc:"object"==typeof e?e.toString():e}_getVideo(e){if(e.isNative)return e;if(e instanceof HTMLVideoElement)return H.S0.SetCorsBehavior(e.currentSrc,e),e;const t=document.createElement("video");return"string"==typeof e?(H.S0.SetCorsBehavior(e,t),t.src=e):(H.S0.SetCorsBehavior(e[0],t),e.forEach((e=>{const i=document.createElement("source");i.src=e,t.appendChild(i)}))),this.onDisposeObservable.addOnce((()=>{vp(t)})),t}_rebuild(){this.update()}update(){this.autoUpdateTexture&&this.updateTexture(!0)}updateTexture(e){e&&(this.video.paused&&this._stillImageCaptured||(this._stillImageCaptured=!0,this._updateInternalTexture()))}get externalTexture(){return this._externalTexture}updateURL(e){this.video.src=e,this._currentSrc=e}clone(){return new Sp(this.name,this._currentSrc,this.getScene(),this._generateMipMaps,this.invertY,this.samplingMode,this._settings)}dispose(){super.dispose(),this._currentSrc=null,this._onUserActionRequestedObservable&&(this._onUserActionRequestedObservable.clear(),this._onUserActionRequestedObservable=null),this.video.removeEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._settings.independentVideoSource||(this.video.removeEventListener("paused",this._updateInternalTexture),this.video.removeEventListener("seeked",this._updateInternalTexture),this.video.removeEventListener("loadeddata",this._updateInternalTexture),this.video.removeEventListener("emptied",this._reset),this.video.removeEventListener("resize",this._resizeInternalTexture),this.video.pause()),this._externalTexture?.dispose()}static CreateFromStreamAsync(e,t,i,r=!0){const s=e.getEngine().createVideoElement(i);return e.getEngine()._badOS&&(document.body.appendChild(s),s.style.transform="scale(0.0001, 0.0001)",s.style.opacity="0",s.style.position="fixed",s.style.bottom="0px",s.style.right="0px"),s.setAttribute("autoplay",""),s.setAttribute("muted","true"),s.setAttribute("playsinline",""),s.muted=!0,s.isNative||("object"==typeof s.srcObject?s.srcObject=t:s.src=window.URL&&window.URL.createObjectURL(t)),new Promise((t=>{const i=()=>{const n=new Sp("video",s,e,!0,r,void 0,void 0,void 0,4);e.getEngine()._badOS&&n.onDisposeObservable.addOnce((()=>{s.remove()})),n.onDisposeObservable.addOnce((()=>{vp(s)})),t(n),s.removeEventListener("playing",i)};s.addEventListener("playing",i),s.play()}))}static async CreateFromWebCamAsync(e,t,i=!1,r=!0){if(navigator.mediaDevices){const s=await navigator.mediaDevices.getUserMedia({video:t,audio:i}),n=await this.CreateFromStreamAsync(e,s,t,r);return n.onDisposeObservable.addOnce((()=>{s.getTracks().forEach((e=>{e.stop()}))})),n}return Promise.reject("No support for userMedia on this device")}static CreateFromWebCam(e,t,i,r=!1,s=!0){this.CreateFromWebCamAsync(e,i,r,s).then((function(e){t&&t(e)})).catch((function(e){m.V.Error(e.name)}))}}(0,Ge.Cg)([(0,ze.lK)("settings")],Sp.prototype,"_settings",void 0),(0,Ge.Cg)([(0,ze.lK)("src")],Sp.prototype,"_currentSrc",void 0),(0,Ge.Cg)([(0,ze.lK)()],Sp.prototype,"isVideo",void 0),$e.g._CreateVideoTexture=(e,t,i,r=!1,s=!1,n=$e.g.TRILINEAR_SAMPLINGMODE,o={},a,l=5)=>new Sp(e,t,i,r,s,n,o,a,l),(0,a.Y5)("BABYLON.VideoTexture",Sp);class bp extends ju{get videoTexture(){return this._texture}get videoMode(){return this.textureMode}set videoMode(e){this.textureMode=e}_initTexture(e,t,i){const r={loop:i.loop,autoPlay:i.autoPlay,autoUpdateTexture:!0,poster:i.poster},s=new Sp((this.name||"videoDome")+"_texture",e,t,i.generateMipMaps,this._useDirectMapping,$e.g.TRILINEAR_SAMPLINGMODE,r);return i.clickToPlay&&(this._pointerObserver=t.onPointerObservable.add((e=>{e.pickInfo?.pickedMesh===this.mesh&&this._texture.video.play()}),rt.Zp.POINTERDOWN)),this._textureObserver=s.onLoadObservable.add((()=>{this.onLoadObservable.notifyObservers()})),s}dispose(e,t=!1){this._texture.onLoadObservable.remove(this._textureObserver),this._scene.onPointerObservable.remove(this._pointerObserver),super.dispose(e,t)}}function yp(e,t=new n.I9(0,1),i=new n.I9(0,.1),r=new n.I9(0,.1),s=new n.I9(1300,.1)){return function(e,t,i,r,s){return(1-e)*(1-e)*(1-e)*t+3*(1-e)*(1-e)*e*i+3*(1-e)*e*e*r+e*e*e*s}(Math.pow(e/s.x,.333333),t.y,i.y,r.y,s.y)}bp.MODE_MONOSCOPIC=ju.MODE_MONOSCOPIC,bp.MODE_TOPBOTTOM=ju.MODE_TOPBOTTOM,bp.MODE_SIDEBYSIDE=ju.MODE_SIDEBYSIDE;class Pp{get gpuFrameTimeCounter(){return this.engine.getGPUFrameTimeCounter()}get captureGPUFrameTime(){return this._captureGPUFrameTime}set captureGPUFrameTime(e){e!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=e,this.engine.captureGPUFrameTime(e))}get shaderCompilationTimeCounter(){return this._shaderCompilationTime}get captureShaderCompilationTime(){return this._captureShaderCompilationTime}set captureShaderCompilationTime(e){e!==this._captureShaderCompilationTime&&(this._captureShaderCompilationTime=e,e?(this._onBeforeShaderCompilationObserver=this.engine.onBeforeShaderCompilationObservable.add((()=>{this._shaderCompilationTime.fetchNewFrame(),this._shaderCompilationTime.beginMonitoring()})),this._onAfterShaderCompilationObserver=this.engine.onAfterShaderCompilationObservable.add((()=>{this._shaderCompilationTime.endMonitoring()}))):(this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver),this._onBeforeShaderCompilationObserver=null,this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver),this._onAfterShaderCompilationObserver=null))}constructor(e){this.engine=e,this._captureGPUFrameTime=!1,this._captureShaderCompilationTime=!1,this._shaderCompilationTime=new Mo.A,this._onBeginFrameObserver=null,this._onEndFrameObserver=null,this._onBeforeShaderCompilationObserver=null,this._onAfterShaderCompilationObserver=null}dispose(){this.engine.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.engine.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null,this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver),this._onBeforeShaderCompilationObserver=null,this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver),this._onAfterShaderCompilationObserver=null,this.engine=null}}class Tp{get activeMeshesEvaluationTimeCounter(){return this._activeMeshesEvaluationTime}get captureActiveMeshesEvaluationTime(){return this._captureActiveMeshesEvaluationTime}set captureActiveMeshesEvaluationTime(e){e!==this._captureActiveMeshesEvaluationTime&&(this._captureActiveMeshesEvaluationTime=e,e?(this._onBeforeActiveMeshesEvaluationObserver=this.scene.onBeforeActiveMeshesEvaluationObservable.add((()=>{H.S0.StartPerformanceCounter("Active meshes evaluation"),this._activeMeshesEvaluationTime.beginMonitoring()})),this._onAfterActiveMeshesEvaluationObserver=this.scene.onAfterActiveMeshesEvaluationObservable.add((()=>{H.S0.EndPerformanceCounter("Active meshes evaluation"),this._activeMeshesEvaluationTime.endMonitoring(!1)}))):(this.scene.onBeforeActiveMeshesEvaluationObservable.remove(this._onBeforeActiveMeshesEvaluationObserver),this._onBeforeActiveMeshesEvaluationObserver=null,this.scene.onAfterActiveMeshesEvaluationObservable.remove(this._onAfterActiveMeshesEvaluationObserver),this._onAfterActiveMeshesEvaluationObserver=null))}get renderTargetsRenderTimeCounter(){return this._renderTargetsRenderTime}get captureRenderTargetsRenderTime(){return this._captureRenderTargetsRenderTime}set captureRenderTargetsRenderTime(e){e!==this._captureRenderTargetsRenderTime&&(this._captureRenderTargetsRenderTime=e,e?(this._onBeforeRenderTargetsRenderObserver=this.scene.onBeforeRenderTargetsRenderObservable.add((()=>{H.S0.StartPerformanceCounter("Render targets rendering"),this._renderTargetsRenderTime.beginMonitoring()})),this._onAfterRenderTargetsRenderObserver=this.scene.onAfterRenderTargetsRenderObservable.add((()=>{H.S0.EndPerformanceCounter("Render targets rendering"),this._renderTargetsRenderTime.endMonitoring(!1)}))):(this.scene.onBeforeRenderTargetsRenderObservable.remove(this._onBeforeRenderTargetsRenderObserver),this._onBeforeRenderTargetsRenderObserver=null,this.scene.onAfterRenderTargetsRenderObservable.remove(this._onAfterRenderTargetsRenderObserver),this._onAfterRenderTargetsRenderObserver=null))}get particlesRenderTimeCounter(){return this._particlesRenderTime}get captureParticlesRenderTime(){return this._captureParticlesRenderTime}set captureParticlesRenderTime(e){e!==this._captureParticlesRenderTime&&(this._captureParticlesRenderTime=e,e?(this._onBeforeParticlesRenderingObserver=this.scene.onBeforeParticlesRenderingObservable.add((()=>{H.S0.StartPerformanceCounter("Particles"),this._particlesRenderTime.beginMonitoring()})),this._onAfterParticlesRenderingObserver=this.scene.onAfterParticlesRenderingObservable.add((()=>{H.S0.EndPerformanceCounter("Particles"),this._particlesRenderTime.endMonitoring(!1)}))):(this.scene.onBeforeParticlesRenderingObservable.remove(this._onBeforeParticlesRenderingObserver),this._onBeforeParticlesRenderingObserver=null,this.scene.onAfterParticlesRenderingObservable.remove(this._onAfterParticlesRenderingObserver),this._onAfterParticlesRenderingObserver=null))}get spritesRenderTimeCounter(){return this._spritesRenderTime}get captureSpritesRenderTime(){return this._captureSpritesRenderTime}set captureSpritesRenderTime(e){e!==this._captureSpritesRenderTime&&(this._captureSpritesRenderTime=e,this.scene.spriteManagers&&(e?(this._onBeforeSpritesRenderingObserver=this.scene.onBeforeSpritesRenderingObservable.add((()=>{H.S0.StartPerformanceCounter("Sprites"),this._spritesRenderTime.beginMonitoring()})),this._onAfterSpritesRenderingObserver=this.scene.onAfterSpritesRenderingObservable.add((()=>{H.S0.EndPerformanceCounter("Sprites"),this._spritesRenderTime.endMonitoring(!1)}))):(this.scene.onBeforeSpritesRenderingObservable.remove(this._onBeforeSpritesRenderingObserver),this._onBeforeSpritesRenderingObserver=null,this.scene.onAfterSpritesRenderingObservable.remove(this._onAfterSpritesRenderingObserver),this._onAfterSpritesRenderingObserver=null)))}get physicsTimeCounter(){return this._physicsTime}get capturePhysicsTime(){return this._capturePhysicsTime}set capturePhysicsTime(e){e!==this._capturePhysicsTime&&this.scene.onBeforePhysicsObservable&&(this._capturePhysicsTime=e,e?(this._onBeforePhysicsObserver=this.scene.onBeforePhysicsObservable.add((()=>{H.S0.StartPerformanceCounter("Physics"),this._physicsTime.beginMonitoring()})),this._onAfterPhysicsObserver=this.scene.onAfterPhysicsObservable.add((()=>{H.S0.EndPerformanceCounter("Physics"),this._physicsTime.endMonitoring()}))):(this.scene.onBeforePhysicsObservable.remove(this._onBeforePhysicsObserver),this._onBeforePhysicsObserver=null,this.scene.onAfterPhysicsObservable.remove(this._onAfterPhysicsObserver),this._onAfterPhysicsObserver=null))}get animationsTimeCounter(){return this._animationsTime}get captureAnimationsTime(){return this._captureAnimationsTime}set captureAnimationsTime(e){e!==this._captureAnimationsTime&&(this._captureAnimationsTime=e,e?this._onAfterAnimationsObserver=this.scene.onAfterAnimationsObservable.add((()=>{this._animationsTime.endMonitoring()})):(this.scene.onAfterAnimationsObservable.remove(this._onAfterAnimationsObserver),this._onAfterAnimationsObserver=null))}get frameTimeCounter(){return this._frameTime}get captureFrameTime(){return this._captureFrameTime}set captureFrameTime(e){this._captureFrameTime=e}get interFrameTimeCounter(){return this._interFrameTime}get captureInterFrameTime(){return this._captureInterFrameTime}set captureInterFrameTime(e){this._captureInterFrameTime=e}get renderTimeCounter(){return this._renderTime}get captureRenderTime(){return this._captureRenderTime}set captureRenderTime(e){e!==this._captureRenderTime&&(this._captureRenderTime=e,e?(this._onBeforeDrawPhaseObserver=this.scene.onBeforeDrawPhaseObservable.add((()=>{this._renderTime.beginMonitoring(),H.S0.StartPerformanceCounter("Main render")})),this._onAfterDrawPhaseObserver=this.scene.onAfterDrawPhaseObservable.add((()=>{this._renderTime.endMonitoring(!1),H.S0.EndPerformanceCounter("Main render")}))):(this.scene.onBeforeDrawPhaseObservable.remove(this._onBeforeDrawPhaseObserver),this._onBeforeDrawPhaseObserver=null,this.scene.onAfterDrawPhaseObservable.remove(this._onAfterDrawPhaseObserver),this._onAfterDrawPhaseObserver=null))}get cameraRenderTimeCounter(){return this._cameraRenderTime}get captureCameraRenderTime(){return this._captureCameraRenderTime}set captureCameraRenderTime(e){e!==this._captureCameraRenderTime&&(this._captureCameraRenderTime=e,e?(this._onBeforeCameraRenderObserver=this.scene.onBeforeCameraRenderObservable.add((e=>{this._cameraRenderTime.beginMonitoring(),H.S0.StartPerformanceCounter(`Rendering camera ${e.name}`)})),this._onAfterCameraRenderObserver=this.scene.onAfterCameraRenderObservable.add((e=>{this._cameraRenderTime.endMonitoring(!1),H.S0.EndPerformanceCounter(`Rendering camera ${e.name}`)}))):(this.scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=null,this.scene.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=null))}get drawCallsCounter(){return this.scene.getEngine()._drawCalls}constructor(e){this.scene=e,this._captureActiveMeshesEvaluationTime=!1,this._activeMeshesEvaluationTime=new Mo.A,this._captureRenderTargetsRenderTime=!1,this._renderTargetsRenderTime=new Mo.A,this._captureFrameTime=!1,this._frameTime=new Mo.A,this._captureRenderTime=!1,this._renderTime=new Mo.A,this._captureInterFrameTime=!1,this._interFrameTime=new Mo.A,this._captureParticlesRenderTime=!1,this._particlesRenderTime=new Mo.A,this._captureSpritesRenderTime=!1,this._spritesRenderTime=new Mo.A,this._capturePhysicsTime=!1,this._physicsTime=new Mo.A,this._captureAnimationsTime=!1,this._animationsTime=new Mo.A,this._captureCameraRenderTime=!1,this._cameraRenderTime=new Mo.A,this._onBeforeActiveMeshesEvaluationObserver=null,this._onAfterActiveMeshesEvaluationObserver=null,this._onBeforeRenderTargetsRenderObserver=null,this._onAfterRenderTargetsRenderObserver=null,this._onAfterRenderObserver=null,this._onBeforeDrawPhaseObserver=null,this._onAfterDrawPhaseObserver=null,this._onBeforeAnimationsObserver=null,this._onBeforeParticlesRenderingObserver=null,this._onAfterParticlesRenderingObserver=null,this._onBeforeSpritesRenderingObserver=null,this._onAfterSpritesRenderingObserver=null,this._onBeforePhysicsObserver=null,this._onAfterPhysicsObserver=null,this._onAfterAnimationsObserver=null,this._onBeforeCameraRenderObserver=null,this._onAfterCameraRenderObserver=null,this._onBeforeAnimationsObserver=e.onBeforeAnimationsObservable.add((()=>{this._captureActiveMeshesEvaluationTime&&this._activeMeshesEvaluationTime.fetchNewFrame(),this._captureRenderTargetsRenderTime&&this._renderTargetsRenderTime.fetchNewFrame(),this._captureFrameTime&&(H.S0.StartPerformanceCounter("Scene rendering"),this._frameTime.beginMonitoring()),this._captureInterFrameTime&&this._interFrameTime.endMonitoring(),this._captureParticlesRenderTime&&this._particlesRenderTime.fetchNewFrame(),this._captureSpritesRenderTime&&this._spritesRenderTime.fetchNewFrame(),this._captureAnimationsTime&&this._animationsTime.beginMonitoring(),this._captureRenderTime&&this._renderTime.fetchNewFrame(),this._captureCameraRenderTime&&this._cameraRenderTime.fetchNewFrame(),this.scene.getEngine()._drawCalls.fetchNewFrame()})),this._onAfterRenderObserver=e.onAfterRenderObservable.add((()=>{this._captureFrameTime&&(H.S0.EndPerformanceCounter("Scene rendering"),this._frameTime.endMonitoring()),this._captureRenderTime&&this._renderTime.endMonitoring(!1),this._captureInterFrameTime&&this._interFrameTime.beginMonitoring(),this._captureActiveMeshesEvaluationTime&&this._activeMeshesEvaluationTime.endFrame(),this._captureRenderTargetsRenderTime&&this._renderTargetsRenderTime.endFrame(),this._captureParticlesRenderTime&&this._particlesRenderTime.endFrame(),this._captureSpritesRenderTime&&this._spritesRenderTime.endFrame(),this._captureRenderTime&&this._renderTime.endFrame(),this._captureCameraRenderTime&&this._cameraRenderTime.endFrame()}))}dispose(){this.scene.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=null,this.scene.onBeforeActiveMeshesEvaluationObservable.remove(this._onBeforeActiveMeshesEvaluationObserver),this._onBeforeActiveMeshesEvaluationObserver=null,this.scene.onAfterActiveMeshesEvaluationObservable.remove(this._onAfterActiveMeshesEvaluationObserver),this._onAfterActiveMeshesEvaluationObserver=null,this.scene.onBeforeRenderTargetsRenderObservable.remove(this._onBeforeRenderTargetsRenderObserver),this._onBeforeRenderTargetsRenderObserver=null,this.scene.onAfterRenderTargetsRenderObservable.remove(this._onAfterRenderTargetsRenderObserver),this._onAfterRenderTargetsRenderObserver=null,this.scene.onBeforeAnimationsObservable.remove(this._onBeforeAnimationsObserver),this._onBeforeAnimationsObserver=null,this.scene.onBeforeParticlesRenderingObservable.remove(this._onBeforeParticlesRenderingObserver),this._onBeforeParticlesRenderingObserver=null,this.scene.onAfterParticlesRenderingObservable.remove(this._onAfterParticlesRenderingObserver),this._onAfterParticlesRenderingObserver=null,this._onBeforeSpritesRenderingObserver&&(this.scene.onBeforeSpritesRenderingObservable.remove(this._onBeforeSpritesRenderingObserver),this._onBeforeSpritesRenderingObserver=null),this._onAfterSpritesRenderingObserver&&(this.scene.onAfterSpritesRenderingObservable.remove(this._onAfterSpritesRenderingObserver),this._onAfterSpritesRenderingObserver=null),this.scene.onBeforeDrawPhaseObservable.remove(this._onBeforeDrawPhaseObserver),this._onBeforeDrawPhaseObserver=null,this.scene.onAfterDrawPhaseObservable.remove(this._onAfterDrawPhaseObserver),this._onAfterDrawPhaseObserver=null,this._onBeforePhysicsObserver&&(this.scene.onBeforePhysicsObservable.remove(this._onBeforePhysicsObserver),this._onBeforePhysicsObserver=null),this._onAfterPhysicsObserver&&(this.scene.onAfterPhysicsObservable.remove(this._onAfterPhysicsObserver),this._onAfterPhysicsObserver=null),this.scene.onAfterAnimationsObservable.remove(this._onAfterAnimationsObserver),this._onAfterAnimationsObserver=null,this.scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=null,this.scene.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=null,this.scene=null}}class Cp{get _shouldRender(){return this._thinEffectLayer._shouldRender}set _shouldRender(e){this._thinEffectLayer._shouldRender=e}get _emissiveTextureAndColor(){return this._thinEffectLayer._emissiveTextureAndColor}set _emissiveTextureAndColor(e){this._thinEffectLayer._emissiveTextureAndColor=e}get _effectIntensity(){return this._thinEffectLayer._effectIntensity}set _effectIntensity(e){this._thinEffectLayer._effectIntensity=e}static get ForceGLSL(){return rc.ForceGLSL}static set ForceGLSL(e){rc.ForceGLSL=e}get name(){return this._thinEffectLayer.name}set name(e){this._thinEffectLayer.name=e}get neutralColor(){return this._thinEffectLayer.neutralColor}set neutralColor(e){this._thinEffectLayer.neutralColor=e}get isEnabled(){return this._thinEffectLayer.isEnabled}set isEnabled(e){this._thinEffectLayer.isEnabled=e}get camera(){return this._thinEffectLayer.camera}get renderingGroupId(){return this._thinEffectLayer.renderingGroupId}set renderingGroupId(e){this._thinEffectLayer.renderingGroupId=e}get disableBoundingBoxesFromEffectLayer(){return this._thinEffectLayer.disableBoundingBoxesFromEffectLayer}set disableBoundingBoxesFromEffectLayer(e){this._thinEffectLayer.disableBoundingBoxesFromEffectLayer=e}get mainTexture(){return this._mainTexture}get _shaderLanguage(){return this._thinEffectLayer.shaderLanguage}get shaderLanguage(){return this._thinEffectLayer.shaderLanguage}setMaterialForRendering(e,t){this._thinEffectLayer.setMaterialForRendering(e,t)}getEffectIntensity(e){return this._thinEffectLayer.getEffectIntensity(e)}setEffectIntensity(e,t){this._thinEffectLayer.setEffectIntensity(e,t)}constructor(e,t,i=!1,r){this._maxSize=0,this._mainTextureDesiredSize={width:0,height:0},this._postProcesses=[],this._textures=[],this.onDisposeObservable=new s.cP,this.onBeforeRenderMainTextureObservable=new s.cP,this.onBeforeComposeObservable=new s.cP,this.onBeforeRenderMeshToEffect=new s.cP,this.onAfterRenderMeshToEffect=new s.cP,this.onAfterComposeObservable=new s.cP,this.onSizeChangedObservable=new s.cP,this._internalThinEffectLayer=!r,r||((r=new rc(e,t,i,!1,this._importShadersAsync.bind(this))).getEffectName=this.getEffectName.bind(this),r.isReady=this.isReady.bind(this),r._createMergeEffect=this._createMergeEffect.bind(this),r._createTextureAndPostProcesses=this._createTextureAndPostProcesses.bind(this),r._internalCompose=this._internalRender.bind(this),r._setEmissiveTextureAndColor=this._setEmissiveTextureAndColor.bind(this),r._numInternalDraws=this._numInternalDraws.bind(this),r._addCustomEffectDefines=this._addCustomEffectDefines.bind(this),r.hasMesh=this.hasMesh.bind(this),r.shouldRender=this.shouldRender.bind(this),r._shouldRenderMesh=this._shouldRenderMesh.bind(this),r._canRenderMesh=this._canRenderMesh.bind(this),r._useMeshMaterial=this._useMeshMaterial.bind(this)),this._thinEffectLayer=r,this.name=e,this._scene=t||C.q.LastCreatedScene,Cp._SceneComponentInitialization(this._scene),this._engine=this._scene.getEngine(),this._maxSize=this._engine.getCaps().maxTextureSize,this._scene.effectLayers.push(this),this._thinEffectLayer.onDisposeObservable.add((()=>{this.onDisposeObservable.notifyObservers(this)})),this._thinEffectLayer.onBeforeRenderLayerObservable.add((()=>{this.onBeforeRenderMainTextureObservable.notifyObservers(this)})),this._thinEffectLayer.onBeforeComposeObservable.add((()=>{this.onBeforeComposeObservable.notifyObservers(this)})),this._thinEffectLayer.onBeforeRenderMeshToEffect.add((e=>{this.onBeforeRenderMeshToEffect.notifyObservers(e)})),this._thinEffectLayer.onAfterRenderMeshToEffect.add((e=>{this.onAfterRenderMeshToEffect.notifyObservers(e)})),this._thinEffectLayer.onAfterComposeObservable.add((()=>{this.onAfterComposeObservable.notifyObservers(this)}))}get _shadersLoaded(){return this._thinEffectLayer._shadersLoaded}set _shadersLoaded(e){this._thinEffectLayer._shadersLoaded=e}_numInternalDraws(){return this._internalThinEffectLayer?1:this._thinEffectLayer._numInternalDraws()}_init(e){this._effectLayerOptions={mainTextureRatio:.5,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,generateStencilBuffer:!1,...e},this._setMainTextureSize(),this._thinEffectLayer._init(e),this._createMainTexture(),this._createTextureAndPostProcesses()}_setMainTextureSize(){this._effectLayerOptions.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._effectLayerOptions.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._effectLayerOptions.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.height=this._engine.getRenderHeight()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.width=this._engine.needPOTTextures?(0,yr.R)(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width,this._mainTextureDesiredSize.height=this._engine.needPOTTextures?(0,yr.R)(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height),this._mainTextureDesiredSize.width=Math.floor(this._mainTextureDesiredSize.width),this._mainTextureDesiredSize.height=Math.floor(this._mainTextureDesiredSize.height)}_createMainTexture(){this._mainTexture=new cr.$("EffectLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,{type:this._effectLayerOptions.mainTextureType,samplingMode:$e.g.TRILINEAR_SAMPLINGMODE,generateStencilBuffer:this._effectLayerOptions.generateStencilBuffer,existingObjectRenderer:this._thinEffectLayer.objectRenderer}),this._mainTexture.activeCamera=this._effectLayerOptions.camera,this._mainTexture.wrapU=$e.g.CLAMP_ADDRESSMODE,this._mainTexture.wrapV=$e.g.CLAMP_ADDRESSMODE,this._mainTexture.anisotropicFilteringLevel=1,this._mainTexture.updateSamplingMode($e.g.BILINEAR_SAMPLINGMODE),this._mainTexture.renderParticles=!1,this._mainTexture.renderList=null,this._mainTexture.ignoreCameraViewport=!0,this._mainTexture.onClearObservable.add((e=>{e.clear(this.neutralColor,!0,!0,!0)}))}_addCustomEffectDefines(e){}_isReady(e,t,i){return this._internalThinEffectLayer?this._thinEffectLayer._internalIsSubMeshReady(e,t,i):this._thinEffectLayer._isSubMeshReady(e,t,i)}async _importShadersAsync(){}_arePostProcessAndMergeReady(){return this._internalThinEffectLayer?this._thinEffectLayer._internalIsLayerReady():this._thinEffectLayer.isLayerReady()}isLayerReady(){return this._arePostProcessAndMergeReady()&&this._mainTexture.isReady()}render(){if(!this._thinEffectLayer.compose())return;const e=this._mainTexture.getSize();this._setMainTextureSize(),e.width===this._mainTextureDesiredSize.width&&e.height===this._mainTextureDesiredSize.height||0===this._mainTextureDesiredSize.width||0===this._mainTextureDesiredSize.height||(this.onSizeChangedObservable.notifyObservers(this),this._disposeTextureAndPostProcesses(),this._createMainTexture(),this._createTextureAndPostProcesses())}hasMesh(e){return this._internalThinEffectLayer?this._thinEffectLayer._internalHasMesh(e):this._thinEffectLayer.hasMesh(e)}shouldRender(){return this._internalThinEffectLayer?this._thinEffectLayer._internalShouldRender():this._thinEffectLayer.shouldRender()}_shouldRenderMesh(e){return!!this._internalThinEffectLayer||this._thinEffectLayer._shouldRenderMesh(e)}_canRenderMesh(e,t){return this._internalThinEffectLayer?this._thinEffectLayer._internalCanRenderMesh(e,t):this._thinEffectLayer._canRenderMesh(e,t)}_shouldRenderEmissiveTextureForMesh(){return!0}_useMeshMaterial(e){return!this._internalThinEffectLayer&&this._thinEffectLayer._useMeshMaterial(e)}_rebuild(){this._thinEffectLayer._rebuild()}_disposeTextureAndPostProcesses(){this._mainTexture.dispose();for(let e=0;e<this._postProcesses.length;e++)this._postProcesses[e]&&this._postProcesses[e].dispose();this._postProcesses=[];for(let e=0;e<this._textures.length;e++)this._textures[e]&&this._textures[e].dispose();this._textures=[]}dispose(){this._thinEffectLayer.dispose(),this._disposeTextureAndPostProcesses();const e=this._scene.effectLayers.indexOf(this,0);e>-1&&this._scene.effectLayers.splice(e,1),this.onDisposeObservable.clear(),this.onBeforeRenderMainTextureObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear(),this.onSizeChangedObservable.clear()}getClassName(){return"EffectLayer"}static Parse(e,t,i){return H.S0.Instantiate(e.customType).Parse(e,t,i)}}Cp._SceneComponentInitialization=e=>{throw(0,Ph.n)("EffectLayerSceneComponent")},(0,Ge.Cg)([(0,ze.lK)()],Cp.prototype,"name",null),(0,Ge.Cg)([(0,ze.qK)()],Cp.prototype,"neutralColor",null),(0,Ge.Cg)([(0,ze.lK)()],Cp.prototype,"isEnabled",null),(0,Ge.Cg)([(0,ze.fW)()],Cp.prototype,"camera",null),(0,Ge.Cg)([(0,ze.lK)()],Cp.prototype,"renderingGroupId",null),(0,Ge.Cg)([(0,ze.lK)()],Cp.prototype,"disableBoundingBoxesFromEffectLayer",null);var Ep=i(93084);(0,Ep.ji)(Ei.v.NAME_EFFECTLAYER,((e,t,i,r)=>{if(e.effectLayers){i.effectLayers||(i.effectLayers=[]);for(let s=0;s<e.effectLayers.length;s++){const n=Cp.Parse(e.effectLayers[s],t,r);i.effectLayers.push(n)}}})),it.Z.prototype.removeEffectLayer=function(e){const t=this.effectLayers.indexOf(e);return-1!==t&&this.effectLayers.splice(t,1),t},it.Z.prototype.addEffectLayer=function(e){this.effectLayers.push(e)};class Ap{constructor(e){this.name=Ei.v.NAME_EFFECTLAYER,this._renderEffects=!1,this._needStencil=!1,this._previousStencilState=!1,this.scene=e||C.q.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine())}register(){this.scene._isReadyForMeshStage.registerStep(Ei.v.STEP_ISREADYFORMESH_EFFECTLAYER,this,this._isReadyForMesh),this.scene._cameraDrawRenderTargetStage.registerStep(Ei.v.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this._renderMainTexture),this.scene._beforeCameraDrawStage.registerStep(Ei.v.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this._setStencil),this.scene._afterRenderingGroupDrawStage.registerStep(Ei.v.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,this,this._drawRenderingGroup),this.scene._afterCameraDrawStage.registerStep(Ei.v.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this._setStencilBack),this.scene._afterCameraDrawStage.registerStep(Ei.v.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this._drawCamera)}rebuild(){const e=this.scene.effectLayers;for(const t of e)t._rebuild()}serialize(e){e.effectLayers=[];const t=this.scene.effectLayers;for(const i of t)i.serialize&&e.effectLayers.push(i.serialize())}addFromContainer(e){e.effectLayers&&e.effectLayers.forEach((e=>{this.scene.addEffectLayer(e)}))}removeFromContainer(e,t){e.effectLayers&&e.effectLayers.forEach((e=>{this.scene.removeEffectLayer(e),t&&e.dispose()}))}dispose(){const e=this.scene.effectLayers;for(;e.length;)e[0].dispose()}_isReadyForMesh(e,t){const i=this._engine.currentRenderPassId,r=this.scene.effectLayers;for(const s of r){if(!s.hasMesh(e))continue;const r=s._mainTexture;this._engine.currentRenderPassId=r.renderPassId;for(const r of e.subMeshes)if(!s.isReady(r,t))return this._engine.currentRenderPassId=i,!1}return this._engine.currentRenderPassId=i,!0}_renderMainTexture(e){this._renderEffects=!1,this._needStencil=!1;let t=!1;const i=this.scene.effectLayers;if(i&&i.length>0){this._previousStencilState=this._engine.getStencilBuffer();for(const r of i)if(r.shouldRender()&&(!r.camera||r.camera.cameraRigMode===ft.i.RIG_MODE_NONE&&e===r.camera||r.camera.cameraRigMode!==ft.i.RIG_MODE_NONE&&r.camera._rigCameras.indexOf(e)>-1)){this._renderEffects=!0,this._needStencil=this._needStencil||r.needStencil();const e=r._mainTexture;e._shouldRender()&&(this.scene.incrementRenderId(),e.render(!1,!1),t=!0)}this.scene.incrementRenderId()}return t}_setStencil(){this._needStencil&&this._engine.setStencilBuffer(!0)}_setStencilBack(){this._needStencil&&this._engine.setStencilBuffer(this._previousStencilState)}_draw(e){if(this._renderEffects){this._engine.setDepthBuffer(!1);const t=this.scene.effectLayers;for(let i=0;i<t.length;i++){const r=t[i];r.renderingGroupId===e&&r.shouldRender()&&r.render()}this._engine.setDepthBuffer(!0)}}_drawCamera(){this._renderEffects&&this._draw(-1)}_drawRenderingGroup(e){!this.scene._isInIntermediateRendering()&&this._renderEffects&&this._draw(e)}}Cp._SceneComponentInitialization=e=>{let t=e._getComponent(Ei.v.NAME_EFFECTLAYER);t||(t=new Ap(e),e._addComponent(t))},it.Z.prototype.getGlowLayerByName=function(e){for(let t=0;t<this.effectLayers?.length;t++)if(this.effectLayers[t].name===e&&this.effectLayers[t].getEffectName()===Ip.EffectName)return this.effectLayers[t];return null};class Ip extends Cp{static get EffectName(){return sc.EffectName}set blurKernelSize(e){this._thinEffectLayer.blurKernelSize=e}get blurKernelSize(){return this._thinEffectLayer.blurKernelSize}set intensity(e){this._thinEffectLayer.intensity=e}get intensity(){return this._thinEffectLayer.intensity}get customEmissiveColorSelector(){return this._thinEffectLayer.customEmissiveColorSelector}set customEmissiveColorSelector(e){this._thinEffectLayer.customEmissiveColorSelector=e}get customEmissiveTextureSelector(){return this._thinEffectLayer.customEmissiveTextureSelector}set customEmissiveTextureSelector(e){this._thinEffectLayer.customEmissiveTextureSelector=e}constructor(e,t,i){super(e,t,!1,new sc(e,t,i)),this._options={mainTextureRatio:Ip.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:void 0,camera:null,mainTextureSamples:1,renderingGroupId:-1,ldrMerge:!1,alphaBlendingMode:1,mainTextureType:0,generateStencilBuffer:!1,...i},this._init(this._options)}getEffectName(){return Ip.EffectName}_createMergeEffect(){return this._thinEffectLayer._createMergeEffect()}_createTextureAndPostProcesses(){this._thinEffectLayer._renderPassId=this._mainTexture.renderPassId;let e=this._mainTextureDesiredSize.width,t=this._mainTextureDesiredSize.height;e=this._engine.needPOTTextures?(0,yr.R)(e,this._maxSize):e,t=this._engine.needPOTTextures?(0,yr.R)(t,this._maxSize):t;let i=0;i=this._engine.getCaps().textureHalfFloatRender?2:0,this._blurTexture1=new cr.$("GlowLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture1.wrapU=$e.g.CLAMP_ADDRESSMODE,this._blurTexture1.wrapV=$e.g.CLAMP_ADDRESSMODE,this._blurTexture1.updateSamplingMode($e.g.BILINEAR_SAMPLINGMODE),this._blurTexture1.renderParticles=!1,this._blurTexture1.ignoreCameraViewport=!0;const r=Math.floor(e/2),s=Math.floor(t/2);this._blurTexture2=new cr.$("GlowLayerBlurRTT2",{width:r,height:s},this._scene,!1,!0,i),this._blurTexture2.wrapU=$e.g.CLAMP_ADDRESSMODE,this._blurTexture2.wrapV=$e.g.CLAMP_ADDRESSMODE,this._blurTexture2.updateSamplingMode($e.g.BILINEAR_SAMPLINGMODE),this._blurTexture2.renderParticles=!1,this._blurTexture2.ignoreCameraViewport=!0,this._textures=[this._blurTexture1,this._blurTexture2],this._thinEffectLayer.bindTexturesForCompose=e=>{e.setTexture("textureSampler",this._blurTexture1),e.setTexture("textureSampler2",this._blurTexture2),e.setFloat("offset",this.intensity)},this._thinEffectLayer._createTextureAndPostProcesses();const n=this._thinEffectLayer._postProcesses[0];this._horizontalBlurPostprocess1=new Ch("GlowLayerHBP1",n.direction,n.kernel,{samplingMode:$e.g.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),width:e,height:t,textureType:i,effectWrapper:n}),this._horizontalBlurPostprocess1.width=e,this._horizontalBlurPostprocess1.height=t,this._horizontalBlurPostprocess1.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess1.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._mainTexture)}));const o=this._thinEffectLayer._postProcesses[1];this._verticalBlurPostprocess1=new Ch("GlowLayerVBP1",o.direction,o.kernel,{samplingMode:$e.g.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),width:e,height:t,textureType:i,effectWrapper:o});const a=this._thinEffectLayer._postProcesses[2];this._horizontalBlurPostprocess2=new Ch("GlowLayerHBP2",a.direction,a.kernel,{samplingMode:$e.g.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),width:r,height:s,textureType:i,effectWrapper:a}),this._horizontalBlurPostprocess2.width=r,this._horizontalBlurPostprocess2.height=s,this._horizontalBlurPostprocess2.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess2.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._blurTexture1)}));const l=this._thinEffectLayer._postProcesses[3];this._verticalBlurPostprocess2=new Ch("GlowLayerVBP2",l.direction,l.kernel,{samplingMode:$e.g.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),width:r,height:s,textureType:i,effectWrapper:l}),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._postProcesses1=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1],this._postProcesses2=[this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._mainTexture.samples=this._options.mainTextureSamples,this._mainTexture.onAfterUnbindObservable.add((()=>{const e=this._blurTexture1.renderTarget;if(e){this._scene.postProcessManager.directRender(this._postProcesses1,e,!0);const t=this._blurTexture2.renderTarget;t&&this._scene.postProcessManager.directRender(this._postProcesses2,t,!0),this._engine.unBindFramebuffer(t??e,!0)}})),this._postProcesses.map((e=>{e.autoClear=!1}))}isReady(e,t){return this._thinEffectLayer.isReady(e,t)}needStencil(){return!1}_canRenderMesh(e,t){return this._thinEffectLayer._canRenderMesh(e,t)}_internalRender(e){this._thinEffectLayer._internalCompose(e)}_setEmissiveTextureAndColor(e,t,i){this._thinEffectLayer._setEmissiveTextureAndColor(e,t,i)}_shouldRenderMesh(e){return this._thinEffectLayer._shouldRenderMesh(e)}_addCustomEffectDefines(e){this._thinEffectLayer._addCustomEffectDefines(e)}addExcludedMesh(e){this._thinEffectLayer.addExcludedMesh(e)}removeExcludedMesh(e){this._thinEffectLayer.removeExcludedMesh(e)}addIncludedOnlyMesh(e){this._thinEffectLayer.addIncludedOnlyMesh(e)}removeIncludedOnlyMesh(e){this._thinEffectLayer.removeIncludedOnlyMesh(e)}hasMesh(e){return this._thinEffectLayer.hasMesh(e)}_useMeshMaterial(e){return this._thinEffectLayer._useMeshMaterial(e)}referenceMeshToUseItsOwnMaterial(e){this._thinEffectLayer.referenceMeshToUseItsOwnMaterial(e)}unReferenceMeshFromUsingItsOwnMaterial(e){this._thinEffectLayer.unReferenceMeshFromUsingItsOwnMaterial(e,this._mainTexture.renderPassId)}_disposeMesh(e){this._thinEffectLayer._disposeMesh(e)}getClassName(){return"GlowLayer"}serialize(){const e=Ue.p.Serialize(this);let t;e.customType="BABYLON.GlowLayer",e.includedMeshes=[];const i=this._thinEffectLayer._includedOnlyMeshes;if(i.length)for(t=0;t<i.length;t++){const r=this._scene.getMeshByUniqueId(i[t]);r&&e.includedMeshes.push(r.id)}e.excludedMeshes=[];const r=this._thinEffectLayer._excludedMeshes;if(r.length)for(t=0;t<r.length;t++){const i=this._scene.getMeshByUniqueId(r[t]);i&&e.excludedMeshes.push(i.id)}return e}static Parse(e,t,i){const r=Ue.p.Parse((()=>new Ip(e.name,t,e.options)),e,t,i);let s;for(s=0;s<e.excludedMeshes.length;s++){const i=t.getMeshById(e.excludedMeshes[s]);i&&r.addExcludedMesh(i)}for(s=0;s<e.includedMeshes.length;s++){const i=t.getMeshById(e.includedMeshes[s]);i&&r.addIncludedOnlyMesh(i)}return r}}Ip.DefaultBlurKernelSize=32,Ip.DefaultTextureRatio=.5,(0,Ge.Cg)([(0,ze.lK)()],Ip.prototype,"blurKernelSize",null),(0,Ge.Cg)([(0,ze.lK)()],Ip.prototype,"intensity",null),(0,Ge.Cg)([(0,ze.lK)("options")],Ip.prototype,"_options",void 0),(0,a.Y5)("BABYLON.GlowLayer",Ip),it.Z.prototype.getHighlightLayerByName=function(e){for(let t=0;t<this.effectLayers?.length;t++)if(this.effectLayers[t].name===e&&this.effectLayers[t].getEffectName()===Mp.EffectName)return this.effectLayers[t];return null};class Rp extends Fi.w{constructor(e,t,i,r,s=null,n=$e.g.BILINEAR_SAMPLINGMODE,o,a){const l={uniforms:ic.Uniforms,size:"number"==typeof r?r:void 0,camera:s,samplingMode:n,engine:o,reusable:a,...r};super(e,ic.FragmentUrl,{effectWrapper:"number"!=typeof r&&r.effectWrapper?void 0:new ic(e,o,t,i,l),...l}),this.direction=t,this.kernel=i,this.onApplyObservable.add((()=>{this._effectWrapper.textureWidth=this.width,this._effectWrapper.textureHeight=this.height}))}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,82937)))):t.push(Promise.resolve().then(i.bind(i,57094))),super._gatherImports(e,t)}}class Mp extends Cp{static get NeutralColor(){return pc.NeutralColor}static set NeutralColor(e){pc.NeutralColor=e}get innerGlow(){return this._thinEffectLayer.innerGlow}set innerGlow(e){this._thinEffectLayer.innerGlow=e}get outerGlow(){return this._thinEffectLayer.outerGlow}set outerGlow(e){this._thinEffectLayer.outerGlow=e}set blurHorizontalSize(e){this._thinEffectLayer.blurHorizontalSize=e}set blurVerticalSize(e){this._thinEffectLayer.blurVerticalSize=e}get blurHorizontalSize(){return this._thinEffectLayer.blurHorizontalSize}get blurVerticalSize(){return this._thinEffectLayer.blurVerticalSize}constructor(e,t,i){super(e,t,void 0!==i&&!!i.forceGLSL,new pc(e,t,i)),this.onBeforeBlurObservable=new s.cP,this.onAfterBlurObservable=new s.cP,this._engine.isStencilEnable||m.V.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new Engine(canvas, antialias, { stencil: true }"),this._options={mainTextureRatio:.5,blurTextureSizeRatio:.5,mainTextureFixedSize:0,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,forceGLSL:!1,isStroke:!1,...i},this._init(this._options),this._shouldRender=!1}getEffectName(){return Mp.EffectName}_numInternalDraws(){return 2}_createMergeEffect(){return this._thinEffectLayer._createMergeEffect()}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,t=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;e=this._engine.needPOTTextures?(0,yr.R)(e,this._maxSize):e,t=this._engine.needPOTTextures?(0,yr.R)(t,this._maxSize):t;let i=0;i=this._engine.getCaps().textureHalfFloatRender?2:0,this._blurTexture=new cr.$("HighlightLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture.wrapU=$e.g.CLAMP_ADDRESSMODE,this._blurTexture.wrapV=$e.g.CLAMP_ADDRESSMODE,this._blurTexture.anisotropicFilteringLevel=16,this._blurTexture.updateSamplingMode($e.g.TRILINEAR_SAMPLINGMODE),this._blurTexture.renderParticles=!1,this._blurTexture.ignoreCameraViewport=!0,this._textures=[this._blurTexture],this._thinEffectLayer.bindTexturesForCompose=e=>{e.setTexture("textureSampler",this._blurTexture)},this._thinEffectLayer._createTextureAndPostProcesses(),2===this._options.alphaBlendingMode?(this._downSamplePostprocess=new wi.v("HighlightLayerPPP",{size:this._options.blurTextureSizeRatio,samplingMode:$e.g.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),effectWrapper:this._thinEffectLayer._postProcesses[0]}),this._downSamplePostprocess.externalTextureSamplerBinding=!0,this._downSamplePostprocess.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._mainTexture)})),this._horizontalBlurPostprocess=new Rp("HighlightLayerHBP",new n.I9(1,0),this._options.blurHorizontalSize,{samplingMode:$e.g.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),effectWrapper:this._thinEffectLayer._postProcesses[1]}),this._horizontalBlurPostprocess.onApplyObservable.add((i=>{i.setFloat2("screenSize",e,t)})),this._verticalBlurPostprocess=new Rp("HighlightLayerVBP",new n.I9(0,1),this._options.blurVerticalSize,{samplingMode:$e.g.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),effectWrapper:this._thinEffectLayer._postProcesses[2]}),this._verticalBlurPostprocess.onApplyObservable.add((i=>{i.setFloat2("screenSize",e,t)})),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess]):(this._horizontalBlurPostprocess=new Ch("HighlightLayerHBP",new n.I9(1,0),this._options.blurHorizontalSize/2,{size:{width:e,height:t},samplingMode:$e.g.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),textureType:i,effectWrapper:this._thinEffectLayer._postProcesses[0]}),this._horizontalBlurPostprocess.width=e,this._horizontalBlurPostprocess.height=t,this._horizontalBlurPostprocess.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._mainTexture)})),this._verticalBlurPostprocess=new Ch("HighlightLayerVBP",new n.I9(0,1),this._options.blurVerticalSize/2,{size:{width:e,height:t},samplingMode:$e.g.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),textureType:i}),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess]),this._mainTexture.onAfterUnbindObservable.add((()=>{this.onBeforeBlurObservable.notifyObservers(this);const e=this._blurTexture.renderTarget;e&&(this._scene.postProcessManager.directRender(this._postProcesses,e,!0),this._engine.unBindFramebuffer(e,!0)),this.onAfterBlurObservable.notifyObservers(this)})),this._postProcesses.map((e=>{e.autoClear=!1}))}needStencil(){return this._thinEffectLayer.needStencil()}isReady(e,t){return this._thinEffectLayer.isReady(e,t)}_internalRender(e,t){this._thinEffectLayer._internalCompose(e,t)}shouldRender(){return this._thinEffectLayer.shouldRender()}_shouldRenderMesh(e){return this._thinEffectLayer._shouldRenderMesh(e)}_canRenderMesh(e,t){return this._thinEffectLayer._canRenderMesh(e,t)}_addCustomEffectDefines(e){this._thinEffectLayer._addCustomEffectDefines(e)}_setEmissiveTextureAndColor(e,t,i){this._thinEffectLayer._setEmissiveTextureAndColor(e,t,i)}addExcludedMesh(e){this._thinEffectLayer.addExcludedMesh(e)}removeExcludedMesh(e){this._thinEffectLayer.removeExcludedMesh(e)}hasMesh(e){return this._thinEffectLayer.hasMesh(e)}addMesh(e,t,i=!1){this._thinEffectLayer.addMesh(e,t,i)}removeMesh(e){this._thinEffectLayer.removeMesh(e)}removeAllMeshes(){this._thinEffectLayer.removeAllMeshes()}_disposeMesh(e){this._thinEffectLayer._disposeMesh(e)}getClassName(){return"HighlightLayer"}serialize(){const e=Ue.p.Serialize(this);e.customType="BABYLON.HighlightLayer",e.meshes=[];const t=this._thinEffectLayer._meshes;if(t)for(const i in t){const r=t[i];r&&e.meshes.push({glowEmissiveOnly:r.glowEmissiveOnly,color:r.color.asArray(),meshId:r.mesh.id})}e.excludedMeshes=[];const i=this._thinEffectLayer._excludedMeshes;if(i)for(const t in i){const r=i[t];r&&e.excludedMeshes.push(r.mesh.id)}return e}static Parse(e,t,i){const r=Ue.p.Parse((()=>new Mp(e.name,t,e.options)),e,t,i);let s;for(s=0;s<e.excludedMeshes.length;s++){const i=t.getMeshById(e.excludedMeshes[s]);i&&r.addExcludedMesh(i)}for(s=0;s<e.meshes.length;s++){const i=e.meshes[s],n=t.getMeshById(i.meshId);n&&r.addMesh(n,o.v9.FromArray(i.color),i.glowEmissiveOnly)}return r}}Mp.EffectName="HighlightLayer",(0,Ge.Cg)([(0,ze.lK)()],Mp.prototype,"innerGlow",null),(0,Ge.Cg)([(0,ze.lK)()],Mp.prototype,"outerGlow",null),(0,Ge.Cg)([(0,ze.lK)()],Mp.prototype,"blurHorizontalSize",null),(0,Ge.Cg)([(0,ze.lK)()],Mp.prototype,"blurVerticalSize",null),(0,Ge.Cg)([(0,ze.lK)("options")],Mp.prototype,"_options",void 0),(0,a.Y5)("BABYLON.HighlightLayer",Mp);class Dp{constructor(e){this.name=Ei.v.NAME_LAYER,this.scene=e||C.q.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine())}register(){this.scene._beforeCameraDrawStage.registerStep(Ei.v.STEP_BEFORECAMERADRAW_LAYER,this,this._drawCameraBackground),this.scene._afterCameraDrawStage.registerStep(Ei.v.STEP_AFTERCAMERADRAW_LAYER,this,this._drawCameraForegroundWithPostProcessing),this.scene._afterCameraPostProcessStage.registerStep(Ei.v.STEP_AFTERCAMERAPOSTPROCESS_LAYER,this,this._drawCameraForegroundWithoutPostProcessing),this.scene._beforeRenderTargetDrawStage.registerStep(Ei.v.STEP_BEFORERENDERTARGETDRAW_LAYER,this,this._drawRenderTargetBackground),this.scene._afterRenderTargetDrawStage.registerStep(Ei.v.STEP_AFTERRENDERTARGETDRAW_LAYER,this,this._drawRenderTargetForegroundWithPostProcessing),this.scene._afterRenderTargetPostProcessStage.registerStep(Ei.v.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER,this,this._drawRenderTargetForegroundWithoutPostProcessing)}rebuild(){const e=this.scene.layers;for(const t of e)t._rebuild()}dispose(){const e=this.scene.layers;for(;e.length;)e[0].dispose()}_draw(e){const t=this.scene.layers;if(t.length){this._engine.setDepthBuffer(!1);for(const i of t)e(i)&&i.render();this._engine.setDepthBuffer(!0)}}_drawCameraPredicate(e,t,i,r){return!e.renderOnlyInRenderTargetTextures&&e.isBackground===t&&e.applyPostProcess===i&&!!(e.layerMask&r)}_drawCameraBackground(e){this._draw((t=>this._drawCameraPredicate(t,!0,!0,e.layerMask)))}_drawCameraForegroundWithPostProcessing(e){this._draw((t=>this._drawCameraPredicate(t,!1,!0,e.layerMask)))}_drawCameraForegroundWithoutPostProcessing(e){this._draw((t=>this._drawCameraPredicate(t,!1,!1,e.layerMask)))}_drawRenderTargetPredicate(e,t,i,r,s){return e.renderTargetTextures.length>0&&e.isBackground===t&&e.applyPostProcess===i&&e.renderTargetTextures.indexOf(s)>-1&&!!(e.layerMask&r)}_drawRenderTargetBackground(e){this._draw((t=>this._drawRenderTargetPredicate(t,!0,!0,this.scene.activeCamera.layerMask,e)))}_drawRenderTargetForegroundWithPostProcessing(e){this._draw((t=>this._drawRenderTargetPredicate(t,!1,!0,this.scene.activeCamera.layerMask,e)))}_drawRenderTargetForegroundWithoutPostProcessing(e){this._draw((t=>this._drawRenderTargetPredicate(t,!1,!1,this.scene.activeCamera.layerMask,e)))}addFromContainer(e){e.layers&&e.layers.forEach((e=>{this.scene.layers.push(e)}))}removeFromContainer(e,t=!1){e.layers&&e.layers.forEach((e=>{const i=this.scene.layers.indexOf(e);-1!==i&&this.scene.layers.splice(i,1),t&&e.dispose()}))}}class Op{set applyPostProcess(e){this._applyPostProcess=e}get applyPostProcess(){return this.isBackground||this._applyPostProcess}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,r,a,l=!1){this.name=e,this._applyPostProcess=!0,this.scale=new n.I9(1,1),this.offset=new n.I9(0,0),this.alphaBlendingMode=2,this.layerMask=268435455,this.renderTargetTextures=[],this.renderOnlyInRenderTargetTextures=!1,this.convertToLinearSpace=!1,this.isEnabled=!0,this._vertexBuffers={},this.onDisposeObservable=new s.cP,this.onBeforeRenderObservable=new s.cP,this.onAfterRenderObservable=new s.cP,this._shaderLanguage=0,this._shadersLoaded=!1,this.texture=t?new $e.g(t,i,!0):null,this.isBackground=void 0===r||r,this.color=void 0===a?new o.ov(1,1,1,1):a,this._scene=i||C.q.LastCreatedScene;const h=this._scene.getEngine();!h.isWebGPU||l||Op.ForceGLSL||(this._shaderLanguage=1);let c=this._scene._getComponent(Ei.v.NAME_LAYER);c||(c=new Dp(this._scene),this._scene._addComponent(c)),this._scene.layers.push(this),this._drawWrapper=new Ah.E(h);const u=[];u.push(1,1),u.push(-1,1),u.push(-1,-1),u.push(1,-1);const d=new Ot.R(h,u,Ot.R.PositionKind,!1,!1,2);this._vertexBuffers[Ot.R.PositionKind]=d,this._createIndexBuffer()}_createIndexBuffer(){const e=this._scene.getEngine(),t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){const e=this._vertexBuffers[Ot.R.PositionKind];e&&e._rebuild(),this._createIndexBuffer()}isReady(){const e=this._scene.getEngine();let t="";this.alphaTest&&(t="#define ALPHATEST"),this.texture&&(this.texture.gammaSpace?this.convertToLinearSpace&&(t+="\n#define CONVERT_TO_LINEAR"):this.convertToLinearSpace||(t+="\n#define CONVERT_TO_GAMMA")),this._previousDefines!==t&&(this._previousDefines=t,this._drawWrapper.effect=e.createEffect("layer",[Ot.R.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],t,void 0,void 0,void 0,void 0,this._shaderLanguage,this._shadersLoaded?void 0:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,16913)),Promise.resolve().then(i.bind(i,70711))]):await Promise.all([Promise.resolve().then(i.bind(i,22614)),Promise.resolve().then(i.bind(i,35256))]),this._shadersLoaded=!0}));const r=this._drawWrapper.effect;return!!r?.isReady()&&(!this.texture||this.texture.isReady())}render(){if(!this.isEnabled)return;const e=this._scene.getEngine();if(!this.isReady())return;const t=this._drawWrapper.effect;this.onBeforeRenderObservable.notifyObservers(this),e.enableEffect(this._drawWrapper),e.setState(!1),this.texture&&(t.setTexture("textureSampler",this.texture),t.setMatrix("textureMatrix",this.texture.getTextureMatrix())),t.setFloat4("color",this.color.r,this.color.g,this.color.b,this.color.a),t.setVector2("offset",this.offset),t.setVector2("scale",this.scale),e.bindBuffers(this._vertexBuffers,this._indexBuffer,t),this.alphaTest?e.drawElementsType(fn.i.TriangleFillMode,0,6):(e.setAlphaMode(this.alphaBlendingMode),e.drawElementsType(fn.i.TriangleFillMode,0,6),e.setAlphaMode(0)),this.onAfterRenderObservable.notifyObservers(this)}dispose(){const e=this._vertexBuffers[Ot.R.PositionKind];e&&(e.dispose(),this._vertexBuffers[Ot.R.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.texture&&(this.texture.dispose(),this.texture=null),this.renderTargetTextures=[];const t=this._scene.layers.indexOf(this);this._scene.layers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderObservable.clear()}}Op.ForceGLSL=!1;var Np=i(83234),wp=i(50136),Fp=i(19073),Bp=i(48267),Vp=i(99858),Lp=i(41288),kp=i(57094),Gp=i(22147),zp=i(7101),Up=i(82937),Wp=i(35256),Hp=i(22614),$p=i(70711),qp=i(16913);class Yp{static AddFlare(e,t,i,r,s){return new Yp(e,t,i,r,s)}constructor(e,t,i,r,s){this.size=e,this.position=t,this.alphaMode=6,this.color=i||new o.v9(1,1,1),this.texture=r?new $e.g(r,s.getScene(),!0):null,this._system=s;const n=s.scene.getEngine();s._onShadersLoaded.addOnce((()=>{this._drawWrapper=new Ah.E(n),this._drawWrapper.effect=n.createEffect("lensFlare",[Ot.R.PositionKind],["color","viewportMatrix"],["textureSampler"],"",void 0,void 0,void 0,void 0,s.shaderLanguage)})),s.lensFlares.push(this)}dispose(){this.texture&&this.texture.dispose();const e=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(e,1)}}class Xp{get scene(){return this._scene}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i){this.name=e,this.lensFlares=[],this.borderLimit=300,this.viewportBorder=0,this.layerMask=268435455,this._shaderLanguage=0,this._vertexBuffers={},this._isEnabled=!0,this._onShadersLoaded=new s.cP(void 0,!0),this._shadersLoaded=!1,this._scene=i||C.q.LastCreatedScene,Xp._SceneComponentInitialization(this._scene),this._emitter=t,this.id=e,i.lensFlareSystems.push(this),this.meshesSelectionPredicate=e=>i.activeCamera&&e.material&&e.isVisible&&e.isEnabled()&&e.isBlocker&&!!(e.layerMask&i.activeCamera.layerMask);const r=i.getEngine(),n=[];n.push(1,1),n.push(-1,1),n.push(-1,-1),n.push(1,-1),this._vertexBuffers[Ot.R.PositionKind]=new Ot.R(r,n,Ot.R.PositionKind,!1,!1,2),this._createIndexBuffer(),this._initShaderSourceAsync()}async _initShaderSourceAsync(){this._scene.getEngine().isWebGPU&&!Xp.ForceGLSL?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,53880)),Promise.resolve().then(i.bind(i,59382))])):await Promise.all([Promise.resolve().then(i.bind(i,5823)),Promise.resolve().then(i.bind(i,70633))]),this._shadersLoaded=!0,this._onShadersLoaded.notifyObservers()}_createIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled=e}getScene(){return this._scene}getEmitter(){return this._emitter}setEmitter(e){this._emitter=e}getEmitterPosition(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position}computeEffectivePosition(e){let t=this.getEmitterPosition();t=n.Pq.Project(t,n.uq.Identity(),this._scene.getTransformMatrix(),e),this._positionX=t.x,this._positionY=t.y,t=n.Pq.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix()),this.viewportBorder>0&&(e.x-=this.viewportBorder,e.y-=this.viewportBorder,e.width+=2*this.viewportBorder,e.height+=2*this.viewportBorder,t.x+=this.viewportBorder,t.y+=this.viewportBorder,this._positionX+=this.viewportBorder,this._positionY+=this.viewportBorder);const i=this._scene.useRightHandedSystem;return!!(t.z>0&&!i||t.z<0&&i)&&(this._positionX>e.x&&this._positionX<e.x+e.width&&this._positionY>e.y&&(this._positionY,e.y,e.height),!0)}_isVisible(){if(!this._isEnabled||!this._scene.activeCamera)return!1;const e=this.getEmitterPosition().subtract(this._scene.activeCamera.globalPosition),t=e.length();e.normalize();const i=new st.Ray(this._scene.activeCamera.globalPosition,e),r=this._scene.pickWithRay(i,this.meshesSelectionPredicate,!0);return!r||!r.hit||r.distance>t}render(){if(!this._scene.activeCamera||!this._shadersLoaded)return!1;const e=this._scene.getEngine(),t=this._scene.activeCamera.viewport.toGlobal(e.getRenderWidth(!0),e.getRenderHeight(!0));if(!this.computeEffectivePosition(t))return!1;if(!this._isVisible())return!1;let i,r;i=this._positionX<this.borderLimit+t.x?this.borderLimit+t.x-this._positionX:this._positionX>t.x+t.width-this.borderLimit?this._positionX-t.x-t.width+this.borderLimit:0,r=this._positionY<this.borderLimit+t.y?this.borderLimit+t.y-this._positionY:this._positionY>t.y+t.height-this.borderLimit?this._positionY-t.y-t.height+this.borderLimit:0;let s=i>r?i:r;s-=this.viewportBorder,s>this.borderLimit&&(s=this.borderLimit);let o=1-(0,yt.Clamp)(s/this.borderLimit,0,1);if(o<0)return!1;o>1&&(o=1),this.viewportBorder>0&&(t.x+=this.viewportBorder,t.y+=this.viewportBorder,t.width-=2*this.viewportBorder,t.height-=2*this.viewportBorder,this._positionX-=this.viewportBorder,this._positionY-=this.viewportBorder);const a=t.x+t.width/2,l=t.y+t.height/2,h=a-this._positionX,c=l-this._positionY;e.setState(!1),e.setDepthBuffer(!1);for(let i=0;i<this.lensFlares.length;i++){const r=this.lensFlares[i];if(!r._drawWrapper.effect.isReady()||r.texture&&!r.texture.isReady())continue;e.enableEffect(r._drawWrapper),e.bindBuffers(this._vertexBuffers,this._indexBuffer,r._drawWrapper.effect),e.setAlphaMode(r.alphaMode);const s=a-h*r.position,u=l-c*r.position,d=r.size,p=r.size*e.getAspectRatio(this._scene.activeCamera,!0),m=(s-t.x)/t.width*2-1,f=1-(u-t.y)/t.height*2,_=n.uq.FromValues(d/2,0,0,0,0,p/2,0,0,0,0,1,0,m,f,0,1);r._drawWrapper.effect.setMatrix("viewportMatrix",_),r._drawWrapper.effect.setTexture("textureSampler",r.texture),r._drawWrapper.effect.setFloat4("color",r.color.r*o,r.color.g*o,r.color.b*o,1),e.drawElementsType(fn.i.TriangleFillMode,0,6)}return e.setDepthBuffer(!0),e.setAlphaMode(0),!0}rebuild(){this._createIndexBuffer();for(const e in this._vertexBuffers)this._vertexBuffers[e]?._rebuild()}dispose(){this._onShadersLoaded.clear();const e=this._vertexBuffers[Ot.R.PositionKind];for(e&&(e.dispose(),this._vertexBuffers[Ot.R.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.lensFlares.length;)this.lensFlares[0].dispose();const t=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(t,1)}static Parse(e,t,i){const r=t.getLastEntryById(e.emitterId),s=e.name||"lensFlareSystem#"+e.emitterId,n=new Xp(s,r,t);n.id=e.id||s,n.borderLimit=e.borderLimit;for(let t=0;t<e.flares.length;t++){const r=e.flares[t];Yp.AddFlare(r.size,r.position,o.v9.FromArray(r.color),r.textureName?i+r.textureName:"",n)}return n}serialize(){const e={};e.id=this.id,e.name=this.name,e.emitterId=this.getEmitter().id,e.borderLimit=this.borderLimit,e.flares=[];for(let t=0;t<this.lensFlares.length;t++){const i=this.lensFlares[t];e.flares.push({size:i.size,position:i.position,color:i.color.asArray(),textureName:H.S0.GetFilename(i.texture?i.texture.name:"")})}return e}}Xp.ForceGLSL=!1,Xp._SceneComponentInitialization=e=>{throw(0,Ph.n)("LensFlareSystemSceneComponent")},(0,Ep.ji)(Ei.v.NAME_LENSFLARESYSTEM,((e,t,i,r)=>{if(void 0!==e.lensFlareSystems&&null!==e.lensFlareSystems){i.lensFlareSystems||(i.lensFlareSystems=[]);for(let s=0,n=e.lensFlareSystems.length;s<n;s++){const n=e.lensFlareSystems[s],o=Xp.Parse(n,t,r);i.lensFlareSystems.push(o)}}})),it.Z.prototype.getLensFlareSystemByName=function(e){for(let t=0;t<this.lensFlareSystems.length;t++)if(this.lensFlareSystems[t].name===e)return this.lensFlareSystems[t];return null},it.Z.prototype.getLensFlareSystemById=function(e){for(let t=0;t<this.lensFlareSystems.length;t++)if(this.lensFlareSystems[t].id===e)return this.lensFlareSystems[t];return null},it.Z.prototype.getLensFlareSystemByID=function(e){return this.getLensFlareSystemById(e)},it.Z.prototype.removeLensFlareSystem=function(e){const t=this.lensFlareSystems.indexOf(e);return-1!==t&&this.lensFlareSystems.splice(t,1),t},it.Z.prototype.addLensFlareSystem=function(e){this.lensFlareSystems.push(e)};class jp{constructor(e){this.name=Ei.v.NAME_LENSFLARESYSTEM,this.scene=e}register(){this.scene._afterCameraDrawStage.registerStep(Ei.v.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM,this,this._draw)}rebuild(){for(let e=0;e<this.scene.lensFlareSystems.length;e++)this.scene.lensFlareSystems[e].rebuild()}addFromContainer(e){e.lensFlareSystems&&e.lensFlareSystems.forEach((e=>{this.scene.addLensFlareSystem(e)}))}removeFromContainer(e,t){e.lensFlareSystems&&e.lensFlareSystems.forEach((e=>{this.scene.removeLensFlareSystem(e),t&&e.dispose()}))}serialize(e){e.lensFlareSystems=[];const t=this.scene.lensFlareSystems;for(const i of t)e.lensFlareSystems.push(i.serialize())}dispose(){const e=this.scene.lensFlareSystems;for(;e.length;)e[0].dispose()}_draw(e){if(this.scene.lensFlaresEnabled){const t=this.scene.lensFlareSystems;H.S0.StartPerformanceCounter("Lens flares",t.length>0);for(const i of t)e.layerMask&i.layerMask&&i.render();H.S0.EndPerformanceCounter("Lens flares",t.length>0)}}}Xp._SceneComponentInitialization=e=>{let t=e._getComponent(Ei.v.NAME_LENSFLARESYSTEM);t||(t=new jp(e),e._addComponent(t))};var Zp=i(5823),Qp=i(70633),Kp=i(53880),Jp=i(59382),em=i(83316);(0,Ep.ji)(Ei.v.NAME_SHADOWGENERATOR,((e,t)=>{if(void 0!==e.shadowGenerators&&null!==e.shadowGenerators)for(let i=0,r=e.shadowGenerators.length;i<r;i++){const r=e.shadowGenerators[i];r.className===Uh.CLASSNAME?Uh.Parse(r,t):Ih.Parse(r,t)}}));class tm{constructor(e){this.name=Ei.v.NAME_SHADOWGENERATOR,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(Ei.v.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}rebuild(){}serialize(e){e.shadowGenerators=[];const t=this.scene.lights;for(const i of t){if(i.doNotSerialize)continue;const t=i.getShadowGenerators();if(t){const i=t.values();for(let t=i.next();!0!==t.done;t=i.next()){const i=t.value;i.doNotSerialize||e.shadowGenerators.push(i.serialize())}}}}addFromContainer(e){}removeFromContainer(e,t){}dispose(){}_gatherRenderTargets(e){const t=this.scene;if(this.scene.shadowsEnabled)for(let i=0;i<t.lights.length;i++){const r=t.lights[i],s=r.getShadowGenerators();if(r.isEnabled()&&r.shadowEnabled&&s){const i=s.values();for(let r=i.next();!0!==r.done;r=i.next()){const i=r.value.getShadowMap();-1!==t.textures.indexOf(i)&&e.push(i)}}}}}Ih._SceneComponentInitialization=e=>{let t=e._getComponent(Ei.v.NAME_SHADOWGENERATOR);t||(t=new tm(e),e._addComponent(t))};var im=i(87428),rm=i(32303),sm=i(10355),nm=i(95799),om=i(70169),am=i(29468),lm=i(69386),hm=i(85426),cm=i(67524);function um(e){const t=e.useDelayedTextureLoading;e.useDelayedTextureLoading=!1;const i=e._blockEntityCollection;e._blockEntityCollection=!1,e._ltcTextures={LTC1:He.I.CreateRGBATexture(null,64,64,e.getEngine(),!1,!1,2,2,0,!1,!0),LTC2:He.I.CreateRGBATexture(null,64,64,e.getEngine(),!1,!1,2,2,0,!1,!0)},e._blockEntityCollection=i,e._ltcTextures.LTC1.wrapU=$e.g.CLAMP_ADDRESSMODE,e._ltcTextures.LTC1.wrapV=$e.g.CLAMP_ADDRESSMODE,e._ltcTextures.LTC2.wrapU=$e.g.CLAMP_ADDRESSMODE,e._ltcTextures.LTC2.wrapV=$e.g.CLAMP_ADDRESSMODE,e.useDelayedTextureLoading=t,async function(){const e=new Uint16Array(16384),t=new Uint16Array(16384),i=await H.S0.LoadFileAsync(H.S0.GetAssetUrl("https://assets.babylonjs.com/core/areaLights/areaLightsLTC.bin")),r=new Uint16Array(i),s=r.length/8;for(let i=0;i<s;i++)e[4*i]=r[8*i],e[4*i+1]=r[8*i+1],e[4*i+2]=r[8*i+2],e[4*i+3]=r[8*i+3],t[4*i]=r[8*i+4],t[4*i+1]=r[8*i+5],t[4*i+2]=r[8*i+6],t[4*i+3]=r[8*i+7];return[e,t]}().then((t=>{if(e._ltcTextures){const i=e._ltcTextures?.LTC1;i.update(t[0]);const r=e._ltcTextures?.LTC2;r.update(t[1]),e.onDisposeObservable.addOnce((()=>{e._ltcTextures?.LTC1.dispose(),e._ltcTextures?.LTC2.dispose()}))}})).catch((e=>{m.V.Error(`Area Light fail to get LTC textures data. Error: ${e}`)}))}class dm extends Ns.v{constructor(e,t,i){super(e,i),this.position=t,this._scene._ltcTextures||um(this._scene)}transferTexturesToEffect(e){return this._scene._ltcTextures&&(e.setTexture("areaLightsLTC1Sampler",this._scene._ltcTextures.LTC1),e.setTexture("areaLightsLTC2Sampler",this._scene._ltcTextures.LTC2)),this}prepareLightSpecificDefines(e,t){e["AREALIGHT"+t]=!0,e.AREALIGHTUSED=!0}_isReady(){return!!this._scene._ltcTextures&&(this._scene._ltcTextures.LTC1.isReady()&&this._scene._ltcTextures.LTC2.isReady())}}pi.b.AddNodeConstructor("Light_Type_4",((e,t)=>()=>new pm(e,n.Pq.Zero(),1,1,t)));class pm extends dm{get width(){return this._width.x}set width(e){this._width.x=e}get height(){return this._height.y}set height(e){this._height.y=e}constructor(e,t,i,r,s){super(e,t,s),this._width=new n.Pq(i,0,0),this._height=new n.Pq(0,r,0),this._pointTransformedPosition=n.Pq.Zero(),this._pointTransformedWidth=n.Pq.Zero(),this._pointTransformedHeight=n.Pq.Zero()}getClassName(){return"RectAreaLight"}getTypeID(){return Ns.v.LIGHTTYPEID_RECT_AREALIGHT}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightWidth",4),this._uniformBuffer.addUniform("vLightHeight",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeTransformedInformation(){return!(!this.parent||!this.parent.getWorldMatrix)&&(n.Pq.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this._pointTransformedPosition),n.Pq.TransformNormalToRef(this._width,this.parent.getWorldMatrix(),this._pointTransformedWidth),n.Pq.TransformNormalToRef(this._height,this.parent.getWorldMatrix(),this._pointTransformedHeight),!0)}transferToEffect(e,t){return this._computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this._pointTransformedPosition.x,this._pointTransformedPosition.y,this._pointTransformedPosition.z,0,t),this._uniformBuffer.updateFloat4("vLightWidth",this._pointTransformedWidth.x/2,this._pointTransformedWidth.y/2,this._pointTransformedWidth.z/2,0,t),this._uniformBuffer.updateFloat4("vLightHeight",this._pointTransformedHeight.x/2,this._pointTransformedHeight.y/2,this._pointTransformedHeight.z/2,0,t)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightWidth",this._width.x/2,this._width.y/2,this._width.z/2,0,t),this._uniformBuffer.updateFloat4("vLightHeight",this._height.x/2,this._height.y/2,this._height.z/2,0,t)),this}transferToNodeMaterialEffect(e,t){return this._computeTransformedInformation()?e.setFloat3(t,this._pointTransformedPosition.x,this._pointTransformedPosition.y,this._pointTransformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this}}(0,Ge.Cg)([(0,ze.lK)()],pm.prototype,"width",null),(0,Ge.Cg)([(0,ze.lK)()],pm.prototype,"height",null),(0,a.Y5)("BABYLON.RectAreaLight",pm);var mm=i(83020);class fm{constructor(e,t="",i="black"){this._renderingCanvas=e,this._loadingText=t,this._loadingDivBackgroundColor=i,this._loadingDivToRenderingCanvasMap=new Map,this._resizeLoadingUI=()=>{this._isLoading&&this._loadingDivToRenderingCanvasMap.forEach((([e,t],i)=>{const r=e.getBoundingClientRect();if(this._isCanvasLayoutChanged(t,r)){const t=window.getComputedStyle(e).position;i.style.position="fixed"===t?"fixed":"absolute",i.style.left=r.left+window.scrollX+"px",i.style.top=r.top+window.scrollY+"px",i.style.width=r.width+"px",i.style.height=r.height+"px",this._loadingDivToRenderingCanvasMap.set(i,[e,r])}}))}}displayLoadingUI(){if(this._isLoading)return;this._isLoading=!0,this._engine=C.q.Instances.find((e=>e.getRenderingCanvas()===this._renderingCanvas));const e=document.createElement("div");e.id="babylonjsLoadingDiv",e.style.opacity="0",e.style.transition="opacity 1.5s ease",e.style.pointerEvents="none",e.style.display="grid",e.style.gridTemplateRows="100%",e.style.gridTemplateColumns="100%",e.style.justifyItems="center",e.style.alignItems="center",this._loadingTextDiv=document.createElement("div"),this._loadingTextDiv.style.position="absolute",this._loadingTextDiv.style.left="0",this._loadingTextDiv.style.top="50%",this._loadingTextDiv.style.marginTop="80px",this._loadingTextDiv.style.width="100%",this._loadingTextDiv.style.height="20px",this._loadingTextDiv.style.fontFamily="Arial",this._loadingTextDiv.style.fontSize="14px",this._loadingTextDiv.style.color="white",this._loadingTextDiv.style.textAlign="center",this._loadingTextDiv.style.zIndex="1",this._loadingTextDiv.innerHTML="Loading",e.appendChild(this._loadingTextDiv),this._loadingTextDiv.innerHTML=this._loadingText,this._style=document.createElement("style"),this._style.type="text/css";this._style.innerHTML="@-webkit-keyframes spin1 {                            0% { -webkit-transform: rotate(0deg);}\n                            100% { -webkit-transform: rotate(360deg);}\n                        }                        @keyframes spin1 {                            0% { transform: rotate(0deg);}\n                            100% { transform: rotate(360deg);}\n                        }",document.getElementsByTagName("head")[0].appendChild(this._style);const t=!!window.SVGSVGElement,i=new Image;fm.DefaultLogoUrl?i.src=fm.DefaultLogoUrl:i.src=t?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAuMTcgMjA4LjA0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9LmNscy0ye2ZpbGw6I2UwNjg0Yjt9LmNscy0ze2ZpbGw6I2JiNDY0Yjt9LmNscy00e2ZpbGw6I2UwZGVkODt9LmNscy01e2ZpbGw6I2Q1ZDJjYTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPkJhYnlsb25Mb2dvPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iUGFnZV9FbGVtZW50cyIgZGF0YS1uYW1lPSJQYWdlIEVsZW1lbnRzIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik05MC4wOSwwLDAsNTJWMTU2bDkwLjA5LDUyLDkwLjA4LTUyVjUyWiIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMiIgcG9pbnRzPSIxODAuMTcgNTIuMDEgMTUxLjk3IDM1LjczIDEyNC44NSA1MS4zOSAxNTMuMDUgNjcuNjcgMTgwLjE3IDUyLjAxIi8+PHBvbHlnb24gY2xhc3M9ImNscy0yIiBwb2ludHM9IjI3LjEyIDY3LjY3IDExNy4yMSAxNS42NiA5MC4wOCAwIDAgNTIuMDEgMjcuMTIgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTIiIHBvaW50cz0iNjEuODkgMTIwLjMgOTAuMDggMTM2LjU4IDExOC4yOCAxMjAuMyA5MC4wOCAxMDQuMDIgNjEuODkgMTIwLjMiLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDE1My4wNSAxNDAuMzcgOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyAwIDUyLjAxIDAgMTU2LjAzIDkwLjA4IDIwOC4wNCAxODAuMTcgMTU2LjAzIDE4MC4xNyA1Mi4wMSAxNTMuMDUgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iOTAuMDggNzEuNDYgNjEuODkgODcuNzQgNjEuODkgMTIwLjMgOTAuMDggMTA0LjAyIDExOC4yOCAxMjAuMyAxMTguMjggODcuNzQgOTAuMDggNzEuNDYiLz48cG9seWdvbiBjbGFzcz0iY2xzLTQiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDExOC4yOCA4Ny43NCAxMTguMjggMTIwLjMgOTAuMDggMTM2LjU4IDkwLjA4IDE3Ni43MiAxNTMuMDUgMTQwLjM3IDE1My4wNSA2Ny42NyIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtNSIgcG9pbnRzPSIyNy4xMiA2Ny42NyA2MS44OSA4Ny43NCA2MS44OSAxMjAuMyA5MC4wOCAxMzYuNTggOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyIvPjwvZz48L2c+PC9zdmc+":"https://cdn.babylonjs.com/Assets/babylonLogo.png",i.style.width="150px",i.style.gridColumn="1",i.style.gridRow="1",i.style.top="50%",i.style.left="50%",i.style.transform="translate(-50%, -50%)",i.style.position="absolute";const r=document.createElement("div");r.style.width="300px",r.style.gridColumn="1",r.style.gridRow="1",r.style.top="50%",r.style.left="50%",r.style.transform="translate(-50%, -50%)",r.style.position="absolute";const s=new Image;if(fm.DefaultSpinnerUrl?s.src=fm.DefaultSpinnerUrl:s.src=t?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTIgMzkyIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2UwNjg0Yjt9LmNscy0ye2ZpbGw6bm9uZTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPlNwaW5uZXJJY29uPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iU3Bpbm5lciI+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNDAuMjEsMTI2LjQzYzMuNy03LjMxLDcuNjctMTQuNDQsMTItMjEuMzJsMy4zNi01LjEsMy41Mi01YzEuMjMtMS42MywyLjQxLTMuMjksMy42NS00LjkxczIuNTMtMy4yMSwzLjgyLTQuNzlBMTg1LjIsMTg1LjIsMCwwLDEsODMuNCw2Ny40M2EyMDgsMjA4LDAsMCwxLDE5LTE1LjY2YzMuMzUtMi40MSw2Ljc0LTQuNzgsMTAuMjUtN3M3LjExLTQuMjgsMTAuNzUtNi4zMmM3LjI5LTQsMTQuNzMtOCwyMi41My0xMS40OSwzLjktMS43Miw3Ljg4LTMuMywxMi00LjY0YTEwNC4yMiwxMDQuMjIsMCwwLDEsMTIuNDQtMy4yMyw2Mi40NCw2Mi40NCwwLDAsMSwxMi43OC0xLjM5QTI1LjkyLDI1LjkyLDAsMCwxLDE5NiwyMS40NGE2LjU1LDYuNTUsMCwwLDEsMi4wNSw5LDYuNjYsNi42NiwwLDAsMS0xLjY0LDEuNzhsLS40MS4yOWEyMi4wNywyMi4wNywwLDAsMS01Ljc4LDMsMzAuNDIsMzAuNDIsMCwwLDEtNS42NywxLjYyLDM3LjgyLDM3LjgyLDAsMCwxLTUuNjkuNzFjLTEsMC0xLjkuMTgtMi44NS4yNmwtMi44NS4yNHEtNS43Mi41MS0xMS40OCwxLjFjLTMuODQuNC03LjcxLjgyLTExLjU4LDEuNGExMTIuMzQsMTEyLjM0LDAsMCwwLTIyLjk0LDUuNjFjLTMuNzIsMS4zNS03LjM0LDMtMTAuOTQsNC42NHMtNy4xNCwzLjUxLTEwLjYsNS41MUExNTEuNiwxNTEuNiwwLDAsMCw2OC41Niw4N0M2Ny4yMyw4OC40OCw2Niw5MCw2NC42NCw5MS41NnMtMi41MSwzLjE1LTMuNzUsNC43M2wtMy41NCw0LjljLTEuMTMsMS42Ni0yLjIzLDMuMzUtMy4zMyw1YTEyNywxMjcsMCwwLDAtMTAuOTMsMjEuNDksMS41OCwxLjU4LDAsMSwxLTMtMS4xNVM0MC4xOSwxMjYuNDcsNDAuMjEsMTI2LjQzWiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgd2lkdGg9IjM5MiIgaGVpZ2h0PSIzOTIiLz48L2c+PC9nPjwvc3ZnPg==":"https://cdn.babylonjs.com/Assets/loadingIcon.png",s.style.animation="spin1 0.75s infinite linear",s.style.transformOrigin="50% 50%",!t){const e={w:16,h:18.5},t={w:30,h:30};i.style.width=`${e.w}vh`,i.style.height=`${e.h}vh`,i.style.left=`calc(50% - ${e.w/2}vh)`,i.style.top=`calc(50% - ${e.h/2}vh)`,s.style.width=`${t.w}vh`,s.style.height=`${t.h}vh`,s.style.left=`calc(50% - ${t.w/2}vh)`,s.style.top=`calc(50% - ${t.h/2}vh)`}r.appendChild(s),e.appendChild(i),e.appendChild(r),e.style.backgroundColor=this._loadingDivBackgroundColor,e.style.opacity="1";const n=[],o=this._engine.views;if(o?.length)for(const e of o)e.enabled&&n.push(e.target);else n.push(this._renderingCanvas);n.forEach(((t,i)=>{const r=e.cloneNode(!0);r.id+=`-${i}`,this._loadingDivToRenderingCanvasMap.set(r,[t,null])})),this._resizeLoadingUI(),this._resizeObserver=this._engine.onResizeObservable.add((()=>{this._resizeLoadingUI()})),this._loadingDivToRenderingCanvasMap.forEach(((e,t)=>{document.body.appendChild(t)}))}hideLoadingUI(){if(!this._isLoading)return;let e=0;const t=i=>{const r=i.target;if(this._loadingDivToRenderingCanvasMap.has(r)){e++,r.remove();e===this._loadingDivToRenderingCanvasMap.size&&(this._loadingTextDiv&&(this._loadingTextDiv.remove(),this._loadingTextDiv=null),this._style&&(this._style.remove(),this._style=null),window.removeEventListener("transitionend",t),this._engine.onResizeObservable.remove(this._resizeObserver),this._loadingDivToRenderingCanvasMap.clear(),this._engine=null,this._isLoading=!1)}};this._loadingDivToRenderingCanvasMap.forEach(((e,t)=>{t.style.opacity="0"})),window.addEventListener("transitionend",t)}set loadingUIText(e){this._loadingText=e,this._loadingTextDiv&&this._loadingDivToRenderingCanvasMap.forEach(((e,t)=>{t.children[0].innerHTML=this._loadingText}))}get loadingUIText(){return this._loadingText}get loadingUIBackgroundColor(){return this._loadingDivBackgroundColor}set loadingUIBackgroundColor(e){this._loadingDivBackgroundColor=e,this._isLoading&&this._loadingDivToRenderingCanvasMap.forEach(((e,t)=>{t.style.backgroundColor=this._loadingDivBackgroundColor}))}_isCanvasLayoutChanged(e,t){return!e||e.left!==t.left||e.top!==t.top||e.right!==t.right||e.bottom!==t.bottom||e.width!==t.width||e.height!==t.height||e.x!==t.x||e.y!==t.y}}fm.DefaultLogoUrl="",fm.DefaultSpinnerUrl="",$.$.DefaultLoadingScreenFactory=e=>new fm(e);var _m=i(27050),gm=i(55157),xm=i(40391),vm=i(98639);class Sm{constructor(){this._hasHit=!1,this._hitNormal=n.Pq.Zero(),this._hitPoint=n.Pq.Zero(),this._triangleIndex=-1}get hitPoint(){return this._hitPoint}get hitNormal(){return this._hitNormal}get hasHit(){return this._hasHit}get triangleIndex(){return this._triangleIndex}setHitData(e,t,i){this._hasHit=!0,this._hitNormal.set(e.x,e.y,e.z),this._hitPoint.set(t.x,t.y,t.z),this._triangleIndex=i??-1}reset(){this._hasHit=!1,this._hitNormal.setAll(0),this._hitPoint.setAll(0),this._triangleIndex=-1,this.body=void 0,this.bodyIndex=void 0,this.shape=void 0}}class bm extends Sm{constructor(){super(...arguments),this._hitDistance=0,this._rayFromWorld=n.Pq.Zero(),this._rayToWorld=n.Pq.Zero()}get hitDistance(){return this._hitDistance}get hitNormalWorld(){return this._hitNormal}get hitPointWorld(){return this._hitPoint}get rayFromWorld(){return this._rayFromWorld}get rayToWorld(){return this._rayToWorld}setHitDistance(e){this._hitDistance=e}calculateHitDistance(){this._hitDistance=n.Pq.Distance(this._rayFromWorld,this._hitPoint)}reset(e=n.Pq.Zero(),t=n.Pq.Zero()){super.reset(),this._rayFromWorld.copyFrom(e),this._rayToWorld.copyFrom(t),this._hitDistance=0}}class ym{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw(0,Ph.n)("CannonJSPlugin")}constructor(e,t=ym.DefaultPluginFactory()){if(this._physicsPlugin=t,this._impostors=[],this._joints=[],this._subTimeStep=0,this._uniqueIdCounter=0,!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");e=e||new n.Pq(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._impostors.forEach((function(e){e.dispose()})),this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}addImpostor(e){this._impostors.push(e),e.uniqueId=this._uniqueIdCounter++,e.parent||this._physicsPlugin.generatePhysicsBody(e)}removeImpostor(e){const t=this._impostors.indexOf(e);if(t>-1){this._impostors.splice(t,1).length&&this.getPhysicsPlugin().removePhysicsBody(e)}}addJoint(e,t,i){const r={mainImpostor:e,connectedImpostor:t,joint:i};i.physicsPlugin=this._physicsPlugin,this._joints.push(r),this._physicsPlugin.generateJoint(r)}removeJoint(e,t,i){const r=this._joints.filter((function(r){return r.connectedImpostor===t&&r.joint===i&&r.mainImpostor===e}));r.length&&this._physicsPlugin.removeJoint(r[0])}_step(e){this._impostors.forEach((e=>{e.isBodyInitRequired()&&this._physicsPlugin.generatePhysicsBody(e)})),e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._impostors)}getPhysicsPlugin(){return this._physicsPlugin}getImpostors(){return this._impostors}getImpostorForPhysicsObject(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].object===e)return this._impostors[t];return null}getImpostorWithPhysicsBody(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].physicsBody===e)return this._impostors[t];return null}raycast(e,t){return this._physicsPlugin.raycast(e,t)}raycastToRef(e,t,i){return this._physicsPlugin.raycastToRef(e,t,i)}}class Pm{constructor(e=!0,t=10,i=CANNON){this._useDeltaForWorldStep=e,this.name="CannonJSPlugin",this._physicsMaterials=new Array,this._fixedTimeStep=1/60,this._physicsBodiesToRemoveAfterStep=new Array,this._firstFrame=!0,this._tmpQuaternion=new n.PT,this._minus90X=new n.PT(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new n.PT(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=n.Pq.Zero(),this._tmpDeltaPosition=n.Pq.Zero(),this._tmpUnityRotation=new n.PT,this.BJSCANNON=i,this.isSupported()?(this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=t,this._cannonRaycastResult=new this.BJSCANNON.RaycastResult,this._raycastResult=new bm):m.V.Error("CannonJS is not available. Please make sure you included the js file.")}getPluginVersion(){return 1}setGravity(e){const t=e;this.world.gravity.set(t.x,t.y,t.z)}setTimeStep(e){this._fixedTimeStep=e}getTimeStep(){return this._fixedTimeStep}executeStep(e,t){if(this._firstFrame){this._firstFrame=!1;for(const e of t)e.type!=Xs.HeightmapImpostor&&e.type!==Xs.PlaneImpostor&&e.beforeStep()}this.world.step(this._useDeltaForWorldStep?e:this._fixedTimeStep),this._removeMarkedPhysicsBodiesFromWorld()}_removeMarkedPhysicsBodiesFromWorld(){this._physicsBodiesToRemoveAfterStep.length>0&&(this._physicsBodiesToRemoveAfterStep.forEach((e=>{"function"==typeof this.world.removeBody?this.world.removeBody(e):this.world.remove(e)})),this._physicsBodiesToRemoveAfterStep.length=0)}applyImpulse(e,t,i){const r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),s=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyImpulse(s,r)}applyForce(e,t,i){const r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),s=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyForce(s,r)}generatePhysicsBody(e){if(this._removeMarkedPhysicsBodiesFromWorld(),e.parent)e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());else{if(e.isBodyInitRequired()){const t=this._createShape(e);if(!t)return void m.V.Warn("It was not possible to create a physics body for this object.");const i=e.physicsBody;i&&this.removePhysicsBody(e);const r=this._addMaterial("mat-"+e.uniqueId,e.getParam("friction"),e.getParam("restitution")),s={mass:e.getParam("mass"),material:r},n=e.getParam("nativeOptions");for(const e in n)Object.prototype.hasOwnProperty.call(n,e)&&(s[e]=n[e]);e.physicsBody=new this.BJSCANNON.Body(s),e.physicsBody.addEventListener("collide",e.onCollide),this.world.addEventListener("preStep",e.beforeStep),this.world.addEventListener("postStep",e.afterStep),e.physicsBody.addShape(t),"function"==typeof this.world.addBody?this.world.addBody(e.physicsBody):this.world.add(e.physicsBody),i&&["force","torque","velocity","angularVelocity"].forEach((function(t){const r=i[t];e.physicsBody[t].set(r.x,r.y,r.z)})),this._processChildMeshes(e)}this._updatePhysicsBodyTransformation(e)}}_processChildMeshes(e){const t=e.object.getChildMeshes?e.object.getChildMeshes(!0):[],i=e.object.rotationQuaternion;if(i?i.conjugateToRef(this._tmpQuaternion):this._tmpQuaternion.set(0,0,0,1),t.length){const i=t=>{if(!t.rotationQuaternion)return;const r=t.getPhysicsImpostor();if(r){if(r.parent!==e&&t.parent){const i=t.getAbsolutePosition().subtract(t.parent.getAbsolutePosition()),s=t.rotationQuaternion.multiply(this._tmpQuaternion);r.physicsBody&&(this.removePhysicsBody(r),r.physicsBody=null),r.parent=e,r.resetUpdateFlags(),e.physicsBody.addShape(this._createShape(r),new this.BJSCANNON.Vec3(i.x,i.y,i.z),new this.BJSCANNON.Quaternion(s.x,s.y,s.z,s.w)),e.physicsBody.mass+=r.getParam("mass")}}t.getChildMeshes(!0).filter((e=>!!e.physicsImpostor)).forEach(i)};t.filter((e=>!!e.physicsImpostor)).forEach(i)}}removePhysicsBody(e){e.physicsBody.removeEventListener("collide",e.onCollide),this.world.removeEventListener("preStep",e.beforeStep),this.world.removeEventListener("postStep",e.afterStep),-1===this._physicsBodiesToRemoveAfterStep.indexOf(e.physicsBody)&&this._physicsBodiesToRemoveAfterStep.push(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;let r;const s=e.joint.jointData,n={pivotA:s.mainPivot?(new this.BJSCANNON.Vec3).set(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z):null,pivotB:s.connectedPivot?(new this.BJSCANNON.Vec3).set(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z):null,axisA:s.mainAxis?(new this.BJSCANNON.Vec3).set(s.mainAxis.x,s.mainAxis.y,s.mainAxis.z):null,axisB:s.connectedAxis?(new this.BJSCANNON.Vec3).set(s.connectedAxis.x,s.connectedAxis.y,s.connectedAxis.z):null,maxForce:s.nativeParams.maxForce,collideConnected:!!s.collision};switch(e.joint.type){case Ws.HingeJoint:case Ws.Hinge2Joint:r=new this.BJSCANNON.HingeConstraint(t,i,n);break;case Ws.DistanceJoint:r=new this.BJSCANNON.DistanceConstraint(t,i,s.maxDistance||2);break;case Ws.SpringJoint:{const e=s;r=new this.BJSCANNON.Spring(t,i,{restLength:e.length,stiffness:e.stiffness,damping:e.damping,localAnchorA:n.pivotA,localAnchorB:n.pivotB});break}case Ws.LockJoint:r=new this.BJSCANNON.LockConstraint(t,i,n);break;case Ws.PointToPointJoint:case Ws.BallAndSocketJoint:default:r=new this.BJSCANNON.PointToPointConstraint(t,n.pivotA,i,n.pivotB,n.maxForce)}r.collideConnected=!!s.collision,e.joint.physicsJoint=r,e.joint.type!==Ws.SpringJoint?this.world.addConstraint(r):(e.joint.jointData.forceApplicationCallback=e.joint.jointData.forceApplicationCallback||function(){r.applyForce()},e.mainImpostor.registerAfterPhysicsStep(e.joint.jointData.forceApplicationCallback))}removeJoint(e){e.joint.type!==Ws.SpringJoint?this.world.removeConstraint(e.joint.physicsJoint):e.mainImpostor.unregisterAfterPhysicsStep(e.joint.jointData.forceApplicationCallback)}_addMaterial(e,t,i){let r,s;for(r=0;r<this._physicsMaterials.length;r++)if(s=this._physicsMaterials[r],s.friction===t&&s.restitution===i)return s;const n=new this.BJSCANNON.Material(e);return n.friction=t,n.restitution=i,this._physicsMaterials.push(n),n}_checkWithEpsilon(e){return e<ut.bH?ut.bH:e}_createShape(e){const t=e.object;let i;const r=e.getObjectExtents();switch(e.type){case Xs.SphereImpostor:{const e=r.x,t=r.y,s=r.z;i=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(e),this._checkWithEpsilon(t),this._checkWithEpsilon(s))/2);break}case Xs.CylinderImpostor:{let t=e.getParam("nativeOptions");t||(t={});const s=void 0!==t.radiusTop?t.radiusTop:this._checkWithEpsilon(r.x)/2,n=void 0!==t.radiusBottom?t.radiusBottom:this._checkWithEpsilon(r.x)/2,o=void 0!==t.height?t.height:this._checkWithEpsilon(r.y),a=void 0!==t.numSegments?t.numSegments:16;i=new this.BJSCANNON.Cylinder(s,n,o,a);const l=new this.BJSCANNON.Quaternion;l.setFromAxisAngle(new this.BJSCANNON.Vec3(1,0,0),-Math.PI/2);const h=new this.BJSCANNON.Vec3(0,0,0);i.transformAllPoints(h,l);break}case Xs.BoxImpostor:{const e=r.scale(.5);i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(e.x),this._checkWithEpsilon(e.y),this._checkWithEpsilon(e.z)));break}case Xs.PlaneImpostor:m.V.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),i=new this.BJSCANNON.Plane;break;case Xs.MeshImpostor:{const r=t.getVerticesData?t.getVerticesData(Ot.R.PositionKind):[],s=t.getIndices?t.getIndices():[];if(!r)return void m.V.Warn("Tried to create a MeshImpostor for an object without vertices. This will fail.");const o=t.position.clone(),a=t.rotation&&t.rotation.clone(),l=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace();const h=t.computeWorldMatrix(!0),c=[];let u;for(u=0;u<r.length;u+=3)n.Pq.TransformCoordinates(n.Pq.FromArray(r,u),h).toArray(c,u);m.V.Warn("MeshImpostor only collides against spheres."),i=new this.BJSCANNON.Trimesh(c,s),t.position.copyFrom(o),a&&t.rotation&&t.rotation.copyFrom(a),l&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(l);break}case Xs.HeightmapImpostor:{const r=t.position.clone(),s=t.rotation&&t.rotation.clone(),n=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace(),t.rotationQuaternion&&t.rotationQuaternion.multiplyInPlace(this._minus90X),i=this._createHeightmap(t),t.position.copyFrom(r),s&&t.rotation&&t.rotation.copyFrom(s),n&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(n),t.computeWorldMatrix(!0);break}case Xs.ParticleImpostor:i=new this.BJSCANNON.Particle;break;case Xs.NoImpostor:i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(0,0,0))}return i}_createHeightmap(e,t){let i=e.getVerticesData(Ot.R.PositionKind);const r=e.computeWorldMatrix(!0),s=[];let o;for(o=0;o<i.length;o+=3)n.Pq.TransformCoordinates(n.Pq.FromArray(i,o),r).toArray(s,o);i=s;const a=new Array,l=t||~~(Math.sqrt(i.length/3)-1),h=e.getBoundingInfo(),c=Math.min(h.boundingBox.extendSizeWorld.x,h.boundingBox.extendSizeWorld.y),u=h.boundingBox.extendSizeWorld.z,d=2*c/l;for(let e=0;e<i.length;e+=3){const t=Math.round(i[e+0]/d+l/2),r=Math.round(-1*(i[e+1]/d-l/2)),s=-i[e+2]+u;a[t]||(a[t]=[]),a[t][r]||(a[t][r]=s),a[t][r]=Math.max(s,a[t][r])}for(let e=0;e<=l;++e){if(!a[e]){let t=1;for(;!a[(e+t)%l];)t++;a[e]=a[(e+t)%l].slice()}for(let t=0;t<=l;++t)if(!a[e][t]){let i,r=1;for(;void 0===i;)i=a[e][(t+r++)%l];a[e][t]=i}}const p=new this.BJSCANNON.Heightfield(a,{elementSize:d});return p.minY=u,p}_updatePhysicsBodyTransformation(e){const t=e.object;if(t.computeWorldMatrix&&t.computeWorldMatrix(!0),!t.getBoundingInfo())return;const i=e.getObjectCenter();this._tmpDeltaPosition.copyFrom(t.getAbsolutePivotPoint().subtract(i)),this._tmpDeltaPosition.divideInPlace(e.object.scaling),this._tmpPosition.copyFrom(i);let r=t.rotationQuaternion;if(r){if(e.type!==Xs.PlaneImpostor&&e.type!==Xs.HeightmapImpostor||(r=r.multiply(this._minus90X),e.setDeltaRotation(this._plus90X)),e.type===Xs.HeightmapImpostor){const e=t;let r=e.getBoundingInfo();const s=e.rotationQuaternion;e.rotationQuaternion=this._tmpUnityRotation,e.computeWorldMatrix(!0);const o=i.clone();let a=e.getPivotMatrix();a=a?a.clone():n.uq.Identity();const l=n.uq.Translation(r.boundingBox.extendSizeWorld.x,0,-r.boundingBox.extendSizeWorld.z);e.setPreTransformMatrix(l),e.computeWorldMatrix(!0),r=e.getBoundingInfo();const h=r.boundingBox.centerWorld.subtract(i).subtract(e.position).negate();this._tmpPosition.copyFromFloats(h.x,h.y-r.boundingBox.extendSizeWorld.y,h.z),this._tmpDeltaPosition.copyFrom(r.boundingBox.centerWorld.subtract(o)),this._tmpDeltaPosition.y+=r.boundingBox.extendSizeWorld.y,e.rotationQuaternion=s,e.setPreTransformMatrix(a),e.computeWorldMatrix(!0)}else e.type===Xs.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpDeltaPosition),e.physicsBody.position.set(this._tmpPosition.x,this._tmpPosition.y,this._tmpPosition.z),e.physicsBody.quaternion.set(r.x,r.y,r.z,r.w)}}setTransformationFromPhysicsBody(e){if(e.object.position.set(e.physicsBody.position.x,e.physicsBody.position.y,e.physicsBody.position.z),e.object.rotationQuaternion){const t=e.physicsBody.quaternion;e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}setPhysicsBodyTransformation(e,t,i){e.physicsBody.position.set(t.x,t.y,t.z),e.physicsBody.quaternion.set(i.x,i.y,i.z,i.w)}isSupported(){return void 0!==this.BJSCANNON}setLinearVelocity(e,t){e.physicsBody.velocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.velocity;return t?new n.Pq(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new n.Pq(t.x,t.y,t.z):null}setBodyMass(e,t){e.physicsBody.mass=t,e.physicsBody.updateMassProperties()}getBodyMass(e){return e.physicsBody.mass}getBodyFriction(e){return e.physicsBody.material.friction}setBodyFriction(e,t){e.physicsBody.material.friction=t}getBodyRestitution(e){return e.physicsBody.material.restitution}setBodyRestitution(e,t){e.physicsBody.material.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.wakeUp()}updateDistanceJoint(e,t){e.physicsJoint.distance=t}setMotor(e,t,i,r){r||(e.physicsJoint.enableMotor(),e.physicsJoint.setMotorSpeed(t),i&&this.setLimit(e,i))}setLimit(e,t,i){e.physicsJoint.motorEquation.maxForce=i,e.physicsJoint.motorEquation.minForce=void 0===t?-t:t}syncMeshWithImpostor(e,t){const i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.quaternion.x,e.rotationQuaternion.y=i.quaternion.y,e.rotationQuaternion.z=i.quaternion.z,e.rotationQuaternion.w=i.quaternion.w)}getRadius(e){return e.physicsBody.shapes[0].boundingSphereRadius}getBoxSizeToRef(e,t){const i=e.physicsBody.shapes[0];t.x=2*i.halfExtents.x,t.y=2*i.halfExtents.y,t.z=2*i.halfExtents.z}dispose(){}_extendNamespace(){const e=new this.BJSCANNON.Vec3,t=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(i,r,s){if(s=s||10,0===(r=r||0))this.internalStep(i),this.time+=i;else{let n=Math.floor((this.time+r)/i)-Math.floor(this.time/i);n=Math.min(n,s)||1;const o=performance.now();for(let e=0;e!==n&&(this.internalStep(i),!(performance.now()-o>1e3*i));e++);this.time+=r;const a=this.time%i/i,l=e,h=this.bodies;for(let e=0;e!==h.length;e++){const i=h[e];i.type!==t.Body.STATIC&&i.sleepState!==t.Body.SLEEPING?(i.position.vsub(i.previousPosition,l),l.scale(a,l),i.position.vadd(l,i.interpolatedPosition)):(i.interpolatedPosition.set(i.position.x,i.position.y,i.position.z),i.interpolatedQuaternion.set(i.quaternion.x,i.quaternion.y,i.quaternion.z,i.quaternion.w))}}}}raycast(e,t){return this._raycastResult.reset(e,t),this.raycastToRef(e,t,this._raycastResult),this._raycastResult}raycastToRef(e,t,i){this._cannonRaycastResult.reset(),this.world.raycastClosest(e,t,{},this._cannonRaycastResult),i.reset(e,t),this._cannonRaycastResult.hasHit&&(i.setHitData({x:this._cannonRaycastResult.hitNormalWorld.x,y:this._cannonRaycastResult.hitNormalWorld.y,z:this._cannonRaycastResult.hitNormalWorld.z},{x:this._cannonRaycastResult.hitPointWorld.x,y:this._cannonRaycastResult.hitPointWorld.y,z:this._cannonRaycastResult.hitPointWorld.z}),i.setHitDistance(this._cannonRaycastResult.distance))}}ym.DefaultPluginFactory=()=>new Pm;class Tm{constructor(e=!0,t,i=OIMO){this._useDeltaForWorldStep=e,this.name="OimoJSPlugin",this._fixedTimeStep=1/60,this._tmpImpostorsArray=[],this._tmpPositionVector=n.Pq.Zero(),this.BJSOIMO=i,this.world=new this.BJSOIMO.World({iterations:t}),this.world.clear(),this._raycastResult=new bm}getPluginVersion(){return 1}setGravity(e){this.world.gravity.set(e.x,e.y,e.z)}setTimeStep(e){this.world.timeStep=e}getTimeStep(){return this.world.timeStep}executeStep(e,t){t.forEach((function(e){e.beforeStep()})),this.world.timeStep=this._useDeltaForWorldStep?e:this._fixedTimeStep,this.world.step(),t.forEach((e=>{e.afterStep(),this._tmpImpostorsArray[e.uniqueId]=e}));let i=this.world.contacts;for(;null!==i;){if(i.touching&&!i.body1.sleeping&&!i.body2.sleeping){i=i.next;continue}const e=this._tmpImpostorsArray[+i.body1.name],t=this._tmpImpostorsArray[+i.body2.name];e&&t?(e.onCollide({body:t.physicsBody,point:null,distance:0,impulse:0,normal:null}),t.onCollide({body:e.physicsBody,point:null,distance:0,impulse:0,normal:null}),i=i.next):i=i.next}}applyImpulse(e,t,i){const r=e.physicsBody.mass;e.physicsBody.applyImpulse(i.scale(this.world.invScale),t.scale(this.world.invScale*r))}applyForce(e,t,i){m.V.Warn("Oimo doesn't support applying force. Using impulse instead."),this.applyImpulse(e,t,i)}generatePhysicsBody(e){if(e.parent)e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());else{if(e.isBodyInitRequired()){const t={name:e.uniqueId,config:[e.getParam("mass")||.001,e.getParam("friction"),e.getParam("restitution")],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:0!==e.getParam("mass"),density:e.getParam("mass"),friction:e.getParam("friction"),restitution:e.getParam("restitution"),world:this.world},i=[e];(e=>{e.getChildMeshes&&e.getChildMeshes().forEach((function(e){e.physicsImpostor&&i.push(e.physicsImpostor)}))})(e.object);const r=e=>Math.max(e,ut.bH),s=new n.PT;i.forEach((i=>{if(!i.object.rotationQuaternion)return;const n=i.object.rotationQuaternion;s.copyFrom(n),i.object.rotationQuaternion.set(0,0,0,1),i.object.computeWorldMatrix(!0);const o=s.toEulerAngles(),a=i.getObjectExtents(),l=57.29577951308232;if(i===e){const i=e.getObjectCenter();e.object.getAbsolutePivotPoint().subtractToRef(i,this._tmpPositionVector),this._tmpPositionVector.divideInPlace(e.object.scaling),t.pos.push(i.x),t.pos.push(i.y),t.pos.push(i.z),t.posShape.push(0,0,0),t.rotShape.push(0,0,0)}else{const e=i.object.position.clone();t.posShape.push(e.x),t.posShape.push(e.y),t.posShape.push(e.z),t.rotShape.push(o.x*l,o.y*l,o.z*l)}switch(i.object.rotationQuaternion.copyFrom(s),i.type){case Xs.ParticleImpostor:m.V.Warn("No Particle support in OIMO.js. using SphereImpostor instead");case Xs.SphereImpostor:{const e=a.x,i=a.y,s=a.z,n=Math.max(r(e),r(i),r(s))/2;t.type.push("sphere"),t.size.push(n),t.size.push(n),t.size.push(n);break}case Xs.CylinderImpostor:{const e=r(a.x)/2,i=r(a.y);t.type.push("cylinder"),t.size.push(e),t.size.push(i),t.size.push(i);break}case Xs.PlaneImpostor:case Xs.BoxImpostor:default:{const e=r(a.x),i=r(a.y),s=r(a.z);t.type.push("box"),t.size.push(e),t.size.push(i),t.size.push(s);break}}i.object.rotationQuaternion=n})),e.physicsBody=this.world.add(t),e.physicsBody.resetQuaternion(s),e.physicsBody.updatePosition(0)}else this._tmpPositionVector.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpPositionVector)}}removePhysicsBody(e){this.world.removeRigidBody(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;const r=e.joint.jointData,s=r.nativeParams||{};let n;const o={body1:t,body2:i,axe1:s.axe1||(r.mainAxis?r.mainAxis.asArray():null),axe2:s.axe2||(r.connectedAxis?r.connectedAxis.asArray():null),pos1:s.pos1||(r.mainPivot?r.mainPivot.asArray():null),pos2:s.pos2||(r.connectedPivot?r.connectedPivot.asArray():null),min:s.min,max:s.max,collision:s.collision||r.collision,spring:s.spring,world:this.world};switch(e.joint.type){case Ws.BallAndSocketJoint:n="jointBall";break;case Ws.SpringJoint:{m.V.Warn("OIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead");const e=r;o.min=e.length||o.min,o.max=Math.max(o.min,o.max)}case Ws.DistanceJoint:n="jointDistance",o.max=r.maxDistance;break;case Ws.PrismaticJoint:n="jointPrisme";break;case Ws.SliderJoint:n="jointSlide";break;case Ws.WheelJoint:n="jointWheel";break;case Ws.HingeJoint:default:n="jointHinge"}o.type=n,e.joint.physicsJoint=this.world.add(o)}removeJoint(e){try{this.world.removeJoint(e.joint.physicsJoint)}catch(e){m.V.Warn(e)}}isSupported(){return void 0!==this.BJSOIMO}setTransformationFromPhysicsBody(e){if(!e.physicsBody.sleeping){if(e.physicsBody.shapes.next){let t=e.physicsBody.shapes;for(;t.next;)t=t.next;e.object.position.set(t.position.x,t.position.y,t.position.z)}else{const t=e.physicsBody.getPosition();e.object.position.set(t.x,t.y,t.z)}if(e.object.rotationQuaternion){const t=e.physicsBody.getQuaternion();e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}}setPhysicsBodyTransformation(e,t,i){const r=e.physicsBody;e.physicsBody.shapes.next||(r.position.set(t.x,t.y,t.z),r.orientation.set(i.x,i.y,i.z,i.w),r.syncShapes(),r.awake())}setLinearVelocity(e,t){e.physicsBody.linearVelocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.linearVelocity;return t?new n.Pq(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new n.Pq(t.x,t.y,t.z):null}setBodyMass(e,t){const i=0===t;e.physicsBody.shapes.density=i?1:t,e.physicsBody.setupMass(i?2:1)}getBodyMass(e){return e.physicsBody.shapes.density}getBodyFriction(e){return e.physicsBody.shapes.friction}setBodyFriction(e,t){e.physicsBody.shapes.friction=t}getBodyRestitution(e){return e.physicsBody.shapes.restitution}setBodyRestitution(e,t){e.physicsBody.shapes.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.awake()}updateDistanceJoint(e,t,i){e.physicsJoint.limitMotor.upperLimit=t,void 0!==i&&(e.physicsJoint.limitMotor.lowerLimit=i)}setMotor(e,t,i,r){void 0!==i?m.V.Warn("OimoJS plugin currently has unexpected behavior when using setMotor with force parameter"):i=1e6,t*=-1;const s=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;s&&s.setMotor(t,i)}setLimit(e,t,i,r){const s=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;s&&s.setLimit(t,void 0===i?-t:i)}syncMeshWithImpostor(e,t){const i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.orientation.x,e.rotationQuaternion.y=i.orientation.y,e.rotationQuaternion.z=i.orientation.z,e.rotationQuaternion.w=i.orientation.w)}getRadius(e){return e.physicsBody.shapes.radius}getBoxSizeToRef(e,t){const i=e.physicsBody.shapes;t.x=2*i.halfWidth,t.y=2*i.halfHeight,t.z=2*i.halfDepth}dispose(){this.world.clear()}raycast(e,t){return m.V.Warn("raycast is not currently supported by the Oimo physics plugin"),this._raycastResult.reset(e,t),this._raycastResult}raycastToRef(e,t,i){m.V.Warn("raycast is not currently supported by the Oimo physics plugin"),i.reset(e,t)}}class Cm{constructor(e=!0,t=Ammo,i=null){this._useDeltaForWorldStep=e,this.bjsAMMO={},this.name="AmmoJSPlugin",this._timeStep=1/60,this._fixedTimeStep=1/60,this._maxSteps=5,this._tmpQuaternion=new n.PT,this._tmpContactCallbackResult=!1,this._tmpContactPoint=new n.Pq,this._tmpContactNormal=new n.Pq,this._tmpVec3=new n.Pq,this._tmpMatrix=new n.uq,"function"!=typeof t?(this.bjsAMMO=t,this.isSupported()?(this._collisionConfiguration=new this.bjsAMMO.btSoftBodyRigidBodyCollisionConfiguration,this._dispatcher=new this.bjsAMMO.btCollisionDispatcher(this._collisionConfiguration),this._overlappingPairCache=i||new this.bjsAMMO.btDbvtBroadphase,this._solver=new this.bjsAMMO.btSequentialImpulseConstraintSolver,this._softBodySolver=new this.bjsAMMO.btDefaultSoftBodySolver,this.world=new this.bjsAMMO.btSoftRigidDynamicsWorld(this._dispatcher,this._overlappingPairCache,this._solver,this._collisionConfiguration,this._softBodySolver),this._tmpAmmoConcreteContactResultCallback=new this.bjsAMMO.ConcreteContactResultCallback,this._tmpAmmoConcreteContactResultCallback.addSingleResult=e=>{const t=(e=this.bjsAMMO.wrapPointer(e,this.bjsAMMO.btManifoldPoint)).getPositionWorldOnA(),i=e.m_normalWorldOnB;this._tmpContactPoint.x=t.x(),this._tmpContactPoint.y=t.y(),this._tmpContactPoint.z=t.z(),this._tmpContactNormal.x=i.x(),this._tmpContactNormal.y=i.y(),this._tmpContactNormal.z=i.z(),this._tmpContactImpulse=e.getAppliedImpulse(),this._tmpContactDistance=e.getDistance(),this._tmpContactCallbackResult=!0},this._raycastResult=new bm,this._tmpAmmoTransform=new this.bjsAMMO.btTransform,this._tmpAmmoTransform.setIdentity(),this._tmpAmmoQuaternion=new this.bjsAMMO.btQuaternion(0,0,0,1),this._tmpAmmoVectorA=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorB=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorC=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorD=new this.bjsAMMO.btVector3(0,0,0)):m.V.Error("AmmoJS is not available. Please make sure you included the js file.")):m.V.Error("AmmoJS is not ready. Please make sure you await Ammo() before using the plugin.")}getPluginVersion(){return 1}setGravity(e){this._tmpAmmoVectorA.setValue(e.x,e.y,e.z),this.world.setGravity(this._tmpAmmoVectorA),this.world.getWorldInfo().set_m_gravity(this._tmpAmmoVectorA)}setTimeStep(e){this._timeStep=e}setFixedTimeStep(e){this._fixedTimeStep=e}setMaxSteps(e){this._maxSteps=e}getTimeStep(){return this._timeStep}_isImpostorInContact(e){return this._tmpContactCallbackResult=!1,this.world.contactTest(e.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_isImpostorPairInContact(e,t){return this._tmpContactCallbackResult=!1,this.world.contactPairTest(e.physicsBody,t.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_stepSimulation(e=1/60,t=10,i=1/60){if(0==t)this.world.stepSimulation(e,0);else for(;t>0&&e>0;)e-i<i?(this.world.stepSimulation(e,0),e=0):(e-=i,this.world.stepSimulation(i,0)),t--}executeStep(e,t){for(const e of t)e.soft||e.beforeStep();this._stepSimulation(this._useDeltaForWorldStep?e:this._timeStep,this._maxSteps,this._fixedTimeStep);for(const e of t)if(e.soft?this._afterSoftStep(e):e.afterStep(),e._onPhysicsCollideCallbacks.length>0&&this._isImpostorInContact(e))for(const t of e._onPhysicsCollideCallbacks)for(const i of t.otherImpostors)(e.physicsBody.isActive()||i.physicsBody.isActive())&&this._isImpostorPairInContact(e,i)&&(e.onCollide({body:i.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}),i.onCollide({body:e.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}))}_afterSoftStep(e){e.type===Xs.RopeImpostor?this._ropeStep(e):this._softbodyOrClothStep(e)}_ropeStep(e){const t=e.physicsBody.get_m_nodes(),i=t.size();let r,s,o,a,l;const h=new Array;for(let e=0;e<i;e++)r=t.at(e),s=r.get_m_x(),o=s.x(),a=s.y(),l=s.z(),h.push(new n.Pq(o,a,l));const c=e.object,u=e.getParam("shape");e._isFromLine?e.object=bn("lines",{points:h,instance:c}):e.object=Nn("ext",{shape:u,path:h,instance:c})}_softbodyOrClothStep(e){const t=e.type===Xs.ClothImpostor?1:-1,i=e.object;let r=i.getVerticesData(Ot.R.PositionKind);r||(r=[]);let s=i.getVerticesData(Ot.R.NormalKind);s||(s=[]);const n=r.length/3,o=e.physicsBody.get_m_nodes();let a,l,h,c,u,d,p,m;for(let e=0;e<n;e++){a=o.at(e),l=a.get_m_x(),h=l.x(),c=l.y(),u=l.z()*t;const i=a.get_m_n();d=i.x(),p=i.y(),m=i.z()*t,r[3*e]=h,r[3*e+1]=c,r[3*e+2]=u,s[3*e]=d,s[3*e+1]=p,s[3*e+2]=m}const f=new ot.P;f.positions=r,f.normals=s,f.uvs=i.getVerticesData(Ot.R.UVKind),f.colors=i.getVerticesData(Ot.R.ColorKind),i&&i.getIndices&&(f.indices=i.getIndices()),f.applyToMesh(i)}applyImpulse(e,t,i){if(e.soft)m.V.Warn("Cannot be applied to a soft body");else{e.physicsBody.activate();const r=this._tmpAmmoVectorA,s=this._tmpAmmoVectorB;e.object&&e.object.getWorldMatrix&&i.subtractInPlace(e.object.getWorldMatrix().getTranslation()),r.setValue(i.x,i.y,i.z),s.setValue(t.x,t.y,t.z),e.physicsBody.applyImpulse(s,r)}}applyForce(e,t,i){if(e.soft)m.V.Warn("Cannot be applied to a soft body");else{e.physicsBody.activate();const r=this._tmpAmmoVectorA,s=this._tmpAmmoVectorB;if(e.object&&e.object.getWorldMatrix){const t=e.object.getWorldMatrix().getTranslation();r.setValue(i.x-t.x,i.y-t.y,i.z-t.z)}else r.setValue(i.x,i.y,i.z);s.setValue(t.x,t.y,t.z),e.physicsBody.applyForce(s,r)}}generatePhysicsBody(e){if(e._pluginData.toDispose=[],e.parent)e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());else if(e.isBodyInitRequired()){const t=this._createShape(e),i=e.getParam("mass");if(e._pluginData.mass=i,e.soft)t.get_m_cfg().set_collisions(17),t.get_m_cfg().set_kDP(e.getParam("damping")),this.bjsAMMO.castObject(t,this.bjsAMMO.btCollisionObject).getCollisionShape().setMargin(e.getParam("margin")),t.setActivationState(Cm._DISABLE_DEACTIVATION_FLAG),this.world.addSoftBody(t,1,-1),e.physicsBody=t,e._pluginData.toDispose.push(t),this.setBodyPressure(e,0),e.type===Xs.SoftbodyImpostor&&this.setBodyPressure(e,e.getParam("pressure")),this.setBodyStiffness(e,e.getParam("stiffness")),this.setBodyVelocityIterations(e,e.getParam("velocityIterations")),this.setBodyPositionIterations(e,e.getParam("positionIterations"));else{const r=new this.bjsAMMO.btVector3(0,0,0),s=new this.bjsAMMO.btTransform;e.object.computeWorldMatrix(!0),s.setIdentity(),0!==i&&t.calculateLocalInertia(i,r),this._tmpAmmoVectorA.setValue(e.object.position.x,e.object.position.y,e.object.position.z),this._tmpAmmoQuaternion.setValue(e.object.rotationQuaternion.x,e.object.rotationQuaternion.y,e.object.rotationQuaternion.z,e.object.rotationQuaternion.w),s.setOrigin(this._tmpAmmoVectorA),s.setRotation(this._tmpAmmoQuaternion);const n=new this.bjsAMMO.btDefaultMotionState(s),o=new this.bjsAMMO.btRigidBodyConstructionInfo(i,n,t,r),a=new this.bjsAMMO.btRigidBody(o);if(0===i&&(a.setCollisionFlags(a.getCollisionFlags()|Cm._KINEMATIC_FLAG),a.setActivationState(Cm._DISABLE_DEACTIVATION_FLAG)),e.type!=Xs.NoImpostor||t.getChildShape||a.setCollisionFlags(a.getCollisionFlags()|Cm._DISABLE_COLLISION_FLAG),e.type!==Xs.MeshImpostor&&e.type!==Xs.NoImpostor){const t=e.object.getBoundingInfo();this._tmpVec3.copyFrom(e.object.getAbsolutePosition()),this._tmpVec3.subtractInPlace(t.boundingBox.centerWorld),this._tmpVec3.x/=e.object.scaling.x,this._tmpVec3.y/=e.object.scaling.y,this._tmpVec3.z/=e.object.scaling.z,e.setDeltaPosition(this._tmpVec3)}const l=e.getParam("group"),h=e.getParam("mask");l&&h?this.world.addRigidBody(a,l,h):this.world.addRigidBody(a),e.physicsBody=a,e._pluginData.toDispose=e._pluginData.toDispose.concat([a,o,n,s,r,t])}this.setBodyRestitution(e,e.getParam("restitution")),this.setBodyFriction(e,e.getParam("friction"))}}removePhysicsBody(e){this.world&&(e.soft?this.world.removeSoftBody(e.physicsBody):this.world.removeRigidBody(e.physicsBody),e._pluginData&&(e._pluginData.toDispose.forEach((e=>{this.bjsAMMO.destroy(e)})),e._pluginData.toDispose=[]))}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;if(e.joint.physicsJoint)return;const r=e.joint.jointData;let s;switch(r.mainPivot||(r.mainPivot=new n.Pq(0,0,0)),r.connectedPivot||(r.connectedPivot=new n.Pq(0,0,0)),e.joint.type){case Ws.DistanceJoint:{const e=r.maxDistance;e&&(r.mainPivot=new n.Pq(0,-e/2,0),r.connectedPivot=new n.Pq(0,e/2,0));const o=this._tmpAmmoVectorA;o.setValue(r.mainPivot.x,r.mainPivot.y,r.mainPivot.z);const a=this._tmpAmmoVectorB;a.setValue(r.connectedPivot.x,r.connectedPivot.y,r.connectedPivot.z),s=new this.bjsAMMO.btPoint2PointConstraint(t,i,o,a);break}case Ws.HingeJoint:{r.mainAxis||(r.mainAxis=new n.Pq(0,0,0)),r.connectedAxis||(r.connectedAxis=new n.Pq(0,0,0));const e=this._tmpAmmoVectorA;e.setValue(r.mainPivot.x,r.mainPivot.y,r.mainPivot.z);const o=this._tmpAmmoVectorB;o.setValue(r.connectedPivot.x,r.connectedPivot.y,r.connectedPivot.z);const a=this._tmpAmmoVectorC;a.setValue(r.mainAxis.x,r.mainAxis.y,r.mainAxis.z);const l=this._tmpAmmoVectorD;l.setValue(r.connectedAxis.x,r.connectedAxis.y,r.connectedAxis.z),s=new this.bjsAMMO.btHingeConstraint(t,i,e,o,a,l);break}case Ws.BallAndSocketJoint:{const e=this._tmpAmmoVectorA;e.setValue(r.mainPivot.x,r.mainPivot.y,r.mainPivot.z);const n=this._tmpAmmoVectorB;n.setValue(r.connectedPivot.x,r.connectedPivot.y,r.connectedPivot.z),s=new this.bjsAMMO.btPoint2PointConstraint(t,i,e,n);break}default:{m.V.Warn("JointType not currently supported by the Ammo plugin, falling back to PhysicsJoint.BallAndSocketJoint");const e=this._tmpAmmoVectorA;e.setValue(r.mainPivot.x,r.mainPivot.y,r.mainPivot.z);const n=this._tmpAmmoVectorB;n.setValue(r.connectedPivot.x,r.connectedPivot.y,r.connectedPivot.z),s=new this.bjsAMMO.btPoint2PointConstraint(t,i,e,n);break}}this.world.addConstraint(s,!e.joint.jointData.collision),e.joint.physicsJoint=s}removeJoint(e){this.world&&this.world.removeConstraint(e.joint.physicsJoint),this.bjsAMMO.destroy(e.joint.physicsJoint)}_addMeshVerts(e,t,i){let r=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let s=i.getIndices();s||(s=[]);let o,a=i.getVerticesData(Ot.R.PositionKind);if(a||(a=[]),t&&t!==i){let e;e=t.rotationQuaternion?t.rotationQuaternion:t.rotation?n.PT.FromEulerAngles(t.rotation.x,t.rotation.y,t.rotation.z):n.PT.Identity();n.uq.Compose(n.Pq.One(),e,t.position).invertToRef(this._tmpMatrix);o=i.computeWorldMatrix(!1).multiply(this._tmpMatrix)}else n.uq.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),o=this._tmpMatrix;const l=s.length/3;for(let t=0;t<l;t++){const i=[];for(let e=0;e<3;e++){let r,l=new n.Pq(a[3*s[3*t+e]+0],a[3*s[3*t+e]+1],a[3*s[3*t+e]+2]);l=n.Pq.TransformCoordinates(l,o),r=0==e?this._tmpAmmoVectorA:1==e?this._tmpAmmoVectorB:this._tmpAmmoVectorC,r.setValue(l.x,l.y,l.z),i.push(r)}e.addTriangle(i[0],i[1],i[2]),r++}i.getChildMeshes().forEach((i=>{r+=this._addMeshVerts(e,t,i)}))}return r}_softVertexData(e){const t=e.object;if(t&&t.getIndices&&t.getWorldMatrix&&t.getChildMeshes){let e=t.getIndices();e||(e=[]);let i=t.getVerticesData(Ot.R.PositionKind);i||(i=[]);let r=t.getVerticesData(Ot.R.NormalKind);r||(r=[]),t.computeWorldMatrix(!1);const s=[],o=[];for(let e=0;e<i.length;e+=3){let a=new n.Pq(i[e],i[e+1],i[e+2]),l=new n.Pq(r[e],r[e+1],r[e+2]);a=n.Pq.TransformCoordinates(a,t.getWorldMatrix()),l=n.Pq.TransformNormal(l,t.getWorldMatrix()),s.push(a.x,a.y,a.z),o.push(l.x,l.y,l.z)}const a=new ot.P;return a.positions=s,a.normals=o,a.uvs=t.getVerticesData(Ot.R.UVKind),a.colors=t.getVerticesData(Ot.R.ColorKind),t&&t.getIndices&&(a.indices=t.getIndices()),a.applyToMesh(t),t.position=n.Pq.Zero(),t.rotationQuaternion=null,t.rotation=n.Pq.Zero(),t.computeWorldMatrix(!0),a}return ot.P.ExtractFromMesh(t)}_createSoftbody(e){const t=e.object;if(t&&t.getIndices){let i=t.getIndices();i||(i=[]);const r=this._softVertexData(e),s=r.positions,o=r.normals;if(null===s||null===o)return new this.bjsAMMO.btCompoundShape;{const e=[],r=[];for(let t=0;t<s.length;t+=3){const i=new n.Pq(s[t],s[t+1],s[t+2]),a=new n.Pq(o[t],o[t+1],o[t+2]);e.push(i.x,i.y,-i.z),r.push(a.x,a.y,-a.z)}const a=(new this.bjsAMMO.btSoftBodyHelpers).CreateFromTriMesh(this.world.getWorldInfo(),e,t.getIndices(),i.length/3,!0),l=s.length/3,h=a.get_m_nodes();let c,u;for(let e=0;e<l;e++)c=h.at(e),u=c.get_m_n(),u.setX(r[3*e]),u.setY(r[3*e+1]),u.setZ(r[3*e+2]);return a}}}_createCloth(e){const t=e.object;if(t&&t.getIndices){let i=t.getIndices();i||(i=[]);const r=this._softVertexData(e),s=r.positions,n=r.normals;if(null===s||null===n)return new this.bjsAMMO.btCompoundShape;{const t=s.length,i=Math.sqrt(t/3);e.segments=i;const r=i-1;this._tmpAmmoVectorA.setValue(s[0],s[1],s[2]),this._tmpAmmoVectorB.setValue(s[3*r],s[3*r+1],s[3*r+2]),this._tmpAmmoVectorD.setValue(s[t-3],s[t-2],s[t-1]),this._tmpAmmoVectorC.setValue(s[t-3-3*r],s[t-2-3*r],s[t-1-3*r]);return(new this.bjsAMMO.btSoftBodyHelpers).CreatePatch(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,this._tmpAmmoVectorC,this._tmpAmmoVectorD,i,i,e.getParam("fixedPoints"),!0)}}}_createRope(e){let t,i;const r=this._softVertexData(e),s=r.positions,n=r.normals;if(null===s||null===n)return new this.bjsAMMO.btCompoundShape;r.applyToMesh(e.object,!0),e._isFromLine=!0;if(0===n.map((e=>e*e)).reduce(((e,t)=>e+t)))t=s.length,i=t/3-1,this._tmpAmmoVectorA.setValue(s[0],s[1],s[2]),this._tmpAmmoVectorB.setValue(s[t-3],s[t-2],s[t-1]);else{e._isFromLine=!1;const r=e.getParam("path");if(null===e.getParam("shape"))return m.V.Warn("No shape available for extruded mesh"),new this.bjsAMMO.btCompoundShape;t=r.length,i=t-1,this._tmpAmmoVectorA.setValue(r[0].x,r[0].y,r[0].z),this._tmpAmmoVectorB.setValue(r[t-1].x,r[t-1].y,r[t-1].z)}e.segments=i;let o=e.getParam("fixedPoints");o=o>3?3:o;const a=(new this.bjsAMMO.btSoftBodyHelpers).CreateRope(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,i-1,o);return a.get_m_cfg().set_collisions(17),a}_createCustom(e){let t=null;return this.onCreateCustomShape&&(t=this.onCreateCustomShape(e)),null==t&&(t=new this.bjsAMMO.btCompoundShape),t}_addHullVerts(e,t,i){let r=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let s=i.getIndices();s||(s=[]);let o=i.getVerticesData(Ot.R.PositionKind);o||(o=[]),i.computeWorldMatrix(!1);const a=s.length/3;for(let t=0;t<a;t++){const a=[];for(let e=0;e<3;e++){let r,l=new n.Pq(o[3*s[3*t+e]+0],o[3*s[3*t+e]+1],o[3*s[3*t+e]+2]);n.uq.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),l=n.Pq.TransformCoordinates(l,this._tmpMatrix),r=0==e?this._tmpAmmoVectorA:1==e?this._tmpAmmoVectorB:this._tmpAmmoVectorC,r.setValue(l.x,l.y,l.z),a.push(r)}e.addPoint(a[0],!0),e.addPoint(a[1],!0),e.addPoint(a[2],!0),r++}i.getChildMeshes().forEach((i=>{r+=this._addHullVerts(e,t,i)}))}return r}_createShape(e,t=!1){const i=e.object;let r;const s=e.getObjectExtents();if(!t){const t=e.object.getChildMeshes?e.object.getChildMeshes(!0):[];r=new this.bjsAMMO.btCompoundShape;let i=0;if(t.forEach((e=>{const t=e.getPhysicsImpostor();if(t){if(t.type==Xs.MeshImpostor)throw"A child MeshImpostor is not supported. Only primitive impostors are supported as children (eg. box or sphere)";const s=this._createShape(t),o=e.parent.getWorldMatrix().clone(),a=new n.Pq;o.decompose(a),this._tmpAmmoTransform.getOrigin().setValue(e.position.x*a.x,e.position.y*a.y,e.position.z*a.z),this._tmpAmmoQuaternion.setValue(e.rotationQuaternion.x,e.rotationQuaternion.y,e.rotationQuaternion.z,e.rotationQuaternion.w),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),r.addChildShape(this._tmpAmmoTransform,s),t.dispose(),i++}})),i>0){if(e.type!=Xs.NoImpostor){const t=this._createShape(e,!0);t&&(this._tmpAmmoTransform.getOrigin().setValue(0,0,0),this._tmpAmmoQuaternion.setValue(0,0,0,1),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),r.addChildShape(this._tmpAmmoTransform,t))}return r}this.bjsAMMO.destroy(r),r=null}switch(e.type){case Xs.SphereImpostor:if((0,yt.WithinEpsilon)(s.x,s.y,1e-4)&&(0,yt.WithinEpsilon)(s.x,s.z,1e-4))r=new this.bjsAMMO.btSphereShape(s.x/2);else{this._tmpAmmoVectorA.setValue(0,0,0);const e=[this._tmpAmmoVectorA],t=[1];r=new this.bjsAMMO.btMultiSphereShape(e,t,1),this._tmpAmmoVectorA.setValue(s.x/2,s.y/2,s.z/2),r.setLocalScaling(this._tmpAmmoVectorA)}break;case Xs.CapsuleImpostor:{const e=s.x/2;r=new this.bjsAMMO.btCapsuleShape(e,s.y-2*e)}break;case Xs.CylinderImpostor:this._tmpAmmoVectorA.setValue(s.x/2,s.y/2,s.z/2),r=new this.bjsAMMO.btCylinderShape(this._tmpAmmoVectorA);break;case Xs.PlaneImpostor:case Xs.BoxImpostor:this._tmpAmmoVectorA.setValue(s.x/2,s.y/2,s.z/2),r=new this.bjsAMMO.btBoxShape(this._tmpAmmoVectorA);break;case Xs.MeshImpostor:if(0==e.getParam("mass")){if(this.onCreateCustomMeshImpostor)r=this.onCreateCustomMeshImpostor(e);else{const t=new this.bjsAMMO.btTriangleMesh;e._pluginData.toDispose.push(t);const s=this._addMeshVerts(t,i,i);r=0==s?new this.bjsAMMO.btCompoundShape:new this.bjsAMMO.btBvhTriangleMeshShape(t)}break}case Xs.ConvexHullImpostor:if(this.onCreateCustomConvexHullImpostor)r=this.onCreateCustomConvexHullImpostor(e);else{const t=new this.bjsAMMO.btConvexHullShape;0==this._addHullVerts(t,i,i)?(e._pluginData.toDispose.push(t),r=new this.bjsAMMO.btCompoundShape):r=t}break;case Xs.NoImpostor:r=new this.bjsAMMO.btSphereShape(s.x/2);break;case Xs.CustomImpostor:r=this._createCustom(e);break;case Xs.SoftbodyImpostor:r=this._createSoftbody(e);break;case Xs.ClothImpostor:r=this._createCloth(e);break;case Xs.RopeImpostor:r=this._createRope(e);break;default:m.V.Warn("The impostor type is not currently supported by the ammo plugin.")}return r}setTransformationFromPhysicsBody(e){e.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),e.object.position.set(this._tmpAmmoTransform.getOrigin().x(),this._tmpAmmoTransform.getOrigin().y(),this._tmpAmmoTransform.getOrigin().z()),e.object.rotationQuaternion?e.object.rotationQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()):e.object.rotation&&(this._tmpQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()),this._tmpQuaternion.toEulerAnglesToRef(e.object.rotation))}setPhysicsBodyTransformation(e,t,i){const r=e.physicsBody.getWorldTransform();if(Math.abs(r.getOrigin().x()-t.x)>ut.bH||Math.abs(r.getOrigin().y()-t.y)>ut.bH||Math.abs(r.getOrigin().z()-t.z)>ut.bH||Math.abs(r.getRotation().x()-i.x)>ut.bH||Math.abs(r.getRotation().y()-i.y)>ut.bH||Math.abs(r.getRotation().z()-i.z)>ut.bH||Math.abs(r.getRotation().w()-i.w)>ut.bH)if(this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),r.setOrigin(this._tmpAmmoVectorA),this._tmpAmmoQuaternion.setValue(i.x,i.y,i.z,i.w),r.setRotation(this._tmpAmmoQuaternion),e.physicsBody.setWorldTransform(r),0==e.mass){const t=e.physicsBody.getMotionState();t&&t.setWorldTransform(r)}else e.physicsBody.activate()}isSupported(){return void 0!==this.bjsAMMO}setLinearVelocity(e,t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),e.soft?e.physicsBody.linearVelocity(this._tmpAmmoVectorA):e.physicsBody.setLinearVelocity(this._tmpAmmoVectorA)}setAngularVelocity(e,t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),e.soft?e.physicsBody.angularVelocity(this._tmpAmmoVectorA):e.physicsBody.setAngularVelocity(this._tmpAmmoVectorA)}getLinearVelocity(e){let t;if(t=e.soft?e.physicsBody.linearVelocity():e.physicsBody.getLinearVelocity(),!t)return null;const i=new n.Pq(t.x(),t.y(),t.z());return this.bjsAMMO.destroy(t),i}getAngularVelocity(e){let t;if(t=e.soft?e.physicsBody.angularVelocity():e.physicsBody.getAngularVelocity(),!t)return null;const i=new n.Pq(t.x(),t.y(),t.z());return this.bjsAMMO.destroy(t),i}setBodyMass(e,t){e.soft?e.physicsBody.setTotalMass(t,!1):e.physicsBody.setMassProps(t),e._pluginData.mass=t}getBodyMass(e){return e._pluginData.mass||0}getBodyFriction(e){return e._pluginData.friction||0}setBodyFriction(e,t){e.soft?e.physicsBody.get_m_cfg().set_kDF(t):e.physicsBody.setFriction(t),e._pluginData.friction=t}getBodyRestitution(e){return e._pluginData.restitution||0}setBodyRestitution(e,t){e.physicsBody.setRestitution(t),e._pluginData.restitution=t}getBodyPressure(e){return e.soft?e._pluginData.pressure||0:(m.V.Warn("Pressure is not a property of a rigid body"),0)}setBodyPressure(e,t){e.soft?e.type===Xs.SoftbodyImpostor?(e.physicsBody.get_m_cfg().set_kPR(t),e._pluginData.pressure=t):(e.physicsBody.get_m_cfg().set_kPR(0),e._pluginData.pressure=0):m.V.Warn("Pressure can only be applied to a softbody")}getBodyStiffness(e){return e.soft?e._pluginData.stiffness||0:(m.V.Warn("Stiffness is not a property of a rigid body"),0)}setBodyStiffness(e,t){e.soft?(t=(t=t<0?0:t)>1?1:t,e.physicsBody.get_m_materials().at(0).set_m_kLST(t),e._pluginData.stiffness=t):m.V.Warn("Stiffness cannot be applied to a rigid body")}getBodyVelocityIterations(e){return e.soft?e._pluginData.velocityIterations||0:(m.V.Warn("Velocity iterations is not a property of a rigid body"),0)}setBodyVelocityIterations(e,t){e.soft?(t=t<0?0:t,e.physicsBody.get_m_cfg().set_viterations(t),e._pluginData.velocityIterations=t):m.V.Warn("Velocity iterations cannot be applied to a rigid body")}getBodyPositionIterations(e){return e.soft?e._pluginData.positionIterations||0:(m.V.Warn("Position iterations is not a property of a rigid body"),0)}setBodyPositionIterations(e,t){e.soft?(t=t<0?0:t,e.physicsBody.get_m_cfg().set_piterations(t),e._pluginData.positionIterations=t):m.V.Warn("Position iterations cannot be applied to a rigid body")}appendAnchor(e,t,i,r,s=1,n=!1){const o=e.segments,a=Math.round((o-1)*i)+o*(o-1-Math.round((o-1)*r));e.physicsBody.appendAnchor(a,t.physicsBody,n,s)}appendHook(e,t,i,r=1,s=!1){const n=Math.round(e.segments*i);e.physicsBody.appendAnchor(n,t.physicsBody,s,r)}sleepBody(e){e.physicsBody.forceActivationState(0)}wakeUpBody(e){e.physicsBody.activate()}updateDistanceJoint(){m.V.Warn("updateDistanceJoint is not currently supported by the Ammo physics plugin")}setMotor(e,t,i){e.physicsJoint.enableAngularMotor(!0,t,i)}setLimit(){m.V.Warn("setLimit is not currently supported by the Ammo physics plugin")}syncMeshWithImpostor(e,t){t.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),e.position.x=this._tmpAmmoTransform.getOrigin().x(),e.position.y=this._tmpAmmoTransform.getOrigin().y(),e.position.z=this._tmpAmmoTransform.getOrigin().z(),e.rotationQuaternion&&(e.rotationQuaternion.x=this._tmpAmmoTransform.getRotation().x(),e.rotationQuaternion.y=this._tmpAmmoTransform.getRotation().y(),e.rotationQuaternion.z=this._tmpAmmoTransform.getRotation().z(),e.rotationQuaternion.w=this._tmpAmmoTransform.getRotation().w())}getRadius(e){return e.getObjectExtents().x/2}getBoxSizeToRef(e,t){const i=e.getObjectExtents();t.x=i.x,t.y=i.y,t.z=i.z}dispose(){this.bjsAMMO.destroy(this.world),this.bjsAMMO.destroy(this._softBodySolver),this.bjsAMMO.destroy(this._solver),this.bjsAMMO.destroy(this._overlappingPairCache),this.bjsAMMO.destroy(this._dispatcher),this.bjsAMMO.destroy(this._collisionConfiguration),this.bjsAMMO.destroy(this._tmpAmmoVectorA),this.bjsAMMO.destroy(this._tmpAmmoVectorB),this.bjsAMMO.destroy(this._tmpAmmoVectorC),this.bjsAMMO.destroy(this._tmpAmmoVectorD),this.bjsAMMO.destroy(this._tmpAmmoTransform),this.bjsAMMO.destroy(this._tmpAmmoQuaternion),this.bjsAMMO.destroy(this._tmpAmmoConcreteContactResultCallback),this.world=null}raycast(e,t){return this.raycastToRef(e,t,this._raycastResult),this._raycastResult}raycastToRef(e,t,i){this._tmpAmmoVectorRCA=new this.bjsAMMO.btVector3(e.x,e.y,e.z),this._tmpAmmoVectorRCB=new this.bjsAMMO.btVector3(t.x,t.y,t.z);const r=new this.bjsAMMO.ClosestRayResultCallback(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB);this.world.rayTest(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB,r),i.reset(e,t),r.hasHit()&&(i.setHitData({x:r.get_m_hitNormalWorld().x(),y:r.get_m_hitNormalWorld().y(),z:r.get_m_hitNormalWorld().z()},{x:r.get_m_hitPointWorld().x(),y:r.get_m_hitPointWorld().y(),z:r.get_m_hitPointWorld().z()}),i.calculateHitDistance()),this.bjsAMMO.destroy(r),this.bjsAMMO.destroy(this._tmpAmmoVectorRCA),this.bjsAMMO.destroy(this._tmpAmmoVectorRCB)}}Cm._DISABLE_COLLISION_FLAG=4,Cm._KINEMATIC_FLAG=2,Cm._DISABLE_DEACTIVATION_FLAG=4,it.Z.prototype.removeReflectionProbe=function(e){if(!this.reflectionProbes)return-1;const t=this.reflectionProbes.indexOf(e);return-1!==t&&this.reflectionProbes.splice(t,1),t},it.Z.prototype.addReflectionProbe=function(e){this.reflectionProbes||(this.reflectionProbes=[]),this.reflectionProbes.push(e)};class Em{constructor(e,t,i,r=!0,s=!1,o=!1){if(this.name=e,this._viewMatrix=n.uq.Identity(),this._target=n.Pq.Zero(),this._add=n.Pq.Zero(),this._invertYAxis=!1,this.position=n.Pq.Zero(),this.metadata=null,this._parentContainer=null,this._scene=i,i.getEngine().supportsUniformBuffers){this._sceneUBOs=[];for(let t=0;t<6;++t)this._sceneUBOs.push(i.createSceneUniformBuffer(`Scene for Reflection Probe (name "${e}") face #${t}`))}this._scene.reflectionProbes||(this._scene.reflectionProbes=[]),this._scene.reflectionProbes.push(this);let a=0;if(s){const e=this._scene.getEngine().getCaps();e.textureHalfFloatRender?a=2:e.textureFloatRender&&(a=1)}this._renderTargetTexture=new cr.$(e,t,i,r,!0,a,!0),this._renderTargetTexture.gammaSpace=!o,this._renderTargetTexture.invertZ=i.useRightHandedSystem;const l=i.getEngine().useReverseDepthBuffer;let h;this._renderTargetTexture.onBeforeRenderObservable.add((e=>{switch(this._sceneUBOs&&(i.setSceneUniformBuffer(this._sceneUBOs[e]),i.getSceneUniformBuffer().unbindEffect()),e){case 0:this._add.copyFromFloats(1,0,0);break;case 1:this._add.copyFromFloats(-1,0,0);break;case 2:this._add.copyFromFloats(0,this._invertYAxis?1:-1,0);break;case 3:this._add.copyFromFloats(0,this._invertYAxis?-1:1,0);break;case 4:this._add.copyFromFloats(0,0,i.useRightHandedSystem?-1:1);break;case 5:this._add.copyFromFloats(0,0,i.useRightHandedSystem?1:-1)}this._attachedMesh&&this.position.copyFrom(this._attachedMesh.getAbsolutePosition()),this.position.addToRef(this._add,this._target);const t=i.useRightHandedSystem?n.uq.LookAtRHToRef:n.uq.LookAtLHToRef,r=i.useRightHandedSystem?n.uq.PerspectiveFovRH:n.uq.PerspectiveFovLH;t(this.position,this._target,n.Pq.Up(),this._viewMatrix),i.activeCamera&&(this._projectionMatrix=r(Math.PI/2,1,l?i.activeCamera.maxZ:i.activeCamera.minZ,l?i.activeCamera.minZ:i.activeCamera.maxZ,this._scene.getEngine().isNDCHalfZRange),i.setTransformMatrix(this._viewMatrix,this._projectionMatrix),i.activeCamera.isRigCamera&&!this._renderTargetTexture.activeCamera&&(this._renderTargetTexture.activeCamera=i.activeCamera.rigParent||null)),i._forcedViewPosition=this.position})),this._renderTargetTexture.onBeforeBindObservable.add((()=>{this._currentSceneUBO=i.getSceneUniformBuffer(),i.getEngine()._debugPushGroup?.(`reflection probe generation for ${e}`,1),h=this._scene.imageProcessingConfiguration.applyByPostProcess,o&&(i.imageProcessingConfiguration.applyByPostProcess=!0)})),this._renderTargetTexture.onAfterUnbindObservable.add((()=>{i.imageProcessingConfiguration.applyByPostProcess=h,i._forcedViewPosition=null,this._sceneUBOs&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(!0),i.getEngine()._debugPopGroup?.(1)}))}get samples(){return this._renderTargetTexture.samples}set samples(e){this._renderTargetTexture.samples=e}get refreshRate(){return this._renderTargetTexture.refreshRate}set refreshRate(e){this._renderTargetTexture.refreshRate=e}getScene(){return this._scene}get cubeTexture(){return this._renderTargetTexture}get renderList(){return this._renderTargetTexture.renderList}set renderList(e){this._renderTargetTexture.renderList=e}attachToMesh(e){this._attachedMesh=e}setRenderingAutoClearDepthStencil(e,t){this._renderTargetTexture.setRenderingAutoClearDepthStencil(e,t)}dispose(){const e=this._scene.reflectionProbes.indexOf(this);if(-1!==e&&this._scene.reflectionProbes.splice(e,1),this._parentContainer){const e=this._parentContainer.reflectionProbes.indexOf(this);e>-1&&this._parentContainer.reflectionProbes.splice(e,1),this._parentContainer=null}if(this._renderTargetTexture&&(this._renderTargetTexture.dispose(),this._renderTargetTexture=null),this._sceneUBOs){for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}toString(e){let t="Name: "+this.name;return e&&(t+=", position: "+this.position.toString(),this._attachedMesh&&(t+=", attached mesh: "+this._attachedMesh.name)),t}getClassName(){return"ReflectionProbe"}serialize(){const e=Ue.p.Serialize(this,this._renderTargetTexture.serialize());return e.isReflectionProbe=!0,e.metadata=this.metadata,e}static Parse(e,t,i){let r=null;if(t.reflectionProbes)for(let i=0;i<t.reflectionProbes.length;i++){const s=t.reflectionProbes[i];if(s.name===e.name){r=s;break}}return r=Ue.p.Parse((()=>r||new Em(e.name,e.renderTargetSize,t,e._generateMipMaps)),e,t,i),r.cubeTexture._waitingRenderList=e.renderList,e._attachedMesh&&r.attachToMesh(t.getMeshById(e._attachedMesh)),e.metadata&&(r.metadata=e.metadata),r}}(0,Ge.Cg)([(0,ze.xG)()],Em.prototype,"_attachedMesh",void 0),(0,Ge.Cg)([(0,ze.P_)()],Em.prototype,"position",void 0);class Am{get animationStarted(){return this._animationStarted}get fromIndex(){return this._fromIndex}get toIndex(){return this._toIndex}get loopAnimation(){return this._loopAnimation}get delay(){return Math.max(this._delay,1)}constructor(){this.width=1,this.height=1,this.angle=0,this.invertU=!1,this.invertV=!1,this.isVisible=!0,this._animationStarted=!1,this._loopAnimation=!1,this._fromIndex=0,this._toIndex=0,this._delay=0,this._direction=1,this._time=0,this._onBaseAnimationEnd=null,this.position={x:1,y:1,z:1},this.color={r:1,g:1,b:1,a:1}}playAnimation(e,t,i,r,s){this._fromIndex=e,this._toIndex=t,this._loopAnimation=i,this._delay=r||1,this._animationStarted=!0,this._onBaseAnimationEnd=s,e<t?this._direction=1:(this._direction=-1,this._toIndex=e,this._fromIndex=t),this.cellIndex=e,this._time=0}stopAnimation(){this._animationStarted=!1}_animate(e){this._animationStarted&&(this._time+=e,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,(this._direction>0&&this.cellIndex>this._toIndex||this._direction<0&&this.cellIndex<this._fromIndex)&&(this._loopAnimation?this.cellIndex=this._direction>0?this._fromIndex:this._toIndex:(this.cellIndex=this._toIndex,this._animationStarted=!1,this._onBaseAnimationEnd&&this._onBaseAnimationEnd()))))}}class Im extends Am{get size(){return this.width}set size(e){this.width=e,this.height=e}get manager(){return this._manager}constructor(e,t){super(),this.name=e,this.animations=new Array,this.isPickable=!1,this.useAlphaForPicking=!1,this.onDisposeObservable=new s.cP,this._onAnimationEnd=null,this._endAnimation=()=>{this._onAnimationEnd&&this._onAnimationEnd(),this.disposeWhenFinishedAnimating&&this.dispose()},this.color=new o.ov(1,1,1,1),this.position=n.Pq.Zero(),this._manager=t,this._manager.sprites.push(this),this.uniqueId=this._manager.scene.getUniqueId()}getClassName(){return"Sprite"}get fromIndex(){return this._fromIndex}set fromIndex(e){this.playAnimation(e,this._toIndex,this._loopAnimation,this._delay,this._onAnimationEnd)}get toIndex(){return this._toIndex}set toIndex(e){this.playAnimation(this._fromIndex,e,this._loopAnimation,this._delay,this._onAnimationEnd)}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){this.playAnimation(this._fromIndex,this._toIndex,e,this._delay,this._onAnimationEnd)}get delay(){return Math.max(this._delay,1)}set delay(e){this.playAnimation(this._fromIndex,this._toIndex,this._loopAnimation,e,this._onAnimationEnd)}playAnimation(e,t,i,r,s=null){this._onAnimationEnd=s,super.playAnimation(e,t,i,r,this._endAnimation)}dispose(){for(let e=0;e<this._manager.sprites.length;e++)this._manager.sprites[e]==this&&this._manager.sprites.splice(e,1);this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}serialize(){const e={};return e.name=this.name,e.position=this.position.asArray(),e.color=this.color.asArray(),e.width=this.width,e.height=this.height,e.angle=this.angle,e.cellIndex=this.cellIndex,e.cellRef=this.cellRef,e.invertU=this.invertU,e.invertV=this.invertV,e.disposeWhenFinishedAnimating=this.disposeWhenFinishedAnimating,e.isPickable=this.isPickable,e.isVisible=this.isVisible,e.useAlphaForPicking=this.useAlphaForPicking,e.animationStarted=this.animationStarted,e.fromIndex=this.fromIndex,e.toIndex=this.toIndex,e.loopAnimation=this.loopAnimation,e.delay=this.delay,e}static Parse(e,t){const i=new Im(e.name,t);return i.position=n.Pq.FromArray(e.position),i.color=o.ov.FromArray(e.color),i.width=e.width,i.height=e.height,i.angle=e.angle,i.cellIndex=e.cellIndex,i.cellRef=e.cellRef,i.invertU=e.invertU,i.invertV=e.invertV,i.disposeWhenFinishedAnimating=e.disposeWhenFinishedAnimating,i.isPickable=e.isPickable,i.isVisible=e.isVisible,i.useAlphaForPicking=e.useAlphaForPicking,i._fromIndex=e.fromIndex,i._toIndex=e.toIndex,i._loopAnimation=e.loopAnimation,i._delay=e.delay,e.animationStarted&&i.playAnimation(i.fromIndex,i.toIndex,i.loopAnimation,i.delay),i}}var Rm=i(48086);it.Z.prototype._internalPickSprites=function(e,t,i,r){if(!Xr.G)return null;let s=null;if(!r){if(!this.activeCamera)return null;r=this.activeCamera}if(this.spriteManagers&&this.spriteManagers.length>0)for(let n=0;n<this.spriteManagers.length;n++){const o=this.spriteManagers[n];if(!o.isPickable)continue;const a=o.intersects(e,r,t,i);if(a&&a.hit&&((i||null==s||!(a.distance>=s.distance))&&(s=a,i)))break}return s||new Xr.G},it.Z.prototype._internalMultiPickSprites=function(e,t,i){if(!Xr.G)return null;let r=[];if(!i){if(!this.activeCamera)return null;i=this.activeCamera}if(this.spriteManagers&&this.spriteManagers.length>0)for(let s=0;s<this.spriteManagers.length;s++){const n=this.spriteManagers[s];if(!n.isPickable)continue;const o=n.multiIntersects(e,i,t);null!==o&&(r=r.concat(o))}return r},it.Z.prototype.pickSprite=function(e,t,i,r,s){if(!this._tempSpritePickingRay)return null;(0,Rm.oZ)(this,e,t,this._tempSpritePickingRay,s);const n=this._internalPickSprites(this._tempSpritePickingRay,i,r,s);return n&&(n.ray=(0,Rm.AU)(this,e,t,s)),n},it.Z.prototype.pickSpriteWithRay=function(e,t,i,r){if(!this._tempSpritePickingRay)return null;if(!r){if(!this.activeCamera)return null;r=this.activeCamera}Rm.Rl.TransformToRef(e,r.getViewMatrix(),this._tempSpritePickingRay);const s=this._internalPickSprites(this._tempSpritePickingRay,t,i,r);return s&&(s.ray=e),s},it.Z.prototype.multiPickSprite=function(e,t,i,r){return(0,Rm.oZ)(this,e,t,this._tempSpritePickingRay,r),this._internalMultiPickSprites(this._tempSpritePickingRay,i,r)},it.Z.prototype.multiPickSpriteWithRay=function(e,t,i){if(!this._tempSpritePickingRay)return null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}return Rm.Rl.TransformToRef(e,i.getViewMatrix(),this._tempSpritePickingRay),this._internalMultiPickSprites(this._tempSpritePickingRay,t,i)},it.Z.prototype.setPointerOverSprite=function(e){this._pointerOverSprite!==e&&(this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(10,h.X.CreateNewFromSprite(this._pointerOverSprite,this)),this._pointerOverSprite=e,this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(9,h.X.CreateNewFromSprite(this._pointerOverSprite,this)))},it.Z.prototype.getPointerOverSprite=function(){return this._pointerOverSprite};class Mm{constructor(e){this.name=Ei.v.NAME_SPRITE,this.scene=e,this.scene.spriteManagers=[],this.scene._tempSpritePickingRay=Rm.Rl?Rm.Rl.Zero():null,this.scene.onBeforeSpritesRenderingObservable=new s.cP,this.scene.onAfterSpritesRenderingObservable=new s.cP,this._spritePredicate=e=>!!e.actionManager&&(e.isPickable&&e.actionManager.hasPointerTriggers)}register(){this.scene._pointerMoveStage.registerStep(Ei.v.STEP_POINTERMOVE_SPRITE,this,this._pointerMove),this.scene._pointerDownStage.registerStep(Ei.v.STEP_POINTERDOWN_SPRITE,this,this._pointerDown),this.scene._pointerUpStage.registerStep(Ei.v.STEP_POINTERUP_SPRITE,this,this._pointerUp)}rebuild(){}dispose(){this.scene.onBeforeSpritesRenderingObservable.clear(),this.scene.onAfterSpritesRenderingObservable.clear();const e=this.scene.spriteManagers;if(e)for(;e.length;)e[0].dispose()}_pickSpriteButKeepRay(e,t,i,r,s){const n=this.scene.pickSprite(t,i,this._spritePredicate,r,s);return n&&(n.ray=e?e.ray:null),n}_pointerMove(e,t,i,r,s){const n=this.scene;return r?n.setPointerOverSprite(null):(i=this._pickSpriteButKeepRay(i,e,t,!1,n.cameraToUseForPointers||void 0))&&i.hit&&i.pickedSprite?(n.setPointerOverSprite(i.pickedSprite),!n.doNotHandleCursors&&s&&(n._pointerOverSprite&&n._pointerOverSprite.actionManager&&n._pointerOverSprite.actionManager.hoverCursor?s.style.cursor=n._pointerOverSprite.actionManager.hoverCursor:s.style.cursor=n.hoverCursor)):n.setPointerOverSprite(null),i}_pointerDown(e,t,i,r){const s=this.scene;if(s._pickedDownSprite=null,s.spriteManagers&&s.spriteManagers.length>0&&(i=s.pickSprite(e,t,this._spritePredicate,!1,s.cameraToUseForPointers||void 0))&&i.hit&&i.pickedSprite&&i.pickedSprite.actionManager){switch(s._pickedDownSprite=i.pickedSprite,r.button){case 0:i.pickedSprite.actionManager.processTrigger(2,h.X.CreateNewFromSprite(i.pickedSprite,s,r));break;case 1:i.pickedSprite.actionManager.processTrigger(4,h.X.CreateNewFromSprite(i.pickedSprite,s,r));break;case 2:i.pickedSprite.actionManager.processTrigger(3,h.X.CreateNewFromSprite(i.pickedSprite,s,r))}i.pickedSprite.actionManager&&i.pickedSprite.actionManager.processTrigger(5,h.X.CreateNewFromSprite(i.pickedSprite,s,r))}return i}_pointerUp(e,t,i,r,s){const n=this.scene;if(n.spriteManagers&&n.spriteManagers.length>0){const i=n.pickSprite(e,t,this._spritePredicate,!1,n.cameraToUseForPointers||void 0);i&&(i.hit&&i.pickedSprite&&i.pickedSprite.actionManager&&(i.pickedSprite.actionManager.processTrigger(7,h.X.CreateNewFromSprite(i.pickedSprite,n,r)),i.pickedSprite.actionManager&&(this.scene._inputManager._isPointerSwiping()||i.pickedSprite.actionManager.processTrigger(1,h.X.CreateNewFromSprite(i.pickedSprite,n,r)),s&&i.pickedSprite.actionManager.processTrigger(6,h.X.CreateNewFromSprite(i.pickedSprite,n,r)))),n._pickedDownSprite&&n._pickedDownSprite.actionManager&&n._pickedDownSprite!==i.pickedSprite&&n._pickedDownSprite.actionManager.processTrigger(16,h.X.CreateNewFromSprite(n._pickedDownSprite,n,r)))}return i}}class Dm{get fogEnabled(){return this._fogEnabled}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this._createEffects())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){const t=!!this._scene?.getEngine().getCaps().fragmentDepthSupported;e&&!t&&m.V.Warn("Logarithmic depth has been requested for a sprite renderer on a device that doesn't support it."),this._useLogarithmicDepth=e&&t,this._createEffects()}get capacity(){return this._capacity}get pixelPerfect(){return this._pixelPerfect}set pixelPerfect(e){this._pixelPerfect!==e&&(this._pixelPerfect=e,this._createEffects())}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i=.01,r=null,s){this.blendMode=2,this.autoResetAlpha=!0,this.disableDepthWrite=!1,this._fogEnabled=!0,this._pixelPerfect=!1,this._shaderLanguage=0,this._useVAO=!1,this._useInstancing=!1,this._vertexBuffers={},this._isDisposed=!1,this._shadersLoaded=!1,this._pixelPerfect=s?.pixelPerfect??!1,this._capacity=t,this._epsilon=i,this._engine=e,this._useInstancing=e.getCaps().instancedArrays&&e._features.supportSpriteInstancing,this._useVAO=e.getCaps().vertexArrayObject&&!e.disableVertexArrayObjects,this._scene=r,this._useInstancing||this._buildIndexBuffer(),this._vertexBufferSize=this._useInstancing?16:18,this._vertexData=new Float32Array(t*this._vertexBufferSize*(this._useInstancing?1:4)),this._buffer=new Ot.h(e,this._vertexData,!0,this._vertexBufferSize);const n=this._buffer.createVertexBuffer(Ot.R.PositionKind,0,4,this._vertexBufferSize,this._useInstancing),o=this._buffer.createVertexBuffer("options",4,2,this._vertexBufferSize,this._useInstancing);let a,l=6;if(this._useInstancing){const t=new Float32Array([this._epsilon,this._epsilon,1-this._epsilon,this._epsilon,this._epsilon,1-this._epsilon,1-this._epsilon,1-this._epsilon]);this._spriteBuffer=new Ot.h(e,t,!1,2),a=this._spriteBuffer.createVertexBuffer("offsets",0,2)}else a=this._buffer.createVertexBuffer("offsets",l,2,this._vertexBufferSize,this._useInstancing),l+=2;const h=this._buffer.createVertexBuffer("inverts",l,2,this._vertexBufferSize,this._useInstancing),c=this._buffer.createVertexBuffer("cellInfo",l+2,4,this._vertexBufferSize,this._useInstancing),u=this._buffer.createVertexBuffer(Ot.R.ColorKind,l+6,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[Ot.R.PositionKind]=n,this._vertexBuffers.options=o,this._vertexBuffers.offsets=a,this._vertexBuffers.inverts=h,this._vertexBuffers.cellInfo=c,this._vertexBuffers[Ot.R.ColorKind]=u,this._initShaderSourceAsync()}async _initShaderSourceAsync(){this._engine.isWebGPU&&!Dm.ForceGLSL?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,24448)),Promise.resolve().then(i.bind(i,62843))])):await Promise.all([Promise.resolve().then(i.bind(i,79831)),Promise.resolve().then(i.bind(i,87554))]),this._shadersLoaded=!0,this._createEffects()}_createEffects(){if(this._isDisposed||!this._shadersLoaded)return;this._drawWrapperBase?.dispose(),this._drawWrapperDepth?.dispose(),this._drawWrapperBase=new Ah.E(this._engine),this._drawWrapperDepth=new Ah.E(this._engine,!1),this._drawWrapperBase.drawContext&&(this._drawWrapperBase.drawContext.useInstancing=this._useInstancing),this._drawWrapperDepth.drawContext&&(this._drawWrapperDepth.drawContext.useInstancing=this._useInstancing);let e="";this._pixelPerfect&&(e+="#define PIXEL_PERFECT\n"),this._scene&&this._scene.fogEnabled&&0!==this._scene.fogMode&&this._fogEnabled&&(e+="#define FOG\n"),this._useLogarithmicDepth&&(e+="#define LOGARITHMICDEPTH\n"),this._drawWrapperBase.effect=this._engine.createEffect("sprites",[Ot.R.PositionKind,"options","offsets","inverts","cellInfo",Ot.R.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor","logarithmicDepthConstant"],["diffuseSampler"],e,void 0,void 0,void 0,void 0,this._shaderLanguage),this._drawWrapperDepth.effect=this._drawWrapperBase.effect,this._drawWrapperBase.effect._refCount++,this._drawWrapperDepth.materialContext=this._drawWrapperBase.materialContext}render(e,t,i,r,s=null){if(!(this._shadersLoaded&&this.texture&&this.texture.isReady()&&e.length))return;const n=this._drawWrapperBase,o=this._drawWrapperDepth,a=this.fogEnabled&&this._scene&&this._scene.fogEnabled&&0!==this._scene.fogMode,l=n.effect;if(!l.isReady())return;const h=this._engine,c=!(!this._scene||!this._scene.useRightHandedSystem),u=Math.min(this._capacity,e.length);let d=0,p=!0;for(let i=0;i<u;i++){const r=e[i];if(!r||!r.isVisible)continue;p=!1,r._animate(t);const n=this.texture.getBaseSize();this._appendSpriteVertex(d++,r,0,0,n,c,s),this._useInstancing||(this._appendSpriteVertex(d++,r,1,0,n,c,s),this._appendSpriteVertex(d++,r,1,1,n,c,s),this._appendSpriteVertex(d++,r,0,1,n,c,s))}if(p)return;this._buffer.update(this._vertexData);const m=!!h.depthCullingState.cull,f=h.depthCullingState.zOffset,_=h.depthCullingState.zOffsetUnits;if(h.setState(m,f,!1,!1,void 0,void 0,_),h.enableEffect(n),l.setTexture("diffuseSampler",this.texture),l.setMatrix("view",i),l.setMatrix("projection",r),a){const e=this._scene;l.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),l.setColor3("vFogColor",e.fogColor)}this.useLogarithmicDepth&&this._scene&&(0,ts.DL)(n.defines,l,this._scene),this._useVAO?(this._vertexArrayObject||(this._vertexArrayObject=h.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,l)),h.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):h.bindBuffers(this._vertexBuffers,this._indexBuffer,l),h.depthCullingState.depthFunc=h.useReverseDepthBuffer?518:515,this.disableDepthWrite||(l.setBool("alphaTest",!0),h.setColorWrite(!1),h.enableEffect(o),this._useInstancing?h.drawArraysType(7,0,4,d):h.drawElementsType(0,0,d/4*6),h.enableEffect(n),h.setColorWrite(!0),l.setBool("alphaTest",!1)),h.setAlphaMode(this.blendMode),this._useInstancing?h.drawArraysType(7,0,4,d):h.drawElementsType(0,0,d/4*6),this.autoResetAlpha&&h.setAlphaMode(0),c&&this._scene.getEngine().setState(m,f,!1,!0,void 0,void 0,_),h.unbindInstanceAttributes()}_appendSpriteVertex(e,t,i,r,s,n,o){let a=e*this._vertexBufferSize;if(0===i?i=this._epsilon:1===i&&(i=1-this._epsilon),0===r?r=this._epsilon:1===r&&(r=1-this._epsilon),o)o(t,s);else{t.cellIndex||(t.cellIndex=0);const e=s.width/this.cellWidth,i=t.cellIndex/e|0;t._xOffset=(t.cellIndex-i*e)*this.cellWidth/s.width,t._yOffset=i*this.cellHeight/s.height,t._xSize=this.cellWidth,t._ySize=this.cellHeight}this._vertexData[a]=t.position.x,this._vertexData[a+1]=t.position.y,this._vertexData[a+2]=t.position.z,this._vertexData[a+3]=t.angle,this._vertexData[a+4]=t.width,this._vertexData[a+5]=t.height,this._useInstancing?a-=2:(this._vertexData[a+6]=i,this._vertexData[a+7]=r),this._vertexData[a+8]=n?t.invertU?0:1:t.invertU?1:0,this._vertexData[a+9]=t.invertV?1:0,this._vertexData[a+10]=t._xOffset,this._vertexData[a+11]=t._yOffset,this._vertexData[a+12]=t._xSize/s.width,this._vertexData[a+13]=t._ySize/s.height,this._vertexData[a+14]=t.color.r,this._vertexData[a+15]=t.color.g,this._vertexData[a+16]=t.color.b,this._vertexData[a+17]=t.color.a}_buildIndexBuffer(){const e=[];let t=0;for(let i=0;i<this._capacity;i++)e.push(t),e.push(t+1),e.push(t+2),e.push(t),e.push(t+2),e.push(t+3),t+=4;this._indexBuffer=this._engine.createIndexBuffer(e)}rebuild(){this._indexBuffer&&this._buildIndexBuffer(),this._useVAO&&(this._vertexArrayObject=void 0),this._buffer._rebuild();for(const e in this._vertexBuffers){this._vertexBuffers[e]._rebuild()}this._spriteBuffer?._rebuild()}dispose(){this._buffer&&(this._buffer.dispose(),this._buffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this.texture&&(this.texture.dispose(),this.texture=null),this._drawWrapperBase?.dispose(),this._drawWrapperDepth?.dispose(),this._isDisposed=!0}}Dm.ForceGLSL=!1;class Om{set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get children(){return this.sprites}get scene(){return this._scene}get capacity(){return this._spriteRenderer.capacity}get texture(){return this._spriteRenderer.texture}set texture(e){e.wrapU=$e.g.CLAMP_ADDRESSMODE,e.wrapV=$e.g.CLAMP_ADDRESSMODE,this._spriteRenderer.texture=e,this._textureContent=null}get cellWidth(){return this._spriteRenderer.cellWidth}set cellWidth(e){this._spriteRenderer.cellWidth=e}get cellHeight(){return this._spriteRenderer.cellHeight}set cellHeight(e){this._spriteRenderer.cellHeight=e}get fogEnabled(){return this._spriteRenderer.fogEnabled}set fogEnabled(e){this._spriteRenderer.fogEnabled=e}get useLogarithmicDepth(){return this._spriteRenderer.useLogarithmicDepth}set useLogarithmicDepth(e){this._spriteRenderer.useLogarithmicDepth=e}get blendMode(){return this._spriteRenderer.blendMode}set blendMode(e){this._spriteRenderer.blendMode=e}get disableDepthWrite(){return this._disableDepthWrite}set disableDepthWrite(e){this._disableDepthWrite=e,this._spriteRenderer.disableDepthWrite=e}get pixelPerfect(){return this._spriteRenderer.pixelPerfect}set pixelPerfect(e){this._spriteRenderer.pixelPerfect=e,e&&3!==this.texture.samplingMode&&this.texture.updateSamplingMode(3)}constructor(e,t,i,r,n,o=.01,a=$e.g.TRILINEAR_SAMPLINGMODE,l=!1,h=null,c){this.name=e,this.sprites=[],this.renderingGroupId=0,this.layerMask=268435455,this.isPickable=!1,this.metadata=null,this._wasDispatched=!1,this.onDisposeObservable=new s.cP,this._disableDepthWrite=!1,this._packedAndReady=!1,this._customUpdate=(e,t)=>{e.cellRef||(e.cellIndex=0);const i=e.cellIndex;"number"==typeof i&&isFinite(i)&&Math.floor(i)===i&&(e.cellRef=this._spriteMap[e.cellIndex]),e._xOffset=this._cellData[e.cellRef].frame.x/t.width,e._yOffset=this._cellData[e.cellRef].frame.y/t.height,e._xSize=this._cellData[e.cellRef].frame.w,e._ySize=this._cellData[e.cellRef].frame.h},n||(n=C.q.LastCreatedScene),n._getComponent(Ei.v.NAME_SPRITE)||n._addComponent(new Mm(n)),this._fromPacked=l,this._scene=n;const u=this._scene.getEngine();if(this._spriteRenderer=new Dm(u,i,o,n,c?.spriteRendererOptions),r.width&&r.height)this.cellWidth=r.width,this.cellHeight=r.height;else{if(void 0===r)return void(this._spriteRenderer=null);this.cellWidth=r,this.cellHeight=r}this._scene.spriteManagers&&this._scene.spriteManagers.push(this),this.uniqueId=this.scene.getUniqueId(),t&&(this.texture=new $e.g(t,n,!0,!1,a)),this._fromPacked&&this._makePacked(t,h)}getClassName(){return"SpriteManager"}_makePacked(e,t){if(null!==t)try{let e;if(e="string"==typeof t?JSON.parse(t):t,e.frames.length){const t={};for(let i=0;i<e.frames.length;i++){const r=e.frames[i];if("string"!=typeof Object.keys(r)[0])throw new Error("Invalid JSON Format.  Check the frame values and make sure the name is the first parameter.");t[r[Object.keys(r)[0]]]=r}e.frames=t}const i=Reflect.ownKeys(e.frames);this._spriteMap=i,this._packedAndReady=!0,this._cellData=e.frames}catch(e){throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON from string. Spritesheet managed with constant cell size.")}else{const t=/\./g;let i;do{i=t.lastIndex,t.test(e)}while(t.lastIndex>0);const r=e.substring(0,i-1)+".json",s=()=>{m.V.Error("JSON ERROR: Unable to load JSON file."),this._fromPacked=!1,this._packedAndReady=!1},n=e=>{try{const t=JSON.parse(e),i=Reflect.ownKeys(t.frames);this._spriteMap=i,this._packedAndReady=!0,this._cellData=t.frames}catch(e){throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON format. Please check documentation for format specifications.")}};H.S0.LoadFile(r,n,void 0,void 0,!1,s)}}_checkTextureAlpha(e,t,i,r,s){if(!e.useAlphaForPicking||!this.texture)return!0;const o=this.texture.getSize();this._textureContent||(this._textureContent=new Uint8Array(o.width*o.height*4),this.texture.readPixels(0,0,this._textureContent));const a=n.AA.Vector3[0];a.copyFrom(t.direction),a.normalize(),a.scaleInPlace(i),a.addInPlace(t.origin);const l=(a.x-r.x)/(s.x-r.x),h=1-(a.y-r.y)/(s.y-r.y),c=e._xOffset*o.width+l*e._xSize|0,u=e._yOffset*o.height+h*e._ySize|0;return this._textureContent[4*(c+u*o.width)+3]>.5}intersects(e,t,i,r){const s=Math.min(this.capacity,this.sprites.length),o=n.Pq.Zero(),a=n.Pq.Zero();let l=Number.MAX_VALUE,h=null;const c=n.AA.Vector3[0],u=n.AA.Vector3[1],d=t.getViewMatrix();let p=e,m=e;for(let t=0;t<s;t++){const s=this.sprites[t];if(s){if(i){if(!i(s))continue}else if(!s.isPickable)continue;if(n.Pq.TransformCoordinatesToRef(s.position,d,u),s.angle?(n.uq.TranslationToRef(-u.x,-u.y,0,n.AA.Matrix[1]),n.uq.TranslationToRef(u.x,u.y,0,n.AA.Matrix[2]),n.uq.RotationZToRef(-s.angle,n.AA.Matrix[3]),n.AA.Matrix[1].multiplyToRef(n.AA.Matrix[3],n.AA.Matrix[4]),n.AA.Matrix[4].multiplyToRef(n.AA.Matrix[2],n.AA.Matrix[0]),p=e.clone(),n.Pq.TransformCoordinatesToRef(e.origin,n.AA.Matrix[0],p.origin),n.Pq.TransformNormalToRef(e.direction,n.AA.Matrix[0],p.direction)):p=e,o.copyFromFloats(u.x-s.width/2,u.y-s.height/2,u.z),a.copyFromFloats(u.x+s.width/2,u.y+s.height/2,u.z),p.intersectsBoxMinMax(o,a)){const e=n.Pq.Distance(u,p.origin);if(l>e){if(!this._checkTextureAlpha(s,p,e,o,a))continue;if(m=p,l=e,h=s,r)break}}}}if(h){const e=new Xr.G;d.invertToRef(n.AA.Matrix[0]),e.hit=!0,e.pickedSprite=h,e.distance=l;const t=n.AA.Vector3[2];return t.copyFrom(m.direction),t.normalize(),t.scaleInPlace(l),m.origin.addToRef(t,c),e.pickedPoint=n.Pq.TransformCoordinates(c,n.AA.Matrix[0]),e}return null}multiIntersects(e,t,i){const r=Math.min(this.capacity,this.sprites.length),s=n.Pq.Zero(),o=n.Pq.Zero();let a;const l=[],h=n.AA.Vector3[0].copyFromFloats(0,0,0),c=n.AA.Vector3[1].copyFromFloats(0,0,0),u=t.getViewMatrix();for(let t=0;t<r;t++){const r=this.sprites[t];if(r){if(i){if(!i(r))continue}else if(!r.isPickable)continue;if(n.Pq.TransformCoordinatesToRef(r.position,u,c),s.copyFromFloats(c.x-r.width/2,c.y-r.height/2,c.z),o.copyFromFloats(c.x+r.width/2,c.y+r.height/2,c.z),e.intersectsBoxMinMax(s,o)){if(a=n.Pq.Distance(c,e.origin),!this._checkTextureAlpha(r,e,a,s,o))continue;const t=new Xr.G;l.push(t),u.invertToRef(n.AA.Matrix[0]),t.hit=!0,t.pickedSprite=r,t.distance=a;const i=n.AA.Vector3[2];i.copyFrom(e.direction),i.normalize(),i.scaleInPlace(a),e.origin.addToRef(i,h),t.pickedPoint=n.Pq.TransformCoordinates(h,n.AA.Matrix[0])}}}return l}render(){if(this._fromPacked&&(!this._packedAndReady||!this._spriteMap||!this._cellData))return;const e=this._scene.getEngine().getDeltaTime();this._packedAndReady?this._spriteRenderer.render(this.sprites,e,this._scene.getViewMatrix(),this._scene.getProjectionMatrix(),this._customUpdate):this._spriteRenderer.render(this.sprites,e,this._scene.getViewMatrix(),this._scene.getProjectionMatrix())}rebuild(){this._spriteRenderer?.rebuild()}dispose(){if(this._spriteRenderer&&(this._spriteRenderer.dispose(),this._spriteRenderer=null),this._textureContent=null,this._scene.spriteManagers){const e=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(e,1)}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null}serialize(e=!1){const t={};t.name=this.name,t.capacity=this.capacity,t.cellWidth=this.cellWidth,t.cellHeight=this.cellHeight,t.fogEnabled=this.fogEnabled,t.blendMode=this.blendMode,t.disableDepthWrite=this.disableDepthWrite,t.pixelPerfect=this.pixelPerfect,t.useLogarithmicDepth=this.useLogarithmicDepth,this.texture&&(e?t.texture=this.texture.serialize():(t.textureUrl=this.texture.name,t.invertY=this.texture._invertY)),t.sprites=[];for(const e of this.sprites)t.sprites.push(e.serialize());return t.metadata=this.metadata,t}static Parse(e,t,i){const r=new Om(e.name,"",e.capacity,{width:e.cellWidth,height:e.cellHeight},t);void 0!==e.fogEnabled&&(r.fogEnabled=e.fogEnabled),void 0!==e.blendMode&&(r.blendMode=e.blendMode),void 0!==e.disableDepthWrite&&(r.disableDepthWrite=e.disableDepthWrite),void 0!==e.pixelPerfect&&(r.pixelPerfect=e.pixelPerfect),void 0!==e.useLogarithmicDepth&&(r.useLogarithmicDepth=e.useLogarithmicDepth),void 0!==e.metadata&&(r.metadata=e.metadata),e.texture?r.texture=$e.g.Parse(e.texture,t,i):e.textureName&&(r.texture=new $e.g(i+e.textureUrl,t,!1,void 0===e.invertY||e.invertY));for(const t of e.sprites)Im.Parse(t,r);return r}static ParseFromFileAsync(e,t,i,r=""){return new Promise(((s,n)=>{const o=new Kr.u;o.addEventListener("readystatechange",(()=>{if(4==o.readyState)if(200==o.status){const t=JSON.parse(o.responseText),n=Om.Parse(t,i||C.q.LastCreatedScene,r);e&&(n.name=e),s(n)}else n("Unable to load the sprite manager")})),o.open("GET",t),o.send()}))}static ParseFromSnippetAsync(e,t,i=""){return"_BLANK"===e?Promise.resolve(new Om("Default sprite manager","//playground.babylonjs.com/textures/player.png",500,64,t)):new Promise(((r,s)=>{const n=new Kr.u;n.addEventListener("readystatechange",(()=>{if(4==n.readyState)if(200==n.status){const s=JSON.parse(JSON.parse(n.responseText).jsonPayload),o=JSON.parse(s.spriteManager),a=Om.Parse(o,t||C.q.LastCreatedScene,i);a.snippetId=e,r(a)}else s("Unable to load the snippet "+e)})),n.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),n.send()}))}}Om.SnippetUrl="https://snippet.babylonjs.com",Om.CreateFromSnippetAsync=Om.ParseFromSnippetAsync;var Nm=!0;class wm{}wm.LoaderInjectedPhysicsEngine=void 0;let Fm={},Bm={},Vm={};const Lm=(e,t,i,r)=>{if(!t.materials)return null;for(let s=0,n=t.materials.length;s<n;s++){const n=t.materials[s];if(e(n))return{parsedMaterial:n,material:fn.i.Parse(n,i,r)}}return null},km=(e,t,i)=>{for(const r in t)if(e.name===t[r])return i.push(e.id),!0;return void 0!==e.parentId&&-1!==i.indexOf(e.parentId)&&(i.push(e.id),!0)},Gm=(e,t)=>e+" of "+(t?t.file+" from "+t.name+" version: "+t.version+", exporter version: "+t.exporter_version:"unknown"),zm=(e,t)=>{const i=t;if(t._waitingData.lods){if(t._waitingData.lods.ids&&t._waitingData.lods.ids.length>0){const r=t._waitingData.lods.ids,s=i.isEnabled(!1);if(t._waitingData.lods.distances){const n=t._waitingData.lods.distances;if(n.length>=r.length){const t=n.length>r.length?n[n.length-1]:0;i.setEnabled(!1);for(let t=0;t<r.length;t++){const s=r[t],o=e.getMeshById(s);null!=o&&i.addLODLevel(n[t],o)}t>0&&i.addLODLevel(t,null),!0===s&&i.setEnabled(!0)}else H.S0.Warn("Invalid level of detail distances for "+t.name)}}t._waitingData.lods=null}},Um=(e,t,i)=>{if("number"!=typeof e){const r=i.getLastEntryById(e);if(r&&null!=t){return r.instances[parseInt(t)]}return r}const r=Fm[e];if(r&&null!=t){return r.instances[parseInt(t)]}return r},Wm=(e,t)=>"number"!=typeof e?t.getLastMaterialById(e,!0):Bm[e],Hm=(e,t,i,r,s=!1)=>{const n=new W.WZ(e);let o="importScene has failed JSON parse";try{var l=JSON.parse(t);o="";const r=sd.cn.loggingLevel===sd.cn.DETAILED_LOGGING;let s,h;if(void 0!==l.environmentTexture&&null!==l.environmentTexture){const t=void 0===l.isPBR||l.isPBR;if(l.environmentTextureType&&"BABYLON.HDRCubeTexture"===l.environmentTextureType){const r=l.environmentTextureSize?l.environmentTextureSize:128,s=new xm.HDRCubeTexture((l.environmentTexture.match(/https?:\/\//g)?"":i)+l.environmentTexture,e,r,!0,!t,void 0,l.environmentTexturePrefilterOnLoad);l.environmentTextureRotationY&&(s.rotationY=l.environmentTextureRotationY),e.environmentTexture=s}else if("object"==typeof l.environmentTexture){const t=Wu.CubeTexture.Parse(l.environmentTexture,e,i);e.environmentTexture=t}else if(l.environmentTexture.endsWith(".env")){const t=new Wu.CubeTexture((l.environmentTexture.match(/https?:\/\//g)?"":i)+l.environmentTexture,e,l.environmentTextureForcedExtension);l.environmentTextureRotationY&&(t.rotationY=l.environmentTextureRotationY),e.environmentTexture=t}else{const t=Wu.CubeTexture.CreateFromPrefilteredData((l.environmentTexture.match(/https?:\/\//g)?"":i)+l.environmentTexture,e,l.environmentTextureForcedExtension);l.environmentTextureRotationY&&(t.rotationY=l.environmentTextureRotationY),e.environmentTexture=t}if(!0===l.createDefaultSkybox){const i=void 0!==e.activeCamera&&null!==e.activeCamera?(e.activeCamera.maxZ-e.activeCamera.minZ)/2:1e3,r=l.skyboxBlurLevel||0;e.createDefaultSkybox(e.environmentTexture,t,i,r)}n.environmentTexture=e.environmentTexture}if(void 0!==l.environmentIntensity&&null!==l.environmentIntensity&&(e.environmentIntensity=l.environmentIntensity),void 0!==l.lights&&null!==l.lights)for(s=0,h=l.lights.length;s<h;s++){const t=l.lights[s],i=Ns.v.Parse(t,e);i&&(Fm[t.uniqueId]=i,n.lights.push(i),i._parentContainer=n,o+=0===s?"\n\tLights:":"",o+="\n\t\t"+i.toString(r))}if(void 0!==l.reflectionProbes&&null!==l.reflectionProbes)for(s=0,h=l.reflectionProbes.length;s<h;s++){const t=l.reflectionProbes[s],a=Em.Parse(t,e,i);a&&(n.reflectionProbes.push(a),a._parentContainer=n,o+=0===s?"\n\tReflection Probes:":"",o+="\n\t\t"+a.toString(r))}if(void 0!==l.animations&&null!==l.animations)for(s=0,h=l.animations.length;s<h;s++){const t=l.animations[s],i=(0,a.n9)("BABYLON.Animation");if(i){const a=i.Parse(t);e.animations.push(a),n.animations.push(a),o+=0===s?"\n\tAnimations:":"",o+="\n\t\t"+a.toString(r)}}if(void 0!==l.materials&&null!==l.materials)for(s=0,h=l.materials.length;s<h;s++){const t=l.materials[s],a=fn.i.Parse(t,e,i);if(a){Bm[t.uniqueId||t.id]=a,n.materials.push(a),a._parentContainer=n,o+=0===s?"\n\tMaterials:":"",o+="\n\t\t"+a.toString(r);a.getActiveTextures().forEach((e=>{-1==n.textures.indexOf(e)&&(n.textures.push(e),e._parentContainer=n)}))}}if(void 0!==l.multiMaterials&&null!==l.multiMaterials)for(s=0,h=l.multiMaterials.length;s<h;s++){const t=l.multiMaterials[s],i=gm.F.ParseMultiMaterial(t,e);Bm[t.uniqueId||t.id]=i,n.multiMaterials.push(i),i._parentContainer=n,o+=0===s?"\n\tMultiMaterials:":"",o+="\n\t\t"+i.toString(r);i.getActiveTextures().forEach((e=>{-1==n.textures.indexOf(e)&&(n.textures.push(e),e._parentContainer=n)}))}if(void 0!==l.morphTargetManagers&&null!==l.morphTargetManagers)for(const t of l.morphTargetManagers){const i=vm.j.Parse(t,e);Vm[t.id]=i,n.morphTargetManagers.push(i),i._parentContainer=n}if(void 0!==l.skeletons&&null!==l.skeletons)for(s=0,h=l.skeletons.length;s<h;s++){const t=l.skeletons[s],i=Ye.E.Parse(t,e);n.skeletons.push(i),i._parentContainer=n,o+=0===s?"\n\tSkeletons:":"",o+="\n\t\t"+i.toString(r)}const c=l.geometries;if(null!=c){const t=new Array,r=c.vertexData;if(null!=r)for(s=0,h=r.length;s<h;s++){const n=r[s];t.push(_m.V.Parse(n,e,i))}t.forEach((e=>{e&&(n.geometries.push(e),e._parentContainer=n)}))}if(void 0!==l.transformNodes&&null!==l.transformNodes)for(s=0,h=l.transformNodes.length;s<h;s++){const t=l.transformNodes[s],r=mt.V.Parse(t,e,i);Fm[t.uniqueId]=r,n.transformNodes.push(r),r._parentContainer=n}if(void 0!==l.meshes&&null!==l.meshes)for(s=0,h=l.meshes.length;s<h;s++){const t=l.meshes[s],a=tt.e.Parse(t,e,i);if(Fm[t.uniqueId]=a,n.meshes.push(a),a._parentContainer=n,a.hasInstances)for(const e of a.instances)n.meshes.push(e),e._parentContainer=n;o+=0===s?"\n\tMeshes:":"",o+="\n\t\t"+a.toString(r)}if(void 0!==l.cameras&&null!==l.cameras)for(s=0,h=l.cameras.length;s<h;s++){const t=l.cameras[s],i=ft.i.Parse(t,e);Fm[t.uniqueId]=i,n.cameras.push(i),i._parentContainer=n,o+=0===s?"\n\tCameras:":"",o+="\n\t\t"+i.toString(r)}if(void 0!==l.postProcesses&&null!==l.postProcesses)for(s=0,h=l.postProcesses.length;s<h;s++){const t=l.postProcesses[s],r=Fi.w.Parse(t,e,i);r&&(n.postProcesses.push(r),r._parentContainer=n,o+=0===s?"\nPostprocesses:":"",o+="\n\t\t"+r.toString())}if(void 0!==l.animationGroups&&null!==l.animationGroups)for(s=0,h=l.animationGroups.length;s<h;s++){const t=l.animationGroups[s],i=L.AnimationGroup.Parse(t,e);n.animationGroups.push(i),i._parentContainer=n,o+=0===s?"\n\tAnimationGroups:":"",o+="\n\t\t"+i.toString(r)}if(l.spriteManagers)for(let t=0,r=l.spriteManagers.length;t<r;t++){const r=l.spriteManagers[t];o+="\n\t\tSpriteManager "+Om.Parse(r,e,i).name}for(s=0,h=e.cameras.length;s<h;s++){const t=e.cameras[s];null!==t._waitingParentId&&(t.parent=Um(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null)}for(s=0,h=e.lights.length;s<h;s++){const t=e.lights[s];t&&null!==t._waitingParentId&&(t.parent=Um(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null)}for(s=0,h=e.transformNodes.length;s<h;s++){const t=e.transformNodes[s];null!==t._waitingParentId&&(t.parent=Um(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null)}for(s=0,h=e.meshes.length;s<h;s++){const t=e.meshes[s];null!==t._waitingParentId&&(t.parent=Um(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null),t._waitingData.lods&&zm(e,t)}for(e.multiMaterials.forEach((t=>{t._waitingSubMaterialsUniqueIds.forEach((i=>{t.subMaterials.push(Wm(i,e))})),t._waitingSubMaterialsUniqueIds=[]})),e.meshes.forEach((t=>{null!==t._waitingMaterialId&&(t.material=Wm(t._waitingMaterialId,e),t._waitingMaterialId=null)})),e.meshes.forEach((e=>{null!==e._waitingMorphTargetManagerId&&(e.morphTargetManager=Vm[e._waitingMorphTargetManagerId],e._waitingMorphTargetManagerId=null)})),s=0,h=e.skeletons.length;s<h;s++){const t=e.skeletons[s];t._hasWaitingData&&(null!=t.bones&&t.bones.forEach((t=>{if(t._waitingTransformNodeId){const i=e.getLastEntryById(t._waitingTransformNodeId);i&&t.linkTransformNode(i),t._waitingTransformNodeId=null}})),t._hasWaitingData=null)}for(s=0,h=e.meshes.length;s<h;s++){const t=e.meshes[s];t._waitingData.freezeWorldMatrix?(t.freezeWorldMatrix(),t._waitingData.freezeWorldMatrix=null):t.computeWorldMatrix(!0)}for(s=0,h=e.lights.length;s<h;s++){const t=e.lights[s];if(t._excludedMeshesIds.length>0){for(let i=0;i<t._excludedMeshesIds.length;i++){const r=e.getMeshById(t._excludedMeshesIds[i]);r&&t.excludedMeshes.push(r)}t._excludedMeshesIds=[]}if(t._includedOnlyMeshesIds.length>0){for(let i=0;i<t._includedOnlyMeshesIds.length;i++){const r=e.getMeshById(t._includedOnlyMeshesIds[i]);r&&t.includedOnlyMeshes.push(r)}t._includedOnlyMeshesIds=[]}}for(e.geometries.forEach((e=>{e._loadedUniqueId=""})),(0,Ep.oj)(l,e,n,i),s=0,h=e.meshes.length;s<h;s++){const t=e.meshes[s];t._waitingData.actions&&(A.Parse(t._waitingData.actions,t,e),t._waitingData.actions=null)}void 0!==l.actions&&null!==l.actions&&A.Parse(l.actions,null,e)}catch(e){const t=Gm("loadAssets",l?l.producer:"Unknown")+o;if(!r)throw m.V.Log(t),e;r(t,e)}finally{Fm={},Bm={},Vm={},s||n.removeAllFromScene(),null!==o&&sd.cn.loggingLevel!==sd.cn.NO_LOGGING&&m.V.Log(Gm("loadAssets",l?l.producer:"Unknown")+(sd.cn.loggingLevel!==sd.cn.MINIMAL_LOGGING?o:""))}return n};sd.cn.RegisterPlugin({name:"babylon.js",extensions:".babylon",canDirectLoad:e=>-1!==e.indexOf("babylon"),importMesh:(e,t,i,r,s,n,o,a)=>{let l="importMesh has failed JSON parse";try{var h=JSON.parse(i);l="";const a=sd.cn.loggingLevel===sd.cn.DETAILED_LOGGING;e?Array.isArray(e)||(e=[e]):e=null;const c=[],u=new Map,d=[];if(void 0!==h.transformNodes&&null!==h.transformNodes)for(let e=0,i=h.transformNodes.length;e<i;e++){const i=h.transformNodes[e],s=mt.V.Parse(i,t,r);d.push(s),u.set(s._waitingParsedUniqueId,s),s._waitingParsedUniqueId=null}if(void 0!==h.meshes&&null!==h.meshes){const i=[],n=[],p=[],f=[];for(let d=0,_=h.meshes.length;d<_;d++){const _=h.meshes[d];if(null===e||km(_,e,c)){if(null!==e&&delete e[e.indexOf(_.name)],void 0!==_.geometryId&&null!==_.geometryId&&void 0!==h.geometries&&null!==h.geometries){let e=!1;["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"].forEach((i=>{!0!==e&&h.geometries[i]&&Array.isArray(h.geometries[i])&&h.geometries[i].forEach((s=>{if(s.id===_.geometryId){if("vertexData"===i)_m.V.Parse(s,t,r);e=!0}}))})),!1===e&&m.V.Warn("Geometry not found for mesh "+_.id)}if(_.materialUniqueId||_.materialId){const e=_.materialUniqueId?p:n;let i=-1!==e.indexOf(_.materialUniqueId||_.materialId);if(!1===i&&void 0!==h.multiMaterials&&null!==h.multiMaterials){const s=(i,s)=>{e.push(i);const n=Lm(s,h,t,r);n&&n.material&&(Bm[n.parsedMaterial.uniqueId||n.parsedMaterial.id]=n.material,l+="\n\tMaterial "+n.material.toString(a))};for(let r=0,n=h.multiMaterials.length;r<n;r++){const n=h.multiMaterials[r];if(_.materialUniqueId&&n.uniqueId===_.materialUniqueId||n.id===_.materialId){n.materialsUniqueIds?n.materialsUniqueIds.forEach((e=>s(e,(t=>t.uniqueId===e)))):n.materials.forEach((e=>s(e,(t=>t.id===e)))),e.push(n.uniqueId||n.id);const r=gm.F.ParseMultiMaterial(n,t);Bm[n.uniqueId||n.id]=r,r&&(i=!0,l+="\n\tMulti-Material "+r.toString(a));break}}}if(!1===i){e.push(_.materialUniqueId||_.materialId);const i=Lm((e=>_.materialUniqueId&&e.uniqueId===_.materialUniqueId||e.id===_.materialId),h,t,r);i&&i.material?(Bm[i.parsedMaterial.uniqueId||i.parsedMaterial.id]=i.material,l+="\n\tMaterial "+i.material.toString(a)):m.V.Warn("Material not found for mesh "+_.id)}}if(null!==_.skeletonId&&void 0!==_.skeletonId&&-1!==h.skeletonId&&void 0!==h.skeletons&&null!==h.skeletons){if(!(i.indexOf(_.skeletonId)>-1))for(let e=0,r=h.skeletons.length;e<r;e++){const r=h.skeletons[e];if(r.id===_.skeletonId){const e=Ye.E.Parse(r,t);o.push(e),i.push(r.id),l+="\n\tSkeleton "+e.toString(a)}}}if(_.morphTargetManagerId>-1&&void 0!==h.morphTargetManagers&&null!==h.morphTargetManagers){if(!(f.indexOf(_.morphTargetManagerId)>-1))for(let e=0;e<h.morphTargetManagers.length;e++){const i=h.morphTargetManagers[e];if(i.id===_.morphTargetManagerId){const e=vm.j.Parse(i,t);Vm[i.id]=e,f.push(i.id),l+="\nMorph target manager"+e.toString()}}}const c=tt.e.Parse(_,t,r);s.push(c),u.set(c._waitingParsedUniqueId,c),c._waitingParsedUniqueId=null,l+="\n\tMesh "+c.toString(a)}}t.multiMaterials.forEach((e=>{e._waitingSubMaterialsUniqueIds.forEach((i=>{e.subMaterials.push(Wm(i,t))})),e._waitingSubMaterialsUniqueIds=[]})),t.meshes.forEach((e=>{null!==e._waitingMaterialId&&(e.material=Wm(e._waitingMaterialId,t),e._waitingMaterialId=null)})),t.meshes.forEach((e=>{null!==e._waitingMorphTargetManagerId&&(e.morphTargetManager=Vm[e._waitingMorphTargetManagerId],e._waitingMorphTargetManagerId=null)}));for(let e=0,i=t.transformNodes.length;e<i;e++){const i=t.transformNodes[e];if(null!==i._waitingParentId){let e=u.get(parseInt(i._waitingParentId))||null;null===e&&(e=t.getLastEntryById(i._waitingParentId));let r=e;i._waitingParentInstanceIndex&&(r=e.instances[parseInt(i._waitingParentInstanceIndex)],i._waitingParentInstanceIndex=null),i.parent=r,i._waitingParentId=null}}let _;for(let e=0,i=t.meshes.length;e<i;e++){if(_=t.meshes[e],_._waitingParentId){let e=u.get(parseInt(_._waitingParentId))||null;null===e&&(e=t.getLastEntryById(_._waitingParentId));let i=e;_._waitingParentInstanceIndex&&(i=e.instances[parseInt(_._waitingParentInstanceIndex)],_._waitingParentInstanceIndex=null),_.parent=i,_._waitingParentId=null}_._waitingData.lods&&zm(t,_)}for(const e of d){e.getChildMeshes(!1).length||e.dispose()}for(let e=0,i=t.skeletons.length;e<i;e++){const i=t.skeletons[e];i._hasWaitingData&&(null!=i.bones&&i.bones.forEach((e=>{if(e._waitingTransformNodeId){const i=t.getLastEntryById(e._waitingTransformNodeId);i&&e.linkTransformNode(i),e._waitingTransformNodeId=null}})),i._hasWaitingData=null)}for(let e=0,i=t.meshes.length;e<i;e++)_=t.meshes[e],_._waitingData.freezeWorldMatrix?(_.freezeWorldMatrix(),_._waitingData.freezeWorldMatrix=null):_.computeWorldMatrix(!0)}if(void 0!==h.particleSystems&&null!==h.particleSystems){const e=(0,Ep.LO)(Ei.v.NAME_PARTICLESYSTEM);if(e)for(let i=0,s=h.particleSystems.length;i<s;i++){const s=h.particleSystems[i];-1!==c.indexOf(s.emitterId)&&n.push(e(s,t,r))}}return t.geometries.forEach((e=>{e._loadedUniqueId=""})),!0}catch(e){const t=Gm("importMesh",h?h.producer:"Unknown")+l;if(!a)throw m.V.Log(t),e;a(t,e)}finally{null!==l&&sd.cn.loggingLevel!==sd.cn.NO_LOGGING&&m.V.Log(Gm("importMesh",h?h.producer:"Unknown")+(sd.cn.loggingLevel!==sd.cn.MINIMAL_LOGGING?l:"")),Bm={},Vm={}}return!1},load:(e,t,i,r)=>{let s="importScene has failed JSON parse";try{var a=JSON.parse(t);switch(s="",void 0!==a.useDelayedTextureLoading&&null!==a.useDelayedTextureLoading&&(e.useDelayedTextureLoading=a.useDelayedTextureLoading&&!sd.cn.ForceFullSceneLoadingForIncremental),void 0!==a.autoClear&&null!==a.autoClear&&(e.autoClear=a.autoClear),void 0!==a.clearColor&&null!==a.clearColor&&(e.clearColor=o.ov.FromArray(a.clearColor)),void 0!==a.ambientColor&&null!==a.ambientColor&&(e.ambientColor=o.v9.FromArray(a.ambientColor)),void 0!==a.gravity&&null!==a.gravity&&(e.gravity=n.Pq.FromArray(a.gravity)),void 0!==a.useRightHandedSystem&&(e.useRightHandedSystem=!!a.useRightHandedSystem),void 0!==a.fogMode&&null!==a.fogMode&&(e.fogMode=a.fogMode),void 0!==a.fogColor&&null!==a.fogColor&&(e.fogColor=o.v9.FromArray(a.fogColor)),void 0!==a.fogStart&&null!==a.fogStart&&(e.fogStart=a.fogStart),void 0!==a.fogEnd&&null!==a.fogEnd&&(e.fogEnd=a.fogEnd),void 0!==a.fogDensity&&null!==a.fogDensity&&(e.fogDensity=a.fogDensity),s+="\tFog mode for scene:  ",e.fogMode){case 0:s+="none\n";break;case 1:s+="exp\n";break;case 2:s+="exp2\n";break;case 3:s+="linear\n"}if(a.physicsEnabled){let t;"cannon"===a.physicsEngine||a.physicsEngine===Pm.name?t=new Pm(void 0,void 0,wm.LoaderInjectedPhysicsEngine):"oimo"===a.physicsEngine||a.physicsEngine===Tm.name?t=new Tm(void 0,wm.LoaderInjectedPhysicsEngine):"ammo"!==a.physicsEngine&&a.physicsEngine!==Cm.name||(t=new Cm(void 0,wm.LoaderInjectedPhysicsEngine,void 0)),s="\tPhysics engine "+(a.physicsEngine?a.physicsEngine:"oimo")+" enabled\n";const i=a.gravity?n.Pq.FromArray(a.gravity):a.physicsGravity?n.Pq.FromArray(a.physicsGravity):null;e.enablePhysics(i,t)}void 0!==a.metadata&&null!==a.metadata&&(e.metadata=a.metadata),void 0!==a.collisionsEnabled&&null!==a.collisionsEnabled&&(e.collisionsEnabled=a.collisionsEnabled);return!!Hm(e,t,i,r,!0)&&(a.autoAnimate&&e.beginAnimation(e,a.autoAnimateFrom,a.autoAnimateTo,a.autoAnimateLoop,a.autoAnimateSpeed||1),void 0!==a.activeCameraID&&null!==a.activeCameraID&&e.setActiveCameraById(a.activeCameraID),!0)}catch(e){const t=Gm("importScene",a?a.producer:"Unknown")+s;if(!r)throw m.V.Log(t),e;r(t,e)}finally{null!==s&&sd.cn.loggingLevel!==sd.cn.NO_LOGGING&&m.V.Log(Gm("importScene",a?a.producer:"Unknown")+(sd.cn.loggingLevel!==sd.cn.MINIMAL_LOGGING?s:""))}return!1},loadAssetContainer:(e,t,i,r)=>Hm(e,t,i,r)});var $m=i(7597),qm=i(35616),Ym=i(92321),Xm=i(11114),jm=i(58057),Zm=i(35198);class Qm{get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,$.$.MarkAllMaterialsAsDirty(20))}constructor(e={}){this._isEnabled=!0,this.bias=void 0===e.bias?0:e.bias,this.power=void 0===e.power?1:e.power,this.leftColor=e.leftColor||o.v9.White(),this.rightColor=e.rightColor||o.v9.Black(),!1===e.isEnabled&&(this.isEnabled=!1)}clone(){const e=new Qm;return E.r.DeepCopy(this,e),e}equals(e){return e&&this.bias===e.bias&&this.power===e.power&&this.leftColor.equals(e.leftColor)&&this.rightColor.equals(e.rightColor)&&this.isEnabled===e.isEnabled}serialize(){return{isEnabled:this.isEnabled,leftColor:this.leftColor.asArray(),rightColor:this.rightColor.asArray(),bias:this.bias,power:this.power}}static Parse(e){return new Qm({isEnabled:e.isEnabled,leftColor:o.v9.FromArray(e.leftColor),rightColor:o.v9.FromArray(e.rightColor),bias:e.bias,power:e.power||1})}}Ue.p._FresnelParametersParser=Qm.Parse;class Km{}Km.BindSceneUniformBuffer=ts._8,Km.PrepareDefinesForMergedUV=ts.YT,Km.BindTextureMatrix=ts.mA,Km.GetFogState=ts.qL,Km.PrepareDefinesForMisc=ts.fm,Km.PrepareDefinesForCamera=ts.Y7,Km.PrepareDefinesForFrameBoundValues=ts.OR,Km.PrepareDefinesForBones=ts.IC,Km.PrepareDefinesForMorphTargets=ts.Jz,Km.PrepareDefinesForBakedVertexAnimation=ts.wu,Km.PrepareDefinesForAttributes=ts.qB,Km.PrepareDefinesForMultiview=ts.VO,Km.PrepareDefinesForOIT=ts.Nc,Km.PrepareDefinesForPrePass=ts.N4,Km.PrepareDefinesForLight=ts.lo,Km.PrepareDefinesForLights=ts.az,Km.PrepareUniformsAndSamplersForLight=ts.GD,Km.PrepareUniformsAndSamplersList=ts.Bb,Km.HandleFallbacksForShadows=ts.c4,Km.PrepareAttributesForMorphTargetsInfluencers=ts.MF,Km.PrepareAttributesForMorphTargets=ts.IF,Km.PrepareAttributesForBakedVertexAnimation=ts.J2,Km.PrepareAttributesForBones=ts.ni,Km.PrepareAttributesForInstances=ts.ER,Km.PushAttributesForInstances=ts.te,Km.BindLightProperties=ts.L0,Km.BindLight=ts.Kd,Km.BindLights=ts.RL,Km.BindFogParameters=ts.Yy,Km.BindBonesParameters=ts.f$,Km.BindMorphTargetParameters=ts.nR,Km.BindLogDepth=ts.DL;var Jm=i(15450),ef=i(5216);class tf extends rs{constructor(e,t){super(e,t,"color",{attributes:["position"],uniforms:["world","viewProjection","color"]}),this.disableColorWrite=!0,this.forceDepthWrite=!0,this.setColor4("color",new o.ov(0,0,0,1))}}var rf=i(92895),sf=i(1018);class nf extends sf.d{get doubleSided(){return this._twoSidedLighting}set doubleSided(e){this._twoSidedLighting!==e&&(this._twoSidedLighting=e,this.backFaceCulling=!e,this._markAllSubMeshesAsTexturesDirty())}constructor(e,t){super(e,t),this.maxSimultaneousLights=4,this.disableLighting=!1,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.emissiveColor=new o.v9(0,0,0),this.occlusionStrength=1,this.useLightmapAsShadowmap=!1,this._useAlphaFromAlbedoTexture=!0,this._useAmbientInGrayScale=!0}getClassName(){return"PBRBaseSimpleMaterial"}}(0,Ge.Cg)([(0,ze.lK)(),(0,ze.$z)("_markAllSubMeshesAsLightsDirty")],nf.prototype,"maxSimultaneousLights",void 0),(0,Ge.Cg)([(0,ze.lK)(),(0,ze.$z)("_markAllSubMeshesAsLightsDirty")],nf.prototype,"disableLighting",void 0),(0,Ge.Cg)([(0,ze.uM)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty","_reflectionTexture")],nf.prototype,"environmentTexture",void 0),(0,Ge.Cg)([(0,ze.lK)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],nf.prototype,"invertNormalMapX",void 0),(0,Ge.Cg)([(0,ze.lK)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],nf.prototype,"invertNormalMapY",void 0),(0,Ge.Cg)([(0,ze.uM)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty","_bumpTexture")],nf.prototype,"normalTexture",void 0),(0,Ge.Cg)([(0,ze.jT)("emissive"),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],nf.prototype,"emissiveColor",void 0),(0,Ge.Cg)([(0,ze.uM)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],nf.prototype,"emissiveTexture",void 0),(0,Ge.Cg)([(0,ze.lK)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty","_ambientTextureStrength")],nf.prototype,"occlusionStrength",void 0),(0,Ge.Cg)([(0,ze.uM)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty","_ambientTexture")],nf.prototype,"occlusionTexture",void 0),(0,Ge.Cg)([(0,ze.lK)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty","_alphaCutOff")],nf.prototype,"alphaCutOff",void 0),(0,Ge.Cg)([(0,ze.lK)()],nf.prototype,"doubleSided",null),(0,Ge.Cg)([(0,ze.uM)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty",null)],nf.prototype,"lightmapTexture",void 0),(0,Ge.Cg)([(0,ze.lK)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],nf.prototype,"useLightmapAsShadowmap",void 0);var of=i(1500),af=i(83670),lf=i(89696);class hf extends nf{constructor(e,t){super(e,t),this._useRoughnessFromMetallicTextureAlpha=!1,this._useRoughnessFromMetallicTextureGreen=!0,this._useMetallnessFromMetallicTextureBlue=!0,this.metallic=1,this.roughness=1}getClassName(){return"PBRMetallicRoughnessMaterial"}clone(e){const t=Ue.p.Clone((()=>new hf(e,this.getScene())),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=Ue.p.Serialize(this);return e.customType="BABYLON.PBRMetallicRoughnessMaterial",this.clearCoat.doNotSerialize||(e.clearCoat=this.clearCoat.serialize()),this.anisotropy.doNotSerialize||(e.anisotropy=this.anisotropy.serialize()),this.brdf.doNotSerialize||(e.brdf=this.brdf.serialize()),this.sheen.doNotSerialize||(e.sheen=this.sheen.serialize()),this.subSurface.doNotSerialize||(e.subSurface=this.subSurface.serialize()),this.iridescence.doNotSerialize||(e.iridescence=this.iridescence.serialize()),e}static Parse(e,t,i){const r=Ue.p.Parse((()=>new hf(e.name,t)),e,t,i);return e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}}(0,Ge.Cg)([(0,ze.jT)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty","_albedoColor")],hf.prototype,"baseColor",void 0),(0,Ge.Cg)([(0,ze.uM)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],hf.prototype,"baseTexture",void 0),(0,Ge.Cg)([(0,ze.lK)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],hf.prototype,"metallic",void 0),(0,Ge.Cg)([(0,ze.lK)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],hf.prototype,"roughness",void 0),(0,Ge.Cg)([(0,ze.uM)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty","_metallicTexture")],hf.prototype,"metallicRoughnessTexture",void 0),(0,a.Y5)("BABYLON.PBRMetallicRoughnessMaterial",hf);class cf extends nf{get useMicroSurfaceFromReflectivityMapAlpha(){return this._useMicroSurfaceFromReflectivityMapAlpha}constructor(e,t){super(e,t),this._useMicroSurfaceFromReflectivityMapAlpha=!0}getClassName(){return"PBRSpecularGlossinessMaterial"}clone(e){const t=Ue.p.Clone((()=>new cf(e,this.getScene())),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=Ue.p.Serialize(this);return e.customType="BABYLON.PBRSpecularGlossinessMaterial",this.clearCoat.doNotSerialize||(e.clearCoat=this.clearCoat.serialize()),this.anisotropy.doNotSerialize||(e.anisotropy=this.anisotropy.serialize()),this.brdf.doNotSerialize||(e.brdf=this.brdf.serialize()),this.sheen.doNotSerialize||(e.sheen=this.sheen.serialize()),this.subSurface.doNotSerialize||(e.subSurface=this.subSurface.serialize()),this.iridescence.doNotSerialize||(e.iridescence=this.iridescence.serialize()),e}static Parse(e,t,i){const r=Ue.p.Parse((()=>new cf(e.name,t)),e,t,i);return e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}}(0,Ge.Cg)([(0,ze.jT)("diffuse"),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty","_albedoColor")],cf.prototype,"diffuseColor",void 0),(0,Ge.Cg)([(0,ze.uM)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],cf.prototype,"diffuseTexture",void 0),(0,Ge.Cg)([(0,ze.jT)("specular"),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty","_reflectivityColor")],cf.prototype,"specularColor",void 0),(0,Ge.Cg)([(0,ze.lK)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty","_microSurface")],cf.prototype,"glossiness",void 0),(0,Ge.Cg)([(0,ze.uM)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty","_reflectivityTexture")],cf.prototype,"specularGlossinessTexture",void 0),(0,a.Y5)("BABYLON.PBRSpecularGlossinessMaterial",cf);var uf,df=i(84307),pf=i(86097),mf=i(39174),ff=i(22625),_f=i(81448),gf=i(84037);!function(e){e[e.GLSL=0]="GLSL",e[e.WGSL=1]="WGSL"}(uf||(uf={}));i(69764);class xf extends zu.t{constructor(e,t,i=null){if(super(t),e)if(this._textureMatrix=n.uq.Identity(),this.name=e,this.url=e,this._onLoad=i,this._texture=this._getFromCache(e,!0),this._texture)this._triggerOnLoad();else{const e=this.getScene();e&&e.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture()}}_triggerOnLoad(){this._onLoad&&this._onLoad()}getTextureMatrix(){return this._textureMatrix}_load3dlTexture(){const e=this._getEngine();let t;t=e._features.support3DTextures?e.createRawTexture3D(null,1,1,1,5,!1,!1,2,null,0):e.createRawTexture(null,1,1,5,!1,!1,2,null,0),this._texture=t,this._texture.isReady=!1,this.isCube=!1,this.is3D=e._features.support3DTextures,this.wrapU=0,this.wrapV=0,this.wrapR=0,this.anisotropicFilteringLevel=1;const i=i=>{if("string"!=typeof i)return;let r,s=null,n=null;const o=i.split("\n");let a=0,l=0,h=0,c=0,u=0;for(let e=0;e<o.length;e++){if(r=o[e],!xf._NoneEmptyLineRegex.test(r))continue;if(0===r.indexOf("#"))continue;const t=r.split(" ");if(0!==a){if(0!=a){const e=Math.max(parseInt(t[0]),0),i=Math.max(parseInt(t[1]),0),r=Math.max(parseInt(t[2]),0);u=Math.max(e,u),u=Math.max(i,u),u=Math.max(r,u);const s=4*(l+c*a+h*a*a);n&&(n[s+0]=e,n[s+1]=i,n[s+2]=r),h++,h%a==0&&(c++,h=0,c%a==0&&(l++,c=0))}}else a=t.length,s=new Uint8Array(a*a*a*4),n=new Float32Array(a*a*a*4)}if(n&&s)for(let e=0;e<n.length;e++)if(e>0&&(e+1)%4==0)s[e]=255;else{const t=n[e];s[e]=t/u*255}t.is3D?(t.updateSize(a,a,a),e.updateRawTexture3D(t,s,5,!1)):(t.updateSize(a*a,a),e.updateRawTexture(t,s,5,!1)),t.isReady=!0,this._triggerOnLoad()},r=this.getScene();return r?r._loadFile(this.url,i):e._loadFile(this.url,i),this._texture}_loadTexture(){if(this.url){const e=this.url.toLocaleLowerCase();(e.endsWith(".3dl")||e.startsWith("blob:"))&&this._load3dlTexture()}}clone(){const e=new xf(this.url,this.getScene()||this._getEngine());return e.level=this.level,e}delayLoad(){4===this.delayLoadState&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,!0),this._texture||this._loadTexture())}static Parse(e,t){let i=null;return e.name&&!e.isRenderTarget&&(i=new xf(e.name,t),i.name=e.name,i.level=e.level),i}serialize(){if(!this.name)return null;const e={};return e.name=this.name,e.level=this.level,e.customType="BABYLON.ColorGradingTexture",e}}xf._NoneEmptyLineRegex=/\S+/,(0,a.Y5)("BABYLON.ColorGradingTexture",xf);var vf=i(73647),Sf=i(8532);class bf extends zu.t{constructor(e,t,i,r=!1,s=!0,n=null,o=null,a=!1){if(super(t),this._onLoad=null,this._onError=null,!e)throw new Error("Image url is not set");this._coordinatesMode=$e.g.CUBIC_MODE,this.name=e,this.url=e,this._size=i,this._supersample=a,this._noMipmap=r,this.gammaSpace=s,this._onLoad=n,this._onError=o,this.hasAlpha=!1,this.isCube=!0,this._texture=this._getFromCache(e,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?n&&(this._texture.isReady?H.S0.SetImmediate((()=>n())):this._texture.onLoadedObservable.add(n)):t.useDelayedTextureLoading?this.delayLoadState=4:this._loadImage((()=>this._loadTexture()),this._onError)}_loadImage(e,t){const i=this.getScene();if(!i)return;const r=i.getEngine().createRawCubeTexture(null,this._size,4,i.getEngine().getCaps().textureFloat?1:7,!this._noMipmap,!1,3);r.generateMipMaps=!this._noMipmap,i.addPendingData(r),r.url=this.url,r.isReady=!1,i.getEngine()._internalTexturesCache.push(r),this._texture=r,(0,Sf.W$)(this.url,(t=>{let i;this._width=t.width,this._height=t.height,(0,Ai.Nf)()?(i=document.createElement("canvas"),i.width=this._width,i.height=this._height):i=new OffscreenCanvas(this._width,this._height);const r=i.getContext("2d");r.drawImage(t,0,0);const s=r.getImageData(0,0,t.width,t.height);this._buffer=s.data.buffer,i.remove&&i.remove(),e()}),((e,s)=>{i.removePendingData(r),t&&t(`${this.getClassName()} could not be loaded`,s)}),i?i.offlineProvider:null)}_loadTexture(){const e=this.getScene();if(!e)return;const t=(()=>{const e=this._getFloat32ArrayFromArrayBuffer(this._buffer),t=vf.D.ConvertPanoramaToCubemap(e,this._width,this._height,this._size,this._supersample),i=[];for(let e=0;e<6;e++){const r=t[bf._FacesMapping[e]];i.push(r)}return i})(),i=this._texture;e.getEngine().updateRawCubeTexture(i,t,i.format,i.type,i.invertY),i.isReady=!0,e.removePendingData(i),i.onLoadedObservable.notifyObservers(i),i.onLoadedObservable.clear(),this._onLoad&&this._onLoad()}_getFloat32ArrayFromArrayBuffer(e){const t=new DataView(e),i=new Float32Array(3*e.byteLength/4);let r=0;for(let s=0;s<e.byteLength;s++)(s+1)%4!=0&&(i[r++]=t.getUint8(s)/255);return i}getClassName(){return"EquiRectangularCubeTexture"}clone(){const e=this.getScene();if(!e)return this;const t=new bf(this.url,e,this._size,this._noMipmap,this.gammaSpace);return t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t.coordinatesIndex=this.coordinatesIndex,t.coordinatesMode=this.coordinatesMode,t}}bf._FacesMapping=["right","left","up","down","front","back"];var yf=i(35428),Pf=i(68571);class Tf extends zu.t{constructor(e,t,i){if(super(i.scene||i.engine),this.onLoadObservable=new s.cP,t&&(i.engine||i.scene)){if(i={...Tf._DefaultOptions,...i},this._generateMipMaps=i.generateMipMaps,this._samplingMode=i.samplingMode,this._textureMatrix=n.uq.Identity(),this._format=i.format,this.name=e,this.element=t,this._isVideo=!!t.getVideoPlaybackQuality,this._isVideo){const e=this._engine,i=e?.createExternalTexture;i&&(this._externalTexture=i.call(e,t))}this.anisotropicFilteringLevel=1,this._createInternalTexture()}}_createInternalTexture(){let e=0,t=0;this._isVideo?(e=this.element.videoWidth,t=this.element.videoHeight):(e=this.element.width,t=this.element.height);const i=this._getEngine();i&&(this._texture=i.createDynamicTexture(e,t,this._generateMipMaps,this._samplingMode),this._texture.format=this._format),this.update()}getTextureMatrix(){return this._textureMatrix}update(e=null){const t=this._getEngine();if(null==this._texture||null==t)return;const i=this.isReady();if(this._isVideo){const i=this.element;if(i.readyState<i.HAVE_CURRENT_DATA)return;t.updateVideoTexture(this._texture,this._externalTexture?this._externalTexture:i,null===e||e)}else{const i=this.element;t.updateDynamicTexture(this._texture,i,null===e||e,!1,this._format)}!i&&this.isReady()&&this.onLoadObservable.notifyObservers(this)}dispose(){this.onLoadObservable.clear(),super.dispose()}}Tf._DefaultOptions={generateMipMaps:!1,samplingMode:2,format:5,engine:null,scene:null};var Cf=i(7169),Ef=i(27911),Af=i(41427),If=i(51958),Rf=i(69384),Mf=i(52093),Df=i(72156),Of=i(64942),Nf=i(9629),wf=i(86700),Ff=i(50863),Bf=i(98078);class Vf extends cr.${get isSupported(){return this._engine?.getCaps().drawBuffersExtension??!1}get textures(){return this._textures}get count(){return this._count}get depthTexture(){return this._textures[this._textures.length-1]}set wrapU(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapU=e}set wrapV(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapV=e}constructor(e,t,i,r,s,n){const o=!(!s||!s.generateMipMaps)&&s.generateMipMaps,a=!(!s||!s.generateDepthTexture)&&s.generateDepthTexture,l=s&&s.depthTextureFormat?s.depthTextureFormat:15,h=!s||void 0===s.doNotChangeAspectRatio||s.doNotChangeAspectRatio,c=!(!s||!s.drawOnlyOnFirstAttachmentByDefault)&&s.drawOnlyOnFirstAttachmentByDefault;if(super(e,t,r,o,h,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0),!this.isSupported)return void this.dispose();this._textureNames=n;const u=[],d=[],p=[],m=[],f=[],_=[],g=[],x=[];this._initTypes(i,u,d,p,m,f,_,g,x,s);const v=!s||void 0===s.generateDepthBuffer||s.generateDepthBuffer,S=!(!s||void 0===s.generateStencilBuffer)&&s.generateStencilBuffer,b=s&&s.samples?s.samples:1;this._multiRenderTargetOptions={samplingModes:d,generateMipMaps:o,generateDepthBuffer:v,generateStencilBuffer:S,generateDepthTexture:a,depthTextureFormat:l,types:u,textureCount:i,useSRGBBuffers:p,samples:b,formats:m,targetTypes:f,faceIndex:_,layerIndex:g,layerCounts:x,labels:n,label:e},this._count=i,this._drawOnlyOnFirstAttachmentByDefault=c,i>0&&(this._createInternalTextures(),this._createTextures(n))}_initTypes(e,t,i,r,s,n,o,a,l,h){for(let c=0;c<e;c++)h&&h.types&&void 0!==h.types[c]?t.push(h.types[c]):t.push(h&&h.defaultType?h.defaultType:0),h&&h.samplingModes&&void 0!==h.samplingModes[c]?i.push(h.samplingModes[c]):i.push($e.g.BILINEAR_SAMPLINGMODE),h&&h.useSRGBBuffers&&void 0!==h.useSRGBBuffers[c]?r.push(h.useSRGBBuffers[c]):r.push(!1),h&&h.formats&&void 0!==h.formats[c]?s.push(h.formats[c]):s.push(5),h&&h.targetTypes&&void 0!==h.targetTypes[c]?n.push(h.targetTypes[c]):n.push(3553),h&&h.faceIndex&&void 0!==h.faceIndex[c]?o.push(h.faceIndex[c]):o.push(0),h&&h.layerIndex&&void 0!==h.layerIndex[c]?a.push(h.layerIndex[c]):a.push(0),h&&h.layerCounts&&void 0!==h.layerCounts[c]?l.push(h.layerCounts[c]):l.push(1)}_createInternaTextureIndexMapping(){const e={},t=[];if(!this._renderTarget)return t;const i=this._renderTarget.textures;for(let r=0;r<i.length;r++){const s=i[r];if(!s)continue;const n=e[s.uniqueId];void 0!==n?t[r]=n:e[s.uniqueId]=r}return t}_rebuild(e=!1,t=!1,i){if(this._count<1||e)return;const r=this._createInternaTextureIndexMapping();this.releaseInternalTextures(),this._createInternalTextures(),t&&(this._releaseTextures(),this._createTextures(i));const s=this._renderTarget.textures;for(let e=0;e<s.length;e++){const t=this._textures[e];void 0!==r[e]&&this._renderTarget.setTexture(s[r[e]],e),t._texture=s[e],t._texture&&(t._noMipmap=!t._texture.useMipMaps,t._useSRGBBuffer=t._texture._useSRGBBuffer)}1!==this.samples&&this._renderTarget.setSamples(this.samples,!this._drawOnlyOnFirstAttachmentByDefault,!0)}_createInternalTextures(){this._renderTarget=this._getEngine().createMultipleRenderTarget(this._size,this._multiRenderTargetOptions,!this._drawOnlyOnFirstAttachmentByDefault),this._texture=this._renderTarget.texture}_releaseTextures(){if(this._textures)for(let e=0;e<this._textures.length;e++)this._textures[e]._texture=null,this._textures[e].dispose()}_createTextures(e){const t=this._renderTarget.textures;this._textures=[];for(let i=0;i<t.length;i++){const r=new $e.g(null,this.getScene());e?.[i]&&(r.name=e[i]),r._texture=t[i],r._texture&&(r._noMipmap=!r._texture.useMipMaps,r._useSRGBBuffer=r._texture._useSRGBBuffer),this._textures.push(r)}}setInternalTexture(e,t,i=!0){if(this.renderTarget&&(0===t&&(this._texture=e),this.renderTarget.setTexture(e,t,i),this.textures[t]||(this.textures[t]=new $e.g(null,this.getScene()),this.textures[t].name=this._textureNames?.[t]??this.textures[t].name),this.textures[t]._texture=e,this.textures[t]._noMipmap=!e.useMipMaps,this.textures[t]._useSRGBBuffer=e._useSRGBBuffer,this._count=this.renderTarget.textures?this.renderTarget.textures.length:0,this._multiRenderTargetOptions.types&&(this._multiRenderTargetOptions.types[t]=e.type),this._multiRenderTargetOptions.samplingModes&&(this._multiRenderTargetOptions.samplingModes[t]=e.samplingMode),this._multiRenderTargetOptions.useSRGBBuffers&&(this._multiRenderTargetOptions.useSRGBBuffers[t]=e._useSRGBBuffer),this._multiRenderTargetOptions.targetTypes&&-1!==this._multiRenderTargetOptions.targetTypes[t])){let i=0;i=e.is2DArray?35866:e.isCube?34067:e.is3D?32879:3553,this._multiRenderTargetOptions.targetTypes[t]=i}}setLayerAndFaceIndex(e,t=-1,i=-1){this.textures[e]&&this.renderTarget&&(this._multiRenderTargetOptions.layerIndex&&(this._multiRenderTargetOptions.layerIndex[e]=t),this._multiRenderTargetOptions.faceIndex&&(this._multiRenderTargetOptions.faceIndex[e]=i),this.renderTarget.setLayerAndFaceIndex(e,t,i))}setLayerAndFaceIndices(e,t){this.renderTarget&&(this._multiRenderTargetOptions.layerIndex=e,this._multiRenderTargetOptions.faceIndex=t,this.renderTarget.setLayerAndFaceIndices(e,t))}get samples(){return this._samples}set samples(e){this._renderTarget?this._samples=this._renderTarget.setSamples(e):this._samples=e}resize(e){this._processSizeParameter(e),this._rebuild(!1,void 0,this._textureNames)}updateCount(e,t,i){this._multiRenderTargetOptions.textureCount=e,this._count=e;const r=[],s=[],n=[],o=[],a=[],l=[],h=[],c=[];this._textureNames=i,this._initTypes(e,r,s,n,o,a,l,h,c,t),this._multiRenderTargetOptions.types=r,this._multiRenderTargetOptions.samplingModes=s,this._multiRenderTargetOptions.useSRGBBuffers=n,this._multiRenderTargetOptions.formats=o,this._multiRenderTargetOptions.targetTypes=a,this._multiRenderTargetOptions.faceIndex=l,this._multiRenderTargetOptions.layerIndex=h,this._multiRenderTargetOptions.layerCounts=c,this._multiRenderTargetOptions.labels=i,this._rebuild(!1,!0,i)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindMultiColorAttachmentFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(t)}))}dispose(e=!1){this._releaseTextures(),e?this._texture=null:this.releaseInternalTextures(),super.dispose()}releaseInternalTextures(){const e=this._renderTarget?.textures;if(e){for(let t=e.length-1;t>=0;t--)this._textures[t]._texture=null;this._renderTarget?.dispose(),this._renderTarget=null}}}class Lf{constructor(e,t,i){this.id=e,this.scale=t,this.offset=i}}class kf{constructor(e,t,i,r){return this.name=e,this.meshes=t,this.scene=r,this.options=i,this.options.map=this.options.map??["ambientTexture","bumpTexture","diffuseTexture","emissiveTexture","lightmapTexture","opacityTexture","reflectionTexture","refractionTexture","specularTexture"],this.options.uvsIn=this.options.uvsIn??Ot.R.UVKind,this.options.uvsOut=this.options.uvsOut??Ot.R.UVKind,this.options.layout=this.options.layout??kf.LAYOUT_STRIP,this.options.layout===kf.LAYOUT_COLNUM&&(this.options.colnum=this.options.colnum??8),this.options.updateInputMeshes=this.options.updateInputMeshes??!0,this.options.disposeSources=this.options.disposeSources??!0,this._expecting=0,this.options.fillBlanks=this.options.fillBlanks??!0,!0===this.options.fillBlanks&&(this.options.customFillColor=this.options.customFillColor??"black"),this.options.frameSize=this.options.frameSize??256,this.options.paddingRatio=this.options.paddingRatio??.0115,this._paddingValue=Math.ceil(this.options.frameSize*this.options.paddingRatio),this._paddingValue%2!=0&&this._paddingValue++,this.options.paddingMode=this.options.paddingMode??kf.SUBUV_WRAP,this.options.paddingMode===kf.SUBUV_COLOR&&(this.options.paddingColor=this.options.paddingColor??new o.ov(0,0,0,1)),this.sets={},this.frames=[],this}_createFrames(e){const t=this._calculateSize(),i=new n.I9(1,1).divide(t);let r=0;const s=this._expecting,a=this.meshes.length,l=Object.keys(this.sets);for(let e=0;e<l.length;e++){const i=l[e],r=new Tr(this.name+".TexturePack."+i+"Set",{width:t.x,height:t.y},this.scene,!0,$e.g.TRILINEAR_SAMPLINGMODE,5),s=r.getContext();s.fillStyle="rgba(0,0,0,0)",s.fillRect(0,0,t.x,t.y),r.update(!1),this.sets[i]=r}const h=this.options.frameSize||256,c=this._paddingValue,u=h+2*c,d=()=>{this._calculateMeshUVFrames(h,c,t,i,this.options.updateInputMeshes||!1)};for(let i=0;i<a;i++){const n=this.meshes[i].material;for(let a=0;a<l.length;a++){const p=new Tr("temp",u,this.scene,!0),m=p.getContext(),f=this._getFrameOffset(i),_=()=>{r++,p.update(!1);const i=m.getImageData(0,0,u,u),n=this.sets[g];if(n.getContext().putImageData(i,t.x*f.x,t.y*f.y),p.dispose(),n.update(!1),r==s)return d(),void e()},g=l[a]||"_blank";if(n&&null!==n[g]){const e=n[g],t=new Image;t.src=e instanceof Tr?e.getContext().canvas.toDataURL("image/png"):e.url,H.S0.SetCorsBehavior(t.src,t),t.onload=()=>{m.fillStyle="rgba(0,0,0,0)",m.fillRect(0,0,u,u),p.update(!1),m.setTransform(1,0,0,-1,0,0);const e=[0,0,1,0,1,1,0,1,-1,1,-1,0,-2,0,-1,1,-1];switch(this.options.paddingMode){case 0:for(let i=0;i<9;i++)m.drawImage(t,0,0,t.width,t.height,c+h*e[i],c+h*e[i+1]-u,h,h);break;case 1:for(let i=0;i<c;i++)m.drawImage(t,0,0,t.width,t.height,i+h*e[0],c-u,h,h),m.drawImage(t,0,0,t.width,t.height,2*c-i,c-u,h,h),m.drawImage(t,0,0,t.width,t.height,c,i-u,h,h),m.drawImage(t,0,0,t.width,t.height,c,2*c-i-u,h,h);m.drawImage(t,0,0,t.width,t.height,c+h*e[0],c+h*e[1]-u,h,h);break;case 2:m.fillStyle=(this.options.paddingColor||o.v9.Black()).toHexString(),m.fillRect(0,0,u,-u),m.clearRect(c,c,h,h),m.drawImage(t,0,0,t.width,t.height,c+h*e[0],c+h*e[1]-u,h,h)}m.setTransform(1,0,0,1,0,0),_()}}else m.fillStyle="rgba(0,0,0,0)",this.options.fillBlanks&&(m.fillStyle=this.options.customFillColor),m.fillRect(0,0,u,u),_()}}}_calculateSize(){const e=this.meshes.length||0,t=this.options.frameSize||0,i=this._paddingValue||0;switch(this.options.layout){case 0:return new n.I9(t*e+2*i*e,t+2*i);case 1:{const r=Math.max(2,Math.ceil(Math.sqrt(e))),s=t*r+2*i*r;return new n.I9(s,s)}case 2:{const r=this.options.colnum||1,s=Math.max(1,Math.ceil(e/r));return new n.I9(t*r+2*i*r,t*s+2*i*s)}}return n.I9.Zero()}_calculateMeshUVFrames(e,t,i,r,s){const o=this.meshes.length;for(let a=0;a<o;a++){const o=this.meshes[a],l=new n.I9(e/i.x,e/i.y),h=r.clone().scale(t),c=this._getFrameOffset(a).add(h),u=new Lf(a,l,c);this.frames.push(u),s&&(this._updateMeshUV(o,a),this._updateTextureReferences(o))}}_getFrameOffset(e){const t=this.meshes.length;let i,r,s;switch(this.options.layout){case 0:return i=1/t,new n.I9(e*i,0);case 1:{const o=Math.max(2,Math.ceil(Math.sqrt(t)));return r=Math.floor(e/o),s=e-r*o,i=1/o,new n.I9(s*i,r*i)}case 2:{const o=this.options.colnum||1,a=Math.max(1,Math.ceil(t/o));return s=Math.floor(e/a),r=e-s*a,i=new n.I9(1/o,1/a),new n.I9(s*i.x,r*i.y)}}return n.I9.Zero()}_updateMeshUV(e,t){const i=this.frames[t],r=e.getVerticesData(this.options.uvsIn||Ot.R.UVKind),s=[];let n=0;r.length&&(n=r.length||0);for(let e=0;e<n;e+=2)s.push(r[e]*i.scale.x+i.offset.x,r[e+1]*i.scale.y+i.offset.y);e.setVerticesData(this.options.uvsOut||Ot.R.UVKind,s)}_updateTextureReferences(e,t=!1){const i=e.material,r=Object.keys(this.sets),s=e=>{e.dispose&&e.dispose()};for(let e=0;e<r.length;e++){const n=r[e];if(t)null!==i[n]&&s(i[n]),i[n]=this.sets[n];else{if(!i)return;null!==i[n]&&(s(i[n]),i[n]=this.sets[n])}}}setMeshToFrame(e,t,i=!1){this._updateMeshUV(e,t),i&&this._updateTextureReferences(e,!0)}processAsync(){return new Promise(((e,t)=>{try{if(0===this.meshes.length)return void e();let t=0;const i=i=>{if(t++,this.options.map){for(let e=0;e<this.options.map.length;e++){null!==i[this.options.map[e]]&&(this.sets[this.options.map[e]]||(this.sets[this.options.map[e]]=!0),this._expecting++)}t===this.meshes.length&&this._createFrames(e)}};for(let r=0;r<this.meshes.length;r++){const s=this.meshes[r],n=s.material;if(n)n.forceCompilationAsync(s).then((()=>{i(n)}));else if(t++,t===this.meshes.length)return this._createFrames(e)}}catch(e){return t(e)}}))}dispose(){const e=Object.keys(this.sets);for(let t=0;t<e.length;t++){const i=e[t];this.sets[i].dispose()}}download(e="png",t=1){setTimeout((()=>{const i={name:this.name,sets:{},options:{},frames:[]},r=Object.keys(this.sets),s=Object.keys(this.options);try{for(let s=0;s<r.length;s++){const n=r[s],o=this.sets[n];i.sets[n]=o.getContext().canvas.toDataURL("image/"+e,t)}for(let e=0;e<s.length;e++){const t=s[e];i.options[t]=this.options[t]}for(let e=0;e<this.frames.length;e++){const t=this.frames[e];i.frames.push(t.scale.x,t.scale.y,t.offset.x,t.offset.y)}}catch(e){return void m.V.Warn("Unable to download: "+e)}const n="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(i,null,4)),o=document.createElement("a");o.setAttribute("href",n),o.setAttribute("download",this.name+"_texurePackage.json"),document.body.appendChild(o),o.click(),o.remove()}),0)}updateFromJSON(e){try{const t=JSON.parse(e);this.name=t.name;const i=Object.keys(t.options);for(let e=0;e<i.length;e++)this.options[i[e]]=t.options[i[e]];for(let e=0;e<t.frames.length;e+=4){const i=new Lf(e/4,new n.I9(t.frames[e],t.frames[e+1]),new n.I9(t.frames[e+2],t.frames[e+3]));this.frames.push(i)}const r=Object.keys(t.sets);for(let e=0;e<r.length;e++){const i=new $e.g(t.sets[r[e]],this.scene,!1,!1);this.sets[r[e]]=i}}catch(e){m.V.Warn("Unable to update from JSON: "+e)}}}kf.LAYOUT_STRIP=0,kf.LAYOUT_POWER2=1,kf.LAYOUT_COLNUM=2,kf.SUBUV_WRAP=0,kf.SUBUV_EXTEND=1,kf.SUBUV_COLOR=2;class Gf extends jd.p{constructor(e,t,i,r,s,n,o){super(e,i,null,r,s,n),this._animate=!0,this._time=0,this._texturePath=t,!s||s instanceof $e.g||(o=!!s.skipJson),o?this.setFragment(this._texturePath):this._loadJson(t),this.refreshRate=1}_loadJson(e){const t=()=>{try{this.setFragment(this._texturePath)}catch(e){m.V.Log("No json or ShaderStore or DOM element found for CustomProceduralTexture")}},i=e+"/config.json",r=new Kr.u;r.open("GET",i),r.addEventListener("load",(()=>{if(200===r.status||r.responseText&&r.responseText.length>0)try{this._config=JSON.parse(r.response),this.updateShaderUniforms(),this.updateTextures(),this.setFragment(this._texturePath+"/custom"),this._animate=this._config.animate,this.refreshRate=this._config.refreshrate}catch(e){t()}else t()}),!1),r.addEventListener("error",(()=>{t()}),!1);try{r.send()}catch(e){m.V.Error("CustomProceduralTexture: Error on XHR send request.")}}isReady(){if(!super.isReady())return!1;for(const e in this._textures){if(!this._textures[e].isReady())return!1}return!0}render(e){const t=this.getScene();this._animate&&t&&(this._time+=.03*t.getAnimationRatio(),this.updateShaderUniforms()),super.render(e)}updateTextures(){for(let e=0;e<this._config.sampler2Ds.length;e++)this.setTexture(this._config.sampler2Ds[e].sample2Dname,new $e.g(this._texturePath+"/"+this._config.sampler2Ds[e].textureRelativeUrl,this.getScene()))}updateShaderUniforms(){if(this._config)for(let e=0;e<this._config.uniforms.length;e++){const t=this._config.uniforms[e];switch(t.type){case"float":this.setFloat(t.name,t.value);break;case"color3":this.setColor3(t.name,new o.v9(t.r,t.g,t.b));break;case"color4":this.setColor4(t.name,new o.ov(t.r,t.g,t.b,t.a));break;case"vector2":this.setVector2(t.name,new n.I9(t.x,t.y));break;case"vector3":this.setVector3(t.name,new n.Pq(t.x,t.y,t.z))}}this.setFloat("time",this._time)}get animate(){return this._animate}set animate(e){this._animate=e}}const zf="noisePixelShader",Uf="uniform float brightness;uniform float persistence;uniform float timeScale;varying vec2 vUV;vec2 hash22(vec2 p)\n{p=p*mat2(127.1,311.7,269.5,183.3);p=-1.0+2.0*fract(sin(p)*43758.5453123);return sin(p*6.283+timeScale);}\nfloat interpolationNoise(vec2 p)\n{vec2 pi=floor(p);vec2 pf=p-pi;vec2 w=pf*pf*(3.-2.*pf);float f00=dot(hash22(pi+vec2(.0,.0)),pf-vec2(.0,.0));float f01=dot(hash22(pi+vec2(.0,1.)),pf-vec2(.0,1.));float f10=dot(hash22(pi+vec2(1.0,0.)),pf-vec2(1.0,0.));float f11=dot(hash22(pi+vec2(1.0,1.)),pf-vec2(1.0,1.));float xm1=mix(f00,f10,w.x);float xm2=mix(f01,f11,w.x);float ym=mix(xm1,xm2,w.y); \nreturn ym;}\nfloat perlinNoise2D(float x,float y)\n{float sum=0.0;float frequency=0.0;float amplitude=0.0;for(int i=0; i<OCTAVES; i++)\n{frequency=pow(2.0,float(i));amplitude=pow(persistence,float(i));sum=sum+interpolationNoise(vec2(x*frequency,y*frequency))*amplitude;}\nreturn sum;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float x=abs(vUV.x);float y=abs(vUV.y);float noise=brightness+(1.0-brightness)*perlinNoise2D(x,y);gl_FragColor=vec4(noise,noise,noise,1.0);}\n";qi.l.ShadersStore[zf]=Uf;class Wf extends jd.p{constructor(e,t=256,i=C.q.LastCreatedScene,r,s){super(e,t,"noise",i,r,s),this.time=0,this.brightness=.2,this.octaves=3,this.persistence=.8,this.animationSpeedFactor=1,this.autoClear=!1,this._updateShaderUniforms()}_updateShaderUniforms(){const e=this.getScene();e&&(this.time+=e.getAnimationRatio()*this.animationSpeedFactor*.01,this.setFloat("brightness",this.brightness),this.setFloat("persistence",this.persistence),this.setFloat("timeScale",this.time))}_getDefines(){return"#define OCTAVES "+(0|this.octaves)}render(e){this._updateShaderUniforms(),super.render(e)}serialize(){const e={customType:"BABYLON.NoiseProceduralTexture"};return e.brightness=this.brightness,e.octaves=this.octaves,e.persistence=this.persistence,e.animationSpeedFactor=this.animationSpeedFactor,e.size=this.getSize().width,e.generateMipMaps=this._generateMipMaps,e.time=this.time,e}clone(){const e=this.getSize(),t=new Wf(this.name,e.width,this.getScene(),this._fallbackTexture?this._fallbackTexture:void 0,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t.brightness=this.brightness,t.octaves=this.octaves,t.persistence=this.persistence,t.animationSpeedFactor=this.animationSpeedFactor,t.time=this.time,t}static Parse(e,t){const i=new Wf(e.name,e.size,t,void 0,e.generateMipMaps);return i.brightness=e.brightness,i.octaves=e.octaves,i.persistence=e.persistence,i.animationSpeedFactor=e.animationSpeedFactor,i.time=e.time??0,i}}(0,a.Y5)("BABYLON.NoiseProceduralTexture",Wf);var Hf=i(45384),$f=i(61094),qf=i(12462);class Yf extends $e.g{get width(){return this._texture?this._texture.width:0}get height(){return this._texture?this._texture.height:0}get depth(){return this._texture?this._texture.depth:0}constructor(e,t,i,r,s,n,o=!0,a=!1,l=$e.g.TRILINEAR_SAMPLINGMODE,h=0,c){super(null,n,!o,a),this.format=s,this._texture=n.getEngine().createRawTexture3D(e,t,i,r,s,o,a,l,null,h,c),this.is3D=!0}update(e){this._texture&&this._getEngine().updateRawTexture3D(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}}class Xf extends cr.${constructor(e,t,i,r){super(e,t,i,r,!0),this.refractionPlane=new Hr.Z(0,1,0,1),this.depth=2,this.onBeforeRenderObservable.add((()=>{this.getScene().clipPlane=this.refractionPlane})),this.onAfterRenderObservable.add((()=>{this.getScene().clipPlane=null}))}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new Xf(this.name,t.width,e,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.refractionPlane=this.refractionPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i.depth=this.depth,i}serialize(){if(!this.name)return null;const e=super.serialize();return e.mirrorPlane=this.refractionPlane.asArray(),e.depth=this.depth,e}}var jf=i(38573),Zf=i(35928);class Qf extends Zf.D{get renderTarget(){return this._renderTarget}constructor(e,t,i){super(null),this._renderTarget=null,this._engine=e,this._renderTargetOptions=i,this.resize(t)}resize(e){this._renderTarget?.dispose(),this._renderTarget=null,this._texture=null,this._size=e,this._engine&&(this._renderTarget=this._engine.createRenderTargetTexture(this._size,this._renderTargetOptions)),this._texture=this.renderTarget.texture}getInternalTexture(){return this._texture}getClassName(){return"ThinRenderTargetTexture"}dispose(e=!1){this._renderTarget?.dispose(!0),this._renderTarget=null,e||super.dispose()}}var Kf,Jf=i(60572),e_=i(14005),t_=i(17156),i_=i(86109),r_=i(55779),s_=i(92248),n_=i(50274),o_=i(94619),a_=i(18961),l_=i(858),h_=i(64972);!function(e){e[e.Uniform=0]="Uniform",e[e.Attribute=1]="Attribute",e[e.Varying=2]="Varying",e[e.Undefined=3]="Undefined"}(Kf||(Kf={}));class c_ extends Cd{constructor(e,t,i,r,s){super(e,t,i),this._blockType=r,this._blockName=s,this.needDualDirectionValidation=!0}checkCompatibilityState(e){return e instanceof c_&&e._blockName===this._blockName?0:1}createCustomInputBlock(){return[new this._blockType(this._blockName),this.name]}}class u_ extends Ed{constructor(e){super(e,gd.Vertex),this._isUnique=!0,this.registerInput("splatPosition",_d.Vector3,!1,gd.Vertex),this.registerInput("splatScale",_d.Vector2,!0,gd.Vertex),this.registerInput("world",_d.Matrix,!1,gd.Vertex),this.registerInput("view",_d.Matrix,!1,gd.Vertex),this.registerInput("projection",_d.Matrix,!1,gd.Vertex),this.registerOutput("splatVertex",_d.Vector4,gd.Vertex)}getClassName(){return"GaussianSplattingBlock"}get splatPosition(){return this._inputs[0]}get splatScale(){return this._inputs[1]}get world(){return this._inputs[2]}get view(){return this._inputs[3]}get projection(){return this._inputs[4]}get splatVertex(){return this._outputs[0]}initialize(e){e._excludeVariableName("focal"),e._excludeVariableName("invViewport")}_buildBlock(e){if(super._buildBlock(e),e.target===gd.Fragment)return;const t=`//${this.name}`;e._emitFunctionFromInclude("gaussianSplattingVertexDeclaration",t),e._emitFunctionFromInclude("gaussianSplatting",t),e._emitUniformFromString("focal",_d.Vector2),e._emitUniformFromString("invViewport",_d.Vector2),e.attributes.push(ss.R.PositionKind),e.sharedData.nodeMaterial.backFaceCulling=!1;const i=this.splatPosition,r=this.splatScale,s=this.world,n=this.view,o=this.projection,a=this.splatVertex;let l=`vec2${e.fSuffix}(1.,1.)`;r.isConnected&&(l=r.associatedVariableName);let h="position",c="";return 1===e.shaderLanguage&&(h="input.position",c=", uniforms.focal, uniforms.invViewport"),e.compilationString+=`${e._declareOutput(a)} = gaussianSplatting(${h}, ${i.associatedVariableName}, ${l}, covA, covB, ${s.associatedVariableName}, ${n.associatedVariableName}, ${o.associatedVariableName}${c});\n`,this}}(0,a.Y5)("BABYLON.GaussianSplattingBlock",u_);class d_ extends Ed{constructor(e){super(e,gd.Fragment),this._isUnique=!1,this.registerInput("splatColor",_d.Color4,!1,gd.Fragment),this.registerOutput("rgba",_d.Color4,gd.Fragment)}getClassName(){return"GaussianBlock"}get splatColor(){return this._inputs[0]}get rgba(){return this._outputs[0]}initialize(e){e._excludeVariableName("vPosition")}_buildBlock(e){if(super._buildBlock(e),e.target===gd.Vertex)return;const t=`//${this.name}`;e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e._emitFunctionFromInclude("logDepthDeclaration",t),e._emitFunctionFromInclude("fogFragmentDeclaration",t),e._emitFunctionFromInclude("gaussianSplattingFragmentDeclaration",t),e._emitVaryingFromString("vPosition",_d.Vector2);const i=this.splatColor,r=this._outputs[0];return 1===e.shaderLanguage?e.compilationString+=`${e._declareOutput(r)} = gaussianColor(${i.associatedVariableName}, input.vPosition);\n`:e.compilationString+=`${e._declareOutput(r)} = gaussianColor(${i.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.GaussianBlock",d_);var p_=i(20927);class m_ extends Ed{constructor(e){super(e,gd.Vertex),this._isUnique=!0,this.registerInput("splatIndex",_d.Float,!1,gd.Vertex),this.registerOutput("splatPosition",_d.Vector3,gd.Vertex),this.registerOutput("splatColor",_d.Color4,gd.Vertex)}getClassName(){return"SplatReaderBlock"}get splatIndex(){return this._inputs[0]}get splatPosition(){return this._outputs[0]}get splatColor(){return this._outputs[1]}initialize(e){e._excludeVariableName("covA"),e._excludeVariableName("covB"),e._excludeVariableName("vPosition"),e._excludeVariableName("covariancesATexture"),e._excludeVariableName("covariancesBTexture"),e._excludeVariableName("centersTexture"),e._excludeVariableName("colorsTexture"),e._excludeVariableName("dataTextureSize")}bind(e,t,i){if(!i)return;const r=i.getScene();p_.b.BindEffect(i,e,r)}_buildBlock(e){if(super._buildBlock(e),e.target===gd.Fragment)return;e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emit2DSampler("covariancesATexture"),e._emit2DSampler("covariancesBTexture"),e._emit2DSampler("centersTexture"),e._emit2DSampler("colorsTexture"),e._emitFunctionFromInclude("gaussianSplattingVertexDeclaration",t),e._emitFunctionFromInclude("gaussianSplatting",t),e._emitVaryingFromString("vPosition",_d.Vector2),e._emitUniformFromString("dataTextureSize",_d.Vector2);const i=this.splatIndex,r=this.splatPosition,s=this.splatColor,n=e._getFreeVariableName("splat");return 1===e.shaderLanguage?(e.compilationString+=`var ${n}: Splat = readSplat(${i.associatedVariableName}, uniforms.dataTextureSize);\n`,e.compilationString+="var covA: vec3f = splat.covA.xyz; var covB: vec3f = vec3f(splat.covA.w, splat.covB.xy);\n",e.compilationString+="vertexOutputs.vPosition = input.position;\n"):(e.compilationString+=`Splat ${n} = readSplat(${i.associatedVariableName});\n`,e.compilationString+="vec3 covA = splat.covA.xyz; vec3 covB = vec3(splat.covA.w, splat.covB.xy);\n",e.compilationString+="vPosition = position;\n"),e.compilationString+=`${e._declareOutput(r)} = ${n}.center.xyz;\n`,e.compilationString+=`${e._declareOutput(s)} = ${n}.color;\n`,this}}function f_(e){e.clear(),e.editorData=null;const t=new Fd("SplatIndex");t.setAsAttribute("splatIndex");const i=new m_("SplatReader");t.connectTo(i);const r=new u_("GaussianSplatting");i.connectTo(r);const s=new Fd("World");s.setAsSystemValue(bd.World);const n=new Ad("WorldPos");i.connectTo(n),s.connectTo(n),n.connectTo(r,{output:"xyz",input:"splatPosition"});const o=new Fd("view");o.setAsSystemValue(bd.View);const a=new Fd("Projection");a.setAsSystemValue(bd.Projection),s.connectTo(r,{input:"world"}),o.connectTo(r,{input:"view"}),a.connectTo(r,{input:"projection"});const l=new d_("Gaussian");i.connectTo(l,{input:"splatColor",output:"splatColor"});const h=new Rd("FragmentOutput");l.connectTo(h);const c=new Id("VertexOutput");r.connectTo(c),e.addOutputNode(c),e.addOutputNode(h),e._mode=Hd.GaussianSplatting}(0,a.Y5)("BABYLON.SplatReaderBlock",m_);class __ extends Ed{constructor(e){super(e,gd.Vertex),this.registerInput("matricesIndices",_d.Vector4),this.registerInput("matricesWeights",_d.Vector4),this.registerInput("matricesIndicesExtra",_d.Vector4,!0),this.registerInput("matricesWeightsExtra",_d.Vector4,!0),this.registerInput("world",_d.Matrix),this.registerOutput("output",_d.Matrix)}initialize(e){e._excludeVariableName("boneSampler"),e._excludeVariableName("boneTextureWidth"),e._excludeVariableName("mBones"),e._excludeVariableName("BonesPerMesh"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,32806)),Promise.resolve().then(i.bind(i,65470))]):await Promise.all([Promise.resolve().then(i.bind(i,69707)),Promise.resolve().then(i.bind(i,3361))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}getClassName(){return"BonesBlock"}get matricesIndices(){return this._inputs[0]}get matricesWeights(){return this._inputs[1]}get matricesIndicesExtra(){return this._inputs[2]}get matricesWeightsExtra(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}autoConfigure(e,t=()=>!0){if(!this.matricesIndices.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"matricesIndices"===e.name&&t(e)));i||(i=new Fd("matricesIndices"),i.setAsAttribute("matricesIndices")),i.output.connectTo(this.matricesIndices)}if(!this.matricesWeights.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"matricesWeights"===e.name&&t(e)));i||(i=new Fd("matricesWeights"),i.setAsAttribute("matricesWeights")),i.output.connectTo(this.matricesWeights)}if(!this.world.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===bd.World&&t(e)));i||(i=new Fd("world"),i.setAsSystemValue(bd.World)),i.output.connectTo(this.world)}}provideFallbacks(e,t){e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton&&t.addCPUSkinningFallback(0,e)}bind(e,t,i){(0,ts.f$)(i,e)}prepareDefines(e,t,i){i._areAttributesDirty&&(0,ts.IC)(e,i)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithFallbacks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.uniforms.push("boneTextureWidth"),e.uniforms.push("mBones"),e.samplers.push("boneSampler");const t=`//${this.name}`;e._emitFunctionFromInclude("bonesDeclaration",t,{removeAttributes:!0,removeUniforms:!1,removeVaryings:!0,removeIfDef:!1});const i=e._getFreeVariableName("influence");e.compilationString+=e._emitCodeFromInclude("bonesVertex",t,{replaceStrings:[{search:/finalWorld=finalWorld\*influence;/,replace:""},{search:/influence/gm,replace:i}]});const r=this._outputs[0],s=this.world;return e.compilationString+="#if NUM_BONE_INFLUENCERS>0\n",e.compilationString+=e._declareOutput(r)+` = ${s.associatedVariableName} * ${i};\n`,e.compilationString+="#else\n",e.compilationString+=e._declareOutput(r)+` = ${s.associatedVariableName};\n`,e.compilationString+="#endif\n",this}}(0,a.Y5)("BABYLON.BonesBlock",__);class g_ extends Ed{constructor(e){super(e,gd.Vertex),this.registerInput("world0",_d.Vector4),this.registerInput("world1",_d.Vector4),this.registerInput("world2",_d.Vector4),this.registerInput("world3",_d.Vector4),this.registerInput("world",_d.Matrix,!0),this.registerOutput("output",_d.Matrix),this.registerOutput("instanceID",_d.Float)}getClassName(){return"InstancesBlock"}get world0(){return this._inputs[0]}get world1(){return this._inputs[1]}get world2(){return this._inputs[2]}get world3(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}get instanceID(){return this._outputs[1]}autoConfigure(e,t=()=>!0){if(!this.world0.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world0"===e.name&&t(e)));i||(i=new Fd("world0"),i.setAsAttribute("world0")),i.output.connectTo(this.world0)}if(!this.world1.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world1"===e.name&&t(e)));i||(i=new Fd("world1"),i.setAsAttribute("world1")),i.output.connectTo(this.world1)}if(!this.world2.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world2"===e.name&&t(e)));i||(i=new Fd("world2"),i.setAsAttribute("world2")),i.output.connectTo(this.world2)}if(!this.world3.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world3"===e.name&&t(e)));i||(i=new Fd("world3"),i.setAsAttribute("world3")),i.output.connectTo(this.world3)}if(!this.world.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world"===e.name&&t(e)));i||(i=new Fd("world"),i.setAsSystemValue(bd.World)),i.output.connectTo(this.world)}this.world.define="!INSTANCES || THIN_INSTANCES"}prepareDefines(e,t,i,r=!1,s){let n=!1;i.INSTANCES!==r&&(i.setValue("INSTANCES",r),n=!0),s&&i.THIN_INSTANCES!==!!s?.getRenderingMesh().hasThinInstances&&(i.setValue("THIN_INSTANCES",!!s?.getRenderingMesh().hasThinInstances),n=!0),n&&i.markAsUnprocessed()}_buildBlock(e){super._buildBlock(e);const t=e.sharedData.scene.getEngine();e.sharedData.blocksWithDefines.push(this);const i=this._outputs[0],r=this._outputs[1],s=this.world0,n=this.world1,o=this.world2,a=this.world3;let l="mat4",h="gl_InstanceID",c="float";return 1===e.shaderLanguage&&(l="mat4x4f",h="vertexInputs.instanceIndex",c="f32"),e.compilationString+="#ifdef INSTANCES\n",e.compilationString+=e._declareOutput(i)+` = ${l}(${s.associatedVariableName}, ${n.associatedVariableName}, ${o.associatedVariableName}, ${a.associatedVariableName});\n`,e.compilationString+="#ifdef THIN_INSTANCES\n",e.compilationString+=`${i.associatedVariableName} = ${this.world.associatedVariableName} * ${i.associatedVariableName};\n`,e.compilationString+="#endif\n",t._caps.canUseGLInstanceID?e.compilationString+=e._declareOutput(r)+` = ${c}(${h});\n`:e.compilationString+=e._declareOutput(r)+" = 0.0;\n",e.compilationString+="#else\n",e.compilationString+=e._declareOutput(i)+` = ${this.world.associatedVariableName};\n`,e.compilationString+=e._declareOutput(r)+" = 0.0;\n",e.compilationString+="#endif\n",this}}(0,a.Y5)("BABYLON.InstancesBlock",g_);class x_ extends Ed{constructor(e){super(e,gd.Vertex),this.registerInput("position",_d.Vector3),this.registerInput("normal",_d.Vector3),this.registerInput("tangent",_d.AutoDetect),this.tangent.addExcludedConnectionPointFromAllowedTypes(_d.Color4|_d.Vector4|_d.Vector3),this.registerInput("uv",_d.Vector2),this.registerInput("uv2",_d.Vector2),this.registerInput("color",_d.Color4),this.registerOutput("positionOutput",_d.Vector3),this.registerOutput("normalOutput",_d.Vector3),this.registerOutput("tangentOutput",_d.Vector4),this.registerOutput("uvOutput",_d.Vector2),this.registerOutput("uv2Output",_d.Vector2),this.registerOutput("colorOutput",_d.Color4)}getClassName(){return"MorphTargetsBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get tangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get uv2(){return this._inputs[4]}get color(){return this._inputs[5]}get positionOutput(){return this._outputs[0]}get normalOutput(){return this._outputs[1]}get tangentOutput(){return this._outputs[2]}get uvOutput(){return this._outputs[3]}get uv2Output(){return this._outputs[4]}get colorOutput(){return this._outputs[5]}initialize(e){e._excludeVariableName("morphTargetInfluences"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,9129)),Promise.resolve().then(i.bind(i,8217)),Promise.resolve().then(i.bind(i,18258)),Promise.resolve().then(i.bind(i,76340))]):await Promise.all([Promise.resolve().then(i.bind(i,15060)),Promise.resolve().then(i.bind(i,90738)),Promise.resolve().then(i.bind(i,48451)),Promise.resolve().then(i.bind(i,27999))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.position.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"position"===e.name&&t(e)));i||(i=new Fd("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.normal.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"normal"===e.name&&t(e)));i||(i=new Fd("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"tangent"===e.name&&t(e)));i||(i=new Fd("tangent"),i.setAsAttribute("tangent")),i.output.connectTo(this.tangent)}if(!this.uv.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"uv"===e.name&&t(e)));i||(i=new Fd("uv"),i.setAsAttribute("uv")),i.output.connectTo(this.uv)}if(!this.uv2.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"uv2"===e.name&&t(e)));i||(i=new Fd("uv2"),i.setAsAttribute("uv2")),i.output.connectTo(this.uv2)}if(!this.color.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"color"===e.name&&t(e)));i||(i=new Fd("color"),i.setAsAttribute("color")),i.output.connectTo(this.color)}}prepareDefines(e,t,i){if(e.morphTargetManager){const t=e.morphTargetManager;t?.isUsingTextureForTargets&&(t.numMaxInfluencers||t.numInfluencers)!==i.NUM_MORPH_INFLUENCERS&&i.markAsAttributesDirty()}i._areAttributesDirty&&(0,ts.Jz)(e,i)}bind(e,t,i){i&&i.morphTargetManager&&i.morphTargetManager.numInfluencers>0&&((0,ts.nR)(i,e),i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(e))}replaceRepeatableContent(e,t,i,r){const s=this.position,n=this.normal,o=this.tangent,a=this.uv,l=this.uv2,h=this.color,c=this.positionOutput,u=this.normalOutput,d=this.tangentOutput,p=this.uvOutput,m=this.uv2Output,f=this.colorOutput,_=e,g=r.NUM_MORPH_INFLUENCERS,x=i.morphTargetManager,v=x&&x.supportsPositions,S=x&&x.supportsNormals,b=x&&x.supportsTangents,y=x&&x.supportsUVs,P=x&&x.supportsUV2s,T=x&&x.supportsColors;let C="";x?.isUsingTextureForTargets&&g>0&&(C+=`${_._declareLocalVar("vertexID",_d.Float)};\n`),C+="#ifdef MORPHTARGETS\n";const E=1===_.shaderLanguage,A=E?"uniforms.":"";if(x?.isUsingTextureForTargets)C+=`for (${E?"var":"int"} i = 0; i < NUM_MORPH_INFLUENCERS; i++) {\n`,C+=`if (i >= ${A}morphTargetCount) { break; }\n`,C+=`vertexID = ${E?"f32(vertexInputs.vertexIndex":"float(gl_VertexID"}) * ${A}morphTargetTextureInfo.x;\n`,v&&(C+="#ifdef MORPHTARGETS_POSITION\n",C+=`${c.associatedVariableName} += (readVector3FromRawSampler(i, vertexID) - ${s.associatedVariableName}) * ${A}morphTargetInfluences[i];\n`,C+="#endif\n"),C+="#ifdef MORPHTARGETTEXTURE_HASPOSITIONS\n",C+="vertexID += 1.0;\n",C+="#endif\n",S&&(C+="#ifdef MORPHTARGETS_NORMAL\n",C+=`${u.associatedVariableName} += (readVector3FromRawSampler(i, vertexID) - ${n.associatedVariableName}) * ${A}morphTargetInfluences[i];\n`,C+="#endif\n"),C+="#ifdef MORPHTARGETTEXTURE_HASNORMALS\n",C+="vertexID += 1.0;\n",C+="#endif\n",y&&(C+="#ifdef MORPHTARGETS_UV\n",C+=`${p.associatedVariableName} += (readVector3FromRawSampler(i, vertexID).xy - ${a.associatedVariableName}) * ${A}morphTargetInfluences[i];\n`,C+="#endif\n"),C+="#ifdef MORPHTARGETTEXTURE_HASUVS\n",C+="vertexID += 1.0;\n",C+="#endif\n",b&&(C+="#ifdef MORPHTARGETS_TANGENT\n",C+=`${d.associatedVariableName}.xyz += (readVector3FromRawSampler(i, vertexID) - ${o.associatedVariableName}.xyz) * ${A}morphTargetInfluences[i];\n`,o.type===_d.Vector4?C+=`${d.associatedVariableName}.w = ${o.associatedVariableName}.w;\n`:C+=`${d.associatedVariableName}.w = 1.;\n`,C+="#endif\n"),C+="#ifdef MORPHTARGETTEXTURE_HASTANGENTS\n",C+="vertexID += 1.0;\n",C+="#endif\n",P&&(C+="#ifdef MORPHTARGETS_UV2\n",C+=`${m.associatedVariableName} += (readVector3FromRawSampler(i, vertexID).xy - ${l.associatedVariableName}) * morphTargetInfluences[i];\n`,C+="#endif\n"),C+="#ifdef MORPHTARGETTEXTURE_HASUV2S\n",C+="vertexID += 1.0;\n",C+="#endif\n",T&&(C+="#ifdef MORPHTARGETS_COLOR\n",C+=`${f.associatedVariableName} += (readVector4FromRawSampler(i, vertexID) - ${h.associatedVariableName}) * ${A}morphTargetInfluences[i];\n`,C+="#endif\n"),C+="}\n";else for(let e=0;e<g;e++)v&&(C+="#ifdef MORPHTARGETS_POSITION\n",C+=`${c.associatedVariableName} += (position${e} - ${s.associatedVariableName}) * ${A}morphTargetInfluences[${e}];\n`,C+="#endif\n"),S&&r.NORMAL&&(C+="#ifdef MORPHTARGETS_NORMAL\n",C+=`${u.associatedVariableName} += (normal${e} - ${n.associatedVariableName}) * ${A}morphTargetInfluences[${e}];\n`,C+="#endif\n"),y&&r.UV1&&(C+="#ifdef MORPHTARGETS_UV\n",C+=`${p.associatedVariableName}.xy += (uv_${e} - ${a.associatedVariableName}.xy) * ${A}morphTargetInfluences[${e}];\n`,C+="#endif\n"),b&&r.TANGENT&&(C+="#ifdef MORPHTARGETS_TANGENT\n",C+=`${d.associatedVariableName}.xyz += (tangent${e} - ${o.associatedVariableName}.xyz) * ${A}morphTargetInfluences[${e}];\n`,o.type===_d.Vector4?C+=`${d.associatedVariableName}.w = ${o.associatedVariableName}.w;\n`:C+=`${d.associatedVariableName}.w = 1.;\n`,C+="#endif\n"),P&&r.UV2&&(C+="#ifdef MORPHTARGETS_UV2\n",C+=`${m.associatedVariableName}.xy += (uv2_${e} - ${l.associatedVariableName}.xy) * morphTargetInfluences[${e}];\n`,C+="#endif\n"),T&&r.VERTEXCOLOR_NME&&(C+="#ifdef MORPHTARGETS_COLOR\n",C+=`${f.associatedVariableName} += (color${e} - ${h.associatedVariableName}) * ${A}morphTargetInfluences[${e}];\n`,C+="#endif\n");if(C+="#endif\n",_.compilationString=_.compilationString.replace(this._repeatableContentAnchor,C),g>0)for(let e=0;e<g;e++)v&&_.attributes.push(Ot.R.PositionKind+e),S&&r.NORMAL&&_.attributes.push(Ot.R.NormalKind+e),b&&r.TANGENT&&_.attributes.push(Ot.R.TangentKind+e),y&&r.UV1&&_.attributes.push(Ot.R.UVKind+"_"+e),P&&r.UV2&&_.attributes.push(Ot.R.UV2Kind+"_"+e),T&&r.VERTEXCOLOR_NME&&_.attributes.push(Ot.R.ColorKind+e)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e.sharedData.repeatableContentBlocks.push(this);const t=this.position,i=this.normal,r=this.tangent,s=this.uv,n=this.uv2,o=this.color,a=this.positionOutput,l=this.normalOutput,h=this.tangentOutput,c=this.uvOutput,u=this.uv2Output,d=this.colorOutput,p=`//${this.name}`;return e.uniforms.push("morphTargetInfluences"),e.uniforms.push("morphTargetCount"),e.uniforms.push("morphTargetTextureInfo"),e.uniforms.push("morphTargetTextureIndices"),e.samplers.push("morphTargets"),e._emitFunctionFromInclude("morphTargetsVertexGlobalDeclaration",p),e._emitFunctionFromInclude("morphTargetsVertexDeclaration",p,{repeatKey:"maxSimultaneousMorphTargets"}),e.compilationString+=`${e._declareOutput(a)} = ${t.associatedVariableName};\n`,e.compilationString+="#ifdef NORMAL\n",e.compilationString+=`${e._declareOutput(l)} = ${i.associatedVariableName};\n`,e.compilationString+="#else\n",e.compilationString+=`${e._declareOutput(l)} = vec3(0., 0., 0.);\n`,e.compilationString+="#endif\n",e.compilationString+="#ifdef TANGENT\n",e.compilationString+=`${e._declareOutput(h)} = ${r.associatedVariableName};\n`,e.compilationString+="#else\n",e.compilationString+=`${e._declareOutput(h)} = vec4(0., 0., 0., 0.);\n`,e.compilationString+="#endif\n",e.compilationString+="#ifdef UV1\n",e.compilationString+=`${e._declareOutput(c)} = ${s.associatedVariableName};\n`,e.compilationString+="#else\n",e.compilationString+=`${e._declareOutput(c)} = vec2(0., 0.);\n`,e.compilationString+="#endif\n",e.compilationString+="#ifdef UV2\n",e.compilationString+=`${e._declareOutput(u)} = ${n.associatedVariableName};\n`,e.compilationString+="#else\n",e.compilationString+=`${e._declareOutput(u)} = vec2(0., 0.);\n`,e.compilationString+="#endif\n",e.compilationString+="#ifdef VERTEXCOLOR_NME\n",e.compilationString+=`${e._declareOutput(d)} = ${o.associatedVariableName};\n`,e.compilationString+="#else\n",e.compilationString+=`${e._declareOutput(d)} = vec4(0., 0., 0., 0.);\n`,e.compilationString+="#endif\n",this._repeatableContentAnchor=e._repeatableContentAnchor,e.compilationString+=this._repeatableContentAnchor,this}}(0,a.Y5)("BABYLON.MorphTargetsBlock",x_);class v_ extends Ed{constructor(e){super(e,gd.Vertex),this.registerInput("worldPosition",_d.Vector4,!1,gd.Vertex),this.registerOutput("direction",_d.Vector3),this.registerOutput("color",_d.Color3),this.registerOutput("intensity",_d.Float),this.registerOutput("shadowBias",_d.Float),this.registerOutput("shadowNormalBias",_d.Float),this.registerOutput("shadowDepthScale",_d.Float),this.registerOutput("shadowDepthRange",_d.Vector2)}getClassName(){return"LightInformationBlock"}get worldPosition(){return this._inputs[0]}get direction(){return this._outputs[0]}get color(){return this._outputs[1]}get intensity(){return this._outputs[2]}get shadowBias(){return this._outputs[3]}get shadowNormalBias(){return this._outputs[4]}get shadowDepthScale(){return this._outputs[5]}get shadowDepthRange(){return this._outputs[6]}bind(e,t,i){if(!i)return;this.light&&this.light.isDisposed()&&(this.light=null);let r=this.light;const s=t.getScene();if(!r&&s.lights.length&&(r=this.light=s.lights[0],this._forcePrepareDefines=!0),!r||!r.isEnabled)return e.setFloat3(this._lightDataUniformName,0,0,0),void e.setFloat4(this._lightColorUniformName,0,0,0,0);r.transferToNodeMaterialEffect(e,this._lightDataUniformName),e.setColor4(this._lightColorUniformName,r.diffuse,r.intensity);const n=r.getShadowGenerator();if((this.shadowBias.hasEndpoints||this.shadowNormalBias.hasEndpoints||this.shadowDepthScale.hasEndpoints)&&(n?e.setFloat3(this._lightShadowUniformName,n.bias,n.normalBias,n.depthScale):e.setFloat3(this._lightShadowUniformName,0,0,0)),this.shadowDepthRange)if(n&&s.activeCamera){const t=r;e.setFloat2(this._lightShadowExtraUniformName,t.getDepthMinZ(s.activeCamera),t.getDepthMinZ(s.activeCamera)+t.getDepthMaxZ(s.activeCamera))}else e.setFloat2(this._lightShadowExtraUniformName,0,0)}prepareDefines(e,t,i){if(!i._areLightsDirty&&!this._forcePrepareDefines)return;this._forcePrepareDefines=!1;const r=this.light;i.setValue(this._lightTypeDefineName,!!(r&&r instanceof cm.H),!0)}_buildBlock(e){super._buildBlock(e),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const t=this.direction,i=this.color,r=this.intensity,s=this.shadowBias,n=this.shadowNormalBias,o=this.shadowDepthScale,a=this.shadowDepthRange;this._lightDataUniformName=e._getFreeVariableName("lightData"),this._lightColorUniformName=e._getFreeVariableName("lightColor"),this._lightShadowUniformName=e._getFreeVariableName("shadowData"),this._lightShadowExtraUniformName=e._getFreeVariableName("shadowExtraData"),this._lightTypeDefineName=e._getFreeDefineName("LIGHTPOINTTYPE");const l=1===e.shaderLanguage?"uniforms.":"";return e._emitUniformFromString(this._lightDataUniformName,_d.Vector3),e._emitUniformFromString(this._lightColorUniformName,_d.Vector4),e.compilationString+=`#ifdef ${this._lightTypeDefineName}\n`,e.compilationString+=e._declareOutput(t)+` = normalize(${this.worldPosition.associatedVariableName}.xyz - ${l}${this._lightDataUniformName});\n`,e.compilationString+="#else\n",e.compilationString+=e._declareOutput(t)+` = ${l}${this._lightDataUniformName};\n`,e.compilationString+="#endif\n",e.compilationString+=e._declareOutput(i)+` = ${l}${this._lightColorUniformName}.rgb;\n`,e.compilationString+=e._declareOutput(r)+` = ${l}${this._lightColorUniformName}.a;\n`,(s.hasEndpoints||n.hasEndpoints||o.hasEndpoints)&&(e._emitUniformFromString(this._lightShadowUniformName,_d.Vector3),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${l}${this._lightShadowUniformName}.x;\n`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${l}${this._lightShadowUniformName}.y;\n`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${l}${this._lightShadowUniformName}.z;\n`)),a.hasEndpoints&&(e._emitUniformFromString(this._lightShadowExtraUniformName,_d.Vector2),e.compilationString+=e._declareOutput(a)+` = ${this._lightShadowUniformName};\n`),this}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId))}}(0,a.Y5)("BABYLON.LightInformationBlock",v_);var S_=i(32806),b_=i(65470),y_=i(69707),P_=i(3361),T_=i(9129),C_=i(8217),E_=i(18258),A_=i(76340),I_=i(15060),R_=i(90738),M_=i(48451),D_=i(27999);class O_ extends Ed{constructor(e){super(e,gd.Fragment),this.convertInputToLinearSpace=!0,this.registerInput("color",_d.AutoDetect),this.registerOutput("output",_d.Color4),this.registerOutput("rgb",_d.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(_d.Color3|_d.Color4|_d.Vector3|_d.Vector4)}getClassName(){return"ImageProcessingBlock"}get color(){return this._inputs[0]}get output(){return this._outputs[0]}get rgb(){return this._outputs[1]}initialize(e){e._excludeVariableName("exposureLinear"),e._excludeVariableName("contrast"),e._excludeVariableName("vInverseScreenSize"),e._excludeVariableName("vignetteSettings1"),e._excludeVariableName("vignetteSettings2"),e._excludeVariableName("vCameraColorCurveNegative"),e._excludeVariableName("vCameraColorCurveNeutral"),e._excludeVariableName("vCameraColorCurvePositive"),e._excludeVariableName("txColorTransform"),e._excludeVariableName("colorTransformSettings"),e._excludeVariableName("ditherIntensity"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,79702)),Promise.resolve().then(i.bind(i,16205)),Promise.resolve().then(i.bind(i,88996))]):await Promise.all([Promise.resolve().then(i.bind(i,73325)),Promise.resolve().then(i.bind(i,89392)),Promise.resolve().then(i.bind(i,64017))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}isReady(e,t,i){return!(i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}prepareDefines(e,t,i){i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i)}bind(e,t,i){i&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),e.sharedData.bindableBlocks.push(this),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity");const t=this.color,i=this._outputs[0],r=`//${this.name}`,s=1===e.shaderLanguage?"Vec3":"";return e._emitFunctionFromInclude("helperFunctions",r),e._emitFunctionFromInclude("imageProcessingDeclaration",r),e._emitFunctionFromInclude("imageProcessingFunctions",r),t.connectedPoint?.isConnected&&(t.connectedPoint.type===_d.Color4||t.connectedPoint.type===_d.Vector4?e.compilationString+=`${e._declareOutput(i)} = ${t.associatedVariableName};\n`:e.compilationString+=`${e._declareOutput(i)} = vec4${e.fSuffix}(${t.associatedVariableName}, 1.0);\n`,e.compilationString+="#ifdef IMAGEPROCESSINGPOSTPROCESS\n",this.convertInputToLinearSpace&&(e.compilationString+=`${i.associatedVariableName} = vec4${e.fSuffix}(toLinearSpace${s}(${t.associatedVariableName}.rgb), ${t.associatedVariableName}.a);\n`),e.compilationString+="#else\n",e.compilationString+="#ifdef IMAGEPROCESSING\n",this.convertInputToLinearSpace&&(e.compilationString+=`${i.associatedVariableName} = vec4${e.fSuffix}(toLinearSpace${s}(${t.associatedVariableName}.rgb), ${t.associatedVariableName}.a);\n`),e.compilationString+=`${i.associatedVariableName} = applyImageProcessing(${i.associatedVariableName});\n`,e.compilationString+="#endif\n",e.compilationString+="#endif\n",this.rgb.hasEndpoints&&(e.compilationString+=e._declareOutput(this.rgb)+` = ${this.output.associatedVariableName}.xyz;\n`)),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertInputToLinearSpace = ${this.convertInputToLinearSpace};\n`,e}serialize(){const e=super.serialize();return e.convertInputToLinearSpace=this.convertInputToLinearSpace,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertInputToLinearSpace=e.convertInputToLinearSpace??!0}}(0,Ge.Cg)([xh("Convert input to linear space",0,"ADVANCED")],O_.prototype,"convertInputToLinearSpace",void 0),(0,a.Y5)("BABYLON.ImageProcessingBlock",O_);class N_ extends Ed{constructor(e){super(e,gd.Fragment,!0),this.registerInput("normal",_d.AutoDetect,!1),this.normal.addExcludedConnectionPointFromAllowedTypes(_d.Color4|_d.Vector4|_d.Vector3),this.registerInput("tangent",_d.Vector4,!1),this.registerInput("world",_d.Matrix,!1),this.registerOutput("TBN",_d.Object,gd.Fragment,new c_("TBN",this,1,N_,"TBNBlock")),this.registerOutput("row0",_d.Vector3,gd.Fragment),this.registerOutput("row1",_d.Vector3,gd.Fragment),this.registerOutput("row2",_d.Vector3,gd.Fragment)}getClassName(){return"TBNBlock"}initialize(e){e._excludeVariableName("tbnNormal"),e._excludeVariableName("tbnTangent"),e._excludeVariableName("tbnBitangent"),e._excludeVariableName("TBN")}get normal(){return this._inputs[0]}get tangent(){return this._inputs[1]}get world(){return this._inputs[2]}get TBN(){return this._outputs[0]}get row0(){return this._outputs[1]}get row1(){return this._outputs[2]}get row2(){return this._outputs[3]}get target(){return gd.Fragment}set target(e){}autoConfigure(e,t=()=>!0){if(!this.world.isConnected){let i=e.getInputBlockByPredicate((e=>e.isSystemValue&&e.systemValue===bd.World&&t(e)));i||(i=new Fd("world"),i.setAsSystemValue(bd.World)),i.output.connectTo(this.world)}if(!this.normal.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"normal"===e.name&&t(e)));i||(i=new Fd("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"tangent"===e.name&&e.type===_d.Vector4&&t(e)));i||(i=new Fd("tangent"),i.setAsAttribute("tangent")),i.output.connectTo(this.tangent)}}prepareDefines(e,t,i){const r=this.normal,s=this.tangent;let n=r.isConnected;r.connectInputBlock?.isAttribute&&!e.isVerticesDataPresent(r.connectInputBlock?.name)&&(n=!1);let o=s.isConnected;s.connectInputBlock?.isAttribute&&!e.isVerticesDataPresent(s.connectInputBlock?.name)&&(o=!1);const a=n&&o;i.setValue("TBNBLOCK",a,!0)}_buildBlock(e){super._buildBlock(e);const t=this.normal,i=this.tangent,r=this.world,s=this.TBN,n=this.row0,o=this.row1,a=this.row2,l=1===e.shaderLanguage,h=l?"mat3x3f":"mat3",c=l?"f":"";return e.target===gd.Fragment&&(e.compilationString+=`\n                // ${this.name}\n                ${e._declareLocalVar("tbnNormal",_d.Vector3)} = normalize(${t.associatedVariableName}).xyz;\n                ${e._declareLocalVar("tbnTangent",_d.Vector3)} = normalize(${i.associatedVariableName}.xyz);\n                ${e._declareLocalVar("tbnBitangent",_d.Vector3)} = cross(tbnNormal, tbnTangent) * ${i.associatedVariableName}.w;\n                ${l?"var":"mat3"} ${s.associatedVariableName} = ${h}(${r.associatedVariableName}[0].xyz, ${r.associatedVariableName}[1].xyz, ${r.associatedVariableName}[2].xyz) * ${h}(tbnTangent, tbnBitangent, tbnNormal);\n            `,n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = vec3${c}(${s.associatedVariableName}[0][0], ${s.associatedVariableName}[0][1], ${s.associatedVariableName}[0][2]);\n`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = vec3${c}(${s.associatedVariableName}[1[0], ${s.associatedVariableName}[1][1], ${s.associatedVariableName}[1][2]);\n`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = vec3${c}(${s.associatedVariableName}[2][0], ${s.associatedVariableName}[2][1], ${s.associatedVariableName}[2][2]);\n`),e.sharedData.blocksWithDefines.push(this)),this}}(0,a.Y5)("BABYLON.TBNBlock",N_);class w_ extends Ed{constructor(e){super(e,gd.Fragment),this._tangentSpaceParameterName="",this._tangentCorrectionFactorName="",this._worldMatrixName="",this.invertX=!1,this.invertY=!1,this.useParallaxOcclusion=!1,this.useObjectSpaceNormalMap=!1,this._isUnique=!0,this.registerInput("worldPosition",_d.Vector4,!1),this.registerInput("worldNormal",_d.Vector4,!1),this.registerInput("worldTangent",_d.Vector4,!0),this.registerInput("uv",_d.Vector2,!1),this.registerInput("normalMapColor",_d.Color3,!1),this.registerInput("strength",_d.Float,!1),this.registerInput("viewDirection",_d.Vector3,!0),this.registerInput("parallaxScale",_d.Float,!0),this.registerInput("parallaxHeight",_d.Float,!0),this.registerInput("TBN",_d.Object,!0,gd.VertexAndFragment,new c_("TBN",this,0,N_,"TBNBlock")),this.registerInput("world",_d.Matrix,!0),this.registerOutput("output",_d.Vector4),this.registerOutput("uvOffset",_d.Vector2)}getClassName(){return"PerturbNormalBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get worldTangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get normalMapColor(){return this._inputs[4]}get strength(){return this._inputs[5]}get viewDirection(){return this._inputs[6]}get parallaxScale(){return this._inputs[7]}get parallaxHeight(){return this._inputs[8]}get TBN(){return this._inputs[9]}get world(){return this._inputs[10]}get output(){return this._outputs[0]}get uvOffset(){return this._outputs[1]}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,20727)),Promise.resolve().then(i.bind(i,15697)),Promise.resolve().then(i.bind(i,91258))]):await Promise.all([Promise.resolve().then(i.bind(i,27018)),Promise.resolve().then(i.bind(i,17494)),Promise.resolve().then(i.bind(i,8269))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}prepareDefines(e,t,i){const r=this.normalMapColor.connectedPoint._ownerBlock.samplerName,s=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&r||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected);i.setValue("BUMP",!0),i.setValue("PARALLAX",s,!0),i.setValue("PARALLAX_RHS",t.getScene().useRightHandedSystem,!0),i.setValue("PARALLAXOCCLUSION",this.useParallaxOcclusion,!0),i.setValue("OBJECTSPACE_NORMALMAP",this.useObjectSpaceNormalMap,!0)}bind(e,t,i){t.getScene()._mirroredCameraPosition?e.setFloat2(this._tangentSpaceParameterName,this.invertX?1:-1,this.invertY?1:-1):e.setFloat2(this._tangentSpaceParameterName,this.invertX?-1:1,this.invertY?-1:1),i&&(e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1),this.useObjectSpaceNormalMap&&!this.world.isConnected&&e.setMatrix(this._worldMatrixName,i.getWorldMatrix()))}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"uv"===e.name&&t(e)));i||(i=new Fd("uv"),i.setAsAttribute()),i.output.connectTo(this.uv)}if(!this.strength.isConnected){const e=new Fd("strength");e.value=1,e.output.connectTo(this.strength)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`,i=this.uv,r=this.worldPosition,s=this.worldNormal,n=this.worldTangent,o=1===e.shaderLanguage,a=o?"mat3x3f":"mat3",l=o?"f":"",h=o?"uniforms.":"";e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentSpaceParameterName=e._getFreeDefineName("tangentSpaceParameter"),e._emitUniformFromString(this._tangentSpaceParameterName,_d.Vector2),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,_d.Float),this._worldMatrixName=e._getFreeDefineName("perturbNormalWorldMatrix"),e._emitUniformFromString(this._worldMatrixName,_d.Matrix);let c=null;this.normalMapColor.connectedPoint&&(c=this.normalMapColor.connectedPoint._ownerBlock.samplerName);const u=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&c||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected),d=this.parallaxScale.isConnectedToInputBlock?this.parallaxScale.connectInputBlock.isConstant?e._emitFloat(this.parallaxScale.connectInputBlock.value):this.parallaxScale.associatedVariableName:"0.05",p=this.strength.isConnectedToInputBlock&&this.strength.connectInputBlock.isConstant?`\n#if !defined(NORMALXYSCALE)\n1.0/\n#endif\n${e._emitFloat(this.strength.connectInputBlock.value)}`:`\n#if !defined(NORMALXYSCALE)\n1.0/\n#endif\n${this.strength.associatedVariableName}`;o||e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const m={search:/defined\(TANGENT\)/g,replace:n.isConnected?"defined(TANGENT)":"defined(IGNORE)"},f=this.TBN;f.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n            ${o?"var":"mat3"} vTBN = ${f.associatedVariableName};\n            #endif\n            `:n.isConnected&&(e.compilationString+=`${e._declareLocalVar("tbnNormal",_d.Vector3)} = normalize(${s.associatedVariableName}.xyz);\n`,e.compilationString+=`${e._declareLocalVar("tbnTangent",_d.Vector3)} = normalize(${n.associatedVariableName}.xyz);\n`,e.compilationString+=`${e._declareLocalVar("tbnBitangent",_d.Vector3)} = cross(tbnNormal, tbnTangent) * ${o?"uniforms.":""}${this._tangentCorrectionFactorName};\n`,e.compilationString+=`${o?"var":"mat3"} vTBN = ${a}(tbnTangent, tbnBitangent, tbnNormal);\n`);let _=[m,{search:/varying mat3 vTBN;/g,replace:""},{search:/uniform mat4 normalMatrix;/g,replace:""}];o&&(_.push({search:/varying vTBN0: vec3f;/g,replace:""}),_.push({search:/varying vTBN1: vec3f;/g,replace:""}),_.push({search:/varying vTBN2: vec3f;/g,replace:""})),e._emitFunctionFromInclude("bumpFragmentMainFunctions",t,{replaceStrings:_});const g=o?"fn parallaxOcclusion(vViewDirCoT: vec3f, vNormalCoT: vec3f, texCoord: vec2f, parallaxScale:f32, bump: texture_2d<f32>, bumpSampler: sampler)":"#define inline\nvec2 parallaxOcclusion(vec3 vViewDirCoT, vec3 vNormalCoT, vec2 texCoord, float parallaxScale, sampler2D bumpSampler)",x=o?/fn parallaxOcclusion\(vViewDirCoT: vec3f,vNormalCoT: vec3f,texCoord: vec2f,parallaxScale: f32\)/g:/vec2 parallaxOcclusion\(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale\)/g,v=o?"fn parallaxOffset(viewDir: vec3f, heightScale: f32, height_: f32)":"vec2 parallaxOffset(vec3 viewDir, float heightScale, float height_)",S=o?/fn parallaxOffset\(viewDir: vec3f,heightScale: f32\)/g:/vec2 parallaxOffset\(vec3 viewDir,float heightScale\)/g;e._emitFunctionFromInclude("bumpFragmentFunctions",t,{replaceStrings:[{search:/#include<samplerFragmentDeclaration>\(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump\)/g,replace:""},{search:/uniform sampler2D bumpSampler;/g,replace:""},{search:x,replace:g},{search:S,replace:v},{search:/texture.+?bumpSampler,vBumpUV\)\.w/g,replace:"height_"}]});const b=u&&c?`${o?`textureSample(${c}, ${c+"Sampler"}`:`texture2D(${c}`}, ${i.associatedVariableName} + uvOffset).xyz`:this.normalMapColor.associatedVariableName,y=e._getFreeVariableName("tempOutput");return e.compilationString+=e._declareLocalVar(y,_d.Vector3)+` = vec3${l}(0.);\n`,_=[{search:new RegExp(`texture.+?bumpSampler${o?"Sampler,fragmentInputs.":","}vBumpUV\\)`,"g"),replace:`${b}`},{search:/#define CUSTOM_FRAGMENT_BUMP_FRAGMENT/g,replace:`${e._declareLocalVar("normalMatrix",_d.Matrix)} = toNormalMatrix(${this.world.isConnected?this.world.associatedVariableName:this._worldMatrixName});`},{search:new RegExp(`perturbNormal\\(TBN,texture.+?bumpSampler${o?"Sampler,fragmentInputs.":","}vBumpUV\\+uvOffset\\).xyz,${o?"uniforms.":""}vBumpInfos.y\\)`,"g"),replace:`perturbNormal(TBN, ${b}, vBumpInfos.y)`},{search:/parallaxOcclusion\(invTBN\*-viewDirectionW,invTBN\*normalW,vBumpUV,vBumpInfos.z\)/g,replace:`parallaxOcclusion((invTBN * -viewDirectionW), (invTBN * normalW), vBumpUV, vBumpInfos.z, ${o?u&&this.useParallaxOcclusion?`${c}, ${c+"Sampler"}`:"bump, bumpSampler":u&&this.useParallaxOcclusion?c:"bumpSampler"})`},{search:/parallaxOffset\(invTBN\*viewDirectionW,vBumpInfos\.z\)/g,replace:`parallaxOffset(invTBN * viewDirectionW, vBumpInfos.z, ${u?this.parallaxHeight.associatedVariableName:"0."})`},{search:/vBumpInfos.y/g,replace:p},{search:/vBumpInfos.z/g,replace:d},{search:/normalW=/g,replace:y+" = "},{search:/mat3\(normalMatrix\)\*normalW/g,replace:`${a}(normalMatrix) * `+y},{search:/normalW/g,replace:s.associatedVariableName+".xyz"},{search:/viewDirectionW/g,replace:u?this.viewDirection.associatedVariableName:`vec3${l}(0.)`},m],o?(_.push({search:/fragmentInputs.vBumpUV/g,replace:i.associatedVariableName}),_.push({search:/input.vPositionW/g,replace:r.associatedVariableName+".xyz"}),_.push({search:/uniforms.vTangentSpaceParams/g,replace:h+this._tangentSpaceParameterName}),_.push({search:/var TBN: mat3x3f=mat3x3<f32>\(input.vTBN0,input.vTBN1,input.vTBN2\);/g,replace:"var TBN = vTBN;"})):(_.push({search:/vBumpUV/g,replace:i.associatedVariableName}),_.push({search:/vPositionW/g,replace:r.associatedVariableName+".xyz"}),_.push({search:/vTangentSpaceParams/g,replace:h+this._tangentSpaceParameterName})),e.compilationString+=e._emitCodeFromInclude("bumpFragment",t,{replaceStrings:_}),e.compilationString+=e._declareOutput(this.output)+` = vec4${l}(${y}, 0.);\n`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.invertX = ${this.invertX};\n`;return e+=`${this._codeVariableName}.invertY = ${this.invertY};\n`,e+=`${this._codeVariableName}.useParallaxOcclusion = ${this.useParallaxOcclusion};\n`,e+=`${this._codeVariableName}.useObjectSpaceNormalMap = ${this.useObjectSpaceNormalMap};\n`,e}serialize(){const e=super.serialize();return e.invertX=this.invertX,e.invertY=this.invertY,e.useParallaxOcclusion=this.useParallaxOcclusion,e.useObjectSpaceNormalMap=this.useObjectSpaceNormalMap,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.invertX=e.invertX,this.invertY=e.invertY,this.useParallaxOcclusion=!!e.useParallaxOcclusion,this.useObjectSpaceNormalMap=!!e.useObjectSpaceNormalMap}}(0,Ge.Cg)([xh("Invert X axis",0,"PROPERTIES",{embedded:!0,notifiers:{update:!1}})],w_.prototype,"invertX",void 0),(0,Ge.Cg)([xh("Invert Y axis",0,"PROPERTIES",{embedded:!0,notifiers:{update:!1}})],w_.prototype,"invertY",void 0),(0,Ge.Cg)([xh("Use parallax occlusion",0,void 0,{embedded:!0,notifiers:{update:!1}})],w_.prototype,"useParallaxOcclusion",void 0),(0,Ge.Cg)([xh("Object Space Mode",0,"PROPERTIES",{embedded:!0,notifiers:{update:!1}})],w_.prototype,"useObjectSpaceNormalMap",void 0),(0,a.Y5)("BABYLON.PerturbNormalBlock",w_);class F_ extends Ed{constructor(e){super(e,gd.Fragment,!0),this.registerInput("value",_d.Float,!0),this.registerInput("cutoff",_d.Float,!0)}getClassName(){return"DiscardBlock"}get value(){return this._inputs[0]}get cutoff(){return this._inputs[1]}_buildBlock(e){if(super._buildBlock(e),e.sharedData.hints.needAlphaTesting=!0,this.cutoff.isConnected&&this.value.isConnected)return e.compilationString+=`if (${this.value.associatedVariableName} < ${this.cutoff.associatedVariableName}) { discard; }\n`,this}}(0,a.Y5)("BABYLON.DiscardBlock",F_);class B_ extends Ed{constructor(e){super(e,gd.Fragment),this.registerOutput("output",_d.Float,gd.Fragment)}getClassName(){return"FrontFacingBlock"}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),e.target===gd.Vertex)throw"FrontFacingBlock must only be used in a fragment shader";const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary("1.0","0.0",0===e.shaderLanguage?"gl_FrontFacing":"fragmentInputs.frontFacing")};\n`,this}}(0,a.Y5)("BABYLON.FrontFacingBlock",B_);class V_ extends Ed{constructor(e){super(e,gd.Fragment),this.registerInput("input",_d.AutoDetect,!1),this.registerOutput("dx",_d.BasedOnInput),this.registerOutput("dy",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[1]._typeConnectionSource=this._inputs[0]}getClassName(){return"DerivativeBlock"}get input(){return this._inputs[0]}get dx(){return this._outputs[0]}get dy(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._outputs[1];e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");let r="dFdx",s="dFdy";return 1===e.shaderLanguage&&(r="dpdx",s="dpdy"),t.hasEndpoints&&(e.compilationString+=e._declareOutput(t)+` = ${r}(${this.input.associatedVariableName});\n`),i.hasEndpoints&&(e.compilationString+=e._declareOutput(i)+` = ${s}(${this.input.associatedVariableName});\n`),this}}(0,a.Y5)("BABYLON.DerivativeBlock",V_);class L_ extends Ed{constructor(e){super(e,gd.Fragment),this.registerOutput("xy",_d.Vector2,gd.Fragment),this.registerOutput("xyz",_d.Vector3,gd.Fragment),this.registerOutput("xyzw",_d.Vector4,gd.Fragment),this.registerOutput("x",_d.Float,gd.Fragment),this.registerOutput("y",_d.Float,gd.Fragment),this.registerOutput("z",_d.Float,gd.Fragment),this.registerOutput("w",_d.Float,gd.Fragment)}getClassName(){return"FragCoordBlock"}get xy(){return this._outputs[0]}get xyz(){return this._outputs[1]}get xyzw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get output(){return this._outputs[6]}writeOutputs(e){let t="";const i=1===e.shaderLanguage?"fragmentInputs.position":"gl_FragCoord";for(const r of this._outputs)r.hasEndpoints&&(t+=`${e._declareOutput(r)} = ${i}.${r.name};\n`);return t}_buildBlock(e){if(super._buildBlock(e),e.target===gd.Vertex)throw"FragCoordBlock must only be used in a fragment shader";return e.compilationString+=this.writeOutputs(e),this}}(0,a.Y5)("BABYLON.FragCoordBlock",L_);class k_ extends Ed{constructor(e){super(e,gd.Fragment),this.registerOutput("xy",_d.Vector2,gd.Fragment),this.registerOutput("x",_d.Float,gd.Fragment),this.registerOutput("y",_d.Float,gd.Fragment)}getClassName(){return"ScreenSizeBlock"}get xy(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}bind(e){const t=this._scene.getEngine();e.setFloat2(this._varName,t.getRenderWidth(),t.getRenderHeight())}writeOutputs(e,t){let i="";for(const r of this._outputs)r.hasEndpoints&&(i+=`${e._declareOutput(r)} = ${t}.${r.name};\n`);return i}_buildBlock(e){if(super._buildBlock(e),this._scene=e.sharedData.scene,e.target===gd.Vertex)throw"ScreenSizeBlock must only be used in a fragment shader";e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,_d.Vector2);const t=1===e.shaderLanguage?"uniforms.":"";return e.compilationString+=this.writeOutputs(e,t+this._varName),this}}(0,a.Y5)("BABYLON.ScreenSizeBlock",k_);class G_ extends Ed{constructor(e){super(e,gd.Fragment),this.registerInput("vector",_d.AutoDetect),this.registerInput("worldViewProjection",_d.Matrix),this.registerOutput("output",_d.Vector2),this.registerOutput("x",_d.Float),this.registerOutput("y",_d.Float),this.inputs[0].addExcludedConnectionPointFromAllowedTypes(_d.Color3|_d.Vector3|_d.Vector4)}getClassName(){return"ScreenSpaceBlock"}get vector(){return this._inputs[0]}get worldViewProjection(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(e,t=()=>!0){if(!this.worldViewProjection.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===bd.WorldViewProjection&&t(e)));i||(i=new Fd("worldViewProjection"),i.setAsSystemValue(bd.WorldViewProjection)),i.output.connectTo(this.worldViewProjection)}}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.worldViewProjection;if(!t.connectedPoint)return;const r=i.associatedVariableName,s=e._getFreeVariableName("screenSpaceTemp");switch(t.connectedPoint.type){case _d.Vector3:e.compilationString+=`${e._declareLocalVar(s,_d.Vector4)} = ${r} * vec4${e.fSuffix}(${t.associatedVariableName}, 1.0);\n`;break;case _d.Vector4:e.compilationString+=`${e._declareLocalVar(s,_d.Vector4)} = ${r} * ${t.associatedVariableName};\n`}return e.compilationString+=`${s} = vec4${e.fSuffix}(${s}.xy / ${s}.w, ${s}.zw);`,e.compilationString+=`${s} = vec4${e.fSuffix}(${s}.xy * 0.5 + vec2${e.fSuffix}(0.5, 0.5), ${s}.zw);`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${s}.xy;\n`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${s}.x;\n`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${s}.y;\n`),this}}(0,a.Y5)("BABYLON.ScreenSpaceBlock",G_);class z_ extends Ed{constructor(e){super(e,gd.Fragment),this.registerInput("input",_d.Vector2),this.registerInput("strength",_d.Float),this.registerInput("center",_d.Vector2),this.registerInput("offset",_d.Vector2),this.registerOutput("output",_d.Vector2),this.registerOutput("x",_d.Float),this.registerOutput("y",_d.Float)}getClassName(){return"TwirlBlock"}get input(){return this._inputs[0]}get strength(){return this._inputs[1]}get center(){return this._inputs[2]}get offset(){return this._inputs[3]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(){if(!this.center.isConnected){const e=new Fd("center");e.value=new n.I9(.5,.5),e.output.connectTo(this.center)}if(!this.strength.isConnected){const e=new Fd("strength");e.value=1,e.output.connectTo(this.strength)}if(!this.offset.isConnected){const e=new Fd("offset");e.value=new n.I9(0,0),e.output.connectTo(this.offset)}}_buildBlock(e){super._buildBlock(e);const t=e._getFreeVariableName("delta"),i=e._getFreeVariableName("angle"),r=e._getFreeVariableName("x"),s=e._getFreeVariableName("y"),n=e._getFreeVariableName("result");return e.compilationString+=`        \n            ${e._declareLocalVar(t,_d.Vector2)} = ${this.input.associatedVariableName} - ${this.center.associatedVariableName};\n            ${e._declareLocalVar(i,_d.Float)} = ${this.strength.associatedVariableName} * length(${t});\n            ${e._declareLocalVar(r,_d.Float)} = cos(${i}) * ${t}.x - sin(${i}) * ${t}.y;\n            ${e._declareLocalVar(s,_d.Float)} = sin(${i}) * ${t}.x + cos(${i}) * ${t}.y;\n            ${e._declareLocalVar(n,_d.Vector2)} = vec2(${r} + ${this.center.associatedVariableName}.x + ${this.offset.associatedVariableName}.x, ${s} + ${this.center.associatedVariableName}.y + ${this.offset.associatedVariableName}.y);\n        `,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${n};\n`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${n}.x;\n`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${n}.y;\n`),this}}(0,a.Y5)("BABYLON.TwirlBlock",z_);class U_ extends Ed{constructor(e){super(e,gd.Fragment),this.generateInWorldSpace=!1,this.automaticNormalizationNormal=!0,this.automaticNormalizationTangent=!0,this.registerInput("input",_d.Float),this.registerInput("worldPosition",_d.Vector3),this.registerInput("worldNormal",_d.Vector3),this.registerInput("worldTangent",_d.AutoDetect,!0),this.registerOutput("output",_d.Vector4),this.registerOutput("xyz",_d.Vector3),this._inputs[3].addExcludedConnectionPointFromAllowedTypes(_d.Color3|_d.Vector3|_d.Vector4)}getClassName(){return"HeightToNormalBlock"}get input(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=1===e.shaderLanguage,r=e.fSuffix;this.generateInWorldSpace||this.worldTangent.isConnected||m.V.Error(`You must connect the 'worldTangent' input of the ${this.name} block!`);const s=this.generateInWorldSpace?"":"\n            vec3 biTangent = cross(norm, tgt);\n            mat3 TBN = mat3(tgt, biTangent, norm);\n            ",n=this.generateInWorldSpace?"":"\n            result = TBN * result;\n            result = result * vec3(0.5) + vec3(0.5);\n            ";let o=`\n            vec4 heightToNormal(float height, vec3 position, vec3 tangent, vec3 normal) {\n                vec3 tgt = ${this.automaticNormalizationTangent?"normalize(tangent);":"tangent;"}\n                vec3 norm = ${this.automaticNormalizationNormal?"normalize(normal);":"normal;"}\n                ${s}\n                vec3 worlddX = dFdx(position);\n                vec3 worlddY = dFdy(position);\n                vec3 crossX = cross(norm, worlddX);\n                vec3 crossY = cross(worlddY, norm);\n                float d = abs(dot(crossY, worlddX));\n                vec3 inToNormal = vec3(((((height + dFdx(height)) - height) * crossY) + (((height + dFdy(height)) - height) * crossX)) * sign(d));\n                inToNormal.y *= -1.0;\n                vec3 result = normalize((d * norm) - inToNormal);\n                ${n}\n                return vec4(result, 0.);\n            }`;return i?o=e._babylonSLtoWGSL(o):e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitFunction("heightToNormal",o,"// heightToNormal"),e.compilationString+=e._declareOutput(t)+` = heightToNormal(${this.input.associatedVariableName}, ${this.worldPosition.associatedVariableName}, ${this.worldTangent.isConnected?this.worldTangent.associatedVariableName:`vec3${r}(0.)`}.xyz, ${this.worldNormal.associatedVariableName});\n`,this.xyz.hasEndpoints&&(e.compilationString+=e._declareOutput(this.xyz)+` = ${this.output.associatedVariableName}.xyz;\n`),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.generateInWorldSpace = ${this.generateInWorldSpace};\n`,e+=`${this._codeVariableName}.automaticNormalizationNormal = ${this.automaticNormalizationNormal};\n`,e+=`${this._codeVariableName}.automaticNormalizationTangent = ${this.automaticNormalizationTangent};\n`,e}serialize(){const e=super.serialize();return e.generateInWorldSpace=this.generateInWorldSpace,e.automaticNormalizationNormal=this.automaticNormalizationNormal,e.automaticNormalizationTangent=this.automaticNormalizationTangent,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.generateInWorldSpace=e.generateInWorldSpace,this.automaticNormalizationNormal=e.automaticNormalizationNormal,this.automaticNormalizationTangent=e.automaticNormalizationTangent}}(0,Ge.Cg)([xh("Generate in world space instead of tangent space",0,"PROPERTIES",{notifiers:{update:!0}})],U_.prototype,"generateInWorldSpace",void 0),(0,Ge.Cg)([xh("Force normalization for the worldNormal input",0,"PROPERTIES",{notifiers:{update:!0}})],U_.prototype,"automaticNormalizationNormal",void 0),(0,Ge.Cg)([xh("Force normalization for the worldTangent input",0,"PROPERTIES",{notifiers:{update:!0}})],U_.prototype,"automaticNormalizationTangent",void 0),(0,a.Y5)("BABYLON.HeightToNormalBlock",U_);class W_ extends Ed{constructor(e){super(e,gd.Fragment,!0),this.registerInput("depth",_d.Float,!0),this.registerInput("worldPos",_d.Vector4,!0),this.registerInput("viewProjection",_d.Matrix,!0)}getClassName(){return"FragDepthBlock"}get depth(){return this._inputs[0]}get worldPos(){return this._inputs[1]}get viewProjection(){return this._inputs[2]}_buildBlock(e){super._buildBlock(e);const t=0===e.shaderLanguage?"gl_FragDepth":"fragmentOutputs.fragDepth";return this.depth.isConnected?e.compilationString+=`${t} = ${this.depth.associatedVariableName};\n`:this.worldPos.isConnected&&this.viewProjection.isConnected?e.compilationString+=`\n                ${e._declareLocalVar("p",_d.Vector4)} = ${this.viewProjection.associatedVariableName} * ${this.worldPos.associatedVariableName};\n                ${e._declareLocalVar("v",_d.Float)} = p.z / p.w;\n                #ifndef IS_NDC_HALF_ZRANGE\n                    v = v * 0.5 + 0.5;\n                #endif\n                ${t} = v;\n    \n            `:m.V.Warn("FragDepthBlock: either the depth input or both the worldPos and viewProjection inputs must be connected!"),this}}(0,a.Y5)("BABYLON.FragDepthBlock",W_);class H_ extends Ed{constructor(e){super(e,gd.Fragment),this.registerInput("worldPosition",_d.Vector4,!1),this.registerInput("viewProjection",_d.Matrix,!1),this.registerInput("worldNormal",_d.AutoDetect,!0),this.registerOutput("depth",_d.Vector3),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(_d.Color3|_d.Vector3|_d.Vector4)}getClassName(){return"ShadowMapBlock"}initialize(e){e._excludeVariableName("vPositionWSM"),e._excludeVariableName("lightDataSM"),e._excludeVariableName("biasAndScaleSM"),e._excludeVariableName("depthValuesSM"),e._excludeVariableName("clipPos"),e._excludeVariableName("worldPos"),e._excludeVariableName("zSM"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,71311)),Promise.resolve().then(i.bind(i,5543)),Promise.resolve().then(i.bind(i,89273))]):await Promise.all([Promise.resolve().then(i.bind(i,29796)),Promise.resolve().then(i.bind(i,8334)),Promise.resolve().then(i.bind(i,98322))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}get worldPosition(){return this._inputs[0]}get viewProjection(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get depth(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`,i=1===e.shaderLanguage;e._emitUniformFromString("biasAndScaleSM",_d.Vector3),e._emitUniformFromString("lightDataSM",_d.Vector3),e._emitUniformFromString("depthValuesSM",_d.Vector2),e._emitFunctionFromInclude("packingFunctions",t),e.compilationString+=`${e._declareLocalVar("worldPos",_d.Vector4)} = ${this.worldPosition.associatedVariableName};\n`,e.compilationString+=`${e._declareLocalVar("vPositionWSM",_d.Vector3)};\n`,e.compilationString+=`${e._declareLocalVar("vDepthMetricSM",_d.Float)} = 0.0;\n`,e.compilationString+=`${e._declareLocalVar("zSM",_d.Float)};\n`,this.worldNormal.isConnected&&(e.compilationString+=`${e._declareLocalVar("vNormalW",_d.Vector3)} = ${this.worldNormal.associatedVariableName}.xyz;\n`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexNormalBias",t)),e.compilationString+=`${e._declareLocalVar("clipPos",_d.Vector4)} = ${this.viewProjection.associatedVariableName} * worldPos;\n`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexMetric",t,{replaceStrings:[{search:/gl_Position/g,replace:"clipPos"},{search:/vertexOutputs.position/g,replace:"clipPos"}]}),e.compilationString+=e._emitCodeFromInclude("shadowMapFragment",t,{replaceStrings:[{search:/return;/g,replace:""}]});const r=i?"fragmentOutputs.fragDepth":"gl_FragDepth";return e.compilationString+=`\n            #if SM_DEPTHTEXTURE == 1\n                #ifdef IS_NDC_HALF_ZRANGE\n                    ${r} = (clipPos.z / clipPos.w);\n                #else\n                    ${r} = (clipPos.z / clipPos.w) * 0.5 + 0.5;\n                #endif\n            #endif\n        `,e.compilationString+=`${e._declareOutput(this.depth)} = vec3${e.fSuffix}(depthSM, 1., 1.);\n`,this}}(0,a.Y5)("BABYLON.ShadowMapBlock",H_);class $_ extends Ed{constructor(e){super(e,gd.Fragment,!0),this.registerInput("viewDepth",_d.Float,!0),this.registerInput("screenDepth",_d.Float,!0),this.registerInput("worldPosition",_d.AutoDetect,!0),this.registerInput("localPosition",_d.AutoDetect,!0),this.registerInput("viewNormal",_d.AutoDetect,!0),this.registerInput("worldNormal",_d.AutoDetect,!0),this.registerInput("reflectivity",_d.AutoDetect,!0),this.registerInput("velocity",_d.AutoDetect,!0),this.registerInput("velocityLinear",_d.AutoDetect,!0),this.inputs[2].addExcludedConnectionPointFromAllowedTypes(_d.Vector3|_d.Vector4),this.inputs[3].addExcludedConnectionPointFromAllowedTypes(_d.Vector3|_d.Vector4),this.inputs[4].addExcludedConnectionPointFromAllowedTypes(_d.Vector3|_d.Vector4),this.inputs[5].addExcludedConnectionPointFromAllowedTypes(_d.Vector3|_d.Vector4),this.inputs[6].addExcludedConnectionPointFromAllowedTypes(_d.Vector3|_d.Vector4|_d.Color3|_d.Color4),this.inputs[7].addExcludedConnectionPointFromAllowedTypes(_d.Vector3|_d.Vector4),this.inputs[8].addExcludedConnectionPointFromAllowedTypes(_d.Vector3|_d.Vector4)}getClassName(){return"PrePassOutputBlock"}get viewDepth(){return this._inputs[0]}get screenDepth(){return this._inputs[1]}get worldPosition(){return this._inputs[2]}get localPosition(){return this._inputs[3]}get viewNormal(){return this._inputs[4]}get worldNormal(){return this._inputs[5]}get reflectivity(){return this._inputs[6]}get velocity(){return this._inputs[7]}get velocityLinear(){return this._inputs[8]}_getFragData(e,t){return e?`fragmentOutputs.fragData${t}`:`gl_FragData[${t}]`}_buildBlock(e){super._buildBlock(e);const t=this.worldPosition,i=this.localPosition,r=this.viewNormal,s=this.worldNormal,n=this.viewDepth,o=this.reflectivity,a=this.screenDepth,l=this.velocity,h=this.velocityLinear;e.sharedData.blocksWithDefines.push(this);const c=`//${this.name}`,u=e._getShaderType(_d.Vector4),d=1===e.shaderLanguage;return e._emitFunctionFromInclude("helperFunctions",c),e.compilationString+="#if defined(PREPASS)\r\n",e.compilationString+=d?"var fragData: array<vec4<f32>, SCENE_MRT_COUNT>;\r\n":"vec4 fragData[SCENE_MRT_COUNT];\r\n",e.compilationString+="#ifdef PREPASS_DEPTH\r\n",n.connectedPoint?e.compilationString+=` fragData[PREPASS_DEPTH_INDEX] = ${u}(${n.associatedVariableName}, 0.0, 0.0, 1.0);\r\n`:e.compilationString+=` fragData[PREPASS_DEPTH_INDEX] = ${u}(0.0, 0.0, 0.0, 0.0);\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_SCREENSPACE_DEPTH\r\n",a.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX] = vec4(${a.associatedVariableName}, 0.0, 0.0, 1.0);\r\n`:e.compilationString+=" gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_POSITION\r\n",t.connectedPoint?e.compilationString+=`fragData[PREPASS_POSITION_INDEX] = ${u}(${t.associatedVariableName}.rgb, ${t.connectedPoint.type===_d.Vector4?t.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=` fragData[PREPASS_POSITION_INDEX] = ${u}(0.0, 0.0, 0.0, 0.0);\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_LOCAL_POSITION\r\n",i.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_LOCAL_POSITION_INDEX] = vec4(${i.associatedVariableName}.rgb, ${i.connectedPoint.type===_d.Vector4?i.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=" gl_FragData[PREPASS_LOCAL_POSITION_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_NORMAL\r\n",r.connectedPoint?e.compilationString+=` fragData[PREPASS_NORMAL_INDEX] = ${u}(${r.associatedVariableName}.rgb, ${r.connectedPoint.type===_d.Vector4?r.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=` fragData[PREPASS_NORMAL_INDEX] = ${u}(0.0, 0.0, 0.0, 0.0);\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_WORLD_NORMAL\r\n",s.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_WORLD_NORMAL_INDEX] = vec4(${s.associatedVariableName}.rgb, ${s.connectedPoint.type===_d.Vector4?s.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=" gl_FragData[PREPASS_WORLD_NORMAL_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_REFLECTIVITY\r\n",o.connectedPoint?e.compilationString+=` fragData[PREPASS_REFLECTIVITY_INDEX] = ${u}(${o.associatedVariableName}.rgb, ${o.connectedPoint.type===_d.Vector4?o.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=` fragData[PREPASS_REFLECTIVITY_INDEX] = ${u}(0.0, 0.0, 0.0, 1.0);\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_VELOCITY\r\n",l.connectedPoint?e.compilationString+=` fragData[PREPASS_VELOCITY_INDEX] = ${u}(${l.associatedVariableName}.rgb, ${l.connectedPoint.type===_d.Vector4?l.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=` fragData[PREPASS_VELOCITY_INDEX] = ${u}(0.0, 0.0, 0.0, 1.0);\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_VELOCITY_LINEAR\r\n",h.connectedPoint?e.compilationString+=` fragData[PREPASS_VELOCITY_LINEAR_INDEX] = ${u}(${h.associatedVariableName}.rgb, ${h.connectedPoint.type===_d.Vector4?h.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=` fragData[PREPASS_VELOCITY_LINEAR_INDEX] = ${u}(0.0, 0.0, 0.0, 1.0);\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 1\r\n",e.compilationString+=`${this._getFragData(d,1)} = fragData[1];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 2\r\n",e.compilationString+=`${this._getFragData(d,2)} = fragData[2];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 3\r\n",e.compilationString+=`${this._getFragData(d,3)} = fragData[3];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 4\r\n",e.compilationString+=`${this._getFragData(d,4)} = fragData[4];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 5\r\n",e.compilationString+=`${this._getFragData(d,5)} = fragData[5];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 6\r\n",e.compilationString+=`${this._getFragData(d,6)} = fragData[6];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 7\r\n",e.compilationString+=`${this._getFragData(d,7)} = fragData[7];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#endif\r\n",this}}(0,a.Y5)("BABYLON.PrePassOutputBlock",$_);var q_=i(79702),Y_=i(16205),X_=i(88996),j_=i(73325),Z_=i(89392),Q_=i(64017),K_=i(20727),J_=i(15697),eg=i(91258),tg=i(27018),ig=i(17494),rg=i(8269),sg=i(71311),ng=i(5543),og=i(89273),ag=i(29796),lg=i(8334),hg=i(98322);class cg extends Ed{constructor(e){super(e,gd.VertexAndFragment,!1),this.registerInput("worldPosition",_d.Vector4,!1,gd.Vertex),this.registerInput("view",_d.Matrix,!1,gd.Vertex),this.registerInput("input",_d.AutoDetect,!1,gd.Fragment),this.registerInput("fogColor",_d.AutoDetect,!1,gd.Fragment),this.registerOutput("output",_d.Color3,gd.Fragment),this.input.addExcludedConnectionPointFromAllowedTypes(_d.Color3|_d.Vector3|_d.Color4),this.fogColor.addExcludedConnectionPointFromAllowedTypes(_d.Color3|_d.Vector3|_d.Color4)}getClassName(){return"FogBlock"}get worldPosition(){return this._inputs[0]}get view(){return this._inputs[1]}get input(){return this._inputs[2]}get fogColor(){return this._inputs[3]}get output(){return this._outputs[0]}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.resolve().then(i.bind(i,66407)):await Promise.resolve().then(i.bind(i,7806)),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===bd.View&&t(e)));i||(i=new Fd("view"),i.setAsSystemValue(bd.View)),i.output.connectTo(this.view)}if(!this.fogColor.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===bd.FogColor&&t(e)));i||(i=new Fd("fogColor",void 0,_d.Color3),i.setAsSystemValue(bd.FogColor)),i.output.connectTo(this.fogColor)}}prepareDefines(e,t,i){const r=e.getScene();i.setValue("FOG",t.fogEnabled&&(0,ts.qL)(e,r))}bind(e,t,i){if(!i)return;const r=i.getScene();e.setFloat4(this._fogParameters,r.fogMode,r.fogStart,r.fogEnd,r.fogDensity)}_buildBlock(e){if(super._buildBlock(e),e.target===gd.Fragment){e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);let t=[],i="",r="";1===e.shaderLanguage?(t=[{search:/fn CalcFogFactor\(\)/,replace:"fn CalcFogFactor(vFogDistance: vec3f, vFogInfos: vec4f)"},{search:/uniforms.vFogInfos/g,replace:"vFogInfos"},{search:/fragmentInputs.vFogDistance/g,replace:"vFogDistance"}],i="fragmentInputs.",r="uniforms."):t=[{search:/float CalcFogFactor\(\)/,replace:"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)"}],e._emitFunctionFromInclude("fogFragmentDeclaration",`//${this.name}`,{removeUniforms:!0,removeVaryings:!0,removeIfDef:!1,replaceStrings:t});const s=e._getFreeVariableName("fog"),n=this.input,o=this.fogColor;this._fogParameters=e._getFreeVariableName("fogParameters");const a=this._outputs[0];e._emitUniformFromString(this._fogParameters,_d.Vector4),e.compilationString+="#ifdef FOG\n",e.compilationString+=`${e._declareLocalVar(s,_d.Float)} = CalcFogFactor(${i}${this._fogDistanceName}, ${r}${this._fogParameters});\n`,e.compilationString+=e._declareOutput(a)+` = ${s} * ${n.associatedVariableName}.rgb + (1.0 - ${s}) * ${o.associatedVariableName}.rgb;\n`,e.compilationString+=`#else\n${e._declareOutput(a)} =  ${n.associatedVariableName}.rgb;\n`,e.compilationString+="#endif\n"}else{const t=this.worldPosition,i=this.view;this._fogDistanceName=e._getFreeVariableName("vFogDistance"),e._emitVaryingFromString(this._fogDistanceName,_d.Vector3);const r=1===e.shaderLanguage?"vertexOutputs.":"";e.compilationString+=`${r}${this._fogDistanceName} = (${i.associatedVariableName} * ${t.associatedVariableName}).xyz;\n`}return this}}(0,a.Y5)("BABYLON.FogBlock",cg);class ug extends Ed{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,m.V.Error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?gd.Fragment:gd.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?gd.Fragment:gd.Vertex}constructor(e){super(e,gd.VertexAndFragment),this._lightId=0,this.generateOnlyFragmentCode=!1,this._isUnique=!0,this.registerInput("worldPosition",_d.Vector4,!1,gd.Vertex),this.registerInput("worldNormal",_d.Vector4,!1,gd.Fragment),this.registerInput("cameraPosition",_d.Vector3,!1,gd.Fragment),this.registerInput("glossiness",_d.Float,!0,gd.Fragment),this.registerInput("glossPower",_d.Float,!0,gd.Fragment),this.registerInput("diffuseColor",_d.Color3,!0,gd.Fragment),this.registerInput("specularColor",_d.Color3,!0,gd.Fragment),this.registerInput("view",_d.Matrix,!0),this.registerOutput("diffuseOutput",_d.Color3,gd.Fragment),this.registerOutput("specularOutput",_d.Color3,gd.Fragment),this.registerOutput("shadow",_d.Float,gd.Fragment)}getClassName(){return"LightBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get cameraPosition(){return this._inputs[2]}get glossiness(){return this._inputs[3]}get glossPower(){return this._inputs[4]}get diffuseColor(){return this._inputs[5]}get specularColor(){return this._inputs[6]}get view(){return this._inputs[7]}get diffuseOutput(){return this._outputs[0]}get specularOutput(){return this._outputs[1]}get shadow(){return this._outputs[2]}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,25271)),Promise.resolve().then(i.bind(i,30379)),Promise.resolve().then(i.bind(i,3925)),Promise.resolve().then(i.bind(i,79702)),Promise.resolve().then(i.bind(i,76493)),Promise.resolve().then(i.bind(i,78589)),Promise.resolve().then(i.bind(i,79456))]):await Promise.all([Promise.resolve().then(i.bind(i,92270)),Promise.resolve().then(i.bind(i,37256)),Promise.resolve().then(i.bind(i,22448)),Promise.resolve().then(i.bind(i,4662)),Promise.resolve().then(i.bind(i,47059)),Promise.resolve().then(i.bind(i,73325)),Promise.resolve().then(i.bind(i,21962)),Promise.resolve().then(i.bind(i,66812)),Promise.resolve().then(i.bind(i,35687))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===bd.CameraPosition&&t(e)));i||(i=new Fd("cameraPosition"),i.setAsSystemValue(bd.CameraPosition)),i.output.connectTo(this.cameraPosition)}}prepareDefines(e,t,i){if(!i._areLightsDirty)return;const r=e.getScene();if(this.light){const t={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};(0,ts.lo)(r,e,this.light,this._lightId,i,!0,t),t.needRebuild&&i.rebuild()}else(0,ts.az)(r,e,i,!0,t.maxSimultaneousLights)}updateUniformsAndSamples(e,t,i,r){e.samplers.push("areaLightsLTC1Sampler"),e.samplers.push("areaLightsLTC2Sampler");for(let s=0;s<t.maxSimultaneousLights&&i["LIGHT"+s];s++){const t=e.uniforms.indexOf("vLightData"+s)>=0;(0,ts.GD)(s,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+s],r,t,i["IESLIGHTTEXTURE"+s])}}bind(e,t,i){if(!i)return;const r=i.getScene();this.light?(0,ts.Kd)(this.light,this._lightId,r,e,!0):(0,ts.RL)(r,i,e,!0,t.maxSimultaneousLights)}_injectVertexCode(e){const t=this.worldPosition,i=`//${this.name}`;this.light?(this._lightId=(void 0!==e.counters.lightCounter?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const r="v_"+t.associatedVariableName;e._emitVaryingFromString(r,_d.Vector4)&&(e.compilationString+=(1===e.shaderLanguage?"vertexOutputs.":"")+`${r} = ${t.associatedVariableName};\n`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`${e._declareLocalVar("worldPos",_d.Vector4)} = ${t.associatedVariableName};\n`,this.view.isConnected&&(e.compilationString+=`${e._declareLocalVar("view",_d.Matrix)} = ${this.view.associatedVariableName};\n`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{repeatKey:"maxSimultaneousLights"}))}_injectUBODeclaration(e){const t=`//${this.name}`;this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0})}_buildBlock(e){super._buildBlock(e);const t=1===e.shaderLanguage,i=t?"f":"",r=`//${this.name}`;if(e.target!==gd.Fragment)return void this._injectVertexCode(e);this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this);const s=t?"fragmentInputs.":"";e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const n=this.worldPosition;let o=n.associatedVariableName;this.generateOnlyFragmentCode?(o=e._getFreeVariableName("globalWorldPos"),e._emitFunction("light_globalworldpos",`${e._declareLocalVar(o,_d.Vector3)};\n`,r),e.compilationString+=`${o} = ${n.associatedVariableName}.xyz;\n`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${n.associatedVariableName}`:void 0})):o=s+"v_"+o+".xyz",e._emitFunctionFromInclude("helperFunctions",r);let a={search:/vPositionW/g,replace:o};if(t&&(a={search:/fragmentInputs\.vPositionW/g,replace:o}),e._emitFunctionFromInclude("lightsFragmentFunctions",r,{replaceStrings:[a]}),e._emitFunctionFromInclude("shadowsFragmentFunctions",r,{replaceStrings:[a]}),this._injectUBODeclaration(e),0===this._lightId&&(e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`${e._declareLocalVar("viewDirectionW",_d.Vector3)} = normalize(${this.cameraPosition.associatedVariableName} - ${o});\n`),e.compilationString+=t?"var info: lightingInfo;\n":"lightingInfo info;\n",e.compilationString+=`${e._declareLocalVar("shadow",_d.Float)} = 1.;\n`,e.compilationString+=`${e._declareLocalVar("aggShadow",_d.Float)} = 0.;\n`,e.compilationString+=`${e._declareLocalVar("numLights",_d.Float)} = 0.;\n`,e.compilationString+=`${e._declareLocalVar("glossiness",_d.Float)} = ${this.glossiness.isConnected?this.glossiness.associatedVariableName:"1.0"} * ${this.glossPower.isConnected?this.glossPower.associatedVariableName:"1024.0"};\n`,e.compilationString+=`${e._declareLocalVar("diffuseBase",_d.Vector3)} = vec3${i}(0., 0., 0.);\n`,e.compilationString+=`${e._declareLocalVar("specularBase",_d.Vector3)}  = vec3${i}(0., 0., 0.);\n`,e.compilationString+=`${e._declareLocalVar("normalW",_d.Vector3)} = ${this.worldNormal.associatedVariableName}.xyz;\n`),this.light){let i={search:/vPositionW/g,replace:o+".xyz"};t&&(i={search:/fragmentInputs\.vPositionW/g,replace:o+".xyz"}),e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},i]})}else{let i=`vPositionW,${o}.xyz`;t&&(i=`fragmentInputs.vPositionW,${o}.xyz`),e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{repeatKey:"maxSimultaneousLights",substitutionVars:i})}0===this._lightId&&(e.compilationString+="aggShadow = aggShadow / numLights;\n");const l=this.diffuseOutput,h=this.specularOutput;return e.compilationString+=e._declareOutput(l)+` = diffuseBase${this.diffuseColor.isConnected?" * "+this.diffuseColor.associatedVariableName:""};\n`,h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = specularBase${this.specularColor.isConnected?" * "+this.specularColor.associatedVariableName:""};\n`),this.shadow.hasEndpoints&&(e.compilationString+=e._declareOutput(this.shadow)+" = aggShadow;\n"),this}serialize(){const e=super.serialize();return e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}(0,Ge.Cg)([xh("Generate only fragment code",0,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:ug._OnGenerateOnlyFragmentCodeChanged}})],ug.prototype,"generateOnlyFragmentCode",void 0),(0,a.Y5)("BABYLON.LightBlock",ug);class dg extends Ed{get texture(){return this._texture}set texture(e){if(this._texture===e)return;const t=e?.getScene()??C.q.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}get samplerName(){return this._samplerName}constructor(e){super(e,gd.VertexAndFragment),this.registerOutput("source",_d.Object,gd.VertexAndFragment,new c_("source",this,1,dg,"ImageSourceBlock")),this.registerOutput("dimensions",_d.Vector2)}bind(e){this.texture&&e.setTexture(this._samplerName,this.texture)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}getClassName(){return"ImageSourceBlock"}get source(){return this._outputs[0]}get dimensions(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),e.target===gd.Vertex&&(this._samplerName=e._getFreeVariableName(this.name+"Texture"),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this)),this.dimensions.isConnected){let t="";t=1===e.shaderLanguage?`vec2f(textureDimensions(${this._samplerName}, 0).xy)`:`vec2(textureSize(${this._samplerName}, 0).xy)`,e.compilationString+=`${e._declareOutput(this.dimensions)} = ${t};\n`}return e._emit2DSampler(this._samplerName),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture?(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e):e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&"VideoTexture"!==this.texture.getClassName()&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i,r){super._deserialize(e,t,i,r),e.texture&&!Jd.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(0===e.texture.url.indexOf("data:")?i="":r&&(e.texture.url=r(e.texture.url),e.texture.name=e.texture.url),this.texture=$e.g.Parse(e.texture,t,i))}}(0,a.Y5)("BABYLON.ImageSourceBlock",dg);class pg extends Ed{get texture(){return this.source.isConnected?(this.source.connectedPoint?.ownerBlock).texture:this._texture}set texture(e){if(this._texture===e)return;const t=e?.getScene()??C.q.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}static _IsPrePassTextureBlock(e){return"PrePassTextureBlock"===e?.getClassName()}get _isSourcePrePass(){return pg._IsPrePassTextureBlock(this._imageSource)}get samplerName(){if(this._imageSource){if(!pg._IsPrePassTextureBlock(this._imageSource))return this._imageSource.samplerName;if(this.source.connectedPoint)return this._imageSource.getSamplerName(this.source.connectedPoint)}return this._samplerName}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const e=this.texture.getScene()??C.q.LastCreatedScene;e?.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const e=this.texture.getScene()??C.q.LastCreatedScene;e?.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,t?gd.Fragment:gd.VertexAndFragment),this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this._fragmentOnly=t,this.registerInput("uv",_d.AutoDetect,!1,gd.VertexAndFragment),this.registerInput("source",_d.Object,!0,gd.VertexAndFragment,new c_("source",this,0,dg,"ImageSourceBlock")),this.registerInput("layer",_d.Float,!0),this.registerInput("lod",_d.Float,!0),this.registerOutput("rgba",_d.Color4,gd.Neutral),this.registerOutput("rgb",_d.Color3,gd.Neutral),this.registerOutput("r",_d.Float,gd.Neutral),this.registerOutput("g",_d.Float,gd.Neutral),this.registerOutput("b",_d.Float,gd.Neutral),this.registerOutput("a",_d.Float,gd.Neutral),this.registerOutput("level",_d.Float,gd.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(_d.Vector2|_d.Vector3|_d.Vector4),this._inputs[0]._prioritizeVertex=!t}getClassName(){return"TextureBlock"}get uv(){return this._inputs[0]}get source(){return this._inputs[1]}get layer(){return this._inputs[2]}get lod(){return this._inputs[3]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}_isTiedToFragment(e){if(e.target===gd.Fragment)return!0;if(e.target===gd.Vertex)return!1;if(e.target===gd.Neutral||e.target===gd.VertexAndFragment){const t=e.ownerBlock;if(t.target===gd.Fragment)return!0;for(const e of t.inputs)if(e.isConnected&&this._isTiedToFragment(e.connectedPoint))return!0}return!1}_getEffectiveTarget(){return this._fragmentOnly?gd.Fragment:this.uv.isConnected?this.uv.sourceBlock.isInput?gd.VertexAndFragment:this._isTiedToFragment(this.uv.connectedPoint)?gd.Fragment:gd.VertexAndFragment:gd.VertexAndFragment}get target(){return this._getEffectiveTarget()}set target(e){}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected)if(e.mode===Hd.PostProcess){const i=e.getBlockByPredicate((e=>"uv"===e.name&&t(e)));i&&i.connectTo(this)}else if(e.mode!==Hd.ProceduralTexture){const i=e.mode===Hd.Particle?"particle_uv":"uv";let r=e.getInputBlockByPredicate((e=>e.isAttribute&&e.name===i&&t(e)));r||(r=new Fd("uv"),r.setAsAttribute(i)),r.output.connectTo(this.uv)}}initializeDefines(e,t,i){i._areTexturesDirty&&void 0!==this._mainUVDefineName&&i.setValue(this._mainUVDefineName,!1,!0)}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;if(!this.texture||!this.texture.getTextureMatrix)return void(this._isMixed&&(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)));const r=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,s=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,r,!0),i.setValue(this._gammaDefineName,s,!0),this._isMixed&&(this.texture.getTextureMatrix().isIdentityAs3x2()?(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)):(i.setValue(this._defineName,!0),null==i[this._mainUVDefineName]&&i.setValue(this._mainUVDefineName,!1,!0)))}isReady(){return!!this._isSourcePrePass||!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){this._isSourcePrePass&&e.setFloat(this._textureInfoName,1),this.texture&&(this._isMixed&&(e.setFloat(this._textureInfoName,this.texture.level),e.setMatrix(this._textureTransformName,this.texture.getTextureMatrix())),this._imageSource||e.setTexture(this._samplerName,this.texture))}get _isMixed(){return this.target!==gd.Fragment}_injectVertexCode(e){const t=this.uv;this._defineName=e._getFreeDefineName("UVTRANSFORM"),this._mainUVDefineName="VMAIN"+t.declarationVariableName.toUpperCase(),this._mainUVName="vMain"+t.declarationVariableName,this._transformedUVName=e._getFreeVariableName("transformedUV"),this._textureTransformName=e._getFreeVariableName("textureTransform"),this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,e._emitVaryingFromString(this._transformedUVName,_d.Vector2,this._defineName),e._emitVaryingFromString(this._mainUVName,_d.Vector2,this._mainUVDefineName),e._emitUniformFromString(this._textureTransformName,_d.Matrix,this._defineName);const i=e._getShaderType(_d.Vector4),r=e._getShaderType(_d.Vector2);e.compilationString+=`#ifdef ${this._defineName}\n`,e.compilationString+=`${e._getVaryingName(this._transformedUVName)} = ${r}(${this._textureTransformName} * ${i}(${t.associatedVariableName}.xy, 1.0, 0.0));\n`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\n`;let s="";if(1===e.shaderLanguage&&t.isConnectedToInputBlock&&-1===t.associatedVariableName.indexOf("vertexInputs.")&&(s="vertexInputs."),e.compilationString+=`${e._getVaryingName(this._mainUVName)} = ${s}${t.associatedVariableName}.xy;\n`,e.compilationString+="#endif\n",this._outputs.some((e=>e.isConnectedInVertexShader))){this._writeTextureRead(e,!0);for(const t of this._outputs)t.hasEndpoints&&"level"!==t.name&&this._writeOutput(e,t,t.name,!0)}}_getUVW(e){let t=e;const i=this._texture?._texture?.is2DArray??!1,r=this._texture?._texture?.is3D??!1;if(i){t=`vec3(${e}, ${this.layer.isConnected?this.layer.associatedVariableName:"0"})`}else if(r){t=`vec3(${e}, ${this.layer.isConnected?this.layer.associatedVariableName:"0"})`}return t}_samplerFunc(e){return 1===e.shaderLanguage?e.target===gd.Vertex?"textureSampleLevel":"textureSample":this.lod.isConnected?"texture2DLodEXT":"texture2D"}get _samplerLodSuffix(){return this.lod.isConnected?`, ${this.lod.associatedVariableName}`:""}_generateTextureSample(e,t){if(1===t.shaderLanguage){const i=t.target===gd.Vertex;return`${this._samplerFunc(t)}(${this.samplerName},${this.samplerName+"Sampler"}, ${this._getUVW(e)}${this._samplerLodSuffix}${i?", 0":""})`}return`${this._samplerFunc(t)}(${this.samplerName}, ${this._getUVW(e)}${this._samplerLodSuffix})`}_generateTextureLookup(e){e.compilationString+=`#ifdef ${this._defineName}\n`,e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,_d.Vector4)} = ${this._generateTextureSample(e._getVaryingName(this._transformedUVName),e)};\n`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\n`,e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,_d.Vector4)} = ${this._generateTextureSample(this._mainUVName?e._getVaryingName(this._mainUVName):this.uv.associatedVariableName,e)}${this._samplerLodSuffix};\n`,e.compilationString+="#endif\n"}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===gd.Fragment)return;this._generateTextureLookup(e)}else this.uv.ownerBlock.target!==gd.Fragment?this._generateTextureLookup(e):e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,_d.Vector4)} = ${this._generateTextureSample(i.associatedVariableName,e)}${this._samplerLodSuffix};\n`}_generateConversionCode(e,t,i){"a"!==i&&(this.texture&&this.texture.gammaSpace||(e.compilationString+=`#ifdef ${this._linearDefineName}\n                    ${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n                    #endif\n                `),e.compilationString+=`#ifdef ${this._gammaDefineName}\n                ${t.associatedVariableName} = ${e._toLinearSpace(t)};\n                #endif\n            `)}_writeOutput(e,t,i,r=!1){if(r){if(e.target===gd.Fragment)return;return e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`,void this._generateConversionCode(e,t,i)}if(this.uv.ownerBlock.target===gd.Fragment)return e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`,void this._generateConversionCode(e,t,i);let s="";this.disableLevelMultiplication||(s=" * "+((1===e.shaderLanguage?"uniforms.":"")+this._textureInfoName)),e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i}${s};\n`,this._generateConversionCode(e,t,i)}_buildBlock(e){if(super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,(e.target===gd.Vertex||this._fragmentOnly||e.target===gd.Fragment)&&(this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA")),!this._isMixed&&e.target===gd.Fragment||this._isMixed&&e.target===gd.Vertex){if(!this._imageSource){const t=e._getFreeVariableName(this.name);this._samplerName=t+"Texture",this._texture?._texture?.is2DArray?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName)}e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this)}if(e.target!==gd.Fragment)return void this._injectVertexCode(e);if(!this._outputs.some((e=>e.isConnectedInFragmentShader)))return;this._isMixed&&!this._imageSource&&(this._texture?._texture?.is2DArray?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName));const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._isMixed&&e._emitUniformFromString(this._textureInfoName,_d.Float),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&"level"!==t.name&&this._writeOutput(e,t,t.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\n`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};\n`,this.texture?(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e):e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.fragmentOnly=this._fragmentOnly,e.disableLevelMultiplication=this.disableLevelMultiplication,this.hasImageSource||!this.texture||this.texture.isRenderTarget||"VideoTexture"===this.texture.getClassName()||(e.texture=this.texture.serialize()),e}_deserialize(e,t,i,r){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this._fragmentOnly=!!e.fragmentOnly,this.disableLevelMultiplication=!!e.disableLevelMultiplication,e.texture&&!Jd.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(0===e.texture.url.indexOf("data:")?i="":r&&(e.texture.url=r(e.texture.url),e.texture.name=e.texture.url),this.texture=$e.g.Parse(e.texture,t,i))}}(0,a.Y5)("BABYLON.TextureBlock",pg);class mg extends Ed{get texture(){return this._texture}set texture(e){if(this._texture===e)return;const t=e?.getScene()??C.q.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}static _OnGenerateOnlyFragmentCodeChanged(e,t){return e._onGenerateOnlyFragmentCodeChanged()}_onGenerateOnlyFragmentCodeChanged(){return this._setTarget(),!0}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?gd.Fragment:gd.VertexAndFragment)}constructor(e){super(e,gd.VertexAndFragment),this.generateOnlyFragmentCode=!1}getClassName(){return"ReflectionTextureBaseBlock"}_getTexture(){return this.texture}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.resolve().then(i.bind(i,72230)):await Promise.resolve().then(i.bind(i,18223)),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.position.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"position"===e.name&&t(e)));i||(i=new Fd("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.world.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===bd.World&&t(e)));i||(i=new Fd("world"),i.setAsSystemValue(bd.World)),i.output.connectTo(this.world)}if(this.view&&!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===bd.View&&t(e)));i||(i=new Fd("view"),i.setAsSystemValue(bd.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;const r=this._getTexture();r&&r.getTextureMatrix&&(i.setValue(this._define3DName,r.isCube,!0),i.setValue(this._defineLocalCubicName,!!r.boundingBoxSize,!0),i.setValue(this._defineExplicitName,0===r.coordinatesMode,!0),i.setValue(this._defineSkyboxName,5===r.coordinatesMode,!0),i.setValue(this._defineCubicName,3===r.coordinatesMode||6===r.coordinatesMode,!0),i.setValue("INVERTCUBICMAP",6===r.coordinatesMode,!0),i.setValue(this._defineSphericalName,1===r.coordinatesMode,!0),i.setValue(this._definePlanarName,2===r.coordinatesMode,!0),i.setValue(this._defineProjectionName,4===r.coordinatesMode,!0),i.setValue(this._defineEquirectangularName,7===r.coordinatesMode,!0),i.setValue(this._defineEquirectangularFixedName,8===r.coordinatesMode,!0),i.setValue(this._defineMirroredEquirectangularFixedName,9===r.coordinatesMode,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i,r){const s=this._getTexture();if(i&&s&&(e.setMatrix(this._reflectionMatrixName,s.getReflectionTextureMatrix()),s.isCube?e.setTexture(this._cubeSamplerName,s):e.setTexture(this._2DSamplerName,s),s.boundingBoxSize)){const t=s;e.setVector3(this._reflectionPositionName,t.boundingBoxPosition),e.setVector3(this._reflectionSizeName,t.boundingBoxSize)}}handleVertexSide(e){if(this.generateOnlyFragmentCode&&e.target===gd.Vertex)return"";const t=1===e.shaderLanguage;this._define3DName=e._getFreeDefineName("REFLECTIONMAP_3D"),this._defineCubicName=e._getFreeDefineName("REFLECTIONMAP_CUBIC"),this._defineSphericalName=e._getFreeDefineName("REFLECTIONMAP_SPHERICAL"),this._definePlanarName=e._getFreeDefineName("REFLECTIONMAP_PLANAR"),this._defineProjectionName=e._getFreeDefineName("REFLECTIONMAP_PROJECTION"),this._defineExplicitName=e._getFreeDefineName("REFLECTIONMAP_EXPLICIT"),this._defineEquirectangularName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR"),this._defineLocalCubicName=e._getFreeDefineName("USE_LOCAL_REFLECTIONMAP_CUBIC"),this._defineMirroredEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"),this._defineEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR_FIXED"),this._defineSkyboxName=e._getFreeDefineName("REFLECTIONMAP_SKYBOX"),this._defineOppositeZ=e._getFreeDefineName("REFLECTIONMAP_OPPOSITEZ"),this._reflectionMatrixName=e._getFreeVariableName("reflectionMatrix"),e._emitUniformFromString(this._reflectionMatrixName,_d.Matrix);let i="";this._worldPositionNameInFragmentOnlyMode=e._getFreeVariableName("worldPosition");const r=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:"v_"+this.worldPosition.associatedVariableName;return(this.generateOnlyFragmentCode||e._emitVaryingFromString(r,_d.Vector4))&&(this.generateOnlyFragmentCode?i+=`${e._declareLocalVar(r,_d.Vector4)} = ${this.worldPosition.associatedVariableName};\n`:i+=`${t?"vertexOutputs.":""}${r} = ${this.worldPosition.associatedVariableName};\n`),this._positionUVWName=e._getFreeVariableName("positionUVW"),this._directionWName=e._getFreeVariableName("directionW"),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._positionUVWName,_d.Vector3,this._defineSkyboxName))&&(i+=`#ifdef ${this._defineSkyboxName}\n`,this.generateOnlyFragmentCode?i+=`${e._declareLocalVar(this._positionUVWName,_d.Vector3)} = ${this.position.associatedVariableName}.xyz;\n`:i+=`${t?"vertexOutputs.":""}${this._positionUVWName} = ${this.position.associatedVariableName}.xyz;\n`,i+="#endif\n"),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._directionWName,_d.Vector3,`defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})`))&&(i+=`#if defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})\n`,this.generateOnlyFragmentCode?i+=`${e._declareLocalVar(this._directionWName,_d.Vector3)} = normalize(vec3${e.fSuffix}(${this.world.associatedVariableName} * vec4${e.fSuffix}(${this.position.associatedVariableName}.xyz, 0.0)));\n`:i+=`${t?"vertexOutputs.":""}${this._directionWName} = normalize(vec3${e.fSuffix}(${this.world.associatedVariableName} * vec4${e.fSuffix}(${this.position.associatedVariableName}.xyz, 0.0)));\n`,i+="#endif\n"),i}handleFragmentSideInits(e){e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),e._samplerDeclaration+=`#ifdef ${this._define3DName}\n`,e._emitCubeSampler(this._cubeSamplerName,"",!0),e._samplerDeclaration+="#else\n",e._emit2DSampler(this._2DSamplerName,"",!0),e._samplerDeclaration+="#endif\n",e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("reflectionFunction",t,{replaceStrings:[{search:/vec3 computeReflectionCoords/g,replace:"void DUMMYFUNC"},{search:/fn computeReflectionCoords\(worldPos: vec4f,worldNormal: vec3f\)->vec3f/g,replace:"fn DUMMYFUNC()"}]}),this._reflectionColorName=e._getFreeVariableName("reflectionColor"),this._reflectionVectorName=e._getFreeVariableName("reflectionUVW"),this._reflectionCoordsName=e._getFreeVariableName("reflectionCoords"),this._reflectionPositionName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionPositionName,_d.Vector3),this._reflectionSizeName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionSizeName,_d.Vector3)}handleFragmentSideCodeReflectionCoords(e,t,i,r=!1,s=!1){i||(i=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:`v_${this.worldPosition.associatedVariableName}`);const n=(1===e.shaderLanguage?"uniforms.":"")+this._reflectionMatrixName,o=`normalize(${this._directionWName})`,a=`${this._positionUVWName}`,l=`${this.cameraPosition.associatedVariableName}`,h=`${this.view.associatedVariableName}`;t+=".xyz";let c=`\n            #ifdef ${this._defineMirroredEquirectangularFixedName}\n               ${e._declareLocalVar(this._reflectionVectorName,_d.Vector3)} = computeMirroredFixedEquirectangularCoords(${i}, ${t}, ${o});\n            #endif\n\n            #ifdef ${this._defineEquirectangularFixedName}\n                ${e._declareLocalVar(this._reflectionVectorName,_d.Vector3)} = computeFixedEquirectangularCoords(${i}, ${t}, ${o});\n            #endif\n\n            #ifdef ${this._defineEquirectangularName}\n                ${e._declareLocalVar(this._reflectionVectorName,_d.Vector3)} = computeEquirectangularCoords(${i}, ${t}, ${l}.xyz, ${n});\n            #endif\n\n            #ifdef ${this._defineSphericalName}\n                ${e._declareLocalVar(this._reflectionVectorName,_d.Vector3)} = computeSphericalCoords(${i}, ${t}, ${h}, ${n});\n            #endif\n\n            #ifdef ${this._definePlanarName}\n                ${e._declareLocalVar(this._reflectionVectorName,_d.Vector3)} = computePlanarCoords(${i}, ${t}, ${l}.xyz, ${n});\n            #endif\n\n            #ifdef ${this._defineCubicName}\n                #ifdef ${this._defineLocalCubicName}\n                    ${e._declareLocalVar(this._reflectionVectorName,_d.Vector3)} = computeCubicLocalCoords(${i}, ${t}, ${l}.xyz, ${n}, ${this._reflectionSizeName}, ${this._reflectionPositionName});\n                #else\n                ${e._declareLocalVar(this._reflectionVectorName,_d.Vector3)} = computeCubicCoords(${i}, ${t}, ${l}.xyz, ${n});\n                #endif\n            #endif\n\n            #ifdef ${this._defineProjectionName}\n                ${e._declareLocalVar(this._reflectionVectorName,_d.Vector3)} = computeProjectionCoords(${i}, ${h}, ${n});\n            #endif\n\n            #ifdef ${this._defineSkyboxName}\n                ${e._declareLocalVar(this._reflectionVectorName,_d.Vector3)} = computeSkyBoxCoords(${a}, ${n});\n            #endif\n\n            #ifdef ${this._defineExplicitName}\n                ${e._declareLocalVar(this._reflectionVectorName,_d.Vector3)} = vec3(0, 0, 0);\n            #endif\n`;return s||(c+=`#ifdef ${this._defineOppositeZ}\n                ${this._reflectionVectorName}.z *= -1.0;\n            #endif\n`),r||(c+=`\n                #ifdef ${this._define3DName}\n                    ${e._declareLocalVar(this._reflectionCoordsName,_d.Vector3)} = ${this._reflectionVectorName};\n                #else\n                    ${e._declareLocalVar(this._reflectionCoordsName,_d.Vector2)} = ${this._reflectionVectorName}.xy;\n                    #ifdef ${this._defineProjectionName}\n                        ${this._reflectionCoordsName} /= ${this._reflectionVectorName}.z;\n                    #endif\n                    ${this._reflectionCoordsName}.y = 1.0 - ${this._reflectionCoordsName}.y;\n                #endif\n`),c}handleFragmentSideCodeReflectionColor(e,t,i=".rgb"){let r=_d.Vector4;3===i.length&&(r=_d.Vector3);let s=`${e._declareLocalVar(this._reflectionColorName,r)};\n            #ifdef ${this._define3DName}\n`;return s+=t?`${this._reflectionColorName} = ${e._generateTextureSampleCubeLOD(this._reflectionVectorName,this._cubeSamplerName,t)}${i};\n`:`${this._reflectionColorName} = ${e._generateTextureSampleCube(this._reflectionVectorName,this._cubeSamplerName)}${i};\n`,s+="\n            #else\n",s+=t?`${this._reflectionColorName} =${e._generateTextureSampleLOD(this._reflectionCoordsName,this._2DSamplerName,t)}${i};\n`:`${this._reflectionColorName} = ${e._generateTextureSample(this._reflectionCoordsName,this._2DSamplerName)}${i};\n`,s+="#endif\n",s}writeOutputs(e,t){let i="";if(e.target===gd.Fragment)for(const r of this._outputs)r.hasEndpoints&&(i+=`${e._declareOutput(r)} = ${t}.${r.name};\n`);return i}_buildBlock(e){return super._buildBlock(e),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();if(!this.texture)return e;if(this.texture.isCube){const t=this.texture.forcedExtension;e+=`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}", undefined, undefined, ${this.texture.noMipmap}, null, undefined, undefined, undefined, ${this.texture._prefiltered}, ${t?'"'+t+'"':"null"});\n`}else e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null);\n`;return e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&!Jd.IgnoreTexturesAtLoadTime&&(i=0===e.texture.url.indexOf("data:")?"":i,e.texture.isCube?this.texture=Wu.CubeTexture.Parse(e.texture,t,i):this.texture=$e.g.Parse(e.texture,t,i)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}(0,Ge.Cg)([xh("Generate only fragment code",0,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:mg._OnGenerateOnlyFragmentCodeChanged}})],mg.prototype,"generateOnlyFragmentCode",void 0),(0,a.Y5)("BABYLON.ReflectionTextureBaseBlock",mg);class fg extends mg{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,m.V.Error("The position input must not be connected to be able to switch!"),!1):this.worldPosition.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,m.V.Error("The worldPosition input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?gd.Fragment:gd.Vertex,this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?gd.Fragment:gd.Vertex}constructor(e){super(e),this.registerInput("position",_d.AutoDetect,!1,gd.Vertex),this.registerInput("worldPosition",_d.Vector4,!1,gd.Vertex),this.registerInput("worldNormal",_d.Vector4,!1,gd.Fragment),this.registerInput("world",_d.Matrix,!1,gd.Vertex),this.registerInput("cameraPosition",_d.Vector3,!1,gd.Fragment),this.registerInput("view",_d.Matrix,!1,gd.Fragment),this.registerOutput("rgb",_d.Color3,gd.Fragment),this.registerOutput("rgba",_d.Color4,gd.Fragment),this.registerOutput("r",_d.Float,gd.Fragment),this.registerOutput("g",_d.Float,gd.Fragment),this.registerOutput("b",_d.Float,gd.Fragment),this.registerOutput("a",_d.Float,gd.Fragment),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(_d.Color3|_d.Vector3|_d.Vector4)}getClassName(){return"ReflectionTextureBlock"}get position(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get world(){return this._inputs[3]}get cameraPosition(){return this._inputs[4]}get view(){return this._inputs[5]}get rgb(){return this._outputs[0]}get rgba(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}autoConfigure(e,t=()=>!0){if(super.autoConfigure(e),!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===bd.CameraPosition&&t(e)));i||(i=new Fd("cameraPosition"),i.setAsSystemValue(bd.CameraPosition)),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){if(super._buildBlock(e),!this.texture)return e.compilationString+=this.writeOutputs(e,`vec4${e.fSuffix}(0.)`),this;if(e.target!==gd.Fragment)return e.compilationString+=this.handleVertexSide(e),this;this.generateOnlyFragmentCode&&(e.compilationString+=this.handleVertexSide(e)),this.handleFragmentSideInits(e);const t=e._getFreeVariableName("normalWUnit");return e.compilationString+=`${e._declareLocalVar(t,_d.Vector4)} = normalize(${this.worldNormal.associatedVariableName});\n`,e.compilationString+=this.handleFragmentSideCodeReflectionCoords(e,t),e.compilationString+=this.handleFragmentSideCodeReflectionColor(e,void 0,""),e.compilationString+=this.writeOutputs(e,this._reflectionColorName),this}}(0,a.Y5)("BABYLON.ReflectionTextureBlock",fg);class _g extends Ed{constructor(e){super(e,gd.VertexAndFragment),this.useNonLinearDepth=!1,this.storeCameraSpaceZ=!1,this.force32itsFloat=!1,this._isUnique=!0,this.registerInput("uv",_d.AutoDetect,!1,gd.VertexAndFragment),this.registerOutput("depth",_d.Float,gd.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(_d.Vector2|_d.Vector3|_d.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"SceneDepthBlock"}get uv(){return this._inputs[0]}get depth(){return this._outputs[0]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return this.uv.isConnected?this.uv.sourceBlock.isInput?gd.VertexAndFragment:gd.Fragment:gd.VertexAndFragment}_getTexture(e){return e.enableDepthRenderer(void 0,this.useNonLinearDepth,this.force32itsFloat,void 0,this.storeCameraSpaceZ).getDepthMap()}bind(e,t){const i=this._getTexture(t.getScene());e.setTexture(this._samplerName,i)}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput){t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,t.type===_d.Vector3?_d.Vector3:t.type===_d.Vector4?_d.Vector4:_d.Vector2)}if(this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,_d.Vector2),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\n`,this._outputs.some((e=>e.isConnectedInVertexShader))){this._writeTextureRead(e,!0);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,"r",!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===gd.Fragment)return;const t=0===e.shaderLanguage?`texture2D(${this._samplerName},`:`textureSampleLevel(${this._samplerName}, ${this._samplerName+"Sampler"},`,r=0===e.shaderLanguage?"":", 0";return void(e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,_d.Vector4)}=  ${t} ${i.associatedVariableName}.xy${r});\n`)}const r=0===e.shaderLanguage?`texture2D(${this._samplerName},`:`textureSample(${this._samplerName}, ${this._samplerName+"Sampler"},`;this.uv.ownerBlock.target!==gd.Fragment?e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,_d.Vector4)} = ${r} ${this._mainUVName});\n`:e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,_d.Vector4)} = ${r} ${i.associatedVariableName}.xy);\n`}_writeOutput(e,t,i,r=!1){if(r){if(e.target===gd.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`}else this.uv.ownerBlock.target,gd.Fragment,e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`}_buildBlock(e){if(super._buildBlock(e),this._samplerName=e._getFreeVariableName(this.name+"Sampler"),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.bindableBlocks.indexOf(this)<0&&e.sharedData.bindableBlocks.push(this),e.target!==gd.Fragment)return e._emit2DSampler(this._samplerName),void this._injectVertexCode(e);if(this._outputs.some((e=>e.isConnectedInFragmentShader))){e._emit2DSampler(this._samplerName),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,"r");return this}}serialize(){const e=super.serialize();return e.useNonLinearDepth=this.useNonLinearDepth,e.storeCameraSpaceZ=this.storeCameraSpaceZ,e.force32itsFloat=this.force32itsFloat,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useNonLinearDepth=e.useNonLinearDepth,this.storeCameraSpaceZ=!!e.storeCameraSpaceZ,this.force32itsFloat=e.force32itsFloat}}(0,Ge.Cg)([xh("Use non linear depth",0,"ADVANCED",{embedded:!0,notifiers:{activatePreviewCommand:!0,callback:(e,t)=>{const i=t;let r=!1;return i.useNonLinearDepth&&(i.storeCameraSpaceZ=!1,r=!0),e&&e.disableDepthRenderer(),r}}})],_g.prototype,"useNonLinearDepth",void 0),(0,Ge.Cg)([xh("Store Camera space Z",0,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(e,t)=>{const i=t;let r=!1;return i.storeCameraSpaceZ&&(i.useNonLinearDepth=!1,r=!0),e&&e.disableDepthRenderer(),r}}})],_g.prototype,"storeCameraSpaceZ",void 0),(0,Ge.Cg)([xh("Force 32 bits float",0,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:e=>e?.disableDepthRenderer()}})],_g.prototype,"force32itsFloat",void 0),(0,a.Y5)("BABYLON.SceneDepthBlock",_g);class gg extends Ed{constructor(e){super(e,gd.VertexAndFragment,!0),this.registerInput("worldPosition",_d.Vector4,!1)}getClassName(){return"ClipPlanesBlock"}initialize(e){e._excludeVariableName("vClipPlane"),e._excludeVariableName("fClipDistance"),e._excludeVariableName("vClipPlane2"),e._excludeVariableName("fClipDistance2"),e._excludeVariableName("vClipPlane3"),e._excludeVariableName("fClipDistance3"),e._excludeVariableName("vClipPlane4"),e._excludeVariableName("fClipDistance4"),e._excludeVariableName("vClipPlane5"),e._excludeVariableName("fClipDistance5"),e._excludeVariableName("vClipPlane6"),e._excludeVariableName("fClipDistance6"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,97715)),Promise.resolve().then(i.bind(i,39759)),Promise.resolve().then(i.bind(i,85197)),Promise.resolve().then(i.bind(i,77029))]):await Promise.all([Promise.resolve().then(i.bind(i,7412)),Promise.resolve().then(i.bind(i,6194)),Promise.resolve().then(i.bind(i,47314)),Promise.resolve().then(i.bind(i,71636))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}get worldPosition(){return this._inputs[0]}get target(){return gd.VertexAndFragment}set target(e){}prepareDefines(e,t,i){const r=e.getScene(),s=!!(t.clipPlane??r.clipPlane),n=!!(t.clipPlane2??r.clipPlane2),o=!!(t.clipPlane3??r.clipPlane3),a=!!(t.clipPlane4??r.clipPlane4),l=!!(t.clipPlane5??r.clipPlane5),h=!!(t.clipPlane6??r.clipPlane6);i.setValue("CLIPPLANE",s,!0),i.setValue("CLIPPLANE2",n,!0),i.setValue("CLIPPLANE3",o,!0),i.setValue("CLIPPLANE4",a,!0),i.setValue("CLIPPLANE5",l,!0),i.setValue("CLIPPLANE6",h,!0)}bind(e,t,i){if(!i)return;const r=i.getScene();(0,es.gS)(e,t,r)}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;if(e.target!==gd.Fragment){const i=this.worldPosition;return e._emitFunctionFromInclude("clipPlaneVertexDeclaration",t,{replaceStrings:[{search:/uniform vec4 vClipPlane\d*;/g,replace:""}]}),e.compilationString+=e._emitCodeFromInclude("clipPlaneVertex",t,{replaceStrings:[{search:/worldPos/g,replace:i.associatedVariableName}]}),e._emitUniformFromString("vClipPlane",_d.Vector4),e._emitUniformFromString("vClipPlane2",_d.Vector4),e._emitUniformFromString("vClipPlane3",_d.Vector4),e._emitUniformFromString("vClipPlane4",_d.Vector4),e._emitUniformFromString("vClipPlane5",_d.Vector4),void e._emitUniformFromString("vClipPlane6",_d.Vector4)}return e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e.compilationString+=e._emitCodeFromInclude("clipPlaneFragment",t),this}}(0,a.Y5)("BABYLON.ClipPlanesBlock",gg);var xg=i(97715),vg=i(39759),Sg=i(85197),bg=i(77029),yg=i(7412),Pg=i(6194),Tg=i(47314),Cg=i(71636),Eg=i(66407),Ag=i(7806),Ig=i(25271),Rg=i(30379),Mg=i(3925),Dg=i(76493),Og=i(78589),Ng=i(79456),wg=i(92270),Fg=i(37256),Bg=i(22448),Vg=i(4662),Lg=i(47059),kg=i(21962),Gg=i(66812),zg=i(35687),Ug=i(72230),Wg=i(18223);class Hg extends Ed{get texture(){return null}set texture(e){}constructor(e,t=gd.VertexAndFragment){super(e,t,!1),this.registerOutput("position",_d.Object,gd.VertexAndFragment,new c_("position",this,1,dg,"ImageSourceBlock")),this.registerOutput("localPosition",_d.Object,gd.VertexAndFragment,new c_("localPosition",this,1,dg,"ImageSourceBlock")),this.registerOutput("depth",_d.Object,gd.VertexAndFragment,new c_("depth",this,1,dg,"ImageSourceBlock")),this.registerOutput("screenDepth",_d.Object,gd.VertexAndFragment,new c_("screenDepth",this,1,dg,"ImageSourceBlock")),this.registerOutput("normal",_d.Object,gd.VertexAndFragment,new c_("normal",this,1,dg,"ImageSourceBlock")),this.registerOutput("worldNormal",_d.Object,gd.VertexAndFragment,new c_("worldNormal",this,1,dg,"ImageSourceBlock"))}getSamplerName(e){return e===this._outputs[0]?this._positionSamplerName:e===this._outputs[1]?this._localPositionSamplerName:e===this._outputs[2]?this._depthSamplerName:e===this._outputs[3]?this._screenSpaceDepthSamplerName:e===this._outputs[4]?this._normalSamplerName:e===this._outputs[5]?this._worldNormalSamplerName:""}get position(){return this._outputs[0]}get localPosition(){return this._outputs[1]}get depth(){return this._outputs[2]}get screenDepth(){return this._outputs[3]}get normal(){return this._outputs[4]}get worldNormal(){return this._outputs[5]}get positionSamplerName(){return this._positionSamplerName}get localPositionSamplerName(){return this._localPositionSamplerName}get normalSamplerName(){return this._normalSamplerName}get worldNormalSamplerName(){return this._worldNormalSamplerName}get depthSamplerName(){return this._depthSamplerName}get linearDepthSamplerName(){return this._screenSpaceDepthSamplerName}getClassName(){return"PrePassTextureBlock"}_buildBlock(e){if(super._buildBlock(e),e.target!==gd.Vertex)return this._positionSamplerName="prepassPositionSampler",this._depthSamplerName="prepassDepthSampler",this._normalSamplerName="prepassNormalSampler",this._worldNormalSamplerName="prepassWorldNormalSampler",this._localPositionSamplerName="prepassLocalPositionSampler",this._screenSpaceDepthSamplerName="prepassScreenSpaceDepthSampler",e.sharedData.variableNames.prepassPositionSampler=0,e.sharedData.variableNames.prepassDepthSampler=0,e.sharedData.variableNames.prepassNormalSampler=0,e.sharedData.variableNames.prepassWorldNormalSampler=0,e.sharedData.variableNames.prepassLocalPositionSampler=0,e.sharedData.variableNames.prepassScreenSpaceDepthSampler=0,e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this),this.position.isConnected&&e._emit2DSampler(this._positionSamplerName),this.depth.isConnected&&e._emit2DSampler(this._depthSamplerName),this.normal.isConnected&&e._emit2DSampler(this._normalSamplerName),this.worldNormal.isConnected&&e._emit2DSampler(this._worldNormalSamplerName),this.localPosition.isConnected&&e._emit2DSampler(this._localPositionSamplerName),this.screenDepth.isConnected&&e._emit2DSampler(this._screenSpaceDepthSamplerName),this}bind(e,t){const i=t.getScene().enablePrePassRenderer();if(!i)return;const r=i.defaultRT;r.textures&&(this.position.isConnected&&e.setTexture(this._positionSamplerName,r.textures[i.getIndex(1)]),this.localPosition.isConnected&&e.setTexture(this._localPositionSamplerName,r.textures[i.getIndex(9)]),this.depth.isConnected&&e.setTexture(this._depthSamplerName,r.textures[i.getIndex(5)]),this.screenDepth.isConnected&&e.setTexture(this._screenSpaceDepthSamplerName,r.textures[i.getIndex(10)]),this.normal.isConnected&&e.setTexture(this._normalSamplerName,r.textures[i.getIndex(6)]),this.worldNormal.isConnected&&e.setTexture(this._worldNormalSamplerName,r.textures[i.getIndex(8)]))}}(0,a.Y5)("BABYLON.PrePassTextureBlock",Hg);class $g extends Ed{get endpoints(){return this._endpoints}get target(){const e=this._inputs[0];if(e.isConnected){const t=e.connectedPoint.ownerBlock;if(t.target!==gd.VertexAndFragment)return t.target;if(e.connectedPoint.target!==gd.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){this._target&e||(this._target=e)}constructor(e){super(e,gd.Neutral),this._endpoints=[],this.registerInput("input",_d.AutoDetect)}getClassName(){return"NodeMaterialTeleportInBlock"}get input(){return this._inputs[0]}isConnectedInFragmentShader(){return this.endpoints.some((e=>e.output.isConnectedInFragmentShader))}_dumpCode(e,t){let i=super._dumpCode(e,t);for(const r of this.endpoints)-1===t.indexOf(r)&&(i+=r._dumpCode(e,t));return i}isAnAncestorOf(e){for(const t of this.endpoints){if(t===e)return!0;if(t.isAnAncestorOf(e))return!0}return!1}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name,this._outputs=this._endpoints.map((e=>e.output))}detachFromEndpoint(e){const t=this._endpoints.indexOf(e);-1!==t&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null,this._outputs=this._endpoints.map((e=>e.output)))}dispose(){super.dispose();for(const e of this._endpoints)this.detachFromEndpoint(e);this._endpoints=[]}}(0,a.Y5)("BABYLON.NodeMaterialTeleportInBlock",$g);class qg extends Ed{constructor(e){super(e,gd.Neutral),this._entryPoint=null,this._tempEntryPointUniqueId=null,this.registerOutput("output",_d.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"NodeMaterialTeleportOutBlock"}get output(){return this._outputs[0]}get target(){return this._entryPoint?this._entryPoint.target:this._target}set target(e){this._target&e||(this._target=e)}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(e){super._buildBlock(e),this.entryPoint&&(e.compilationString+=e._declareOutput(this.output)+` = ${this.entryPoint.input.associatedVariableName};\n`)}clone(e,t=""){const i=super.clone(e,t);return this.entryPoint&&this.entryPoint.attachToEndpoint(i),i}_customBuildStep(e,t){this.entryPoint&&this.entryPoint.build(e,t)}_dumpCode(e,t){let i="";return this.entryPoint&&-1===t.indexOf(this.entryPoint)&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});\n`),e}serialize(){const e=super.serialize();return e.entryPoint=this.entryPoint?.uniqueId??"",e}_deserialize(e,t,i){super._deserialize(e,t,i),this._tempEntryPointUniqueId=e.entryPoint}}(0,a.Y5)("BABYLON.NodeMaterialTeleportOutBlock",qg);class Yg extends Ud{constructor(e){super(e)}getClassName(){return"AddBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} + ${this.right.associatedVariableName};\n`,this}}(0,a.Y5)("BABYLON.AddBlock",Yg);class Xg extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("input",_d.AutoDetect),this.registerInput("factor",_d.Float),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ScaleBlock"}get input(){return this._inputs[0]}get factor(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName} * ${this.factor.associatedVariableName};\n`,this}}(0,a.Y5)("BABYLON.ScaleBlock",Xg);class jg extends Ed{constructor(e){super(e,gd.Neutral),this.minimum=0,this.maximum=1,this.registerInput("value",_d.AutoDetect),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ClampBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=1===e.shaderLanguage?e._getShaderType(this.value.type):"";return e.compilationString+=e._declareOutput(t)+` = clamp(${this.value.associatedVariableName}, ${i}(${this._writeFloat(this.minimum)}), ${i}(${this._writeFloat(this.maximum)}));\n`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.minimum = ${this.minimum};\n`;return e+=`${this._codeVariableName}.maximum = ${this.maximum};\n`,e}serialize(){const e=super.serialize();return e.minimum=this.minimum,e.maximum=this.maximum,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.minimum=e.minimum,this.maximum=e.maximum}}(0,Ge.Cg)([xh("Minimum",1,void 0,{embedded:!0})],jg.prototype,"minimum",void 0),(0,Ge.Cg)([xh("Maximum",1,void 0,{embedded:!0})],jg.prototype,"maximum",void 0),(0,a.Y5)("BABYLON.ClampBlock",jg);class Zg extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("left",_d.AutoDetect),this.registerInput("right",_d.AutoDetect),this.registerOutput("output",_d.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(_d.Float),this._inputs[0].excludedConnectionPointTypes.push(_d.Matrix),this._inputs[0].excludedConnectionPointTypes.push(_d.Vector2),this._inputs[1].excludedConnectionPointTypes.push(_d.Float),this._inputs[1].excludedConnectionPointTypes.push(_d.Matrix),this._inputs[1].excludedConnectionPointTypes.push(_d.Vector2)}getClassName(){return"CrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = cross(${this.left.associatedVariableName}.xyz, ${this.right.associatedVariableName}.xyz);\n`,this}}(0,a.Y5)("BABYLON.CrossBlock",Zg);class Qg extends Ed{get options(){return this._options}set options(e){this._deserializeOptions(e)}constructor(e){super(e)}getClassName(){return"CustomBlock"}_buildBlock(e){super._buildBlock(e);let t=this._code,i=this._options.functionName;this._inputs.forEach((r=>{const s=new RegExp("\\{TYPE_"+r.name+"\\}","gm"),n=e._getGLType(r.type);t=t.replace(s,n),i=i.replace(s,n)})),this._outputs.forEach((r=>{const s=new RegExp("\\{TYPE_"+r.name+"\\}","gm"),n=e._getGLType(r.type);t=t.replace(s,n),i=i.replace(s,n)})),e._emitFunction(i,t,""),this._outputs.forEach((t=>{e.compilationString+=e._declareOutput(t)+";\n"})),e.compilationString+=i+"(";let r=!1;return this._inputs.forEach(((t,i)=>{i>0&&(e.compilationString+=", "),this._inputSamplers&&-1!==this._inputSamplers.indexOf(t.name)?e.compilationString+=t.connectedPoint?.ownerBlock?.samplerName??t.associatedVariableName:e.compilationString+=t.associatedVariableName,r=!0})),this._outputs.forEach(((t,i)=>{(i>0||r)&&(e.compilationString+=", "),e.compilationString+=t.associatedVariableName})),e.compilationString+=");\n",this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.options = ${JSON.stringify(this._options)};\n`,e}serialize(){const e=super.serialize();return e.options=this._options,e}_deserialize(e,t,i){this._deserializeOptions(e.options),super._deserialize(e,t,i)}_deserializeOptions(e){this._options=e,this._code=e.code.join("\n")+"\n",this.name=this.name||e.name,this.target=gd[e.target],e.inParameters?.forEach(((e,t)=>{const i=_d[e.type];"sampler2D"===e.type||"samplerCube"===e.type?(this._inputSamplers=this._inputSamplers||[],this._inputSamplers.push(e.name),this.registerInput(e.name,_d.Object,!0,gd.VertexAndFragment,new c_(e.name,this,0,dg,"ImageSourceBlock"))):this.registerInput(e.name,i),Object.defineProperty(this,e.name,{get:function(){return this._inputs[t]},enumerable:!0,configurable:!0})})),e.outParameters?.forEach(((e,t)=>{this.registerOutput(e.name,_d[e.type]),Object.defineProperty(this,e.name,{get:function(){return this._outputs[t]},enumerable:!0,configurable:!0}),"BasedOnInput"===e.type&&(this._outputs[t]._typeConnectionSource=this._findInputByName(e.typeFromInput)[0])})),e.inLinkedConnectionTypes?.forEach((e=>{this._linkConnectionTypes(this._findInputByName(e.input1)[1],this._findInputByName(e.input2)[1])}))}_findInputByName(e){if(!e)return null;for(let t=0;t<this._inputs.length;t++)if(this._inputs[t].name===e)return[this._inputs[t],t];return null}}(0,a.Y5)("BABYLON.CustomBlock",Qg);class Kg extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("left",_d.AutoDetect),this.registerInput("right",_d.AutoDetect),this.registerOutput("output",_d.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(_d.Float),this._inputs[0].excludedConnectionPointTypes.push(_d.Matrix),this._inputs[1].excludedConnectionPointTypes.push(_d.Float),this._inputs[1].excludedConnectionPointTypes.push(_d.Matrix)}getClassName(){return"DotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = dot(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.DotBlock",Kg);class Jg extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("input",_d.AutoDetect),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(_d.Float),this._inputs[0].excludedConnectionPointTypes.push(_d.Matrix)}getClassName(){return"NormalizeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(${i.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.NormalizeBlock",Jg);class ex extends Ed{constructor(e){super(e,gd.Neutral),this.rSwizzle="r",this.gSwizzle="g",this.bSwizzle="b",this.aSwizzle="a",this.registerInput("rgb ",_d.Color3,!0),this.registerInput("r",_d.Float,!0),this.registerInput("g",_d.Float,!0),this.registerInput("b",_d.Float,!0),this.registerInput("a",_d.Float,!0),this.registerOutput("rgba",_d.Color4),this.registerOutput("rgb",_d.Color3)}getClassName(){return"ColorMergerBlock"}get rgbIn(){return this._inputs[0]}get r(){return this._inputs[1]}get g(){return this._inputs[2]}get b(){return this._inputs[3]}get a(){return this._inputs[4]}get rgba(){return this._outputs[0]}get rgbOut(){return this._outputs[1]}get rgb(){return this.rgbOut}_inputRename(e){return"rgb "===e?"rgbIn":e}_buildSwizzle(e){return"."+(this.rSwizzle+this.gSwizzle+this.bSwizzle+this.aSwizzle).substring(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.r,i=this.g,r=this.b,s=this.a,n=this.rgbIn,o=this._outputs[0],a=this._outputs[1],l=e._getShaderType(_d.Vector4),h=e._getShaderType(_d.Vector3);return n.isConnected?(o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${l}(${n.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};\n`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${n.associatedVariableName}${this._buildSwizzle(3)};\n`)):(o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${l}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};\n`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${h}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};\n`)),this}serialize(){const e=super.serialize();return e.rSwizzle=this.rSwizzle,e.gSwizzle=this.gSwizzle,e.bSwizzle=this.bSwizzle,e.aSwizzle=this.aSwizzle,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.rSwizzle=e.rSwizzle??"r",this.gSwizzle=e.gSwizzle??"g",this.bSwizzle=e.bSwizzle??"b",this.aSwizzle=e.aSwizzle??"a"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.rSwizzle = "${this.rSwizzle}";\n`,e+=`${this._codeVariableName}.gSwizzle = "${this.gSwizzle}";\n`,e+=`${this._codeVariableName}.bSwizzle = "${this.bSwizzle}";\n`,e+=`${this._codeVariableName}.aSwizzle = "${this.aSwizzle}";\n`,e}}(0,a.Y5)("BABYLON.ColorMergerBlock",ex);class tx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("xyzw",_d.Vector4,!0),this.registerInput("xyz ",_d.Vector3,!0),this.registerInput("xy ",_d.Vector2,!0),this.registerOutput("xyz",_d.Vector3),this.registerOutput("xy",_d.Vector2),this.registerOutput("zw",_d.Vector2),this.registerOutput("x",_d.Float),this.registerOutput("y",_d.Float),this.registerOutput("z",_d.Float),this.registerOutput("w",_d.Float),this.inputsAreExclusive=!0}getClassName(){return"VectorSplitterBlock"}get xyzw(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get xyzOut(){return this._outputs[0]}get xyOut(){return this._outputs[1]}get zw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get w(){return this._outputs[6]}_inputRename(e){switch(e){case"xy ":return"xyIn";case"xyz ":return"xyzIn";default:return e}}_outputRename(e){switch(e){case"xy":return"xyOut";case"xyz":return"xyzOut";default:return e}}_buildBlock(e){super._buildBlock(e);const t=this.xyzw.isConnected?this.xyzw:this.xyzIn.isConnected?this.xyzIn:this.xyIn,i=this._outputs[0],r=this._outputs[1],s=this._outputs[2],n=this._outputs[3],o=this._outputs[4],a=this._outputs[5],l=this._outputs[6],h=e._getShaderType(_d.Vector3);return i.hasEndpoints&&(t===this.xyIn?e.compilationString+=e._declareOutput(i)+` = ${h}(${t.associatedVariableName}, 0.0);\n`:e.compilationString+=e._declareOutput(i)+` = ${t.associatedVariableName}.xyz;\n`),s.hasEndpoints&&this.xyzw.isConnected&&(e.compilationString+=e._declareOutput(s)+` = ${this.xyzw.associatedVariableName}.zw;\n`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName}.xy;\n`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${t.associatedVariableName}.x;\n`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${t.associatedVariableName}.y;\n`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${t.associatedVariableName}.z;\n`),l.hasEndpoints&&(e.compilationString+=e._declareOutput(l)+` = ${t.associatedVariableName}.w;\n`),this}}(0,a.Y5)("BABYLON.VectorSplitterBlock",tx);class ix extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("left",_d.AutoDetect),this.registerInput("right",_d.AutoDetect),this.registerInput("gradient",_d.AutoDetect),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(_d.Float)}getClassName(){return"LerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.LerpBlock",ix);class rx extends Ud{constructor(e){super(e)}getClassName(){return"DivideBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} / ${this.right.associatedVariableName};\n`,this}}(0,a.Y5)("BABYLON.DivideBlock",rx);class sx extends Ud{constructor(e){super(e)}getClassName(){return"SubtractBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} - ${this.right.associatedVariableName};\n`,this}}(0,a.Y5)("BABYLON.SubtractBlock",sx);class nx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("value",_d.Float),this.registerInput("edge",_d.Float),this.registerOutput("output",_d.Float)}getClassName(){return"StepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = step(${this.edge.associatedVariableName}, ${this.value.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.StepBlock",nx);class ox extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("input",_d.AutoDetect),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0].excludedConnectionPointTypes.push(_d.Matrix)}getClassName(){return"OneMinusBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = 1. - ${this.input.associatedVariableName};\n`,this}}(0,a.Y5)("BABYLON.OneMinusBlock",ox),(0,a.Y5)("BABYLON.OppositeBlock",ox);class ax extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("worldPosition",_d.Vector4),this.registerInput("cameraPosition",_d.Vector3),this.registerOutput("output",_d.Vector3)}getClassName(){return"ViewDirectionBlock"}get worldPosition(){return this._inputs[0]}get cameraPosition(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===bd.CameraPosition&&t(e)));i||(i=new Fd("cameraPosition"),i.setAsSystemValue(bd.CameraPosition)),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(${this.cameraPosition.associatedVariableName} - ${this.worldPosition.associatedVariableName}.xyz);\n`,this}}(0,a.Y5)("BABYLON.ViewDirectionBlock",ax);var lx;i(51339);class hx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("worldNormal",_d.Vector4),this.registerInput("viewDirection",_d.Vector3),this.registerInput("bias",_d.Float),this.registerInput("power",_d.Float),this.registerOutput("fresnel",_d.Float)}getClassName(){return"FresnelBlock"}get worldNormal(){return this._inputs[0]}get viewDirection(){return this._inputs[1]}get bias(){return this._inputs[2]}get power(){return this._inputs[3]}get fresnel(){return this._outputs[0]}autoConfigure(e){if(!this.viewDirection.isConnected){const t=new ax("View direction");t.output.connectTo(this.viewDirection),t.autoConfigure(e)}if(!this.bias.isConnected){const e=new Fd("bias");e.value=0,e.output.connectTo(this.bias)}if(!this.power.isConnected){const e=new Fd("power");e.value=1,e.output.connectTo(this.power)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;return e._emitFunctionFromInclude("fresnelFunction",t,{removeIfDef:!0}),e.compilationString+=e._declareOutput(this.fresnel)+` = computeFresnelTerm(${this.viewDirection.associatedVariableName}.xyz, ${this.worldNormal.associatedVariableName}.xyz, ${this.bias.associatedVariableName}, ${this.power.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.FresnelBlock",hx);class cx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("left",_d.AutoDetect),this.registerInput("right",_d.AutoDetect),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MaxBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = max(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.MaxBlock",cx);class ux extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("left",_d.AutoDetect),this.registerInput("right",_d.AutoDetect),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MinBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = min(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.MinBlock",ux);class dx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("left",_d.AutoDetect),this.registerInput("right",_d.AutoDetect),this.registerOutput("output",_d.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(_d.Float),this._inputs[0].excludedConnectionPointTypes.push(_d.Matrix),this._inputs[1].excludedConnectionPointTypes.push(_d.Float),this._inputs[1].excludedConnectionPointTypes.push(_d.Matrix)}getClassName(){return"DistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = length(${this.left.associatedVariableName} - ${this.right.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.DistanceBlock",dx);class px extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("value",_d.AutoDetect),this.registerOutput("output",_d.Float),this._inputs[0].excludedConnectionPointTypes.push(_d.Float),this._inputs[0].excludedConnectionPointTypes.push(_d.Matrix)}getClassName(){return"LengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = length(${this.value.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.LengthBlock",px);class mx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("value",_d.AutoDetect),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NegateBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = -1.0 * ${this.value.associatedVariableName};\n`,this}}(0,a.Y5)("BABYLON.NegateBlock",mx);class fx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("value",_d.AutoDetect),this.registerInput("power",_d.AutoDetect),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"PowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = pow(max(${this.value.associatedVariableName}, 0.), ${this.power.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.PowBlock",fx);class _x extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("seed",_d.AutoDetect),this.registerOutput("output",_d.Float),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(_d.Vector2|_d.Vector3|_d.Vector4|_d.Color3|_d.Color4)}getClassName(){return"RandomNumberBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",i),e.compilationString+=e._declareOutput(t)+` = getRand(${this.seed.associatedVariableName}.xy);\n`,this}}(0,a.Y5)("BABYLON.RandomNumberBlock",_x);class gx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("x",_d.Float),this.registerInput("y",_d.Float),this.registerOutput("output",_d.Float)}getClassName(){return"ArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=1===e.shaderLanguage?"atan2":"atan";return e.compilationString+=e._declareOutput(t)+` = ${i}(${this.x.associatedVariableName}, ${this.y.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.ArcTan2Block",gx);class xx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("value",_d.AutoDetect),this.registerInput("edge0",_d.Float),this.registerInput("edge1",_d.Float),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"SmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=e._getShaderType(this.value.type);return e.compilationString+=e._declareOutput(t)+` = smoothstep(${i}(${this.edge0.associatedVariableName}), ${i}(${this.edge1.associatedVariableName}), ${this.value.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.SmoothStepBlock",xx);class vx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("input",_d.AutoDetect),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ReciprocalBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return this.input.type===_d.Matrix?e.compilationString+=e._declareOutput(t)+` = inverse(${this.input.associatedVariableName});\n`:e.compilationString+=e._declareOutput(t)+` = 1. / ${this.input.associatedVariableName};\n`,this}}(0,a.Y5)("BABYLON.ReciprocalBlock",vx);class Sx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("value",_d.AutoDetect),this.registerInput("reference",_d.AutoDetect),this.registerInput("distance",_d.Float),this.registerInput("replacement",_d.AutoDetect),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push(_d.Float),this._inputs[0].excludedConnectionPointTypes.push(_d.Matrix),this._inputs[1].excludedConnectionPointTypes.push(_d.Float),this._inputs[1].excludedConnectionPointTypes.push(_d.Matrix),this._inputs[3].excludedConnectionPointTypes.push(_d.Float),this._inputs[3].excludedConnectionPointTypes.push(_d.Matrix)}getClassName(){return"ReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+";\n",e.compilationString+=`if (length(${this.value.associatedVariableName} - ${this.reference.associatedVariableName}) < ${this.distance.associatedVariableName}) {\n`,e.compilationString+=`${t.associatedVariableName} = ${this.replacement.associatedVariableName};\n`,e.compilationString+="} else {\n",e.compilationString+=`${t.associatedVariableName} = ${this.value.associatedVariableName};\n`,e.compilationString+="}\n",this}}(0,a.Y5)("BABYLON.ReplaceColorBlock",Sx);class bx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("value",_d.AutoDetect),this.registerInput("steps",_d.AutoDetect),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(_d.Matrix),this._inputs[1].excludedConnectionPointTypes.push(_d.Matrix),this._inputs[1].acceptedConnectionPointTypes.push(_d.Float)}getClassName(){return"PosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = floor(${this.value.associatedVariableName} / (1.0 / ${this.steps.associatedVariableName})) * (1.0 / ${this.steps.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.PosterizeBlock",bx),function(e){e[e.SawTooth=0]="SawTooth",e[e.Square=1]="Square",e[e.Triangle=2]="Triangle"}(lx||(lx={}));class yx extends Ed{constructor(e){super(e,gd.Neutral),this.kind=0,this.registerInput("input",_d.AutoDetect),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(_d.Matrix)}getClassName(){return"WaveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];switch(this.kind){case 0:e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName});\n`;break;case 1:e.compilationString+=e._declareOutput(t)+` = 1.0 - 2.0 * round(fract(${this.input.associatedVariableName}));\n`;break;case 2:e.compilationString+=e._declareOutput(t)+` = 2.0 * abs(2.0 * (${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName}))) - 1.0;\n`}return this}serialize(){const e=super.serialize();return e.kind=this.kind,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.kind=e.kind}}(0,Ge.Cg)([xh("Kind",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"SawTooth",value:0},{label:"Square",value:1},{label:"Triangle",value:2}]})],yx.prototype,"kind",void 0),(0,a.Y5)("BABYLON.WaveBlock",yx);class Px{get step(){return this._step}set step(e){this._step=e}get color(){return this._color}set color(e){this._color=e}constructor(e,t){this.step=e,this.color=t}}class Tx extends Ed{colorStepsUpdated(){this.onValueChangedObservable.notifyObservers(this)}constructor(e){super(e,gd.Neutral),this.colorSteps=[new Px(0,o.v9.Black()),new Px(1,o.v9.White())],this.onValueChangedObservable=new s.cP,this.registerInput("gradient",_d.AutoDetect),this.registerOutput("output",_d.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(_d.Float|_d.Vector2|_d.Vector3|_d.Vector4|_d.Color3|_d.Color4)}getClassName(){return"GradientBlock"}get gradient(){return this._inputs[0]}get output(){return this._outputs[0]}_writeColorConstant(e,t){const i=this.colorSteps[e];return`${t}(${i.color.r}, ${i.color.g}, ${i.color.b})`}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=e._getShaderType(_d.Vector3);if(!this.colorSteps.length||!this.gradient.connectedPoint)return void(e.compilationString+=e._declareOutput(t)+` = ${i}(0., 0., 0.);\n`);const r=e._getFreeVariableName("gradientTempColor"),s=e._getFreeVariableName("gradientTempPosition");e.compilationString+=`${e._declareLocalVar(r,_d.Vector3)} = ${this._writeColorConstant(0,i)};\n`,e.compilationString+=`${e._declareLocalVar(s,_d.Float)};\n`;let n=this.gradient.associatedVariableName;this.gradient.connectedPoint.type!==_d.Float&&(n+=".x");for(let t=1;t<this.colorSteps.length;t++){const o=this.colorSteps[t],a=this.colorSteps[t-1];e.compilationString+=`${s} = clamp((${n} - ${e._emitFloat(a.step)}) / (${e._emitFloat(o.step)} -  ${e._emitFloat(a.step)}), 0.0, 1.0) * step(${e._emitFloat(t)}, ${e._emitFloat(this.colorSteps.length-1)});\n`,e.compilationString+=`${r} = mix(${r}, ${this._writeColorConstant(t,i)}, ${s});\n`}return e.compilationString+=e._declareOutput(t)+` = ${r};\n`,this}serialize(){const e=super.serialize();e.colorSteps=[];for(const t of this.colorSteps)e.colorSteps.push({step:t.step,color:{r:t.color.r,g:t.color.g,b:t.color.b}});return e}_deserialize(e,t,i){super._deserialize(e,t,i),this.colorSteps.length=0;for(const t of e.colorSteps)this.colorSteps.push(new Px(t.step,new o.v9(t.color.r,t.color.g,t.color.b)))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();e+=`${this._codeVariableName}.colorSteps = [];\n`;for(const t of this.colorSteps)e+=`${this._codeVariableName}.colorSteps.push(new BABYLON.GradientBlockColorStep(${t.step}, new BABYLON.Color3(${t.color.r}, ${t.color.g}, ${t.color.b})));\n`;return e}}(0,a.Y5)("BABYLON.GradientBlock",Tx);class Cx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("left",_d.AutoDetect),this.registerInput("right",_d.AutoDetect),this.registerInput("gradient",_d.AutoDetect),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(_d.Float)}getClassName(){return"NLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName}));\n`,this}}(0,a.Y5)("BABYLON.NLerpBlock",Cx);class Ex extends Ed{constructor(e){super(e,gd.Neutral),this.manhattanDistance=!1,this.registerInput("seed",_d.Vector3),this.registerInput("jitter",_d.Float),this.registerOutput("output",_d.Vector2),this.registerOutput("x",_d.Float),this.registerOutput("y",_d.Float)}getClassName(){return"WorleyNoise3DBlock"}get seed(){return this._inputs[0]}get jitter(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;if(!this.output.hasEndpoints&&!this.x.hasEndpoints&&!this.y.hasEndpoints)return;let t="vec3 permute(vec3 x){\n";t+="    return mod((34.0 * x + 1.0) * x, 289.0);\n",t+="}\n\n",t+="vec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\n",t+="    return [manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z)];\n",t+="}\n\n",t+="vec2 worley(vec3 P, float jitter, bool manhattanDistance){\n",t+="    float K = 0.142857142857; // 1/7\n",t+="    float Ko = 0.428571428571; // 1/2-K/2\n",t+="    float  K2 = 0.020408163265306; // 1/(7*7)\n",t+="    float Kz = 0.166666666667; // 1/6\n",t+="    float Kzo = 0.416666666667; // 1/2-1/6*2\n",t+="\n",t+="    vec3 Pi = mod(floor(P), 289.0);\n",t+="    vec3 Pf = fract(P) - 0.5;\n",t+="\n",t+="    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\n",t+="    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\n",t+="    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\n",t+="\n",t+="    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\n",t+="    vec3 p1 = permute(p + Pi.y - 1.0);\n",t+="    vec3 p2 = permute(p + Pi.y);\n",t+="    vec3 p3 = permute(p + Pi.y + 1.0);\n",t+="\n",t+="    vec3 p11 = permute(p1 + Pi.z - 1.0);\n",t+="    vec3 p12 = permute(p1 + Pi.z);\n",t+="    vec3 p13 = permute(p1 + Pi.z + 1.0);\n",t+="\n",t+="    vec3 p21 = permute(p2 + Pi.z - 1.0);\n",t+="    vec3 p22 = permute(p2 + Pi.z);\n",t+="    vec3 p23 = permute(p2 + Pi.z + 1.0);\n",t+="\n",t+="    vec3 p31 = permute(p3 + Pi.z - 1.0);\n",t+="    vec3 p32 = permute(p3 + Pi.z);\n",t+="    vec3 p33 = permute(p3 + Pi.z + 1.0);\n",t+="\n",t+="    vec3 ox11 = fract(p11*K) - Ko;\n",t+="    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\n",t+="    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\n",t+="\n",t+="    vec3 ox12 = fract(p12*K) - Ko;\n",t+="    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\n",t+="    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox13 = fract(p13*K) - Ko;\n",t+="    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\n",t+="    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox21 = fract(p21*K) - Ko;\n",t+="    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\n",t+="    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox22 = fract(p22*K) - Ko;\n",t+="    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\n",t+="    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox23 = fract(p23*K) - Ko;\n",t+="    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\n",t+="    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox31 = fract(p31*K) - Ko;\n",t+="    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\n",t+="    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox32 = fract(p32*K) - Ko;\n",t+="    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\n",t+="    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox33 = fract(p33*K) - Ko;\n",t+="    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\n",t+="    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 dx11 = Pfx + jitter*ox11;\n",t+="    vec3 dy11 = Pfy.x + jitter*oy11;\n",t+="    vec3 dz11 = Pfz.x + jitter*oz11;\n",t+="\n",t+="    vec3 dx12 = Pfx + jitter*ox12;\n",t+="    vec3 dy12 = Pfy.x + jitter*oy12;\n",t+="    vec3 dz12 = Pfz.y + jitter*oz12;\n",t+="\n",t+="    vec3 dx13 = Pfx + jitter*ox13;\n",t+="    vec3 dy13 = Pfy.x + jitter*oy13;\n",t+="    vec3 dz13 = Pfz.z + jitter*oz13;\n",t+="\n",t+="    vec3 dx21 = Pfx + jitter*ox21;\n",t+="    vec3 dy21 = Pfy.y + jitter*oy21;\n",t+="    vec3 dz21 = Pfz.x + jitter*oz21;\n",t+="\n",t+="    vec3 dx22 = Pfx + jitter*ox22;\n",t+="    vec3 dy22 = Pfy.y + jitter*oy22;\n",t+="    vec3 dz22 = Pfz.y + jitter*oz22;\n",t+="\n",t+="    vec3 dx23 = Pfx + jitter*ox23;\n",t+="    vec3 dy23 = Pfy.y + jitter*oy23;\n",t+="    vec3 dz23 = Pfz.z + jitter*oz23;\n",t+="\n",t+="    vec3 dx31 = Pfx + jitter*ox31;\n",t+="    vec3 dy31 = Pfy.z + jitter*oy31;\n",t+="    vec3 dz31 = Pfz.x + jitter*oz31;\n",t+="\n",t+="    vec3 dx32 = Pfx + jitter*ox32;\n",t+="    vec3 dy32 = Pfy.z + jitter*oy32;\n",t+="    vec3 dz32 = Pfz.y + jitter*oz32;\n",t+="\n",t+="    vec3 dx33 = Pfx + jitter*ox33;\n",t+="    vec3 dy33 = Pfy.z + jitter*oy33;\n",t+="    vec3 dz33 = Pfz.z + jitter*oz33;\n",t+="\n",t+="    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\n",t+="    vec3 d12 = dist(dx12, dy12, dz12, manhattanDistance);\n",t+="    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\n",t+="    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\n",t+="    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\n",t+="    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\n",t+="    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\n",t+="    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\n",t+="    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\n",t+="\n",t+="    vec3 d1a = min(d11, d12);\n",t+="    d12 = max(d11, d12);\n",t+="    d11 = min(d1a, d13); // Smallest now not in d12 or d13\n",t+="    d13 = max(d1a, d13);\n",t+="    d12 = min(d12, d13); // 2nd smallest now not in d13\n",t+="    vec3 d2a = min(d21, d22);\n",t+="    d22 = max(d21, d22);\n",t+="    d21 = min(d2a, d23); // Smallest now not in d22 or d23\n",t+="    d23 = max(d2a, d23);\n",t+="    d22 = min(d22, d23); // 2nd smallest now not in d23\n",t+="    vec3 d3a = min(d31, d32);\n",t+="    d32 = max(d31, d32);\n",t+="    d31 = min(d3a, d33); // Smallest now not in d32 or d33\n",t+="    d33 = max(d3a, d33);\n",t+="    d32 = min(d32, d33); // 2nd smallest now not in d33\n",t+="    vec3 da = min(d11, d21);\n",t+="    d21 = max(d11, d21);\n",t+="    d11 = min(da, d31); // Smallest now in d11\n",t+="    d31 = max(da, d31); // 2nd smallest now not in d31\n",t+="    if (d11.x >= d11.y) { vec2 temp = d11.yx; d11.x = temp.x; d11.y = temp.y; }\n",t+="    if (d11.x >= d11.z) { vec2 temp = d11.zx; d11.x = temp.x; d11.z = temp.y; }\n",t+="    d12 = min(d12, d21); // 2nd smallest now not in d21\n",t+="    d12 = min(d12, d22); // nor in d22\n",t+="    d12 = min(d12, d31); // nor in d31\n",t+="    d12 = min(d12, d32); // nor in d32\n",t+="    vec2 temp2 = min(d11.yz, d12.xy); // nor in d12.yz\n",t+="    d11.y = temp2.x;\n",t+="    d11.z = temp2.y;\n",t+="    d11.y = min(d11.y, d12.z); // Only two more to go\n",t+="    d11.y = min(d11.y, d11.z); // Done! (Phew!)\n",t+="    return sqrt(d11.xy); // F1, F2\n",t+="}\n\n",t=1===e.shaderLanguage?e._babylonSLtoWGSL(t):e._babylonSLtoGLSL(t),e._emitFunction("worley3D",t,"// Worley3D");const i=e._getFreeVariableName("worleyTemp");return e.compilationString+=`${e._declareLocalVar(i,_d.Vector2)} = worley(${this.seed.associatedVariableName}, ${this.jitter.associatedVariableName}, ${this.manhattanDistance});\n`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${i};\n`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${i}.x;\n`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${i}.y;\n`),this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.manhattanDistance = ${this.manhattanDistance};\n`}serialize(){const e=super.serialize();return e.manhattanDistance=this.manhattanDistance,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.manhattanDistance=e.manhattanDistance}}(0,Ge.Cg)([xh("Use Manhattan Distance",0,"PROPERTIES",{embedded:!0,notifiers:{update:!1}})],Ex.prototype,"manhattanDistance",void 0),(0,a.Y5)("BABYLON.WorleyNoise3DBlock",Ex);class Ax extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("seed",_d.Vector3),this.registerOutput("output",_d.Float)}getClassName(){return"SimplexPerlin3DBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;if(!this._outputs[0].hasEndpoints)return;let t="const float SKEWFACTOR = 1.0/3.0;\n";return t+="const float UNSKEWFACTOR = 1.0/6.0;\n",t+="const float SIMPLEX_CORNER_POS = 0.5;\n",t+="const float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\n",t+="float SimplexPerlin3D( vec3 source ){\n",t+="    vec3 P = source;\n",t+="    P.x = [P.x == 0. && P.y == 0. && P.z == 0. ? 0.00001 : P.x];\n",t+="    P *= SIMPLEX_TETRAHADRON_HEIGHT;\n",t+="    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );",t+="    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\n",t+="    vec3 g = step(x0.yzx, x0.xyz);\n",t+="    vec3 l = 1.0 - g;\n",t+="    vec3 Pi_1 = min( g.xyz, l.zxy );\n",t+="    vec3 Pi_2 = max( g.xyz, l.zxy );\n",t+="    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\n",t+="    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\n",t+="    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\n",t+="    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\n",t+="    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\n",t+="    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\n",t+="    Pi = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\n",t+="    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\n",t+="    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\n",t+="    Pt *= Pt;\n",t+="    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\n",t+="    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\n",t+="    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\n",t+="    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\n",t+="    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\n",t+="    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\n",t+="    Pi_1 = [( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods];\n",t+="    Pi_2 = [( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods];\n",t+="    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\n",t+="    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\n",t+="    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\n",t+="    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\n",t+="    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\n",t+="    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\n",t+="    kernel_weights = max(0.5 - kernel_weights, vec4(0.));\n",t+="    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\n",t+="    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\n",t+="}\n",t=1===e.shaderLanguage?e._babylonSLtoWGSL(t):e._babylonSLtoGLSL(t),e._emitFunction("SimplexPerlin3D",t,"// SimplexPerlin3D"),e.compilationString+=e._declareOutput(this._outputs[0])+` = SimplexPerlin3D(${this.seed.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.SimplexPerlin3DBlock",Ax);class Ix extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("normalMap0",_d.AutoDetect),this.registerInput("normalMap1",_d.AutoDetect),this.registerOutput("output",_d.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(_d.Color3|_d.Color4|_d.Vector3|_d.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(_d.Color3|_d.Color4|_d.Vector3|_d.Vector4)}getClassName(){return"NormalBlendBlock"}get normalMap0(){return this._inputs[0]}get normalMap1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0],r=this._inputs[1],s=e._getFreeVariableName("stepR"),n=e._getFreeVariableName("stepG");return e.compilationString+=`${e._declareLocalVar(s,_d.Float)} = step(0.5, ${i.associatedVariableName}.r);\n`,e.compilationString+=`${e._declareLocalVar(n,_d.Float)} = step(0.5, ${i.associatedVariableName}.g);\n`,e.compilationString+=e._declareOutput(t)+";\n",e.compilationString+=`${t.associatedVariableName}.r = (1.0 - ${s}) * ${i.associatedVariableName}.r * ${r.associatedVariableName}.r * 2.0 + ${s} * (1.0 - (1.0 - ${i.associatedVariableName}.r) * (1.0 - ${r.associatedVariableName}.r) * 2.0);\n`,e.compilationString+=`${t.associatedVariableName}.g = (1.0 - ${n}) * ${i.associatedVariableName}.g * ${r.associatedVariableName}.g * 2.0 + ${n} * (1.0 - (1.0 - ${i.associatedVariableName}.g) * (1.0 - ${r.associatedVariableName}.g) * 2.0);\n`,e.compilationString+=`${t.associatedVariableName}.b = ${i.associatedVariableName}.b * ${r.associatedVariableName}.b;\n`,this}}(0,a.Y5)("BABYLON.NormalBlendBlock",Ix);class Rx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("input",_d.Vector2),this.registerInput("angle",_d.Float),this.registerOutput("output",_d.Vector2)}getClassName(){return"Rotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new Fd("angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.angle,r=this.input;return e.compilationString+=e._declareOutput(t)+` = vec2(cos(${i.associatedVariableName}) * ${r.associatedVariableName}.x - sin(${i.associatedVariableName}) * ${r.associatedVariableName}.y, sin(${i.associatedVariableName}) * ${r.associatedVariableName}.x + cos(${i.associatedVariableName}) * ${r.associatedVariableName}.y);\n`,this}}(0,a.Y5)("BABYLON.Rotate2dBlock",Rx);class Mx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("incident",_d.AutoDetect),this.registerInput("normal",_d.AutoDetect),this.registerOutput("output",_d.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(_d.Vector3|_d.Vector4|_d.Color3|_d.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(_d.Vector3|_d.Vector4|_d.Color3|_d.Color4)}getClassName(){return"ReflectBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = reflect(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz);\n`,this}}(0,a.Y5)("BABYLON.ReflectBlock",Mx);class Dx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("incident",_d.AutoDetect),this.registerInput("normal",_d.AutoDetect),this.registerInput("ior",_d.Float),this.registerOutput("output",_d.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(_d.Vector3|_d.Vector4|_d.Color3|_d.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(_d.Vector3|_d.Vector4|_d.Color3|_d.Color4)}getClassName(){return"RefractBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get ior(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = refract(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz, ${this.ior.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.RefractBlock",Dx);class Ox extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("color",_d.Color3),this.registerInput("level",_d.Float),this.registerOutput("output",_d.Color3)}getClassName(){return"DesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.color.associatedVariableName,r=e._getFreeVariableName("colorMin"),s=e._getFreeVariableName("colorMax"),n=e._getFreeVariableName("colorMerge");return e.compilationString+=`${e._declareLocalVar(r,_d.Float)} = min(min(${i}.x, ${i}.y), ${i}.z);\n`,e.compilationString+=`${e._declareLocalVar(s,_d.Float)} = max(max(${i}.x, ${i}.y), ${i}.z);\n`,e.compilationString+=`${e._declareLocalVar(n,_d.Float)} = 0.5 * (${r} + ${s});\n`,e.compilationString+=e._declareOutput(t)+` = mix(${i}, ${e._getShaderType(_d.Vector3)}(${n}, ${n}, ${n}), ${this.level.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.DesaturateBlock",Ox);class Nx extends Ed{constructor(e){super(e,gd.Fragment),this.albedoScaling=!1,this.linkSheenWithAlbedo=!1,this._isUnique=!0,this.registerInput("intensity",_d.Float,!0,gd.Fragment),this.registerInput("color",_d.Color3,!0,gd.Fragment),this.registerInput("roughness",_d.Float,!0,gd.Fragment),this.registerOutput("sheen",_d.Object,gd.Fragment,new c_("sheen",this,1,Nx,"SheenBlock"))}initialize(e){e._excludeVariableName("sheenOut"),e._excludeVariableName("sheenMapData"),e._excludeVariableName("vSheenColor"),e._excludeVariableName("vSheenRoughness")}getClassName(){return"SheenBlock"}get intensity(){return this._inputs[0]}get color(){return this._inputs[1]}get roughness(){return this._inputs[2]}get sheen(){return this._outputs[0]}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("SHEEN",!0),i.setValue("SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("SHEEN_LINKWITHALBEDO",this.linkSheenWithAlbedo,!0),i.setValue("SHEEN_ROUGHNESS",this.roughness.isConnected,!0),i.setValue("SHEEN_ALBEDOSCALING",this.albedoScaling,!0)}getCode(e,t){let i="";const r=this.color.isConnected?this.color.associatedVariableName:`vec3${t.fSuffix}(1.)`,s=this.intensity.isConnected?this.intensity.associatedVariableName:"1.",n=this.roughness.isConnected?this.roughness.associatedVariableName:"0.",o=`vec4${t.fSuffix}(0.)`,a=1===t.shaderLanguage;return i=`#ifdef SHEEN\n            ${a?"var sheenOut: sheenOutParams":"sheenOutParams sheenOut"};\n\n            ${t._declareLocalVar("vSheenColor",_d.Vector4)} = vec4${t.fSuffix}(${r}, ${s});\n\n            sheenOut = sheenBlock(\n                vSheenColor\n            #ifdef SHEEN_ROUGHNESS\n                , ${n}\n            #endif\n                , roughness\n            #ifdef SHEEN_TEXTURE\n                , ${o}\n                ${a?`, ${o}Sampler`:""}\n                , 1.0\n            #endif\n                , reflectance\n            #ifdef SHEEN_LINKWITHALBEDO\n                , baseColor\n                , surfaceAlbedo\n            #endif\n            #ifdef ENVIRONMENTBRDF\n                , NdotV\n                , environmentBrdf\n            #endif\n            #if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n                , AARoughnessFactors\n                , ${a?"uniforms.":""}${e?._vReflectionMicrosurfaceInfosName}\n                , ${e?._vReflectionInfosName}\n                , ${e?.reflectionColor}\n                , ${a?"uniforms.":""}vLightingIntensity\n                #ifdef ${e?._define3DName}\n                    , ${e?._cubeSamplerName}                                      \n                    ${a?`, ${e?._cubeSamplerName}Sampler`:""}\n                #else\n                    , ${e?._2DSamplerName}\n                    ${a?`, ${e?._2DSamplerName}Sampler`:""}\n                #endif\n                , reflectionOut.reflectionCoords\n                , NdotVUnclamped\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${e?._define3DName}\n                        , ${e?._cubeSamplerName}                        \n                        ${a?`, ${e?._cubeSamplerName}Sampler`:""}\n                        , ${e?._cubeSamplerName}\n                        ${a?`, ${e?._cubeSamplerName}Sampler`:""}\n                    #else\n                        , ${e?._2DSamplerName}\n                        ${a?`, ${e?._2DSamplerName}Sampler`:""}\n                        , ${e?._2DSamplerName}\n                        ${a?`, ${e?._2DSamplerName}Sampler`:""}\n                    #endif\n                #endif\n                #if !defined(${e?._defineSkyboxName}) && defined(RADIANCEOCCLUSION)\n                    , seo\n                #endif\n                #if !defined(${e?._defineSkyboxName}) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(${e?._define3DName})\n                    , eho\n                #endif\n            #endif\n            );\n\n            #ifdef SHEEN_LINKWITHALBEDO\n                surfaceAlbedo = sheenOut.surfaceAlbedo;\n            #endif\n        #endif\n`,i}_buildBlock(e){return e.target===gd.Fragment&&e.sharedData.blocksWithDefines.push(this),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.albedoScaling = ${this.albedoScaling};\n`,e+=`${this._codeVariableName}.linkSheenWithAlbedo = ${this.linkSheenWithAlbedo};\n`,e}serialize(){const e=super.serialize();return e.albedoScaling=this.albedoScaling,e.linkSheenWithAlbedo=this.linkSheenWithAlbedo,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.albedoScaling=e.albedoScaling,this.linkSheenWithAlbedo=e.linkSheenWithAlbedo}}(0,Ge.Cg)([xh("Albedo scaling",0,"PROPERTIES",{embedded:!0,notifiers:{update:!0}})],Nx.prototype,"albedoScaling",void 0),(0,Ge.Cg)([xh("Link sheen with albedo",0,"PROPERTIES",{embedded:!0,notifiers:{update:!0}})],Nx.prototype,"linkSheenWithAlbedo",void 0),(0,a.Y5)("BABYLON.SheenBlock",Nx);var wx=i(4109);class Fx extends Ed{constructor(e){super(e,gd.Fragment),this._tangentCorrectionFactorName="",this._isUnique=!0,this.registerInput("intensity",_d.Float,!0,gd.Fragment),this.registerInput("direction",_d.Vector2,!0,gd.Fragment),this.registerInput("uv",_d.Vector2,!0),this.registerInput("worldTangent",_d.Vector4,!0),this.registerInput("TBN",_d.Object,!0,gd.VertexAndFragment,new c_("TBN",this,0,N_,"TBNBlock")),this.registerInput("roughness",_d.Float,!0,gd.Fragment),this.registerOutput("anisotropy",_d.Object,gd.Fragment,new c_("anisotropy",this,1,Fx,"AnisotropyBlock"))}initialize(e){e._excludeVariableName("anisotropicOut"),e._excludeVariableName("TBN")}getClassName(){return"AnisotropyBlock"}get intensity(){return this._inputs[0]}get direction(){return this._inputs[1]}get uv(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get TBN(){return this._inputs[4]}get roughness(){return this._inputs[5]}get anisotropy(){return this._outputs[0]}_generateTBNSpace(e){let t="";const i=`//${this.name}`,r=this.uv,s=this.worldPositionConnectionPoint,n=this.worldNormalConnectionPoint,o=this.worldTangent,a=1===e.shaderLanguage;r.isConnected||m.V.Error("You must connect the 'uv' input of the Anisotropy block!"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const l={search:/defined\(TANGENT\)/g,replace:o.isConnected?"defined(TANGENT)":"defined(IGNORE)"},h=this.TBN;return h.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n            ${a?"var TBN":"mat3 TBN"} = ${h.associatedVariableName};\n            #endif\n            `:o.isConnected&&(t+=`${e._declareLocalVar("tbnNormal",_d.Vector3)} = normalize(${n.associatedVariableName}.xyz);\n`,t+=`${e._declareLocalVar("tbnTangent",_d.Vector3)} = normalize(${o.associatedVariableName}.xyz);\n`,t+=`${e._declareLocalVar("tbnBitangent",_d.Vector3)} = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\n`,t+=`${a?"var vTBN":"mat3 vTBN"} = ${a?"mat3x3f":"mat3"}(tbnTangent, tbnBitangent, tbnNormal);\n`),t+=`\n            #if defined(${o.isConnected?"TANGENT":"IGNORE"}) && defined(NORMAL)\n                ${a?"var TBN":"mat3 TBN"} = vTBN;\n            #else\n                ${a?"var TBN":"mat3 TBN"} = cotangent_frame(${n.associatedVariableName+".xyz"}, ${"v_"+s.associatedVariableName+".xyz"}, ${r.isConnected?r.associatedVariableName:"vec2(0.)"}, vec2${e.fSuffix}(1., 1.));\n            #endif\n`,e._emitFunctionFromInclude("bumpFragmentMainFunctions",i,{replaceStrings:[l]}),t}getCode(e,t=!1){let i="";t&&(i+=this._generateTBNSpace(e));const r=1===e.shaderLanguage,s=this.intensity.isConnected?this.intensity.associatedVariableName:"1.0";return i+=`${r?"var anisotropicOut: anisotropicOutParams":"anisotropicOutParams anisotropicOut"};\n            anisotropicOut = anisotropicBlock(\n                vec3(${this.direction.isConnected?this.direction.associatedVariableName:"vec2(1., 0.)"}, ${s}),\n                ${this.roughness.isConnected?this.roughness.associatedVariableName:"0."},\n            #ifdef ANISOTROPIC_TEXTURE\n                vec3(0.),\n            #endif\n                TBN,\n                normalW,\n                viewDirectionW\n            );\n`,i}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("ANISOTROPIC",!0),i.setValue("ANISOTROPIC_TEXTURE",!1,!0),i.setValue("ANISOTROPIC_LEGACY",!this.roughness.isConnected)}bind(e,t,i){super.bind(e,t,i),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_buildBlock(e){return e.target===gd.Fragment&&(e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,_d.Float)),this}}(0,a.Y5)("BABYLON.AnisotropyBlock",Fx);class Bx extends mg{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,m.V.Error("The position input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?gd.Fragment:gd.Vertex,this.generateOnlyFragmentCode&&(this.forceIrradianceInFragment=!0)}constructor(e){super(e),this.useSphericalHarmonics=!0,this.forceIrradianceInFragment=!1,this._isUnique=!0,this.registerInput("position",_d.AutoDetect,!1,gd.Vertex),this.registerInput("world",_d.Matrix,!1,gd.Vertex),this.registerInput("color",_d.Color3,!0,gd.Fragment),this.registerOutput("reflection",_d.Object,gd.Fragment,new c_("reflection",this,1,Bx,"ReflectionBlock")),this.position.addExcludedConnectionPointFromAllowedTypes(_d.Color3|_d.Vector3|_d.Vector4)}getClassName(){return"ReflectionBlock"}get position(){return this._inputs[0]}get worldPosition(){return this.worldPositionConnectionPoint}get worldNormal(){return this.worldNormalConnectionPoint}get world(){return this._inputs[1]}get cameraPosition(){return this.cameraPositionConnectionPoint}get view(){return this.viewConnectionPoint}get color(){return this._inputs[2]}get reflection(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}get reflectionColor(){return this.color.isConnected?this.color.associatedVariableName:"vec3(1., 1., 1.)"}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const r=this._getTexture(),s=r&&r.getTextureMatrix;i.setValue("REFLECTION",s,!0),s&&(i.setValue(this._defineLODReflectionAlpha,r.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularReflection,r.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!r.invertZ:r.invertZ,!0),i.setValue("SPHERICAL_HARMONICS",this.useSphericalHarmonics,!0),i.setValue("GAMMAREFLECTION",r.gammaSpace,!0),i.setValue("RGBDREFLECTION",r.isRGBD,!0),r&&r.coordinatesMode!==$e.g.SKYBOX_MODE&&r.isCube&&(i.setValue("USESPHERICALFROMREFLECTIONMAP",!0),i.setValue("USEIRRADIANCEMAP",!1),this.forceIrradianceInFragment||this._scene.getEngine().getCaps().maxVaryingVectors<=8?i.setValue("USESPHERICALINVERTEX",!1):i.setValue("USESPHERICALINVERTEX",!0)))}bind(e,t,i,r){super.bind(e,t,i);const s=this._getTexture();if(!s||!r)return;s.isCube?e.setTexture(this._cubeSamplerName,s):e.setTexture(this._2DSamplerName,s);const n=s.getSize().width;e.setFloat3(this._vReflectionMicrosurfaceInfosName,n,s.lodGenerationScale,s.lodGenerationOffset),e.setFloat2(this._vReflectionFilteringInfoName,n,Math.log2(n));const o=r.materialDefines,a=s.sphericalPolynomial;if(o.USESPHERICALFROMREFLECTIONMAP&&a)if(o.SPHERICAL_HARMONICS){const t=a.preScaledHarmonics;e.setVector3("vSphericalL00",t.l00),e.setVector3("vSphericalL1_1",t.l1_1),e.setVector3("vSphericalL10",t.l10),e.setVector3("vSphericalL11",t.l11),e.setVector3("vSphericalL2_2",t.l2_2),e.setVector3("vSphericalL2_1",t.l2_1),e.setVector3("vSphericalL20",t.l20),e.setVector3("vSphericalL21",t.l21),e.setVector3("vSphericalL22",t.l22)}else e.setFloat3("vSphericalX",a.x.x,a.x.y,a.x.z),e.setFloat3("vSphericalY",a.y.x,a.y.y,a.y.z),e.setFloat3("vSphericalZ",a.z.x,a.z.y,a.z.z),e.setFloat3("vSphericalXX_ZZ",a.xx.x-a.zz.x,a.xx.y-a.zz.y,a.xx.z-a.zz.z),e.setFloat3("vSphericalYY_ZZ",a.yy.x-a.zz.x,a.yy.y-a.zz.y,a.yy.z-a.zz.z),e.setFloat3("vSphericalZZ",a.zz.x,a.zz.y,a.zz.z),e.setFloat3("vSphericalXY",a.xy.x,a.xy.y,a.xy.z),e.setFloat3("vSphericalYZ",a.yz.x,a.yz.y,a.yz.z),e.setFloat3("vSphericalZX",a.zx.x,a.zx.y,a.zx.z)}handleVertexSide(e){let t=super.handleVertexSide(e);const i=1===e.shaderLanguage;e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]});const r=e._getFreeVariableName("reflectionVector");return this._vEnvironmentIrradianceName=e._getFreeVariableName("vEnvironmentIrradiance"),e._emitVaryingFromString(this._vEnvironmentIrradianceName,_d.Vector3,"defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)"),e._emitUniformFromString("vSphericalL00",_d.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL1_1",_d.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL10",_d.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL11",_d.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_2",_d.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_1",_d.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL20",_d.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL21",_d.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL22",_d.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalX",_d.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalY",_d.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZ",_d.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXX_ZZ",_d.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYY_ZZ",_d.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZZ",_d.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXY",_d.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYZ",_d.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZX",_d.Vector3,"SPHERICAL_HARMONICS",!0),t+=`#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n                ${e._declareLocalVar(r,_d.Vector3)} = (${(i?"uniforms.":"")+this._reflectionMatrixName} * vec4${e.fSuffix}(normalize(${this.worldNormal.associatedVariableName}).xyz, 0)).xyz;\n                #ifdef ${this._defineOppositeZ}\n                    ${r}.z *= -1.0;\n                #endif\n                ${i?"vertexOutputs.":""}${this._vEnvironmentIrradianceName} = computeEnvironmentIrradiance(${r});\n            #endif\n`,t}getCode(e,t){let i="";this.handleFragmentSideInits(e);const r=1===e.shaderLanguage;e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]}),r||(e._emitFunction("sampleReflection",`\n                #ifdef ${this._define3DName}\n                    #define sampleReflection(s, c) textureCube(s, c)\n                #else\n                    #define sampleReflection(s, c) texture2D(s, c)\n                #endif\n`,`//${this.name}`),e._emitFunction("sampleReflectionLod",`\n                #ifdef ${this._define3DName}\n                    #define sampleReflectionLod(s, c, l) textureCubeLodEXT(s, c, l)\n                #else\n                    #define sampleReflectionLod(s, c, l) texture2DLodEXT(s, c, l)\n                #endif\n`,`//${this.name}`));const s=r?`\n            fn computeReflectionCoordsPBR(worldPos: vec4f, worldNormal: vec3f) -> vec3f {\n                ${this.handleFragmentSideCodeReflectionCoords(e,"worldNormal","worldPos",!0,!0)}\n                return ${this._reflectionVectorName};\n            }\n`:`\n            vec3 computeReflectionCoordsPBR(vec4 worldPos, vec3 worldNormal) {\n                ${this.handleFragmentSideCodeReflectionCoords(e,"worldNormal","worldPos",!0,!0)}\n                return ${this._reflectionVectorName};\n            }\n`;return e._emitFunction("computeReflectionCoordsPBR",s,`//${this.name}`),this._vReflectionMicrosurfaceInfosName=e._getFreeVariableName("vReflectionMicrosurfaceInfos"),e._emitUniformFromString(this._vReflectionMicrosurfaceInfosName,_d.Vector3),this._vReflectionInfosName=e._getFreeVariableName("vReflectionInfos"),this._vReflectionFilteringInfoName=e._getFreeVariableName("vReflectionFilteringInfo"),e._emitUniformFromString(this._vReflectionFilteringInfoName,_d.Vector2),i+=`#ifdef REFLECTION\n            ${e._declareLocalVar(this._vReflectionInfosName,_d.Vector2)} = vec2${e.fSuffix}(1., 0.);\n\n            ${r?"var reflectionOut: reflectionOutParams":"reflectionOutParams reflectionOut"};\n\n            reflectionOut = reflectionBlock(\n                ${this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:(r?"input.":"")+"v_"+this.worldPosition.associatedVariableName}.xyz\n                , ${t}\n                , alphaG\n                , ${(r?"uniforms.":"")+this._vReflectionMicrosurfaceInfosName}\n                , ${this._vReflectionInfosName}\n                , ${this.reflectionColor}\n            #ifdef ANISOTROPIC\n                ,anisotropicOut\n            #endif\n            #if defined(${this._defineLODReflectionAlpha}) && !defined(${this._defineSkyboxName})\n                ,NdotVUnclamped\n            #endif\n            #ifdef ${this._defineLinearSpecularReflection}\n                , roughness\n            #endif\n            #ifdef ${this._define3DName}\n                , ${this._cubeSamplerName}\n                ${r?`, ${this._cubeSamplerName}Sampler`:""}\n            #else\n                , ${this._2DSamplerName}\n                ${r?`, ${this._2DSamplerName}Sampler`:""}\n            #endif\n            #if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n                , ${r?"input.":""}${this._vEnvironmentIrradianceName}\n            #endif\n            #if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))\n                    , ${this._reflectionMatrixName}\n            #endif\n            #ifdef USEIRRADIANCEMAP\n                , irradianceSampler         // ** not handled **\n                ${r?", irradianceSamplerSampler":""}\n            #endif\n            #ifndef LODBASEDMICROSFURACE\n                #ifdef ${this._define3DName}\n                    , ${this._cubeSamplerName}\n                    ${r?`, ${this._cubeSamplerName}Sampler`:""}\n                    , ${this._cubeSamplerName}\n                    ${r?`, ${this._cubeSamplerName}Sampler`:""}\n                #else\n                    , ${this._2DSamplerName}\n                    ${r?`, ${this._2DSamplerName}Sampler`:""}\n                    , ${this._2DSamplerName}                    \n                    ${r?`, ${this._2DSamplerName}Sampler`:""}\n                #endif\n            #endif\n            #ifdef REALTIME_FILTERING\n                , ${this._vReflectionFilteringInfoName}\n                #ifdef IBL_CDF_FILTERING\n                    , icdfSampler         // ** not handled **\n                    ${r?", icdfSamplerSampler":""}\n                #endif\n            #endif\n            );\n        #endif\n`,i}_buildBlock(e){return this._scene=e.sharedData.scene,e.target!==gd.Fragment&&(this._defineLODReflectionAlpha=e._getFreeDefineName("LODINREFLECTIONALPHA"),this._defineLinearSpecularReflection=e._getFreeDefineName("LINEARSPECULARREFLECTION")),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e+=`${this._codeVariableName}.texture.gammaSpace = ${this.texture.gammaSpace};\n`),e+=`${this._codeVariableName}.useSphericalHarmonics = ${this.useSphericalHarmonics};\n`,e+=`${this._codeVariableName}.forceIrradianceInFragment = ${this.forceIrradianceInFragment};\n`,e}serialize(){const e=super.serialize();return e.useSphericalHarmonics=this.useSphericalHarmonics,e.forceIrradianceInFragment=this.forceIrradianceInFragment,e.gammaSpace=this.texture?.gammaSpace??!0,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useSphericalHarmonics=e.useSphericalHarmonics,this.forceIrradianceInFragment=e.forceIrradianceInFragment,this.texture&&(this.texture.gammaSpace=e.gammaSpace)}}(0,Ge.Cg)([xh("Spherical Harmonics",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],Bx.prototype,"useSphericalHarmonics",void 0),(0,Ge.Cg)([xh("Force irradiance in fragment",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],Bx.prototype,"forceIrradianceInFragment",void 0),(0,a.Y5)("BABYLON.ReflectionBlock",Bx);class Vx extends Ed{constructor(e){super(e,gd.Fragment),this._tangentCorrectionFactorName="",this.remapF0OnInterfaceChange=!0,this._isUnique=!0,this.registerInput("intensity",_d.Float,!1,gd.Fragment),this.registerInput("roughness",_d.Float,!0,gd.Fragment),this.registerInput("indexOfRefraction",_d.Float,!0,gd.Fragment),this.registerInput("normalMapColor",_d.Color3,!0,gd.Fragment),this.registerInput("uv",_d.Vector2,!0,gd.Fragment),this.registerInput("tintColor",_d.Color3,!0,gd.Fragment),this.registerInput("tintAtDistance",_d.Float,!0,gd.Fragment),this.registerInput("tintThickness",_d.Float,!0,gd.Fragment),this.registerInput("worldTangent",_d.Vector4,!0),this.registerInput("worldNormal",_d.AutoDetect,!0),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(_d.Color4|_d.Vector4|_d.Vector3),this.registerInput("TBN",_d.Object,!0,gd.VertexAndFragment,new c_("TBN",this,0,N_,"TBNBlock")),this.registerOutput("clearcoat",_d.Object,gd.Fragment,new c_("clearcoat",this,1,Vx,"ClearCoatBlock"))}initialize(e){e._excludeVariableName("clearcoatOut"),e._excludeVariableName("vClearCoatParams"),e._excludeVariableName("vClearCoatTintParams"),e._excludeVariableName("vClearCoatRefractionParams"),e._excludeVariableName("vClearCoatTangentSpaceParams"),e._excludeVariableName("vGeometricNormaClearCoatW")}getClassName(){return"ClearCoatBlock"}get intensity(){return this._inputs[0]}get roughness(){return this._inputs[1]}get indexOfRefraction(){return this._inputs[2]}get normalMapColor(){return this._inputs[3]}get uv(){return this._inputs[4]}get tintColor(){return this._inputs[5]}get tintAtDistance(){return this._inputs[6]}get tintThickness(){return this._inputs[7]}get worldTangent(){return this._inputs[8]}get worldNormal(){return this._inputs[9]}get TBN(){return this._inputs[10]}get clearcoat(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new Fd("ClearCoat intensity",gd.Fragment,_d.Float);e.value=1,e.output.connectTo(this.intensity)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("CLEARCOAT",!0),i.setValue("CLEARCOAT_TEXTURE",!1,!0),i.setValue("CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("CLEARCOAT_TINT",this.tintColor.isConnected||this.tintThickness.isConnected||this.tintAtDistance.isConnected,!0),i.setValue("CLEARCOAT_BUMP",this.normalMapColor.isConnected,!0),i.setValue("CLEARCOAT_DEFAULTIOR",!this.indexOfRefraction.isConnected||this.indexOfRefraction.connectInputBlock.value===af.t._DefaultIndexOfRefraction,!0),i.setValue("CLEARCOAT_REMAP_F0",this.remapF0OnInterfaceChange,!0)}bind(e,t,i){super.bind(e,t,i);const r=this.indexOfRefraction.connectInputBlock?.value??af.t._DefaultIndexOfRefraction,s=1-r,n=1+r,o=Math.pow(-s/n,2),a=1/r;e.setFloat4("vClearCoatRefractionParams",o,a,s,n);const l=this.clearcoat.hasEndpoints?this.clearcoat.endpoints[0].ownerBlock:null,h=l?.perturbedNormal.isConnected?l.perturbedNormal.connectedPoint.ownerBlock:null;this._scene._mirroredCameraPosition?e.setFloat2("vClearCoatTangentSpaceParams",h?.invertX?1:-1,h?.invertY?1:-1):e.setFloat2("vClearCoatTangentSpaceParams",h?.invertX?-1:1,h?.invertY?-1:1),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_generateTBNSpace(e,t,i){let r="";const s=`//${this.name}`,n=this.worldTangent,o=1===e.shaderLanguage;o||e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const a={search:/defined\(TANGENT\)/g,replace:n.isConnected?"defined(TANGENT)":"defined(IGNORE)"},l=this.TBN;return l.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n                ${o?"var TBN":"mat3 TBN"} = ${l.associatedVariableName};\n            #endif\n            `:n.isConnected&&(r+=`${e._declareLocalVar("tbnNormal",_d.Vector3)} = normalize(${i}.xyz);\n`,r+=`${e._declareLocalVar("tbnTangent",_d.Vector3)} = normalize(${n.associatedVariableName}.xyz);\n`,r+=`${e._declareLocalVar("tbnBitangent",_d.Vector3)} = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\n`,r+=`${o?"var vTBN":"mat3 vTBN"} = ${o?"mat3x3f":"mat3"}(tbnTangent, tbnBitangent, tbnNormal);\n`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",s,{replaceStrings:[a]}),r}static GetCode(e,t,i,r,s,n,o){let a="";const l=t?.intensity.isConnected?t.intensity.associatedVariableName:"1.",h=t?.roughness.isConnected?t.roughness.associatedVariableName:"0.",c=t?.normalMapColor.isConnected?t.normalMapColor.associatedVariableName:`vec3${e.fSuffix}(0.)`,u=t?.uv.isConnected?t.uv.associatedVariableName:`vec2${e.fSuffix}(0.)`,d=t?.tintColor.isConnected?t.tintColor.associatedVariableName:`vec3${e.fSuffix}(1.)`,p=t?.tintThickness.isConnected?t.tintThickness.associatedVariableName:"1.",m=t?.tintAtDistance.isConnected?t.tintAtDistance.associatedVariableName:"1.",f=`vec4${e.fSuffix}(0.)`;if(t){e._emitUniformFromString("vClearCoatRefractionParams",_d.Vector4),e._emitUniformFromString("vClearCoatTangentSpaceParams",_d.Vector2);const i=t.worldNormal;a+=`${e._declareLocalVar("vGeometricNormaClearCoatW",_d.Vector3)} = ${i.isConnected?"normalize("+i.associatedVariableName+".xyz)":"geometricNormalW"};\n`}else a+=`${e._declareLocalVar("vGeometricNormaClearCoatW",_d.Vector3)} = geometricNormalW;\n`;s&&t&&(a+=t._generateTBNSpace(e,r,o),n=t.worldTangent.isConnected);const _=1===e.shaderLanguage;return a+=`${_?"var clearcoatOut: clearcoatOutParams":"clearcoatOutParams clearcoatOut"};\n\n        #ifdef CLEARCOAT\n            ${e._declareLocalVar("vClearCoatParams",_d.Vector2)} = vec2${e.fSuffix}(${l}, ${h});\n            ${e._declareLocalVar("vClearCoatTintParams",_d.Vector4)} = vec4${e.fSuffix}(${d}, ${p});\n\n            clearcoatOut = clearcoatBlock(\n                ${r}.xyz\n                , vGeometricNormaClearCoatW\n                , viewDirectionW\n                , vClearCoatParams\n                , specularEnvironmentR0\n            #ifdef CLEARCOAT_TEXTURE\n                , vec2${e.fSuffix}(0.)\n            #endif\n            #ifdef CLEARCOAT_TINT\n                , vClearCoatTintParams\n                , ${m}\n                , ${_?"uniforms.":""}vClearCoatRefractionParams\n                #ifdef CLEARCOAT_TINT_TEXTURE\n                    , ${f}\n                #endif\n            #endif\n            #ifdef CLEARCOAT_BUMP\n                , vec2${e.fSuffix}(0., 1.)\n                , vec4${e.fSuffix}(${c}, 0.)\n                , ${u}\n                #if defined(${n?"TANGENT":"IGNORE"}) && defined(NORMAL)\n                    , vTBN\n                #else\n                    , ${_?"uniforms.":""}vClearCoatTangentSpaceParams\n                #endif\n                #ifdef OBJECTSPACE_NORMALMAP\n                    , normalMatrix\n                #endif\n            #endif\n            #if defined(FORCENORMALFORWARD) && defined(NORMAL)\n                , faceNormal\n            #endif\n            #ifdef REFLECTION\n                , ${_?"uniforms.":""}${i?._vReflectionMicrosurfaceInfosName}\n                , ${i?._vReflectionInfosName}\n                , ${i?.reflectionColor}\n                , ${_?"uniforms.":""}vLightingIntensity\n                #ifdef ${i?._define3DName}\n                    , ${i?._cubeSamplerName}       \n                    ${_?`, ${i?._cubeSamplerName}Sampler`:""}\n                #else\n                    , ${i?._2DSamplerName}       \n                    ${_?`, ${i?._2DSamplerName}Sampler`:""}\n                #endif\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${i?._define3DName}\n                        , ${i?._cubeSamplerName}       \n                        ${_?`, ${i?._cubeSamplerName}Sampler`:""}\n                        , ${i?._cubeSamplerName}\n                        ${_?`, ${i?._cubeSamplerName}Sampler`:""}\n                    #else\n                        , ${i?._2DSamplerName}\n                        ${_?`, ${i?._2DSamplerName}Sampler`:""}\n                        , ${i?._2DSamplerName}\n                        ${_?`, ${i?._2DSamplerName}Sampler`:""}                        \n                    #endif\n                #endif\n            #endif\n            #if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n                , (${e._generateTernary("1.","-1.",_?"fragmentInputs.frontFacing":"gl_FrontFacing")})\n            #endif\n            );\n        #else\n            clearcoatOut.specularEnvironmentR0 = specularEnvironmentR0;\n        #endif\n`,a}_buildBlock(e){return this._scene=e.sharedData.scene,e.target===gd.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,_d.Float)),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.remapF0OnInterfaceChange = ${this.remapF0OnInterfaceChange};\n`,e}serialize(){const e=super.serialize();return e.remapF0OnInterfaceChange=this.remapF0OnInterfaceChange,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.remapF0OnInterfaceChange=e.remapF0OnInterfaceChange??!0}}(0,Ge.Cg)([xh("Remap F0 on interface change",0,"ADVANCED",{embedded:!0})],Vx.prototype,"remapF0OnInterfaceChange",void 0),(0,a.Y5)("BABYLON.ClearCoatBlock",Vx);class Lx extends Ed{constructor(e){super(e,gd.Fragment),this._isUnique=!0,this.registerInput("intensity",_d.Float,!0,gd.Fragment),this.registerInput("indexOfRefraction",_d.Float,!0,gd.Fragment),this.registerInput("thickness",_d.Float,!0,gd.Fragment),this.registerOutput("iridescence",_d.Object,gd.Fragment,new c_("iridescence",this,1,Lx,"IridescenceBlock"))}initialize(e){e._excludeVariableName("iridescenceOut"),e._excludeVariableName("vIridescenceParams")}getClassName(){return"IridescenceBlock"}get intensity(){return this._inputs[0]}get indexOfRefraction(){return this._inputs[1]}get thickness(){return this._inputs[2]}get iridescence(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new Fd("Iridescence intensity",gd.Fragment,_d.Float);e.value=1,e.output.connectTo(this.intensity);const t=new Fd("Iridescence ior",gd.Fragment,_d.Float);t.value=1.3,t.output.connectTo(this.indexOfRefraction);const i=new Fd("Iridescence thickness",gd.Fragment,_d.Float);i.value=400,i.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("IRIDESCENCE",!0,!0),i.setValue("IRIDESCENCE_TEXTURE",!1,!0),i.setValue("IRIDESCENCE_THICKNESS_TEXTURE",!1,!0)}static GetCode(e,t){let i="";const r=e?.intensity.isConnected?e.intensity.associatedVariableName:"1.",s=e?.indexOfRefraction.isConnected?e.indexOfRefraction.associatedVariableName:lf.z._DefaultIndexOfRefraction,n=e?.thickness.isConnected?e.thickness.associatedVariableName:lf.z._DefaultMaximumThickness;return i+=`${1===t.shaderLanguage?"var iridescenceOut: iridescenceOutParams":"iridescenceOutParams iridescenceOut"};\n\n        #ifdef IRIDESCENCE\n            iridescenceOut = iridescenceBlock(\n                vec4(${r}, ${s}, 1., ${n})\n                , NdotV\n                , specularEnvironmentR0\n                #ifdef CLEARCOAT\n                    , NdotVUnclamped\n                #endif                \n            );\n\n            float iridescenceIntensity = iridescenceOut.iridescenceIntensity;\n            specularEnvironmentR0 = iridescenceOut.specularEnvironmentR0;\n        #endif\n`,i}_buildBlock(e){return e.target===gd.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this)),this}serialize(){return super.serialize()}_deserialize(e,t,i){super._deserialize(e,t,i)}}(0,a.Y5)("BABYLON.IridescenceBlock",Lx);class kx extends Ed{constructor(e){super(e,gd.Fragment),this.linkRefractionWithTransparency=!1,this.invertRefractionY=!1,this.useThicknessAsDepth=!1,this._isUnique=!0,this.registerInput("intensity",_d.Float,!1,gd.Fragment),this.registerInput("tintAtDistance",_d.Float,!0,gd.Fragment),this.registerInput("volumeIndexOfRefraction",_d.Float,!0,gd.Fragment),this.registerOutput("refraction",_d.Object,gd.Fragment,new c_("refraction",this,1,kx,"RefractionBlock"))}initialize(e){e._excludeVariableName("vRefractionPosition"),e._excludeVariableName("vRefractionSize")}getClassName(){return"RefractionBlock"}get intensity(){return this._inputs[0]}get tintAtDistance(){return this._inputs[1]}get volumeIndexOfRefraction(){return this._inputs[2]}get view(){return this.viewConnectionPoint}get refraction(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}autoConfigure(e,t=()=>!0){if(!this.intensity.isConnected){const e=new Fd("Refraction intensity",gd.Fragment,_d.Float);e.value=1,e.output.connectTo(this.intensity)}if(this.view&&!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===bd.View&&t(e)));i||(i=new Fd("view"),i.setAsSystemValue(bd.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const r=this._getTexture(),s=r&&r.getTextureMatrix;i.setValue("SS_REFRACTION",s,!0),s&&(i.setValue(this._define3DName,r.isCube,!0),i.setValue(this._defineLODRefractionAlpha,r.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularRefraction,r.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem&&r.isCube?!r.invertZ:r.invertZ,!0),i.setValue("SS_LINKREFRACTIONTOTRANSPARENCY",this.linkRefractionWithTransparency,!0),i.setValue("SS_GAMMAREFRACTION",r.gammaSpace,!0),i.setValue("SS_RGBDREFRACTION",r.isRGBD,!0),i.setValue("SS_USE_LOCAL_REFRACTIONMAP_CUBIC",!!r.boundingBoxSize,!0),i.setValue("SS_USE_THICKNESS_AS_DEPTH",this.useThicknessAsDepth,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i){super.bind(e,t,i);const r=this._getTexture();if(!r)return;r.isCube?e.setTexture(this._cubeSamplerName,r):e.setTexture(this._2DSamplerName,r),e.setMatrix(this._refractionMatrixName,r.getRefractionTextureMatrix());let s=1;r.isCube||r.depth&&(s=r.depth);const n=this.volumeIndexOfRefraction.connectInputBlock?.value??this.indexOfRefractionConnectionPoint.connectInputBlock?.value??1.5;e.setFloat4(this._vRefractionInfosName,r.level,1/n,s,this.invertRefractionY?-1:1),e.setFloat4(this._vRefractionMicrosurfaceInfosName,r.getSize().width,r.lodGenerationScale,r.lodGenerationOffset,1/n);const o=r.getSize().width;if(e.setFloat2(this._vRefractionFilteringInfoName,o,Math.log2(o)),r.boundingBoxSize){const t=r;e.setVector3("vRefractionPosition",t.boundingBoxPosition),e.setVector3("vRefractionSize",t.boundingBoxSize)}}getCode(e){e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),this._define3DName=e._getFreeDefineName("SS_REFRACTIONMAP_3D");return this._getTexture()&&(e._samplerDeclaration+=`#ifdef ${this._define3DName}\n`,e._emitCubeSampler(this._cubeSamplerName,void 0,!0),e._samplerDeclaration+="#else\n",e._emit2DSampler(this._2DSamplerName,void 0,!0),e._samplerDeclaration+="#endif\n"),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._defineLODRefractionAlpha=e._getFreeDefineName("SS_LODINREFRACTIONALPHA"),this._defineLinearSpecularRefraction=e._getFreeDefineName("SS_LINEARSPECULARREFRACTION"),this._defineOppositeZ=e._getFreeDefineName("SS_REFRACTIONMAP_OPPOSITEZ"),this._refractionMatrixName=e._getFreeVariableName("refractionMatrix"),e._emitUniformFromString(this._refractionMatrixName,_d.Matrix),1!==e.shaderLanguage&&(e._emitFunction("sampleRefraction",`\n                #ifdef ${this._define3DName}\n                    #define sampleRefraction(s, c) textureCube(s, c)\n                #else\n                    #define sampleRefraction(s, c) texture2D(s, c)\n                #endif\n`,`//${this.name}`),e._emitFunction("sampleRefractionLod",`\n                #ifdef ${this._define3DName}\n                    #define sampleRefractionLod(s, c, l) textureCubeLodEXT(s, c, l)\n                #else\n                    #define sampleRefractionLod(s, c, l) texture2DLodEXT(s, c, l)\n                #endif\n`,`//${this.name}`)),this._vRefractionMicrosurfaceInfosName=e._getFreeVariableName("vRefractionMicrosurfaceInfos"),e._emitUniformFromString(this._vRefractionMicrosurfaceInfosName,_d.Vector4),this._vRefractionInfosName=e._getFreeVariableName("vRefractionInfos"),e._emitUniformFromString(this._vRefractionInfosName,_d.Vector4),this._vRefractionFilteringInfoName=e._getFreeVariableName("vRefractionFilteringInfo"),e._emitUniformFromString(this._vRefractionFilteringInfoName,_d.Vector2),e._emitUniformFromString("vRefractionPosition",_d.Vector3),e._emitUniformFromString("vRefractionSize",_d.Vector3),""}_buildBlock(e){return this._scene=e.sharedData.scene,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e=this.texture.isCube?`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}");\n`:`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}");\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`),e+=`${this._codeVariableName}.linkRefractionWithTransparency = ${this.linkRefractionWithTransparency};\n`,e+=`${this._codeVariableName}.invertRefractionY = ${this.invertRefractionY};\n`,e+=`${this._codeVariableName}.useThicknessAsDepth = ${this.useThicknessAsDepth};\n`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.linkRefractionWithTransparency=this.linkRefractionWithTransparency,e.invertRefractionY=this.invertRefractionY,e.useThicknessAsDepth=this.useThicknessAsDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,e.texture.isCube?this.texture=Wu.CubeTexture.Parse(e.texture,t,i):this.texture=$e.g.Parse(e.texture,t,i)),this.linkRefractionWithTransparency=e.linkRefractionWithTransparency,this.invertRefractionY=e.invertRefractionY,this.useThicknessAsDepth=!!e.useThicknessAsDepth}}(0,Ge.Cg)([xh("Link refraction to transparency",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],kx.prototype,"linkRefractionWithTransparency",void 0),(0,Ge.Cg)([xh("Invert refraction Y",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],kx.prototype,"invertRefractionY",void 0),(0,Ge.Cg)([xh("Use thickness as depth",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],kx.prototype,"useThicknessAsDepth",void 0),(0,a.Y5)("BABYLON.RefractionBlock",kx);class Gx extends Ed{constructor(e){super(e,gd.Fragment),this._isUnique=!0,this.registerInput("thickness",_d.Float,!1,gd.Fragment),this.registerInput("tintColor",_d.Color3,!0,gd.Fragment),this.registerInput("translucencyIntensity",_d.Float,!0,gd.Fragment),this.registerInput("translucencyDiffusionDist",_d.Color3,!0,gd.Fragment),this.registerInput("refraction",_d.Object,!0,gd.Fragment,new c_("refraction",this,0,kx,"RefractionBlock")),this.registerInput("dispersion",_d.Float,!0,gd.Fragment),this.registerOutput("subsurface",_d.Object,gd.Fragment,new c_("subsurface",this,1,Gx,"SubSurfaceBlock"))}initialize(e){e._excludeVariableName("subSurfaceOut"),e._excludeVariableName("vThicknessParam"),e._excludeVariableName("vTintColor"),e._excludeVariableName("vTranslucencyColor"),e._excludeVariableName("vSubSurfaceIntensity"),e._excludeVariableName("dispersion")}getClassName(){return"SubSurfaceBlock"}get thickness(){return this._inputs[0]}get tintColor(){return this._inputs[1]}get translucencyIntensity(){return this._inputs[2]}get translucencyDiffusionDist(){return this._inputs[3]}get refraction(){return this._inputs[4]}get dispersion(){return this._inputs[5]}get subsurface(){return this._outputs[0]}autoConfigure(){if(!this.thickness.isConnected){const e=new Fd("SubSurface thickness",gd.Fragment,_d.Float);e.value=0,e.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const r=this.translucencyDiffusionDist.isConnected||this.translucencyIntensity.isConnected;i.setValue("SUBSURFACE",r||this.refraction.isConnected,!0),i.setValue("SS_TRANSLUCENCY",r,!0),i.setValue("SS_THICKNESSANDMASK_TEXTURE",!1,!0),i.setValue("SS_REFRACTIONINTENSITY_TEXTURE",!1,!0),i.setValue("SS_TRANSLUCENCYINTENSITY_TEXTURE",!1,!0),i.setValue("SS_USE_GLTF_TEXTURES",!1,!0),i.setValue("SS_DISPERSION",this.dispersion.isConnected,!0)}static GetCode(e,t,i,r){let s="";const n=t?.thickness.isConnected?t.thickness.associatedVariableName:"0.",o=t?.tintColor.isConnected?t.tintColor.associatedVariableName:"vec3(1.)",a=t?.translucencyIntensity.isConnected?t?.translucencyIntensity.associatedVariableName:"1.",l=t?.translucencyDiffusionDist.isConnected?t?.translucencyDiffusionDist.associatedVariableName:"vec3(1.)",h=t?.refraction.isConnected?t?.refraction.connectedPoint?.ownerBlock:null,c=h?.tintAtDistance.isConnected?h.tintAtDistance.associatedVariableName:"1.",u=h?.intensity.isConnected?h.intensity.associatedVariableName:"1.",d=h?.view.isConnected?h.view.associatedVariableName:"",p=t?.dispersion.isConnected?t?.dispersion.associatedVariableName:"0.0",m=1===e.shaderLanguage;return s+=h?.getCode(e)??"",s+=`${m?"var subSurfaceOut: subSurfaceOutParams":"subSurfaceOutParams subSurfaceOut"};\n\n        #ifdef SUBSURFACE\n            ${e._declareLocalVar("vThicknessParam",_d.Vector2)} = vec2${e.fSuffix}(0., ${n});\n            ${e._declareLocalVar("vTintColor",_d.Vector4)} = vec4${e.fSuffix}(${o}, ${c});\n            ${e._declareLocalVar("vSubSurfaceIntensity",_d.Vector3)} = vec3(${u}, ${a}, 0.);\n            ${e._declareLocalVar("dispersion",_d.Float)} = ${p};\n            subSurfaceOut = subSurfaceBlock(\n                vSubSurfaceIntensity\n                , vThicknessParam\n                , vTintColor\n                , normalW\n                , specularEnvironmentReflectance\n            #ifdef SS_THICKNESSANDMASK_TEXTURE\n                , vec4${e.fSuffix}(0.)\n            #endif\n            #ifdef REFLECTION\n                #ifdef SS_TRANSLUCENCY\n                    , ${(m?"uniforms.":"")+i?._reflectionMatrixName}\n                    #ifdef USESPHERICALFROMREFLECTIONMAP\n                        #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n                            , reflectionOut.irradianceVector\n                        #endif\n                        #if defined(REALTIME_FILTERING)\n                            , ${i?._cubeSamplerName}\n                            ${m?`, ${i?._cubeSamplerName}Sampler`:""}\n                            , ${i?._vReflectionFilteringInfoName}\n                        #endif\n                        #endif\n                    #ifdef USEIRRADIANCEMAP\n                        , irradianceSampler\n                        ${m?", irradianceSamplerSampler":""}\n                    #endif\n                #endif\n            #endif\n            #if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n                , surfaceAlbedo\n            #endif\n            #ifdef SS_REFRACTION\n                , ${r}.xyz\n                , viewDirectionW\n                , ${d}\n                , ${(m?"uniforms.":"")+(h?._vRefractionInfosName??"")}\n                , ${(m?"uniforms.":"")+(h?._refractionMatrixName??"")}\n                , ${(m?"uniforms.":"")+(h?._vRefractionMicrosurfaceInfosName??"")}\n                , ${m?"uniforms.":""}vLightingIntensity\n                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n                    , alpha\n                #endif\n                #ifdef ${h?._defineLODRefractionAlpha??"IGNORE"}\n                    , NdotVUnclamped\n                #endif\n                #ifdef ${h?._defineLinearSpecularRefraction??"IGNORE"}\n                    , roughness\n                #endif\n                , alphaG\n                #ifdef ${h?._define3DName??"IGNORE"}\n                    , ${h?._cubeSamplerName??""}\n                    ${m?`, ${h?._cubeSamplerName}Sampler`:""}\n                #else\n                    , ${h?._2DSamplerName??""}\n                    ${m?`, ${h?._2DSamplerName}Sampler`:""}\n                #endif\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${h?._define3DName??"IGNORE"}\n                        , ${h?._cubeSamplerName??""}                        \n                        ${m?`, ${h?._cubeSamplerName}Sampler`:""}\n                        , ${h?._cubeSamplerName??""}                        \n                        ${m?`, ${h?._cubeSamplerName}Sampler`:""}\n                    #else\n                        , ${h?._2DSamplerName??""}\n                        ${m?`, ${h?._2DSamplerName}Sampler`:""}\n                        , ${h?._2DSamplerName??""}\n                        ${m?`, ${h?._2DSamplerName}Sampler`:""}\n                    #endif\n                #endif\n                #ifdef ANISOTROPIC\n                    , anisotropicOut\n                #endif\n                #ifdef REALTIME_FILTERING\n                    , ${h?._vRefractionFilteringInfoName??""}\n                #endif\n                #ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n                    , vRefractionPosition\n                    , vRefractionSize\n                #endif\n                #ifdef SS_DISPERSION\n                    , dispersion\n                #endif\n            #endif\n            #ifdef SS_TRANSLUCENCY\n                , ${l}\n                , vTintColor\n                #ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\n                    , vec4${e.fSuffix}(0.)\n                #endif\n            #endif                \n            );\n\n            #ifdef SS_REFRACTION\n                surfaceAlbedo = subSurfaceOut.surfaceAlbedo;\n                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n                    alpha = subSurfaceOut.alpha;\n                #endif\n            #endif\n        #else\n            subSurfaceOut.specularEnvironmentReflectance = specularEnvironmentReflectance;\n        #endif\n`,s}_buildBlock(e){return e.target===gd.Fragment&&e.sharedData.blocksWithDefines.push(this),this}}(0,a.Y5)("BABYLON.SubSurfaceBlock",Gx);const zx={ambientClr:["finalAmbient",""],diffuseDir:["finalDiffuse",""],specularDir:["finalSpecularScaled","!defined(UNLIT) && defined(SPECULARTERM)"],clearcoatDir:["finalClearCoatScaled","!defined(UNLIT) && defined(CLEARCOAT)"],sheenDir:["finalSheenScaled","!defined(UNLIT) && defined(SHEEN)"],diffuseInd:["finalIrradiance","!defined(UNLIT) && defined(REFLECTION)"],specularInd:["finalRadianceScaled","!defined(UNLIT) && defined(REFLECTION)"],clearcoatInd:["clearcoatOut.finalClearCoatRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(CLEARCOAT)"],sheenInd:["sheenOut.finalSheenRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(SHEEN) && defined(ENVIRONMENTBRDF)"],refraction:["subSurfaceOut.finalRefraction","!defined(UNLIT) && defined(SS_REFRACTION)"],lighting:["finalColor.rgb",""],shadow:["aggShadow",""],alpha:["alpha",""]};class Ux extends Ed{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected||i.worldNormal.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,m.V.Error("The worldPosition and worldNormal inputs must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?gd.Fragment:gd.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?gd.Fragment:gd.Vertex,this.getInputByName("worldNormal").target=this.generateOnlyFragmentCode?gd.Fragment:gd.Vertex}constructor(e){super(e,gd.VertexAndFragment),this._environmentBRDFTexture=null,this._metallicReflectanceColor=o.v9.White(),this._metallicF0Factor=1,this.directIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.lightFalloff=0,this.useAlphaTest=!1,this.alphaTestCutoff=.5,this.useAlphaBlending=!1,this.useRadianceOverAlpha=!0,this.useSpecularOverAlpha=!0,this.enableSpecularAntiAliasing=!1,this.realTimeFiltering=!1,this.realTimeFilteringQuality=8,this.useEnergyConservation=!0,this.useRadianceOcclusion=!0,this.useHorizonOcclusion=!0,this.unlit=!1,this.forceNormalForward=!1,this.generateOnlyFragmentCode=!1,this.debugMode=0,this.debugLimit=0,this.debugFactor=1,this._isUnique=!0,this.registerInput("worldPosition",_d.Vector4,!1,gd.Vertex),this.registerInput("worldNormal",_d.Vector4,!1,gd.Vertex),this.registerInput("view",_d.Matrix,!1),this.registerInput("cameraPosition",_d.Vector3,!1,gd.Fragment),this.registerInput("perturbedNormal",_d.Vector4,!0,gd.Fragment),this.registerInput("baseColor",_d.Color3,!0,gd.Fragment),this.registerInput("metallic",_d.Float,!1,gd.Fragment),this.registerInput("roughness",_d.Float,!1,gd.Fragment),this.registerInput("ambientOcc",_d.Float,!0,gd.Fragment),this.registerInput("opacity",_d.Float,!0,gd.Fragment),this.registerInput("indexOfRefraction",_d.Float,!0,gd.Fragment),this.registerInput("ambientColor",_d.Color3,!0,gd.Fragment),this.registerInput("reflection",_d.Object,!0,gd.Fragment,new c_("reflection",this,0,Bx,"ReflectionBlock")),this.registerInput("clearcoat",_d.Object,!0,gd.Fragment,new c_("clearcoat",this,0,Vx,"ClearCoatBlock")),this.registerInput("sheen",_d.Object,!0,gd.Fragment,new c_("sheen",this,0,Nx,"SheenBlock")),this.registerInput("subsurface",_d.Object,!0,gd.Fragment,new c_("subsurface",this,0,Gx,"SubSurfaceBlock")),this.registerInput("anisotropy",_d.Object,!0,gd.Fragment,new c_("anisotropy",this,0,Fx,"AnisotropyBlock")),this.registerInput("iridescence",_d.Object,!0,gd.Fragment,new c_("iridescence",this,0,Lx,"IridescenceBlock")),this.registerOutput("ambientClr",_d.Color3,gd.Fragment),this.registerOutput("diffuseDir",_d.Color3,gd.Fragment),this.registerOutput("specularDir",_d.Color3,gd.Fragment),this.registerOutput("clearcoatDir",_d.Color3,gd.Fragment),this.registerOutput("sheenDir",_d.Color3,gd.Fragment),this.registerOutput("diffuseInd",_d.Color3,gd.Fragment),this.registerOutput("specularInd",_d.Color3,gd.Fragment),this.registerOutput("clearcoatInd",_d.Color3,gd.Fragment),this.registerOutput("sheenInd",_d.Color3,gd.Fragment),this.registerOutput("refraction",_d.Color3,gd.Fragment),this.registerOutput("lighting",_d.Color3,gd.Fragment),this.registerOutput("shadow",_d.Float,gd.Fragment),this.registerOutput("alpha",_d.Float,gd.Fragment)}initialize(e){e._excludeVariableName("vLightingIntensity"),e._excludeVariableName("geometricNormalW"),e._excludeVariableName("normalW"),e._excludeVariableName("faceNormal"),e._excludeVariableName("albedoOpacityOut"),e._excludeVariableName("surfaceAlbedo"),e._excludeVariableName("alpha"),e._excludeVariableName("aoOut"),e._excludeVariableName("baseColor"),e._excludeVariableName("reflectivityOut"),e._excludeVariableName("microSurface"),e._excludeVariableName("roughness"),e._excludeVariableName("NdotVUnclamped"),e._excludeVariableName("NdotV"),e._excludeVariableName("alphaG"),e._excludeVariableName("AARoughnessFactors"),e._excludeVariableName("environmentBrdf"),e._excludeVariableName("ambientMonochrome"),e._excludeVariableName("seo"),e._excludeVariableName("eho"),e._excludeVariableName("environmentRadiance"),e._excludeVariableName("irradianceVector"),e._excludeVariableName("environmentIrradiance"),e._excludeVariableName("diffuseBase"),e._excludeVariableName("specularBase"),e._excludeVariableName("preInfo"),e._excludeVariableName("info"),e._excludeVariableName("shadow"),e._excludeVariableName("finalDiffuse"),e._excludeVariableName("finalAmbient"),e._excludeVariableName("ambientOcclusionForDirectDiffuse"),e._excludeVariableName("finalColor"),e._excludeVariableName("vClipSpacePosition"),e._excludeVariableName("vDebugMode"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,39174)),Promise.resolve().then(i.bind(i,22625))]):await Promise.all([Promise.resolve().then(i.bind(i,81448)),Promise.resolve().then(i.bind(i,84037))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}getClassName(){return"PBRMetallicRoughnessBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get view(){return this._inputs[2]}get cameraPosition(){return this._inputs[3]}get perturbedNormal(){return this._inputs[4]}get baseColor(){return this._inputs[5]}get metallic(){return this._inputs[6]}get roughness(){return this._inputs[7]}get ambientOcc(){return this._inputs[8]}get opacity(){return this._inputs[9]}get indexOfRefraction(){return this._inputs[10]}get ambientColor(){return this._inputs[11]}get reflection(){return this._inputs[12]}get clearcoat(){return this._inputs[13]}get sheen(){return this._inputs[14]}get subsurface(){return this._inputs[15]}get anisotropy(){return this._inputs[16]}get iridescence(){return this._inputs[17]}get ambientClr(){return this._outputs[0]}get diffuseDir(){return this._outputs[1]}get specularDir(){return this._outputs[2]}get clearcoatDir(){return this._outputs[3]}get sheenDir(){return this._outputs[4]}get diffuseInd(){return this._outputs[5]}get specularInd(){return this._outputs[6]}get clearcoatInd(){return this._outputs[7]}get sheenInd(){return this._outputs[8]}get refraction(){return this._outputs[9]}get lighting(){return this._outputs[10]}get shadow(){return this._outputs[11]}get alpha(){return this._outputs[12]}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===bd.CameraPosition&&t(e)));i||(i=new Fd("cameraPosition"),i.setAsSystemValue(bd.CameraPosition)),i.output.connectTo(this.cameraPosition)}if(!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===bd.View&&t(e)));i||(i=new Fd("view"),i.setAsSystemValue(bd.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){i.setValue("PBR",!0),i.setValue("METALLICWORKFLOW",!0),i.setValue("DEBUGMODE",this.debugMode,!0),i.setValue("DEBUGMODE_FORCERETURN",!0),i.setValue("NORMALXYSCALE",!0),i.setValue("BUMP",this.perturbedNormal.isConnected,!0),i.setValue("LODBASEDMICROSFURACE",this._scene.getEngine().getCaps().textureLOD),i.setValue("ALBEDO",!1,!0),i.setValue("OPACITY",this.opacity.isConnected,!0),i.setValue("AMBIENT",!0,!0),i.setValue("AMBIENTINGRAYSCALE",!1,!0),i.setValue("REFLECTIVITY",!1,!0),i.setValue("AOSTOREINMETALMAPRED",!1,!0),i.setValue("METALLNESSSTOREINMETALMAPBLUE",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPALPHA",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPGREEN",!1,!0),this.lightFalloff===sf.d.LIGHTFALLOFF_STANDARD?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!1)):this.lightFalloff===sf.d.LIGHTFALLOFF_GLTF?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!0)):(i.setValue("USEPHYSICALLIGHTFALLOFF",!0),i.setValue("USEGLTFLIGHTFALLOFF",!1));const r=this.alphaTestCutoff.toString();i.setValue("ALPHABLEND",this.useAlphaBlending,!0),i.setValue("ALPHAFROMALBEDO",!1,!0),i.setValue("ALPHATEST",this.useAlphaTest,!0),i.setValue("ALPHATESTVALUE",r.indexOf(".")<0?r+".":r,!0),i.setValue("OPACITYRGB",!1,!0),i.setValue("RADIANCEOVERALPHA",this.useRadianceOverAlpha,!0),i.setValue("SPECULAROVERALPHA",this.useSpecularOverAlpha,!0),i.setValue("SPECULARAA",this._scene.getEngine().getCaps().standardDerivatives&&this.enableSpecularAntiAliasing,!0),i.setValue("REALTIME_FILTERING",this.realTimeFiltering,!0);const s=e.getScene();if(s.getEngine()._features.needTypeSuffixInShaderConstants?i.setValue("NUM_SAMPLES",this.realTimeFilteringQuality+"u",!0):i.setValue("NUM_SAMPLES",""+this.realTimeFilteringQuality,!0),i.setValue("BRDF_V_HEIGHT_CORRELATED",!0),i.setValue("MS_BRDF_ENERGY_CONSERVATION",this.useEnergyConservation,!0),i.setValue("RADIANCEOCCLUSION",this.useRadianceOcclusion,!0),i.setValue("HORIZONOCCLUSION",this.useHorizonOcclusion,!0),i.setValue("UNLIT",this.unlit,!0),i.setValue("FORCENORMALFORWARD",this.forceNormalForward,!0),this._environmentBRDFTexture&&$u.h.ReflectionTextureEnabled?(i.setValue("ENVIRONMENTBRDF",!0),i.setValue("ENVIRONMENTBRDF_RGBD",this._environmentBRDFTexture.isRGBD,!0)):(i.setValue("ENVIRONMENTBRDF",!1),i.setValue("ENVIRONMENTBRDF_RGBD",!1)),i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i),i._areLightsDirty)if(this.light){const t={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};(0,ts.lo)(s,e,this.light,this._lightId,i,!0,t),t.needRebuild&&i.rebuild()}else(0,ts.az)(s,e,i,!0,t.maxSimultaneousLights),i._needNormals=!0,(0,ts.VO)(s,i)}updateUniformsAndSamples(e,t,i,r){for(let s=0;s<t.maxSimultaneousLights&&i["LIGHT"+s];s++){const t=e.uniforms.indexOf("vLightData"+s)>=0;(0,ts.GD)(s,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+s],r,t,i["IESLIGHTTEXTURE"+s])}}isReady(e,t,i){return!(this._environmentBRDFTexture&&!this._environmentBRDFTexture.isReady())&&!(i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}bind(e,t,i){if(!i)return;const r=i.getScene();this.light?(0,ts.Kd)(this.light,this._lightId,r,e,!0):(0,ts.RL)(r,i,e,!0,t.maxSimultaneousLights),e.setTexture(this._environmentBrdfSamplerName,this._environmentBRDFTexture),e.setFloat2("vDebugMode",this.debugLimit,this.debugFactor);const s=this._scene.ambientColor;s&&e.setColor3("ambientFromScene",s);const n=r.useRightHandedSystem===(null!=r._mirroredCameraPosition);e.setFloat(this._invertNormalName,n?-1:1),e.setFloat4("vLightingIntensity",this.directIntensity,1,this.environmentIntensity*this._scene.environmentIntensity,this.specularIntensity);const a=this.indexOfRefraction.connectInputBlock?.value??1.5,l=Math.pow((a-1)/(a+1),2);this._metallicReflectanceColor.scaleToRef(l*this._metallicF0Factor,o.IG.Color3[0]);const h=this._metallicF0Factor;e.setColor4(this._vMetallicReflectanceFactorsName,o.IG.Color3[0],h),t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_injectVertexCode(e){const t=this.worldPosition,i=this.worldNormal,r=`//${this.name}`,s=1===e.shaderLanguage;this.light?(this._lightId=(void 0!==e.counters.lightCounter?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const n="v_"+t.associatedVariableName;e._emitVaryingFromString(n,_d.Vector4)&&(e.compilationString+=(s?"vertexOutputs.":"")+`${n} = ${t.associatedVariableName};\n`);const o="v_"+i.associatedVariableName;e._emitVaryingFromString(o,_d.Vector4)&&(e.compilationString+=(s?"vertexOutputs.":"")+`${o} = ${i.associatedVariableName};\n`);const a=this.reflection.isConnected?this.reflection.connectedPoint?.ownerBlock:null;a&&(a.viewConnectionPoint=this.view),e.compilationString+=a?.handleVertexSide(e)??"",e._emitVaryingFromString("vClipSpacePosition",_d.Vector4,"defined(IGNORE) || DEBUGMODE > 0")&&(e._injectAtEnd+="#if DEBUGMODE > 0\n",e._injectAtEnd+=(s?"vertexOutputs.":"")+`vClipSpacePosition = ${s?"vertexOutputs.position":"gl_Position"};\n`,e._injectAtEnd+="#endif\n"),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`${e._declareLocalVar("worldPos",_d.Vector4)} = ${t.associatedVariableName};\n`,this.view.isConnected&&(e.compilationString+=`${e._declareLocalVar("view",_d.Matrix)} = ${this.view.associatedVariableName};\n`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights"}))}_getAlbedoOpacityCode(e){let t=1===e.shaderLanguage?"var albedoOpacityOut: albedoOpacityOutParams;\n":"albedoOpacityOutParams albedoOpacityOut;\n";const i=this.baseColor.isConnected?this.baseColor.associatedVariableName:"vec3(1.)",r=this.opacity.isConnected?this.opacity.associatedVariableName:"1.";return t+=`albedoOpacityOut = albedoOpacityBlock(\n                vec4${e.fSuffix}(${i}, 1.)\n            #ifdef ALBEDO\n                ,vec4${e.fSuffix}(1.)\n                ,vec2${e.fSuffix}(1., 1.)\n            #endif\n                ,1. /* Base Weight */\n            #ifdef OPACITY\n                ,vec4${e.fSuffix}(${r})\n                ,vec2${e.fSuffix}(1., 1.)\n            #endif\n            );\n\n            ${e._declareLocalVar("surfaceAlbedo",_d.Vector3)} = albedoOpacityOut.surfaceAlbedo;\n            ${e._declareLocalVar("alpha",_d.Float)} = albedoOpacityOut.alpha;\n`,t}_getAmbientOcclusionCode(e){let t=1===e.shaderLanguage?"var aoOut: ambientOcclusionOutParams;\n":"ambientOcclusionOutParams aoOut;\n";const i=this.ambientOcc.isConnected?this.ambientOcc.associatedVariableName:"1.";return t+=`aoOut = ambientOcclusionBlock(\n            #ifdef AMBIENT\n                vec3${e.fSuffix}(${i}),\n                vec4${e.fSuffix}(0., 1.0, 1.0, 0.)\n            #endif\n            );\n`,t}_getReflectivityCode(e){const t=1===e.shaderLanguage;let i=t?"var reflectivityOut: reflectivityOutParams;\n":"reflectivityOutParams reflectivityOut;\n";return this._vMetallicReflectanceFactorsName=e._getFreeVariableName("vMetallicReflectanceFactors"),e._emitUniformFromString(this._vMetallicReflectanceFactorsName,_d.Vector4),i+=`${e._declareLocalVar("baseColor",_d.Vector3)} = surfaceAlbedo;\n\n            reflectivityOut = reflectivityBlock(\n                vec4${e.fSuffix}(${this.metallic.associatedVariableName}, ${this.roughness.associatedVariableName}, 0., 0.)\n            #ifdef METALLICWORKFLOW\n                , surfaceAlbedo\n                , ${(t?"uniforms.":"")+this._vMetallicReflectanceFactorsName}\n            #endif\n            #ifdef REFLECTIVITY\n                , vec3${e.fSuffix}(0., 0., 1.)\n                , vec4${e.fSuffix}(1.)\n            #endif\n            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY)  && defined(AOSTOREINMETALMAPRED)\n                , aoOut.ambientOcclusionColor\n            #endif\n            #ifdef MICROSURFACEMAP\n                , microSurfaceTexel <== not handled!\n            #endif\n            );\n\n            ${e._declareLocalVar("microSurface",_d.Float)} = reflectivityOut.microSurface;\n            ${e._declareLocalVar("roughness",_d.Float)} = reflectivityOut.roughness;\n\n            #ifdef METALLICWORKFLOW\n                surfaceAlbedo = reflectivityOut.surfaceAlbedo;\n            #endif\n            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n                aoOut.ambientOcclusionColor = reflectivityOut.ambientOcclusionColor;\n            #endif\n`,i}_buildBlock(e){super._buildBlock(e),this._scene=e.sharedData.scene;const t=1===e.shaderLanguage;this._environmentBRDFTexture||(this._environmentBRDFTexture=(0,wx.X)(this._scene));const i=this.reflection.isConnected?this.reflection.connectedPoint?.ownerBlock:null;if(i&&(i.worldPositionConnectionPoint=this.worldPosition,i.cameraPositionConnectionPoint=this.cameraPosition,i.worldNormalConnectionPoint=this.worldNormal,i.viewConnectionPoint=this.view),e.target!==gd.Fragment)return this._injectVertexCode(e),this;e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this);const r=`//${this.name}`,s=this.perturbedNormal;let n=this.worldPosition.associatedVariableName,o=this.worldNormal.associatedVariableName;this.generateOnlyFragmentCode?(n=e._getFreeVariableName("globalWorldPos"),e._emitFunction("pbr_globalworldpos",t?`var<private> ${n}:vec3${e.fSuffix};\n`:`vec3${e.fSuffix} ${n};\n`,r),e.compilationString+=`${n} = ${this.worldPosition.associatedVariableName}.xyz;\n`,o=e._getFreeVariableName("globalWorldNormal"),e._emitFunction("pbr_globalworldnorm",t?`var<private> ${o}:vec4${e.fSuffix};\n`:`vec4${e.fSuffix} ${o};\n`,r),e.compilationString+=`${o} = ${this.worldNormal.associatedVariableName};\n`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${this.worldPosition.associatedVariableName}`:void 0}),e.compilationString+="#if DEBUGMODE > 0\n",e.compilationString+=`${e._declareLocalVar("vClipSpacePosition",_d.Vector4)} = vec4${e.fSuffix}((vec2${e.fSuffix}(${t?"fragmentInputs.position":"gl_FragCoord.xy"}) / vec2${e.fSuffix}(1.0)) * 2.0 - 1.0, 0.0, 1.0);\n`,e.compilationString+="#endif\n"):(n=(t?"input.":"")+"v_"+n,o=(t?"input.":"")+"v_"+o),this._environmentBrdfSamplerName=e._getFreeVariableName("environmentBrdfSampler"),e._emit2DSampler(this._environmentBrdfSamplerName),e.sharedData.hints.needAlphaBlending=e.sharedData.hints.needAlphaBlending||this.useAlphaBlending,e.sharedData.hints.needAlphaTesting=e.sharedData.hints.needAlphaTesting||this.useAlphaTest,e._emitExtension("lod","#extension GL_EXT_shader_texture_lod : enable","defined(LODBASEDMICROSFURACE)"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitUniformFromString("vDebugMode",_d.Vector2,"defined(IGNORE) || DEBUGMODE > 0"),e._emitUniformFromString("ambientFromScene",_d.Vector3),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity"),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",r,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),e._emitFunctionFromInclude("helperFunctions",r),e._emitFunctionFromInclude("importanceSampling",r),e._emitFunctionFromInclude("pbrHelperFunctions",r),e._emitFunctionFromInclude("imageProcessingDeclaration",r),e._emitFunctionFromInclude("imageProcessingFunctions",r),e._emitFunctionFromInclude("shadowsFragmentFunctions",r),e._emitFunctionFromInclude("pbrDirectLightingSetupFunctions",r),e._emitFunctionFromInclude("pbrDirectLightingFalloffFunctions",r),e._emitFunctionFromInclude("pbrBRDFFunctions",r,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"}]}),e._emitFunctionFromInclude("hdrFilteringFunctions",r),e._emitFunctionFromInclude("pbrDirectLightingFunctions",r),e._emitFunctionFromInclude("pbrIBLFunctions",r),e._emitFunctionFromInclude("pbrBlockAlbedoOpacity",r),e._emitFunctionFromInclude("pbrBlockReflectivity",r),e._emitFunctionFromInclude("pbrBlockAmbientOcclusion",r),e._emitFunctionFromInclude("pbrBlockAlphaFresnel",r),e._emitFunctionFromInclude("pbrBlockAnisotropic",r),e._emitUniformFromString("vLightingIntensity",_d.Vector4),i?.generateOnlyFragmentCode&&(e.compilationString+=i.handleVertexSide(e)),this._vNormalWName=e._getFreeVariableName("vNormalW"),e.compilationString+=`${e._declareLocalVar(this._vNormalWName,_d.Vector4)} = normalize(${o});\n`,e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`${e._declareLocalVar("viewDirectionW",_d.Vector3)} = normalize(${this.cameraPosition.associatedVariableName} - ${n}.xyz);\n`),e.compilationString+=`${e._declareLocalVar("geometricNormalW",_d.Vector3)} = ${this._vNormalWName}.xyz;\n`,e.compilationString+=`${e._declareLocalVar("normalW",_d.Vector3)} = ${s.isConnected?"normalize("+s.associatedVariableName+".xyz)":"geometricNormalW"};\n`,this._invertNormalName=e._getFreeVariableName("invertNormal"),e._emitUniformFromString(this._invertNormalName,_d.Float),e.compilationString+=e._emitCodeFromInclude("pbrBlockNormalFinal",r,{replaceStrings:[{search:/vPositionW/g,replace:n+".xyz"},{search:/vEyePosition.w/g,replace:this._invertNormalName}]}),e.compilationString+=this._getAlbedoOpacityCode(e),e.compilationString+=e._emitCodeFromInclude("depthPrePass",r),e.compilationString+=this._getAmbientOcclusionCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockLightmapInit",r),e.compilationString+=`#ifdef UNLIT\n                ${e._declareLocalVar("diffuseBase",_d.Vector3)} = vec3${e.fSuffix}(1., 1., 1.);\n            #else\n`,e.compilationString+=this._getReflectivityCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockGeometryInfo",r,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"}]});const a=this.anisotropy.isConnected?this.anisotropy.connectedPoint?.ownerBlock:null;a&&(a.worldPositionConnectionPoint=this.worldPosition,a.worldNormalConnectionPoint=this.worldNormal,e.compilationString+=a.getCode(e,!this.perturbedNormal.isConnected)),i&&i.hasTexture&&(e.compilationString+=i.getCode(e,a?"anisotropicOut.anisotropicNormal":"normalW")),e._emitFunctionFromInclude("pbrBlockReflection",r,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:i?._defineOppositeZ??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:i?._defineProjectionName??"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:i?._defineLODReflectionAlpha??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:i?._defineLinearSpecularReflection??"LINEARSPECULARREFLECTION"},{search:/vReflectionFilteringInfo/g,replace:i?._vReflectionFilteringInfoName??"vReflectionFilteringInfo"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance0",r,{replaceStrings:[{search:/metallicReflectanceFactors/g,replace:(t?"uniforms.":"")+this._vMetallicReflectanceFactorsName}]});const l=this.sheen.isConnected?this.sheen.connectedPoint?.ownerBlock:null;l&&(e.compilationString+=l.getCode(i,e)),e._emitFunctionFromInclude("pbrBlockSheen",r,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:i?._defineLODReflectionAlpha??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:i?._defineLinearSpecularReflection??"LINEARSPECULARREFLECTION"}]});const h=this.iridescence.isConnected?this.iridescence.connectedPoint?.ownerBlock:null;e.compilationString+=Lx.GetCode(h,e),e._emitFunctionFromInclude("pbrBlockIridescence",r,{replaceStrings:[]});const c=this.clearcoat.isConnected?this.clearcoat.connectedPoint?.ownerBlock:null,u=!this.perturbedNormal.isConnected&&!this.anisotropy.isConnected,d=this.perturbedNormal.isConnected&&(this.perturbedNormal.connectedPoint?.ownerBlock).worldTangent?.isConnected,p=this.anisotropy.isConnected&&(this.anisotropy.connectedPoint?.ownerBlock).worldTangent.isConnected;let f=d||!this.perturbedNormal.isConnected&&p;e.compilationString+=Vx.GetCode(e,c,i,n,u,f,o),u&&(f=c?.worldTangent.isConnected??!1),e._emitFunctionFromInclude("pbrBlockClearcoat",r,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:i?._defineOppositeZ??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:i?._defineProjectionName??"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:i?._defineLODReflectionAlpha??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:i?._defineLinearSpecularReflection??"LINEARSPECULARREFLECTION"},{search:/defined\(TANGENT\)/g,replace:f?"defined(TANGENT)":"defined(IGNORE)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance",r,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"}]});const _=this.subsurface.isConnected?this.subsurface.connectedPoint?.ownerBlock:null,g=this.subsurface.isConnected?(this.subsurface.connectedPoint?.ownerBlock).refraction.connectedPoint?.ownerBlock:null;g&&(g.viewConnectionPoint=this.view,g.indexOfRefractionConnectionPoint=this.indexOfRefraction),e.compilationString+=Gx.GetCode(e,_,i,n),e._emitFunctionFromInclude("pbrBlockSubSurface",r,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:i?._defineOppositeZ??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:i?._defineProjectionName??"REFLECTIONMAP_PROJECTION"},{search:/SS_REFRACTIONMAP_3D/g,replace:g?._define3DName??"SS_REFRACTIONMAP_3D"},{search:/SS_LODINREFRACTIONALPHA/g,replace:g?._defineLODRefractionAlpha??"SS_LODINREFRACTIONALPHA"},{search:/SS_LINEARSPECULARREFRACTION/g,replace:g?._defineLinearSpecularRefraction??"SS_LINEARSPECULARREFRACTION"},{search:/SS_REFRACTIONMAP_OPPOSITEZ/g,replace:g?._defineOppositeZ??"SS_REFRACTIONMAP_OPPOSITEZ"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockDirectLighting",r),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:new RegExp((t?"fragmentInputs.":"")+"vPositionW","g"),replace:n+".xyz"}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{repeatKey:"maxSimultaneousLights",substitutionVars:`${t?"fragmentInputs.":""}vPositionW,${n}.xyz`}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalLitComponents",r),e.compilationString+="#endif\n";const x=this.ambientColor.isConnected?this.ambientColor.associatedVariableName:`vec3${e.fSuffix}(0., 0., 0.)`;let v=sf.d.DEFAULT_AO_ON_ANALYTICAL_LIGHTS.toString();-1===v.indexOf(".")&&(v+=".");let S=[{search:/vec3 finalEmissive[\s\S]*?finalEmissive\*=vLightingIntensity\.y;/g,replace:""},{search:new RegExp((t?"uniforms.":"")+"vAmbientColor","g"),replace:x+` * ${t?"uniforms.":""}ambientFromScene`},{search:new RegExp((t?"uniforms.":"")+"vAmbientInfos.w","g"),replace:v}];t&&(S[0]={search:/var finalEmissive[\s\S]*?finalEmissive\*=uniforms.vLightingIntensity\.y;/g,replace:""}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalUnlitComponents",r,{replaceStrings:S}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalColorComposition",r,{replaceStrings:[{search:/finalEmissive/g,replace:`vec3${e.fSuffix}(0.)`}]}),S=t?[{search:/mesh.visibility/g,replace:"1."}]:[{search:/visibility/g,replace:"1."}],e.compilationString+=e._emitCodeFromInclude("pbrBlockImageProcessing",r,{replaceStrings:S});const b=t?"fragmentOutputs.color":"gl_FragColor";S=[{search:new RegExp((t?"fragmentInputs.":"")+"vNormalW","g"),replace:this._vNormalWName},{search:new RegExp((t?"fragmentInputs.":"")+"vPositionW","g"),replace:n},{search:/albedoTexture\.rgb;/g,replace:`vec3${e.fSuffix}(1.);\n${b}.rgb = toGammaSpace(${b}.rgb);\n`}],e.compilationString+=e._emitCodeFromInclude("pbrDebug",r,{replaceStrings:S});for(const t of this._outputs)if(t.hasEndpoints){const i=zx[t.name];if(i){const[r,s]=i;s&&(e.compilationString+=`#if ${s}\n`),e.compilationString+=`${e._declareOutput(t)} = ${r};\n`,s&&(e.compilationString+="#else\n",e.compilationString+=`${e._declareOutput(t)} = vec3${e.fSuffix}(0.);\n`,e.compilationString+="#endif\n")}else m.V.Error(`There's no remapping for the ${t.name} end point! No code generated`)}return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.lightFalloff = ${this.lightFalloff};\n`,e+=`${this._codeVariableName}.useAlphaTest = ${this.useAlphaTest};\n`,e+=`${this._codeVariableName}.alphaTestCutoff = ${this.alphaTestCutoff};\n`,e+=`${this._codeVariableName}.useAlphaBlending = ${this.useAlphaBlending};\n`,e+=`${this._codeVariableName}.useRadianceOverAlpha = ${this.useRadianceOverAlpha};\n`,e+=`${this._codeVariableName}.useSpecularOverAlpha = ${this.useSpecularOverAlpha};\n`,e+=`${this._codeVariableName}.enableSpecularAntiAliasing = ${this.enableSpecularAntiAliasing};\n`,e+=`${this._codeVariableName}.realTimeFiltering = ${this.realTimeFiltering};\n`,e+=`${this._codeVariableName}.realTimeFilteringQuality = ${this.realTimeFilteringQuality};\n`,e+=`${this._codeVariableName}.useEnergyConservation = ${this.useEnergyConservation};\n`,e+=`${this._codeVariableName}.useRadianceOcclusion = ${this.useRadianceOcclusion};\n`,e+=`${this._codeVariableName}.useHorizonOcclusion = ${this.useHorizonOcclusion};\n`,e+=`${this._codeVariableName}.unlit = ${this.unlit};\n`,e+=`${this._codeVariableName}.forceNormalForward = ${this.forceNormalForward};\n`,e+=`${this._codeVariableName}.debugMode = ${this.debugMode};\n`,e+=`${this._codeVariableName}.debugLimit = ${this.debugLimit};\n`,e+=`${this._codeVariableName}.debugFactor = ${this.debugFactor};\n`,e}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e.lightFalloff=this.lightFalloff,e.useAlphaTest=this.useAlphaTest,e.alphaTestCutoff=this.alphaTestCutoff,e.useAlphaBlending=this.useAlphaBlending,e.useRadianceOverAlpha=this.useRadianceOverAlpha,e.useSpecularOverAlpha=this.useSpecularOverAlpha,e.enableSpecularAntiAliasing=this.enableSpecularAntiAliasing,e.realTimeFiltering=this.realTimeFiltering,e.realTimeFilteringQuality=this.realTimeFilteringQuality,e.useEnergyConservation=this.useEnergyConservation,e.useRadianceOcclusion=this.useRadianceOcclusion,e.useHorizonOcclusion=this.useHorizonOcclusion,e.unlit=this.unlit,e.forceNormalForward=this.forceNormalForward,e.debugMode=this.debugMode,e.debugLimit=this.debugLimit,e.debugFactor=this.debugFactor,e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.lightFalloff=e.lightFalloff??0,this.useAlphaTest=e.useAlphaTest,this.alphaTestCutoff=e.alphaTestCutoff,this.useAlphaBlending=e.useAlphaBlending,this.useRadianceOverAlpha=e.useRadianceOverAlpha,this.useSpecularOverAlpha=e.useSpecularOverAlpha,this.enableSpecularAntiAliasing=e.enableSpecularAntiAliasing,this.realTimeFiltering=!!e.realTimeFiltering,this.realTimeFilteringQuality=e.realTimeFilteringQuality??8,this.useEnergyConservation=e.useEnergyConservation,this.useRadianceOcclusion=e.useRadianceOcclusion,this.useHorizonOcclusion=e.useHorizonOcclusion,this.unlit=e.unlit,this.forceNormalForward=!!e.forceNormalForward,this.debugMode=e.debugMode,this.debugLimit=e.debugLimit,this.debugFactor=e.debugFactor,this.generateOnlyFragmentCode=!!e.generateOnlyFragmentCode,this._setTarget()}}(0,Ge.Cg)([xh("Direct lights",1,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],Ux.prototype,"directIntensity",void 0),(0,Ge.Cg)([xh("Environment lights",1,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],Ux.prototype,"environmentIntensity",void 0),(0,Ge.Cg)([xh("Specular highlights",1,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],Ux.prototype,"specularIntensity",void 0),(0,Ge.Cg)([xh("Light falloff",4,"LIGHTING & COLORS",{notifiers:{update:!0},options:[{label:"Physical",value:sf.d.LIGHTFALLOFF_PHYSICAL},{label:"GLTF",value:sf.d.LIGHTFALLOFF_GLTF},{label:"Standard",value:sf.d.LIGHTFALLOFF_STANDARD}]})],Ux.prototype,"lightFalloff",void 0),(0,Ge.Cg)([xh("Alpha Testing",0,"OPACITY")],Ux.prototype,"useAlphaTest",void 0),(0,Ge.Cg)([xh("Alpha CutOff",1,"OPACITY",{min:0,max:1,notifiers:{update:!0}})],Ux.prototype,"alphaTestCutoff",void 0),(0,Ge.Cg)([xh("Alpha blending",0,"OPACITY")],Ux.prototype,"useAlphaBlending",void 0),(0,Ge.Cg)([xh("Radiance over alpha",0,"RENDERING",{notifiers:{update:!0}})],Ux.prototype,"useRadianceOverAlpha",void 0),(0,Ge.Cg)([xh("Specular over alpha",0,"RENDERING",{notifiers:{update:!0}})],Ux.prototype,"useSpecularOverAlpha",void 0),(0,Ge.Cg)([xh("Specular anti-aliasing",0,"RENDERING",{notifiers:{update:!0}})],Ux.prototype,"enableSpecularAntiAliasing",void 0),(0,Ge.Cg)([xh("Realtime filtering",0,"RENDERING",{notifiers:{update:!0}})],Ux.prototype,"realTimeFiltering",void 0),(0,Ge.Cg)([xh("Realtime filtering quality",4,"RENDERING",{notifiers:{update:!0},options:[{label:"Low",value:8},{label:"Medium",value:16},{label:"High",value:64}]})],Ux.prototype,"realTimeFilteringQuality",void 0),(0,Ge.Cg)([xh("Energy Conservation",0,"ADVANCED",{notifiers:{update:!0}})],Ux.prototype,"useEnergyConservation",void 0),(0,Ge.Cg)([xh("Radiance occlusion",0,"ADVANCED",{notifiers:{update:!0}})],Ux.prototype,"useRadianceOcclusion",void 0),(0,Ge.Cg)([xh("Horizon occlusion",0,"ADVANCED",{notifiers:{update:!0}})],Ux.prototype,"useHorizonOcclusion",void 0),(0,Ge.Cg)([xh("Unlit",0,"ADVANCED",{notifiers:{update:!0}})],Ux.prototype,"unlit",void 0),(0,Ge.Cg)([xh("Force normal forward",0,"ADVANCED",{notifiers:{update:!0}})],Ux.prototype,"forceNormalForward",void 0),(0,Ge.Cg)([xh("Generate only fragment code",0,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:Ux._OnGenerateOnlyFragmentCodeChanged}})],Ux.prototype,"generateOnlyFragmentCode",void 0),(0,Ge.Cg)([xh("Debug mode",4,"DEBUG",{notifiers:{update:!0},options:[{label:"None",value:0},{label:"Normalized position",value:1},{label:"Normals",value:2},{label:"Tangents",value:3},{label:"Bitangents",value:4},{label:"Bump Normals",value:5},{label:"ClearCoat Normals",value:8},{label:"ClearCoat Tangents",value:9},{label:"ClearCoat Bitangents",value:10},{label:"Anisotropic Normals",value:11},{label:"Anisotropic Tangents",value:12},{label:"Anisotropic Bitangents",value:13},{label:"Env Refraction",value:40},{label:"Env Reflection",value:41},{label:"Env Clear Coat",value:42},{label:"Direct Diffuse",value:50},{label:"Direct Specular",value:51},{label:"Direct Clear Coat",value:52},{label:"Direct Sheen",value:53},{label:"Env Irradiance",value:54},{label:"Surface Albedo",value:60},{label:"Reflectance 0",value:61},{label:"Metallic",value:62},{label:"Metallic F0",value:71},{label:"Roughness",value:63},{label:"AlphaG",value:64},{label:"NdotV",value:65},{label:"ClearCoat Color",value:66},{label:"ClearCoat Roughness",value:67},{label:"ClearCoat NdotV",value:68},{label:"Transmittance",value:69},{label:"Refraction Transmittance",value:70},{label:"SEO",value:80},{label:"EHO",value:81},{label:"Energy Factor",value:82},{label:"Specular Reflectance",value:83},{label:"Clear Coat Reflectance",value:84},{label:"Sheen Reflectance",value:85},{label:"Luminance Over Alpha",value:86},{label:"Alpha",value:87},{label:"Albedo color",value:88},{label:"Ambient occlusion color",value:89}]})],Ux.prototype,"debugMode",void 0),(0,Ge.Cg)([xh("Split position",1,"DEBUG",{min:-1,max:1,notifiers:{update:!0}})],Ux.prototype,"debugLimit",void 0),(0,Ge.Cg)([xh("Output factor",1,"DEBUG",{min:0,max:5,notifiers:{update:!0}})],Ux.prototype,"debugFactor",void 0),(0,a.Y5)("BABYLON.PBRMetallicRoughnessBlock",Ux);class Wx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("left",_d.AutoDetect),this.registerInput("right",_d.AutoDetect),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[1].acceptedConnectionPointTypes.push(_d.Float)}getClassName(){return"ModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return 0===e.shaderLanguage?e.compilationString+=e._declareOutput(t)+` = mod(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`:e.compilationString+=e._declareOutput(t)+` = (${this.left.associatedVariableName} % ${this.right.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.ModBlock",Wx);class Hx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("row0",_d.Vector4),this.registerInput("row1",_d.Vector4),this.registerInput("row2",_d.Vector4),this.registerInput("row3",_d.Vector4),this.registerOutput("output",_d.Matrix)}getClassName(){return"MatrixBuilder"}get row0(){return this._inputs[0]}get row1(){return this._inputs[1]}get row2(){return this._inputs[2]}get row3(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(){if(!this.row0.isConnected){const e=new Fd("row0");e.value=new n.IU(1,0,0,0),e.output.connectTo(this.row0)}if(!this.row1.isConnected){const e=new Fd("row1");e.value=new n.IU(0,1,0,0),e.output.connectTo(this.row1)}if(!this.row2.isConnected){const e=new Fd("row2");e.value=new n.IU(0,0,1,0),e.output.connectTo(this.row2)}if(!this.row3.isConnected){const e=new Fd("row3");e.value=new n.IU(0,0,0,1),e.output.connectTo(this.row3)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.row0,r=this.row1,s=this.row2,n=this.row3,o=1===e.shaderLanguage?"mat4x4f":"mat4";return e.compilationString+=e._declareOutput(t)+` = ${o}(${i.associatedVariableName}, ${r.associatedVariableName}, ${s.associatedVariableName}, ${n.associatedVariableName});\n`,this}}var $x,qx,Yx;(0,a.Y5)("BABYLON.MatrixBuilder",Hx),function(e){e[e.Equal=0]="Equal",e[e.NotEqual=1]="NotEqual",e[e.LessThan=2]="LessThan",e[e.GreaterThan=3]="GreaterThan",e[e.LessOrEqual=4]="LessOrEqual",e[e.GreaterOrEqual=5]="GreaterOrEqual",e[e.Xor=6]="Xor",e[e.Or=7]="Or",e[e.And=8]="And"}($x||($x={}));class Xx extends Ed{constructor(e){super(e,gd.Neutral),this.condition=$x.LessThan,this.registerInput("a",_d.Float),this.registerInput("b",_d.Float),this.registerInput("true",_d.AutoDetect,!0),this.registerInput("false",_d.AutoDetect,!0),this.registerOutput("output",_d.BasedOnInput),this._linkConnectionTypes(2,3),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=_d.Float}getClassName(){return"ConditionalBlock"}get a(){return this._inputs[0]}get b(){return this._inputs[1]}get true(){return this._inputs[2]}get false(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(e){if(!this.true.isConnected){const t=e.getBlockByPredicate((e=>e.isInput&&1===e.value&&"True"===e.name))||new Fd("True");t.value=1,t.output.connectTo(this.true)}if(!this.false.isConnected){const t=e.getBlockByPredicate((e=>e.isInput&&0===e.value&&"False"===e.name))||new Fd("False");t.value=0,t.output.connectTo(this.false)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.true.isConnected?this.true.associatedVariableName:"1.0",r=this.false.isConnected?this.false.associatedVariableName:"0.0";switch(this.condition){case $x.Equal:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} == ${this.b.associatedVariableName}`)};\n`;break;case $x.NotEqual:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} != ${this.b.associatedVariableName}`)};\n`;break;case $x.LessThan:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} < ${this.b.associatedVariableName}`)};\n`;break;case $x.LessOrEqual:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} <= ${this.b.associatedVariableName}`)};\n`;break;case $x.GreaterThan:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} > ${this.b.associatedVariableName}`)};\n`;break;case $x.GreaterOrEqual:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} >= ${this.b.associatedVariableName}`)};\n`;break;case $x.Xor:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`(((${this.a.associatedVariableName} + ${this.b.associatedVariableName}) % 2.0) > 0.0)`)};\n`;break;case $x.Or:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`(min(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 1.0) > 0.0)`)};\n`;break;case $x.And:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`(${this.a.associatedVariableName} * ${this.b.associatedVariableName} > 0.0)`)};\n`}return this}serialize(){const e=super.serialize();return e.condition=this.condition,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.condition=e.condition}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.condition = BABYLON.ConditionalBlockConditions.${$x[this.condition]};\n`}}(0,Ge.Cg)([xh("Condition",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Equal",value:$x.Equal},{label:"NotEqual",value:$x.NotEqual},{label:"LessThan",value:$x.LessThan},{label:"GreaterThan",value:$x.GreaterThan},{label:"LessOrEqual",value:$x.LessOrEqual},{label:"GreaterOrEqual",value:$x.GreaterOrEqual},{label:"Xor",value:$x.Xor},{label:"And",value:$x.And},{label:"Or",value:$x.Or}]})],Xx.prototype,"condition",void 0),(0,a.Y5)("BABYLON.ConditionalBlock",Xx);class jx extends Ed{constructor(e){super(e,gd.Neutral),this.octaves=6,this.registerInput("seed",_d.AutoDetect),this.registerInput("chaos",_d.AutoDetect,!0),this.registerInput("offsetX",_d.Float,!0),this.registerInput("offsetY",_d.Float,!0),this.registerInput("offsetZ",_d.Float,!0),this.registerOutput("output",_d.Float),this._inputs[0].acceptedConnectionPointTypes.push(_d.Vector2),this._inputs[0].acceptedConnectionPointTypes.push(_d.Vector3),this._linkConnectionTypes(0,1)}getClassName(){return"CloudBlock"}get seed(){return this._inputs[0]}get chaos(){return this._inputs[1]}get offsetX(){return this._inputs[2]}get offsetY(){return this._inputs[3]}get offsetZ(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;if(!this._outputs[0].hasEndpoints)return;let t="\n\n        float cloudRandom(float p) { \n            float temp = fract(p * 0.011); \n            temp *= temp + 7.5; \n            temp *= temp + temp; \n            return fract(temp); \n        }\n\n        // Based on Morgan McGuire @morgan3d\n        // https://www.shadertoy.com/view/4dS3Wd\n        float cloudNoise2(vec2 x, vec2 chaos) {\n            vec2 step = chaos * vec2(75., 120.) + vec2(75., 120.);\n\n            vec2 i = floor(x);\n            vec2 f = fract(x);\n\n            float n = dot(i, step);\n\n            vec2 u = f * f * (3.0 - 2.0 * f);\n            return mix(\n                    mix(cloudRandom(n + dot(step, vec2(0, 0))), cloudRandom(n + dot(step, vec2(1, 0))), u.x),\n                    mix(cloudRandom(n + dot(step, vec2(0, 1))), cloudRandom(n + dot(step, vec2(1, 1))), u.x),\n                    u.y\n                );\n        }\n\n        float cloudNoise3(vec3 x, vec3 chaos) {\n            vec3 step = chaos * vec3(60., 120., 75.) + vec3(60., 120., 75.);\n\n            vec3 i = floor(x);\n            vec3 f = fract(x);\n\n            float n = dot(i, step);\n\n            vec3 u = f * f * (3.0 - 2.0 * f);\n            return mix(mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 0))), cloudRandom(n + dot(step, vec3(1, 0, 0))), u.x),\n                           mix( cloudRandom(n + dot(step, vec3(0, 1, 0))), cloudRandom(n + dot(step, vec3(1, 1, 0))), u.x), u.y),\n                       mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 1))), cloudRandom(n + dot(step, vec3(1, 0, 1))), u.x),\n                           mix( cloudRandom(n + dot(step, vec3(0, 1, 1))), cloudRandom(n + dot(step, vec3(1, 1, 1))), u.x), u.y), u.z);\n        }",i="\n        float fbm2(vec2 st, vec2 chaos) {\n            // Initial values\n            float value = 0.0;\n            float amplitude = .5;\n            float frequency = 0.;\n\n            // Loop of octaves\n            vec2 tempST = st;\n            for (int i = 0; i < OCTAVES; i++) {\n                value += amplitude * cloudNoise2(tempST, chaos);\n                tempST *= 2.0;\n                amplitude *= 0.5;\n            }\n            return value;\n        }\n\n        float fbm3(vec3 x, vec3 chaos) {\n            // Initial values\n            float value = 0.0;\n            float amplitude = 0.5;\n            vec3 tempX = x;\n            for (int i = 0; i < OCTAVES; i++) {\n                value += amplitude * cloudNoise3(tempX, chaos);\n                tempX = tempX * 2.0;\n                amplitude *= 0.5;\n            }\n            return value;\n        }";1===e.shaderLanguage&&(t=e._babylonSLtoWGSL(t),i=e._babylonSLtoWGSL(i));const r=`fbm${this.octaves}`;e._emitFunction("CloudBlockCode",t,"// CloudBlockCode"),e._emitFunction("CloudBlockCodeFBM"+this.octaves,i.replace(/fbm/gi,r).replace(/OCTAVES/gi,(0|this.octaves).toString()),"// CloudBlockCode FBM");const s=e._getFreeVariableName("st"),n=this.seed.connectedPoint?.type||_d.Vector3;e.compilationString+=`${e._declareLocalVar(s,n)} = ${this.seed.associatedVariableName};\n`,this.offsetX.isConnected&&(e.compilationString+=`${s}.x += 0.1 * ${this.offsetX.associatedVariableName};\n`),this.offsetY.isConnected&&(e.compilationString+=`${s}.y += 0.1 * ${this.offsetY.associatedVariableName};\n`),this.offsetZ.isConnected&&n===_d.Vector3&&(e.compilationString+=`${s}.z += 0.1 * ${this.offsetZ.associatedVariableName};\n`);let o="";if(this.chaos.isConnected)o=this.chaos.associatedVariableName;else{const t=e.fSuffix;o=this.seed.connectedPoint?.type===_d.Vector2?`vec2${t}(0., 0.)`:`vec3${t}(0., 0., 0.)`}return e.compilationString+=e._declareOutput(this._outputs[0])+` = ${r}${this.seed.connectedPoint?.type===_d.Vector2?"2":"3"}(${s}, ${o});\n`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.octaves = ${this.octaves};\n`}serialize(){const e=super.serialize();return e.octaves=this.octaves,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.octaves=e.octaves}}(0,Ge.Cg)([xh("Octaves",2,void 0,{embedded:!0})],jx.prototype,"octaves",void 0),(0,a.Y5)("BABYLON.CloudBlock",jx);class Zx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("seed",_d.Vector2),this.registerInput("offset",_d.Float),this.registerInput("density",_d.Float),this.registerOutput("output",_d.Float),this.registerOutput("cells",_d.Float)}getClassName(){return"VoronoiNoiseBlock"}get seed(){return this._inputs[0]}get offset(){return this._inputs[1]}get density(){return this._inputs[2]}get output(){return this._outputs[0]}get cells(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;let t="vec2 voronoiRandom(vec2 p){\n            p = vec2(dot(p,vec2(127.1,311.7)),dot(p,vec2(269.5,183.3)));\n            return fract(sin(p)*18.5453);\n        }\n        ";1===e.shaderLanguage&&(t=e._babylonSLtoWGSL(t)),e._emitFunction("voronoiRandom",t,"// Voronoi random generator"),t="void voronoi(vec2 seed, float offset, float density, out float outValue, out float cells){\n            vec2 n = floor(seed * density);\n            vec2 f = fract(seed * density);\n            vec3 m = vec3( 8.0 );\n            for( int j=-1; j<=1; j++ ){\n                for( int i=-1; i<=1; i++ ){\n                    vec2  g = vec2( float(i), float(j) );\n                    vec2  o = voronoiRandom( n + g);\n                    vec2  r = g - f + (0.5+0.5*sin(offset+6.2831*o));\n                    float d = dot( r, r );\n                    if( d<m.x ){\n                        m = vec3( d, o );\n                        outValue = m.x;\n                        cells = m.y;\n                    }\n                }\n\t\t\t}\n        }\n        ",t=1===e.shaderLanguage?e._babylonSLtoWGSL(t):e._babylonSLtoGLSL(t),e._emitFunction("voronoi",t,"// Voronoi");const i=e._getFreeVariableName("tempOutput"),r=e._getFreeVariableName("tempCells"),s=1===e.shaderLanguage?"&":"";return e.compilationString+=`${e._declareLocalVar(i,_d.Float)} = 0.0;\n`,e.compilationString+=`${e._declareLocalVar(r,_d.Float)} = 0.0;\n`,e.compilationString+=`voronoi(${this.seed.associatedVariableName}, ${this.offset.associatedVariableName}, ${this.density.associatedVariableName}, ${s}${i}, ${s}${r});\n`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${i};\n`),this.cells.hasEndpoints&&(e.compilationString+=e._declareOutput(this.cells)+` = ${r};\n`),this}}(0,a.Y5)("BABYLON.VoronoiNoiseBlock",Zx);class Qx extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("input",_d.AutoDetect),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}get target(){const e=this._inputs[0];if(e.isConnected){const t=e.connectedPoint.ownerBlock;if(t.target!==gd.VertexAndFragment)return t.target;if(e.connectedPoint.target!==gd.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){this._target&e||(this._target=e)}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=e._declareOutput(t)+` = ${i.associatedVariableName};\n`,this}}(0,a.Y5)("BABYLON.ElbowBlock",Qx);class Kx extends Ed{get texture(){return this.source.isConnected?(this.source.connectedPoint?.ownerBlock).texture:this._texture}set texture(e){if(this._texture===e)return;const t=e?.getScene()??C.q.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}get textureY(){return this.sourceY.isConnected?(this.sourceY.connectedPoint?.ownerBlock).texture:null}get textureZ(){return this.sourceZ?.isConnected?(this.sourceY.connectedPoint?.ownerBlock).texture:null}_getImageSourceBlock(e){return e?.isConnected?e.connectedPoint.ownerBlock:null}get samplerName(){const e=this._getImageSourceBlock(this.source);return e?e.samplerName:this._samplerName}get samplerYName(){return this._getImageSourceBlock(this.sourceY)?.samplerName??null}get samplerZName(){return this._getImageSourceBlock(this.sourceZ)?.samplerName??null}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const e=this.texture.getScene()??C.q.LastCreatedScene;e?.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const e=this.texture.getScene()??C.q.LastCreatedScene;e?.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,gd.Neutral),this.projectAsCube=!1,this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this.registerInput("position",_d.AutoDetect,!1),this.registerInput("normal",_d.AutoDetect,!1),this.registerInput("sharpness",_d.Float,!0),this.registerInput("source",_d.Object,!0,gd.VertexAndFragment,new c_("source",this,0,dg,"ImageSourceBlock")),this.registerInput("sourceY",_d.Object,!0,gd.VertexAndFragment,new c_("sourceY",this,0,dg,"ImageSourceBlock")),t||this.registerInput("sourceZ",_d.Object,!0,gd.VertexAndFragment,new c_("sourceZ",this,0,dg,"ImageSourceBlock")),this.registerOutput("rgba",_d.Color4,gd.Neutral),this.registerOutput("rgb",_d.Color3,gd.Neutral),this.registerOutput("r",_d.Float,gd.Neutral),this.registerOutput("g",_d.Float,gd.Neutral),this.registerOutput("b",_d.Float,gd.Neutral),this.registerOutput("a",_d.Float,gd.Neutral),this.registerOutput("level",_d.Float,gd.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(_d.Color3|_d.Vector3|_d.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(_d.Color3|_d.Vector3|_d.Vector4)}getClassName(){return"TriPlanarBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get sharpness(){return this._inputs[2]}get source(){return this._inputs[3]}get sourceY(){return this._inputs[4]}get sourceZ(){return this._inputs[5]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;const r=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,s=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,r,!0),i.setValue(this._gammaDefineName,s,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){this.texture&&(e.setFloat(this._textureInfoName,this.texture.level),this._imageSource||e.setTexture(this._samplerName,this.texture))}_samplerFunc(e){return 1===e.shaderLanguage?"textureSample":"texture2D"}_generateTextureSample(e,t,i){return 1===i.shaderLanguage?`${this._samplerFunc(i)}(${e},${e+"Sampler"}, ${t})`:`${this._samplerFunc(i)}(${e}, ${t})`}_generateTextureLookup(e){const t=this.samplerName,i=this.samplerYName??t,r=this.samplerZName??t,s=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",n=e._getFreeVariableName("x"),o=e._getFreeVariableName("y"),a=e._getFreeVariableName("z"),l=e._getFreeVariableName("w"),h=e._getFreeVariableName("n"),c=e._getFreeVariableName("uvx"),u=e._getFreeVariableName("uvy"),d=e._getFreeVariableName("uvz");e.compilationString+=`\n            ${e._declareLocalVar(h,_d.Vector3)} = ${this.normal.associatedVariableName}.xyz;\n\n            ${e._declareLocalVar(c,_d.Vector2)} = ${this.position.associatedVariableName}.yz;\n            ${e._declareLocalVar(u,_d.Vector2)} = ${this.position.associatedVariableName}.zx;\n            ${e._declareLocalVar(d,_d.Vector2)} = ${this.position.associatedVariableName}.xy;\n        `,this.projectAsCube&&(e.compilationString+=`\n                ${c}.xy = ${c}.yx;\n\n                if (${h}.x >= 0.0) {\n                    ${c}.x = -${c}.x;\n                }\n                if (${h}.y < 0.0) {\n                    ${u}.y = -${u}.y;\n                }\n                if (${h}.z < 0.0) {\n                    ${d}.x = -${d}.x;\n                }\n            `);const p=e.fSuffix;e.compilationString+=`\n            ${e._declareLocalVar(n,_d.Vector4)} = ${this._generateTextureSample(t,c,e)};\n            ${e._declareLocalVar(o,_d.Vector4)} = ${this._generateTextureSample(i,u,e)};\n            ${e._declareLocalVar(a,_d.Vector4)} = ${this._generateTextureSample(r,d,e)};\n           \n            // blend weights\n            ${e._declareLocalVar(l,_d.Vector3)} = pow(abs(${h}), vec3${p}(${s}));\n\n            // blend and return\n            ${e._declareLocalVar(this._tempTextureRead,_d.Vector4)} = (${n}*${l}.x + ${o}*${l}.y + ${a}*${l}.z) / (${l}.x + ${l}.y + ${l}.z);        \n        `}_generateConversionCode(e,t,i){let r="";1!==e.shaderLanguage||t.type!==_d.Vector3&&t.type!==_d.Color3||(r="Vec3"),"a"!==i&&(this.texture&&this.texture.gammaSpace||(e.compilationString+=`#ifdef ${this._linearDefineName}\n                    ${t.associatedVariableName} = toGammaSpace${r}(${t.associatedVariableName});\n                    #endif\n                `),e.compilationString+=`#ifdef ${this._gammaDefineName}\n                ${t.associatedVariableName} = toLinearSpace${r}(${t.associatedVariableName});\n                #endif\n            `)}_writeOutput(e,t,i){let r="";this.disableLevelMultiplication||(r=` * ${1===e.shaderLanguage?"uniforms.":""}${this._textureInfoName}`),e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i}${r};\n`,this._generateConversionCode(e,t,i)}_buildBlock(e){super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=(1===e.shaderLanguage?"uniforms.":"")+this._textureInfoName,this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA"),this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Texture"),e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e._emitUniformFromString(this._textureInfoName,_d.Float),this._generateTextureLookup(e);for(const t of this._outputs)t.hasEndpoints&&"level"!==t.name&&this._writeOutput(e,t,t.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\n`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};\n`,e+=`${this._codeVariableName}.projectAsCube = ${this.projectAsCube};\n`,this.texture?(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e):e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.disableLevelMultiplication=this.disableLevelMultiplication,e.projectAsCube=this.projectAsCube,this.hasImageSource||!this.texture||this.texture.isRenderTarget||"VideoTexture"===this.texture.getClassName()||(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.disableLevelMultiplication=!!e.disableLevelMultiplication,this.projectAsCube=!!e.projectAsCube,e.texture&&!Jd.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=$e.g.Parse(e.texture,t,i))}}(0,Ge.Cg)([xh("Project as cube",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],Kx.prototype,"projectAsCube",void 0),(0,a.Y5)("BABYLON.TriPlanarBlock",Kx);class Jx extends Kx{constructor(e){super(e,!0)}getClassName(){return"BiPlanarBlock"}_declareLocalVarAsVec3I(e,t){return 1===t.shaderLanguage?`var ${e}: vec3<i32>`:`ivec3 ${e}`}_getTextureGrad(e,t){return 1===e.shaderLanguage?`textureSampleGrad(${t},${t+"Sampler"}`:`textureGrad(${t}`}_generateTextureLookup(e){const t=this.samplerName,i=this.samplerYName??this.samplerName,r=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",s=e._getFreeVariableName("dxValue"),n=e._getFreeVariableName("dyValue"),o=e._getFreeVariableName("n"),a=e._getFreeVariableName("ma"),l=e._getFreeVariableName("mi"),h=e._getFreeVariableName("me"),c=e._getFreeVariableName("x"),u=e._getFreeVariableName("y"),d=e._getFreeVariableName("w");let p="ivec3",m="dFdx",f="dFdy";const _=e.fSuffix;1===e.shaderLanguage&&(p="vec3<i32>",m="dpdx",f="dpdy"),e.compilationString+=`\n            // grab coord derivatives for texturing\n            ${e._declareLocalVar(s,_d.Vector3)} = ${m}(${this.position.associatedVariableName}.xyz);\n            ${e._declareLocalVar(n,_d.Vector3)} = ${f}(${this.position.associatedVariableName}.xyz);\n            ${e._declareLocalVar(o,_d.Vector3)} = abs(${this.normal.associatedVariableName}.xyz);\n        \n            // determine major axis (in x; yz are following axis)\n            ${this._declareLocalVarAsVec3I(a,e)} = ${e._generateTernary(`${p}(0,1,2)`,`${e._generateTernary(`${p}(1,2,0)`,`${p}(2,0,1)`,`(${o}.y>${o}.z)`)}`,`(${o}.x>${o}.y && ${o}.x>${o}.z)`)};                    \n\n            // determine minor axis (in x; yz are following axis)\n            ${this._declareLocalVarAsVec3I(l,e)} =  ${e._generateTernary(`${p}(0,1,2)`,`${e._generateTernary(`${p}(1,2,0)`,`${p}(2,0,1)`,`(${o}.y<${o}.z)`)}`,`(${o}.x<${o}.y && ${o}.x<${o}.z)`)};  \n                              \n            // determine median axis (in x;  yz are following axis)\n            ${this._declareLocalVarAsVec3I(h,e)} = ${p}(3) - ${l} - ${a};\n            \n            // project+fetch\n            ${e._declareLocalVar(c,_d.Vector4)} = ${this._getTextureGrad(e,t)}, vec2${_}(${this.position.associatedVariableName}[${a}.y], ${this.position.associatedVariableName}[${a}.z]), \n                                    vec2${_}(${s}[${a}.y],${s}[${a}.z]), \n                                    vec2${_}(${n}[${a}.y],${n}[${a}.z]));\n            ${e._declareLocalVar(u,_d.Vector4)} = ${this._getTextureGrad(e,i)}, vec2${_}(${this.position.associatedVariableName}[${h}.y], ${this.position.associatedVariableName}[${h}.z]), \n                                    vec2${_}(${s}[${h}.y],${s}[${h}.z]),\n                                    vec2${_}(${n}[${h}.y],${n}[${h}.z]));\n            \n            // blend factors\n            ${e._declareLocalVar(d,_d.Vector2)} = vec2${_}(${o}[${a}.x],${o}[${h}.x]);\n            // make local support\n            ${d} = clamp( (${d}-0.5773)/(1.0-0.5773), vec2${_}(0.0), vec2${_}(1.0) );\n            // shape transition\n            ${d} = pow( ${d}, vec2${_}(${r}/8.0) );\n            // blend and return\n            ${e._declareLocalVar(this._tempTextureRead,_d.Vector4)} = (${c}*${d}.x + ${u}*${d}.y) / (${d}.x + ${d}.y);\n        `}}(0,a.Y5)("BABYLON.BiPlanarBlock",Jx);class ev extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("input",_d.Matrix),this.registerOutput("output",_d.Float)}getClassName(){return"MatrixDeterminantBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=e._declareOutput(t)+` = determinant(${i.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.MatrixDeterminantBlock",ev);class tv extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("input",_d.Matrix),this.registerOutput("output",_d.Matrix)}getClassName(){return"MatrixTransposeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=e._declareOutput(t)+` = transpose(${i.associatedVariableName});\n`,this}}(0,a.Y5)("BABYLON.MatrixTransposeBlock",tv),function(e){e[e.None=0]="None",e[e.Normal=1]="Normal",e[e.Tangent=2]="Tangent",e[e.VertexColor=3]="VertexColor",e[e.UV1=4]="UV1",e[e.UV2=5]="UV2",e[e.UV3=6]="UV3",e[e.UV4=7]="UV4",e[e.UV5=8]="UV5",e[e.UV6=9]="UV6"}(qx||(qx={}));class iv extends Ed{constructor(e){super(e,gd.Neutral),this.attributeType=0,this.registerInput("input",_d.AutoDetect),this.registerInput("fallback",_d.AutoDetect),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].onConnectionObservable.add((e=>{if(this.attributeType)return;const t=e.ownerBlock;if(t instanceof Fd&&t.isAttribute)switch(t.name){case"color":this.attributeType=3;break;case"normal":this.attributeType=1;break;case"tangent":this.attributeType=2;break;case"uv":this.attributeType=4;break;case"uv2":this.attributeType=5;break;case"uv3":this.attributeType=6;break;case"uv4":this.attributeType=7;break;case"uv5":this.attributeType=8;break;case"uv6":this.attributeType=9}else if(t instanceof x_)switch(this.input.connectedPoint?.name){case"normalOutput":this.attributeType=1;break;case"tangentOutput":this.attributeType=2;break;case"uvOutput":this.attributeType=4;break;case"uv2Output":this.attributeType=5}}))}getClassName(){return"MeshAttributeExistsBlock"}get input(){return this._inputs[0]}get fallback(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=null;switch(this.attributeType){case 3:t="VERTEXCOLOR_NME";break;case 1:t="NORMAL";break;case 2:t="TANGENT";break;case 4:t="UV1";break;case 5:t="UV2";break;case 6:t="UV3";break;case 7:t="UV4";break;case 8:t="UV5";break;case 9:t="UV6"}const i=e._declareOutput(this.output);return t&&(e.compilationString+=`#ifdef ${t}\n`),e.compilationString+=`${i} = ${this.input.associatedVariableName};\n`,t&&(e.compilationString+="#else\n",e.compilationString+=`${i} = ${this.fallback.associatedVariableName};\n`,e.compilationString+="#endif\n"),this}serialize(){const e=super.serialize();return e.attributeType=this.attributeType,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.attributeType=e.attributeType??0}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.attributeType = ${this.attributeType};\n`,e}}(0,Ge.Cg)([xh("Attribute lookup",4,void 0,{notifiers:{update:!0},embedded:!0,options:[{label:"(None)",value:0},{label:"Normal",value:1},{label:"Tangent",value:2},{label:"Vertex Color",value:3},{label:"UV1",value:4},{label:"UV2",value:5},{label:"UV3",value:6},{label:"UV4",value:7},{label:"UV5",value:8},{label:"UV6",value:9}]})],iv.prototype,"attributeType",void 0),(0,a.Y5)("BABYLON.MeshAttributeExistsBlock",iv),function(e){e[e.EaseInSine=0]="EaseInSine",e[e.EaseOutSine=1]="EaseOutSine",e[e.EaseInOutSine=2]="EaseInOutSine",e[e.EaseInQuad=3]="EaseInQuad",e[e.EaseOutQuad=4]="EaseOutQuad",e[e.EaseInOutQuad=5]="EaseInOutQuad",e[e.EaseInCubic=6]="EaseInCubic",e[e.EaseOutCubic=7]="EaseOutCubic",e[e.EaseInOutCubic=8]="EaseInOutCubic",e[e.EaseInQuart=9]="EaseInQuart",e[e.EaseOutQuart=10]="EaseOutQuart",e[e.EaseInOutQuart=11]="EaseInOutQuart",e[e.EaseInQuint=12]="EaseInQuint",e[e.EaseOutQuint=13]="EaseOutQuint",e[e.EaseInOutQuint=14]="EaseInOutQuint",e[e.EaseInExpo=15]="EaseInExpo",e[e.EaseOutExpo=16]="EaseOutExpo",e[e.EaseInOutExpo=17]="EaseInOutExpo",e[e.EaseInCirc=18]="EaseInCirc",e[e.EaseOutCirc=19]="EaseOutCirc",e[e.EaseInOutCirc=20]="EaseInOutCirc",e[e.EaseInBack=21]="EaseInBack",e[e.EaseOutBack=22]="EaseOutBack",e[e.EaseInOutBack=23]="EaseInOutBack",e[e.EaseInElastic=24]="EaseInElastic",e[e.EaseOutElastic=25]="EaseOutElastic",e[e.EaseInOutElastic=26]="EaseInOutElastic"}(Yx||(Yx={}));class rv extends Ed{constructor(e){super(e,gd.Neutral),this.type=Yx.EaseInOutSine,this.registerInput("input",_d.AutoDetect),this.registerOutput("output",_d.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(_d.Matrix),this._inputs[0].excludedConnectionPointTypes.push(_d.Object),this._inputs[0].excludedConnectionPointTypes.push(_d.Int)}getClassName(){return"CurveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_duplicateEntry(e,t){return`ret.${t} = ${e.replace(/VAL/g,"v."+t)}`}_duplicateEntryDirect(e){return`return ${e.replace(/VAL/g,"v")}`}_duplicateVector(e,t,i){if("float"===t||"f32"===t)return this._duplicateEntryDirect(e);const r=parseInt(t.replace("vec",""));let s=i?`\n            var ret: vec${r}f = vec${r}f(0.0);\n        `:`\n            vec${r} ret = vec${r}(0.0);\n        `;for(let t=1;t<=r;t++)s+=this._duplicateEntry(e,1===t?"x":2===t?"y":3===t?"z":"w")+";\n";return s+="return ret;\n",s}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="",r="";const s=e._getShaderType(this.input.type),n=1===e.shaderLanguage;switch(r=Yx[this.type]+"_"+s.replace("<","").replace(">",""),this.type){case Yx.EaseInSine:i="return 1.0 - cos((v * 3.1415) / 2.0)";break;case Yx.EaseOutSine:i="return sin((v * 3.1415) / 2.0)";break;case Yx.EaseInOutSine:i="return -(cos(v * 3.1415) - 1.0) / 2.0";break;case Yx.EaseInQuad:i="return v * v";break;case Yx.EaseOutQuad:i="return (1.0 - v) * (1.0 - v)";break;case Yx.EaseInOutQuad:{const t=e._generateTernary("2.0 * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 2.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,s,n);break}case Yx.EaseInCubic:i="return v * v * v";break;case Yx.EaseOutCubic:{const e="1.0 - pow(1.0 - VAL, 3.0)";i=this._duplicateVector(e,s,n);break}case Yx.EaseInOutCubic:{const t=e._generateTernary("4.0 * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 3.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,s,n);break}case Yx.EaseInQuart:i="return v * v * v * v";break;case Yx.EaseOutQuart:{const e="1.0 - pow(1.0 - VAL, 4.0)";i=this._duplicateVector(e,s,n);break}case Yx.EaseInOutQuart:{const t=e._generateTernary("8.0 * VAL * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 4.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,s,n);break}case Yx.EaseInQuint:i="return v * v * v * v * v";break;case Yx.EaseOutQuint:{const e="1.0 - pow(1.0 - VAL, 5.0)";i=this._duplicateVector(e,s,n);break}case Yx.EaseInOutQuint:{const t=e._generateTernary("16.0 * VAL * VAL * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 5.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,s,n);break}case Yx.EaseInExpo:{const t=e._generateTernary("0.0","pow(2.0, 10.0 * VAL - 10.0)","VAL == 0.0");i=this._duplicateVector(t,s,n);break}case Yx.EaseOutExpo:{const t=e._generateTernary("1.0","1.0 - pow(2.0, -10.0 * VAL)","VAL == 1.0");i=this._duplicateVector(t,s,n);break}case Yx.EaseInOutExpo:{const t=e._generateTernary("0.0",e._generateTernary("1.0",e._generateTernary("pow(2.0, 20.0 * VAL - 10.0) / 2.0","(2.0 - pow(2.0, -20.0 * VAL + 10.0)) / 2.0","VAL < 0.5"),"VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(t,s,n);break}case Yx.EaseInCirc:{const e="1.0 - sqrt(1.0 - pow(VAL, 2.0))";i=this._duplicateVector(e,s,n);break}case Yx.EaseOutCirc:{const e="sqrt(1.0 - pow(VAL - 1.0, 2.0))";i=this._duplicateVector(e,s,n);break}case Yx.EaseInOutCirc:{const t=e._generateTernary("(1.0 - sqrt(1.0 - pow(2.0 * VAL, 2.0))) / 2.0","(sqrt(1.0 - pow(-2.0 * VAL + 2.0, 2.0)) + 1.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,s,n);break}case Yx.EaseInBack:i="return 2.70158 * v * v * v - 1.70158 * v * v";break;case Yx.EaseOutBack:{const e="2.70158 * pow(VAL - 1.0, 3.0) + 1.70158 * pow(VAL - 1.0, 2.0)";i=this._duplicateVector(e,s,n);break}case Yx.EaseInOutBack:{const t=e._generateTernary("(pow(2.0 * VAL, 2.0) * ((3.5949095) * 2.0 * VAL - 2.5949095)) / 2.0","(pow(2.0 * VAL - 2.0, 2.0) * (3.5949095 * (VAL * 2.0 - 2.0) + 3.5949095) + 2.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,s,n);break}case Yx.EaseInElastic:{const t=e._generateTernary("0.0",e._generateTernary("1.0","-pow(2.0, 10.0 * VAL - 10.0) * sin((VAL * 10.0 - 10.75) * ((2.0 * 3.1415) / 3.0))","VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(t,s,n);break}case Yx.EaseOutElastic:{const t=e._generateTernary("0.0",e._generateTernary("1.0","pow(2.0, -10.0 * VAL) * sin((VAL * 10.0 - 0.75) * ((2.0 * 3.1415) / 3.0)) + 1.0","VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(t,s,n);break}case Yx.EaseInOutElastic:{const t=e._generateTernary("0.0",e._generateTernary("1.0",e._generateTernary("-(pow(2.0, 20.0 * VAL - 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0","(pow(2.0, -20.0 * VAL + 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0 + 1.0","VAL < 0.5"),"VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(t,s,n);break}}return n?e._emitFunction(r,`fn ${r}(v: ${s}) -> ${s}  {${i};}\n`,""):e._emitFunction(r,`${s} ${r}(${s} v) {${i};}\n`,""),e.compilationString+=e._declareOutput(t)+` = ${r}(${this.input.associatedVariableName});\n`,this}serialize(){const e=super.serialize();return e.curveType=this.type,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.type=e.curveType}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.type = BABYLON.CurveBlockTypes.${Yx[this.type]};\n`}}(0,Ge.Cg)([xh("Type",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"EaseInSine",value:Yx.EaseInSine},{label:"EaseOutSine",value:Yx.EaseOutSine},{label:"EaseInOutSine",value:Yx.EaseInOutSine},{label:"EaseInQuad",value:Yx.EaseInQuad},{label:"EaseOutQuad",value:Yx.EaseOutQuad},{label:"EaseInOutQuad",value:Yx.EaseInOutQuad},{label:"EaseInCubic",value:Yx.EaseInCubic},{label:"EaseOutCubic",value:Yx.EaseOutCubic},{label:"EaseInOutCubic",value:Yx.EaseInOutCubic},{label:"EaseInQuart",value:Yx.EaseInQuart},{label:"EaseOutQuart",value:Yx.EaseOutQuart},{label:"EaseInOutQuart",value:Yx.EaseInOutQuart},{label:"EaseInQuint",value:Yx.EaseInQuint},{label:"EaseOutQuint",value:Yx.EaseOutQuint},{label:"EaseInOutQuint",value:Yx.EaseInOutQuint},{label:"EaseInExpo",value:Yx.EaseInExpo},{label:"EaseOutExpo",value:Yx.EaseOutExpo},{label:"EaseInOutExpo",value:Yx.EaseInOutExpo},{label:"EaseInCirc",value:Yx.EaseInCirc},{label:"EaseOutCirc",value:Yx.EaseOutCirc},{label:"EaseInOutCirc",value:Yx.EaseInOutCirc},{label:"EaseInBack",value:Yx.EaseInBack},{label:"EaseOutBack",value:Yx.EaseOutBack},{label:"EaseInOutBack",value:Yx.EaseInOutBack},{label:"EaseInElastic",value:Yx.EaseInElastic},{label:"EaseOutElastic",value:Yx.EaseOutElastic},{label:"EaseInOutElastic",value:Yx.EaseInOutElastic}]})],rv.prototype,"type",void 0),(0,a.Y5)("BABYLON.CurveBlock",rv);class sv extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("rgb ",_d.Color3,!0),this.registerInput("hsl ",_d.Color3,!0),this.registerOutput("rgb",_d.Color3),this.registerOutput("hsl",_d.Color3)}getClassName(){return"ColorConverterBlock"}get rgbIn(){return this._inputs[0]}get hslIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get hslOut(){return this._outputs[1]}_inputRename(e){return"rgb "===e?"rgbIn":"hsl "===e?"hslIn":e}_buildBlock(e){super._buildBlock(e);const t=this.rgbIn,i=this.hslIn,r=this._outputs[0],s=this._outputs[1],n=e._getShaderType(_d.Vector3);let o="\n            vec3 rgb2hsl(vec3 color) {\n                float r = color.r;\n                float g = color.g;\n                float b = color.b;\n\n                float maxc = max(r, max(g, b));\n                float minc = min(r, min(g, b));\n                float h = 0.0;\n                float s = 0.0;\n                float l = (maxc + minc) / 2.0;\n\n                if (maxc != minc) {\n                    float d = maxc - minc;\n                    if (l > 0.5) {\n                        s = d / (2.0 - maxc - minc);\n                    } else {\n                        s = d / (maxc + minc);\n                    }\n\n                    if (maxc == r) {\n                        float add = 0.0;\n                        if (g < b) {\n                            add = 6.0;\n                        }\n                        h = (g - b) / d + add;\n                    } else if (maxc == g) {\n                        h = (b - r) / d + 2.0;\n                    } else if (maxc == b) {\n                        h = (r - g) / d + 4.0;\n                    }\n                    h /= 6.0;\n                }\n\n                return vec3(h, s, l);\n            }",a="\n            float hue2rgb(float p, float q, float tt) {\n                float t = tt;\n                if (t < 0.0) {\n                    t += 1.0;\n                }\n                if (t > 1.0) {\n                    t -= 1.0;\n                }\n                if (t < 1.0/6.0) {\n                    return p + (q - p) * 6.0 * t;\n                }\n                if (t < 1.0/2.0) {\n                    return q;\n                }\n                if (t < 2.0/3.0) {\n                    return p + (q - p) * (2.0/3.0 - t) * 6.0;\n                }\n                return p;\n            }",l="\n            vec3 hsl2rgb(vec3 hsl) {\n                float h = hsl.x;\n                float s = hsl.y;\n                float l = hsl.z;\n\n                float r;\n                float g;\n                float b;\n\n                if (s == 0.0) {\n                    // Achromatic (grey)\n                    r = l;\n                    g = l;\n                    b = l; \n                } else {\n                    float q;\n                \n                    if (l < 0.5) {\n                        q = l * (1.0 + s);\n                    } else {\n                        q = (l + s - l * s);\n                    }\n\n                    float p = 2.0 * l - q;\n\n                    r = hue2rgb(p, q, h + 1.0/3.0);\n                    g = hue2rgb(p, q, h);\n                    b = hue2rgb(p, q, h - 1.0/3.0);\n                }\n\n                return vec3(r, g, b);\n            }";return 1===e.shaderLanguage&&(o=e._babylonSLtoWGSL(o),a=e._babylonSLtoWGSL(a),l=e._babylonSLtoWGSL(l)),e._emitFunction("rgb2hsl",o,""),e._emitFunction("hue2rgb",a,""),e._emitFunction("hsl2rgb",l,""),t.isConnected?(r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName};\n`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = rgb2hsl(${t.associatedVariableName});\n`)):i.isConnected?(r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = hsl2rgb(${i.associatedVariableName});\n`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${i.associatedVariableName};\n`)):(r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` =  ${n}(0.);\n`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` =  ${n}(0.);\n`)),this}}(0,a.Y5)("BABYLON.ColorConverterBlock",sv);class nv extends Ed{constructor(e){super(e,gd.Neutral),this.iterations=4,this.registerInput("input",_d.AutoDetect),this.registerInput("iterations",_d.Float,!0),this.registerOutput("output",_d.BasedOnInput),this.registerOutput("index",_d.Float,gd.Fragment),this.registerOutput("loopID",_d.Object,void 0,new c_("loopID",this,1,nv,"LoopBlock")),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0]._forPostBuild=!0,this._outputs[2]._redirectedSource=this._inputs[0],this._outputs[1]._preventBubbleUp=!0,this._outputs[2]._preventBubbleUp=!0}getClassName(){return"LoopBlock"}get input(){return this._inputs[0]}get iterationsInput(){return this._inputs[1]}get output(){return this._outputs[0]}get index(){return this._outputs[1]}get loopID(){return this._outputs[2]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._outputs[1],r=e._getFreeVariableName("index"),s=1===e.shaderLanguage?"var":"int",n=1===e.shaderLanguage?"f32":"float",o=1===e.shaderLanguage?"i32":"int";e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName};\n`;const a=this.iterationsInput.isConnected?`${o}(${this.iterationsInput.associatedVariableName})`:this.iterations;return e.compilationString+=`for (${s} ${r} = 0; ${r} < ${a}; ${r}++){\n`,e.compilationString+=`${e._declareOutput(i)} = ${n}(${r});\n`,this}_postBuildBlock(e){return super._postBuildBlock(e),e.compilationString+="}\n",this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.iterations = ${this.iterations};\n`}serialize(){const e=super.serialize();return e.iterations=this.iterations,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.iterations=e.iterations}}(0,Ge.Cg)([xh("Iterations",2,void 0,{embedded:!0})],nv.prototype,"iterations",void 0),(0,a.Y5)("BABYLON.LoopBlock",nv);class ov extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("loopID",_d.Object,!1,void 0,new c_("loopID",this,0,nv,"LoopBlock")),this.registerOutput("value",_d.AutoDetect),this._outputs[0]._linkedConnectionSource=this._inputs[0]}getClassName(){return"StorageReadBlock"}get loopID(){return this._inputs[0]}get value(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.value;if(!this.loopID.isConnected)return this;const i=this.loopID.connectedPoint.ownerBlock;return e.compilationString+=e._declareOutput(t)+` = ${i.output.associatedVariableName};\n`,this}}(0,a.Y5)("BABYLON.StorageReadBlock",ov);class av extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("loopID",_d.Object,!1,void 0,new c_("loopID",this,0,nv,"LoopBlock")),this.registerInput("value",_d.AutoDetect),this._linkConnectionTypes(0,1)}getClassName(){return"StorageWriteBlock"}get loopID(){return this._inputs[0]}get value(){return this._inputs[1]}isConnectedInFragmentShader(){if(!this.loopID.isConnected)return!1;return this.loopID.connectedPoint.ownerBlock.output.isConnectedInFragmentShader}_buildBlock(e){super._buildBlock(e);const t=this.value;if(!this.loopID.isConnected)return this;const i=this.loopID.connectedPoint.ownerBlock;return e.compilationString+=`${i.output.associatedVariableName} = ${t.associatedVariableName};\n`,this}}(0,a.Y5)("BABYLON.StorageWriteBlock",av);class lv extends Ed{constructor(e){super(e,gd.Neutral),this.registerInput("input",_d.Matrix),this.registerOutput("row0",_d.Vector4),this.registerOutput("row1",_d.Vector4),this.registerOutput("row2",_d.Vector4),this.registerOutput("row3",_d.Vector4),this.registerOutput("col0",_d.Vector4),this.registerOutput("col1",_d.Vector4),this.registerOutput("col2",_d.Vector4),this.registerOutput("col3",_d.Vector4)}getClassName(){return"MatrixSplitterBlock"}get input(){return this._inputs[0]}get row0(){return this._outputs[0]}get row1(){return this._outputs[1]}get row2(){return this._outputs[2]}get row3(){return this._outputs[3]}get col0(){return this._outputs[4]}get col1(){return this._outputs[5]}get col2(){return this._outputs[6]}get col3(){return this._outputs[7]}_exportColumn(e,t,i,r){const s=1===e.shaderLanguage?"vec4f":"vec4";e.compilationString+=e._declareOutput(t)+` = ${s}(${i}[0][${r}], ${i}[1][${r}], ${i}[2][${r}], ${i}[3][${r}]);\n`}_buildBlock(e){super._buildBlock(e);const t=this._inputs[0].associatedVariableName,i=this.row0,r=this.row1,s=this.row2,n=this.row3,o=this.col0,a=this.col1,l=this.col2,h=this.col3;return i.hasEndpoints&&(e.compilationString+=e._declareOutput(i)+` = ${t}[0];\n`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t}[1];\n`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${t}[2];\n`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${t}[3];\n`),o.hasEndpoints&&this._exportColumn(e,o,t,0),a.hasEndpoints&&this._exportColumn(e,a,t,1),l.hasEndpoints&&this._exportColumn(e,l,t,2),h.hasEndpoints&&this._exportColumn(e,h,t,3),this}}(0,a.Y5)("BABYLON.MatrixSplitterBlock",lv);const hv="gaussianSplattingVertexDeclaration",cv="attribute position: vec2f;\n";qi.l.IncludesShadersStoreWGSL[hv]=cv;const uv={name:hv,shader:cv};var dv=i(39775);class pv extends Ed{get isActive(){return this._isActive&&this.debug.isConnected}set isActive(e){this._isActive!==e&&(this._isActive=e)}constructor(e){super(e,gd.Fragment,!0,!0),this._isActive=!1,this.renderAlpha=!1,this.registerInput("debug",_d.AutoDetect,!0),this.debug.excludedConnectionPointTypes.push(_d.Matrix)}get _isFinalOutputAndActive(){return this.isActive}get _hasPrecedence(){return!0}get debug(){return this._inputs[0]}getClassName(){return"NodeMaterialDebugBlock"}_buildBlock(e){if(super._buildBlock(e),!this._isActive)return this;let t="gl_FragColor";1===e.shaderLanguage&&(t="fragmentOutputs.color");const i=this.debug;return i.connectedPoint?(i.connectedPoint.type===_d.Float?e.compilationString+=`${t}  = vec4${e.fSuffix}(${i.associatedVariableName}, ${i.associatedVariableName}, ${i.associatedVariableName}, 1.0);\n`:i.connectedPoint.type===_d.Vector2?e.compilationString+=`${t}  = vec4${e.fSuffix}(${i.associatedVariableName}, 0., 1.0);\n`:i.connectedPoint.type===_d.Color3||i.connectedPoint.type===_d.Vector3?e.compilationString+=`${t}  = vec4${e.fSuffix}(${i.associatedVariableName}, 1.0);\n`:this.renderAlpha?e.compilationString+=`${t}  =${i.associatedVariableName};\n`:e.compilationString+=`${t}  = vec4${e.fSuffix}(${i.associatedVariableName}.rgb, 1.0);\n`,this):this}serialize(){const e=super.serialize();return e.isActive=this._isActive,e.renderAlpha=this.renderAlpha,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.isActive=e.isActive,this.renderAlpha=e.renderAlpha}}(0,Ge.Cg)([xh("Render Alpha",0,void 0)],pv.prototype,"renderAlpha",void 0),(0,a.Y5)("BABYLON.NodeMaterialDebugBlock",pv);class mv{optimize(e,t){}}var fv=i(38688);class _v{constructor(){this.mm=new Map}get(e,t){const i=this.mm.get(e);if(void 0!==i)return i.get(t)}set(e,t,i){let r=this.mm.get(e);void 0===r&&this.mm.set(e,r=new Map),r.set(t,i)}}class gv{get standalone(){return this._options?.standalone??!1}get baseMaterial(){return this._baseMaterial}get doNotInjectCode(){return this._options?.doNotInjectCode??!1}constructor(e,t,i){this._baseMaterial=e,this._scene=t??C.q.LastCreatedScene,this._options=i,this._subMeshToEffect=new Map,this._subMeshToDepthWrapper=new _v,this._meshes=new Map,this._onEffectCreatedObserver=this._baseMaterial.onEffectCreatedObservable.add((e=>{const t=e.subMesh?.getMesh();t&&!this._meshes.has(t)&&this._meshes.set(t,t.onDisposeObservable.add((e=>{const t=this._subMeshToEffect.keys();for(let i=t.next();!0!==i.done;i=t.next()){const t=i.value;t?.getMesh()===e&&(this._subMeshToEffect.delete(t),this._deleteDepthWrapperEffect(t))}}))),this._subMeshToEffect.get(e.subMesh)?.[0]!==e.effect&&(this._subMeshToEffect.set(e.subMesh,[e.effect,this._scene.getEngine().currentRenderPassId]),this._deleteDepthWrapperEffect(e.subMesh))}))}_deleteDepthWrapperEffect(e){const t=this._subMeshToDepthWrapper.mm.get(e);t&&(t.forEach((e=>{e.mainDrawWrapper.effect?.dispose()})),this._subMeshToDepthWrapper.mm.delete(e))}getEffect(e,t,i){const r=this._subMeshToDepthWrapper.mm.get(e)?.get(t);if(!r)return null;let s=r.drawWrapper[i];return s||(s=r.drawWrapper[i]=new Ah.E(this._scene.getEngine()),s.setEffect(r.mainDrawWrapper.effect,r.mainDrawWrapper.defines)),s}isReadyForSubMesh(e,t,i,r,s){return!(this.standalone&&!this._baseMaterial.isReadyForSubMesh(e.getMesh(),e,r))&&(this._makeEffect(e,t,i,s)?.isReady()??!1)}dispose(){this._baseMaterial.onEffectCreatedObservable.remove(this._onEffectCreatedObserver),this._onEffectCreatedObserver=null;const e=this._meshes.entries();for(let t=e.next();!0!==t.done;t=e.next()){const[e,i]=t.value;e.onDisposeObservable.remove(i)}}_makeEffect(e,t,i,r){const s=this._scene.getEngine(),n=this._subMeshToEffect.get(e);if(!n)return null;const[o,a]=n;let l=this._subMeshToDepthWrapper.get(e,i);if(!l){const t=new Ah.E(s);t.defines=e._getDrawWrapper(a)?.defines??null,l={drawWrapper:[],mainDrawWrapper:t,depthDefines:"",token:(0,fv.z)()},l.drawWrapper[r]=t,this._subMeshToDepthWrapper.set(e,i,l)}const h=t.join("\n");if(l.mainDrawWrapper.effect&&h===l.depthDefines)return l.mainDrawWrapper.effect;l.depthDefines=h;const c=o.getUniformNames().slice();let u=o.vertexSourceCodeBeforeMigration,d=o.fragmentSourceCodeBeforeMigration;if(!this.doNotInjectCode){const e=this._options&&this._options.remappedVariables?`#include<shadowMapVertexNormalBias>(${this._options.remappedVariables.join(",")})`:"#include<shadowMapVertexNormalBias>",t=this._options&&this._options.remappedVariables?`#include<shadowMapVertexMetric>(${this._options.remappedVariables.join(",")})`:"#include<shadowMapVertexMetric>",i=this._options&&this._options.remappedVariables?`#include<shadowMapFragmentSoftTransparentShadow>(${this._options.remappedVariables.join(",")})`:"#include<shadowMapFragmentSoftTransparentShadow>",r="#include<shadowMapFragment>",s="#include<shadowMapVertexExtraDeclaration>";u=0===o.shaderLanguage?u.replace(/void\s+?main/g,`\n${s}\nvoid main`):u.replace(/@vertex/g,`\n${s}\n@vertex`),u=u.replace(/#define SHADOWDEPTH_NORMALBIAS|#define CUSTOM_VERTEX_UPDATE_WORLDPOS/g,e),u=-1!==u.indexOf("#define SHADOWDEPTH_METRIC")?u.replace(/#define SHADOWDEPTH_METRIC/g,t):u.replace(/}\s*$/g,t+"\n}"),u=u.replace(/#define SHADER_NAME.*?\n|out vec4 glFragColor;\n/g,"");const n=d.indexOf("#define SHADOWDEPTH_SOFTTRANSPARENTSHADOW")>=0||d.indexOf("#define CUSTOM_FRAGMENT_BEFORE_FOG")>=0,a=-1!==d.indexOf("#define SHADOWDEPTH_FRAGMENT");let l="";n?d=d.replace(/#define SHADOWDEPTH_SOFTTRANSPARENTSHADOW|#define CUSTOM_FRAGMENT_BEFORE_FOG/g,i):l=i+"\n",d=d.replace(/void\s+?main/g,xo.M.IncludesShadersStore.shadowMapFragmentExtraDeclaration+"\nvoid main"),a?d=d.replace(/#define SHADOWDEPTH_FRAGMENT/g,r):l+=r+"\n",l&&(d=d.replace(/}\s*$/g,l+"}")),c.push("biasAndScaleSM","depthValuesSM","lightDataSM","softTransparentShadowSM")}l.mainDrawWrapper.effect=s.createEffect({vertexSource:u,fragmentSource:d,vertexToken:l.token,fragmentToken:l.token},{attributes:o.getAttributesNames(),uniformsNames:c,uniformBuffersNames:o.getUniformBuffersNames(),samplers:o.getSamplers(),defines:h+"\n"+o.defines.replace("#define SHADOWS","").replace(/#define SHADOW\d/g,""),indexParameters:o.getIndexParameters(),shaderLanguage:o.shaderLanguage},s);for(let e=0;e<l.drawWrapper.length;++e)e!==r&&l.drawWrapper[e]?.setEffect(l.mainDrawWrapper.effect,l.mainDrawWrapper.defines);return l.mainDrawWrapper.effect}}var xv,vv=i(50074),Sv=i(83040);!function(e){e[e.Created=1]="Created",e[e.Disposed=2]="Disposed",e[e.GetDefineNames=4]="GetDefineNames",e[e.PrepareUniformBuffer=8]="PrepareUniformBuffer",e[e.IsReadyForSubMesh=16]="IsReadyForSubMesh",e[e.PrepareDefines=32]="PrepareDefines",e[e.BindForSubMesh=64]="BindForSubMesh",e[e.PrepareEffect=128]="PrepareEffect",e[e.GetAnimatables=256]="GetAnimatables",e[e.GetActiveTextures=512]="GetActiveTextures",e[e.HasTexture=1024]="HasTexture",e[e.FillRenderTargetTextures=2048]="FillRenderTargetTextures",e[e.HasRenderTargetTextures=4096]="HasRenderTargetTextures",e[e.HardBindForSubMesh=8192]="HardBindForSubMesh"}(xv||(xv={}));var bv=i(97841);class yv extends Hu.M{constructor(){super(...arguments),this.DECAL=!1,this.DECALDIRECTUV=0,this.DECAL_SMOOTHALPHA=!1,this.GAMMADECAL=!1}}class Pv extends vv.y{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"DecalMap",150,new yv,t),this._isEnabled=!1,this.isEnabled=!1,this._smoothAlpha=!1,this.smoothAlpha=!1,this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i,r){const s=r.getMesh().decalMap;return!(this._isEnabled&&s?.texture&&$u.h.DecalMapEnabled&&t.texturesEnabled)||s.isReady()}prepareDefinesBeforeAttributes(e,t,i){const r=i.decalMap;if(this._isEnabled&&r?.texture&&$u.h.DecalMapEnabled&&t.texturesEnabled){(!e.DECAL||e.GAMMADECAL!==r.texture.gammaSpace)&&e.markAsTexturesDirty(),e.DECAL=!0,e.GAMMADECAL=r.texture.gammaSpace,e.DECAL_SMOOTHALPHA=this._smoothAlpha,(0,ts.YT)(r.texture,e,"DECAL")}else{e.DECAL&&e.markAsTexturesDirty(),e.DECAL=!1}}hardBindForSubMesh(e,t,i,r){const s=r.getMesh().decalMap;if(!(this._isEnabled&&s?.texture&&$u.h.DecalMapEnabled&&t.texturesEnabled))return;const n=this._material.isFrozen,o=s.texture;e.useUbo&&n&&e.isSync||(e.updateFloat4("vDecalInfos",o.coordinatesIndex,0,0,0),(0,ts.mA)(o,e,"decal")),e.setTexture("decalSampler",o)}getClassName(){return"DecalMapConfiguration"}getSamplers(e){e.push("decalSampler")}getUniforms(){return{ubo:[{name:"vDecalInfos",size:4,type:"vec4"},{name:"decalMatrix",size:16,type:"mat4"}]}}}function Tv(e){return e instanceof sf.d?new rf.i(e):null}function Cv(e){return e instanceof sf.d?new of.j(e):null}function Ev(e){return e instanceof sf.d?new af.t(e):null}function Av(e){return e instanceof sf.d?new lf.z(e):null}function Iv(e){return e instanceof sf.d?new df.C(e):null}function Rv(e){return e instanceof sf.d?new pf.I(e):null}function Mv(e){return e instanceof sf.d||e instanceof br.F?new bv.c(e):null}(0,Ge.Cg)([(0,ze.lK)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],Pv.prototype,"isEnabled",void 0),(0,Ge.Cg)([(0,ze.lK)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],Pv.prototype,"smoothAlpha",void 0),(0,a.Y5)("BABYLON.DecalMapConfiguration",Pv);class Dv{}Dv.DEFAULT_COLOR=o.v9.White(),Dv.DEFAULT_WIDTH_ATTENUATED=1,Dv.DEFAULT_WIDTH=.1;class Ov{static ConvertPoints(e,t){if(e.length&&Array.isArray(e)&&"number"==typeof e[0])return[e];if(e.length&&Array.isArray(e[0])&&"number"==typeof e[0][0])return e;if(e.length&&!Array.isArray(e[0])&&e[0]instanceof n.Pq){const t=[];for(let i=0;i<e.length;i++){const r=e[i];t.push(r.x,r.y,r.z)}return[t]}if(e.length>0&&Array.isArray(e[0])&&e[0].length>0&&e[0][0]instanceof n.Pq){const t=[];return e.forEach((e=>{t.push(e.flatMap((e=>[e.x,e.y,e.z])))})),t}if(e instanceof Float32Array){if(t?.floatArrayStride){const i=[],r=3*t.floatArrayStride;for(let t=0;t<e.length;t+=r){const s=new Array(r);for(let i=0;i<r;i++)s[i]=e[t+i];i.push(s)}return i}return[Array.from(e)]}if(e.length&&e[0]instanceof Float32Array){const t=[];return e.forEach((e=>{t.push(Array.from(e))})),t}return[]}static OmitZeroLengthPredicate(e,t,i){const r=[];return t.subtract(e).lengthSquared()>0&&r.push([e,t]),i.subtract(t).lengthSquared()>0&&r.push([t,i]),e.subtract(i).lengthSquared()>0&&r.push([i,e]),0===r.length?null:r}static OmitDuplicatesPredicate(e,t,i,r){const s=[];return Ov._SearchInPoints(e,t,r)||s.push([e,t]),Ov._SearchInPoints(t,i,r)||s.push([t,i]),Ov._SearchInPoints(i,e,r)||s.push([i,e]),0===s.length?null:s}static _SearchInPoints(e,t,i){for(const r of i)for(let i=0;i<r.length;i++)if(r[i]?.equals(e)&&(r[i+1]?.equals(t)||r[i-1]?.equals(t)))return!0;return!1}static MeshesToLines(e,t){const i=[];return e.forEach(((e,r)=>{const s=e.getVerticesData(Ot.R.PositionKind),o=e.getIndices();if(s&&o)for(let a=0,l=0;a<o.length;a++){const h=3*o[l++],c=3*o[l++],u=3*o[l++],d=new n.Pq(s[h],s[h+1],s[h+2]),p=new n.Pq(s[c],s[c+1],s[c+2]),m=new n.Pq(s[u],s[u+1],s[u+2]);if(t){const n=t(d,p,m,i,a,h,e,r,s,o);if(n)for(const e of n)i.push(e)}else i.push([d,p],[p,m],[m,d])}})),i}static ToVector3Array(e){if(Array.isArray(e[0])){const t=[],i=e;for(const e of i){const i=[];for(let t=0;t<e.length;t+=3)i.push(new n.Pq(e[t],e[t+1],e[t+2]));t.push(i)}return t}const t=e,i=[];for(let e=0;e<t.length;e+=3)i.push(new n.Pq(t[e],t[e+1],t[e+2]));return i}static ToNumberArray(e){return e.flatMap((e=>[e.x,e.y,e.z]))}static GetPointsCountInfo(e){const t=new Array(e.length);let i=0;for(let r=e.length;r--;)t[r]=e[r].length/3,i+=t[r];return{total:i,counts:t}}static GetLineLength(e){if(0===e.length)return 0;let t;t="number"==typeof e[0]?Ov.ToVector3Array(e):e;const i=n.AA.Vector3[0];let r=0;for(let e=0;e<t.length-1;e++){const s=t[e];r+=t[e+1].subtractToRef(s,i).length()}return r}static GetLineLengthArray(e){const t=new Float32Array(e.length/3);let i=0;for(let r=0,s=e.length/3-1;r<s;r++){let s=e[3*r+0],n=e[3*r+1],o=e[3*r+2];s-=e[3*r+3],n-=e[3*r+4],o-=e[3*r+5];i+=Math.sqrt(s*s+n*n+o*o),t[r+1]=i}return t}static SegmentizeSegmentByCount(e,t,i){const r=[],s=t.subtract(e),o=n.AA.Vector3[0];o.setAll(i);const a=n.AA.Vector3[1];s.divideToRef(o,a);let l=e.clone();r.push(l);for(let e=0;e<i;e++)l=l.clone(),r.push(l.addInPlace(a));return r}static SegmentizeLineBySegmentLength(e,t){const i=e[0]instanceof n.Pq?Ov.GetLineSegments(e):"number"==typeof e[0]?Ov.GetLineSegments(Ov.ToVector3Array(e)):e,r=[];return i.forEach((e=>{if(e.length>t){Ov.SegmentizeSegmentByCount(e.point1,e.point2,Math.ceil(e.length/t)).forEach((e=>{r.push(e)}))}else r.push(e.point1),r.push(e.point2)})),r}static SegmentizeLineBySegmentCount(e,t){const i="number"==typeof e[0]?Ov.ToVector3Array(e):e,r=Ov.GetLineLength(i)/t;return Ov.SegmentizeLineBySegmentLength(i,r)}static GetLineSegments(e){const t=[];for(let i=0;i<e.length-1;i++){const r=e[i],s=e[i+1],n=s.subtract(r).length();t.push({point1:r,point2:s,length:n})}return t}static GetMinMaxSegmentLength(e){const t=Ov.GetLineSegments(e).sort((e=>e.length));return{min:t[0].length,max:t[t.length-1].length}}static GetPositionOnLineByVisibility(e,t,i,r=!1){const s=t*i;let o=0,a=0;const l=e.length;for(let t=0;t<l;t++){if(s<=o+e[t].length){a=t;break}o+=e[t].length}const h=(s-o)/e[a].length;return e[a].point2.subtractToRef(e[a].point1,n.AA.Vector3[0]),n.AA.Vector3[1]=n.AA.Vector3[0].multiplyByFloats(h,h,h),r||n.AA.Vector3[1].addInPlace(e[a].point1),n.AA.Vector3[1].clone()}static GetCircleLinePoints(e,t,i=0,r=e,s=2*Math.PI/t){const o=[];for(let a=0;a<=t;a++)o.push(new n.Pq(Math.cos(a*s)*e,Math.sin(a*s)*r,i));return o}static GetBezierLinePoints(e,t,i,r){return Tn.jj.CreateQuadraticBezier(e,t,i,r).getPoints().flatMap((e=>[e.x,e.y,e.z]))}static GetArrowCap(e,t,i,r,s,n=0,o=0){return{points:[e.clone(),e.add(t.multiplyByFloats(i,i,i))],widths:[r,s,n,o]}}static GetPointsFromText(e,t,i,r,s=0,n=!0){const o=[],a=po(e,t,i,r);for(const e of a){for(const t of e.paths){const e=[],i=t.getPoints();for(const t of i)e.push(t.x,t.y,s);o.push(e)}if(n)for(const t of e.holes){const e=[],i=t.getPoints();for(const t of i)e.push(t.x,t.y,s);o.push(e)}}return o}static Color3toRGBAUint8(e){const t=new Uint8Array(4*e.length);for(let i=0,r=0;i<e.length;i++)t[r++]=255*e[i].r,t[r++]=255*e[i].g,t[r++]=255*e[i].b,t[r++]=255;return t}static CreateColorsTexture(e,t,i,r){const s=r.getEngine().getCaps().maxTextureSize??1,n=t.length>s?s:t.length,o=Math.ceil(t.length/s);o>1&&(t=[...t,...Array(n*o-t.length).fill(t[0])]);const a=Ov.Color3toRGBAUint8(t),l=new He.I(a,n,o,Vi.Engine.TEXTUREFORMAT_RGBA,r,!1,!0,i);return l.name=e,l}static PrepareEmptyColorsTexture(e){if(!Dv.EmptyColorsTexture){const t=new Uint8Array(4);Dv.EmptyColorsTexture=new He.I(t,1,1,Vi.Engine.TEXTUREFORMAT_RGBA,e,!1,!1,He.I.NEAREST_NEAREST),Dv.EmptyColorsTexture.name="grlEmptyColorsTexture"}return Dv.EmptyColorsTexture}static DisposeEmptyColorsTexture(){Dv.EmptyColorsTexture?.dispose(),Dv.EmptyColorsTexture=null}static BooleanToNumber(e){return e?1:0}}class Nv extends Hu.M{constructor(){super(...arguments),this.GREASED_LINE_HAS_COLOR=!1,this.GREASED_LINE_SIZE_ATTENUATION=!1,this.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=!1,this.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=!1,this.GREASED_LINE_CAMERA_FACING=!0,this.GREASED_LINE_USE_OFFSETS=!1}}class wv extends vv.y{isCompatible(e){return!0}constructor(e,t,i){i=i||{color:Dv.DEFAULT_COLOR};const r=new Nv;r.GREASED_LINE_HAS_COLOR=!!i.color&&!i.useColors,r.GREASED_LINE_SIZE_ATTENUATION=i.sizeAttenuation??!1,r.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=1===i.colorDistributionType,r.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=(t??e.getScene()).useRightHandedSystem,r.GREASED_LINE_CAMERA_FACING=i.cameraFacing??!0,super(e,wv.GREASED_LINE_MATERIAL_NAME,200,r,!0,!0),this.colorsTexture=null,this._forceGLSL=!1,this._forceGLSL=i?.forceGLSL||wv.ForceGLSL,this._scene=t??e.getScene(),this._engine=this._scene.getEngine(),this._cameraFacing=i.cameraFacing??!0,this.visibility=i.visibility??1,this.useDash=i.useDash??!1,this.dashRatio=i.dashRatio??.5,this.dashOffset=i.dashOffset??0,this.width=i.width?i.width:i.sizeAttenuation?Dv.DEFAULT_WIDTH_ATTENUATED:Dv.DEFAULT_WIDTH,this._sizeAttenuation=i.sizeAttenuation??!1,this.colorMode=i.colorMode??0,this._color=i.color??null,this.useColors=i.useColors??!1,this._colorsDistributionType=i.colorDistributionType??0,this.colorsSampling=i.colorsSampling??He.I.NEAREST_NEAREST,this._colors=i.colors??null,this.dashCount=i.dashCount??1,this.resolution=i.resolution??new n.I9(this._engine.getRenderWidth(),this._engine.getRenderHeight()),i.colorsTexture?this.colorsTexture=i.colorsTexture:this._colors?this.colorsTexture=Ov.CreateColorsTexture(`${e.name}-colors-texture`,this._colors,this.colorsSampling,this._scene):(this._color=this._color??Dv.DEFAULT_COLOR,Ov.PrepareEmptyColorsTexture(this._scene)),this._engine.onDisposeObservable.add((()=>{Ov.DisposeEmptyColorsTexture()}))}getAttributes(e){e.push("grl_offsets"),e.push("grl_widths"),e.push("grl_colorPointers"),e.push("grl_counters"),this._cameraFacing?(e.push("grl_previousAndSide"),e.push("grl_nextAndCounters")):e.push("grl_slopes")}getSamplers(e){e.push("grl_colors")}getActiveTextures(e){this.colorsTexture&&e.push(this.colorsTexture)}getUniforms(e=0){const t=[{name:"grl_singleColor",size:3,type:"vec3"},{name:"grl_textureSize",size:2,type:"vec2"},{name:"grl_dashOptions",size:4,type:"vec4"},{name:"grl_colorMode_visibility_colorsWidth_useColors",size:4,type:"vec4"}];return this._cameraFacing&&t.push({name:"grl_projection",size:16,type:"mat4"},{name:"grl_aspect_resolution_lineWidth",size:4,type:"vec4"}),1===e&&t.push({name:"viewProjection",size:16,type:"mat4"}),{ubo:t,vertex:this._cameraFacing&&this._isGLSL(e)?"\n                    uniform vec4 grl_aspect_resolution_lineWidth;\n                    uniform mat4 grl_projection;\n    ":"",fragment:this._isGLSL(e)?"\n                    uniform vec4 grl_dashOptions;\n                    uniform vec2 grl_textureSize;\n                    uniform vec4 grl_colorMode_visibility_colorsWidth_useColors;\n                    uniform vec3 grl_singleColor;\n    ":""}}get isEnabled(){return!0}bindForSubMesh(e){if(this._cameraFacing){e.updateMatrix("grl_projection",this._scene.getProjectionMatrix()),!this._isGLSL(this._material.shaderLanguage)&&e.updateMatrix("viewProjection",this._scene.getTransformMatrix());const t=n.AA.Vector4[0];t.x=this._aspect,t.y=this._resolution.x,t.z=this._resolution.y,t.w=this.width,e.updateVector4("grl_aspect_resolution_lineWidth",t)}const t=n.AA.Vector4[0];t.x=Ov.BooleanToNumber(this.useDash),t.y=this._dashArray,t.z=this.dashOffset,t.w=this.dashRatio,e.updateVector4("grl_dashOptions",t);const i=n.AA.Vector4[1];i.x=this.colorMode,i.y=this.visibility,i.z=this.colorsTexture?this.colorsTexture.getSize().width:0,i.w=Ov.BooleanToNumber(this.useColors),e.updateVector4("grl_colorMode_visibility_colorsWidth_useColors",i),this._color&&e.updateColor3("grl_singleColor",this._color);const r=this.colorsTexture??Dv.EmptyColorsTexture;e.setTexture("grl_colors",r),e.updateFloat2("grl_textureSize",r?.getSize().width??1,r?.getSize().height??1)}prepareDefines(e,t,i){e.GREASED_LINE_HAS_COLOR=!!this.color&&!this.useColors,e.GREASED_LINE_SIZE_ATTENUATION=this._sizeAttenuation,e.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=1===this._colorsDistributionType,e.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=t.useRightHandedSystem,e.GREASED_LINE_CAMERA_FACING=this._cameraFacing,e.GREASED_LINE_USE_OFFSETS=!!i.offsets}getClassName(){return wv.GREASED_LINE_MATERIAL_NAME}getCustomCode(e,t=0){return this._isGLSL(t)?function(e,t){if("vertex"===e){const e={CUSTOM_VERTEX_DEFINITIONS:"\n                attribute float grl_widths;\n                attribute vec3 grl_offsets;\n                attribute float grl_colorPointers;\n                varying float grlCounters;\n                varying float grlColorPointer;\n\n                #ifdef GREASED_LINE_CAMERA_FACING\n                    attribute vec4 grl_previousAndSide;\n                    attribute vec4 grl_nextAndCounters;\n\n                    vec2 grlFix( vec4 i, float aspect ) {\n                        vec2 res = i.xy / i.w;\n                        res.x *= aspect;\n                        return res;\n                    }\n                #else\n                    attribute vec3 grl_slopes;\n                    attribute float grl_counters;\n                #endif\n                ",CUSTOM_VERTEX_UPDATE_POSITION:"\n                #ifdef GREASED_LINE_CAMERA_FACING\n                    vec3 grlPositionOffset = grl_offsets;\n                    positionUpdated += grlPositionOffset;\n                #else\n                    positionUpdated = (positionUpdated + grl_offsets) + (grl_slopes * grl_widths);\n                #endif\n                ",CUSTOM_VERTEX_MAIN_END:"\n                grlColorPointer = grl_colorPointers;\n\n                #ifdef GREASED_LINE_CAMERA_FACING\n\n                    float grlAspect = grl_aspect_resolution_lineWidth.x;\n                    float grlBaseWidth = grl_aspect_resolution_lineWidth.w;\n\n                    vec3 grlPrevious = grl_previousAndSide.xyz;\n                    float grlSide = grl_previousAndSide.w;\n\n                    vec3 grlNext = grl_nextAndCounters.xyz;\n                    grlCounters = grl_nextAndCounters.w;\n                    float grlWidth = grlBaseWidth * grl_widths;\n                    \n                    vec3 worldDir = normalize(grlNext - grlPrevious);\n                    vec3 nearPosition = positionUpdated + (worldDir * 0.001);\n                    mat4 grlMatrix = viewProjection * finalWorld;\n                    vec4 grlFinalPosition = grlMatrix * vec4(positionUpdated , 1.0);\n                    vec4 screenNearPos = grlMatrix * vec4(nearPosition, 1.0);\n                    vec2 grlLinePosition = grlFix(grlFinalPosition, grlAspect);\n                    vec2 grlLineNearPosition = grlFix(screenNearPos, grlAspect);\n                    vec2 grlDir = normalize(grlLineNearPosition - grlLinePosition);\n\n                    vec4 grlNormal = vec4(-grlDir.y, grlDir.x, 0., 1.);\n\n                    #ifdef GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM\n                        grlNormal.xy *= -.5 * grlWidth;\n                    #else\n                        grlNormal.xy *= .5 * grlWidth;\n                    #endif\n\n                    grlNormal *= grl_projection;\n\n                    #ifdef GREASED_LINE_SIZE_ATTENUATION\n                        grlNormal.xy *= grlFinalPosition.w;\n                        grlNormal.xy /= (vec4(grl_aspect_resolution_lineWidth.yz, 0., 1.) * grl_projection).xy;\n                    #endif\n\n                    grlFinalPosition.xy += grlNormal.xy * grlSide;\n                    gl_Position = grlFinalPosition;\n\n                    vPositionW = vec3(grlFinalPosition);\n                #else\n                    grlCounters = grl_counters;\n                #endif\n                "};return t&&(e["!gl_Position\\=viewProjection\\*worldPos;"]="//"),e}return"fragment"===e?{CUSTOM_FRAGMENT_DEFINITIONS:"\n                    #ifdef PBR\n                         #define grlFinalColor finalColor\n                    #else\n                         #define grlFinalColor color\n                    #endif\n\n                    varying float grlCounters;\n                    varying float grlColorPointer;\n                    uniform sampler2D grl_colors;\n                ",CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR:"\n                    float grlColorMode = grl_colorMode_visibility_colorsWidth_useColors.x;\n                    float grlVisibility = grl_colorMode_visibility_colorsWidth_useColors.y;\n                    float grlColorsWidth = grl_colorMode_visibility_colorsWidth_useColors.z;\n                    float grlUseColors = grl_colorMode_visibility_colorsWidth_useColors.w;\n\n                    float grlUseDash = grl_dashOptions.x;\n                    float grlDashArray = grl_dashOptions.y;\n                    float grlDashOffset = grl_dashOptions.z;\n                    float grlDashRatio = grl_dashOptions.w;\n\n                    grlFinalColor.a *= step(grlCounters, grlVisibility);\n                    if(grlFinalColor.a == 0.) discard;\n\n                    if(grlUseDash == 1.){\n                        grlFinalColor.a *= ceil(mod(grlCounters + grlDashOffset, grlDashArray) - (grlDashArray * grlDashRatio));\n                        if (grlFinalColor.a == 0.) discard;\n                    }\n\n                    #ifdef GREASED_LINE_HAS_COLOR\n                        if (grlColorMode == 0.) {\n                            grlFinalColor.rgb = grl_singleColor;\n                        } else if (grlColorMode == 1.) {\n                            grlFinalColor.rgb += grl_singleColor;\n                        } else if (grlColorMode == 2.) {\n                            grlFinalColor.rgb *= grl_singleColor;\n                        }\n                    #else\n                        if (grlUseColors == 1.) {\n                            #ifdef GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE\n                                vec4 grlColor = texture2D(grl_colors, vec2(grlCounters, 0.), 0.);\n                            #else\n                                vec2 lookup = vec2(fract(grlColorPointer / grl_textureSize.x), 1.0 - floor(grlColorPointer / grl_textureSize.x) / max(grl_textureSize.y - 1.0, 1.0));\n                                vec4 grlColor = texture2D(grl_colors, lookup, 0.0);\n                            #endif\n                            if (grlColorMode == 0.) {\n                                grlFinalColor = grlColor;\n                            } else if (grlColorMode == 1.) {\n                                grlFinalColor += grlColor;\n                            } else if (grlColorMode == 2.) {\n                                grlFinalColor *= grlColor;\n                            }\n                        }\n                    #endif\n                "}:null}(e,this._cameraFacing):function(e,t){if("vertex"===e){const e={CUSTOM_VERTEX_DEFINITIONS:"\n                attribute grl_widths: f32;\n                attribute grl_colorPointers: f32;\n                varying grlCounters: f32;\n                varying grlColorPointer: f32;\n\n                #ifdef GREASED_LINE_USE_OFFSETS\n                    attribute grl_offsets: vec3f;   \n                #endif\n\n                #ifdef GREASED_LINE_CAMERA_FACING\n                    attribute grl_previousAndSide : vec4f;\n                    attribute grl_nextAndCounters : vec4f;\n\n                    fn grlFix(i: vec4f, aspect: f32) -> vec2f {\n                        var res = i.xy / i.w;\n                        res.x *= aspect;\n                        return res;\n                    }\n                #else\n                    attribute grl_slopes: f32;\n                    attribute grl_counters: f32;\n                #endif\n\n\n                ",CUSTOM_VERTEX_UPDATE_POSITION:"\n                #ifdef GREASED_LINE_USE_OFFSETS\n                    var grlPositionOffset: vec3f = input.grl_offsets;\n                #else\n                    var grlPositionOffset = vec3f(0.);\n                #endif\n\n                #ifdef GREASED_LINE_CAMERA_FACING\n                    positionUpdated += grlPositionOffset;\n                #else\n                    positionUpdated = (positionUpdated + grlPositionOffset) + (input.grl_slopes * input.grl_widths);\n                #endif\n                ",CUSTOM_VERTEX_MAIN_END:"\n                vertexOutputs.grlColorPointer = input.grl_colorPointers;\n\n                #ifdef GREASED_LINE_CAMERA_FACING\n\n                    let grlAspect: f32 = uniforms.grl_aspect_resolution_lineWidth.x;\n                    let grlBaseWidth: f32 = uniforms.grl_aspect_resolution_lineWidth.w;\n\n                    let grlPrevious: vec3f = input.grl_previousAndSide.xyz;\n                    let grlSide: f32 = input.grl_previousAndSide.w;\n\n                    let grlNext: vec3f = input.grl_nextAndCounters.xyz;\n                    vertexOutputs.grlCounters = input.grl_nextAndCounters.w;\n\n                    let grlWidth: f32 = grlBaseWidth * input.grl_widths;\n\n                    let worldDir: vec3f = normalize(grlNext - grlPrevious);\n                    let nearPosition: vec3f = positionUpdated + (worldDir * 0.001);\n                    let grlMatrix: mat4x4f = uniforms.viewProjection * finalWorld;\n                    let grlFinalPosition: vec4f = grlMatrix * vec4f(positionUpdated, 1.0); \n                    let screenNearPos: vec4f = grlMatrix * vec4(nearPosition, 1.0);\n                    let grlLinePosition: vec2f = grlFix(grlFinalPosition, grlAspect);\n                    let grlLineNearPosition: vec2f = grlFix(screenNearPos, grlAspect);\n                    let grlDir: vec2f = normalize(grlLineNearPosition - grlLinePosition);\n\n                    var grlNormal: vec4f = vec4f(-grlDir.y, grlDir.x, 0.0, 1.0);\n\n                    let grlHalfWidth: f32 = 0.5 * grlWidth;\n                    #if defined(GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM)\n                        grlNormal.x *= -grlHalfWidth;\n                        grlNormal.y *= -grlHalfWidth;\n                    #else\n                        grlNormal.x *= grlHalfWidth;\n                        grlNormal.y *= grlHalfWidth;\n                    #endif\n\n                    grlNormal *= uniforms.grl_projection;\n\n                    #if defined(GREASED_LINE_SIZE_ATTENUATION)\n                        grlNormal.x *= grlFinalPosition.w;\n                        grlNormal.y *= grlFinalPosition.w;\n\n                        let pr = vec4f(uniforms.grl_aspect_resolution_lineWidth.yz, 0.0, 1.0) * uniforms.grl_projection;\n                        grlNormal.x /= pr.x;\n                        grlNormal.y /= pr.y;\n                    #endif\n\n                    vertexOutputs.position = vec4f(grlFinalPosition.xy + grlNormal.xy * grlSide, grlFinalPosition.z, grlFinalPosition.w);\n                    vertexOutputs.vPositionW = vertexOutputs.position.xyz;\n                \n                #else\n                    vertexOutputs.grlCounters = input.grl_counters;\n                #endif\n                "};return t&&(e["!vertexOutputs\\.position\\s=\\sscene\\.viewProjection\\s\\*\\sworldPos;"]="//"),e}return"fragment"===e?{CUSTOM_FRAGMENT_DEFINITIONS:"\n                    #ifdef PBR\n                         #define grlFinalColor finalColor\n                    #else\n                         #define grlFinalColor color\n                    #endif\n\n                    varying grlCounters: f32;\n                    varying grlColorPointer: 32;\n\n                    var grl_colors: texture_2d<f32>;\n                    var grl_colorsSampler: sampler;\n                ",CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR:"\n                    let grlColorMode: f32 = uniforms.grl_colorMode_visibility_colorsWidth_useColors.x;\n                    let grlVisibility: f32 = uniforms.grl_colorMode_visibility_colorsWidth_useColors.y;\n                    let grlColorsWidth: f32 = uniforms.grl_colorMode_visibility_colorsWidth_useColors.z;\n                    let grlUseColors: f32 = uniforms.grl_colorMode_visibility_colorsWidth_useColors.w;\n\n                    let grlUseDash: f32 = uniforms.grl_dashOptions.x;\n                    let grlDashArray: f32 = uniforms.grl_dashOptions.y;\n                    let grlDashOffset: f32 = uniforms.grl_dashOptions.z;\n                    let grlDashRatio: f32 = uniforms.grl_dashOptions.w;\n\n                    grlFinalColor.a *= step(fragmentInputs.grlCounters, grlVisibility);\n                    if (grlFinalColor.a == 0.0) {\n                        discard;\n                    }\n\n                    if (grlUseDash == 1.0) {\n                        let dashPosition = (fragmentInputs.grlCounters + grlDashOffset) % grlDashArray;\n                        grlFinalColor.a *= ceil(dashPosition - (grlDashArray * grlDashRatio));\n\n                        if (grlFinalColor.a == 0.0) {\n                            discard;\n                        }\n                    }\n\n                    #ifdef GREASED_LINE_HAS_COLOR\n                        if (grlColorMode == 0.) {\n                            grlFinalColor = vec4f(uniforms.grl_singleColor, grlFinalColor.a);\n                        } else if (grlColorMode == 1.) {\n                            grlFinalColor += vec4f(uniforms.grl_singleColor, grlFinalColor.a);\n                        } else if (grlColorMode == 2.) {\n                            grlFinalColor *= vec4f(uniforms.grl_singleColor, grlFinalColor.a);\n                        }\n                    #else\n                        if (grlUseColors == 1.) {\n                            #ifdef GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE\n                                let grlColor: vec4f = textureSample(grl_colors, grl_colorsSampler, vec2f(fragmentInputs.grlCounters, 0.));\n                            #else\n                                let lookup: vec2f = vec2(fract(fragmentInputs.grlColorPointer / uniforms.grl_textureSize.x), 1.0 - floor(fragmentInputs.grlColorPointer / uniforms.grl_textureSize.x) / max(uniforms.grl_textureSize.y - 1.0, 1.0));\n                                let grlColor: vec4f = textureSample(grl_colors, grl_colorsSampler, lookup);\n                            #endif\n                            if (grlColorMode == 0.) {\n                                grlFinalColor = grlColor;\n                            } else if (grlColorMode == 1.) {\n                                grlFinalColor += grlColor;\n                            } else if (grlColorMode == 2.) {\n                                grlFinalColor *= grlColor;\n                            }\n                        }\n                    #endif\n\n\n                "}:null}(e,this._cameraFacing)}dispose(){this.colorsTexture?.dispose(),super.dispose()}get colors(){return this._colors}set colors(e){this.setColors(e)}setColors(e,t=!1,i=!1){const r=this._colors?.length??0;if(this._colors=e,null!==e&&0!==e.length){if(!t||i)if(this.colorsTexture&&r===e.length&&!i){const t=Ov.Color3toRGBAUint8(e);this.colorsTexture.update(t)}else this.colorsTexture?.dispose(),this.colorsTexture=Ov.CreateColorsTexture(`${this._material.name}-colors-texture`,e,this.colorsSampling,this._scene)}else this.colorsTexture?.dispose()}updateLazy(){this._colors&&this.setColors(this._colors,!1,!0)}get dashCount(){return this._dashCount}set dashCount(e){this._dashCount=e,this._dashArray=1/e}get sizeAttenuation(){return this._sizeAttenuation}set sizeAttenuation(e){this._sizeAttenuation=e,this.markAllDefinesAsDirty()}get color(){return this._color}set color(e){this.setColor(e)}setColor(e,t=!1){null===this._color&&null!==e||null!==this._color&&null===e?(this._color=e,!t&&this.markAllDefinesAsDirty()):this._color=e}get colorsDistributionType(){return this._colorsDistributionType}set colorsDistributionType(e){this._colorsDistributionType=e,this.markAllDefinesAsDirty()}get resolution(){return this._resolution}set resolution(e){this._aspect=e.x/e.y,this._resolution=e}serialize(){const e=super.serialize(),t={colorDistributionType:this._colorsDistributionType,colorsSampling:this.colorsSampling,colorMode:this.colorMode,dashCount:this._dashCount,dashOffset:this.dashOffset,dashRatio:this.dashRatio,resolution:this._resolution,sizeAttenuation:this._sizeAttenuation,useColors:this.useColors,useDash:this.useDash,visibility:this.visibility,width:this.width};return this._colors&&(t.colors=this._colors),this._color&&(t.color=this._color),e.greasedLineMaterialOptions=t,e}parse(e,t,i){super.parse(e,t,i);const r=e.greasedLineMaterialOptions;this.colorsTexture?.dispose(),r.color&&this.setColor(r.color,!0),r.colorDistributionType&&(this.colorsDistributionType=r.colorDistributionType),r.colors&&(this.colors=r.colors),r.colorsSampling&&(this.colorsSampling=r.colorsSampling),r.colorMode&&(this.colorMode=r.colorMode),r.useColors&&(this.useColors=r.useColors),r.visibility&&(this.visibility=r.visibility),r.useDash&&(this.useDash=r.useDash),r.dashCount&&(this.dashCount=r.dashCount),r.dashRatio&&(this.dashRatio=r.dashRatio),r.dashOffset&&(this.dashOffset=r.dashOffset),r.width&&(this.width=r.width),r.sizeAttenuation&&(this.sizeAttenuation=r.sizeAttenuation),r.resolution&&(this.resolution=r.resolution),this.colors?this.colorsTexture=Ov.CreateColorsTexture(`${this._material.name}-colors-texture`,this.colors,this.colorsSampling,t):Ov.PrepareEmptyColorsTexture(t),this.markAllDefinesAsDirty()}copyTo(e){const t=e;t.colorsTexture?.dispose(),this._colors&&(t.colorsTexture=Ov.CreateColorsTexture(`${t._material.name}-colors-texture`,this._colors,t.colorsSampling,this._scene)),t.setColor(this.color,!0),t.colorsDistributionType=this.colorsDistributionType,t.colorsSampling=this.colorsSampling,t.colorMode=this.colorMode,t.useColors=this.useColors,t.visibility=this.visibility,t.useDash=this.useDash,t.dashCount=this.dashCount,t.dashRatio=this.dashRatio,t.dashOffset=this.dashOffset,t.width=this.width,t.sizeAttenuation=this.sizeAttenuation,t.resolution=this.resolution,t.markAllDefinesAsDirty()}_isGLSL(e){return 0===e||this._forceGLSL}}wv.GREASED_LINE_MATERIAL_NAME="GreasedLinePluginMaterial",wv.ForceGLSL=!1,(0,a.Y5)(`BABYLON.${wv.GREASED_LINE_MATERIAL_NAME}`,wv);const Fv="GREASED_LINE_USE_OFFSETS";class Bv extends rs{constructor(e,t,r){const s=t.getEngine(),a=s.isWebGPU&&!(r.forceGLSL||Bv.ForceGLSL),l=["COLOR_DISTRIBUTION_TYPE_LINE 1.","COLOR_DISTRIBUTION_TYPE_SEGMENT 0.","COLOR_MODE_SET 0.","COLOR_MODE_ADD 1.","COLOR_MODE_MULTIPLY 2."];t.useRightHandedSystem&&l.push("GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM");const h=["position","grl_widths","grl_offsets","grl_colorPointers"];r.cameraFacing?(l.push("GREASED_LINE_CAMERA_FACING"),h.push("grl_previousAndSide","grl_nextAndCounters")):(h.push("grl_slopes"),h.push("grl_counters"));const c=["grlColorsWidth","grlUseColors","grlWidth","grlColor","grl_colorModeAndColorDistributionType","grlResolution","grlAspect","grlAizeAttenuation","grlDashArray","grlDashOffset","grlDashRatio","grlUseDash","grlVisibility","grlColors"];if(a||c.push("world","viewProjection","view","projection"),super(e,t,{vertex:"greasedLine",fragment:"greasedLine"},{uniformBuffers:a?["Scene","Mesh"]:void 0,attributes:h,uniforms:c,samplers:a?[]:["grlColors"],defines:l,extraInitializationsAsync:async()=>{a?await Promise.all([Promise.resolve().then(i.bind(i,68547)),Promise.resolve().then(i.bind(i,19145))]):await Promise.all([Promise.resolve().then(i.bind(i,26892)),Promise.resolve().then(i.bind(i,84710))])},shaderLanguage:a?1:0}),this._color=o.v9.White(),this._colorsDistributionType=0,this._colorsTexture=null,r=r||{color:Dv.DEFAULT_COLOR},this.visibility=r.visibility??1,this.useDash=r.useDash??!1,this.dashRatio=r.dashRatio??.5,this.dashOffset=r.dashOffset??0,this.dashCount=r.dashCount??1,this.width=r.width?r.width:r.sizeAttenuation&&r.cameraFacing?Dv.DEFAULT_WIDTH_ATTENUATED:Dv.DEFAULT_WIDTH,this.sizeAttenuation=r.sizeAttenuation??!1,this.color=r.color??o.v9.White(),this.useColors=r.useColors??!1,this.colorsDistributionType=r.colorDistributionType??0,this.colorsSampling=r.colorsSampling??He.I.NEAREST_NEAREST,this.colorMode=r.colorMode??0,this._colors=r.colors??null,this._cameraFacing=r.cameraFacing??!0,this.resolution=r.resolution??new n.I9(s.getRenderWidth(),s.getRenderHeight()),r.colorsTexture?this.colorsTexture=r.colorsTexture:this.colorsTexture=Ov.PrepareEmptyColorsTexture(t),this._colors&&this.useColors&&(this.colorsTexture=Ov.CreateColorsTexture(`${this.name}-colors-texture`,this._colors,this.colorsSampling,t)),a){const e=new jf.u;e.setParameters(),e.samplingMode=this.colorsSampling,this.setTextureSampler("grlColorsSampler",e)}s.onDisposeObservable.add((()=>{Ov.DisposeEmptyColorsTexture()}))}dispose(){this._colorsTexture?.dispose(),super.dispose()}_setColorModeAndColorDistributionType(){this.setVector2("grl_colorModeAndColorDistributionType",new n.I9(this._colorMode,this._colorsDistributionType))}updateLazy(){this._colors&&this.setColors(this._colors,!1,!0)}get colors(){return this._colors}set colors(e){this.setColors(e)}setColors(e,t=!1,i=!1){const r=this._colors?.length??0;if(this._colors=e,null!==e&&0!==e.length){if(!t||i)if(this._colorsTexture&&r===e.length&&!i){const t=Ov.Color3toRGBAUint8(e);this._colorsTexture.update(t)}else this._colorsTexture?.dispose(),this.colorsTexture=Ov.CreateColorsTexture(`${this.name}-colors-texture`,e,this.colorsSampling,this.getScene())}else this._colorsTexture?.dispose()}get colorsTexture(){return this._colorsTexture??null}set colorsTexture(e){this._colorsTexture=e,this.setFloat("grlColorsWidth",this._colorsTexture.getSize().width),this.setTexture("grlColors",this._colorsTexture)}get width(){return this._width}set width(e){this._width=e,this.setFloat("grlWidth",e)}get useColors(){return this._useColors}set useColors(e){this._useColors=e,this.setFloat("grlUseColors",Ov.BooleanToNumber(e))}get colorsSampling(){return this._colorsSampling}set colorsSampling(e){this._colorsSampling=e}get visibility(){return this._visibility}set visibility(e){this._visibility=e,this.setFloat("grlVisibility",e)}get useDash(){return this._useDash}set useDash(e){this._useDash=e,this.setFloat("grlUseDash",Ov.BooleanToNumber(e))}get dashOffset(){return this._dashOffset}set dashOffset(e){this._dashOffset=e,this.setFloat("grlDashOffset",e)}get dashRatio(){return this._dashRatio}set dashRatio(e){this._dashRatio=e,this.setFloat("grlDashRatio",e)}get dashCount(){return this._dashCount}set dashCount(e){this._dashCount=e,this._dashArray=1/e,this.setFloat("grlDashArray",this._dashArray)}get sizeAttenuation(){return this._sizeAttenuation}set sizeAttenuation(e){this._sizeAttenuation=e,this.setFloat("grlSizeAttenuation",Ov.BooleanToNumber(e))}get color(){return this._color}set color(e){this.setColor(e)}setColor(e){e=e??Dv.DEFAULT_COLOR,this._color=e,this.setColor3("grlColor",e)}get colorsDistributionType(){return this._colorsDistributionType}set colorsDistributionType(e){this._colorsDistributionType=e,this._setColorModeAndColorDistributionType()}get colorMode(){return this._colorMode}set colorMode(e){this._colorMode=e,this._setColorModeAndColorDistributionType()}get resolution(){return this._resolution}set resolution(e){this._resolution=e,this.setVector2("grlResolution",e),this.setFloat("grlAspect",e.x/e.y)}serialize(){const e=super.serialize(),t={colorDistributionType:this._colorsDistributionType,colorsSampling:this._colorsSampling,colorMode:this._colorMode,color:this._color,dashCount:this._dashCount,dashOffset:this._dashOffset,dashRatio:this._dashRatio,resolution:this._resolution,sizeAttenuation:this._sizeAttenuation,useColors:this._useColors,useDash:this._useDash,visibility:this._visibility,width:this._width,cameraFacing:this._cameraFacing};return this._colors&&(t.colors=this._colors),e.greasedLineMaterialOptions=t,e}parse(e,t,i){const r=e.greasedLineMaterialOptions;this._colorsTexture?.dispose(),r.color&&(this.color=r.color),r.colorDistributionType&&(this.colorsDistributionType=r.colorDistributionType),r.colorsSampling&&(this.colorsSampling=r.colorsSampling),r.colorMode&&(this.colorMode=r.colorMode),r.useColors&&(this.useColors=r.useColors),r.visibility&&(this.visibility=r.visibility),r.useDash&&(this.useDash=r.useDash),r.dashCount&&(this.dashCount=r.dashCount),r.dashRatio&&(this.dashRatio=r.dashRatio),r.dashOffset&&(this.dashOffset=r.dashOffset),r.width&&(this.width=r.width),r.sizeAttenuation&&(this.sizeAttenuation=r.sizeAttenuation),r.resolution&&(this.resolution=r.resolution),r.colors?this.colorsTexture=Ov.CreateColorsTexture(`${this.name}-colors-texture`,r.colors,this.colorsSampling,this.getScene()):this.colorsTexture=Ov.PrepareEmptyColorsTexture(t),this._cameraFacing=r.cameraFacing??!0,this.setDefine("GREASED_LINE_CAMERA_FACING",this._cameraFacing)}}var Vv,Lv,kv;Bv.ForceGLSL=!1,function(e){e[e.MATERIAL_TYPE_STANDARD=0]="MATERIAL_TYPE_STANDARD",e[e.MATERIAL_TYPE_PBR=1]="MATERIAL_TYPE_PBR",e[e.MATERIAL_TYPE_SIMPLE=2]="MATERIAL_TYPE_SIMPLE"}(Vv||(Vv={})),function(e){e[e.COLOR_MODE_SET=0]="COLOR_MODE_SET",e[e.COLOR_MODE_ADD=1]="COLOR_MODE_ADD",e[e.COLOR_MODE_MULTIPLY=2]="COLOR_MODE_MULTIPLY"}(Lv||(Lv={})),function(e){e[e.COLOR_DISTRIBUTION_TYPE_SEGMENT=0]="COLOR_DISTRIBUTION_TYPE_SEGMENT",e[e.COLOR_DISTRIBUTION_TYPE_LINE=1]="COLOR_DISTRIBUTION_TYPE_LINE"}(kv||(kv={}));const Gv=[new ku.v9(.98,.26,.38),new ku.v9(.47,.75,.3),new ku.v9(0,.26,.77),new ku.v9(.97,.6,.76),new ku.v9(.19,.63,.78),new ku.v9(.98,.8,.6),new ku.v9(.65,.43,.15),new ku.v9(.15,.47,.22),new ku.v9(.67,.71,.86),new ku.v9(.09,.46,.56),new ku.v9(.8,.98,.02),new ku.v9(.39,.29,.13),new ku.v9(.53,.63,.06),new ku.v9(.95,.96,.41),new ku.v9(1,.72,.94),new ku.v9(.63,.08,.31),new ku.v9(.66,.96,.95),new ku.v9(.22,.14,.19),new ku.v9(.14,.65,.59),new ku.v9(.93,1,.68),new ku.v9(.93,.14,.44),new ku.v9(.47,.86,.67),new ku.v9(.85,.07,.78),new ku.v9(.53,.64,.98),new ku.v9(.43,.37,.56),new ku.v9(.71,.65,.25),new ku.v9(.66,.19,.01),new ku.v9(.94,.53,.12),new ku.v9(.41,.44,.44),new ku.v9(.24,.71,.96),new ku.v9(.57,.28,.56),new ku.v9(.44,.98,.42)];var zv;!function(e){e[e.NONE=0]="NONE",e[e.TRIANGLES=1]="TRIANGLES",e[e.VERTICES=2]="VERTICES",e[e.TRIANGLES_VERTICES=3]="TRIANGLES_VERTICES",e[e.UV0=4]="UV0",e[e.UV1=5]="UV1",e[e.VERTEXCOLORS=6]="VERTEXCOLORS",e[e.MATERIALIDS=7]="MATERIALIDS"}(zv||(zv={}));class Uv extends Hu.M{constructor(){super(...arguments),this.DBG_MODE=0,this.DBG_MULTIPLY=!0,this.DBG_ENABLED=!0}}class Wv extends vv.y{_markAllDefinesAsDirty(){this._enable(this._isEnabled),this.markAllDefinesAsDirty()}isCompatible(e){switch(e){case 0:case 1:return!0;default:return!1}}constructor(e,t={}){const i=new Uv;i.DBG_MODE=t.mode??i.DBG_MODE,i.DBG_MULTIPLY=t.multiply??i.DBG_MULTIPLY,super(e,"MeshDebug",200,i,!0,!0),this._mode=i.DBG_MODE,this._multiply=i.DBG_MULTIPLY,this.shadedDiffuseColor=t.shadedDiffuseColor??new ku.v9(1,1,1),this.shadedSpecularColor=t.shadedSpecularColor??new ku.v9(.8,.8,.8),this.shadedSpecularPower=t.shadedSpecularPower??10,this.wireframeThickness=t.wireframeThickness??.7,this.wireframeTrianglesColor=t.wireframeTrianglesColor??new ku.v9(0,0,0),this.wireframeVerticesColor=t.wireframeVerticesColor??new ku.v9(.8,.8,.8),this.vertexColor=t.vertexColor??new ku.v9(0,0,0),this.vertexRadius=t.vertexRadius??1.2,this.uvScale=t.uvScale??20,this.uvPrimaryColor=t.uvPrimaryColor??new ku.v9(1,1,1),this.uvSecondaryColor=t.uvSecondaryColor??new ku.v9(.5,.5,.5),this._materialColor=Wv.MaterialColors[Wv._PluginCount++%Wv.MaterialColors.length],this.isEnabled=!0}getClassName(){return"MeshDebugPluginMaterial"}get isEnabled(){return this._isEnabled}set isEnabled(e){if(this._isEnabled!==e){if(!this._material.getScene().getEngine().isWebGPU&&1==this._material.getScene().getEngine().version)return m.V.Error("MeshDebugPluginMaterial is not supported on WebGL 1.0."),void(this._isEnabled=!1);this._isEnabled=e,this._markAllDefinesAsDirty()}}prepareDefines(e,t,i){2!=this._mode&&1!=this._mode&&3!=this._mode||i.isVerticesDataPresent("dbg_initialPass")||m.V.Warn("For best results with TRIANGLES, TRIANGLES_VERTICES, or VERTICES modes, please use MeshDebugPluginMaterial.PrepareMeshForTrianglesAndVerticesMode() on mesh.",1),e.DBG_MODE=this._mode,e.DBG_MULTIPLY=this._multiply,e.DBG_ENABLED=this._isEnabled}getAttributes(e){e.push("dbg_initialPass")}getUniforms(e=0){return{ubo:[{name:"dbg_shadedDiffuseColor",size:3,type:"vec3"},{name:"dbg_shadedSpecularColorPower",size:4,type:"vec4"},{name:"dbg_thicknessRadiusScale",size:3,type:"vec3"},{name:"dbg_wireframeTrianglesColor",size:3,type:"vec3"},{name:"dbg_wireframeVerticesColor",size:3,type:"vec3"},{name:"dbg_vertexColor",size:3,type:"vec3"},{name:"dbg_uvPrimaryColor",size:3,type:"vec3"},{name:"dbg_uvSecondaryColor",size:3,type:"vec3"},{name:"dbg_materialColor",size:3,type:"vec3"}],fragment:0===e?"#if defined(DBG_ENABLED)\nuniform vec3 dbg_shadedDiffuseColor;\nuniform vec4 dbg_shadedSpecularColorPower;\nuniform vec3 dbg_thicknessRadiusScale;\n\n#if DBG_MODE == 2 || DBG_MODE == 3\n    uniform vec3 dbg_vertexColor;\n#endif\n\n#if DBG_MODE == 1\n    uniform vec3 dbg_wireframeTrianglesColor;\n#elif DBG_MODE == 3\n    uniform vec3 dbg_wireframeVerticesColor;\n#elif DBG_MODE == 4 || DBG_MODE == 5\n    uniform vec3 dbg_uvPrimaryColor;\n    uniform vec3 dbg_uvSecondaryColor;\n#elif DBG_MODE == 7\n    uniform vec3 dbg_materialColor;\n#endif\n#endif":"#if defined(DBG_ENABLED)\nuniform dbg_shadedDiffuseColor: vec3f;\nuniform dbg_shadedSpecularColorPower: vec4f;\nuniform dbg_thicknessRadiusScale: vec3f;\n\n#if DBG_MODE == 2 || DBG_MODE == 3\n    uniform dbg_vertexColor: vec3f;\n#endif\n\n#if DBG_MODE == 1\n    uniform dbg_wireframeTrianglesColor: vec3f;\n#elif DBG_MODE == 3\n    uniform  dbg_wireframeVerticesColor: vec3f;\n#elif DBG_MODE == 4 || DBG_MODE == 5\n    uniform dbg_uvPrimaryColor: vec3f;\n    uniform dbg_uvSecondaryColor: vec3f;\n#elif DBG_MODE == 7\n    uniform dbg_materialColor: vec3f;\n#endif\n#endif"}}bindForSubMesh(e){this._isEnabled&&(e.updateFloat3("dbg_shadedDiffuseColor",this.shadedDiffuseColor.r,this.shadedDiffuseColor.g,this.shadedDiffuseColor.b),e.updateFloat4("dbg_shadedSpecularColorPower",this.shadedSpecularColor.r,this.shadedSpecularColor.g,this.shadedSpecularColor.b,this.shadedSpecularPower),e.updateFloat3("dbg_thicknessRadiusScale",this.wireframeThickness,this.vertexRadius,this.uvScale),e.updateColor3("dbg_wireframeTrianglesColor",this.wireframeTrianglesColor),e.updateColor3("dbg_wireframeVerticesColor",this.wireframeVerticesColor),e.updateColor3("dbg_vertexColor",this.vertexColor),e.updateColor3("dbg_uvPrimaryColor",this.uvPrimaryColor),e.updateColor3("dbg_uvSecondaryColor",this.uvSecondaryColor),e.updateColor3("dbg_materialColor",this._materialColor))}getCustomCode(e,t=0){return 1===t?"vertex"===e?{CUSTOM_VERTEX_DEFINITIONS:"#if defined(DBG_ENABLED)\nattribute dbg_initialPass: f32;\nvarying dbg_vBarycentric: vec3f;\nvarying dbg_vVertexWorldPos: vec3f;\nvarying dbg_vPass: f32;\n#endif",CUSTOM_VERTEX_MAIN_END:"#if defined(DBG_ENABLED)\nvar dbg_vertexIndex = f32(input.vertexIndex) % 3.;\nif (dbg_vertexIndex == 0.0) { \n    vertexOutputs.dbg_vBarycentric = vec3f(1.,0.,0.); \n}\nelse if (dbg_vertexIndex == 1.0) { \n    vertexOutputs.dbg_vBarycentric = vec3f(0.,1.,0.); \n}\nelse { \n    vertexOutputs.dbg_vBarycentric = vec3f(0.,0.,1.); \n}\n\nvertexOutputs.dbg_vVertexWorldPos = vertexOutputs.vPositionW;\nvertexOutputs.dbg_vPass = input.dbg_initialPass;\n#endif"}:{CUSTOM_FRAGMENT_DEFINITIONS:"#if defined(DBG_ENABLED)\nvarying dbg_vBarycentric: vec3f;\nvarying dbg_vVertexWorldPos: vec3f;\nvarying dbg_vPass: f32;\n\n#if !defined(DBG_MULTIPLY)\n    fn dbg_applyShading(color: vec3f) -> vec3f {\n        var N = fragmentInputs.vNormalW.xyz;\n        var L = normalize(scene.vEyePosition.xyz - fragmentInputs.vPositionW.xyz);\n        var H = normalize(L + L);\n        var LdotN = clamp(dot(L,N), 0., 1.);\n        var HdotN = clamp(dot(H,N), 0., 1.);\n        var specTerm = pow(HdotN, uniforms.dbg_shadedSpecularColorPower.w);\n        var result = color * (LdotN / PI);\n        result += uniforms.dbg_shadedSpecularColorPower.rgb * (specTerm / PI);\n        return result;\n    }\n#endif\n\n#if DBG_MODE == 1 || DBG_MODE == 3\n    fn dbg_edgeFactor() -> f32 {\n        var d = fwidth(fragmentInputs.dbg_vBarycentric);\n        var a3 = smoothstep(vec3f(0.), d * uniforms.dbg_thicknessRadiusScale.x, fragmentInputs.dbg_vBarycentric);\n        return min(min(a3.x, a3.y), a3.z);\n    }\n#endif\n\n#if DBG_MODE == 2 || DBG_MODE == 3\n    fn dbg_cornerFactor() -> f32 {\n        var worldPos = fragmentInputs.vPositionW;\n        float dist = length(worldPos - fragmentInputs.dbg_vVertexWorldPos);\n        float camDist = length(worldPos - scene.vEyePosition.xyz);\n        float d = sqrt(camDist) * .001;\n        return smoothstep((uniforms.dbg_thicknessRadiusScale.y * d), ((uniforms.dbg_thicknessRadiusScale.y * 1.01) * d), dist);\n    }\n#endif\n\n#if (DBG_MODE == 4 && defined(UV1)) || (DBG_MODE == 5 && defined(UV2))\n    fn dbg_checkerboardFactor(uv: vec2f) -> f32 {\n        var f = fract(uv * uniforms.dbg_thicknessRadiusScale.z);\n        f -= .5;\n        return (f.x * f.y) > 0. ? 1. : 0.;\n    }\n#endif\n#endif",CUSTOM_FRAGMENT_MAIN_END:"#if defined(DBG_ENABLED)\nvar dbg_color = vec3f(1.);\n#if DBG_MODE == 1\n    dbg_color = mix(uniforms.dbg_wireframeTrianglesColor, vec3f(1.), dbg_edgeFactor());\n#elif DBG_MODE == 2 || DBG_MODE == 3\n    var dbg_cornerFactor = dbg_cornerFactor();\n    if (fragmentInputs.dbg_vPass == 0. && dbg_cornerFactor == 1.) discard;\n    dbg_color = mix(uniforms.dbg_vertexColor, vec3(1.), dbg_cornerFactor);\n    #if DBG_MODE == 3\n        dbg_color *= mix(uniforms.dbg_wireframeVerticesColor, vec3f(1.), dbg_edgeFactor());\n    #endif\n#elif DBG_MODE == 4 && defined(MAINUV1)\n    dbg_color = mix(uniforms.dbg_uvPrimaryColor, uniforms.dbg_uvSecondaryColor, dbg_checkerboardFactor(fragmentInputs.vMainUV1));\n#elif DBG_MODE == 5 && defined(MAINUV2)\n    dbg_color = mix(uniforms.dbg_uvPrimaryColor, uniforms.dbg_uvSecondaryColor, dbg_checkerboardFactor(fragmentInputs.vMainUV2));\n#elif DBG_MODE == 6 && defined(VERTEXCOLOR)\n    dbg_color = fragmentInputs.vColor.rgb;\n#elif DBG_MODE == 7\n    dbg_color = uniforms.dbg_materialColor;\n#endif\n\n#if defined(DBG_MULTIPLY)\n    fragmentOutputs.color *= vec4f(dbg_color, 1.);\n#else\n    #if DBG_MODE != 6\n        fragmentOutputs.color = vec4f(dbg_applyShading(dbg_shadedDiffuseColor) * dbg_color, 1.);\n    #else\n        fragmentOutputs.color = vec4f(dbg_color, 1.);\n    #endif\n#endif\n#endif"}:"vertex"===e?{CUSTOM_VERTEX_DEFINITIONS:"#if defined(DBG_ENABLED)\nattribute float dbg_initialPass;\nvarying vec3 dbg_vBarycentric;\nflat varying vec3 dbg_vVertexWorldPos;\nflat varying float dbg_vPass;\n#endif",CUSTOM_VERTEX_MAIN_END:"#if defined(DBG_ENABLED)\nfloat dbg_vertexIndex = mod(float(gl_VertexID), 3.);\nif (dbg_vertexIndex == 0.0) { \n    dbg_vBarycentric = vec3(1.,0.,0.); \n}\nelse if (dbg_vertexIndex == 1.0) { \n    dbg_vBarycentric = vec3(0.,1.,0.); \n}\nelse { \n    dbg_vBarycentric = vec3(0.,0.,1.); \n}\n\ndbg_vVertexWorldPos = vPositionW;\ndbg_vPass = dbg_initialPass;\n#endif"}:{CUSTOM_FRAGMENT_DEFINITIONS:"#if defined(DBG_ENABLED)\nvarying vec3 dbg_vBarycentric;\nflat varying vec3 dbg_vVertexWorldPos;\nflat varying float dbg_vPass;\n\n#if !defined(DBG_MULTIPLY)\n    vec3 dbg_applyShading(vec3 color) {\n        vec3 N = vNormalW.xyz;\n        vec3 L = normalize(vEyePosition.xyz - vPositionW.xyz);\n        vec3 H = normalize(L + L);\n        float LdotN = clamp(dot(L,N), 0., 1.);\n        float HdotN = clamp(dot(H,N), 0., 1.);\n        float specTerm = pow(HdotN, dbg_shadedSpecularColorPower.w);\n        color *= (LdotN / PI);\n        color += dbg_shadedSpecularColorPower.rgb * (specTerm / PI);\n        return color;\n    }\n#endif\n\n#if DBG_MODE == 1 || DBG_MODE == 3\n    float dbg_edgeFactor() {\n        vec3 d = fwidth(dbg_vBarycentric);\n        vec3 a3 = smoothstep(vec3(0.), d * dbg_thicknessRadiusScale.x, dbg_vBarycentric);\n        return min(min(a3.x, a3.y), a3.z);\n    }\n#endif\n\n#if DBG_MODE == 2 || DBG_MODE == 3\n    float dbg_cornerFactor() {\n        vec3 worldPos = vPositionW;\n        float dist = length(worldPos - dbg_vVertexWorldPos);\n        float camDist = length(worldPos - vEyePosition.xyz);\n        float d = sqrt(camDist) * .001;\n        return smoothstep((dbg_thicknessRadiusScale.y * d), ((dbg_thicknessRadiusScale.y * 1.01) * d), dist);\n    }\n#endif\n\n#if (DBG_MODE == 4 && defined(UV1)) || (DBG_MODE == 5 && defined(UV2))\n    float dbg_checkerboardFactor(vec2 uv) {\n        vec2 f = fract(uv * dbg_thicknessRadiusScale.z);\n        f -= .5;\n        return (f.x * f.y) > 0. ? 1. : 0.;\n    }\n#endif\n#endif",CUSTOM_FRAGMENT_MAIN_END:"#if defined(DBG_ENABLED)\nvec3 dbg_color = vec3(1.);\n#if DBG_MODE == 1\n    dbg_color = mix(dbg_wireframeTrianglesColor, vec3(1.), dbg_edgeFactor());\n#elif DBG_MODE == 2 || DBG_MODE == 3\n    float dbg_cornerFactor = dbg_cornerFactor();\n    if (dbg_vPass == 0. && dbg_cornerFactor == 1.) discard;\n    dbg_color = mix(dbg_vertexColor, vec3(1.), dbg_cornerFactor);\n    #if DBG_MODE == 3\n        dbg_color *= mix(dbg_wireframeVerticesColor, vec3(1.), dbg_edgeFactor());\n    #endif\n#elif DBG_MODE == 4 && defined(MAINUV1)\n    dbg_color = mix(dbg_uvPrimaryColor, dbg_uvSecondaryColor, dbg_checkerboardFactor(vMainUV1));\n#elif DBG_MODE == 5 && defined(MAINUV2)\n    dbg_color = mix(dbg_uvPrimaryColor, dbg_uvSecondaryColor, dbg_checkerboardFactor(vMainUV2));\n#elif DBG_MODE == 6 && defined(VERTEXCOLOR)\n    dbg_color = vColor.rgb;\n#elif DBG_MODE == 7\n    dbg_color = dbg_materialColor;\n#endif\n\n#if defined(DBG_MULTIPLY)\n    gl_FragColor *= vec4(dbg_color, 1.);\n#else\n    #if DBG_MODE != 6\n        gl_FragColor = vec4(dbg_applyShading(dbg_shadedDiffuseColor) * dbg_color, 1.);\n    #else\n        gl_FragColor = vec4(dbg_color, 1.);\n    #endif\n#endif\n#endif"}}static Reset(){this._PluginCount=0,this.MaterialColors=Gv}static PrepareMeshForTrianglesAndVerticesMode(e,t=!1){let i=()=>{};if(0==e.getTotalIndices())return i;if(t){const t=e.getVerticesDataKinds(),r=e.getIndices(),s={};for(const i of t)s[i]=e.getVerticesData(i);i=function(){e.setIndices(r);for(const i of t){const t=e.getVertexBuffer(i).getStrideSize();e.setVerticesData(i,s[i],void 0,t)}e.removeVerticesData("dbg_initialPass")}}let r=Array.from(e.getIndices());const s=[];for(let e=0;e<r.length;e+=3)s.push(r[e+1],r[e+2],r[e+0]);e.setIndices(r.concat(s)),e.convertToUnIndexedMesh(),e.isUnIndexed=!1,r=Array.from(e.getIndices());const n=[];for(let e=r.length/2;e<r.length;e+=3)n.push(r[e+1],r[e+2],r[e+0]);e.setIndices(r.concat(n));const o=e.getTotalVertices(),a=o/2,l=new Array(o).fill(1,0,a).fill(0,a,o);return e.setVerticesData("dbg_initialPass",l,!1,1),i}}Wv._PluginCount=0,Wv.MaterialColors=Gv,(0,Ge.Cg)([(0,ze.jT)()],Wv.prototype,"_materialColor",void 0),(0,Ge.Cg)([(0,ze.lK)()],Wv.prototype,"_isEnabled",void 0),(0,Ge.Cg)([(0,ze.lK)(),(0,ze.$z)("_markAllDefinesAsDirty")],Wv.prototype,"mode",void 0),(0,Ge.Cg)([(0,ze.lK)(),(0,ze.$z)("_markAllDefinesAsDirty")],Wv.prototype,"multiply",void 0),(0,Ge.Cg)([(0,ze.jT)()],Wv.prototype,"shadedDiffuseColor",void 0),(0,Ge.Cg)([(0,ze.jT)()],Wv.prototype,"shadedSpecularColor",void 0),(0,Ge.Cg)([(0,ze.lK)()],Wv.prototype,"shadedSpecularPower",void 0),(0,Ge.Cg)([(0,ze.lK)()],Wv.prototype,"wireframeThickness",void 0),(0,Ge.Cg)([(0,ze.jT)()],Wv.prototype,"wireframeTrianglesColor",void 0),(0,Ge.Cg)([(0,ze.jT)()],Wv.prototype,"wireframeVerticesColor",void 0),(0,Ge.Cg)([(0,ze.jT)()],Wv.prototype,"vertexColor",void 0),(0,Ge.Cg)([(0,ze.lK)()],Wv.prototype,"vertexRadius",void 0),(0,Ge.Cg)([(0,ze.lK)()],Wv.prototype,"uvScale",void 0),(0,Ge.Cg)([(0,ze.jT)()],Wv.prototype,"uvPrimaryColor",void 0),(0,Ge.Cg)([(0,ze.jT)()],Wv.prototype,"uvSecondaryColor",void 0),(0,a.Y5)("BABYLON.MeshDebugPluginMaterial",Wv),Object.defineProperty(br.F.prototype,"decalMap",{get:function(){if(!this._decalMap){if(this._uniformBufferLayoutBuilt)return null;this._decalMap=new Pv(this)}return this._decalMap},enumerable:!0,configurable:!0}),Object.defineProperty(sf.d.prototype,"decalMap",{get:function(){if(!this._decalMap){if(this._uniformBufferLayoutBuilt)return null;this._decalMap=new Pv(this)}return this._decalMap},enumerable:!0,configurable:!0}),Object.defineProperty(Ps.u.prototype,"decalMap",{get:function(){return this._decalMap},set:function(e){this._decalMap=e},enumerable:!0,configurable:!0});var Hv=i(42319),$v=i(14268),qv=i(45791),Yv=i(59235),Xv=i(84710),jv=i(26892),Zv=i(19145),Qv=i(68547),Kv=i(62128),Jv=i(71139);class eS{constructor(e,t){this.radius=e,this.theta=t,this.radius=e,this.theta=t}getClassName(){return"Polar"}toString(){return JSON.stringify(this)}asArray(){return[this.radius,this.theta]}addToRef(e,t){return t.radius=this.radius+e.radius,t.theta=this.theta+e.theta,t}add(e){const t=new eS(0,0);return this.addToRef(e,t),t}addInPlace(e){return this.addToRef(e,this),this}addInPlaceFromFloats(e,t){return this.radius+=e,this.theta+=t,this}subtractToRef(e,t){return t.radius=this.radius-e.radius,t.theta=this.theta-e.theta,t}subtract(e){const t=new eS(0,0);return this.subtractToRef(e,t),t}subtractInPlace(e){return this.subtractToRef(e,this),this}subtractFromFloatsToRef(e,t,i){return i.radius=this.radius-e,i.theta=this.theta-t,i}subtractFromFloats(e,t){const i=new eS(0,0);return this.subtractFromFloatsToRef(e,t,i),i}multiplyToRef(e,t){return t.radius=this.radius*e.radius,t.theta=this.theta*e.theta,t}multiply(e){const t=new eS(0,0);return this.multiplyToRef(e,t),t}multiplyInPlace(e){return this.multiplyToRef(e,this),this}divideToRef(e,t){return t.radius=this.radius/e.radius,t.theta=this.theta/e.theta,t}divide(e){const t=new eS(0,0);return this.divideToRef(e,t),t}divideInPlace(e){return this.divideToRef(e,this),this}clone(){return new eS(this.radius,this.theta)}copyFrom(e){return this.radius=e.radius,this.theta=e.theta,this}copyFromFloats(e,t){return this.radius=e,this.theta=t,this}scaleToRef(e,t){return t.radius=this.radius*e,t.theta=this.theta*e,t}scale(e){const t=new eS(0,0);return this.scaleToRef(e,t),t}scaleInPlace(e){return this.scaleToRef(e,this),this}set(e,t){return this.radius=e,this.theta=t,this}setAll(e){return this.set(e,e),this}toVector2ToRef(e){const t=this.radius*Math.cos(this.theta),i=this.radius*Math.sin(this.theta);return e.set(t,i),e}toVector2(){const e=new n.I9(0,0);return this.toVector2ToRef(e)}static FromVector2ToRef(e,t){const i=Math.sign(e.y)*Math.acos(e.x/e.length());return t.radius=e.length(),t.theta=i,t}static FromVector2(e){const t=new eS(0,0);return eS.FromVector2ToRef(e,t),t}static FromArray(e){return new eS(e[0],e[1])}}class tS{constructor(e,t,i){this.radius=e,this.theta=t,this.phi=i,this.radius=e,this.theta=t,this.phi=i}getClassName(){return"Spherical"}toString(){return JSON.stringify(this)}asArray(){return[this.radius,this.theta,this.phi]}addToRef(e,t){return t.radius=this.radius+e.radius,t.theta=this.theta+e.theta,t.phi=this.phi+e.phi,t}add(e){const t=new tS(0,0,0);return this.addToRef(e,t),t}addInPlace(e){return this.addToRef(e,this),this}addInPlaceFromFloats(e,t,i){return this.radius+=e,this.theta+=t,this.phi+=i,this}subtractToRef(e,t){return t.radius=this.radius-e.radius,t.theta=this.theta-e.theta,t.phi=this.phi-e.phi,t}subtract(e){const t=new tS(0,0,0);return this.subtractToRef(e,t),t}subtractInPlace(e){return this.subtractToRef(e,this),this}subtractFromFloatsToRef(e,t,i,r){return r.radius=this.radius-e,r.theta=this.theta-t,r.phi=this.phi-i,r}subtractFromFloats(e,t,i){const r=new tS(0,0,0);return this.subtractFromFloatsToRef(e,t,i,r),r}multiplyToRef(e,t){return t.radius=this.radius*e.radius,t.theta=this.theta*e.theta,t.phi=this.phi*e.phi,t}multiply(e){const t=new tS(0,0,0);return this.multiplyToRef(e,t),t}multiplyInPlace(e){return this.multiplyToRef(e,this),this}divideToRef(e,t){return t.radius=this.radius/e.radius,t.theta=this.theta/e.theta,t.phi=this.phi/e.phi,t}divide(e){const t=new tS(0,0,0);return this.divideToRef(e,t),t}divideInPlace(e){return this.divideToRef(e,this),this}clone(){return new tS(this.radius,this.theta,this.phi)}copyFrom(e){return this.radius=e.radius,this.theta=e.theta,this.phi=e.phi,this}copyFromFloats(e,t,i){return this.radius=e,this.theta=t,this.phi=i,this}scaleToRef(e,t){return t.radius=this.radius*e,t.theta=this.theta*e,t.phi=this.phi*e,t}scale(e){const t=new tS(0,0,0);return this.scaleToRef(e,t),t}scaleInPlace(e){return this.scaleToRef(e,this),this}set(e,t,i){return this.radius=e,this.theta=t,this.phi=i,this}setAll(e){return this.set(e,e,e),this}toVector3ToRef(e){const t=this.radius*Math.sin(this.theta)*Math.cos(this.phi),i=this.radius*Math.cos(this.theta),r=this.radius*Math.sin(this.theta)*Math.sin(this.phi);return e.set(t,i,r),e}toVector3(){const e=new n.Pq(0,0,0);return this.toVector3ToRef(e)}static FromVector3ToRef(e,t){return t.radius=e.length(),t.theta=Math.acos(e.y/t.radius),t.phi=Math.atan2(e.z,e.x),t}static FromVector3(e){const t=new tS(0,0,0);return tS.FromVector3ToRef(e,t),t}static FromArray(e){return new tS(e[0],e[1],e[2])}}var iS=i(77517);function rS(e,t){return`{X: ${e.x.toFixed(t)} Y: ${e.y.toFixed(t)}}`}function sS(e,t){return`{X: ${e._x.toFixed(t)} Y: ${e._y.toFixed(t)} Z: ${e._z.toFixed(t)}}`}function nS(e,t){return`{X: ${e.x.toFixed(t)} Y: ${e.y.toFixed(t)} Z: ${e.z.toFixed(t)} W: ${e.w.toFixed(t)}}`}var oS=i(85456),aS=i(85442),lS=i(87728);class hS{static get Configuration(){return{get decoder(){return lS.Y.DefaultConfiguration},set decoder(e){lS.Y.DefaultConfiguration=e}}}static set Configuration(e){lS.Y.DefaultConfiguration=e.decoder}static get DecoderAvailable(){return(0,aS.$Y)(lS.Y.DefaultConfiguration)}static get Default(){return hS._Default??(hS._Default=new hS),hS._Default}static ResetDefault(e){hS._Default&&(e||hS._Default.dispose(),hS._Default=null)}constructor(e=hS.DefaultNumWorkers){const t="number"==typeof e?{...lS.Y.DefaultConfiguration,numWorkers:e}:{...lS.Y.DefaultConfiguration,...e};this._decoder=new lS.Y(t)}dispose(){this._decoder.dispose()}async whenReadyAsync(){return this._decoder.whenReadyAsync()}decodeMeshToMeshDataAsync(e,t,i){return this._decoder.decodeMeshToMeshDataAsync(e,t,i)}async decodeMeshToGeometryAsync(e,t,i,r){return this._decoder.decodeMeshToGeometryAsync(e,t,i,r)}async _decodeMeshToGeometryForGltfAsync(e,t,i,r,s,n){return this._decoder._decodeMeshToGeometryForGltfAsync(e,t,i,r,s,n)}async decodeMeshAsync(e,t){const i=await this._decoder.decodeMeshToMeshDataAsync(e,t),r=new ot.P;i.indices&&(r.indices=i.indices);for(const e of i.attributes){const t=ss.R.GetFloatData(e.data,e.size,ss.R.GetDataType(e.data),e.byteOffset,e.byteStride,e.normalized,i.totalVertices);r.set(t,e.kind)}return r}}hS.DefaultNumWorkers=(0,aS.E5)(),hS._Default=null;var cS=i(59185),uS=i(85296),dS=i(28853);function pS(e){return e===ss.R.PositionKind?"POSITION":e===ss.R.NormalKind?"NORMAL":e===ss.R.ColorKind?"COLOR":e.startsWith(ss.R.UVKind)?"TEX_COORD":"GENERIC"}const mS={decodeSpeed:5,encodeSpeed:5,method:"MESH_EDGEBREAKER_ENCODING",quantizationBits:{POSITION:14,NORMAL:10,COLOR:8,TEX_COORD:12,GENERIC:12}};class fS extends aS.AA{static get DefaultAvailable(){return(0,aS.$Y)(fS.DefaultConfiguration)}static get Default(){return fS._Default??(fS._Default=new fS),fS._Default}static ResetDefault(e){fS._Default&&(e||fS._Default.dispose(),fS._Default=null)}_isModuleAvailable(){return"undefined"!=typeof DracoEncoderModule}async _createModuleAsync(e,t){return{module:await(t||DracoEncoderModule)({wasmBinary:e})}}_getWorkerContent(){return`${uS.Ct}(${uS.t})()`}constructor(e=fS.DefaultConfiguration){super(e)}async _encodeAsync(e,t,i){const r=i?(0,dS.$)(mS,i):mS;if(this._workerPoolPromise){const i=await this._workerPoolPromise;return new Promise(((s,n)=>{i.push(((i,o)=>{const a=e=>{i.removeEventListener("error",a),i.removeEventListener("message",l),n(e),o()},l=e=>{"encodeMeshDone"===e.data.id&&(i.removeEventListener("error",a),i.removeEventListener("message",l),s(e.data.encodedMeshData),o())};i.addEventListener("error",a),i.addEventListener("message",l);const h=[];e.forEach((e=>{h.push(e.data.buffer)})),t&&h.push(t.buffer),i.postMessage({id:"encodeMesh",attributes:e,indices:t,options:r},h)}))}))}if(this._modulePromise){const i=await this._modulePromise;return(0,uS.Ct)(i.module,e,t,r)}throw new Error("Draco encoder module is not available")}async encodeMeshAsync(e,t){if(0==e.getTotalVertices())throw new Error("Cannot compress geometry with Draco. There are no vertices.");e instanceof tt.e&&e.morphTargetManager&&"MESH_EDGEBREAKER_ENCODING"===t?.method&&(m.V.Warn("Cannot use Draco EDGEBREAKER method with morph targets. Falling back to SEQUENTIAL method."),t.method="MESH_SEQUENTIAL_ENCODING");const i=function(e){let t=e.getIndices(void 0,!0);return!t||t instanceof Uint32Array||t instanceof Uint16Array||(t=((0,Nt.Lm)(t,t.length)?Uint32Array:Uint16Array).from(t)),t}(e),r=function(e,t){const i=[];for(const r of e.getVerticesDataKinds()){if(t?.includes(r)){if(r===ss.R.PositionKind)throw new Error("Cannot exclude position attribute from Draco encoding.");continue}const s=e.getVertexBuffer(r),n=s.getSize(),o=(0,Nt.II)(s.getData(),n,s.type,s.byteOffset,s.byteStride,s.normalized,e.getTotalVertices(),!0);i.push({kind:r,dracoName:pS(r),size:n,data:o})}return i}(e,t?.excludedAttributes);return this._encodeAsync(r,i,t)}}fS.DefaultConfiguration={wasmUrl:`${H.S0._DefaultCdnUrl}/draco_encoder_wasm_wrapper.js`,wasmBinaryUrl:`${H.S0._DefaultCdnUrl}/draco_encoder.wasm`,fallbackUrl:`${H.S0._DefaultCdnUrl}/draco_encoder.js`},fS._Default=null;let _S=0;class gS{constructor(e,t,i,r){this.pos=e,this.normal=t,this.uv=i,this.vertColor=r}clone(){return new gS(this.pos.clone(),this.normal.clone(),this.uv?.clone(),this.vertColor?.clone())}flip(){this.normal=this.normal.scale(-1)}interpolate(e,t){return new gS(n.Pq.Lerp(this.pos,e.pos,t),n.Pq.Lerp(this.normal,e.normal,t),this.uv&&e.uv?n.I9.Lerp(this.uv,e.uv,t):void 0,this.vertColor&&e.vertColor?o.ov.Lerp(this.vertColor,e.vertColor,t):void 0)}}class xS{constructor(e,t){this.normal=e,this.w=t}static FromPoints(e,t,i){const r=i.subtract(e),s=t.subtract(e);if(0===r.lengthSquared()||0===s.lengthSquared())return null;const o=n.Pq.Normalize(n.Pq.Cross(r,s));return new xS(o,n.Pq.Dot(o,e))}clone(){return new xS(this.normal.clone(),this.w)}flip(){this.normal.scaleInPlace(-1),this.w=-this.w}splitPolygon(e,t,i,r,s){let o=0;const a=[];let l,h;for(l=0;l<e.vertices.length;l++){h=n.Pq.Dot(this.normal,e.vertices[l].pos)-this.w;const t=h<-xS.EPSILON?2:h>xS.EPSILON?1:0;o|=t,a.push(t)}switch(o){case 0:(n.Pq.Dot(this.normal,e.plane.normal)>0?t:i).push(e);break;case 1:r.push(e);break;case 2:s.push(e);break;case 3:{const t=[],i=[];for(l=0;l<e.vertices.length;l++){const r=(l+1)%e.vertices.length,s=a[l],o=a[r],c=e.vertices[l],u=e.vertices[r];if(2!==s&&t.push(c),1!==s&&i.push(2!==s?c.clone():c),3==(s|o)){h=(this.w-n.Pq.Dot(this.normal,c.pos))/n.Pq.Dot(this.normal,u.pos.subtract(c.pos));const e=c.interpolate(u,h);t.push(e),i.push(e.clone())}}let o;t.length>=3&&(o=new vS(t,e.shared),o.plane&&r.push(o)),i.length>=3&&(o=new vS(i,e.shared),o.plane&&s.push(o));break}}}}xS.EPSILON=1e-5;class vS{constructor(e,t){this.vertices=e,this.shared=t,this.plane=xS.FromPoints(e[0].pos,e[1].pos,e[2].pos)}clone(){const e=this.vertices.map((e=>e.clone()));return new vS(e,this.shared)}flip(){this.vertices.reverse().map((e=>{e.flip()})),this.plane.flip()}}class SS{constructor(e){this._plane=null,this._front=null,this._back=null,this._polygons=new Array,e&&this.build(e)}clone(){const e=new SS;return e._plane=this._plane&&this._plane.clone(),e._front=this._front&&this._front.clone(),e._back=this._back&&this._back.clone(),e._polygons=this._polygons.map((e=>e.clone())),e}invert(){for(let e=0;e<this._polygons.length;e++)this._polygons[e].flip();this._plane&&this._plane.flip(),this._front&&this._front.invert(),this._back&&this._back.invert();const e=this._front;this._front=this._back,this._back=e}clipPolygons(e){if(!this._plane)return e.slice();let t=[],i=[];for(let r=0;r<e.length;r++)this._plane.splitPolygon(e[r],t,i,t,i);return this._front&&(t=this._front.clipPolygons(t)),i=this._back?this._back.clipPolygons(i):[],t.concat(i)}clipTo(e){this._polygons=e.clipPolygons(this._polygons),this._front&&this._front.clipTo(e),this._back&&this._back.clipTo(e)}allPolygons(){let e=this._polygons.slice();return this._front&&(e=e.concat(this._front.allPolygons())),this._back&&(e=e.concat(this._back.allPolygons())),e}build(e){if(!e.length)return;this._plane||(this._plane=e[0].plane.clone());const t=[],i=[];for(let r=0;r<e.length;r++)this._plane.splitPolygon(e[r],this._polygons,this._polygons,t,i);t.length&&(this._front||(this._front=new SS),this._front.build(t)),i.length&&(this._back||(this._back=new SS),this._back.build(i))}}class bS{constructor(){this._polygons=new Array}static FromVertexData(e){let t,i,r;const s=[],a=e.indices,l=e.positions,h=e.normals,c=e.uvs,u=e.colors;if(!a||!l)throw"BABYLON.CSG: VertexData must at least contain positions and indices";for(let e=0;e<a.length;e+=3){r=[];for(let i=0;i<3;i++){const s=a[e+i],d=h?n.Pq.FromArray(h,3*s):n.Pq.Zero(),p=c?n.I9.FromArray(c,2*s):void 0,m=u?o.ov.FromArray(u,4*s):void 0,f=n.Pq.FromArray(l,3*s);t=new gS(f,d,p,m),r.push(t)}i=new vS(r,{subMeshId:0,meshId:_S,materialIndex:0}),i.plane&&s.push(i)}const d=bS._FromPolygons(s);return d.matrix=n.uq.Identity(),d.position=n.Pq.Zero(),d.rotation=n.Pq.Zero(),d.scaling=n.Pq.One(),d.rotationQuaternion=n.PT.Identity(),_S++,d}static FromMesh(e,t=!1){let i,r,s,a,l,h,c;const u=[];let d,p,m,f,_=null,g=!1;if(!(e instanceof tt.e))throw"BABYLON.CSG: Wrong Mesh type, must be BABYLON.Mesh";e.computeWorldMatrix(!0),d=e.getWorldMatrix(),p=e.position.clone(),m=e.rotation.clone(),e.rotationQuaternion&&(_=e.rotationQuaternion.clone()),f=e.scaling.clone(),e.material&&t&&(g=0===e.material.sideOrientation);const x=e.getIndices(),v=e.getVerticesData(Ot.R.PositionKind),S=e.getVerticesData(Ot.R.NormalKind),b=e.getVerticesData(Ot.R.UVKind),y=e.getVerticesData(Ot.R.ColorKind);if(null===x)throw"BABYLON.CSG: Mesh has no indices";if(null===v)throw"BABYLON.CSG: Mesh has no positions";if(null===S)throw"BABYLON.CSG: Mesh has no normals";const P=e.subMeshes;if(!P)throw"BABYLON.CSG: Mesh has no submeshes";for(let e=0,t=P.length;e<t;e++)for(let t=P[e].indexStart,p=P[e].indexCount+P[e].indexStart;t<p;t+=3){c=[];for(let e=0;e<3;e++){const h=0===e?t+e:g?t+3-e:t+e,u=new n.Pq(S[3*x[h]],S[3*x[h]+1],S[3*x[h]+2]);b&&(s=new n.I9(b[2*x[h]],b[2*x[h]+1])),y&&(l=new o.ov(y[4*x[h]],y[4*x[h]+1],y[4*x[h]+2],y[4*x[h]+3]));const p=new n.Pq(v[3*x[h]],v[3*x[h]+1],v[3*x[h]+2]);a=n.Pq.TransformCoordinates(p,d),r=n.Pq.TransformNormal(u,d),i=new gS(a,r,s,l),c.push(i)}h=new vS(c,{subMeshId:e,meshId:_S,materialIndex:P[e].materialIndex}),h.plane&&u.push(h)}const T=bS._FromPolygons(u);return T.matrix=t?n.uq.Identity():d,T.position=t?n.Pq.Zero():p,T.rotation=t?n.Pq.Zero():m,T.scaling=t?n.Pq.One():f,T.rotationQuaternion=t&&_?n.PT.Identity():_,_S++,T}static _FromPolygons(e){const t=new bS;return t._polygons=e,t}clone(){const e=new bS;return e._polygons=this._polygons.map((e=>e.clone())),e.copyTransformAttributes(this),e}union(e){const t=new SS(this.clone()._polygons),i=new SS(e.clone()._polygons);return t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),bS._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}unionInPlace(e){const t=new SS(this._polygons),i=new SS(e._polygons);t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),this._polygons=t.allPolygons()}subtract(e){const t=new SS(this.clone()._polygons),i=new SS(e.clone()._polygons);return t.invert(),t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),t.invert(),bS._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}subtractInPlace(e){const t=new SS(this._polygons),i=new SS(e._polygons);t.invert(),t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),t.invert(),this._polygons=t.allPolygons()}intersect(e){const t=new SS(this.clone()._polygons),i=new SS(e.clone()._polygons);return t.invert(),i.clipTo(t),i.invert(),t.clipTo(i),i.clipTo(t),t.build(i.allPolygons()),t.invert(),bS._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}intersectInPlace(e){const t=new SS(this._polygons),i=new SS(e._polygons);t.invert(),i.clipTo(t),i.invert(),t.clipTo(i),i.clipTo(t),t.build(i.allPolygons()),t.invert(),this._polygons=t.allPolygons()}inverse(){const e=this.clone();return e.inverseInPlace(),e}inverseInPlace(){this._polygons.map((e=>{e.flip()}))}copyTransformAttributes(e){return this.matrix=e.matrix,this.position=e.position,this.rotation=e.rotation,this.scaling=e.scaling,this.rotationQuaternion=e.rotationQuaternion,this}toVertexData(e=null,t=null){const i=this.matrix.clone();i.invert();const r=this._polygons,s=[],a=[],l=[];let h=null,c=null;const u=n.Pq.Zero(),d=n.Pq.Zero(),p=n.I9.Zero(),m=new o.ov(0,0,0,0),f=[0,0,0],_={};let g;for(let o=0,x=r.length;o<x;o++){const x=r[o];e&&e(x);for(let e=2,r=x.vertices.length;e<r;e++){f[0]=0,f[1]=e-1,f[2]=e;for(let e=0;e<3;e++){u.copyFrom(x.vertices[f[e]].pos),d.copyFrom(x.vertices[f[e]].normal),x.vertices[f[e]].uv&&(h||(h=[]),p.copyFrom(x.vertices[f[e]].uv)),x.vertices[f[e]].vertColor&&(c||(c=[]),m.copyFrom(x.vertices[f[e]].vertColor));const r=n.Pq.TransformCoordinates(u,i),o=n.Pq.TransformNormal(d,i);g=_[r.x+","+r.y+","+r.z];let v=!1;h&&h[2*g]!==p.x&&h[2*g+1]!==p.y&&(v=!0);let S=!1;c&&c[4*g]!==m.r&&c[4*g+1]!==m.g&&c[4*g+2]!==m.b&&c[4*g+3]!==m.a&&(S=!0),(void 0===g||l[3*g]!==o.x||l[3*g+1]!==o.y||l[3*g+2]!==o.z||v||S)&&(s.push(r.x,r.y,r.z),h&&h.push(p.x,p.y),l.push(d.x,d.y,d.z),c&&c.push(m.r,m.g,m.b,m.a),g=_[r.x+","+r.y+","+r.z]=s.length/3-1),a.push(g),t&&t()}}}const x=new ot.P;return x.positions=s,x.normals=l,h&&(x.uvs=h),c&&(x.colors=c),x.indices=a,x}buildMeshGeometry(e,t,i){const r=new tt.e(e,t),s=this._polygons;let n=0;const o={};let a;i&&s.sort(((e,t)=>e.shared.meshId===t.shared.meshId?e.shared.subMeshId-t.shared.subMeshId:e.shared.meshId-t.shared.meshId));if(this.toVertexData((e=>{o[e.shared.meshId]||(o[e.shared.meshId]={}),o[e.shared.meshId][e.shared.subMeshId]||(o[e.shared.meshId][e.shared.subMeshId]={indexStart:1/0,indexEnd:-1/0,materialIndex:e.shared.materialIndex}),a=o[e.shared.meshId][e.shared.subMeshId]}),(()=>{a.indexStart=Math.min(n,a.indexStart),a.indexEnd=Math.max(n,a.indexEnd),n++})).applyToMesh(r),i){let e,t=0;r.subMeshes=[];for(const i in o){e=-1;for(const s in o[i])a=o[i][s],ip.K.CreateFromIndices(a.materialIndex+t,a.indexStart,a.indexEnd-a.indexStart+1,r),e=Math.max(a.materialIndex,e);t+=++e}}return r}toMesh(e,t=null,i,r){const s=this.buildMeshGeometry(e,i,r);return s.material=t,s.position.copyFrom(this.position),s.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(s.rotationQuaternion=this.rotationQuaternion.clone()),s.scaling.copyFrom(this.scaling),s.computeWorldMatrix(!0),s}}class yS{static _GetShader(e,t){if(!e._meshUVSpaceRendererShader){const i=new rs("meshUVSpaceRendererShader",e,{vertex:"meshUVSpaceRenderer",fragment:"meshUVSpaceRenderer"},{attributes:["position","normal","uv"],uniforms:["world","projMatrix"],samplers:["textureSampler"],needAlphaBlending:!0,shaderLanguage:t});i.backFaceCulling=!1,i.alphaMode=2,e.onDisposeObservable.add((()=>{e._meshUVSpaceRendererShader?.dispose(),e._meshUVSpaceRendererShader=null})),e._meshUVSpaceRendererShader=i}return e._meshUVSpaceRendererShader}static _GetMaskShader(e,t){if(!e._meshUVSpaceRendererMaskShader){const i=new rs("meshUVSpaceRendererMaskShader",e,{vertex:"meshUVSpaceRendererMasker",fragment:"meshUVSpaceRendererMasker"},{attributes:["position","uv"],uniforms:["worldViewProjection"],shaderLanguage:t});i.backFaceCulling=!1,i.alphaMode=2,e.onDisposeObservable.add((()=>{e._meshUVSpaceRendererMaskShader?.dispose(),e._meshUVSpaceRendererMaskShader=null})),e._meshUVSpaceRendererMaskShader=i}return e._meshUVSpaceRendererMaskShader}static _IsRenderTargetTexture(e){return void 0!==e.renderList}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i){this._textureCreatedInternally=!1,this._configureUserCreatedTexture=!0,this._maskTexture=null,this._finalPostProcess=null,this._shadersLoaded=!1,this._isDisposed=!1,this.clearColor=new o.ov(0,0,0,0),this.texture=null,this._shaderLanguage=0,this._mesh=e,this._scene=t,this._options={width:1024,height:1024,textureType:0,generateMipMaps:!0,optimizeUVAllocation:!0,uvEdgeBlending:!1,...i},this._initShaderSourceAsync()}async _initShaderSourceAsync(){this._scene.getEngine().isWebGPU?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,23451)),Promise.resolve().then(i.bind(i,72657)),Promise.resolve().then(i.bind(i,19226)),Promise.resolve().then(i.bind(i,4044)),Promise.resolve().then(i.bind(i,33570)),Promise.resolve().then(i.bind(i,29700))])):await Promise.all([Promise.resolve().then(i.bind(i,99764)),Promise.resolve().then(i.bind(i,30)),Promise.resolve().then(i.bind(i,54561)),Promise.resolve().then(i.bind(i,78439)),Promise.resolve().then(i.bind(i,18507)),Promise.resolve().then(i.bind(i,15105))]),this._isDisposed||(this._shadersLoaded=!0)}isReady(){if(!this._shadersLoaded)return!1;this.texture?this._configureUserCreatedTexture&&this._configureUserCreatedRTT():this._createDiffuseRTT();const e=yS._IsRenderTargetTexture(this.texture)?this.texture.isReadyForRendering():this.texture.isReady(),t=this._maskTexture?.isReadyForRendering()??!0,i=this._finalPostProcess?.isReady()??!0;return e&&t&&i}renderTexture(e,t,i,r,s=0,n=!0){if(!n||this.isReady()){if(this.texture?this._configureUserCreatedTexture&&this._configureUserCreatedRTT():this._createDiffuseRTT(),yS._IsRenderTargetTexture(this.texture)){const n=this._createProjectionMatrix(t,i,r,s),o=yS._GetShader(this._scene,this._shaderLanguage);o.setTexture("textureSampler",e),o.setMatrix("projMatrix",n),this.texture.render(),o.removeTexture("textureSampler")}}else setTimeout((()=>{this.renderTexture(e,t,i,r,s,n)}),16)}clear(){if(this.texture&&yS._IsRenderTargetTexture(this.texture)&&this.texture.renderTarget){const e=this._scene.getEngine();e.bindFramebuffer(this.texture.renderTarget),e.clear(this.clearColor,!0,!0,!0),e.unBindFramebuffer(this.texture.renderTarget)}if(this._finalPostProcess?.inputTexture){const e=this._scene.getEngine();e.bindFramebuffer(this._finalPostProcess?.inputTexture),e.clear(this.clearColor,!0,!0,!0),e.unBindFramebuffer(this._finalPostProcess?.inputTexture)}}dispose(){this._textureCreatedInternally&&(this.texture?.dispose(),this._textureCreatedInternally=!1),this._configureUserCreatedTexture=!0,this._maskTexture?.dispose(),this._maskTexture=null,this._finalPostProcess?.dispose(),this._finalPostProcess=null,this._isDisposed=!0}_configureUserCreatedRTT(){this._configureUserCreatedTexture=!1,this.texture&&yS._IsRenderTargetTexture(this.texture)&&(this.texture.setMaterialForRendering(this._mesh,yS._GetShader(this._scene,this._shaderLanguage)),this.texture.onClearObservable.add((()=>{})),this.texture.renderList=[this._mesh],this._options.uvEdgeBlending&&(this._createMaskTexture(),this._createPostProcess(),this.texture.addPostProcess(this._finalPostProcess)))}_createDiffuseRTT(){this._textureCreatedInternally=!0;const e=this._createRenderTargetTexture(this._options.width,this._options.height);e.setMaterialForRendering(this._mesh,yS._GetShader(this._scene,this._shaderLanguage)),this.texture=e,this._configureUserCreatedTexture=!1,this._options.uvEdgeBlending&&(this._createMaskTexture(),this._createPostProcess(),e.addPostProcess(this._finalPostProcess))}_createMaskTexture(){this._maskTexture||(this._maskTexture=new cr.$(this._mesh.name+"_maskTexture",{width:this._options.width,height:this._options.height},this._scene,!1,!0,0,!1,2,void 0,void 0,void 0,6),this._maskTexture.clearColor=new o.ov(0,0,0,0),this._maskTexture.renderList.push(this._mesh),this._maskTexture.setMaterialForRendering(this._mesh,yS._GetMaskShader(this._scene,this._shaderLanguage)),this._maskTexture.refreshRate=cr.$.REFRESHRATE_RENDER_ONCE,this._scene.customRenderTargets.push(this._maskTexture))}_createPostProcess(){this._finalPostProcess||(this._finalPostProcess=new Fi.w(this._mesh.name+"_fixSeamsPostProcess","meshUVSpaceRendererFinaliser",["textureSize"],["textureSampler","maskTextureSampler"],1,null,1,this._scene.getEngine(),!1,null,this._options.textureType,void 0,void 0,void 0,void 0,this._shaderLanguage),this._finalPostProcess.onApplyObservable.add((e=>{e.setTexture("maskTextureSampler",this._maskTexture),e.setFloat2("textureSize",this._options.width,this._options.height)})))}_createRenderTargetTexture(e,t){const i=new cr.$(this._mesh.name+"_uvspaceTexture",{width:e,height:t},this._scene,this._options.generateMipMaps,!0,this._options.textureType,!1,this._options.generateMipMaps?3:2,!1,!1,!1,5);return i.renderParticles=!1,i.optimizeUVAllocation=!!this._options.optimizeUVAllocation,i.onClearObservable.addOnce((()=>{this._scene.getEngine().clear(this.clearColor,!0,!0,!0),i.onClearObservable.add((()=>{}))})),i.renderList=[this._mesh],i}_createProjectionMatrix(e,t,i,r=0){const s=-Math.atan2(t.z,t.x)-Math.PI/2,o=Math.sqrt(t.x*t.x+t.z*t.z),a=Math.atan2(t.y,o),l=e.add(t.scale(.5*i.z)),h=n.uq.RotationYawPitchRoll(s,a,r).multiply(n.uq.Translation(l.x,l.y,l.z)),c=n.uq.Invert(h),u=n.uq.FromArray([2/i.x,0,0,0,0,2/i.y,0,0,0,0,1/i.z,0,0,0,0,1]),d=n.uq.FromArray([.5,0,0,0,0,.5,0,0,0,0,1,0,.5,.5,0,1]);return c.multiply(u).multiply(d)}}var PS,TS=i(11420);tt.e._TrailMeshParser=(e,t)=>CS.Parse(e,t);class CS extends tt.e{constructor(e,t,i,r,s=60,o=!0){super(e,i),this._sectionPolygonPointsCount=4,this._running=!1,this._generator=t,"object"==typeof r&&null!==r?(this.diameter=r.diameter||1,this._length=r.length||60,this._segments=r.segments?r.segments>this._length?this._length:r.segments:this._length,this._sectionPolygonPointsCount=r.sections||4,this._doNotTaper=r.doNotTaper||!1,this._autoStart=r.autoStart||!0):(this.diameter=r||1,this._length=s,this._segments=this._length,this._doNotTaper=!1,this._autoStart=o),this._sectionVectors=[],this._sectionNormalVectors=[];for(let e=0;e<=this._sectionPolygonPointsCount;e++)this._sectionVectors[e]=n.Pq.Zero(),this._sectionNormalVectors[e]=n.Pq.Zero();this._createMesh()}getClassName(){return"TrailMesh"}_createMesh(){const e=new ot.P,t=[],i=[],r=[],s=[];let o=n.Pq.Zero();o=this._generator instanceof Ps.u&&this._generator.hasBoundingInfo?this._generator.getBoundingInfo().boundingBox.centerWorld:this._generator.absolutePosition;const a=2*Math.PI/this._sectionPolygonPointsCount;for(let e=0;e<=this._sectionPolygonPointsCount;e++){const i=e!==this._sectionPolygonPointsCount?e*a:0;t.push(o.x+Math.cos(i)*this.diameter,o.y+Math.sin(i)*this.diameter,o.z),s.push(e/this._sectionPolygonPointsCount,0)}for(let e=1;e<=this._segments;e++){for(let i=0;i<=this._sectionPolygonPointsCount;i++){const r=i!==this._sectionPolygonPointsCount?i*a:0;t.push(o.x+Math.cos(r)*this.diameter,o.y+Math.sin(r)*this.diameter,o.z),s.push(i/this._sectionPolygonPointsCount,e/this._segments)}const i=t.length/3-2*(this._sectionPolygonPointsCount+1);for(let e=0;e<=this._sectionPolygonPointsCount;e++)r.push(i+e,i+e+this._sectionPolygonPointsCount,i+e+this._sectionPolygonPointsCount+1),r.push(i+e,i+e+this._sectionPolygonPointsCount+1,i+e+1)}ot.P.ComputeNormals(t,r,i),e.positions=t,e.normals=i,e.indices=r,e.uvs=s,e.applyToMesh(this,!0),this._autoStart&&this.start()}_updateSectionVectors(){const e=this._generator.getWorldMatrix(),t=2*Math.PI/this._sectionPolygonPointsCount;for(let i=0;i<=this._sectionPolygonPointsCount;i++){const r=i!==this._sectionPolygonPointsCount?i*t:0;this._sectionVectors[i].copyFromFloats(Math.cos(r)*this.diameter,Math.sin(r)*this.diameter,0),this._sectionNormalVectors[i].copyFromFloats(Math.cos(r),Math.sin(r),0),n.Pq.TransformCoordinatesToRef(this._sectionVectors[i],e,this._sectionVectors[i]),n.Pq.TransformNormalToRef(this._sectionNormalVectors[i],e,this._sectionNormalVectors[i])}}start(){this._running||(this._running=!0,this._beforeRenderObserver=this.getScene().onBeforeRenderObservable.add((()=>{this.update()})))}stop(){this._beforeRenderObserver&&this._running&&(this._running=!1,this.getScene().onBeforeRenderObservable.remove(this._beforeRenderObserver))}update(){const e=this.getVerticesData(Ot.R.PositionKind),t=this.getVerticesData(Ot.R.NormalKind),i=3*(this._sectionPolygonPointsCount+1);if(e&&t){if(this._doNotTaper)for(let t=i;t<e.length;t++)e[t-i]=(0,yt.Lerp)(e[t-i],e[t],this._segments/this._length);else for(let r=i;r<e.length;r++)e[r-i]=(0,yt.Lerp)(e[r-i],e[r],this._segments/this._length)-t[r]/this._length*this.diameter;for(let e=i;e<t.length;e++)t[e-i]=(0,yt.Lerp)(t[e-i],t[e],this._segments/this._length);this._updateSectionVectors();const r=e.length-3*(this._sectionPolygonPointsCount+1);for(let i=0;i<=this._sectionPolygonPointsCount;i++)e[r+3*i]=this._sectionVectors[i].x,e[r+3*i+1]=this._sectionVectors[i].y,e[r+3*i+2]=this._sectionVectors[i].z,t[r+3*i]=this._sectionNormalVectors[i].x,t[r+3*i+1]=this._sectionNormalVectors[i].y,t[r+3*i+2]=this._sectionNormalVectors[i].z;this.updateVerticesData(Ot.R.PositionKind,e,!0,!1),this.updateVerticesData(Ot.R.NormalKind,t,!0,!1)}}reset(){const e=this.getVerticesData(Ot.R.PositionKind),t=this.getVerticesData(Ot.R.NormalKind);if(e&&t){this._updateSectionVectors();for(let i=0;i<=this._segments;i++){const r=3*i*(this._sectionPolygonPointsCount+1);for(let i=0;i<=this._sectionPolygonPointsCount;i++)e[r+3*i]=this._sectionVectors[i].x,e[r+3*i+1]=this._sectionVectors[i].y,e[r+3*i+2]=this._sectionVectors[i].z,t[r+3*i]=this._sectionNormalVectors[i].x,t[r+3*i+1]=this._sectionNormalVectors[i].y,t[r+3*i+2]=this._sectionNormalVectors[i].z}this.updateVerticesData(Ot.R.PositionKind,e,!0,!1),this.updateVerticesData(Ot.R.NormalKind,t,!0,!1)}}clone(e="",t){const i={diameter:this.diameter,length:this._length,segments:this._segments,sections:this._sectionPolygonPointsCount,doNotTaper:this._doNotTaper,autoStart:this._autoStart};return new CS(e,t??this._generator,this.getScene(),i)}serialize(e){super.serialize(e),e.generatorId=this._generator.id}static Parse(e,t){const i=t.getLastMeshById(e.generatorId)??t.getLastTransformNodeById(e.generatorId);if(!i)throw new Error("TrailMesh: generator not found with ID "+e.generatorId);const r={diameter:e.diameter??e._diameter,length:e._length,segments:e._segments,sections:e._sectionPolygonPointsCount,doNotTaper:e._doNotTaper,autoStart:e._autoStart};return new CS(e.name,i,t,r)}}class ES{constructor(e,t,i){this.quality=e,this.distance=t,this.optimizeMesh=i}}class AS{constructor(){this.running=!1,this._simplificationArray=[]}addTask(e){this._simplificationArray.push(e)}executeNext(){const e=this._simplificationArray.pop();e?(this.running=!0,this.runSimplification(e)):this.running=!1}runSimplification(e){if(e.parallelProcessing)e.settings.forEach((t=>{this._getSimplifier(e).simplify(t,(i=>{void 0!==t.distance&&e.mesh.addLODLevel(t.distance,i),i.isVisible=!0,t.quality===e.settings[e.settings.length-1].quality&&e.successCallback&&e.successCallback(),this.executeNext()}))}));else{const t=this._getSimplifier(e),i=(i,r)=>{t.simplify(i,(t=>{void 0!==i.distance&&e.mesh.addLODLevel(i.distance,t),t.isVisible=!0,r()}))};H.LV.Run(e.settings.length,(t=>{i(e.settings[t.index],(()=>{t.executeNext()}))}),(()=>{e.successCallback&&e.successCallback(),this.executeNext()}))}}_getSimplifier(e){return e.simplificationType,new OS(e.mesh)}}!function(e){e[e.QUADRATIC=0]="QUADRATIC"}(PS||(PS={}));class IS{constructor(e){this._vertices=e,this.error=new Array(4),this.deleted=!1,this.isDirty=!1,this.deletePending=!1,this.borderFactor=0}}class RS{constructor(e,t){this.position=e,this.id=t,this.isBorder=!0,this.q=new MS,this.triangleCount=0,this.triangleStart=0,this.originalOffsets=[]}updatePosition(e){this.position.copyFrom(e)}}class MS{constructor(e){this.data=new Array(10);for(let t=0;t<10;++t)e&&e[t]?this.data[t]=e[t]:this.data[t]=0}det(e,t,i,r,s,n,o,a,l){return this.data[e]*this.data[s]*this.data[l]+this.data[i]*this.data[r]*this.data[a]+this.data[t]*this.data[n]*this.data[o]-this.data[i]*this.data[s]*this.data[o]-this.data[e]*this.data[n]*this.data[a]-this.data[t]*this.data[r]*this.data[l]}addInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e.data[t]}addArrayInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e[t]}add(e){const t=new MS;for(let i=0;i<10;++i)t.data[i]=this.data[i]+e.data[i];return t}static FromData(e,t,i,r){return new MS(MS.DataFromNumbers(e,t,i,r))}static DataFromNumbers(e,t,i,r){return[e*e,e*t,e*i,e*r,t*t,t*i,t*r,i*i,i*r,r*r]}}class DS{constructor(e,t){this.vertexId=e,this.triangleId=t}}class OS{constructor(e){this._mesh=e,this.syncIterations=5e3,this.aggressiveness=7,this.decimationIterations=100,this.boundingBoxEpsilon=ut.bH}simplify(e,t){this._initDecimatedMesh(),H.LV.Run(this._mesh.subMeshes.length,(t=>{this._initWithMesh(t.index,(()=>{this._runDecimation(e,t.index,(()=>{t.executeNext()}))}),e.optimizeMesh)}),(()=>{setTimeout((()=>{t(this._reconstructedMesh)}),0)}))}_runDecimation(e,t,i){const r=~~(this._triangles.length*e.quality);let s=0;const o=this._triangles.length,a=(e,t)=>{setTimeout((()=>{e%5==0&&this._updateMesh(0===e);for(let e=0;e<this._triangles.length;++e)this._triangles[e].isDirty=!1;const i=1e-9*Math.pow(e+3,this.aggressiveness);H.LV.SyncAsyncForLoop(this._triangles.length,this.syncIterations,(e=>{const t=~~((this._triangles.length/2+e)%this._triangles.length),r=this._triangles[t];if(r&&!(r.error[3]>i||r.deleted||r.isDirty))for(let e=0;e<3;++e)if(r.error[e]<i){const t=[],i=[],o=r._vertices[e],a=r._vertices[(e+1)%3];if(o.isBorder||a.isBorder)continue;const l=n.Pq.Zero();this._calculateError(o,a,l);const h=[];if(this._isFlipped(o,a,l,t,h))continue;if(this._isFlipped(a,o,l,i,h))continue;if(t.indexOf(!0)<0||i.indexOf(!0)<0)continue;const c=[];if(h.forEach((e=>{-1===c.indexOf(e)&&(e.deletePending=!0,c.push(e))})),c.length%2!=0)continue;o.q=a.q.add(o.q),o.updatePosition(l);const u=this._references.length;s=this._updateTriangles(o,o,t,s),s=this._updateTriangles(o,a,i,s);const d=this._references.length-u;if(d<=o.triangleCount){if(d)for(let e=0;e<d;e++)this._references[o.triangleStart+e]=this._references[u+e]}else o.triangleStart=u;o.triangleCount=d;break}}),t,(()=>o-s<=r))}),0)};H.LV.Run(this.decimationIterations,(e=>{o-s<=r?e.breakLoop():a(e.index,(()=>{e.executeNext()}))}),(()=>{setTimeout((()=>{this._reconstructMesh(t),i()}),0)}))}_initWithMesh(e,t,i){this._vertices=[],this._triangles=[];const r=this._mesh.getVerticesData(Ot.R.PositionKind),s=this._mesh.getIndices(),o=this._mesh.subMeshes[e],a=e=>{if(i)for(let t=0;t<this._vertices.length;++t)if(this._vertices[t].position.equalsWithEpsilon(e,1e-4))return this._vertices[t];return null},l=[],h=o.verticesCount;H.LV.SyncAsyncForLoop(h,this.syncIterations/4|0,(e=>{if(!r)return;const t=e+o.verticesStart,i=n.Pq.FromArray(r,3*t),s=a(i)||new RS(i,this._vertices.length);s.originalOffsets.push(t),s.id===this._vertices.length&&this._vertices.push(s),l.push(s.id)}),(()=>{H.LV.SyncAsyncForLoop(o.indexCount/3,this.syncIterations,(e=>{if(!s)return;const t=3*(o.indexStart/3+e),i=s[t+0],r=s[t+1],n=s[t+2],a=this._vertices[l[i-o.verticesStart]],h=this._vertices[l[r-o.verticesStart]],c=this._vertices[l[n-o.verticesStart]],u=new IS([a,h,c]);u.originalOffset=t,this._triangles.push(u)}),(()=>{this._init(t)}))}))}_init(e){H.LV.SyncAsyncForLoop(this._triangles.length,this.syncIterations,(e=>{const t=this._triangles[e];t.normal=n.Pq.Cross(t._vertices[1].position.subtract(t._vertices[0].position),t._vertices[2].position.subtract(t._vertices[0].position)).normalize();for(let e=0;e<3;e++)t._vertices[e].q.addArrayInPlace(MS.DataFromNumbers(t.normal.x,t.normal.y,t.normal.z,-n.Pq.Dot(t.normal,t._vertices[0].position)))}),(()=>{H.LV.SyncAsyncForLoop(this._triangles.length,this.syncIterations,(e=>{const t=this._triangles[e];for(let e=0;e<3;++e)t.error[e]=this._calculateError(t._vertices[e],t._vertices[(e+1)%3]);t.error[3]=Math.min(t.error[0],t.error[1],t.error[2])}),(()=>{e()}))}))}_reconstructMesh(e){const t=[];let i,r,s;for(i=0;i<this._vertices.length;++i)this._vertices[i].triangleCount=0;for(i=0;i<this._triangles.length;++i)if(!this._triangles[i].deleted){for(r=this._triangles[i],s=0;s<3;++s)r._vertices[s].triangleCount=1;t.push(r)}const n=this._reconstructedMesh.getVerticesData(Ot.R.PositionKind)||[],o=this._reconstructedMesh.getVerticesData(Ot.R.NormalKind)||[],a=this._reconstructedMesh.getVerticesData(Ot.R.UVKind)||[],l=this._reconstructedMesh.getVerticesData(Ot.R.ColorKind)||[],h=this._mesh.getVerticesData(Ot.R.NormalKind),c=this._mesh.getVerticesData(Ot.R.UVKind),u=this._mesh.getVerticesData(Ot.R.ColorKind);let d=0;for(i=0;i<this._vertices.length;++i){const e=this._vertices[i];e.id=d,e.triangleCount&&e.originalOffsets.forEach((t=>{n.push(e.position.x),n.push(e.position.y),n.push(e.position.z),h&&h.length&&(o.push(h[3*t]),o.push(h[3*t+1]),o.push(h[3*t+2])),c&&c.length&&(a.push(c[2*t]),a.push(c[2*t+1])),u&&u.length&&(l.push(u[4*t]),l.push(u[4*t+1]),l.push(u[4*t+2]),l.push(u[4*t+3])),++d}))}const p=this._reconstructedMesh.getTotalIndices(),m=this._reconstructedMesh.getTotalVertices(),f=this._reconstructedMesh.subMeshes;this._reconstructedMesh.subMeshes=[];const _=this._reconstructedMesh.getIndices(),g=this._mesh.getIndices();for(i=0;i<t.length;++i)r=t[i],[0,1,2].forEach((e=>{const t=g[r.originalOffset+e];let i=r._vertices[e].originalOffsets.indexOf(t);i<0&&(i=0),_.push(r._vertices[e].id+i+m)}));this._reconstructedMesh.setIndices(_),this._reconstructedMesh.setVerticesData(Ot.R.PositionKind,n),o.length>0&&this._reconstructedMesh.setVerticesData(Ot.R.NormalKind,o),a.length>0&&this._reconstructedMesh.setVerticesData(Ot.R.UVKind,a),l.length>0&&this._reconstructedMesh.setVerticesData(Ot.R.ColorKind,l);const x=this._mesh.subMeshes[e];e>0&&(this._reconstructedMesh.subMeshes=[],f.forEach((e=>{ip.K.AddToMesh(e.materialIndex,e.verticesStart,e.verticesCount,e.indexStart,e.indexCount,e.getMesh())})),ip.K.AddToMesh(x.materialIndex,m,d,p,3*t.length,this._reconstructedMesh))}_initDecimatedMesh(){this._reconstructedMesh=new tt.e(this._mesh.name+"Decimated",this._mesh.getScene()),this._reconstructedMesh.material=this._mesh.material,this._reconstructedMesh.parent=this._mesh.parent,this._reconstructedMesh.isVisible=!1,this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId}_isFlipped(e,t,i,r,s){for(let o=0;o<e.triangleCount;++o){const a=this._triangles[this._references[e.triangleStart+o].triangleId];if(a.deleted)continue;const l=this._references[e.triangleStart+o].vertexId,h=a._vertices[(l+1)%3],c=a._vertices[(l+2)%3];if(h===t||c===t){r[o]=!0,s.push(a);continue}let u=h.position.subtract(i);u=u.normalize();let d=c.position.subtract(i);if(d=d.normalize(),Math.abs(n.Pq.Dot(u,d))>.999)return!0;const p=n.Pq.Cross(u,d).normalize();if(r[o]=!1,n.Pq.Dot(p,a.normal)<.2)return!0}return!1}_updateTriangles(e,t,i,r){let s=r;for(let r=0;r<t.triangleCount;++r){const n=this._references[t.triangleStart+r],o=this._triangles[n.triangleId];o.deleted||(i[r]&&o.deletePending?(o.deleted=!0,s++):(o._vertices[n.vertexId]=e,o.isDirty=!0,o.error[0]=this._calculateError(o._vertices[0],o._vertices[1])+o.borderFactor/2,o.error[1]=this._calculateError(o._vertices[1],o._vertices[2])+o.borderFactor/2,o.error[2]=this._calculateError(o._vertices[2],o._vertices[0])+o.borderFactor/2,o.error[3]=Math.min(o.error[0],o.error[1],o.error[2]),this._references.push(n)))}return s}_identifyBorder(){for(let e=0;e<this._vertices.length;++e){const t=[],i=[],r=this._vertices[e];let s;for(s=0;s<r.triangleCount;++s){const e=this._triangles[this._references[r.triangleStart+s].triangleId];for(let r=0;r<3;r++){let s=0;const n=e._vertices[r];for(;s<t.length&&i[s]!==n.id;)++s;s===t.length?(t.push(1),i.push(n.id)):t[s]++}}for(s=0;s<t.length;++s)1===t[s]?this._vertices[i[s]].isBorder=!0:this._vertices[i[s]].isBorder=!1}}_updateMesh(e=!1){let t,i,r,s;if(!e){const e=[];for(t=0;t<this._triangles.length;++t)this._triangles[t].deleted||e.push(this._triangles[t]);this._triangles=e}for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleCount=0,this._vertices[t].triangleStart=0;for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],r=0;r<3;++r)s=i._vertices[r],s.triangleCount++;let n=0;for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleStart=n,n+=this._vertices[t].triangleCount,this._vertices[t].triangleCount=0;const o=new Array(3*this._triangles.length);for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],r=0;r<3;++r)s=i._vertices[r],o[s.triangleStart+s.triangleCount]=new DS(r,t),s.triangleCount++;this._references=o,e&&this._identifyBorder()}_vertexError(e,t){const i=t.x,r=t.y,s=t.z;return e.data[0]*i*i+2*e.data[1]*i*r+2*e.data[2]*i*s+2*e.data[3]*i+e.data[4]*r*r+2*e.data[5]*r*s+2*e.data[6]*r+e.data[7]*s*s+2*e.data[8]*s+e.data[9]}_calculateError(e,t,i){const r=e.q.add(t.q),s=e.isBorder&&t.isBorder;let o=0;const a=r.det(0,1,2,1,4,5,2,5,7);if(0===a||s){const s=e.position.add(t.position).divide(new n.Pq(2,2,2)),a=this._vertexError(r,e.position),l=this._vertexError(r,t.position),h=this._vertexError(r,s);o=Math.min(a,l,h),o===a?i&&i.copyFrom(e.position):o===l?i&&i.copyFrom(t.position):i&&i.copyFrom(s)}else i||(i=n.Pq.Zero()),i.x=-1/a*r.det(1,2,3,4,5,6,5,7,8),i.y=1/a*r.det(0,2,3,1,5,6,2,7,8),i.z=-1/a*r.det(0,1,3,1,4,6,2,5,8),o=this._vertexError(r,i);return o}}Object.defineProperty(it.Z.prototype,"simplificationQueue",{get:function(){if(!this._simplificationQueue){this._simplificationQueue=new AS;let e=this._getComponent(Ei.v.NAME_SIMPLIFICATIONQUEUE);e||(e=new NS(this),this._addComponent(e))}return this._simplificationQueue},set:function(e){this._simplificationQueue=e},enumerable:!0,configurable:!0}),tt.e.prototype.simplify=function(e,t=!0,i=0,r){return this.getScene().simplificationQueue.addTask({settings:e,parallelProcessing:t,mesh:this,simplificationType:i,successCallback:r}),this};class NS{constructor(e){this.name=Ei.v.NAME_SIMPLIFICATIONQUEUE,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(Ei.v.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE,this,this._beforeCameraUpdate)}rebuild(){}dispose(){}_beforeCameraUpdate(){this.scene._simplificationQueue&&!this.scene._simplificationQueue.running&&this.scene._simplificationQueue.executeNext()}}var wS=i(93970);class FS{getClassName(){return"Lattice"}get resolutionX(){return this._resolutionX}get resolutionY(){return this._resolutionY}get resolutionZ(){return this._resolutionZ}get size(){return this._size}get position(){return this._position}get data(){return this._data}get cellSize(){return this._cellSize}get min(){return this._min}get max(){return this._max}constructor(e){this._cellSize=new n.Pq,this._min=new n.Pq(-.5,-.5,-.5),this._max=new n.Pq(.5,.5,.5),this._localPos=new n.Pq,this._tmpVector=new n.Pq,this._lerpVector0=new n.Pq,this._lerpVector1=new n.Pq,this._lerpVector2=new n.Pq,this._lerpVector3=new n.Pq,this._lerpVector4=new n.Pq,this._lerpVector5=new n.Pq;const t={resolutionX:3,resolutionY:3,resolutionZ:3,position:n.Pq.Zero(),size:n.Pq.One(),...e};this._resolutionX=t.resolutionX,this._resolutionY=t.resolutionY,this._resolutionZ=t.resolutionZ,this._position=t.position,this._size=t.autoAdaptToMesh?t.autoAdaptToMesh.getBoundingInfo().boundingBox.extendSize.scale(2):t.size,this._allocateData(),this.update()}_allocateData(){this._data=new Array(this.resolutionX);for(let e=0;e<this.resolutionX;e++){this._data[e]=new Array(this.resolutionY);for(let t=0;t<this.resolutionY;t++){this._data[e][t]=new Array(this.resolutionZ);for(let i=0;i<this.resolutionZ;i++)this._data[e][t][i]=n.Pq.Zero()}}}update(){for(let e=0;e<this.resolutionX;e++)for(let t=0;t<this.resolutionY;t++)for(let i=0;i<this.resolutionZ;i++){const r=-this.size.x/2+this.size.x*(e/(this.resolutionX-1)),s=-this.size.y/2+this.size.y*(t/(this.resolutionY-1)),n=-this.size.z/2+this.size.z*(i/(this.resolutionZ-1));this._data[e][t][i].set(r,s,n)}}deformMesh(e){const t=e.getVerticesData(ss.R.PositionKind);t&&(this.deform(t),e.setVerticesData(ss.R.PositionKind,t,!0))}updateInternals(){const e=this._resolutionX,t=this._resolutionY,i=this._resolutionZ;this._cellSize.set(this.size.x/(e-1),this.size.y/(t-1),this.size.z/(i-1)),this._min.set(this.position.x-this.size.x/2,this.position.y-this.size.y/2,this.position.z-this.size.z/2),this._min.addToRef(this._size,this._max)}deform(e,t){const i=this._resolutionX,r=this._resolutionY,s=this._resolutionZ;this.updateInternals();const o=this._min,a=this._max;for(let l=0;l<e.length;l+=3){const h=this._tmpVector.fromArray(e,l);if((0,yt.OutsideRange)(h.x,o.x,a.x,ut.bH)||(0,yt.OutsideRange)(h.y,o.y,a.y,ut.bH)||(0,yt.OutsideRange)(h.z,o.z,a.z,ut.bH)){t&&h.toArray(t,l);continue}const c=this._localPos.set((h.x-o.x)/this._cellSize.x,(h.y-o.y)/this._cellSize.y,(h.z-o.z)/this._cellSize.z),u=Math.floor(c.x),d=Math.floor(c.y),p=Math.floor(c.z),m=Math.min(u+1,i-1),f=Math.min(d+1,r-1),_=Math.min(p+1,s-1),g=c.x-u,x=c.y-d,v=c.z-p,S=(0,yt.Clamp)(u,0,i-1),b=(0,yt.Clamp)(d,0,r-1),y=(0,yt.Clamp)(p,0,s-1),P=(0,yt.Clamp)(m,0,i-1),T=(0,yt.Clamp)(f,0,r-1),C=(0,yt.Clamp)(_,0,s-1),E=this._data[S][b][y],A=this._data[P][b][y],I=this._data[S][T][y],R=this._data[P][T][y],M=this._data[S][b][C],D=this._data[P][b][C],O=this._data[S][T][C],N=this._data[P][T][C],w=n.Pq.LerpToRef(E,A,g,this._lerpVector0),F=n.Pq.LerpToRef(M,D,g,this._lerpVector1),B=n.Pq.LerpToRef(I,R,g,this._lerpVector2),V=n.Pq.LerpToRef(O,N,g,this._lerpVector3),L=n.Pq.LerpToRef(w,B,x,this._lerpVector4),k=n.Pq.LerpToRef(F,V,x,this._lerpVector5),G=n.Pq.LerpToRef(L,k,v,this._lerpVector0);G.addInPlace(this.position),G.toArray(t||e,l)}}}class BS extends vv.y{constructor(e,t){super(t,"Lattice",200),this._lattice=e,this.refreshData(),this._enable(!0)}getClassName(){return"LatticePluginMaterial"}isCompatible(e){switch(e){case 0:case 1:return!0;default:return!1}}refreshData(){const e=this._lattice.resolutionX*this._lattice.resolutionY*this._lattice.resolutionZ*4;this._latticeData&&this._latticeData.length===e||(this._latticeData=new Float32Array(e));for(let e=0;e<this._lattice.resolutionX;e++)for(let t=0;t<this._lattice.resolutionY;t++)for(let i=0;i<this._lattice.resolutionZ;i++){const r=this._lattice.data[e][t][i],s=e+this._lattice.resolutionX*(t+this._lattice.resolutionY*i);r.toArray(this._latticeData,4*s)}this._latticeDataTexture&&this._latticeDataTexture.width===this._lattice.resolutionX&&this._latticeDataTexture.height===this._lattice.resolutionY&&this._latticeDataTexture.depth===this._lattice.resolutionZ?this._latticeDataTexture.update(this._latticeData):(this._latticeDataTexture&&this._latticeDataTexture.dispose(),this._latticeDataTexture=new Yf(this._latticeData,this._lattice.resolutionX,this._lattice.resolutionY,this._lattice.resolutionZ,5,this._material.getScene(),!1,!1,1,1))}getUniforms(e=0){return 1===e?{ubo:[{name:"lattice_cellSize",size:3,type:"vec3"},{name:"lattice_min",size:3,type:"vec3"},{name:"lattice_max",size:3,type:"vec3"},{name:"lattice_resolution",size:3,type:"vec3"},{name:"lattice_position",size:3,type:"vec3"}]}:{ubo:[{name:"lattice_cellSize",size:3,type:"vec3"},{name:"lattice_min",size:3,type:"vec3"},{name:"lattice_max",size:3,type:"vec3"},{name:"lattice_resolution",size:3,type:"vec3"},{name:"lattice_position",size:3,type:"vec3"}],vertex:"\n                    uniform vec3 lattice_cellSize;\n                    uniform vec3 lattice_min;\n                    uniform vec3 lattice_max;\n                    uniform vec3 lattice_resolution;\n                    uniform vec3 lattice_position;\n                    "}}bindForSubMesh(e){this._lattice.updateInternals(),e.updateVector3("lattice_cellSize",this._lattice.cellSize),e.updateVector3("lattice_min",this._lattice.min),e.updateVector3("lattice_max",this._lattice.max),e.updateFloat3("lattice_resolution",this._lattice.resolutionX,this._lattice.resolutionY,this._lattice.resolutionZ),e.updateVector3("lattice_position",this._lattice.position),e.setTexture("latticeData",this._latticeDataTexture)}getSamplers(e){e.push("latticeData")}_prepareCode(e=0){if(this._code)return this._code;let t="\n            if (positionUpdated.x >= lattice_min.x && positionUpdated.x <= lattice_max.x &&\n                positionUpdated.y >= lattice_min.y && positionUpdated.y <= lattice_max.y &&\n                positionUpdated.z >= lattice_min.z && positionUpdated.z <= lattice_max.z) {\n\n                // Map vertex position to lattice local coordinates\n                vec3d localPos = vec3c((positionUpdated.x - lattice_min.x) / lattice_cellSize.x, (positionUpdated.y - lattice_min.y) / lattice_cellSize.y, (positionUpdated.z - lattice_min.z) / lattice_cellSize.z);\n\n                // Get integer lattice indices\n                intd i0 = intc(floor(localPos.x));\n                intd j0 = intc(floor(localPos.y));\n                intd k0 = intc(floor(localPos.z));\n\n                intd resX = intc(lattice_resolution.x) - 1;\n                intd resY = intc(lattice_resolution.y) - 1;\n                intd resZ = intc(lattice_resolution.z) - 1;\n\n                intd i1 = min(i0 + 1, resX);\n                intd j1 = min(j0 + 1, resY);\n                intd k1 = min(k0 + 1, resZ);\n\n                // Compute interpolation weights\n                floatd tx = localPos.x - floatc(i0);\n                floatd ty = localPos.y - floatc(j0);\n                floatd tz = localPos.z - floatc(k0);\n\n                // Ensure indices are within bounds\n                intd ii0 = clamp(i0, 0, resX);\n                intd jj0 = clamp(j0, 0, resY);\n                intd kk0 = clamp(k0, 0, resZ);\n                intd ii1 = clamp(i1, 0, resX);\n                intd jj1 = clamp(j1, 0, resY);\n                intd kk1 = clamp(k1, 0, resZ);\n\n                // Get lattice control points\n                vec3d p000 = texelFetch(latticeData, ivec3c(ii0, jj0, kk0), 0).rgb;\n                vec3d p100 = texelFetch(latticeData, ivec3c(ii1, jj0, kk0), 0).rgb;\n                vec3d p010 = texelFetch(latticeData, ivec3c(ii0, jj1, kk0), 0).rgb;\n                vec3d p110 = texelFetch(latticeData, ivec3c(ii1, jj1, kk0), 0).rgb;\n                vec3d p001 = texelFetch(latticeData, ivec3c(ii0, jj0, kk1), 0).rgb;\n                vec3d p101 = texelFetch(latticeData, ivec3c(ii1, jj0, kk1), 0).rgb;\n                vec3d p011 = texelFetch(latticeData, ivec3c(ii0, jj1, kk1), 0).rgb;\n                vec3d p111 = texelFetch(latticeData, ivec3c(ii1, jj1, kk1), 0).rgb;\n\n                // Trilinear interpolation\n                vec3d p00 = mix(p000, p100, tx);\n                vec3d p01 = mix(p001, p101, tx);\n                vec3d p10 = mix(p010, p110, tx);\n                vec3d p11 = mix(p011, p111, tx);\n\n                vec3d p0 = mix(p00, p10, ty);\n                vec3d p1 = mix(p01, p11, ty);\n\n                vec3d deformedPos = mix(p0, p1, tz);\n                positionUpdated = deformedPos + lattice_position;\n            };\n        ";return 1===e?(t="\n                let lattice_min = uniforms.lattice_min;\n                let lattice_max = uniforms.lattice_max;\n                let lattice_resolution = uniforms.lattice_resolution;\n                let lattice_position = uniforms.lattice_position;\n                let lattice_cellSize = uniforms.lattice_cellSize;\n            "+t,t=t.replace(/ivec3c/g,"vec3i"),t=t.replace(/vec3d/g,"var"),t=t.replace(/vec3c/g,"vec3f"),t=t.replace(/intd/g,"var"),t=t.replace(/intc/g,"i32"),t=t.replace(/floatd/g,"var"),t=t.replace(/floatc/g,"f32"),t=t.replace(/texelFetch/g,"textureLoad")):(t=t.replace(/ivec3c/g,"ivec3"),t=t.replace(/vec3d/g,"vec3"),t=t.replace(/vec3c/g,"vec3"),t=t.replace(/intd/g,"int"),t=t.replace(/intc/g,"int"),t=t.replace(/floatd/g,"float"),t=t.replace(/floatc/g,"float")),this._code=t,this._code}getCustomCode(e,t=0){return"vertex"===e?1===t?{CUSTOM_VERTEX_DEFINITIONS:"\n                        var latticeData: texture_3d<f32>;\n                    ",CUSTOM_VERTEX_UPDATE_POSITION:this._prepareCode(t)}:{CUSTOM_VERTEX_DEFINITIONS:"\n                    precision highp sampler3D;\n                    uniform sampler3D latticeData;\n                ",CUSTOM_VERTEX_UPDATE_POSITION:this._prepareCode(t)}:null}dispose(){this._latticeDataTexture&&(this._latticeDataTexture.dispose(),this._latticeDataTexture=null)}}var VS,LS,kS,GS,zS,US=i(16400);!function(e){e[e.POINTS_MODE_POINTS=0]="POINTS_MODE_POINTS",e[e.POINTS_MODE_PATHS=1]="POINTS_MODE_PATHS"}(VS||(VS={})),function(e){e[e.FACES_MODE_SINGLE_SIDED=0]="FACES_MODE_SINGLE_SIDED",e[e.FACES_MODE_SINGLE_SIDED_NO_BACKFACE_CULLING=1]="FACES_MODE_SINGLE_SIDED_NO_BACKFACE_CULLING",e[e.FACES_MODE_DOUBLE_SIDED=2]="FACES_MODE_DOUBLE_SIDED"}(LS||(LS={})),function(e){e[e.AUTO_DIRECTIONS_FROM_FIRST_SEGMENT=0]="AUTO_DIRECTIONS_FROM_FIRST_SEGMENT",e[e.AUTO_DIRECTIONS_FROM_ALL_SEGMENTS=1]="AUTO_DIRECTIONS_FROM_ALL_SEGMENTS",e[e.AUTO_DIRECTIONS_ENHANCED=2]="AUTO_DIRECTIONS_ENHANCED",e[e.AUTO_DIRECTIONS_FACE_TO=3]="AUTO_DIRECTIONS_FACE_TO",e[e.AUTO_DIRECTIONS_NONE=99]="AUTO_DIRECTIONS_NONE"}(kS||(kS={}));class WS extends tt.e{constructor(e,t,i){super(e,t,null,null,!1,!1),this.name=e,this._options=i,this._lazy=!1,this._updatable=!1,this._engine=t.getEngine(),this._lazy=i.lazy??!1,this._updatable=i.updatable??!1,this._vertexPositions=[],this._indices=[],this._uvs=[],this._points=[],this._colorPointers=i.colorPointers??[],this._widths=i.widths??new Array(i.points.length).fill(1)}getClassName(){return"GreasedLineMesh"}_updateWidthsWithValue(e){let t=0;for(const e of this._points)t+=e.length;const i=t/3*2-this._widths.length;for(let t=0;t<i;t++)this._widths.push(e)}updateLazy(){this._setPoints(this._points),this._options.colorPointers||this._updateColorPointers(),this._createVertexBuffers(this._options.ribbonOptions?.smoothShading),!this.doNotSyncBoundingInfo&&this.refreshBoundingInfo(),this.greasedLineMaterial?.updateLazy()}addPoints(e,t){for(const t of e)this._points.push(t);this._lazy||this.setPoints(this._points,t)}dispose(e,t=!1){super.dispose(e,t)}isLazy(){return this._lazy}get uvs(){return this._uvs}set uvs(e){this._uvs=e instanceof Float32Array?e:new Float32Array(e),this._createVertexBuffers()}get offsets(){return this._offsets}set offsets(e){this.material instanceof Bv&&this.material.setDefine(Fv,e?.length>0),this._offsets=e,this._offsetsBuffer?this._offsetsBuffer.update(e):this._createOffsetsBuffer(e)}get widths(){return this._widths}set widths(e){this._widths=e,this._lazy||this._widthsBuffer&&this._widthsBuffer.update(e)}get colorPointers(){return this._colorPointers}set colorPointers(e){this._colorPointers=e,this._lazy||this._colorPointersBuffer&&this._colorPointersBuffer.update(e)}get greasedLineMaterial(){if(this.material&&this.material instanceof Bv)return this.material;const e=this.material?.pluginManager?.getPlugin(wv.GREASED_LINE_MATERIAL_NAME);return e||void 0}get points(){const e=[];return E.r.DeepCopy(this._points,e),e}setPoints(e,t){this._points=Ov.ConvertPoints(e,t?.pointsOptions??this._options.pointsOptions),this._updateWidths(),t?.colorPointers||this._updateColorPointers(),this._setPoints(this._points,t)}_initGreasedLine(){this._vertexPositions=[],this._indices=[],this._uvs=[]}_createLineOptions(){return{points:this._points,colorPointers:this._colorPointers,lazy:this._lazy,updatable:this._updatable,uvs:this._uvs,widths:this._widths,ribbonOptions:this._options.ribbonOptions}}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions()}_createVertexBuffers(e=!1){const t=new ot.P;return t.positions=this._vertexPositions,t.indices=this._indices,t.uvs=this._uvs,e&&(t.normals=[],ot.P.ComputeNormals(this._vertexPositions,this._indices,t.normals)),t.applyToMesh(this,this._options.updatable),t}_createOffsetsBuffer(e){const t=this._scene.getEngine(),i=new Ot.h(t,e,this._updatable,3);this.setVerticesBuffer(i.createVertexBuffer("grl_offsets",0,3)),this._offsetsBuffer=i}}tt.e._GreasedLineMeshParser=(e,t)=>HS.Parse(e,t);class HS extends WS{constructor(e,t,i){super(e,t,i),this.name=e,this.intersectionThreshold=.1,this._previousAndSide=[],this._nextAndCounters=[],i.points&&this.addPoints(Ov.ConvertPoints(i.points))}getClassName(){return"GreasedLineMesh"}_updateColorPointers(){if(this._options.colorPointers)return;let e=0;this._colorPointers=[],this._points.forEach((t=>{for(let i=0;i<t.length;i+=3)this._colorPointers.push(e),this._colorPointers.push(e++)}))}_updateWidths(){}_setPoints(e){this._points=e,this._options.points=e,this._initGreasedLine();let t=0,i=0,r=0,s=0,n=0;e.forEach((e=>{i+=2*e.length,r+=2*(e.length-3),s+=4*e.length/3,n+=8*e.length/3}));const o=new Float32Array(i),a=i>65535?new Uint32Array(r):new Uint16Array(r),l=new Float32Array(s),h=new Float32Array(n),c=new Float32Array(n);let u=0,d=0,p=0,m=0,f=0;e.forEach((e=>{const i=Ov.GetLineLengthArray(e),r=i[i.length-1];for(let i=0,r=0;r<e.length;i++,r+=3){const s=u+2*r;if(o[s+0]=e[r+0],o[s+1]=e[r+1],o[s+2]=e[r+2],o[s+3]=e[r+0],o[s+4]=e[r+1],o[s+5]=e[r+2],r<e.length-3){const e=2*i+t,s=d+2*r;a[s+0]=e,a[s+1]=e+1,a[s+2]=e+2,a[s+3]=e+2,a[s+4]=e+1,a[s+5]=e+3}}t+=e.length/3*2;const s=2*e.length,n=o.subarray(u,u+s);u+=s,d+=2*(e.length-3);const _=new Float32Array(n.length),g=new Float32Array(n.length),x=n.length/6;let v;v=HS._CompareV3(0,x-1,n)?n.subarray(6*(x-2),6*(x-1)):n.subarray(0,6),_.set(v),_.set(n.subarray(0,n.length-6),6),g.set(n.subarray(6)),v=HS._CompareV3(x-1,0,n)?n.subarray(6,12):n.subarray(6*(x-1),6*x),g.set(v,g.length-6);for(let e=0,t=n.length/3;e<t;e++)h[m++]=_[3*e],h[m++]=_[3*e+1],h[m++]=_[3*e+2],h[m++]=1-((1&e)<<1),c[f++]=g[3*e],c[f++]=g[3*e+1],c[f++]=g[3*e+2],c[f++]=i[e>>1]/r;if(this._options.uvs)for(let e=0;e<this._options.uvs.length;e++)l[p++]=this._options.uvs[e];else for(let e=0;e<x;e++){const t=i[e]/r,s=p+4*e;l[s+0]=t,l[s+1]=0,l[s+2]=t,l[s+3]=1}})),this._vertexPositions=o,this._indices=a,this._uvs=l,this._previousAndSide=h,this._nextAndCounters=c,this._lazy||(this._options.colorPointers||this._updateColorPointers(),this._createVertexBuffers(),!this.doNotSyncBoundingInfo&&this.refreshBoundingInfo())}clone(e=`${this.name}-cloned`,t){const i=this._createLineOptions(),r={};E.r.DeepCopy(i,r,["instance"],void 0,!0);const s=new HS(e,this._scene,r);return t&&(s.parent=t),s.material=this.material,s}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions()}static Parse(e,t){const i=e.lineOptions,r=e.name;return new HS(r,t,i)}_initGreasedLine(){super._initGreasedLine(),this._previousAndSide=[],this._nextAndCounters=[]}intersects(e,t,i,r=!1,s,n=!1){const o=new Xr.G,a=this.findAllIntersections(e,t,i,r,s,n,!0);if(1===a?.length){const t=a[0];o.hit=!0,o.distance=t.distance,o.ray=e,o.pickedMesh=this,o.pickedPoint=t.point}return o}findAllIntersections(e,t,i,r=!1,s,n=!1,o=!1){if(r&&!n&&!1===e.intersectsSphere(this._boundingSphere,this.intersectionThreshold))return;const a=this.getIndices(),l=this.getVerticesData(Ot.R.PositionKind),h=this._widths,c=this.greasedLineMaterial?.width??1,u=[];if(a&&l&&h){let t=0,i=0;for(t=0,i=a.length-1;t<i;t+=3){const i=a[t],r=a[t+1];HS._V_START.fromArray(l,3*i),HS._V_END.fromArray(l,3*r),this._offsets&&(HS._V_OFFSET_START.fromArray(this._offsets,3*i),HS._V_OFFSET_END.fromArray(this._offsets,3*r),HS._V_START.addInPlace(HS._V_OFFSET_START),HS._V_END.addInPlace(HS._V_OFFSET_END));const s=Math.floor(t/3),n=void 0!==h[s]?h[s]:1,d=this.intersectionThreshold*(c*n)/2,p=e.intersectionSegment(HS._V_START,HS._V_END,d);if(-1!==p&&(u.push({distance:p,point:e.direction.normalize().multiplyByFloats(p,p,p).add(e.origin)}),o))return u}t=i}return u}get _boundingSphere(){return this.getBoundingInfo().boundingSphere}static _CompareV3(e,t,i){const r=6*e,s=6*t;return i[r]===i[s]&&i[r+1]===i[s+1]&&i[r+2]===i[s+2]}_createVertexBuffers(){const e=super._createVertexBuffers(),t=this._scene.getEngine(),i=new Ot.h(t,this._previousAndSide,!1,4);this.setVerticesBuffer(i.createVertexBuffer("grl_previousAndSide",0,4));const r=new Ot.h(t,this._nextAndCounters,!1,4);this.setVerticesBuffer(r.createVertexBuffer("grl_nextAndCounters",0,4));const s=new Ot.h(t,this._widths,this._updatable,1);this.setVerticesBuffer(s.createVertexBuffer("grl_widths",0,1)),this._widthsBuffer=s;const n=new Ot.h(t,this._colorPointers,this._updatable,1);return this.setVerticesBuffer(n.createVertexBuffer("grl_colorPointers",0,1)),this._colorPointersBuffer=n,e}}HS._V_START=new n.Pq,HS._V_END=new n.Pq,HS._V_OFFSET_START=new n.Pq,HS._V_OFFSET_END=new n.Pq,tt.e._GreasedLineRibbonMeshParser=(e,t)=>$S.Parse(e,t);class $S extends WS{constructor(e,t,i,r){if(super(e,t,i),this.name=e,!i.ribbonOptions)throw"'GreasedLineMeshOptions.ribbonOptions' is not set.";this._paths=[],this._counters=[],this._slopes=[],this._widths=i.widths??[],this._ribbonWidths=[],this._pathsOptions=r??[],i.points&&this.addPoints(Ov.ConvertPoints(i.points),i,!!r)}addPoints(e,t,i=!1){if(!t.ribbonOptions)throw"addPoints() on GreasedLineRibbonMesh instance requires 'GreasedLineMeshOptions.ribbonOptions'.";i||this._pathsOptions.push({options:t,pathCount:e.length}),super.addPoints(e,t)}getClassName(){return"GreasedLineRibbonMesh"}get isFlatLine(){return this._paths.length<3}get slopes(){return this._slopes}set slopes(e){this._slopes=e}_updateColorPointers(){if(this._options.colorPointers)return;let e=0;this._colorPointers=[];for(let t=0;t<this._pathsOptions.length;t++){const{options:i,pathCount:r}=this._pathsOptions[t],s=this._points[t];if(0===i.ribbonOptions.pointsMode)for(let t=0;t<r;t++)for(let t=0;t<s.length;t+=3)this._colorPointers.push(e),this._colorPointers.push(e++);else for(let t=0;t<s.length;t+=3){for(let t=0;t<r;t++)this._colorPointers.push(e);e++}}}_updateWidths(){super._updateWidthsWithValue(1)}_setPoints(e,t){if(!this._options.ribbonOptions)throw"No 'GreasedLineMeshOptions.ribbonOptions' provided.";this._points=e,this._options.points=e,this._initGreasedLine();let i,r=0;for(let t=0,s=0;t<this._pathsOptions.length;t++){const{options:n,pathCount:o}=this._pathsOptions[t],a=e.slice(s,s+o);if(s+=o,1===n.ribbonOptions?.pointsMode)r=this._preprocess(Ov.ToVector3Array(a),r,n);else{if(99===n.ribbonOptions?.directionsAutoMode){if(!n.ribbonOptions.directions)throw"In GreasedLineRibbonAutoDirectionMode.AUTO_DIRECTIONS_NONE 'GreasedLineMeshOptions.ribbonOptions.directions' must be defined.";i=$S._GetDirectionPlanesFromDirectionsOption(a.length,n.ribbonOptions.directions)}a.forEach(((e,t)=>{const s=$S._ConvertToRibbonPath(e,n.ribbonOptions,this._scene.useRightHandedSystem,i?i[t]:i);r=this._preprocess(s,r,n)}))}}this._lazy||(this._createVertexBuffers(),!this.doNotSyncBoundingInfo&&this.refreshBoundingInfo())}static _GetDirectionPlanesFromDirectionsOption(e,t){return Array.isArray(t)?t:new Array(e).fill(t)}static _CreateRibbonVertexData(e,t){const i=e.length;if(i<2)throw"Minimum of two paths are required to create a GreasedLineRibbonMesh.";const r=[],s=[],n=e[0];for(let t=0;t<n.length;t++)for(let i=0;i<e.length;i++){const s=e[i][t];r.push(s.x,s.y,s.z)}const o=[1,0,i],a=2===t.ribbonOptions?.facesMode,l=1===t.ribbonOptions?.pointsMode&&t.ribbonOptions.closePath;if(i>2)for(let e=0;e<n.length-1;e++){o[0]=1+i*e,o[1]=i*e,o[2]=(e+1)*i;for(let e=0;e<2*(i-1);e++)e%2!=0&&(o[2]+=1),e%2==0&&e>0&&(o[0]+=1,o[1]+=1),s.push(o[1]+(e%2!=0?i:0),o[0],o[2]),a&&s.push(o[0],o[1]+(e%2!=0?i:0),o[2])}else for(let e=0;e<r.length/3-3;e+=2)s.push(e,e+1,e+2),s.push(e+2,e+1,e+3),a&&(s.push(e+1,e,e+2),s.push(e+1,e+2,e+3));if(l){let e=i*(n.length-1);for(let t=0;t<i-1;t++)s.push(e,t+1,t),s.push(e+1,t+1,e),a&&(s.push(t,t+1,e),s.push(e,t+1,e+1)),e++}return{positions:r,indices:s}}_preprocess(e,t,i){this._paths=e;const r=$S._CreateRibbonVertexData(e,i),s=r.positions;if(!this._options.widths)throw"No 'GreasedLineMeshOptions.widths' table is specified.";const n=Array.isArray(this._vertexPositions)?this._vertexPositions:Array.from(this._vertexPositions);this._vertexPositions=n;const o=Array.isArray(this._uvs)?this._uvs:Array.from(this._uvs);this._uvs=o;const a=Array.isArray(this._indices)?this._indices:Array.from(this._indices);this._indices=a;for(const e of s)n.push(e);let l=e;if(1===i.ribbonOptions?.pointsMode&&i.ribbonOptions.closePath){l=[];for(let t=0;t<e.length;t++){const i=e[t].slice();i.push(e[t][0].clone()),l.push(i)}}this._calculateSegmentLengths(l);const h=l.length,c=new Array(h).fill(0);for(let e=0;e<l[0].length;e++){let t=0;for(let i=0;i<h;i++){const r=c[i]+this._vSegmentLengths[i][e]/this._vTotalLengths[i];this._counters.push(r),o.push(r,t),c[i]=r,t+=this._uSegmentLengths[e][i]/this._uTotalLengths[e]}}for(let e=0,t=0;e<l[0].length;e++){const i=this._uSegmentLengths[e][0]/2,r=this._uSegmentLengths[e][h-1]/2;this._ribbonWidths.push(((this._widths[t++]??1)-1)*i);for(let e=0;e<h-2;e++)this._ribbonWidths.push(0);this._ribbonWidths.push(((this._widths[t++]??1)-1)*r)}const u=1===i.ribbonOptions?.pointsMode?new Array(l[0].length*l.length*6).fill(0):$S._CalculateSlopes(l);for(const e of u)this._slopes.push(e);if(r.indices)for(let e=0;e<r.indices.length;e++)a.push(r.indices[e]+t);return t+=s.length/3}static _ConvertToRibbonPath(e,t,i,r){if(0===t.pointsMode&&!t.width)throw"'GreasedLineMeshOptions.ribbonOptiosn.width' must be specified in GreasedLineRibbonPointsMode.POINTS_MODE_POINTS.";const s=[],o=[];if(0===t.pointsMode){const a=t.width/2,l=Ov.ToVector3Array(e);let h=null,c=null;if(0===t.directionsAutoMode&&(r=$S._GetDirectionFromPoints(l[0],l[1],null)),3===t.directionsAutoMode&&!(t.directions instanceof n.Pq))throw"In GreasedLineRibbonAutoDirectionMode.AUTO_DIRECTIONS_FACE_TO 'GreasedLineMeshOptions.ribbonOptions.directions' must be a Vector3.";n.AA.Vector3[1]=t.directions instanceof n.Pq?t.directions:$S.DIRECTION_XZ;for(let e=0;e<l.length-(r?0:1);e++){const u=l[e],d=l[e+1];if(r)h=r;else if(3===t.directionsAutoMode)d.subtractToRef(u,n.AA.Vector3[0]),h=n.Pq.CrossToRef(n.AA.Vector3[0],n.AA.Vector3[1],n.AA.Vector3[2]).normalize();else if(1===t.directionsAutoMode)h=$S._GetDirectionFromPoints(u,d,h);else{const e=d.subtract(u);e.applyRotationQuaternionInPlace(e.x>e.y&&e.x>e.z?i?$S._RightHandedForwardReadOnlyQuaternion:$S._LeftHandedForwardReadOnlyQuaternion:$S._LeftReadOnlyQuaternion),h=e.normalize()}c=h.multiplyByFloats(a,a,a),s.push(u.add(c)),o.push(u.subtract(c))}r||(s.push(l[l.length-1].add(c)),o.push(l[l.length-1].subtract(c)))}return[s,o]}static _GetDirectionFromPoints(e,t,i){return e.x!==t.x||i&&1!==i?.x?e.y===t.y?$S.DIRECTION_XZ:e.z===t.z?$S.DIRECTION_XY:$S.DIRECTION_XZ:$S.DIRECTION_YZ}clone(e=`${this.name}-cloned`,t){const i=this._createLineOptions(),r={},s=[];E.r.DeepCopy(this._pathsOptions,s,void 0,void 0,!0),E.r.DeepCopy(i,r,["instance"],void 0,!0);const n=new $S(e,this._scene,r,s);return t&&(n.parent=t),n.material=this.material,n}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions(),e.pathsOptions=this._pathsOptions}static Parse(e,t){const i=e.lineOptions,r=e.name,s=e.pathOptions;return new $S(r,t,i,s)}_initGreasedLine(){super._initGreasedLine(),this._paths=[],this._counters=[],this._slopes=[],this._ribbonWidths=[]}_calculateSegmentLengths(e){const t=e.length;this._vSegmentLengths=new Array(t),this._vTotalLengths=new Array(t);let i=0;for(let r=0;r<t;r++){const t=e[r];this._vSegmentLengths[r]=[0],i=0;for(let e=0;e<t.length-1;e++){const s=Math.abs(t[e].subtract(t[e+1]).lengthSquared());i+=s,this._vSegmentLengths[r].push(s)}this._vTotalLengths[r]=i}const r=e[0].length;this._uSegmentLengths=new Array(r).fill([]),this._uTotalLengths=new Array(r).fill([]);const s=new n.Pq;for(let n=0;n<r;n++){i=0;for(let r=1;r<t;r++){e[r][n].subtractToRef(e[r-1][n],s);const t=s.length();i+=t,this._uSegmentLengths[n].push(t)}this._uTotalLengths[n]=i}}static _CalculateSlopes(e){const t=e[0],i=2===e.length?e[1]:e[e.length-1],r=[],s=new n.Pq;for(let n=0;n<t.length;n++)for(let o=0;o<e.length;o++)0===o||o===e.length-1?(t[n].subtract(i[n]).normalizeToRef(s),r.push(s.x,s.y,s.z),r.push(-s.x,-s.y,-s.z)):r.push(0,0,0,0,0,0);return r}_createVertexBuffers(){this._uvs=this._options.uvs??this._uvs;const e=super._createVertexBuffers(this._options.ribbonOptions?.smoothShading),t=new Ot.h(this._engine,this._counters,this._updatable,1);this.setVerticesBuffer(t.createVertexBuffer("grl_counters",0,1));const i=new Ot.h(this._engine,this._colorPointers,this._updatable,1);this.setVerticesBuffer(i.createVertexBuffer("grl_colorPointers",0,1));const r=new Ot.h(this._engine,this._slopes,this._updatable,3);this.setVerticesBuffer(r.createVertexBuffer("grl_slopes",0,3));const s=new Ot.h(this._engine,this._ribbonWidths,this._updatable,1);return this.setVerticesBuffer(s.createVertexBuffer("grl_widths",0,1)),this._widthsBuffer=s,e}}function qS(e,t,i){let r;switch(i=i??C.q.LastCreatedScene,t.materialType){case 1:r=new Qu.Y(e,i,t.forceGLSL),new wv(r,i,t);break;case 2:r=new Bv(e,i,t);break;default:r=new br.F(e,i,t.forceGLSL),new wv(r,i,t)}return r}function YS(e,t,i,r){let s;r=r??C.q.LastCreatedScene;const n=Ov.ConvertPoints(t.points,t.pointsOptions);t.widthDistribution=t.widthDistribution??3,t.ribbonOptions&&(t.ribbonOptions.facesMode=t.ribbonOptions.facesMode??1,t.ribbonOptions.pointsMode=t.ribbonOptions.pointsMode??0,t.ribbonOptions.directionsAutoMode=t.ribbonOptions.directionsAutoMode??(t.ribbonOptions.directions?99:0)),(i=i??{color:Dv.DEFAULT_COLOR}).createAndAssignMaterial=i.createAndAssignMaterial??!0,i.colorDistribution=i?.colorDistribution??3,i.materialType=i.materialType??0;const o=XS(n),a=jS(o,t.widths??[],t.widthDistribution),l=i?.colors?ZS(o,i.colors,i.colorDistribution,i.color??Dv.DEFAULT_COLOR):void 0,h={points:n,updatable:t.updatable,widths:a,lazy:t.lazy,ribbonOptions:t.ribbonOptions,uvs:t.uvs,colorPointers:t.colorPointers};if(h.ribbonOptions&&0===h.ribbonOptions.pointsMode&&(h.ribbonOptions.width=i.width??h.ribbonOptions.width??Dv.DEFAULT_WIDTH),t.instance)if(s=t.instance,s instanceof $S)s.addPoints(n,h);else{const e=s.widths;if(e){const t=e.slice();for(const e of a)t.push(e);s.widths=t}else s.widths=a;if(s.addPoints(n),t.uvs){const e=s.uvs;if(e){const i=new Float32Array(e.length+t.uvs.length);i.set(e,0),i.set(t.uvs,e.length),s.uvs=i}else s.uvs=t.uvs}}else if(s=h.ribbonOptions?new $S(e,r,h):new HS(e,r,h),i){const n={materialType:i.materialType,dashCount:i.dashCount,dashOffset:i.dashOffset,dashRatio:i.dashRatio,resolution:i.resolution,sizeAttenuation:i.sizeAttenuation,useColors:i.useColors,useDash:i.useDash,visibility:i.visibility,width:i.width,color:i.color,colorMode:i.colorMode,colorsSampling:i.colorsSampling,colorDistributionType:i.colorDistributionType,colors:l,cameraFacing:!t.ribbonOptions,colorsTexture:i.colorsTexture};if(i.createAndAssignMaterial){const i=qS(e,n,r);s.material=i,1===t.ribbonOptions?.facesMode&&(i.backFaceCulling=!1)}}if(l&&t.instance&&t.instance.greasedLineMaterial){const e=t.instance.greasedLineMaterial.colors;if(e){const i=e.concat(l);t.instance.greasedLineMaterial.setColors(i,s.isLazy())}}return s}function XS(e){let t=0;for(const i of e)t+=i.length/3;return t}function jS(e,t,i,r=1,s=1){const n=e-t.length/2,o=[];if(n<0)return t.slice(0,2*e);if(n>0){if(t.length%2!=0&&t.push(r),5===i){const e=Math.floor(t.length/2);for(let i=0,r=0;i<e-1;i++)o.push(t[r++]),o.push(t[r++]);const i=t[e/2],r=t[e/2+1];for(let e=0;e<n;e++)o.push(r),o.push(i);for(let i=e;i<t.length;i+=2)o.push(t[i]),o.push(t[i+1])}else if(3===i){for(let e=0;e<t.length;e+=2)o.push(t[e]),o.push(t[e+1]);for(let e=0;e<n;e++)o.push(r),o.push(s)}else if(4===i){for(let e=0;e<n;e++)o.push(r),o.push(s);for(let e=0;e<t.length;e+=2)o.push(t[e]),o.push(t[e+1])}else if(1===i){let i=0;for(let r=0;r<e;r++)o.push(t[i++]),o.push(t[i++]),i===t.length&&(i=0)}else if(2===i){let i=0;const r=t.length/(2*(e-1));for(let s=0;s<e;s++){const e=Math.floor(i);o.push(t[e]),o.push(t[e+1]),i+=r}}}else for(let e=0;e<t.length;e++)o.push(t[e]);return o}function ZS(e,t,i,r){const s=(e=Math.max(t.length,e))-t.length;if(s<0)return t.slice(0,e);const n=[];if(s>0){if(5===i){const e=Math.floor(t.length/2);for(let i=0;i<e;i++)n.push(t[i]);for(let e=0;e<s-1;e++)n.push(r);for(let i=e;i<t.length;i++)n.push(t[i])}else if(3===i){for(let e=0;e<t.length;e++)n.push(t[e]);for(let e=0;e<s;e++)n.push(r)}else if(4===i){for(let e=0;e<s-1;e++)n.push(r);for(let e=0;e<t.length;e++)n.push(t[e])}else if(1===i){let i=0;for(let r=0;r<e;r++)n.push(t[i]),i++,i===t.length&&(i=0)}else if(2===i){let i=0;const r=t.length/(e-1);for(let s=0;s<e-1;s++){const e=Math.floor(i);n.push(t[e]),i+=r}}else if(0===i)for(let e=0;e<t.length;e++)n.push(t[e])}else for(let i=0;i<e;i++)n.push(t[i]);return n}$S.DEFAULT_WIDTH=.1,$S._RightHandedForwardReadOnlyQuaternion=n.PT.RotationAxis(n.Pq.RightHandedForwardReadOnly,Math.PI/2),$S._LeftHandedForwardReadOnlyQuaternion=n.PT.RotationAxis(n.Pq.LeftHandedForwardReadOnly,Math.PI/2),$S._LeftReadOnlyQuaternion=n.PT.RotationAxis(n.Pq.LeftReadOnly,Math.PI/2),$S.DIRECTION_XY=n.Pq.LeftHandedForwardReadOnly,$S.DIRECTION_XZ=n.Pq.UpReadOnly,$S.DIRECTION_YZ=n.Pq.LeftReadOnly,function(e){e[e.COLOR_DISTRIBUTION_NONE=0]="COLOR_DISTRIBUTION_NONE",e[e.COLOR_DISTRIBUTION_REPEAT=1]="COLOR_DISTRIBUTION_REPEAT",e[e.COLOR_DISTRIBUTION_EVEN=2]="COLOR_DISTRIBUTION_EVEN",e[e.COLOR_DISTRIBUTION_START=3]="COLOR_DISTRIBUTION_START",e[e.COLOR_DISTRIBUTION_END=4]="COLOR_DISTRIBUTION_END",e[e.COLOR_DISTRIBUTION_START_END=5]="COLOR_DISTRIBUTION_START_END"}(GS||(GS={})),function(e){e[e.WIDTH_DISTRIBUTION_NONE=0]="WIDTH_DISTRIBUTION_NONE",e[e.WIDTH_DISTRIBUTION_REPEAT=1]="WIDTH_DISTRIBUTION_REPEAT",e[e.WIDTH_DISTRIBUTION_EVEN=2]="WIDTH_DISTRIBUTION_EVEN",e[e.WIDTH_DISTRIBUTION_START=3]="WIDTH_DISTRIBUTION_START",e[e.WIDTH_DISTRIBUTION_END=4]="WIDTH_DISTRIBUTION_END",e[e.WIDTH_DISTRIBUTION_START_END=5]="WIDTH_DISTRIBUTION_START_END"}(zS||(zS={}));var QS=i(54329),KS=i(26635);let JS,eb,tb,ib,rb=0;class sb{get numProp(){return this._numProp}constructor(e,t,i){this._manifold=e,this._numProp=t,this._vertexStructure=i}_process(e,t){if(this.numProp!==t.numProp)throw new Error("CSG must be used with geometries having the same number of properties");return new sb(JS[e](this._manifold,t._manifold),this.numProp,this._vertexStructure)}subtract(e){return this._process("difference",e)}intersect(e){return this._process("intersection",e)}add(e){return this._process("union",e)}printDebug(){m.V.Log("Genus:"+this._manifold.genus());const e=this._manifold.getProperties();m.V.Log("Volume:"+e.volume),m.V.Log("surface area:"+e.surfaceArea)}toVertexData(e){const t={rebuildNormals:!1,...e},i=new ot.P,r=this._vertexStructure.find((e=>e.kind===Ot.R.NormalKind)),s=this._manifold.getMesh(t.rebuildNormals&&r?[3,4,5]:void 0);i.indices=s.triVerts.length>65535?new Uint32Array(s.triVerts):new Uint16Array(s.triVerts);for(let e=0;e<s.triVerts.length;e+=3)i.indices[e]=s.triVerts[e+2],i.indices[e+1]=s.triVerts[e+1],i.indices[e+2]=s.triVerts[e];const n=s.vertProperties.length/s.numProp;let o=0;for(let e=0;e<this._vertexStructure.length;e++){const t=this._vertexStructure[e],r=new Float32Array(n*t.stride);for(let e=0;e<n;e++)for(let i=0;i<t.stride;i++)r[e*t.stride+i]=s.vertProperties[e*s.numProp+o+i];i.set(r,t.kind),o+=t.stride}return i}toMesh(e,t,i){const r={rebuildNormals:!1,centerMesh:!0,...i},s=this.toVertexData({rebuildNormals:r.rebuildNormals}),n=this._vertexStructure.find((e=>e.kind===Ot.R.NormalKind)),o=this._manifold.getMesh(r.rebuildNormals&&n?[3,4,5]:void 0),a=o.vertProperties.length/o.numProp,l=new tt.e(e,t);if(s.applyToMesh(l),r.centerMesh){const e=l.getBoundingInfo().boundingSphere.center;l.position.set(-e.x,-e.y,-e.z),l.bakeCurrentTransformIntoVertices()}let h=o.runOriginalID[0],c=o.runIndex[0],u=0;const d=[];t=l.getScene();for(let e=0;e<o.numRun;++e){const i=o.runOriginalID[e+1];if(i!==h){const r=o.runIndex[e+1];new ip.K(u,0,a,c,r-c,l),d.push(t.getMaterialByUniqueID(h-ib)||t.defaultMaterial),h=i,c=r,u++}}if(r.materialToUse)l.material=r.materialToUse;else if(d.length>1){const i=new gm.F(e,t);i.subMaterials=d,l.material=i}else l.subMeshes.length>1&&l._createGlobalSubMesh(!0),l.material=d[0];return l}dispose(){this._manifold&&(this._manifold.delete(),this._manifold=null)}static _ProcessData(e,t,i,r,s,n){const o=new Float32Array(e*i.reduce(((e,t)=>e+t.stride),0));for(let t=0;t<e;t++){let e=0;for(let s=0;s<i.length;s++){const n=i[s];for(let i=0;i<n.stride;i++)o[t*r+e+i]=n.data[t*n.stride+i];e+=n.stride}}const a=new tb({numProp:r,vertProperties:o,triVerts:t,runIndex:s,runOriginalID:n});let l;a.merge();try{l=new sb(new JS(a),r,i)}catch(e){throw new Error("Error while creating the CSG: "+e.message)}return l}static _Construct(e,t,i,r){const s=new Uint32Array(e.indices.length);for(let t=0;t<e.indices.length;t+=3)s[t]=e.indices[t+2],s[t+1]=e.indices[t+1],s[t+2]=e.indices[t];const o=new n.Pq;let a=3;const l=[{stride:3,kind:Ot.R.PositionKind}];if(t){const i=new Float32Array(e.positions.length);for(let r=0;r<e.positions.length;r+=3)n.Pq.TransformCoordinatesFromFloatsToRef(e.positions[r],e.positions[r+1],e.positions[r+2],t,o),o.toArray(i,r);l[0].data=i}else l[0].data=e.positions;const h=e.normals;if(h)if(a+=3,l.push({stride:3,kind:Ot.R.NormalKind}),t){const e=new Float32Array(h.length);for(let i=0;i<h.length;i+=3)n.Pq.TransformNormalFromFloatsToRef(h[i],h[i+1],h[i+2],t,o),o.toArray(e,i);l[1].data=e}else l[1].data=h;for(const t of[Ot.R.UVKind,Ot.R.UV2Kind,Ot.R.UV3Kind,Ot.R.UV4Kind,Ot.R.UV5Kind,Ot.R.UV6Kind]){const i=e[t===Ot.R.UVKind?"uvs":t];i&&(a+=2,l.push({stride:2,kind:t,data:i}))}const c=e.colors;return c&&(a+=4,l.push({stride:4,kind:Ot.R.ColorKind,data:c})),this._ProcessData(e.positions.length/3,s,l,a,i,r)}static FromVertexData(e){const t=e.positions,i=e.indices;if(!t||!i)throw new Error("The vertexData must at least have positions and indices");return this._Construct(e,null)}static FromMesh(e,t=!1){const i=e.getVerticesData(Ot.R.PositionKind),r=e.getIndices(),s=e.computeWorldMatrix(!0);if(!i||!r)throw new Error("The mesh must at least have positions and indices");const n=[...Array(e.subMeshes.length)].map(((t,i)=>e.subMeshes[i].indexStart)),o=e.material||e.getScene().defaultMaterial,a="MultiMaterial"===o.getClassName(),l=[...Array(e.subMeshes.length)].map(((t,i)=>a?ib+o.subMaterials[e.subMeshes[i].materialIndex].uniqueId:ib+o.uniqueId)),h=Array.from(n.keys());h.sort(((e,t)=>n[e]-n[t]));const c=new Uint32Array(h.map((e=>n[e]))),u=new Uint32Array(h.map((e=>l[e]))),d={positions:i,indices:r,normals:e.getVerticesData(Ot.R.NormalKind),colors:e.getVerticesData(Ot.R.ColorKind),uvs:e.getVerticesData(Ot.R.UVKind),uvs2:e.getVerticesData(Ot.R.UV2Kind),uvs3:e.getVerticesData(Ot.R.UV3Kind),uvs4:e.getVerticesData(Ot.R.UV4Kind),uvs5:e.getVerticesData(Ot.R.UV5Kind),uvs6:e.getVerticesData(Ot.R.UV6Kind)};return this._Construct(d,t?null:s,c,u)}}function nb(){return void 0!==JS}async function ob(e){const t={manifoldUrl:"https://unpkg.com/manifold-3d@3.0.1",...e};if(!JS)if(eb)await eb;else{if(t.manifoldInstance)JS=t.manifoldInstance,tb=t.manifoldMeshInstance;else{i=`\n            import Module from '${t.manifoldUrl}/manifold.js';\n            const wasm = await Module();\n            wasm.setup();\n            const {Manifold, Mesh} = wasm;\n            const returnedValue =  {Manifold, Mesh};\n        `,eb=new Promise(((e,t)=>{let s,n;if((0,Ai.BA)())s=window,n="window";else{if("undefined"==typeof self)return void t(new Error("Cannot load script module outside of a window or a worker"));s=self,n="self"}s._LoadScriptModuleResolve||(s._LoadScriptModuleResolve={}),s._LoadScriptModuleResolve[rb]=e,i+=`\n            ${n}._LoadScriptModuleResolve[${rb}](returnedValue);\n            ${n}._LoadScriptModuleResolve[${rb}] = undefined;\n        `,rb++,H.S0.LoadScript(i,void 0,((e,i)=>{t(i||new Error(e))}),r,!0)}));const e=await eb;JS=e.Manifold,tb=e.Mesh}var i,r;ib=JS.reserveIDs(65536)}}var ab=i(91480);const lb=Math.pow(10,4);function hb(e,t=lb){let i=(r=e*t)+(r>0?.5:-.5)|0;var r;return 0===i&&(i=0),`${i}`}function cb(e,t=lb){return`${hb(e.x,t)},${hb(e.y,t)},${hb(e.z,t)}`}function ub(e,t,i,r,s,n){for(let o=0;o<i;o++)e[t+o]=r[o],e[t+i+o]=s[o],e[t+2*i+o]=n[o]}function db(e){if(!e.indices||0===e.indices.length)return e;const t=[],i=[],r=[],s=e.indices,n=e.positions,o=e.normals,a=e.uvs;for(let e=0;e<s.length;e++){const l=s[e];t.push(n[3*l],n[3*l+1],n[3*l+2]),o&&i.push(o[3*l],o[3*l+1],o[3*l+2]),a&&r.push(a[2*l],a[2*l+1])}const l=new ot.P;return l.positions=t,i.length&&(l.normals=i),r.length&&(l.uvs=r),l}function pb(e,t,i,r){3!==r?e.set(t[2*i],t[2*i+1],0):e.fromArray(t,3*i)}function mb(e,t,i){const r=new n.Pq,s=new n.Pq,o=new n.Pq,a=new n.Pq,l=new n.Pq,h=new n.Pq;for(let n=0;n<t;n+=3){const t=3*n;r.set(e[t],e[t+1],e[t+2]),s.set(e[t+3],e[t+4],e[t+5]),o.set(e[t+6],e[t+7],e[t+8]),r.addToRef(s,a),a.scaleInPlace(.5),s.addToRef(o,l),l.scaleInPlace(.5),o.addToRef(r,h),h.scaleInPlace(.5),i.push(r.x,r.y,r.z,a.x,a.y,a.z,h.x,h.y,h.z),i.push(s.x,s.y,s.z,l.x,l.y,l.z,a.x,a.y,a.z),i.push(o.x,o.y,o.z,h.x,h.y,h.z,l.x,l.y,l.z),i.push(a.x,a.y,a.z,l.x,l.y,l.z,h.x,h.y,h.z)}}function fb(e){const t=db(e),i=t.positions,r=t.normals,s=t.uvs,n=i.length/3,o=[],a=[],l=[];if(mb(i,n,o),r&&r.length&&mb(r,n,a),s&&s.length)for(let e=0;e<n;e+=3){const t=2*e,i=[s[t],s[t+1]],r=[s[t+2],s[t+3]],n=[s[t+4],s[t+5]],o=[(i[0]+r[0])/2,(i[1]+r[1])/2],a=[(r[0]+n[0])/2,(r[1]+n[1])/2],h=[(n[0]+i[0])/2,(n[1]+i[1])/2];l.push(...i,...o,...h),l.push(...r,...a,...o),l.push(...n,...h,...a),l.push(...o,...a,...h)}const h=o.length/3,c=[];for(let e=0;e<h;e++)c.push(e);const u=new ot.P;return u.positions=o,a.length&&(u.normals=a),l.length&&(u.uvs=l),u.indices=c,u}function _b(e,t){const i=db(e),r=fb(i),s=function(e){const t=Object.keys(e).filter((t=>Array.isArray(e[t])));return Array.from(new Set(["positions","normals","uvs",...t]))}(i),o=i.positions,a=r.positions,l=o.length/3,h={},c={},u={},d={};function p(e,t,i){c[e]||(c[e]={}),c[e][t]||(c[e][t]=[]),c[e][t].push(i)}function m(e,t){u[e]||(u[e]=[]),u[e].push(t)}function f(e,t){d[e]||(d[e]=new Set),d[e].add(t)}const _=new n.Pq,g=new n.Pq,x=new n.Pq,v=new n.Pq,S=new n.Pq,b=new n.Pq,y=new n.Pq;for(let e=0;e<l;e+=3){pb(g,o,e,3),pb(x,o,e+1,3),pb(v,o,e+2,3);const t=cb(g),i=cb(x),r=cb(v);p(t,i,e+1),p(t,r,e+2),p(i,t,e),p(i,r,e+2),p(r,t,e),p(r,i,e+1),g.addToRef(x,S),S.scaleInPlace(.5),x.addToRef(v,b),b.scaleInPlace(.5),v.addToRef(g,y),y.scaleInPlace(.5),m(cb(S),e+2),m(cb(b),e),m(cb(y),e+1),f(t,cb(S)),f(t,cb(y)),f(i,cb(S)),f(i,cb(b)),f(r,cb(b)),f(r,cb(y))}for(let e=0;e<a.length/3;e++){pb(_,a,e,3);const t=cb(_);h[t]||(h[t]=[]),h[t].push(e)}const P=[new n.Pq,new n.Pq,new n.Pq],T=[new n.Pq,new n.Pq,new n.Pq],C=new n.Pq,E=new n.Pq;const A=new ot.P;s.forEach((e=>{if("indices"===e)return;const s=i[e],n=r[e];if(!s||!n)return;const o=function(e,i,r){const s="uvs"===e?2:3,n=a.length/3,o=new Array(n*s);let l=0;for(let p=0;p<n;p+=3){for(let n=0;n<3;n++)if("uvs"!==e||t.uvSmooth)if("normals"===e){pb(T[n],a,p+n,3);const e=cb(T[n]),t=h[e]||[],i=t.length,s=.75/i,o=1-s*i;pb(P[n],r,p+n,3),P[n].scaleInPlace(o),t.forEach((e=>{pb(C,r,e,3),C.scaleInPlace(s),P[n].addInPlace(C)}))}else{pb(P[n],r,p+n,s),pb(T[n],a,p+n,3);const e=cb(T[n]),o=c[e],l=u[e];if(o){if(t.preserveEdges){const t=d[e];let i=!0;if(t.forEach((e=>{u[e]&&u[e].length%2!=0&&(i=!1)})),!i)continue}const r=Object.keys(o).length,a=1/r*(5/8-Math.pow(3/8+1/4*Math.cos(2*Math.PI/r),2)),l=1/r/r,h=Kv.X.Lerp(l,a,t.weight),c=1-h*r;P[n].scaleInPlace(c);for(const e in o){const t=o[e];C.set(0,0,0),t.forEach((e=>{pb(E,i,e,s),C.addInPlace(E)})),C.scaleInPlace(1/t.length),C.scaleInPlace(h),P[n].addInPlace(C)}}else if(l&&2===l.length){const e=l.length,t=.125,r=1-t*e;P[n].scaleInPlace(r),l.forEach((e=>{pb(C,i,e,s),C.scaleInPlace(t),P[n].addInPlace(C)}))}}else pb(P[n],r,p+n,2);ub(o,l,s,P[0].asArray(),P[1].asArray(),P[2].asArray()),l+=3*s}return o}(e,s,n);A[e]=o}));const I=A.positions,R=[];for(let e=0;e<I.length/3;e++)R.push(e);return A.indices=R,A}function gb(e,t,i){if(i={flatOnly:!1,uvSmooth:!1,preserveEdges:!1,weight:1,...i},!e.positions||0===e.positions.length||t<=0)return e;let r=e.clone();for(let e=0;e<t;e++)r=i.flatOnly?fb(r):_b(r,i);return r}var xb,vb,Sb,bb,yb,Pb,Tb,Cb,Eb;i(90203);!function(e){e[e.Int=1]="Int",e[e.Float=2]="Float",e[e.Vector2=4]="Vector2",e[e.Vector3=8]="Vector3",e[e.Vector4=16]="Vector4",e[e.Matrix=32]="Matrix",e[e.Geometry=64]="Geometry",e[e.Texture=128]="Texture",e[e.AutoDetect=1024]="AutoDetect",e[e.BasedOnInput=2048]="BasedOnInput",e[e.Undefined=4096]="Undefined",e[e.All=4095]="All"}(xb||(xb={})),function(e){e[e.Compatible=0]="Compatible",e[e.TypeIncompatible=1]="TypeIncompatible",e[e.HierarchyIssue=2]="HierarchyIssue"}(vb||(vb={})),function(e){e[e.Input=0]="Input",e[e.Output=1]="Output"}(Sb||(Sb={}));class Ab{get direction(){return this._direction}get type(){if(this._type===xb.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource){if(this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type;if(this._linkedConnectionSource._defaultConnectionPointType)return this._linkedConnectionSource._defaultConnectionPointType}if(this._defaultConnectionPointType)return this._defaultConnectionPointType}if(this._type===xb.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get isConnected(){return null!==this.connectedPoint||this.hasEndpoints}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return 0===this._endpoints.length?[]:this._endpoints.map((e=>e.ownerBlock))}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get innerType(){return this._linkedConnectionSource&&!this._isMainLinkSource&&this._linkedConnectionSource.isConnected?this.type:this._type}_resetCounters(){this._callCount=0,this._executionCount=0}get callCount(){return this._callCount}get executionCount(){return this._executionCount}getConnectedValue(e){return this.isConnected?this._connectedPoint?._storedFunction?(this._connectedPoint._callCount++,this._connectedPoint._executionCount++,this._connectedPoint._storedFunction(e)):(this._connectedPoint._callCount++,this._connectedPoint._executionCount=1,this._connectedPoint._storedValue):(this._callCount++,this._executionCount=1,this.value)}constructor(e,t,i){this._connectedPoint=null,this._storedValue=null,this._storedFunction=null,this._acceptedConnectionPointType=null,this._endpoints=new Array,this._type=xb.Geometry,this._linkedConnectionSource=null,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this._isMainLinkSource=!1,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new s.cP,this.onDisconnectionObservable=new s.cP,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this.defaultValue=null,this.value=null,this.valueMin=null,this.valueMax=null,this._callCount=0,this._executionCount=0,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeGeometryConnectionPoint"}canConnectTo(e){return 0===this.checkCompatibilityState(e)}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(this.type!==e.type&&e.innerType!==xb.AutoDetect)return e.acceptedConnectionPointTypes&&-1!==e.acceptedConnectionPointTypes.indexOf(this.type)?0:1;if(e.excludedConnectionPointTypes&&-1!==e.excludedConnectionPointTypes.indexOf(this.type))return 1;let r=i,s=t;return 0===this.direction&&(r=t,s=i),r.isAnAncestorOf(s)?2:0}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return-1===t||(this._endpoints.splice(t,1),e._connectedPoint=null,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this)),this}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<xb.All;)e&t||this.excludedConnectionPointTypes.push(t),t<<=1}serialize(e=!0){const t={};return t.name=this.name,t.displayName=this.displayName,void 0!==this.value&&null!==this.value&&(this.value.asArray?(t.valueType="BABYLON."+this.value.getClassName(),t.value=this.value.asArray()):(t.valueType="number",t.value=this.value)),e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear()}}class Ib{get buildExecutionTime(){return this._buildExecutionTime}get inputs(){return this._inputs}get outputs(){return this._outputs}get name(){return this._name}set name(e){this._name=e}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isDebug(){return this._isDebug}get isUnique(){return this._isUnique}getClassName(){return"NodeGeometryBlock"}_inputRename(e){return e}_outputRename(e){return e}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints){if(i.ownerBlock===e)return!0;if(i.ownerBlock.isAnAncestorOf(e))return!0}return!1}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints)if(i.ownerBlock.isAnAncestorOfType(e))return!0;return!1}getDescendantOfPredicate(e){if(e(this))return this;for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints){const t=i.ownerBlock.getDescendantOfPredicate(e);if(t)return t}return null}get _isReadyState(){return null}constructor(e){this._name="",this._isInput=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._isDebug=!1,this._isUnique=!1,this._buildExecutionTime=0,this.onBuildObservable=new s.cP,this._inputs=new Array,this._outputs=new Array,this._codeVariableName="",this.visibleOnFrame=!1,this._name=e,this.uniqueId=Xl.K.UniqueId}registerInput(e,t,i=!1,r,s,n){const o=new Ab(e,this,0);return o.type=t,o.isOptional=i,o.defaultValue=r,o.value=r,o.valueMin=s,o.valueMax=n,this._inputs.push(o),this}registerOutput(e,t,i){return(i=i??new Ab(e,this,1)).type=t,this._outputs.push(i),this}_buildBlock(e){}_customBuildStep(e){}build(e){if(this._buildId===e.buildId)return!0;if(this._outputs.length>0){if(!this._outputs.some((e=>e.hasEndpoints))&&!this.isDebug)return!1;this.outputs.forEach((e=>e._resetCounters()))}this._buildId=e.buildId;for(const t of this._inputs){if(!t.connectedPoint){t.isOptional||e.notConnectedNonOptionalInputs.push(t);continue}const i=t.connectedPoint.ownerBlock;i&&i!==this&&i.build(e)}this._customBuildStep(e),e.verbose&&m.V.Log(`Building ${this.name} [${this.getClassName()}]`);const t=Md.j.Now;return this._buildBlock(e),this._buildExecutionTime=Md.j.Now-t,this.onBuildObservable.notifyObservers(this),!1}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:(this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[e]._isMainLinkSource=!0),this._inputs[t]._linkedConnectionSource=this._inputs[e]}initialize(){}autoConfigure(e){}getInputByName(e){const t=this._inputs.filter((t=>t.name===e));return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter((t=>t.name===e));return t.length?t[0]:null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.visibleOnFrame=this.visibleOnFrame,e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e){this._name=e.name,this.comments=e.comments,this.visibleOnFrame=!!e.visibleOnFrame,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;t&&t.forEach((e=>{const t=this.inputs.find((t=>t.name===e.name));if(t&&(e.displayName&&(t.displayName=e.displayName),e.isExposedOnFrame&&(t.isExposedOnFrame=e.isExposedOnFrame,t.exposedPortPosition=e.exposedPortPosition),void 0!==e.value&&null!==e.value))if("number"===e.valueType)t.value=e.value;else{const i=(0,a.n9)(e.valueType);i&&(t.value=i.FromArray(e.value))}})),i&&i.forEach(((e,t)=>{e.displayName&&(this.outputs[t].displayName=e.displayName),e.isExposedOnFrame&&(this.outputs[t].isExposedOnFrame=e.isExposedOnFrame,this.outputs[t].exposedPortPosition=e.exposedPortPosition)}))}_dumpPropertiesCode(){return`${this._codeVariableName}.visibleOnFrame = ${this.visibleOnFrame};\n`}_dumpCodeForOutputConnections(e){let t="";if(-1!==e.indexOf(this))return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const r=i.connectedPoint,s=r.ownerBlock;t+=s._dumpCodeForOutputConnections(e),t+=`${s._codeVariableName}.${s._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});\n`}return t}_dumpCode(e,t){t.push(this);const i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,-1!==e.indexOf(this._codeVariableName)){let t=0;do{t++,this._codeVariableName=i+t}while(-1!==e.indexOf(this._codeVariableName))}e.push(this._codeVariableName);let r=`\n// ${this.getClassName()}\n`;this.comments&&(r+=`// ${this.comments}\n`);const s=this.getClassName();if("GeometryInputBlock"===s){const e=this.type;r+=`var ${this._codeVariableName} = new BABYLON.GeometryInputBlock("${this.name}", ${e});\n`}else r+=`var ${this._codeVariableName} = new BABYLON.${s}("${this.name}");\n`;r+=this._dumpPropertiesCode();for(const i of this.inputs){if(!i.isConnected)continue;const s=i.connectedPoint.ownerBlock;-1===t.indexOf(s)&&(r+=s._dumpCode(e,t))}for(const i of this.outputs)if(i.hasEndpoints)for(const s of i.endpoints){const i=s.ownerBlock;i&&-1===t.indexOf(i)&&(r+=i._dumpCode(e,t))}return r}clone(){const e=this.serialize(),t=(0,a.n9)(e.customType);if(t){const i=new t;return i._deserialize(e),i}return null}dispose(){for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose();this.onBuildObservable.clear()}}(0,Ge.Cg)([(0,ze.lK)("comment")],Ib.prototype,"comments",void 0);class Rb extends Ib{get currentVertexData(){return this._vertexData}constructor(e){super(e),this._vertexData=null,this._isUnique=!0,this.registerInput("geometry",xb.Geometry)}getClassName(){return"GeometryOutputBlock"}get geometry(){return this._inputs[0]}_buildBlock(e){e.vertexData=this.geometry.getConnectedValue(e),this._vertexData=e.vertexData}}(0,a.Y5)("BABYLON.GeometryOutputBlock",Rb),function(e){e[e.None=0]="None",e[e.Positions=1]="Positions",e[e.Normals=2]="Normals",e[e.Tangents=3]="Tangents",e[e.UV=4]="UV",e[e.UV2=5]="UV2",e[e.UV3=6]="UV3",e[e.UV4=7]="UV4",e[e.UV5=8]="UV5",e[e.UV6=9]="UV6",e[e.Colors=10]="Colors",e[e.VertexID=11]="VertexID",e[e.FaceID=12]="FaceID",e[e.GeometryID=13]="GeometryID",e[e.CollectionID=14]="CollectionID",e[e.LoopID=15]="LoopID",e[e.InstanceID=16]="InstanceID",e[e.LatticeID=17]="LatticeID",e[e.LatticeControl=18]="LatticeControl"}(bb||(bb={}));class Mb{constructor(){this._rotationMatrix=new n.uq,this._scalingMatrix=new n.uq,this._positionMatrix=new n.uq,this._scalingRotationMatrix=new n.uq,this._transformMatrix=new n.uq,this._tempVector3=new n.Pq,this.notConnectedNonOptionalInputs=[],this.noContextualData=[],this.vertexData=null,this._geometryContext=null,this._executionContext=null,this._instancingContext=null,this._geometryContextStack=[],this._executionContextStack=[],this._instancingContextStack=[]}get geometryContext(){return this._geometryContext}get executionContext(){return this._executionContext}get instancingContext(){return this._instancingContext}pushGeometryContext(e){this._geometryContext=e,this._geometryContextStack.push(this._geometryContext)}pushExecutionContext(e){this._executionContext=e,this._executionContextStack.push(this._executionContext)}pushInstancingContext(e){this._instancingContext=e,this._instancingContextStack.push(this._instancingContext)}restoreGeometryContext(){this._geometryContextStack.pop(),this._geometryContext=this._geometryContextStack.length>0?this._geometryContextStack[this._geometryContextStack.length-1]:null}restoreExecutionContext(){this._executionContextStack.pop(),this._executionContext=this._executionContextStack.length>0?this._executionContextStack[this._executionContextStack.length-1]:null}restoreInstancingContext(){this._instancingContextStack.pop(),this._instancingContext=this._instancingContextStack.length>0?this._instancingContextStack[this._instancingContextStack.length-1]:null}getContextualValue(e,t=!1){if(!this.executionContext)return t||this.noContextualData.push(e),null;const i=this.executionContext.getExecutionIndex();switch(e){case bb.Positions:return this.executionContext.getOverridePositionsContextualValue?this.executionContext.getOverridePositionsContextualValue():this.geometryContext&&this.geometryContext.positions?n.Pq.FromArray(this.geometryContext.positions,3*i):n.Pq.Zero();case bb.Normals:return this.executionContext.getOverrideNormalsContextualValue?this.executionContext.getOverrideNormalsContextualValue():this.geometryContext&&this.geometryContext.normals?n.Pq.FromArray(this.geometryContext.normals,3*i):n.Pq.Zero();case bb.Colors:return this.geometryContext&&this.geometryContext.colors?n.IU.FromArray(this.geometryContext.colors,4*i):n.IU.Zero();case bb.Tangents:return this.geometryContext&&this.geometryContext.tangents?n.IU.FromArray(this.geometryContext.tangents,4*i):n.IU.Zero();case bb.UV:return this.executionContext.getOverrideUVs1ContextualValue?this.executionContext.getOverrideUVs1ContextualValue():this.geometryContext&&this.geometryContext.uvs?n.I9.FromArray(this.geometryContext.uvs,2*i):n.I9.Zero();case bb.UV2:return this.geometryContext&&this.geometryContext.uvs2?n.I9.FromArray(this.geometryContext.uvs2,2*i):n.I9.Zero();case bb.UV3:return this.geometryContext&&this.geometryContext.uvs3?n.I9.FromArray(this.geometryContext.uvs3,2*i):n.I9.Zero();case bb.UV4:return this.geometryContext&&this.geometryContext.uvs4?n.I9.FromArray(this.geometryContext.uvs4,2*i):n.I9.Zero();case bb.UV5:return this.geometryContext&&this.geometryContext.uvs5?n.I9.FromArray(this.geometryContext.uvs5,2*i):n.I9.Zero();case bb.UV6:return this.geometryContext&&this.geometryContext.uvs6?n.I9.FromArray(this.geometryContext.uvs6,2*i):n.I9.Zero();case bb.VertexID:return i;case bb.FaceID:return this.executionContext.getExecutionFaceIndex();case bb.LoopID:return this.executionContext.getExecutionLoopIndex();case bb.InstanceID:return this.instancingContext?this.instancingContext.getInstanceIndex():0;case bb.GeometryID:return this.geometryContext?this.geometryContext.uniqueId:0;case bb.CollectionID:return this.geometryContext&&this.geometryContext.metadata&&this.geometryContext.metadata.collectionId||0;case bb.LatticeID:return this.executionContext.getOverridePositionsContextualValue?this.executionContext.getOverridePositionsContextualValue():n.Pq.Zero();case bb.LatticeControl:return this.executionContext.getOverrideNormalsContextualValue?this.executionContext.getOverrideNormalsContextualValue():n.Pq.Zero()}return null}adapt(e,t){const i=e.getConnectedValue(this)||0;if(e.type===t)return i;switch(t){case xb.Vector2:return new n.I9(i,i);case xb.Vector3:return new n.Pq(i,i,i);case xb.Vector4:return new n.IU(i,i,i,i)}return null}adaptInput(e,t,i){if(!e.isConnected)return e.value||i;const r=e.getConnectedValue(this);if(e._connectedPoint?.type===t)return r;switch(t){case xb.Vector2:return new n.I9(r,r);case xb.Vector3:return new n.Pq(r,r,r);case xb.Vector4:return new n.IU(r,r,r,r)}return null}emitErrors(){let e="";for(const t of this.notConnectedNonOptionalInputs)e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.\n`;for(const t of this.noContextualData)e+=`Contextual input ${bb[t]} has no context to pull data from (must be connected to a setXXX block or a instantiateXXX block).\n`;if(e)throw"Build of NodeGeometry failed:\n"+e}_instantiate(e,t,i,r,s){n.uq.ScalingToRef(r.x,r.y,r.z,this._scalingMatrix),n.uq.RotationYawPitchRollToRef(i.y,i.x,i.z,this._rotationMatrix),n.uq.TranslationToRef(t.x,t.y,t.z,this._positionMatrix),this._scalingMatrix.multiplyToRef(this._rotationMatrix,this._scalingRotationMatrix),this._scalingRotationMatrix.multiplyToRef(this._positionMatrix,this._transformMatrix);for(let t=0;t<e.positions.length;t+=3)this._tempVector3.fromArray(e.positions,t),n.Pq.TransformCoordinatesToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.positions,t),e.normals&&(this._tempVector3.fromArray(e.normals,t),n.Pq.TransformNormalToRef(this._tempVector3,this._scalingRotationMatrix,this._tempVector3),this._tempVector3.toArray(e.normals,t));s.push(e)}_instantiateWithMatrix(e,t,i){for(let i=0;i<e.positions.length;i+=3)this._tempVector3.fromArray(e.positions,i),n.Pq.TransformCoordinatesToRef(this._tempVector3,t,this._tempVector3),this._tempVector3.toArray(e.positions,i),e.normals&&(this._tempVector3.fromArray(e.normals,i),n.Pq.TransformNormalToRef(this._tempVector3,t,this._tempVector3),this._tempVector3.toArray(e.normals,i));i.push(e)}_instantiateWithPositionAndMatrix(e,t,i,r){n.uq.TranslationToRef(t.x,t.y,t.z,this._positionMatrix),i.multiplyToRef(this._positionMatrix,this._transformMatrix);for(let t=0;t<e.positions.length;t+=3)this._tempVector3.fromArray(e.positions,t),n.Pq.TransformCoordinatesToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.positions,t),e.normals&&(this._tempVector3.fromArray(e.normals,t),n.Pq.TransformNormalToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.normals,t));r.push(e)}}class Db extends Ib{get type(){if(this._type===xb.AutoDetect&&null!=this.value){if(!isNaN(this.value))return this._type=xb.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=xb.Vector2,this._type;case"Vector3":return this._type=xb.Vector3,this._type;case"Vector4":return this._type=xb.Vector4,this._type;case"Matrix":return this._type=xb.Matrix,this._type}}return this._type}get isContextual(){return this._contextualSource!==bb.None}get contextualValue(){return this._contextualSource}set contextualValue(e){switch(this._contextualSource=e,e){case bb.Positions:case bb.Normals:case bb.LatticeID:case bb.LatticeControl:this._type=xb.Vector3;break;case bb.Colors:case bb.Tangents:this._type=xb.Vector4;break;case bb.UV:case bb.UV2:case bb.UV3:case bb.UV4:case bb.UV5:case bb.UV6:this._type=xb.Vector2;break;case bb.VertexID:case bb.GeometryID:case bb.CollectionID:case bb.FaceID:case bb.LoopID:case bb.InstanceID:this._type=xb.Int}this.output&&(this.output.type=this._type)}constructor(e,t=xb.AutoDetect){super(e),this._type=xb.Undefined,this._contextualSource=bb.None,this.min=0,this.max=0,this.groupInInspector="",this.displayInInspector=!0,this.onValueChangedObservable=new s.cP,this._type=t,this._isInput=!0,this.setDefaultValue(),this.registerOutput("output",t)}get value(){return this._storedValue}set value(e){this.type===xb.Float&&this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e)),this._storedValue=e,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e}getClassName(){return"GeometryInputBlock"}get output(){return this._outputs[0]}setDefaultValue(){switch(this.contextualValue=bb.None,this.type){case xb.Int:case xb.Float:this.value=0;break;case xb.Vector2:this.value=n.I9.Zero();break;case xb.Vector3:this.value=n.Pq.Zero();break;case xb.Vector4:this.value=n.IU.Zero();break;case xb.Matrix:this.value=n.uq.Identity()}}_buildBlock(e){super._buildBlock(e),this.isContextual?(this.output._storedValue=null,this.output._storedFunction=e=>e.getContextualValue(this._contextualSource)):(this.output._storedFunction=null,this.output._storedValue=this.value)}dispose(){this.onValueChangedObservable.clear(),super.dispose()}_dumpPropertiesCode(){const e=this._codeVariableName;if(this.isContextual)return super._dumpPropertiesCode()+`${e}.contextualValue = BABYLON.NodeGeometryContextualSources.${bb[this._contextualSource]};\n`;const t=[];let i="";switch(this.type){case xb.Float:case xb.Int:i=`${this.value}`;break;case xb.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case xb.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case xb.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`}return t.push(`${e}.value = ${i}`),this.type!==xb.Float&&this.type!==xb.Int||t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`),t.push(""),super._dumpPropertiesCode()+t.join(";\n")}serialize(){const e=super.serialize();return e.type=this.type,e.contextualValue=this.contextualValue,e.min=this.min,e.max=this.max,e.groupInInspector=this.groupInInspector,e.displayInInspector=this.displayInInspector,null===this._storedValue||this.isContextual||(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e){if(super._deserialize(e),this._type=e.type,this.contextualValue=e.contextualValue,this.min=e.min||0,this.max=e.max||0,this.groupInInspector=e.groupInInspector||"",void 0!==e.displayInInspector&&(this.displayInInspector=e.displayInInspector),e.valueType)if("number"===e.valueType)this._storedValue=e.value;else{const t=(0,a.n9)(e.valueType);t&&(this._storedValue=t.FromArray(e.value))}}}(0,a.Y5)("BABYLON.GeometryInputBlock",Db);class Ob extends Ib{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("size",xb.Float,!0,1),this.registerInput("width",xb.Float,!0,0),this.registerInput("height",xb.Float,!0,0),this.registerInput("depth",xb.Float,!0,0),this.registerInput("subdivisions",xb.Int,!0,1,0),this.registerInput("subdivisionsX",xb.Int,!0,0,0),this.registerInput("subdivisionsY",xb.Int,!0,0,0),this.registerInput("subdivisionsZ",xb.Int,!0,0,0),this.registerOutput("geometry",xb.Geometry)}getClassName(){return"BoxBlock"}get size(){return this._inputs[0]}get width(){return this._inputs[1]}get height(){return this._inputs[2]}get depth(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get subdivisionsX(){return this._inputs[5]}get subdivisionsY(){return this._inputs[6]}get subdivisionsZ(){return this._inputs[7]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.size.isConnected){if(!this.width.isConnected&&!this.height.isConnected&&!this.depth.isConnected){const e=new Db("Size");return e.value=1,void e.output.connectTo(this.size)}if(!this.width.isConnected){const e=new Db("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){const e=new Db("Height");e.value=1,e.output.connectTo(this.height)}if(!this.depth.isConnected){const e=new Db("Depth");e.value=1,e.output.connectTo(this.depth)}}}_buildBlock(e){const t={},i=e=>{t.size=this.size.getConnectedValue(e),t.width=this.width.getConnectedValue(e),t.height=this.height.getConnectedValue(e),t.depth=this.depth.getConnectedValue(e);const i=this.subdivisions.getConnectedValue(e),r=this.subdivisionsX.getConnectedValue(e),s=this.subdivisionsY.getConnectedValue(e),n=this.subdivisionsZ.getConnectedValue(e);return i&&(t.segments=i),r&&(t.widthSegments=r),s&&(t.heightSegments=s),n&&(t.depthSegments=n),(0,ks.G$)(t)};if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Ob.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.BoxBlock",Ob);class Nb{_getGlobalNodeGeometryEditor(){return"undefined"!=typeof NODEGEOMETRYEDITOR?NODEGEOMETRYEDITOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.NodeGeometryEditor?BABYLON:void 0}get buildExecutionTime(){return this._buildExecutionTime}constructor(e){this._buildId=Nb._BuildIdGenerator++,this._buildWasSuccessful=!1,this._vertexData=null,this._buildExecutionTime=0,this.BJSNODEGEOMETRYEDITOR=this._getGlobalNodeGeometryEditor(),this.editorData=null,this.attachedBlocks=[],this.onBuildObservable=new s.cP,this.outputBlock=null,this.name=e}getClassName(){return"NodeGeometry"}get vertexData(){return this._vertexData}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e){if(t)return H.S0.Warn("More than one block was found with the name `"+e+"`"),t;t=i}return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}edit(e){return new Promise((t=>{if(this.BJSNODEGEOMETRYEDITOR=this.BJSNODEGEOMETRYEDITOR||this._getGlobalNodeGeometryEditor(),void 0===this.BJSNODEGEOMETRYEDITOR){const i=e&&e.editorURL?e.editorURL:Nb.EditorURL;H.S0.LoadBabylonScript(i,(()=>{this.BJSNODEGEOMETRYEDITOR=this.BJSNODEGEOMETRYEDITOR||this._getGlobalNodeGeometryEditor(),this._createNodeEditor(e?.nodeGeometryEditorConfig),t()}))}else this._createNodeEditor(e?.nodeGeometryEditorConfig),t()}))}_createNodeEditor(e){const t={nodeGeometry:this,...e};this.BJSNODEGEOMETRYEDITOR.NodeGeometryEditor.Show(t)}build(e=!1,t=!0,i=!1){if(this._buildWasSuccessful=!1,!this.outputBlock)throw"You must define the outputBlock property before building the geometry";const r=Md.j.Now;this._initializeBlock(this.outputBlock,i);const s=[];for(const e of this.attachedBlocks)e._isReadyState&&s.push(e._isReadyState);if(s.length)return void Promise.all(s).then((()=>{this.build(e,t,i)}));const n=new Mb;n.buildId=this._buildId,n.verbose=e;try{this.outputBlock.build(n)}finally{t&&(this._buildId=Nb._BuildIdGenerator++)}this._buildExecutionTime=Md.j.Now-r,n.emitErrors(),this._buildWasSuccessful=!0,this._vertexData=n.vertexData,this.onBuildObservable.notifyObservers(this)}createMesh(e,t=null){if(this._buildWasSuccessful||this.build(),!this._vertexData)return null;const i=new tt.e(e,t);return this._vertexData.applyToMesh(i),i._internalMetadata=i._internalMetadata||{},i._internalMetadata.nodeGeometry=this,i}updateMesh(e){return this._buildWasSuccessful||this.build(),!!this._vertexData&&(this._vertexData.applyToMesh(e),e._internalMetadata=e._internalMetadata||{},e._internalMetadata.nodeGeometry=this,e)}_initializeBlock(e,t=!0){e.initialize(),t&&e.autoConfigure(this),e._preparationId=this._buildId,-1===this.attachedBlocks.indexOf(e)&&this.attachedBlocks.push(e);for(const i of e.inputs){const r=i.connectedPoint;if(r){const i=r.ownerBlock;i!==e&&this._initializeBlock(i,t)}}}clear(){this.outputBlock=null,this.attachedBlocks.length=0}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e===this.outputBlock&&(this.outputBlock=null)}parseSerializedObject(e,t=!1){t||this.clear();const i={};for(const t of e.blocks){const e=(0,a.n9)(t.customType);if(e){const r=new e;r._deserialize(t),i[t.id]=r,this.attachedBlocks.push(r)}}for(const e of this.attachedBlocks)if(e.isTeleportOut){const t=e,r=t._tempEntryPointUniqueId;if(r){const e=i[r];e&&e.attachToEndpoint(t)}}for(let r=0;r<e.blocks.length;r++){const s=e.blocks[r],n=i[s.id];n&&(n.inputs.length&&s.inputs.some((e=>e.targetConnectionName))&&!t||this._restoreConnections(n,e,i))}if(e.outputNodeId&&(this.outputBlock=i[e.outputNodeId]),e.locations||e.editorData&&e.editorData.locations){const r=e.locations||e.editorData.locations;for(const e of r)i[e.blockId]&&(e.blockId=i[e.blockId].uniqueId);t&&this.editorData&&this.editorData.locations&&r.concat(this.editorData.locations),e.locations?this.editorData={locations:r}:(this.editorData=e.editorData,this.editorData.locations=r);const s=[];for(const e in i)s[e]=i[e].uniqueId;this.editorData.map=s}this.comment=e.comment}_restoreConnections(e,t,i){for(const r of e.outputs)for(const s of t.blocks){const n=i[s.id];if(n)for(const o of s.inputs)if(i[o.targetBlockId]!==e||o.targetConnectionName!==r.name);else{const e=n.getInputByName(o.inputName);if(!e||e.isConnected)continue;r.connectTo(e,!0),this._restoreConnections(n,t,i)}}}generateCode(){let e=[];const t=[],i=["const","var","let"];this.outputBlock&&this._gatherBlocks(this.outputBlock,t);let r=`let nodeGeometry = new BABYLON.NodeGeometry("${this.name||"node geometry"}");\n`;for(const s of t)s.isInput&&-1===e.indexOf(s)&&(r+=s._dumpCode(i,e));return this.outputBlock&&(e=[],r+="// Connections\n",r+=this.outputBlock._dumpCodeForOutputConnections(e),r+="// Output nodes\n",r+=`nodeGeometry.outputBlock = ${this.outputBlock._codeVariableName};\n`,r+="nodeGeometry.build();\n"),r}_gatherBlocks(e,t){if(-1===t.indexOf(e)){t.push(e);for(const i of e.inputs){const r=i.connectedPoint;if(r){const i=r.ownerBlock;i!==e&&this._gatherBlocks(i,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}setToDefault(){this.clear(),this.editorData=null;const e=new Ob("Box");e.autoConfigure();const t=new Rb("Geometry Output");e.geometry.connectTo(t.geometry),this.outputBlock=t}clone(e){const t=this.serialize(),i=Ue.p.Clone((()=>new Nb(e)),this);return i.name=e,i.parseSerializedObject(t),i._buildId=this._buildId,i.build(!1),i}serialize(e){const t=e?{}:Ue.p.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];e?i=e:(t.customType="BABYLON.NodeGeometry",this.outputBlock&&(t.outputNodeId=this.outputBlock.uniqueId)),t.blocks=[];for(const e of i)t.blocks.push(e.serialize());if(!e)for(const e of this.attachedBlocks)-1===i.indexOf(e)&&t.blocks.push(e.serialize());return t}dispose(){for(const e of this.attachedBlocks)e.dispose();this.attachedBlocks.length=0,this.onBuildObservable.clear()}static CreateDefault(e){const t=new Nb(e);return t.setToDefault(),t.build(),t}static Parse(e){const t=Ue.p.Parse((()=>new Nb(e.name)),e,null);return t.parseSerializedObject(e),t.build(),t}static ParseFromSnippetAsync(e,t,i=!1){return"_BLANK"===e?Promise.resolve(Nb.CreateDefault("blank")):new Promise(((r,s)=>{const n=new Kr.u;n.addEventListener("readystatechange",(()=>{if(4==n.readyState)if(200==n.status){const o=JSON.parse(JSON.parse(n.responseText).jsonPayload),a=JSON.parse(o.nodeGeometry);t||(t=Ue.p.Parse((()=>new Nb(e)),a,null)),t.parseSerializedObject(a),t.snippetId=e;try{i||t.build(),r(t)}catch(e){s(e)}}else s("Unable to load the snippet "+e)})),n.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),n.send()}))}}Nb._BuildIdGenerator=0,Nb.EditorURL=`${H.S0._DefaultCdnUrl}/v${$.$.Version}/nodeGeometryEditor/babylon.nodeGeometryEditor.js`,Nb.SnippetUrl="https://snippet.babylonjs.com",(0,Ge.Cg)([(0,ze.lK)()],Nb.prototype,"name",void 0),(0,Ge.Cg)([(0,ze.lK)("comment")],Nb.prototype,"comment",void 0);class wb extends Ib{getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}constructor(e){super(e),this.evaluateContext=!0,this.epsilon=ut.bH,this.optimizeFaces=!1,this.registerInput("geometry",xb.Geometry),this.registerInput("selector",xb.Int,!0),this.registerOutput("output",xb.Geometry)}getClassName(){return"GeometryOptimizeBlock"}get geometry(){return this._inputs[0]}get selector(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(!this.geometry.isConnected)return null;const t=this.geometry.getConnectedValue(e),i=[],r={};e.pushExecutionContext(this),e.pushGeometryContext(t);for(let s=0;s<t.positions.length;s+=3){if(this._currentIndex=s/3,this.selector.isConnected){if(!this.selector.getConnectedValue(e))continue}const n=t.positions[s],o=t.positions[s+1],a=t.positions[s+2];let l=!1;for(let e=0;e<i.length;e+=3)(0,yt.WithinEpsilon)(n,i[e],this.epsilon)&&(0,yt.WithinEpsilon)(o,i[e+1],this.epsilon)&&(0,yt.WithinEpsilon)(a,i[e+2],this.epsilon)&&(r[s/3]=e/3,l=!0);l||(r[s/3]=i.length/3,i.push(n,o,a))}const s=new ot.P;s.positions=i;const n=t.indices.map((e=>r[e])),o=[];if(this.optimizeFaces){for(let e=0;e<n.length;e+=3){const t=n[e],i=n[e+1],r=n[e+2];if(t===i||i==r||r===t)continue;let s=!1;for(let e=0;e<o.length;e+=3)(t!==o[e]||i!==o[e+1]||r!==o[e+2])&&(t!==o[e+1]||i!==o[e+2]||r!==o[e])&&(t!==o[e+2]||i!==o[e]||r!==o[e+1])||(s=!0);s||o.push(t,i,r)}s.indices=o}else s.indices=n;return s};e.restoreGeometryContext(),e.restoreExecutionContext(),this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`;return e+=`${this._codeVariableName}.epsilon = ${this.epsilon};\n`,e+=`${this._codeVariableName}.optimizeFaces = ${this.optimizeFaces?"true":"false"};\n`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.epsilon=this.epsilon,e.optimizeFaces=this.optimizeFaces,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext,this.epsilon=e.epsilon,this.optimizeFaces=e.optimizeFaces}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],wb.prototype,"evaluateContext",void 0),(0,Ge.Cg)([xh("Epsilon",1,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],wb.prototype,"epsilon",void 0),(0,Ge.Cg)([xh("Optimize faces",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],wb.prototype,"optimizeFaces",void 0),(0,a.Y5)("BABYLON.GeometryOptimizeBlock",wb);class Fb extends Ib{constructor(e){super(e),this._rotationMatrix=new n.uq,this.evaluateContext=!1,this.registerInput("size",xb.Float,!0,1),this.registerInput("width",xb.Float,!0,0),this.registerInput("height",xb.Float,!0,0),this.registerInput("subdivisions",xb.Int,!0,1,0),this.registerInput("subdivisionsX",xb.Int,!0,0,0),this.registerInput("subdivisionsY",xb.Int,!0,0,0),this.registerOutput("geometry",xb.Geometry)}getClassName(){return"PlaneBlock"}get size(){return this._inputs[0]}get width(){return this._inputs[1]}get height(){return this._inputs[2]}get subdivisions(){return this._inputs[3]}get subdivisionsX(){return this._inputs[4]}get subdivisionsY(){return this._inputs[5]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.size.isConnected){if(!this.width.isConnected&&!this.height.isConnected){const e=new Db("Size");return e.value=1,void e.output.connectTo(this.size)}if(!this.width.isConnected){const e=new Db("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){const e=new Db("Height");e.value=1,e.output.connectTo(this.height)}}}_buildBlock(e){const t={},i=e=>{t.size=this.size.getConnectedValue(e),t.width=this.width.getConnectedValue(e),t.height=this.height.getConnectedValue(e);const i=this.subdivisions.getConnectedValue(e),r=this.subdivisionsX.getConnectedValue(e),s=this.subdivisionsY.getConnectedValue(e);i&&(t.subdivisions=i),r&&(t.subdivisionsX=r),s&&(t.subdivisionsY=s);const o=(0,Br.EH)(t);return n.uq.RotationYawPitchRollToRef(-Math.PI/2,0,Math.PI/2,this._rotationMatrix),o.transform(this._rotationMatrix),o};if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Fb.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.PlaneBlock",Fb);class Bb extends Ib{get mesh(){return this._mesh}set mesh(e){this._mesh=e}constructor(e){super(e),this._cachedVertexData=null,this.reverseWindingOrder=!1,this.serializedCachedData=!1,this.registerOutput("geometry",xb.Geometry)}getClassName(){return"MeshBlock"}get isUsingCachedData(){return!this.mesh&&!!this._cachedVertexData}get geometry(){return this._outputs[0]}cleanData(){this._mesh=null,this._cachedVertexData=null}_buildBlock(){if(!this._mesh)return void(this._cachedVertexData?this.geometry._storedValue=this._cachedVertexData.clone():this.geometry._storedValue=null);const e=ot.P.ExtractFromMesh(this._mesh,!1,!0);if(this._cachedVertexData=null,this.reverseWindingOrder&&e.indices)for(let t=0;t<e.indices.length;t+=3){const i=e.indices[t];e.indices[t]=e.indices[t+2],e.indices[t+2]=i}this.geometry._storedFunction=()=>e.clone()}serialize(){const e=super.serialize();return e.serializedCachedData=this.serializedCachedData,this.serializedCachedData&&(this._mesh?e.cachedVertexData=ot.P.ExtractFromMesh(this._mesh,!1,!0).serialize():this._cachedVertexData&&(e.cachedVertexData=this._cachedVertexData.serialize())),e.reverseWindingOrder=this.reverseWindingOrder,e}_deserialize(e){super._deserialize(e),e.cachedVertexData&&(this._cachedVertexData=ot.P.Parse(e.cachedVertexData)),this.serializedCachedData=!!e.serializedCachedData,this.reverseWindingOrder=e.reverseWindingOrder}}(0,Ge.Cg)([xh("Serialize cached data",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Bb.prototype,"serializedCachedData",void 0),(0,a.Y5)("BABYLON.MeshBlock",Bb);class Vb extends Ib{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("radius",xb.Float,!0,1),this.registerInput("radiusX",xb.Float,!0,0),this.registerInput("radiusY",xb.Float,!0,0),this.registerInput("radiusZ",xb.Float,!0,0),this.registerInput("subdivisions",xb.Int,!0,4),this.registerOutput("geometry",xb.Geometry)}getClassName(){return"IcoSphereBlock"}get radius(){return this._inputs[0]}get radiusX(){return this._inputs[1]}get radiusY(){return this._inputs[2]}get radiusZ(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.radius.isConnected){const e=new Db("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){const t={},i=e=>(t.radius=this.radius.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),t.radiusX=this.radiusX.getConnectedValue(e),t.radiusY=this.radiusY.getConnectedValue(e),t.radiusZ=this.radiusZ.getConnectedValue(e),Hn(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Vb.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.IcoSphereBlock",Vb);class Lb extends Ib{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("segments",xb.Int,!0,32),this.registerInput("diameter",xb.Float,!0,1),this.registerInput("diameterX",xb.Float,!0,0),this.registerInput("diameterY",xb.Float,!0,0),this.registerInput("diameterZ",xb.Float,!0,0),this.registerInput("arc",xb.Float,!0,1),this.registerInput("slice",xb.Float,!0,1),this.registerOutput("geometry",xb.Geometry)}getClassName(){return"SphereBlock"}get segments(){return this._inputs[0]}get diameter(){return this._inputs[1]}get diameterX(){return this._inputs[2]}get diameterY(){return this._inputs[3]}get diameterZ(){return this._inputs[4]}get arc(){return this._inputs[5]}get slice(){return this._inputs[6]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){const e=new Db("Diameter");e.value=1,e.output.connectTo(this.diameter)}}_buildBlock(e){const t={},i=e=>(t.segments=this.segments.getConnectedValue(e),t.diameter=this.diameter.getConnectedValue(e),t.diameterX=this.diameterX.getConnectedValue(e),t.diameterY=this.diameterY.getConnectedValue(e),t.diameterZ=this.diameterZ.getConnectedValue(e),t.arc=this.arc.getConnectedValue(e),t.slice=this.slice.getConnectedValue(e),Gs(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Lb.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.SphereBlock",Lb);class kb extends Ib{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("width",xb.Float,!0,1),this.registerInput("height",xb.Float,!0,1),this.registerInput("subdivisions",xb.Int,!0,1,0),this.registerInput("subdivisionsX",xb.Int,!0,0,0),this.registerInput("subdivisionsY",xb.Int,!0,0,0),this.registerOutput("geometry",xb.Geometry)}getClassName(){return"GridBlock"}get width(){return this._inputs[0]}get height(){return this._inputs[1]}get subdivisions(){return this._inputs[2]}get subdivisionsX(){return this._inputs[3]}get subdivisionsY(){return this._inputs[4]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.width.isConnected){const e=new Db("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){const e=new Db("Height");e.value=1,e.output.connectTo(this.height)}}_buildBlock(e){const t={},i=e=>(t.width=this.width.getConnectedValue(e),t.height=this.height.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),t.subdivisionsX=this.subdivisionsX.getConnectedValue(e),t.subdivisionsY=this.subdivisionsY.getConnectedValue(e),(0,Br.EH)(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],kb.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.GridBlock",kb);class Gb extends Ib{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("diameter",xb.Float,!0,1),this.registerInput("thickness",xb.Float,!0,.5),this.registerInput("tessellation",xb.Int,!0,16),this.registerOutput("geometry",xb.Geometry)}getClassName(){return"TorusBlock"}get diameter(){return this._inputs[0]}get thickness(){return this._inputs[1]}get tessellation(){return this._inputs[2]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){const e=new Db("Diameter");e.value=1,e.output.connectTo(this.diameter)}}_buildBlock(e){const t={},i=e=>(t.thickness=this.thickness.getConnectedValue(e),t.diameter=this.diameter.getConnectedValue(e),t.tessellation=this.tessellation.getConnectedValue(e),Vr(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Gb.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.TorusBlock",Gb);class zb extends Ib{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("height",xb.Float,!0,25),this.registerInput("diameter",xb.Float,!0,1),this.registerInput("diameterTop",xb.Float,!0,-1),this.registerInput("diameterBottom",xb.Float,!0,-1),this.registerInput("subdivisions",xb.Int,!0,1),this.registerInput("tessellation",xb.Int,!0,24),this.registerInput("arc",xb.Float,!0,1),this.registerOutput("geometry",xb.Geometry)}getClassName(){return"CylinderBlock"}get height(){return this._inputs[0]}get diameter(){return this._inputs[1]}get diameterTop(){return this._inputs[2]}get diameterBottom(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get tessellation(){return this._inputs[5]}get arc(){return this._inputs[6]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){const e=new Db("Diameter");e.value=1,e.output.connectTo(this.diameter)}if(!this.height.isConnected){const e=new Db("Height");e.value=1,e.output.connectTo(this.height)}}_buildBlock(e){const t={},i=e=>(t.height=this.height.getConnectedValue(e),t.diameter=this.diameter.getConnectedValue(e),t.diameterTop=this.diameterTop.getConnectedValue(e),t.diameterBottom=this.diameterBottom.getConnectedValue(e),-1===t.diameterTop&&(t.diameterTop=t.diameter),-1===t.diameterBottom&&(t.diameterBottom=t.diameter),t.tessellation=this.tessellation.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),t.arc=this.arc.getConnectedValue(e),Cs(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],zb.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.CylinderBlock",zb);class Ub extends Ib{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("height",xb.Float,!0,1),this.registerInput("radius",xb.Float,!0,.25),this.registerInput("tessellation",xb.Int,!0,16),this.registerInput("subdivisions",xb.Int,!0,2),this.registerOutput("geometry",xb.Geometry)}getClassName(){return"CapsuleBlock"}get height(){return this._inputs[0]}get radius(){return this._inputs[1]}get tessellation(){return this._inputs[2]}get subdivisions(){return this._inputs[3]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.height.isConnected){const e=new Db("Height");e.value=1,e.output.connectTo(this.height)}if(!this.radius.isConnected){const e=new Db("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){const t={},i=e=>(t.height=this.height.getConnectedValue(e),t.radius=this.radius.getConnectedValue(e),t.tessellation=this.tessellation.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),js(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Ub.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.CapsuleBlock",Ub);class Wb extends Ib{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("radius",xb.Float,!0,.5),this.registerInput("tessellation",xb.Int,!0,64),this.registerInput("arc",xb.Float,!0,1),this.registerOutput("geometry",xb.Geometry)}getClassName(){return"DiscBlock"}get radius(){return this._inputs[0]}get tessellation(){return this._inputs[1]}get arc(){return this._inputs[2]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.radius.isConnected){const e=new Db("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){const t={},i=e=>(t.radius=this.radius.getConnectedValue(e),t.tessellation=this.tessellation.getConnectedValue(e),t.arc=this.arc.getConnectedValue(e),tn(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Wb.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.DiscBlock",Wb);class Hb extends Ib{constructor(e){super(e),this.registerOutput("geometry",xb.Geometry),this.registerOutput("vector",xb.Vector3)}getClassName(){return"NullBlock"}get geometry(){return this._outputs[0]}get vector(){return this._outputs[1]}_buildBlock(){this.geometry._storedValue=null,this.vector._storedValue=null}}(0,a.Y5)("BABYLON.NullBlock",Hb);class $b extends Ib{constructor(e){super(e),this.points=[],this.registerOutput("geometry",xb.Geometry)}getClassName(){return"PointListBlock"}get geometry(){return this._outputs[0]}_buildBlock(e){this.geometry._storedFunction=()=>{if(this.geometry._executionCount=1,0===this.points.length)return null;const e=new ot.P;return e.positions=this.points.reduce(((e,t)=>(e.push(t.x,t.y,t.z),e)),[]),e}}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.points = [];\n`;for(let t=0;t<this.points.length;t++){const i=this.points[t];e+=`${this._codeVariableName}.points.push(new BABYLON.Vector3(${i.x}, ${i.y}, ${i.z}));\n`}return e}serialize(){const e=super.serialize();return e.points=this.points.map((e=>e.asArray())),e}_deserialize(e){super._deserialize(e),this.points=e.points.map((e=>n.Pq.FromArray(e)))}}(0,a.Y5)("BABYLON.PointListBlock",$b);class qb extends Ib{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",xb.Geometry),this.registerInput("positions",xb.Vector3),this.registerOutput("output",xb.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetPositionsBlock"}get geometry(){return this._inputs[0]}get positions(){return this._inputs[1]}get output(){return this._outputs[0]}_remapVector3Data(e,t){const i=[];for(let r=0;r<e.length;r+=3){void 0!==t[r/3]&&i.push(e[r],e[r+1],e[r+2])}return i}_remapVector4Data(e,t){const i=[];for(let r=0;r<e.length;r+=4){void 0!==t[r/4]&&i.push(e[r],e[r+1],e[r+2],e[r+3])}return i}_remapVector2Data(e,t){const i=[];for(let r=0;r<e.length;r+=2){void 0!==t[r/2]&&i.push(e[r],e[r+1])}return i}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this.positions.isConnected)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=null);const t={},i=this._vertexData.positions.length/3,r=[];let s=0,n=!1;for(this._currentIndex=0;this._currentIndex<i;this._currentIndex++){const i=this.positions.getConnectedValue(e);i?(i.toArray(r,3*s),t[this._currentIndex]=s,s++):n=!0}if(n){if(this._vertexData.indices){const e=[];for(let i=0;i<this._vertexData.indices.length;i+=3){const r=this._vertexData.indices[i],s=this._vertexData.indices[i+1],n=this._vertexData.indices[i+2],o=t[r],a=t[s],l=t[n];void 0!==o&&void 0!==a&&void 0!==l&&(e.push(o),e.push(a),e.push(l))}this._vertexData.indices=e}this._vertexData.normals&&(this._vertexData.normals=this._remapVector3Data(this._vertexData.normals,t)),this._vertexData.tangents&&(this._vertexData.tangents=this._remapVector4Data(this._vertexData.tangents,t)),this._vertexData.colors&&(this._vertexData.colors=this._remapVector4Data(this._vertexData.colors,t)),this._vertexData.uvs&&(this._vertexData.uvs=this._remapVector2Data(this._vertexData.uvs,t)),this._vertexData.uvs2&&(this._vertexData.uvs2=this._remapVector2Data(this._vertexData.uvs2,t)),this._vertexData.uvs3&&(this._vertexData.uvs3=this._remapVector2Data(this._vertexData.uvs3,t)),this._vertexData.uvs4&&(this._vertexData.uvs4=this._remapVector2Data(this._vertexData.uvs4,t)),this._vertexData.uvs5&&(this._vertexData.uvs5=this._remapVector2Data(this._vertexData.uvs5,t)),this._vertexData.uvs6&&(this._vertexData.uvs6=this._remapVector2Data(this._vertexData.uvs6,t))}return this._vertexData.positions=r,e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],qb.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.SetPositionsBlock",qb);class Yb extends Ib{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",xb.Geometry),this.registerInput("normals",xb.Vector3),this.registerOutput("output",xb.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetNormalsBlock"}get geometry(){return this._inputs[0]}get normals(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=null);if(!this.normals.isConnected)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=this._vertexData);this._vertexData.normals||(this._vertexData.normals=[]);const t=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.normals.getConnectedValue(e);t&&t.toArray(this._vertexData.normals,3*this._currentIndex)}return e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Yb.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.SetNormalsBlock",Yb);class Xb extends Ib{constructor(e){super(e),this.evaluateContext=!0,this.textureCoordinateIndex=0,this.registerInput("geometry",xb.Geometry),this.registerInput("uvs",xb.Vector2),this.registerOutput("output",xb.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetUVsBlock"}get geometry(){return this._inputs[0]}get uvs(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=null);if(!this.uvs.isConnected)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=this._vertexData);const t=[],i=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<i;this._currentIndex++){const i=this.uvs.getConnectedValue(e);i&&i.toArray(t,2*this._currentIndex)}switch(this.textureCoordinateIndex){case 0:this._vertexData.uvs=t;break;case 1:this._vertexData.uvs2=t;break;case 2:this._vertexData.uvs3=t;break;case 3:this._vertexData.uvs4=t;break;case 4:this._vertexData.uvs5=t;break;case 5:this._vertexData.uvs6=t}return e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.textureCoordinateIndex};\n`;return e+=`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.textureCoordinateIndex=this.textureCoordinateIndex,e}_deserialize(e){super._deserialize(e),this.textureCoordinateIndex=e.textureCoordinateIndex,void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Xb.prototype,"evaluateContext",void 0),(0,Ge.Cg)([xh("Texture coordinates index",4,"ADVANCED",{notifiers:{update:!0},embedded:!0,options:[{label:"UV1",value:0},{label:"UV2",value:1},{label:"UV3",value:2},{label:"UV4",value:3},{label:"UV5",value:4},{label:"UV6",value:5}]})],Xb.prototype,"textureCoordinateIndex",void 0),(0,a.Y5)("BABYLON.SetUVsBlock",Xb);class jb extends Ib{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",xb.Geometry),this.registerInput("colors",xb.AutoDetect),this.registerOutput("output",xb.Geometry),this._inputs[1].excludedConnectionPointTypes.push(xb.Int),this._inputs[1].excludedConnectionPointTypes.push(xb.Float),this._inputs[1].excludedConnectionPointTypes.push(xb.Vector2),this._inputs[1].excludedConnectionPointTypes.push(xb.Texture),this._inputs[1].excludedConnectionPointTypes.push(xb.Texture)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetColorsBlock"}get geometry(){return this._inputs[0]}get colors(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=null);if(!this.colors.isConnected)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=this._vertexData);this._vertexData.colors||(this._vertexData.colors=[]);const t=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++)if(this.colors.connectedPoint?.type===xb.Vector3){const t=this.colors.getConnectedValue(e);t&&(t.toArray(this._vertexData.colors,4*this._currentIndex),this._vertexData.colors[4*this._currentIndex+3]=1,this._vertexData.hasVertexAlpha=!1)}else{const t=this.colors.getConnectedValue(e);t&&(t.toArray(this._vertexData.colors,4*this._currentIndex),this._vertexData.hasVertexAlpha=!0)}return e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],jb.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.SetColorsBlock",jb);class Zb extends Ib{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",xb.Geometry),this.registerInput("tangents",xb.Vector4),this.registerOutput("output",xb.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetTangentsBlock"}get geometry(){return this._inputs[0]}get tangents(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=null);if(!this.tangents.isConnected)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=this._vertexData);this._vertexData.tangents||(this._vertexData.tangents=[]);const t=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.tangents.getConnectedValue(e);t&&t.toArray(this._vertexData.tangents,4*this._currentIndex)}return e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Zb.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.SetTangentsBlock",Zb),function(e){e[e.Add=0]="Add",e[e.Subtract=1]="Subtract",e[e.Multiply=2]="Multiply",e[e.Divide=3]="Divide",e[e.Max=4]="Max",e[e.Min=5]="Min"}(yb||(yb={}));class Qb extends Ib{constructor(e){super(e),this.operation=yb.Add,this.registerInput("left",xb.AutoDetect),this.registerInput("right",xb.AutoDetect),this.registerOutput("output",xb.BasedOnInput),this.output._typeConnectionSource=this.left;const t=[xb.Matrix,xb.Geometry,xb.Texture];this.left.excludedConnectionPointTypes.push(...t),this.right.excludedConnectionPointTypes.push(...t),this._linkConnectionTypes(0,1),this._connectionObservers=[this.left.onConnectionObservable.add((()=>this._updateInputOutputTypes())),this.left.onDisconnectionObservable.add((()=>this._updateInputOutputTypes())),this.right.onConnectionObservable.add((()=>this._updateInputOutputTypes())),this.right.onDisconnectionObservable.add((()=>this._updateInputOutputTypes()))]}getClassName(){return"MathBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){let e;const t=this.left,i=this.right;if(!t.isConnected||!i.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const r=t.type===xb.Float||t.type===xb.Int,s=i.type===xb.Float||i.type===xb.Int,o=r&&s;switch(this.operation){case yb.Add:e=o?e=>t.getConnectedValue(e)+i.getConnectedValue(e):r?e=>e.adapt(t,i.type).add(i.getConnectedValue(e)):e=>t.getConnectedValue(e).add(e.adapt(i,t.type));break;case yb.Subtract:e=o?e=>t.getConnectedValue(e)-i.getConnectedValue(e):r?e=>e.adapt(t,i.type).subtract(i.getConnectedValue(e)):e=>t.getConnectedValue(e).subtract(e.adapt(i,t.type));break;case yb.Multiply:e=o?e=>t.getConnectedValue(e)*i.getConnectedValue(e):r?e=>e.adapt(t,i.type).multiply(i.getConnectedValue(e)):e=>t.getConnectedValue(e).multiply(e.adapt(i,t.type));break;case yb.Divide:e=o?e=>t.getConnectedValue(e)/i.getConnectedValue(e):r?e=>e.adapt(t,i.type).divide(i.getConnectedValue(e)):e=>t.getConnectedValue(e).divide(e.adapt(i,t.type));break;case yb.Min:if(o)e=e=>Math.min(t.getConnectedValue(e),i.getConnectedValue(e));else{const[s,o]=r?[i,t]:[t,i];switch(s.type){case xb.Vector2:e=e=>n.I9.Minimize(s.getConnectedValue(e),e.adapt(o,s.type));break;case xb.Vector3:e=e=>n.Pq.Minimize(s.getConnectedValue(e),e.adapt(o,s.type));break;case xb.Vector4:e=e=>n.IU.Minimize(s.getConnectedValue(e),e.adapt(o,s.type))}}break;case yb.Max:if(!o){const[s,o]=r?[i,t]:[t,i];switch(s.type){case xb.Vector2:e=e=>n.I9.Maximize(s.getConnectedValue(e),e.adapt(o,s.type));break;case xb.Vector3:e=e=>n.Pq.Maximize(s.getConnectedValue(e),e.adapt(o,s.type));break;case xb.Vector4:e=e=>n.IU.Maximize(s.getConnectedValue(e),e.adapt(o,s.type))}break}e=e=>Math.max(t.getConnectedValue(e),i.getConnectedValue(e))}this.output._storedFunction=i=>t.type===xb.Int?0|e(i):e(i)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.MathBlockOperations.${yb[this.operation]};\n`}_updateInputOutputTypes(){if(this.output._typeConnectionSource=this.left,this.left.isConnected&&this.right.isConnected?(this.left.type===xb.Int||this.left.type===xb.Float&&this.right.type!==xb.Int)&&(this.output._typeConnectionSource=this.right):this.left.isConnected!==this.right.isConnected&&(this.output._typeConnectionSource=this.left.isConnected?this.left:this.right),this.left.isConnected||this.right.isConnected)for(const[e,t]of[[this.left,this.right],[this.right,this.left]])e.acceptedConnectionPointTypes=[xb.Int,xb.Float],t.isConnected&&(e.acceptedConnectionPointTypes.push(t.type),t.type!==xb.Int&&t.type!==xb.Float||e.acceptedConnectionPointTypes.push(xb.Vector2,xb.Vector3,xb.Vector4))}dispose(){super.dispose(),this._connectionObservers.forEach((e=>e.remove())),this._connectionObservers.length=0}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.operation=e.operation}}(0,Ge.Cg)([xh("Operation",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Add",value:yb.Add},{label:"Subtract",value:yb.Subtract},{label:"Multiply",value:yb.Multiply},{label:"Divide",value:yb.Divide},{label:"Max",value:yb.Max},{label:"Min",value:yb.Min}]})],Qb.prototype,"operation",void 0),(0,a.Y5)("BABYLON.MathBlock",Qb);class Kb extends Ib{constructor(e){super(e),this.registerInput("value",xb.AutoDetect),this.registerInput("fromMin",xb.Float,!0,0),this.registerInput("fromMax",xb.Float,!0,1),this.registerInput("toMin",xb.Float,!0,0),this.registerInput("toMax",xb.Float,!0,1),this.registerOutput("output",xb.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(xb.Vector2),this._inputs[0].excludedConnectionPointTypes.push(xb.Vector3),this._inputs[0].excludedConnectionPointTypes.push(xb.Vector4),this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[0].excludedConnectionPointTypes.push(xb.Geometry),this._inputs[0].excludedConnectionPointTypes.push(xb.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"MapRangeBlock"}get value(){return this._inputs[0]}get fromMin(){return this._inputs[1]}get fromMax(){return this._inputs[2]}get toMin(){return this._inputs[3]}get toMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);this.output._storedFunction=e=>{const t=this.value.getConnectedValue(e),i=this.fromMin.getConnectedValue(e),r=this.fromMax.getConnectedValue(e),s=this.toMin.getConnectedValue(e),n=(t-i)/(r-i)*(this.toMax.getConnectedValue(e)-s)+s;return this.output.type===xb.Int?Math.floor(n):n}}}(0,a.Y5)("BABYLON.MapRangeBlock",Kb),function(e){e[e.Equal=0]="Equal",e[e.NotEqual=1]="NotEqual",e[e.LessThan=2]="LessThan",e[e.GreaterThan=3]="GreaterThan",e[e.LessOrEqual=4]="LessOrEqual",e[e.GreaterOrEqual=5]="GreaterOrEqual",e[e.Xor=6]="Xor",e[e.Or=7]="Or",e[e.And=8]="And"}(Pb||(Pb={}));class Jb extends Ib{constructor(e){super(e),this.test=Pb.Equal,this.registerInput("left",xb.Float),this.registerInput("right",xb.Float,!0,0),this.registerInput("ifTrue",xb.AutoDetect,!0,1),this.registerInput("ifFalse",xb.AutoDetect,!0,0),this.registerOutput("output",xb.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=xb.Float,this._inputs[0].acceptedConnectionPointTypes.push(xb.Int),this._inputs[1].acceptedConnectionPointTypes.push(xb.Int),this._linkConnectionTypes(2,3)}getClassName(){return"ConditionBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get ifTrue(){return this._inputs[2]}get ifFalse(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(e){if(!this.ifTrue.isConnected){const t=e.getBlockByPredicate((e=>e.isInput&&1===e.value&&"True"===e.name))||new Db("True");t.value=1,t.output.connectTo(this.ifTrue)}if(!this.ifFalse.isConnected){const t=e.getBlockByPredicate((e=>e.isInput&&0===e.value&&"False"===e.name))||new Db("False");t.value=0,t.output.connectTo(this.ifFalse)}}_buildBlock(){if(!this.left.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=e=>{const t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);let r=!1;switch(this.test){case Pb.Equal:r=(0,yt.WithinEpsilon)(t,i,ut.bH);break;case Pb.NotEqual:r=t!==i;break;case Pb.LessThan:r=t<i;break;case Pb.GreaterThan:r=t>i;break;case Pb.LessOrEqual:r=t<=i;break;case Pb.GreaterOrEqual:r=t>=i;break;case Pb.Xor:r=!!t&&!i||!t&&!!i;break;case Pb.Or:r=!!t||!!i;break;case Pb.And:r=!!t&&!!i}return r};this.output._storedFunction=t=>e(t)?this.ifTrue.getConnectedValue(t):this.ifFalse.getConnectedValue(t)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.test = BABYLON.ConditionBlockTests.${Pb[this.test]};\n`}serialize(){const e=super.serialize();return e.test=this.test,e}_deserialize(e){super._deserialize(e),this.test=e.test}}(0,Ge.Cg)([xh("Test",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Equal",value:Pb.Equal},{label:"NotEqual",value:Pb.NotEqual},{label:"LessThan",value:Pb.LessThan},{label:"GreaterThan",value:Pb.GreaterThan},{label:"LessOrEqual",value:Pb.LessOrEqual},{label:"GreaterOrEqual",value:Pb.GreaterOrEqual},{label:"Xor",value:Pb.Xor},{label:"Or",value:Pb.Or},{label:"And",value:Pb.And}]})],Jb.prototype,"test",void 0),(0,a.Y5)("BABYLON.ConditionBlock",Jb),function(e){e[e.None=0]="None",e[e.LoopID=1]="LoopID",e[e.InstanceID=2]="InstanceID",e[e.Once=3]="Once"}(Tb||(Tb={}));class ey extends Ib{constructor(e){super(e),this._currentLockId=-1,this.lockMode=Tb.None,this.registerInput("min",xb.AutoDetect),this.registerInput("max",xb.AutoDetect),this.registerOutput("output",xb.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[0].excludedConnectionPointTypes.push(xb.Geometry),this._inputs[0].excludedConnectionPointTypes.push(xb.Texture),this._inputs[1].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[1].excludedConnectionPointTypes.push(xb.Geometry),this._inputs[1].excludedConnectionPointTypes.push(xb.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"RandomBlock"}get min(){return this._inputs[0]}get max(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.min.isConnected){const e=new Db("Min");e.value=0,e.output.connectTo(this.min)}if(!this.max.isConnected){const e=new Db("Max");e.value=1,e.output.connectTo(this.max)}}_buildBlock(){let e=null;switch(this._currentLockId=-1,this.min.type){case xb.Int:case xb.Float:e=e=>{const t=this.min.getConnectedValue(e)||0,i=this.max.getConnectedValue(e)||0;return t+Math.random()*(i-t)};break;case xb.Vector2:e=e=>{const t=this.min.getConnectedValue(e)||n.I9.Zero(),i=this.max.getConnectedValue(e)||n.I9.Zero();return new n.I9(t.x+Math.random()*(i.x-t.x),t.y+Math.random()*(i.y-t.y))};break;case xb.Vector3:e=e=>{const t=this.min.getConnectedValue(e)||n.Pq.Zero(),i=this.max.getConnectedValue(e)||n.Pq.Zero();return new n.Pq(t.x+Math.random()*(i.x-t.x),t.y+Math.random()*(i.y-t.y),t.z+Math.random()*(i.z-t.z))};break;case xb.Vector4:e=e=>{const t=this.min.getConnectedValue(e)||n.IU.Zero(),i=this.max.getConnectedValue(e)||n.IU.Zero();return new n.IU(t.x+Math.random()*(i.x-t.x),t.y+Math.random()*(i.y-t.y),t.z+Math.random()*(i.z-t.z),t.w+Math.random()*(i.w-t.w))}}this.lockMode!==Tb.None&&e?this.output._storedFunction=t=>{let i=0;switch(this.lockMode){case Tb.InstanceID:i=t.getContextualValue(bb.InstanceID,!0)||0;break;case Tb.LoopID:i=t.getContextualValue(bb.LoopID,!0)||0;break;case Tb.Once:i=t.buildId||0}return this._currentLockId===i&&this.lockMode!==Tb.None||(this._currentLockId=i,this.output._storedValue=e(t)),this.output._storedValue}:this.output._storedFunction=e}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.lockMode = BABYLON.RandomBlockLocks.${Tb[this.lockMode]};\n`}serialize(){const e=super.serialize();return e.lockMode=this.lockMode,e}_deserialize(e){super._deserialize(e),this.lockMode=e.lockMode}}(0,Ge.Cg)([xh("LockMode",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"None",value:Tb.None},{label:"LoopID",value:Tb.LoopID},{label:"InstanceID",value:Tb.InstanceID},{label:"Once",value:Tb.Once}]})],ey.prototype,"lockMode",void 0),(0,a.Y5)("BABYLON.RandomBlock",ey);class ty extends Ib{constructor(e){super(e),this.registerInput("offset",xb.Vector3,!0,n.Pq.Zero()),this.registerInput("scale",xb.Float,!0,1),this.registerInput("octaves",xb.Float,!0,2,0,16),this.registerInput("roughness",xb.Float,!0,.5,0,1),this.registerOutput("output",xb.Float)}getClassName(){return"NoiseBlock"}get offset(){return this._inputs[0]}get scale(){return this._inputs[1]}get octaves(){return this._inputs[2]}get roughness(){return this._inputs[3]}get output(){return this._outputs[0]}_negateIf(e,t){return 0!==t?-e:e}_noiseGrad(e,t,i,r){const s=15&e,n=s<8?t:i,o=s<4?i:12===s||14==s?t:r;return this._negateIf(n,s&n)+this._negateIf(o,2&s)}_fade(e){return e*e*e*(e*(6*e-15)+10)}_hashBitRotate(e,t){return e<<t|e>>32-t}_hash(e,t,i){let r,s,n;return r=s=n=3735928584,n+=i,s+=t,r+=e,n^=s,n-=this._hashBitRotate(s,14),r^=n,r-=this._hashBitRotate(n,11),s^=r,s-=this._hashBitRotate(r,25),n^=s,n-=this._hashBitRotate(s,16),r^=n,r-=this._hashBitRotate(n,4),s^=r,s-=this._hashBitRotate(r,14),n^=s,n-=this._hashBitRotate(s,24),n}_mix(e,t,i,r,s,n,o,a,l,h,c){const u=1-l,d=1-h;return(1-c)*(d*(e*u+t*l)+h*(i*u+r*l))+c*(d*(s*u+n*l)+h*(o*u+a*l))}_perlinNoise(e){const t=(0|e.x)-(e.x<0?1:0),i=(0|e.y)-(e.y<0?1:0),r=(0|e.z)-(e.z<0?1:0),s=e.x-t,n=e.y-i,o=e.z-r,a=this._fade(s),l=this._fade(n),h=this._fade(o);return this._mix(this._noiseGrad(this._hash(t,i,r),s,n,o),this._noiseGrad(this._hash(t+1,i,r),s-1,n,o),this._noiseGrad(this._hash(t,i+1,r),s,n-1,o),this._noiseGrad(this._hash(t+1,i+1,r),s-1,n-1,o),this._noiseGrad(this._hash(t,i,r+1),s,n,o-1),this._noiseGrad(this._hash(t+1,i,r+1),s-1,n,o-1),this._noiseGrad(this._hash(t,i+1,r+1),s,n-1,o-1),this._noiseGrad(this._hash(t+1,i+1,r+1),s-1,n-1,o-1),a,l,h)}_perlinSigned(e){return.982*this._perlinNoise(e)}_perlin(e){return this._perlinSigned(e)/2+.5}noise(e,t,i,r,s){const o=new n.Pq(i.x*s+r.x,i.y*s+r.y,i.z*s+r.z);let a=1,l=1,h=0,c=0;const u=0|(e=(0,yt.Clamp)(e,0,15));for(let e=0;e<=u;e++){c+=this._perlin(o.scale(a))*l,h+=l,l*=(0,yt.Clamp)(t,0,1),a*=2}const d=e-Math.floor(e);if(0==d)return c/h;let p=c+this._perlin(o.scale(a))*l;return c/=h,p/=h+l,(1-d)*c+d*p}_buildBlock(){this.output._storedFunction=e=>{const t=e.getContextualValue(bb.Positions),i=this.octaves.getConnectedValue(e),r=this.roughness.getConnectedValue(e),s=this.offset.getConnectedValue(e),n=this.scale.getConnectedValue(e);return this.noise(i,r,t,s,n)}}}(0,a.Y5)("BABYLON.NoiseBlock",ty);class iy extends Ib{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("geometry0",xb.Geometry),this.registerInput("geometry1",xb.Geometry,!0),this.registerInput("geometry2",xb.Geometry,!0),this.registerInput("geometry3",xb.Geometry,!0),this.registerInput("geometry4",xb.Geometry,!0),this.registerOutput("output",xb.Geometry)}getClassName(){return"MergeGeometryBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get geometry2(){return this._inputs[2]}get geometry3(){return this._inputs[3]}get geometry4(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{const t=[];if(this.geometry0.isConnected){const i=this.geometry0.getConnectedValue(e);i&&t.push(i)}if(this.geometry1.isConnected){const i=this.geometry1.getConnectedValue(e);i&&t.push(i)}if(this.geometry2.isConnected){const i=this.geometry2.getConnectedValue(e);i&&t.push(i)}if(this.geometry3.isConnected){const i=this.geometry3.getConnectedValue(e);i&&t.push(i)}if(this.geometry4.isConnected){const i=this.geometry4.getConnectedValue(e);i&&t.push(i)}if(0===t.length)return null;let i=t[0].clone();const r=t.slice(1);return r.length&&i&&(i=i.merge(r,!0,!1,!0,!0)),i};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],iy.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.MergeGeometryBlock",iy);class ry extends Ib{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry0",xb.Geometry,!0),this.registerInput("geometry1",xb.Geometry,!0),this.registerInput("geometry2",xb.Geometry,!0),this.registerInput("geometry3",xb.Geometry,!0),this.registerInput("geometry4",xb.Geometry,!0),this.registerInput("geometry5",xb.Geometry,!0),this.registerInput("geometry6",xb.Geometry,!0),this.registerInput("geometry7",xb.Geometry,!0),this.registerInput("geometry8",xb.Geometry,!0),this.registerInput("geometry9",xb.Geometry,!0),this.registerOutput("output",xb.Geometry),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"GeometryCollectionBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get geometry2(){return this._inputs[2]}get geometry3(){return this._inputs[3]}get geometry4(){return this._inputs[4]}get geometry5(){return this._inputs[5]}get geometry6(){return this._inputs[6]}get geometry7(){return this._inputs[7]}get geometry8(){return this._inputs[8]}get geometry9(){return this._inputs[9]}get output(){return this._outputs[0]}_storeGeometry(e,t,i,r){if(e.isConnected){const s=e.getConnectedValue(t);if(!s)return;s.metadata=s.metadata||{},s.metadata.collectionId=i,r.push(s)}}_buildBlock(e){const t=e=>{const t=[];return this._storeGeometry(this.geometry0,e,0,t),this._storeGeometry(this.geometry1,e,1,t),this._storeGeometry(this.geometry2,e,2,t),this._storeGeometry(this.geometry3,e,3,t),this._storeGeometry(this.geometry4,e,4,t),this._storeGeometry(this.geometry5,e,5,t),this._storeGeometry(this.geometry6,e,6,t),this._storeGeometry(this.geometry7,e,7,t),this._storeGeometry(this.geometry8,e,8,t),this._storeGeometry(this.geometry9,e,9,t),t.length?t[Math.round(Math.random()*(t.length-1))]:null};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],ry.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.GeometryCollectionBlock",ry);class sy extends Ib{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",xb.Geometry),this.registerOutput("output",xb.Geometry)}getClassName(){return"CleanGeometryBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(!this.geometry.isConnected)return null;const t=this.geometry.getConnectedValue(e).clone();if(!t.positions||!t.indices||!t.normals)return t;const i=t.indices,r=t.positions;return(0,Jv.Y4)(r,i),t};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],sy.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.CleanGeometryBlock",sy);class ny extends Ib{constructor(e){super(e),this.registerInput("input",xb.AutoDetect),this.registerOutput("output",xb.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}get buildExecutionTime(){return-1}getClassName(){return"GeometryElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];t._storedFunction=e=>i.getConnectedValue(e)}}(0,a.Y5)("BABYLON.GeometryElbowBlock",ny);class oy extends Ib{constructor(e){super(e),this.registerInput("geometry",xb.Geometry),this.registerOutput("output",xb.Geometry)}getClassName(){return"ComputeNormalsBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){this.output._storedFunction=e=>{if(!this.geometry.isConnected)return null;const t=this.geometry.getConnectedValue(e);return t?(t.normals||(t.normals=[]),ot.P.ComputeNormals(t.positions,t.indices,t.normals),t):null}}}(0,a.Y5)("BABYLON.ComputeNormalsBlock",oy);class ay extends Ib{constructor(e){super(e),this.registerInput("xyzw ",xb.Vector4,!0),this.registerInput("xyz ",xb.Vector3,!0),this.registerInput("xy ",xb.Vector2,!0),this.registerInput("zw ",xb.Vector2,!0),this.registerInput("x ",xb.Float,!0),this.registerInput("y ",xb.Float,!0),this.registerInput("z ",xb.Float,!0),this.registerInput("w ",xb.Float,!0),this.registerOutput("xyzw",xb.Vector4),this.registerOutput("xyz",xb.Vector3),this.registerOutput("xy",xb.Vector2),this.registerOutput("zw",xb.Vector2),this.registerOutput("x",xb.Float),this.registerOutput("y",xb.Float),this.registerOutput("z",xb.Float),this.registerOutput("w",xb.Float)}getClassName(){return"VectorConverterBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get xIn(){return this._inputs[4]}get yIn(){return this._inputs[5]}get zIn(){return this._inputs[6]}get wIn(){return this._inputs[7]}get xyzwOut(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xOut(){return this._outputs[4]}get yOut(){return this._outputs[5]}get zOut(){return this._outputs[6]}get wOut(){return this._outputs[7]}_inputRename(e){return"xyzw "===e?"xyzwIn":"xyz "===e?"xyzIn":"xy "===e?"xyIn":"zw "===e?"zwIn":"x "===e?"xIn":"y "===e?"yIn":"z "===e?"zIn":"w "===e?"wIn":e}_outputRename(e){switch(e){case"x":return"xOut";case"y":return"yOut";case"z":return"zOut";case"w":return"wOut";case"xy":return"xyOut";case"zw":return"zwOut";case"xyz":return"xyzOut";case"xyzw":return"xyzwOut";default:return e}}_buildBlock(e){super._buildBlock(e);const t=this.xIn,i=this.yIn,r=this.zIn,s=this.wIn,o=this.xyIn,a=this.zwIn,l=this.xyzIn,h=this.xyzwIn,c=this.xyzwOut,u=this.xyzOut,d=this.xyOut,p=this.zwOut,m=this.xOut,f=this.yOut,_=this.zOut,g=this.wOut,x=e=>{if(h.isConnected)return h.getConnectedValue(e);let c=0,u=0,d=0,p=0;if(t.isConnected&&(c=t.getConnectedValue(e)),i.isConnected&&(u=i.getConnectedValue(e)),r.isConnected&&(d=r.getConnectedValue(e)),s.isConnected&&(p=s.getConnectedValue(e)),o.isConnected){const t=o.getConnectedValue(e);t&&(c=t.x,u=t.y)}if(a.isConnected){const t=a.getConnectedValue(e);t&&(d=t.x,p=t.y)}if(l.isConnected){const t=l.getConnectedValue(e);t&&(c=t.x,u=t.y,d=t.z)}return new n.IU(c,u,d,p)};c._storedFunction=e=>x(e),u._storedFunction=e=>{const t=x(e);return new n.Pq(t.x,t.y,t.z)},d._storedFunction=e=>{const t=x(e);return new n.I9(t.x,t.y)},p._storedFunction=e=>{const t=x(e);return new n.I9(t.z,t.w)},m._storedFunction=e=>x(e).x,f._storedFunction=e=>x(e).y,_._storedFunction=e=>x(e).z,g._storedFunction=e=>x(e).w}}(0,a.Y5)("BABYLON.VectorConverterBlock",ay);class ly extends Ib{constructor(e){super(e),this.registerInput("input",xb.AutoDetect),this.registerOutput("output",xb.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(xb.Float),this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[0].excludedConnectionPointTypes.push(xb.Geometry),this._inputs[0].excludedConnectionPointTypes.push(xb.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NormalizeVectorBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.output._storedFunction=null,this.input.isConnected?this.output._storedFunction=e=>this.input.getConnectedValue(e).normalize():this.output._storedValue=null}}(0,a.Y5)("BABYLON.NormalizeVectorBlock",ly);class hy extends Ib{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",xb.Geometry),this.registerInput("id",xb.Int,!0,0),this.registerOutput("output",xb.Geometry),this.id.acceptedConnectionPointTypes.push(xb.Float)}getClassName(){return"SetMaterialIDBlock"}get geometry(){return this._inputs[0]}get id(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.geometry.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const t=e=>{const t=this.geometry.getConnectedValue(e);if(!t||!t.indices||!t.positions)return t;const i=new ot.o;return i.materialIndex=0|this.id.getConnectedValue(e),i.indexStart=0,i.indexCount=t.indices.length,i.verticesStart=0,i.verticesCount=t.positions.length/3,t.materialInfos=[i],t};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],hy.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.SetMaterialIDBlock",hy);class cy extends Ib{constructor(e){super(e),this._indexVector3=new n.Pq,this._currentControl=new n.Pq,this.evaluateContext=!0,this.resolutionX=3,this.resolutionY=3,this.resolutionZ=3,this.registerInput("geometry",xb.Geometry),this.registerInput("controls",xb.Vector3),this.registerOutput("output",xb.Geometry)}getExecutionIndex(){return this._currentIndexX+this.resolutionX*(this._currentIndexY+this.resolutionY*this._currentIndexZ)}getExecutionLoopIndex(){return this.getExecutionIndex()}getExecutionFaceIndex(){return 0}getClassName(){return"LatticeBlock"}get geometry(){return this._inputs[0]}get controls(){return this._inputs[1]}get output(){return this._outputs[0]}getOverridePositionsContextualValue(){return this._indexVector3}getOverrideNormalsContextualValue(){return this._currentControl}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),!this._vertexData||!this._vertexData.positions)return e.restoreExecutionContext(),void(this.output._storedValue=null);const t=this._vertexData.positions,i=(0,Jv.b8)(t,0,t.length/3),r=i.maximum.subtract(i.minimum);for(this._lattice=new FS({resolutionX:this.resolutionX,resolutionY:this.resolutionY,resolutionZ:this.resolutionZ,size:r,position:i.minimum.add(r.scale(.5))}),this._currentIndexX=0;this._currentIndexX<this.resolutionX;this._currentIndexX++)for(this._currentIndexY=0;this._currentIndexY<this.resolutionY;this._currentIndexY++)for(this._currentIndexZ=0;this._currentIndexZ<this.resolutionZ;this._currentIndexZ++){this._indexVector3.set(this._currentIndexX,this._currentIndexY,this._currentIndexZ);const t=this._lattice.data[this._currentIndexX][this._currentIndexY][this._currentIndexZ];this._currentControl.copyFrom(t);const i=this.controls.getConnectedValue(e);i&&t.set(i.x,i.y,i.z)}return this._lattice.deform(t),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`;return e+=`${this._codeVariableName}.resolutionX = ${this.resolutionX};\n`,e+=`${this._codeVariableName}.resolutionY = ${this.resolutionY};\n`,e+=`${this._codeVariableName}.resolutionZ = ${this.resolutionZ};\n`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.resolutionX=this.resolutionX,e.resolutionY=this.resolutionY,e.resolutionZ=this.resolutionZ,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext,this.resolutionX=e.resolutionX,this.resolutionY=e.resolutionY,this.resolutionZ=e.resolutionZ)}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],cy.prototype,"evaluateContext",void 0),(0,Ge.Cg)([xh("resolutionX",2,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:1,max:10})],cy.prototype,"resolutionX",void 0),(0,Ge.Cg)([xh("resolutionY",2,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:1,max:10})],cy.prototype,"resolutionY",void 0),(0,Ge.Cg)([xh("resolutionZ",2,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:1,max:10})],cy.prototype,"resolutionZ",void 0),(0,a.Y5)("BABYLON.LatticeBlock",cy),function(e){e[e.Cos=0]="Cos",e[e.Sin=1]="Sin",e[e.Abs=2]="Abs",e[e.Exp=3]="Exp",e[e.Round=4]="Round",e[e.Floor=5]="Floor",e[e.Ceiling=6]="Ceiling",e[e.Sqrt=7]="Sqrt",e[e.Log=8]="Log",e[e.Tan=9]="Tan",e[e.ArcTan=10]="ArcTan",e[e.ArcCos=11]="ArcCos",e[e.ArcSin=12]="ArcSin",e[e.Sign=13]="Sign",e[e.Negate=14]="Negate",e[e.OneMinus=15]="OneMinus",e[e.Reciprocal=16]="Reciprocal",e[e.ToDegrees=17]="ToDegrees",e[e.ToRadians=18]="ToRadians",e[e.Fract=19]="Fract",e[e.Exp2=20]="Exp2"}(Cb||(Cb={}));class uy extends Ib{constructor(e){super(e),this.operation=Cb.Cos,this.registerInput("input",xb.AutoDetect),this.registerOutput("output",xb.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[0].excludedConnectionPointTypes.push(xb.Geometry),this._inputs[0].excludedConnectionPointTypes.push(xb.Texture)}getClassName(){return"GeometryTrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=null;switch(this.operation){case Cb.Cos:t=e=>Math.cos(e);break;case Cb.Sin:t=e=>Math.sin(e);break;case Cb.Abs:t=e=>Math.abs(e);break;case Cb.Exp:t=e=>Math.exp(e);break;case Cb.Exp2:t=e=>Math.pow(2,e);break;case Cb.Round:t=e=>Math.round(e);break;case Cb.Floor:t=e=>Math.floor(e);break;case Cb.Ceiling:t=e=>Math.ceil(e);break;case Cb.Sqrt:t=e=>Math.sqrt(e);break;case Cb.Log:t=e=>Math.log(e);break;case Cb.Tan:t=e=>Math.tan(e);break;case Cb.ArcTan:t=e=>Math.atan(e);break;case Cb.ArcCos:t=e=>Math.acos(e);break;case Cb.ArcSin:t=e=>Math.asin(e);break;case Cb.Sign:t=e=>Math.sign(e);break;case Cb.Negate:t=e=>-e;break;case Cb.OneMinus:t=e=>1-e;break;case Cb.Reciprocal:t=e=>1/e;break;case Cb.ToRadians:t=e=>e*Math.PI/180;break;case Cb.ToDegrees:t=e=>180*e/Math.PI;break;case Cb.Fract:t=e=>e>=0?e-Math.floor(e):e-Math.ceil(e)}if(!t)return this.output._storedFunction=null,void(this.output._storedValue=null);switch(this.input.type){case xb.Int:case xb.Float:this.output._storedFunction=e=>{const i=this.input.getConnectedValue(e);return t(i)};break;case xb.Vector2:this.output._storedFunction=e=>{const i=this.input.getConnectedValue(e);return new n.I9(t(i.x),t(i.y))};break;case xb.Vector3:this.output._storedFunction=e=>{const i=this.input.getConnectedValue(e);return new n.Pq(t(i.x),t(i.y),t(i.z))};break;case xb.Vector4:this.output._storedFunction=e=>{const i=this.input.getConnectedValue(e);return new n.IU(t(i.x),t(i.y),t(i.z),t(i.w))}}return this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.GeometryTrigonometryBlockOperations.${Cb[this.operation]};\n`}}(0,Ge.Cg)([xh("Operation",4,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},options:[{label:"Cos",value:Cb.Cos},{label:"Sin",value:Cb.Sin},{label:"Abs",value:Cb.Abs},{label:"Exp",value:Cb.Exp},{label:"Exp2",value:Cb.Exp2},{label:"Round",value:Cb.Round},{label:"Floor",value:Cb.Floor},{label:"Ceiling",value:Cb.Ceiling},{label:"Sqrt",value:Cb.Sqrt},{label:"Log",value:Cb.Log},{label:"Tan",value:Cb.Tan},{label:"ArcTan",value:Cb.ArcTan},{label:"ArcCos",value:Cb.ArcCos},{label:"ArcSin",value:Cb.ArcSin},{label:"Sign",value:Cb.Sign},{label:"Negate",value:Cb.Negate},{label:"OneMinus",value:Cb.OneMinus},{label:"Reciprocal",value:Cb.Reciprocal},{label:"ToDegrees",value:Cb.ToDegrees},{label:"ToRadians",value:Cb.ToRadians},{label:"Fract",value:Cb.Fract}]})],uy.prototype,"operation",void 0),(0,a.Y5)("BABYLON.GeometryTrigonometryBlock",uy);class dy extends Ib{constructor(e){super(e),this._rotationMatrix=new n.uq,this._scalingMatrix=new n.uq,this._translationMatrix=new n.uq,this._scalingRotationMatrix=new n.uq,this._pivotMatrix=new n.uq,this._backPivotMatrix=new n.uq,this._transformMatrix=new n.uq,this.evaluateContext=!0,this.registerInput("value",xb.AutoDetect),this.registerInput("matrix",xb.Matrix,!0),this.registerInput("translation",xb.Vector3,!0,n.Pq.Zero()),this.registerInput("rotation",xb.Vector3,!0,n.Pq.Zero()),this.registerInput("scaling",xb.Vector3,!0,n.Pq.One()),this.registerInput("pivot",xb.Vector3,!0,n.Pq.Zero()),this.registerOutput("output",xb.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(xb.Float),this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[0].excludedConnectionPointTypes.push(xb.Texture)}getClassName(){return"GeometryTransformBlock"}get value(){return this._inputs[0]}get matrix(){return this._inputs[1]}get translation(){return this._inputs[2]}get rotation(){return this._inputs[3]}get scaling(){return this._inputs[4]}get pivot(){return this._inputs[5]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.value.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const t=e=>{const t=this.value.getConnectedValue(e);if(!t)return null;let i;if(this.matrix.isConnected)i=this.matrix.getConnectedValue(e);else{const t=this.scaling.getConnectedValue(e)||n.Pq.OneReadOnly,r=this.rotation.getConnectedValue(e)||n.Pq.ZeroReadOnly,s=this.translation.getConnectedValue(e)||n.Pq.ZeroReadOnly,o=this.pivot.getConnectedValue(e)||n.Pq.ZeroReadOnly;n.uq.TranslationToRef(-o.x,-o.y,-o.z,this._pivotMatrix),n.uq.ScalingToRef(t.x,t.y,t.z,this._scalingMatrix),n.uq.RotationYawPitchRollToRef(r.y,r.x,r.z,this._rotationMatrix),n.uq.TranslationToRef(s.x+o.x,s.y+o.y,s.z+o.z,this._translationMatrix),this._pivotMatrix.multiplyToRef(this._scalingMatrix,this._backPivotMatrix),this._backPivotMatrix.multiplyToRef(this._rotationMatrix,this._scalingRotationMatrix),this._scalingRotationMatrix.multiplyToRef(this._translationMatrix,this._transformMatrix),i=this._transformMatrix}switch(this.value.type){case xb.Geometry:{const e=t.clone();return e.transform(i),e}case xb.Vector2:return n.I9.Transform(t,i);case xb.Vector3:return n.Pq.TransformCoordinates(t,i);case xb.Vector4:return n.IU.TransformCoordinates(t,i)}return null};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],dy.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.GeometryTransformBlock",dy);class py extends Ib{constructor(e){super(e),this.registerInput("angle",xb.Float,!0,0),this.registerOutput("matrix",xb.Matrix)}getClassName(){return"RotationXBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>n.uq.RotationX(this.angle.getConnectedValue(e))}}(0,a.Y5)("BABYLON.RotationXBlock",py);class my extends Ib{constructor(e){super(e),this.registerInput("angle",xb.Float,!0,0),this.registerOutput("matrix",xb.Matrix)}getClassName(){return"RotationYBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>n.uq.RotationY(this.angle.getConnectedValue(e))}}(0,a.Y5)("BABYLON.RotationYBlock",my);class fy extends Ib{constructor(e){super(e),this.registerInput("angle",xb.Float,!0,0),this.registerOutput("matrix",xb.Matrix)}getClassName(){return"RotationZBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>n.uq.RotationZ(this.angle.getConnectedValue(e))}}(0,a.Y5)("BABYLON.RotationZBlock",fy);class _y extends Ib{constructor(e){super(e),this.registerInput("scale",xb.Vector3,!1,n.Pq.One()),this.registerOutput("matrix",xb.Matrix)}getClassName(){return"ScalingBlock"}get scale(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.scale.isConnected){const e=new Db("Scale");e.value=new n.Pq(1,1,1),e.output.connectTo(this.scale)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>{const t=this.scale.getConnectedValue(e);return n.uq.Scaling(t.x,t.y,t.z)}}}(0,a.Y5)("BABYLON.ScalingBlock",_y);class gy extends Ib{constructor(e){super(e),this.registerInput("source",xb.Vector3,!0,n.Pq.Up()),this.registerInput("target",xb.Vector3,!0,n.Pq.Left()),this.registerOutput("matrix",xb.Matrix)}getClassName(){return"AlignBlock"}get source(){return this._inputs[0]}get target(){return this._inputs[1]}get matrix(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>{const t=this.source.getConnectedValue(e).clone(),i=this.target.getConnectedValue(e).clone(),r=new n.uq;return t.normalize(),i.normalize(),n.uq.RotationAlignToRef(t,i,r,!0),r}}}(0,a.Y5)("BABYLON.AlignBlock",gy);class xy extends Ib{constructor(e){super(e),this.registerInput("translation",xb.Vector3,!1,n.Pq.Zero()),this.registerOutput("matrix",xb.Matrix)}getClassName(){return"TranslationBlock"}get translation(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.translation.isConnected){const e=new Db("Translation");e.value=new n.Pq(0,0,0),e.output.connectTo(this.translation)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>{const t=this.translation.getConnectedValue(e);return n.uq.Translation(t.x,t.y,t.z)}}}(0,a.Y5)("BABYLON.TranslationBlock",xy);class vy extends Ib{constructor(e){super(e),this._indexTranslation=null,this.evaluateContext=!0,this.removeDuplicatedPositions=!0,this.registerInput("geometry",xb.Geometry),this.registerInput("instance",xb.Geometry,!0),this.registerInput("density",xb.Float,!0,1,0,1),this.registerInput("matrix",xb.Matrix,!0),this.registerInput("offset",xb.Vector3,!0,n.Pq.Zero()),this.registerInput("rotation",xb.Vector3,!0,n.Pq.Zero()),this.registerInput("scaling",xb.Vector3,!0,n.Pq.One()),this.scaling.acceptedConnectionPointTypes.push(xb.Float),this.registerOutput("output",xb.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return this._indexTranslation?this._indexTranslation[this._currentIndex]:this._currentIndex}getExecutionLoopIndex(){return this._currentLoopIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateOnVerticesBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get density(){return this._inputs[2]}get matrix(){return this._inputs[3]}get offset(){return this._inputs[4]}get rotation(){return this._inputs[5]}get scaling(){return this._inputs[6]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),e.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(e),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this.instance.isConnected)return e.restoreExecutionContext(),e.restoreInstancingContext(),e.restoreGeometryContext(),void(this.output._storedValue=null);let t=this._vertexData.positions.length/3;const i=[],r=new n.Pq,s=[];let o=this._vertexData.positions;if(this._currentLoopIndex=0,this.removeDuplicatedPositions){for(this._indexTranslation={},this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const e=o[3*this._currentIndex],t=o[3*this._currentIndex+1],i=o[3*this._currentIndex+2];let r=!1;for(let n=0;n<s.length;n+=3)if(Math.abs(s[n]-e)<ut.bH&&Math.abs(s[n+1]-t)<ut.bH&&Math.abs(s[n+2]-i)<ut.bH){r=!0;break}r||(this._indexTranslation[s.length/3]=this._currentIndex,s.push(e,t,i))}o=s,t=o.length/3}else this._indexTranslation=null;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.instance.getConnectedValue(e);if(!t||!t.positions||0===t.positions.length)continue;const s=this.density.getConnectedValue(e);if(s<1&&Math.random()>s)continue;r.fromArray(o,3*this._currentIndex);const a=t.clone();if(this.matrix.isConnected){const t=this.matrix.getConnectedValue(e);e._instantiateWithPositionAndMatrix(a,r,t,i)}else{const t=e.adaptInput(this.offset,xb.Vector3,n.Pq.ZeroReadOnly),s=e.adaptInput(this.scaling,xb.Vector3,n.Pq.OneReadOnly),o=this.rotation.getConnectedValue(e)||n.Pq.ZeroReadOnly;r.addInPlace(t),e._instantiate(a,r,o,s,i)}this._currentLoopIndex++}if(e.restoreGeometryContext(),e.restoreExecutionContext(),e.restoreInstancingContext(),!i.length)return null;if(1===i.length)this._vertexData=i[0];else{const e=i.splice(0,1)[0];this._vertexData=e.merge(i,!0,!1,!0,!0)}return this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.removeDuplicatedPositions = ${this.removeDuplicatedPositions?"true":"false"};\n`;return e+=`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`,e}serialize(){const e=super.serialize();return e.removeDuplicatedPositions=this.removeDuplicatedPositions,e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.removeDuplicatedPositions=e.removeDuplicatedPositions,void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],vy.prototype,"evaluateContext",void 0),(0,Ge.Cg)([xh("Remove duplicated positions",0,"ADVANCED",{notifiers:{update:!0}})],vy.prototype,"removeDuplicatedPositions",void 0),(0,a.Y5)("BABYLON.InstantiateOnVerticesBlock",vy);class Sy extends Ib{constructor(e){super(e),this._currentPosition=new n.Pq,this._currentUV=new n.I9,this._vertex0=new n.Pq,this._vertex1=new n.Pq,this._vertex2=new n.Pq,this._tempVector0=new n.Pq,this._tempVector1=new n.Pq,this._uv0=new n.I9,this._uv1=new n.I9,this._uv2=new n.I9,this.evaluateContext=!0,this.registerInput("geometry",xb.Geometry),this.registerInput("instance",xb.Geometry,!0),this.registerInput("count",xb.Int,!0,256),this.registerInput("matrix",xb.Matrix,!0),this.registerInput("offset",xb.Vector3,!0,n.Pq.Zero()),this.registerInput("rotation",xb.Vector3,!0,n.Pq.Zero()),this.registerInput("scaling",xb.Vector3,!0,n.Pq.One()),this.scaling.acceptedConnectionPointTypes.push(xb.Float),this.registerOutput("output",xb.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return 0}getExecutionFaceIndex(){return this._currentFaceIndex}getExecutionLoopIndex(){return this._currentLoopIndex}getOverridePositionsContextualValue(){return this._currentPosition}getOverrideNormalsContextualValue(){return this._vertex1.subtractToRef(this._vertex0,this._tempVector0),this._vertex2.subtractToRef(this._vertex1,this._tempVector1),this._tempVector0.normalize(),this._tempVector1.normalize(),n.Pq.Cross(this._tempVector1,this._tempVector0)}getOverrideUVs1ContextualValue(){return this._currentUV}getClassName(){return"InstantiateOnFacesBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get count(){return this._inputs[2]}get matrix(){return this._inputs[3]}get offset(){return this._inputs[4]}get rotation(){return this._inputs[5]}get scaling(){return this._inputs[6]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),e.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(e),e.pushGeometryContext(this._vertexData),!(this._vertexData&&this._vertexData.positions&&this._vertexData.indices&&this.instance.isConnected))return e.restoreExecutionContext(),e.restoreInstancingContext(),e.restoreGeometryContext(),void(this.output._storedValue=null);let t=null;const i=this.count.getConnectedValue(e),r=this._vertexData.indices.length/3,s=i/r;let o=0;const a=[];let l=0;for(this._currentLoopIndex=0,this._currentFaceIndex=0;this._currentFaceIndex<r;this._currentFaceIndex++){o+=s;const r=(0|o)-l;if(r<1)continue;const h=this._vertexData.indices[3*this._currentFaceIndex],c=this._vertexData.indices[3*this._currentFaceIndex+1],u=this._vertexData.indices[3*this._currentFaceIndex+2];this._vertex0.fromArray(this._vertexData.positions,3*h),this._vertex1.fromArray(this._vertexData.positions,3*c),this._vertex2.fromArray(this._vertexData.positions,3*u),this._vertexData.uvs&&(this._uv0.fromArray(this._vertexData.uvs,2*h),this._uv1.fromArray(this._vertexData.uvs,2*c),this._uv2.fromArray(this._vertexData.uvs,2*u));for(let h=0;h<r&&!(l>=i);h++){let i=Math.random(),r=Math.random();if(i>r){const e=i;i=r,r=e}const h=i,c=r-i,u=1-h-c;if(this._currentPosition.set(h*this._vertex0.x+c*this._vertex1.x+u*this._vertex2.x,h*this._vertex0.y+c*this._vertex1.y+u*this._vertex2.y,h*this._vertex0.z+c*this._vertex1.z+u*this._vertex2.z),this._vertexData.uvs&&this._currentUV.set(h*this._uv0.x+c*this._uv1.x+u*this._uv2.x,h*this._uv0.y+c*this._uv1.y+u*this._uv2.y),t=this.instance.getConnectedValue(e),!t||!t.positions||0===t.positions.length){o-=s;continue}const d=t.clone();if(this.matrix.isConnected){const t=this.matrix.getConnectedValue(e);e._instantiateWithPositionAndMatrix(d,this._currentPosition,t,a)}else{const t=e.adaptInput(this.offset,xb.Vector3,n.Pq.ZeroReadOnly),i=e.adaptInput(this.scaling,xb.Vector3,n.Pq.OneReadOnly),r=this.rotation.getConnectedValue(e)||n.Pq.ZeroReadOnly;this._currentPosition.addInPlace(t),e._instantiate(d,this._currentPosition,r,i,a)}l++,this._currentLoopIndex++}}if(a.length)if(1===a.length)this._vertexData=a[0];else{const e=a.splice(0,1)[0];this._vertexData=e.merge(a,!0,!1,!0,!0)}return e.restoreExecutionContext(),e.restoreInstancingContext(),e.restoreGeometryContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],Sy.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.InstantiateOnFacesBlock",Sy);class by extends Ib{constructor(e){super(e),this._currentPosition=new n.Pq,this._vertex0=new n.Pq,this._vertex1=new n.Pq,this._vertex2=new n.Pq,this.evaluateContext=!0,this.gridMode=!1,this.registerInput("geometry",xb.Geometry),this.registerInput("instance",xb.Geometry,!0),this.registerInput("count",xb.Int,!0,256),this.registerInput("matrix",xb.Matrix,!0),this.registerInput("offset",xb.Vector3,!0,n.Pq.Zero()),this.registerInput("rotation",xb.Vector3,!0,n.Pq.Zero()),this.registerInput("scaling",xb.Vector3,!0,n.Pq.One()),this.registerInput("gridSize",xb.Int,!0,10),this.scaling.acceptedConnectionPointTypes.push(xb.Float),this.registerOutput("output",xb.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return 0}getExecutionFaceIndex(){return 0}getExecutionLoopIndex(){return this._currentLoopIndex}getOverridePositionsContextualValue(){return this._currentPosition}getClassName(){return"InstantiateOnVolumeBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get count(){return this._inputs[2]}get matrix(){return this._inputs[3]}get offset(){return this._inputs[4]}get rotation(){return this._inputs[5]}get scaling(){return this._inputs[6]}get gridSize(){return this._inputs[6]}get output(){return this._outputs[0]}_getValueOnGrid(e,t,i,r){const s=(r-i)/t;return i+s/2+e*s}_getIndexinGrid(e,t,i,r){return e+t*r+i*r*r}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),e.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(e),e.pushGeometryContext(this._vertexData),!(this._vertexData&&this._vertexData.positions&&this._vertexData.indices&&this.instance.isConnected))return e.restoreExecutionContext(),e.restoreInstancingContext(),e.restoreGeometryContext(),void(this.output._storedValue=null);let t=null;const i=this.count.getConnectedValue(e),r=[],s=(0,Jv.b8)(this._vertexData.positions,0,this._vertexData.positions.length/3),o=s.minimum,a=s.maximum,l=new n.Pq(.5,.8,.2),h=this._vertexData.indices.length/3,c=this.gridSize.getConnectedValue(e);let u;if(this._currentLoopIndex=0,this.gridMode){u=[];for(let e=0;e<c*c*c;e++)u[e]=!1}for(let s=0;s<i;s++){if(this.gridMode){let e=Math.floor(Math.random()*c),t=Math.floor(Math.random()*c),i=Math.floor(Math.random()*c),r=this._getIndexinGrid(e,t,i,c);if(u[r]){let s=!1;for(let n=0;n<c*c*c;n++)if(!u[n]){i=Math.floor(n/(c*c)),t=Math.floor((n-i*c*c)/c),e=n-i*c*c-t*c,r=this._getIndexinGrid(e,t,i,c),s=!0;break}if(!s)break}if(!u[r]){const s=this._getValueOnGrid(e,c,o.x,a.x),n=this._getValueOnGrid(t,c,o.y,a.y),l=this._getValueOnGrid(i,c,o.z,a.z);this._currentPosition.set(s,n,l),u[r]=!0}}else this._currentPosition.set(Math.random()*(a.x-o.x)+o.x,Math.random()*(a.y-o.y)+o.y,Math.random()*(a.z-o.z)+o.z);const i=new st.Ray(this._currentPosition,l);let d=0;for(let e=0;e<h;e++){this._vertex0.fromArray(this._vertexData.positions,3*this._vertexData.indices[3*e]),this._vertex1.fromArray(this._vertexData.positions,3*this._vertexData.indices[3*e+1]),this._vertex2.fromArray(this._vertexData.positions,3*this._vertexData.indices[3*e+2]);const t=i.intersectsTriangle(this._vertex0,this._vertex1,this._vertex2);t&&t.distance>0&&d++}if(d%2==0){s--;continue}if(t=this.instance.getConnectedValue(e),!t||!t.positions||0===t.positions.length)continue;const p=t.clone();if(this.matrix.isConnected){const t=this.matrix.getConnectedValue(e);e._instantiateWithPositionAndMatrix(p,this._currentPosition,t,r)}else{const t=e.adaptInput(this.offset,xb.Vector3,n.Pq.ZeroReadOnly),i=e.adaptInput(this.scaling,xb.Vector3,n.Pq.OneReadOnly),s=this.rotation.getConnectedValue(e)||n.Pq.ZeroReadOnly;this._currentPosition.addInPlace(t),e._instantiate(p,this._currentPosition,s,i,r)}this._currentLoopIndex++}if(r.length)if(1===r.length)this._vertexData=r[0];else{const e=r.splice(0,1)[0];this._vertexData=e.merge(r,!0,!1,!0,!0)}return e.restoreGeometryContext(),e.restoreExecutionContext(),e.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`;return e+=`${this._codeVariableName}.gridMode = ${this.gridMode?"true":"false"};\n`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.gridMode=this.gridMode,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext),void 0!==e.gridMode&&(this.gridMode=e.gridMode)}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],by.prototype,"evaluateContext",void 0),(0,Ge.Cg)([xh("Grid mode",0,"MODES",{notifiers:{rebuild:!0}})],by.prototype,"gridMode",void 0),(0,a.Y5)("BABYLON.InstantiateOnVolumeBlock",by);class yy extends Ib{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("instance",xb.Geometry,!0),this.registerInput("count",xb.Int,!0,1),this.registerOutput("output",xb.Geometry)}getInstanceIndex(){return this._currentIndex}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateBaseBlock"}get instance(){return this._inputs[0]}get count(){return this._inputs[1]}get output(){return this._outputs[0]}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],yy.prototype,"evaluateContext",void 0);class Py extends yy{constructor(e){super(e),this.registerInput("matrix",xb.Matrix,!0),this.registerInput("position",xb.Vector3,!0,n.Pq.Zero()),this.registerInput("rotation",xb.Vector3,!0,n.Pq.Zero()),this.registerInput("scaling",xb.Vector3,!0,n.Pq.One()),this.scaling.acceptedConnectionPointTypes.push(xb.Float)}getInstanceIndex(){return this._currentIndex}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateBlock"}get matrix(){return this._inputs[2]}get position(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}_buildBlock(e){const t=e=>{e.pushExecutionContext(this),e.pushInstancingContext(this);const t=this.count.getConnectedValue(e),i=[];for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.instance.getConnectedValue(e);if(!t||!t.positions||0===t.positions.length)continue;const r=t.clone();if(this.matrix.isConnected){const t=this.matrix.getConnectedValue(e);e._instantiateWithMatrix(r,t,i)}else{const t=this.position.getConnectedValue(e)||n.Pq.ZeroReadOnly,s=e.adaptInput(this.scaling,xb.Vector3,n.Pq.OneReadOnly),o=this.rotation.getConnectedValue(e)||n.Pq.ZeroReadOnly;e._instantiate(r,t,o,s,i)}}if(i.length)if(1===i.length)this._vertexData=i[0];else{const e=i.splice(0,1)[0];this._vertexData=e.merge(i,!0,!1,!0,!0)}return e.restoreExecutionContext(),e.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}}(0,a.Y5)("BABYLON.InstantiateBlock",Py);class Ty extends yy{constructor(e){super(e),this.registerInput("direction",xb.Vector3,!0,new n.Pq(1,0,0)),this.registerInput("rotation",xb.Vector3,!0,new n.Pq(0,0,0)),this.registerInput("scaling",xb.Vector3,!0,new n.Pq(0,0,0)),this.scaling.acceptedConnectionPointTypes.push(xb.Float)}getClassName(){return"InstantiateLinearBlock"}get direction(){return this._inputs[2]}get rotation(){return this._inputs[3]}get scaling(){return this._inputs[4]}_buildBlock(e){const t=e=>{e.pushExecutionContext(this),e.pushInstancingContext(this);const t=this.count.getConnectedValue(e),i=[],r=n.uq.Identity(),s=n.Pq.Zero(),o=n.Pq.Zero(),a=n.Pq.Zero();for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.instance.getConnectedValue(e);if(!t||!t.positions||0===t.positions.length)continue;const l=t.clone(),h=this.direction.getConnectedValue(e),c=this.rotation.getConnectedValue(e),u=e.adaptInput(this.scaling,xb.Vector3,n.Pq.OneReadOnly);s.copyFrom(h.clone().scale(this._currentIndex)),o.copyFrom(c.clone().scale(this._currentIndex)),a.copyFrom(u.clone().scale(this._currentIndex)),a.addInPlaceFromFloats(1,1,1),n.uq.ComposeToRef(a,n.PT.FromEulerAngles(o.x,o.y,o.z),s,r),e._instantiateWithMatrix(l,r,i)}if(i.length)if(1===i.length)this._vertexData=i[0];else{const e=i.splice(0,1)[0];this._vertexData=e.merge(i,!0,!1,!0,!0)}return e.restoreExecutionContext(),e.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}}(0,a.Y5)("BABYLON.InstantiateLinearBlock",Ty);class Cy extends yy{constructor(e){super(e),this.registerInput("radius",xb.Int,!0,0,0),this.registerInput("angleStart",xb.Float,!0,0),this.registerInput("angleEnd",xb.Float,!0,2*Math.PI),this.registerInput("transform",xb.Vector3,!0,new n.Pq(0,0,0)),this.registerInput("rotation",xb.Vector3,!0,new n.Pq(0,0,0)),this.registerInput("scaling",xb.Vector3,!0,new n.Pq(0,0,0)),this.scaling.acceptedConnectionPointTypes.push(xb.Float)}getClassName(){return"InstantiateRadialBlock"}get radius(){return this._inputs[2]}get angleStart(){return this._inputs[3]}get angleEnd(){return this._inputs[4]}get transform(){return this._inputs[5]}get rotation(){return this._inputs[6]}get scaling(){return this._inputs[7]}_buildBlock(e){const t=e=>{e.pushExecutionContext(this),e.pushInstancingContext(this);const t=this.count.getConnectedValue(e),i=[],r=n.uq.Identity(),s=n.uq.Identity(),o=n.uq.Identity(),a=n.Pq.Zero(),l=n.Pq.Zero(),h=n.Pq.Zero();for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const c=this.instance.getConnectedValue(e);if(!c||!c.positions||0===c.positions.length)continue;const u=c.clone(),d=this.radius.getConnectedValue(e),p=this.angleStart.getConnectedValue(e),m=this.angleEnd.getConnectedValue(e),f=this.transform.getConnectedValue(e),_=this.rotation.getConnectedValue(e),g=e.adaptInput(this.scaling,xb.Vector3,n.Pq.OneReadOnly),x=p+(m-p)/t*this._currentIndex,v=n.PT.FromEulerAngles(0,x,0);a.copyFrom(f.clone().scale(this._currentIndex)),l.copyFrom(_.clone().scale(this._currentIndex)),h.copyFrom(g.clone().scale(this._currentIndex)),h.addInPlaceFromFloats(1,1,1),n.uq.RotationYawPitchRollToRef(l.y,l.x,l.z,r),s.setTranslationFromFloats(0,0,d),n.uq.ComposeToRef(h,v,a,o),r.multiplyToRef(s,s),s.multiplyToRef(o,o),e._instantiateWithMatrix(u,o,i)}if(i.length)if(1===i.length)this._vertexData=i[0];else{const e=i.splice(0,1)[0];this._vertexData=e.merge(i,!0,!1,!0,!0)}return e.restoreExecutionContext(),e.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}}(0,a.Y5)("BABYLON.InstantiateRadialBlock",Cy);class Ey extends Ib{constructor(e){super(e),this.registerInput("float ",xb.Float,!0),this.registerInput("int ",xb.Int,!0),this.registerOutput("float",xb.Float),this.registerOutput("int",xb.Int)}getClassName(){return"IntFloatConverterBlock"}get floatIn(){return this._inputs[0]}get intIn(){return this._inputs[1]}get floatOut(){return this._outputs[0]}get intOut(){return this._outputs[1]}_inputRename(e){return"float "===e?"floatIn":"int "===e?"intIn":e}_buildBlock(){this.floatOut._storedFunction=e=>this.floatIn.isConnected?this.floatIn.getConnectedValue(e):this.intIn.isConnected?this.intIn.getConnectedValue(e):0,this.intOut._storedFunction=e=>this.floatIn.isConnected?Math.floor(this.floatIn.getConnectedValue(e)):this.intIn.isConnected?Math.floor(this.intIn.getConnectedValue(e)):0}}(0,a.Y5)("BABYLON.IntFloatConverterBlock",Ey);class Ay extends Ib{constructor(e){super(e),this.log=[],this._isDebug=!0,this.registerInput("input",xb.AutoDetect),this.registerOutput("output",xb.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(xb.Geometry),this._inputs[0].excludedConnectionPointTypes.push(xb.Texture)}get buildExecutionTime(){return-1}getClassName(){return"DebugBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.input.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);this.log=[];const t=e=>{const t=this.input.getConnectedValue(e);if(null==t)return this.log.push(["null",""]),t;switch(this.input.type){case xb.Vector2:this.log.push([rS(t,4),t.toString()]);break;case xb.Vector3:this.log.push([sS(t,4),t.toString()]);break;case xb.Vector4:this.log.push([nS(t,4),t.toString()]);break;default:this.log.push([t.toString(),t.toString()])}return t};this.output.isConnected?this.output._storedFunction=t:this.output._storedValue=t(e)}}(0,a.Y5)("BABYLON.DebugBlock",Ay);class Iy extends Ib{constructor(e){super(e),this.registerInput("geometry",xb.Geometry),this.registerOutput("output",xb.Geometry),this.registerOutput("id",xb.Int),this.registerOutput("collectionId",xb.Int),this.registerOutput("verticesCount",xb.Int),this.registerOutput("facesCount",xb.Int)}getClassName(){return"GeometryInfoBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}get id(){return this._outputs[1]}get collectionId(){return this._outputs[2]}get verticesCount(){return this._outputs[3]}get facesCount(){return this._outputs[4]}_buildBlock(){if(!this.geometry.isConnected)return this.id._storedValue=0,this.collectionId._storedValue=0,this.verticesCount._storedValue=0,this.facesCount._storedValue=0,this.output._storedValue=0,this.id._storedFunction=null,this.collectionId._storedFunction=null,this.verticesCount._storedFunction=null,this.facesCount._storedFunction=null,void(this.output._storedFunction=null);this.output._storedFunction=e=>(this._currentVertexData=this.geometry.getConnectedValue(e),this._currentVertexData),this.id._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.uniqueId),this.collectionId._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.metadata?this._currentVertexData.metadata.collectionId:0),this.verticesCount._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.positions?this._currentVertexData.positions.length/3:0),this.facesCount._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.indices?this._currentVertexData.indices.length/3:0)}}(0,a.Y5)("BABYLON.GeometryInfoBlock",Iy),function(e){e[e.Spherical=0]="Spherical",e[e.Cylindrical=1]="Cylindrical",e[e.Cubic=2]="Cubic"}(Eb||(Eb={}));class Ry extends Ib{constructor(e){super(e),this.mapping=Eb.Spherical,this.registerInput("position",xb.Vector3),this.registerInput("normal",xb.Vector3),this.registerInput("center",xb.Vector3,!0,n.Pq.Zero()),this.registerOutput("uv",xb.Vector2)}getClassName(){return"MappingBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get center(){return this._inputs[2]}get uv(){return this._outputs[0]}_buildBlock(){if(!this.position.isConnected)return this.uv._storedFunction=null,void(this.uv._storedValue=null);const e=n.Pq.Zero(),t=t=>{const i=this.position.getConnectedValue(t)||n.Pq.Zero(),r=this.normal.getConnectedValue(t)||n.Pq.Zero(),s=this.center.getConnectedValue(t),o=n.I9.Zero();switch(this.mapping){case Eb.Spherical:{i.subtractToRef(s,e);const t=e.length();t>0&&(o.x=Math.acos(e.y/t)/Math.PI,0===e.x&&0===e.z||(o.y=Math.atan2(e.x,e.z)/(2*Math.PI)));break}case Eb.Cylindrical:{i.subtractToRef(s,e);const t=e.length();t>0&&(o.x=Math.atan2(e.x/t,e.z/t)/(2*Math.PI),o.y=(e.y+1)/2);break}case Eb.Cubic:{const e=Math.abs(r.x),t=Math.abs(r.y),n=Math.abs(r.z),a=Math.max(Math.abs(i.x),Math.abs(i.y),Math.abs(i.z));let l=0,h=0;e>=t&&e>=n?(l=i.y/a-s.y,h=i.z/a-s.z):t>=e&&t>=n?(l=i.x/a-s.x,h=i.z/a-s.z):(l=i.x/a-s.x,h=i.y/a-s.y),o.x=(l+1)/2,o.y=(h+1)/2}}return o};this.uv._storedFunction=e=>t(e)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.mapping = BABYLON.MappingTypes.${Eb[this.mapping]};\n`}serialize(){const e=super.serialize();return e.mapping=this.mapping,e}_deserialize(e){super._deserialize(e),this.mapping=e.mapping}}(0,Ge.Cg)([xh("Mapping",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Spherical",value:Eb.Spherical},{label:"Cylindrical",value:Eb.Cylindrical},{label:"Cubic",value:Eb.Cubic}]})],Ry.prototype,"mapping",void 0),(0,a.Y5)("BABYLON.MappingBlock",Ry);class My extends Ib{constructor(e){super(e),this.registerInput("matrix0",xb.Matrix),this.registerInput("matrix1",xb.Matrix),this.registerOutput("output",xb.Matrix)}getClassName(){return"MatrixComposeBlock"}get matrix0(){return this._inputs[0]}get matrix1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){this.output._storedFunction=e=>{if(!this.matrix0.isConnected||!this.matrix1.isConnected)return null;const t=this.matrix0.getConnectedValue(e),i=this.matrix1.getConnectedValue(e);return t&&i?t.multiply(i):null}}}(0,a.Y5)("BABYLON.MatrixComposeBlock",My);class Dy extends Ib{get endpoints(){return this._endpoints}constructor(e){super(e),this._endpoints=[],this._isTeleportIn=!0,this.registerInput("input",xb.AutoDetect)}getClassName(){return"TeleportInBlock"}get input(){return this._inputs[0]}_dumpCode(e,t){let i=super._dumpCode(e,t);for(const r of this.endpoints)-1===t.indexOf(r)&&(i+=r._dumpCode(e,t));return i}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(const t of this.endpoints)if(t.isAnAncestorOfType(e))return!0;return!1}isAnAncestorOf(e){for(const t of this.endpoints){if(t===e)return!0;if(t.isAnAncestorOf(e))return!0}return!1}getDescendantOfPredicate(e){if(e(this))return this;for(const t of this.endpoints){const i=t.getDescendantOfPredicate(e);if(i)return i}return null}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name}detachFromEndpoint(e){const t=this._endpoints.indexOf(e);-1!==t&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null)}_buildBlock(){for(const e of this._endpoints)e.output._storedFunction=e=>this.input.getConnectedValue(e)}}(0,a.Y5)("BABYLON.TeleportInBlock",Dy);class Oy extends Ib{constructor(e){super(e),this._entryPoint=null,this._tempEntryPointUniqueId=null,this._isTeleportOut=!0,this.registerOutput("output",xb.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"TeleportOutBlock"}get output(){return this._outputs[0]}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(){}_customBuildStep(e){this.entryPoint&&this.entryPoint.build(e)}_dumpCode(e,t){let i="";return this.entryPoint&&-1===t.indexOf(this.entryPoint)&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}clone(){const e=super.clone();return this.entryPoint&&this.entryPoint.attachToEndpoint(e),e}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});\n`),e}serialize(){const e=super.serialize();return e.entryPoint=this.entryPoint?.uniqueId??"",e}_deserialize(e){super._deserialize(e),this._tempEntryPointUniqueId=e.entryPoint}}(0,a.Y5)("BABYLON.TeleportOutBlock",Oy);var Ny,wy,Fy,By,Vy=i(42683);class Ly extends Ib{get textureData(){return this._data}get textureWidth(){return this._width}get textureHeight(){return this._height}constructor(e){super(e),this._data=null,this.serializedCachedData=!1,this.registerOutput("texture",xb.Texture)}getClassName(){return"GeometryTextureBlock"}get texture(){return this._outputs[0]}_prepareImgToLoadAsync(e){return new Promise(((t,i)=>{const r=new Image,s=document.createElement("canvas"),n=s.getContext("2d");r.onload=()=>{s.width=r.width,s.height=r.height,n.drawImage(r,0,0);const e=n.getImageData(0,0,r.width,r.height).data,i=new Float32Array(e.length);for(let t=0;t<e.length;t++)i[t]=e[t]/255;this._data=i,this._width=r.width,this._height=r.height,t()},r.onerror=()=>{this._data=null,i()},r.src=e}))}cleanData(){this._data=null}loadTextureFromFileAsync(e){return this._prepareImgToLoadAsync(URL.createObjectURL(e))}loadTextureFromUrlAsync(e){return this._prepareImgToLoadAsync(e)}extractFromTextureAsync(e){return new Promise(((t,i)=>{if(!e.isReady())return void e.onLoadObservable.addOnce((()=>this.extractFromTextureAsync(e).then(t).catch(i)));const r=e.getSize();Vy.LO.GetTextureDataAsync(e,r.width,r.height).then((async e=>{const i=new Float32Array(e.length);for(let t=0;t<e.length;t++)i[t]=e[t]/255;this._data=i,this._width=r.width,this._height=r.height,t()})).catch(i)}))}_buildBlock(){if(!this._data)return void(this.texture._storedValue=null);const e={data:this._data,width:this._width,height:this._height};this.texture._storedValue=e}serialize(){const e=super.serialize();return e.width=this._width,e.height=this._height,e.serializedCachedData=this.serializedCachedData,this._data&&this.serializedCachedData&&(e.data=Array.from(this._data)),e}_deserialize(e){super._deserialize(e),this._width=e.width,this._height=e.height,e.data?(this._data=new Float32Array(e.data),this.serializedCachedData=!0):this.serializedCachedData=!!e.serializedCachedData}}(0,Ge.Cg)([xh("Serialize cached data",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Ly.prototype,"serializedCachedData",void 0),(0,a.Y5)("BABYLON.GeometryTextureBlock",Ly);class ky extends Ib{constructor(e){super(e),this.clampCoordinates=!0,this.registerInput("texture",xb.Texture),this.registerInput("coordinates",xb.Vector2),this.registerOutput("rgba",xb.Vector4),this.registerOutput("rgb",xb.Vector3),this.registerOutput("r",xb.Float),this.registerOutput("g",xb.Float),this.registerOutput("b",xb.Float),this.registerOutput("a",xb.Float)}getClassName(){return"GeometryTextureFetchBlock"}get texture(){return this.inputs[0]}get coordinates(){return this.inputs[1]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}_repeatClamp(e){return e>=0?e%1:1-Math.abs(e)%1}_buildBlock(){const e=e=>{const t=this.texture.getConnectedValue(e);if(!t||!t.data)return null;const i=this.coordinates.getConnectedValue(e);if(!i)return null;const r=this.clampCoordinates?Math.max(0,Math.min(i.x,1)):this._repeatClamp(i.x),s=this.clampCoordinates?Math.max(0,Math.min(i.y,1)):this._repeatClamp(i.y),o=Math.floor(r*(t.width-1)),a=Math.floor(s*(t.height-1)),l=o+t.width*a;return n.IU.FromArray(t.data,4*l)};this.rgba._storedFunction=t=>e(t),this.rgb._storedFunction=t=>{const i=e(t);return i?i.toVector3():null},this.r._storedFunction=t=>{const i=e(t);return i?i.x:null},this.g._storedFunction=t=>{const i=e(t);return i?i.y:null},this.b._storedFunction=t=>{const i=e(t);return i?i.z:null},this.a._storedFunction=t=>{const i=e(t);return i?i.w:null}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.clampCoordinates = ${this.clampCoordinates};\n`}serialize(){const e=super.serialize();return e.clampCoordinates=this.clampCoordinates,e}_deserialize(e){super._deserialize(e),this.clampCoordinates=e.clampCoordinates}}(0,Ge.Cg)([xh("Clamp Coordinates",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],ky.prototype,"clampCoordinates",void 0),(0,a.Y5)("BABYLON.GeometryTextureFetchBlock",ky);class Gy extends Ib{constructor(e){super(e),this.registerInput("geometry",xb.Geometry),this.registerOutput("min",xb.Vector3),this.registerOutput("max",xb.Vector3)}getClassName(){return"BoundingBlock"}get geometry(){return this._inputs[0]}get min(){return this._outputs[0]}get max(){return this._outputs[1]}_buildBlock(){this.min._storedFunction=e=>{const t=this.geometry.getConnectedValue(e);if(!t)return null;return(0,Jv.b8)(t.positions,0,t.positions.length/3).minimum},this.max._storedFunction=e=>{const t=this.geometry.getConnectedValue(e);if(!t)return null;return(0,Jv.b8)(t.positions,0,t.positions.length/3).maximum}}}(0,a.Y5)("BABYLON.BoundingBlock",Gy),function(e){e[e.Intersect=0]="Intersect",e[e.Subtract=1]="Subtract",e[e.Union=2]="Union"}(Ny||(Ny={}));class zy extends Ib{get _isReadyState(){return nb()?null:(this._csg2LoadingPromise||(this._csg2LoadingPromise=ob()),this._csg2LoadingPromise)}constructor(e){super(e),this.evaluateContext=!1,this.operation=Ny.Intersect,this.useOldCSGEngine=!1,this.registerInput("geometry0",xb.Geometry),this.registerInput("geometry1",xb.Geometry),this.registerOutput("output",xb.Geometry)}getClassName(){return"BooleanGeometryBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{const t=this.geometry0.getConnectedValue(e),i=this.geometry1.getConnectedValue(e);if(!t||!i)return null;const r=t.positions.length/3;let s;if(!t.normals&&i.normals&&(t.normals=new Array(t.positions.length)),!i.normals&&t.normals&&(i.normals=new Array(i.positions.length)),!t.uvs&&i.uvs&&(t.uvs=new Array(2*r)),!i.uvs&&t.uvs&&(i.uvs=new Array(2*r)),!t.colors&&i.colors&&(t.colors=new Array(4*r)),!i.colors&&t.colors&&(i.colors=new Array(4*r)),this.useOldCSGEngine){const e=bS.FromVertexData(t),r=bS.FromVertexData(i);switch(this.operation){case Ny.Intersect:s=e.intersect(r);break;case Ny.Subtract:s=e.subtract(r);break;case Ny.Union:s=e.union(r)}}else{const e=sb.FromVertexData(t),r=sb.FromVertexData(i);switch(this.operation){case Ny.Intersect:s=e.intersect(r);break;case Ny.Subtract:s=e.subtract(r);break;case Ny.Union:s=e.add(r)}}return s.toVertexData()};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`;return e+=`${this._codeVariableName}.operation = BABYLON.BooleanGeometryOperations.${Ny[this.operation]};\n`,e+=`${this._codeVariableName}.useOldCSGEngine = ${this.useOldCSGEngine?"true":"false"};\n`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.operation=this.operation,e.useOldCSGEngine=this.useOldCSGEngine,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext,e.operation&&(this.operation=e.operation),this.useOldCSGEngine=!!e.useOldCSGEngine}}(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],zy.prototype,"evaluateContext",void 0),(0,Ge.Cg)([xh("Operation",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Intersect",value:Ny.Intersect},{label:"Subtract",value:Ny.Subtract},{label:"Union",value:Ny.Union}]})],zy.prototype,"operation",void 0),(0,Ge.Cg)([xh("Use old CSG engine",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],zy.prototype,"useOldCSGEngine",void 0),(0,a.Y5)("BABYLON.BooleanGeometryBlock",zy);class Uy extends Ib{constructor(e){super(e),this.registerInput("x",xb.AutoDetect),this.registerInput("y",xb.AutoDetect),this.registerOutput("output",xb.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[0].excludedConnectionPointTypes.push(xb.Geometry),this._inputs[0].excludedConnectionPointTypes.push(xb.Texture)}getClassName(){return"GeometryArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.x.isConnected||!this.y.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=(e,t)=>Math.atan2(e,t);this.output._storedFunction=t=>{const i=this.x.getConnectedValue(t),r=this.y.getConnectedValue(t);switch(this.x.type){case xb.Int:case xb.Float:return e(i,r);case xb.Vector2:return new n.I9(e(i.x,r.x),e(i.y,r.y));case xb.Vector3:return new n.Pq(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z));case xb.Vector4:return new n.IU(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z),e(i.w,r.w))}return 0}}}(0,a.Y5)("BABYLON.GeometryArcTan2Block",Uy);class Wy extends Ib{constructor(e){super(e),this.registerInput("left",xb.AutoDetect),this.registerInput("right",xb.AutoDetect),this.registerInput("gradient",xb.Float,!0,0,0,1),this.registerOutput("output",xb.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[0].excludedConnectionPointTypes.push(xb.Geometry),this._inputs[0].excludedConnectionPointTypes.push(xb.Texture)}getClassName(){return"GeometryLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=(e,t,i)=>(1-e)*t+e*i;return this.output._storedFunction=t=>{const i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t),s=this.gradient.getConnectedValue(t);switch(this.left.type){case xb.Int:case xb.Float:return e(s,i,r);case xb.Vector2:return new n.I9(e(s,i.x,r.x),e(s,i.y,r.y));case xb.Vector3:return new n.Pq(e(s,i.x,r.x),e(s,i.y,r.y),e(s,i.z,r.z));case xb.Vector4:return new n.IU(e(s,i.x,r.x),e(s,i.y,r.y),e(s,i.z,r.z),e(s,i.w,r.w))}return 0},this}}(0,a.Y5)("BABYLON.GeometryLerpBlock",Wy);class Hy extends Ib{constructor(e){super(e),this.registerInput("left",xb.AutoDetect),this.registerInput("right",xb.AutoDetect),this.registerInput("gradient",xb.Float,!0,0,0,1),this.registerOutput("output",xb.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[0].excludedConnectionPointTypes.push(xb.Geometry),this._inputs[0].excludedConnectionPointTypes.push(xb.Texture)}getClassName(){return"GeometryNLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=(e,t,i)=>(1-e)*t+e*i;return this.output._storedFunction=t=>{const i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t),s=this.gradient.getConnectedValue(t);switch(this.left.type){case xb.Int:case xb.Float:return e(s,i,r);case xb.Vector2:{const t=new n.I9(e(s,i.x,r.x),e(s,i.y,r.y));return t.normalize(),t}case xb.Vector3:{const t=new n.Pq(e(s,i.x,r.x),e(s,i.y,r.y),e(s,i.z,r.z));return t.normalize(),t}case xb.Vector4:{const t=new n.IU(e(s,i.x,r.x),e(s,i.y,r.y),e(s,i.z,r.z),e(s,i.w,r.w));return t.normalize(),t}}return 0},this}}(0,a.Y5)("BABYLON.GeometryNLerpBlock",Hy);class $y extends Ib{constructor(e){super(e),this.registerInput("value",xb.AutoDetect),this.registerInput("edge",xb.Float,!0,0),this.registerOutput("output",xb.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[0].excludedConnectionPointTypes.push(xb.Geometry),this._inputs[0].excludedConnectionPointTypes.push(xb.Texture)}getClassName(){return"GeometryStepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=(e,t)=>e<t?0:1;return this.output._storedFunction=t=>{const i=this.value.getConnectedValue(t),r=this.edge.getConnectedValue(t);switch(this.value.type){case xb.Int:case xb.Float:return e(i,r);case xb.Vector2:return new n.I9(e(i.x,r),e(i.y,r));case xb.Vector3:return new n.Pq(e(i.x,r),e(i.y,r),e(i.z,r));case xb.Vector4:return new n.IU(e(i.x,r),e(i.y,r),e(i.z,r),e(i.w,r))}return 0},this}}(0,a.Y5)("BABYLON.GeometryStepBlock",$y);class qy extends Ib{constructor(e){super(e),this.registerInput("value",xb.AutoDetect),this.registerInput("edge0",xb.Float,!0,0),this.registerInput("edge1",xb.Float,!0,1),this.registerOutput("output",xb.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[0].excludedConnectionPointTypes.push(xb.Geometry),this._inputs[0].excludedConnectionPointTypes.push(xb.Texture)}getClassName(){return"GeometrySmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=(e,t,i)=>{const r=Math.max(0,Math.min((e-t)/(i-t),1));return r*r*(3-2*r)};return this.output._storedFunction=t=>{const i=this.value.getConnectedValue(t),r=this.edge0.getConnectedValue(t),s=this.edge1.getConnectedValue(t);switch(this.value.type){case xb.Int:case xb.Float:return e(i,r,s);case xb.Vector2:return new n.I9(e(i.x,r,s),e(i.y,r,s));case xb.Vector3:return new n.Pq(e(i.x,r,s),e(i.y,r,s),e(i.z,r,s));case xb.Vector4:return new n.IU(e(i.x,r,s),e(i.y,r,s),e(i.z,r,s),e(i.w,r,s))}return 0},this}}(0,a.Y5)("BABYLON.GeometrySmoothStepBlock",qy);class Yy extends Ib{constructor(e){super(e),this.registerInput("left",xb.AutoDetect),this.registerInput("right",xb.AutoDetect),this.registerOutput("output",xb.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[0].excludedConnectionPointTypes.push(xb.Geometry),this._inputs[0].excludedConnectionPointTypes.push(xb.Texture)}getClassName(){return"GeometryModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=(e,t)=>e-Math.floor(e/t)*t;return this.output._storedFunction=t=>{const i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t);switch(this.left.type){case xb.Int:case xb.Float:return e(i,r);case xb.Vector2:return new n.I9(e(i.x,r.x),e(i.y,r.y));case xb.Vector3:return new n.Pq(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z));case xb.Vector4:return new n.IU(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z),e(i.w,r.w))}return 0},this}}(0,a.Y5)("BABYLON.GeometryModBlock",Yy);class Xy extends Ib{constructor(e){super(e),this.registerInput("value",xb.AutoDetect),this.registerInput("power",xb.AutoDetect),this.registerOutput("output",xb.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[0].excludedConnectionPointTypes.push(xb.Geometry),this._inputs[0].excludedConnectionPointTypes.push(xb.Texture)}getClassName(){return"GeometryPowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.power.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=(e,t)=>Math.pow(e,t);return this.output._storedFunction=t=>{const i=this.value.getConnectedValue(t),r=this.power.getConnectedValue(t);switch(this.value.type){case xb.Int:case xb.Float:return e(i,r);case xb.Vector2:return new n.I9(e(i.x,r),e(i.y,r));case xb.Vector3:return new n.Pq(e(i.x,r),e(i.y,r),e(i.z,r));case xb.Vector4:return new n.IU(e(i.x,r),e(i.y,r),e(i.z,r),e(i.w,r))}return 0},this}}(0,a.Y5)("BABYLON.GeometryPowBlock",Xy);class jy extends Ib{get minimum(){return this.min.value}set minimum(e){this.min.value=e}get maximum(){return this.max.value}set maximum(e){this.max.value=e}constructor(e){super(e),this.registerInput("value",xb.AutoDetect),this.registerInput("min",xb.Float,!0,0),this.registerInput("max",xb.Float,!0,1),this.registerOutput("output",xb.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[0].excludedConnectionPointTypes.push(xb.Geometry),this._inputs[0].excludedConnectionPointTypes.push(xb.Texture)}getClassName(){return"GeometryClampBlock"}get value(){return this._inputs[0]}get min(){return this._inputs[1]}get max(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=(e,t,i)=>Math.max(t,Math.min(e,i));return this.output._storedFunction=t=>{const i=this.value.getConnectedValue(t),r=this.min.isConnected?this.min.getConnectedValue(t):this.minimum,s=this.max.isConnected?this.max.getConnectedValue(t):this.maximum;switch(this.value.type){case xb.Int:case xb.Float:return e(i,r,s);case xb.Vector2:return new n.I9(e(i.x,r,s),e(i.y,r,s));case xb.Vector3:return new n.Pq(e(i.x,r,s),e(i.y,r,s),e(i.z,r,s));case xb.Vector4:return new n.IU(e(i.x,r,s),e(i.y,r,s),e(i.z,r,s),e(i.w,r,s))}return 0},this}_deserialize(e){super._deserialize(e),this.minimum=e.minimum,this.maximum=e.maximum}}(0,a.Y5)("BABYLON.GeometryClampBlock",jy);class Zy extends Ib{constructor(e){super(e),this.registerInput("left",xb.AutoDetect),this.registerInput("right",xb.AutoDetect),this.registerOutput("output",xb.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(xb.Int),this._inputs[0].excludedConnectionPointTypes.push(xb.Float),this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[0].excludedConnectionPointTypes.push(xb.Vector2),this._inputs[1].excludedConnectionPointTypes.push(xb.Int),this._inputs[1].excludedConnectionPointTypes.push(xb.Float),this._inputs[1].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[1].excludedConnectionPointTypes.push(xb.Vector2)}getClassName(){return"GeometryCrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){return this.left.isConnected&&this.right.isConnected?(this.output._storedFunction=e=>{const t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);switch(this.left.type){case xb.Vector3:return n.Pq.Cross(t,i);case xb.Vector4:return n.Pq.Cross(t.toVector3(),i.toVector3())}return 0},this):(this.output._storedFunction=null,void(this.output._storedValue=null))}}(0,a.Y5)("BABYLON.GeometryCrossBlock",Zy),function(e){e[e.EaseInSine=0]="EaseInSine",e[e.EaseOutSine=1]="EaseOutSine",e[e.EaseInOutSine=2]="EaseInOutSine",e[e.EaseInQuad=3]="EaseInQuad",e[e.EaseOutQuad=4]="EaseOutQuad",e[e.EaseInOutQuad=5]="EaseInOutQuad",e[e.EaseInCubic=6]="EaseInCubic",e[e.EaseOutCubic=7]="EaseOutCubic",e[e.EaseInOutCubic=8]="EaseInOutCubic",e[e.EaseInQuart=9]="EaseInQuart",e[e.EaseOutQuart=10]="EaseOutQuart",e[e.EaseInOutQuart=11]="EaseInOutQuart",e[e.EaseInQuint=12]="EaseInQuint",e[e.EaseOutQuint=13]="EaseOutQuint",e[e.EaseInOutQuint=14]="EaseInOutQuint",e[e.EaseInExpo=15]="EaseInExpo",e[e.EaseOutExpo=16]="EaseOutExpo",e[e.EaseInOutExpo=17]="EaseInOutExpo",e[e.EaseInCirc=18]="EaseInCirc",e[e.EaseOutCirc=19]="EaseOutCirc",e[e.EaseInOutCirc=20]="EaseInOutCirc",e[e.EaseInBack=21]="EaseInBack",e[e.EaseOutBack=22]="EaseOutBack",e[e.EaseInOutBack=23]="EaseInOutBack",e[e.EaseInElastic=24]="EaseInElastic",e[e.EaseOutElastic=25]="EaseOutElastic",e[e.EaseInOutElastic=26]="EaseInOutElastic"}(wy||(wy={}));class Qy extends Ib{constructor(e){super(e),this.type=wy.EaseInOutSine,this.registerInput("input",xb.AutoDetect),this.registerOutput("output",xb.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[0].excludedConnectionPointTypes.push(xb.Int)}getClassName(){return"GeometryCurveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){if(!this.input.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);let e;switch(this.type){case wy.EaseInSine:e=e=>1-Math.cos(3.1415*e/2);break;case wy.EaseOutSine:e=e=>Math.sin(3.1415*e/2);break;case wy.EaseInOutSine:e=e=>-(Math.cos(3.1415*e)-1)/2;break;case wy.EaseInQuad:e=e=>e*e;break;case wy.EaseOutQuad:e=e=>(1-e)*(1-e);break;case wy.EaseInOutQuad:e=e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2;break;case wy.EaseInCubic:e=e=>e*e*e;break;case wy.EaseOutCubic:e=e=>1-Math.pow(1-e,3);break;case wy.EaseInOutCubic:e=e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2;break;case wy.EaseInQuart:e=e=>e*e*e*e;break;case wy.EaseOutQuart:e=e=>1-Math.pow(1-e,4);break;case wy.EaseInOutQuart:e=e=>e<.5?8*e*e*e*e:1-Math.pow(-2*e+2,4)/2;break;case wy.EaseInQuint:e=e=>e*e*e*e*e;break;case wy.EaseOutQuint:e=e=>1-Math.pow(1-e,5);break;case wy.EaseInOutQuint:e=e=>e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2;break;case wy.EaseInExpo:e=e=>0===e?0:Math.pow(2,10*e-10);break;case wy.EaseOutExpo:e=e=>1===e?1:1-Math.pow(2,-10*e);break;case wy.EaseInOutExpo:e=e=>0===e?0:1===e?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2;break;case wy.EaseInCirc:e=e=>1-Math.sqrt(1-Math.pow(e,2));break;case wy.EaseOutCirc:e=e=>Math.sqrt(1-Math.pow(e-1,2));break;case wy.EaseInOutCirc:e=e=>e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2;break;case wy.EaseInBack:e=e=>2.70158*e*e*e-1.70158*e*e;break;case wy.EaseOutBack:e=e=>2.70158*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2);break;case wy.EaseInOutBack:e=e=>e<.5?Math.pow(2*e,2)*(7.189819*e-2.5949095)/2:(Math.pow(2*e-2,2)*(3.5949095*(2*e-2)+3.5949095)+2)/2;break;case wy.EaseInElastic:e=e=>0===e?0:1===e?1:-Math.pow(2,10*e-10)*Math.sin(6.283/3*(10*e-10.75));break;case wy.EaseOutElastic:e=e=>0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin(6.283/3*(10*e-.75))+1;break;case wy.EaseInOutElastic:e=e=>0===e?0:1==e?1:e<.5?-Math.pow(2,20*e-10)*Math.sin(6.283/4.5*(20*e-11.125))/2:Math.pow(2,-20*e+10)*Math.sin(6.283/4.5*(20*e-11.125))/2+1}return this.output._storedFunction=t=>{const i=this.input.getConnectedValue(t);switch(this.input.type){case xb.Float:return e(i);case xb.Vector2:return new n.I9(e(i.x),e(i.y));case xb.Vector3:return new n.Pq(e(i.x),e(i.y),e(i.z));case xb.Vector4:return new n.IU(e(i.x),e(i.y),e(i.z),e(i.w))}return 0},this}serialize(){const e=super.serialize();return e.curveType=this.type,e}_deserialize(e){super._deserialize(e),this.type=e.curveType}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.type = BABYLON.GeometryCurveBlockTypes.${wy[this.type]};\n`}}(0,Ge.Cg)([xh("Type",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"EaseInSine",value:wy.EaseInSine},{label:"EaseOutSine",value:wy.EaseOutSine},{label:"EaseInOutSine",value:wy.EaseInOutSine},{label:"EaseInQuad",value:wy.EaseInQuad},{label:"EaseOutQuad",value:wy.EaseOutQuad},{label:"EaseInOutQuad",value:wy.EaseInOutQuad},{label:"EaseInCubic",value:wy.EaseInCubic},{label:"EaseOutCubic",value:wy.EaseOutCubic},{label:"EaseInOutCubic",value:wy.EaseInOutCubic},{label:"EaseInQuart",value:wy.EaseInQuart},{label:"EaseOutQuart",value:wy.EaseOutQuart},{label:"EaseInOutQuart",value:wy.EaseInOutQuart},{label:"EaseInQuint",value:wy.EaseInQuint},{label:"EaseOutQuint",value:wy.EaseOutQuint},{label:"EaseInOutQuint",value:wy.EaseInOutQuint},{label:"EaseInExpo",value:wy.EaseInExpo},{label:"EaseOutExpo",value:wy.EaseOutExpo},{label:"EaseInOutExpo",value:wy.EaseInOutExpo},{label:"EaseInCirc",value:wy.EaseInCirc},{label:"EaseOutCirc",value:wy.EaseOutCirc},{label:"EaseInOutCirc",value:wy.EaseInOutCirc},{label:"EaseInBack",value:wy.EaseInBack},{label:"EaseOutBack",value:wy.EaseOutBack},{label:"EaseInOutBack",value:wy.EaseInOutBack},{label:"EaseInElastic",value:wy.EaseInElastic},{label:"EaseOutElastic",value:wy.EaseOutElastic},{label:"EaseInOutElastic",value:wy.EaseInOutElastic}]})],Qy.prototype,"type",void 0),(0,a.Y5)("BABYLON.GeometryCurveBlock",Qy);class Ky extends Ib{constructor(e){super(e),this.registerInput("color",xb.Vector3),this.registerInput("level",xb.Float,!0,0),this.registerOutput("output",xb.Vector3)}getClassName(){return"GeometryDesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){return this.color.isConnected?(this.output._storedFunction=e=>{const t=this.color.getConnectedValue(e),i=this.level.getConnectedValue(e),r=.5*(Math.min(t.x,t.y,t.z)+Math.max(t.x,t.y,t.z));return new n.Pq(t.x*(1-i)+r*i,t.y*(1-i)+r*i,t.z*(1-i)+r*i)},this):(this.output._storedFunction=null,void(this.output._storedValue=null))}}(0,a.Y5)("BABYLON.GeometryDesaturateBlock",Ky);class Jy extends Ib{constructor(e){super(e),this.registerInput("value",xb.AutoDetect),this.registerInput("steps",xb.AutoDetect),this.registerOutput("output",xb.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[1].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[1].acceptedConnectionPointTypes.push(xb.Float)}getClassName(){return"GeometryPosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){return this.value.isConnected&&this.steps.isConnected?(this.output._storedFunction=e=>{const t=this.value.getConnectedValue(e),i=this.steps.getConnectedValue(e);let r=i;if(this.steps.type===xb.Float)switch(this.value.type){case xb.Vector2:r=new n.I9(i,i);break;case xb.Vector3:r=new n.Pq(i,i,i);break;case xb.Vector4:r=new n.IU(i,i,i,i)}switch(this.value.type){case xb.Vector2:return new n.I9(t.x/(1/r.x)*(1/r.x),t.y/(1/r.y)*(1/r.y));case xb.Vector3:return new n.Pq(t.x/(1/r.x)*(1/r.x),t.y/(1/r.y)*(1/r.y),t.z/(1/r.z)*(1/r.z));case xb.Vector4:return new n.IU(t.x/(1/r.x)*(1/r.x),t.y/(1/r.y)*(1/r.y),t.z/(1/r.z)*(1/r.z),t.w/(1/r.w)*(1/r.w));default:return Math.floor(t/(1/i)*(1/i))}},this):(this.output._storedFunction=null,void(this.output._storedValue=null))}}(0,a.Y5)("BABYLON.GeometryPosterizeBlock",Jy);class eP extends Ib{constructor(e){super(e),this.registerInput("value",xb.AutoDetect),this.registerInput("reference",xb.AutoDetect),this.registerInput("distance",xb.Float,!0,0),this.registerInput("replacement",xb.AutoDetect),this.registerOutput("output",xb.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push(xb.Float),this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[1].excludedConnectionPointTypes.push(xb.Float),this._inputs[1].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[3].excludedConnectionPointTypes.push(xb.Float),this._inputs[3].excludedConnectionPointTypes.push(xb.Matrix)}getClassName(){return"GeometryReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(){return this.value.isConnected&&this.reference.isConnected&&this.replacement.isConnected?(this.output._storedFunction=e=>{const t=this.value.getConnectedValue(e),i=this.reference.getConnectedValue(e),r=this.distance.getConnectedValue(e),s=this.replacement.getConnectedValue(e);return t.subtract(i).length()<r?s:t},this):(this.output._storedFunction=null,void(this.output._storedValue=null))}}(0,a.Y5)("BABYLON.GeometryReplaceColorBlock",eP);class tP extends Ib{constructor(e){super(e),this.registerInput("left",xb.AutoDetect),this.registerInput("right",xb.AutoDetect),this.registerOutput("output",xb.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(xb.Int),this._inputs[0].excludedConnectionPointTypes.push(xb.Float),this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[1].excludedConnectionPointTypes.push(xb.Float),this._inputs[1].excludedConnectionPointTypes.push(xb.Matrix)}getClassName(){return"GeometryDistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){return this.left.isConnected&&this.right.isConnected?(this.output._storedFunction=e=>{const t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);return t.subtract(i).length()},this):(this.output._storedFunction=null,void(this.output._storedValue=null))}}(0,a.Y5)("BABYLON.GeometryDistanceBlock",tP);class iP extends Ib{constructor(e){super(e),this.registerInput("left",xb.AutoDetect),this.registerInput("right",xb.AutoDetect),this.registerOutput("output",xb.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(xb.Int),this._inputs[0].excludedConnectionPointTypes.push(xb.Float),this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[1].excludedConnectionPointTypes.push(xb.Float),this._inputs[1].excludedConnectionPointTypes.push(xb.Matrix)}getClassName(){return"GeometryDotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){return this.left.isConnected&&this.right.isConnected?(this.output._storedFunction=e=>{const t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);return t.dot(i)},this):(this.output._storedFunction=null,void(this.output._storedValue=null))}}(0,a.Y5)("BABYLON.GeometryDotBlock",iP);class rP extends Ib{constructor(e){super(e),this.registerInput("value",xb.AutoDetect),this.registerOutput("output",xb.Float),this._inputs[0].excludedConnectionPointTypes.push(xb.Int),this._inputs[0].excludedConnectionPointTypes.push(xb.Float),this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix)}getClassName(){return"GeometryLengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){return this.value.isConnected?(this.output._storedFunction=e=>this.value.getConnectedValue(e).length(),this):(this.output._storedFunction=null,void(this.output._storedValue=null))}}(0,a.Y5)("BABYLON.GeometryLengthBlock",rP);class sP extends Ib{constructor(e){super(e),this.registerInput("input",xb.Vector2),this.registerInput("angle",xb.Float,!0,0),this.registerOutput("output",xb.Vector2)}getClassName(){return"GeometryRotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){return this.input.isConnected?(this.output._storedFunction=e=>{const t=this.input.getConnectedValue(e),i=this.angle.getConnectedValue(e);return new n.I9(Math.cos(i)*t.x-Math.sin(i)*t.y,Math.sin(i)*t.x+Math.cos(i)*t.y)},this):(this.output._storedFunction=null,void(this.output._storedValue=null))}}(0,a.Y5)("BABYLON.GeometryRotate2dBlock",sP);class nP extends Ib{constructor(e){super(e),this.onInterceptionObservable=new s.cP(void 0,!0),this.registerInput("input",xb.AutoDetect),this.registerOutput("output",xb.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}get buildExecutionTime(){return-1}getClassName(){return"GeometryInterceptorBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];t._storedFunction=e=>{let t=i.getConnectedValue(e);return this.customFunction&&(t=this.customFunction(t,e)),this.onInterceptionObservable.notifyObservers(t),t}}}(0,a.Y5)("BABYLON.GeometryInterceptorBlock",nP),function(e){e[e.EaseInSine=0]="EaseInSine",e[e.EaseOutSine=1]="EaseOutSine",e[e.EaseInOutSine=2]="EaseInOutSine",e[e.EaseInQuad=3]="EaseInQuad",e[e.EaseOutQuad=4]="EaseOutQuad",e[e.EaseInOutQuad=5]="EaseInOutQuad",e[e.EaseInCubic=6]="EaseInCubic",e[e.EaseOutCubic=7]="EaseOutCubic",e[e.EaseInOutCubic=8]="EaseInOutCubic",e[e.EaseInQuart=9]="EaseInQuart",e[e.EaseOutQuart=10]="EaseOutQuart",e[e.EaseInOutQuart=11]="EaseInOutQuart",e[e.EaseInQuint=12]="EaseInQuint",e[e.EaseOutQuint=13]="EaseOutQuint",e[e.EaseInOutQuint=14]="EaseInOutQuint",e[e.EaseInExpo=15]="EaseInExpo",e[e.EaseOutExpo=16]="EaseOutExpo",e[e.EaseInOutExpo=17]="EaseInOutExpo",e[e.EaseInCirc=18]="EaseInCirc",e[e.EaseOutCirc=19]="EaseOutCirc",e[e.EaseInOutCirc=20]="EaseInOutCirc",e[e.EaseInBack=21]="EaseInBack",e[e.EaseOutBack=22]="EaseOutBack",e[e.EaseInOutBack=23]="EaseInOutBack",e[e.EaseInElastic=24]="EaseInElastic",e[e.EaseOutElastic=25]="EaseOutElastic",e[e.EaseInOutElastic=26]="EaseInOutElastic"}(Fy||(Fy={}));class oP extends Ib{get type(){return this._type}set type(e){if(this._type!==e)switch(this._type=e,this._type){case Fy.EaseInSine:this._easingFunction=new F.kc,this._easingFunction.setEasingMode(F.kc.EASINGMODE_EASEIN);break;case Fy.EaseOutSine:this._easingFunction=new F.kc,this._easingFunction.setEasingMode(F.kc.EASINGMODE_EASEOUT);break;case Fy.EaseInOutSine:this._easingFunction=new F.kc,this._easingFunction.setEasingMode(F.kc.EASINGMODE_EASEINOUT);break;case Fy.EaseInQuad:this._easingFunction=new F.fA,this._easingFunction.setEasingMode(F.fA.EASINGMODE_EASEIN);break;case Fy.EaseOutQuad:this._easingFunction=new F.fA,this._easingFunction.setEasingMode(F.fA.EASINGMODE_EASEOUT);break;case Fy.EaseInOutQuad:this._easingFunction=new F.fA,this._easingFunction.setEasingMode(F.fA.EASINGMODE_EASEINOUT);break;case Fy.EaseInCubic:this._easingFunction=new F.vm,this._easingFunction.setEasingMode(F.vm.EASINGMODE_EASEIN);break;case Fy.EaseOutCubic:this._easingFunction=new F.vm,this._easingFunction.setEasingMode(F.vm.EASINGMODE_EASEOUT);break;case Fy.EaseInOutCubic:this._easingFunction=new F.vm,this._easingFunction.setEasingMode(F.vm.EASINGMODE_EASEINOUT);break;case Fy.EaseInQuart:this._easingFunction=new F.Q6,this._easingFunction.setEasingMode(F.Q6.EASINGMODE_EASEIN);break;case Fy.EaseOutQuart:this._easingFunction=new F.Q6,this._easingFunction.setEasingMode(F.Q6.EASINGMODE_EASEOUT);break;case Fy.EaseInOutQuart:this._easingFunction=new F.Q6,this._easingFunction.setEasingMode(F.Q6.EASINGMODE_EASEINOUT);break;case Fy.EaseInQuint:this._easingFunction=new F.q7,this._easingFunction.setEasingMode(F.q7.EASINGMODE_EASEIN);break;case Fy.EaseOutQuint:this._easingFunction=new F.q7,this._easingFunction.setEasingMode(F.q7.EASINGMODE_EASEOUT);break;case Fy.EaseInOutQuint:this._easingFunction=new F.q7,this._easingFunction.setEasingMode(F.q7.EASINGMODE_EASEINOUT);break;case Fy.EaseInExpo:this._easingFunction=new F.E8,this._easingFunction.setEasingMode(F.E8.EASINGMODE_EASEIN);break;case Fy.EaseOutExpo:this._easingFunction=new F.E8,this._easingFunction.setEasingMode(F.E8.EASINGMODE_EASEOUT);break;case Fy.EaseInOutExpo:this._easingFunction=new F.E8,this._easingFunction.setEasingMode(F.E8.EASINGMODE_EASEINOUT);break;case Fy.EaseInCirc:this._easingFunction=new F.rm,this._easingFunction.setEasingMode(F.rm.EASINGMODE_EASEIN);break;case Fy.EaseOutCirc:this._easingFunction=new F.rm,this._easingFunction.setEasingMode(F.rm.EASINGMODE_EASEOUT);break;case Fy.EaseInOutCirc:this._easingFunction=new F.rm,this._easingFunction.setEasingMode(F.rm.EASINGMODE_EASEINOUT);break;case Fy.EaseInBack:this._easingFunction=new F.kL,this._easingFunction.setEasingMode(F.kL.EASINGMODE_EASEIN);break;case Fy.EaseOutBack:this._easingFunction=new F.kL,this._easingFunction.setEasingMode(F.kL.EASINGMODE_EASEOUT);break;case Fy.EaseInOutBack:this._easingFunction=new F.kL,this._easingFunction.setEasingMode(F.kL.EASINGMODE_EASEINOUT);break;case Fy.EaseInElastic:this._easingFunction=new F._B,this._easingFunction.setEasingMode(F._B.EASINGMODE_EASEIN);break;case Fy.EaseOutElastic:this._easingFunction=new F._B,this._easingFunction.setEasingMode(F._B.EASINGMODE_EASEOUT);break;case Fy.EaseInOutElastic:this._easingFunction=new F._B,this._easingFunction.setEasingMode(F._B.EASINGMODE_EASEINOUT)}}constructor(e){super(e),this._easingFunction=new F.kc,this._type=Fy.EaseInOutSine,this.registerInput("input",xb.AutoDetect),this.registerOutput("output",xb.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(xb.Matrix),this._inputs[0].excludedConnectionPointTypes.push(xb.Geometry),this._inputs[0].excludedConnectionPointTypes.push(xb.Texture)}getClassName(){return"GeometryEaseBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this._easingFunction)return this.output._storedFunction=null,void(this.output._storedValue=null);switch(this.input.type){case xb.Int:case xb.Float:this.output._storedFunction=e=>{const t=this.input.getConnectedValue(e);return this._easingFunction.ease(t)};break;case xb.Vector2:this.output._storedFunction=e=>{const t=this.input.getConnectedValue(e);return new n.I9(this._easingFunction.ease(t.x),this._easingFunction.ease(t.y))};break;case xb.Vector3:this.output._storedFunction=e=>{const t=this.input.getConnectedValue(e);return new n.Pq(this._easingFunction.ease(t.x),this._easingFunction.ease(t.y),this._easingFunction.ease(t.z))};break;case xb.Vector4:this.output._storedFunction=e=>{const t=this.input.getConnectedValue(e);return new n.IU(this._easingFunction.ease(t.x),this._easingFunction.ease(t.y),this._easingFunction.ease(t.z),this._easingFunction.ease(t.w))}}return this}serialize(){const e=super.serialize();return e.type=this.type,e}_deserialize(e){super._deserialize(e),this.type=e.type}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.type = BABYLON.GeometryEaseBlockTypes.${Fy[this.type]};\n`}}(0,Ge.Cg)([xh("Type",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"EaseInSine",value:Fy.EaseInSine},{label:"EaseOutSine",value:Fy.EaseOutSine},{label:"EaseInOutSine",value:Fy.EaseInOutSine},{label:"EaseInQuad",value:Fy.EaseInQuad},{label:"EaseOutQuad",value:Fy.EaseOutQuad},{label:"EaseInOutQuad",value:Fy.EaseInOutQuad},{label:"EaseInCubic",value:Fy.EaseInCubic},{label:"EaseOutCubic",value:Fy.EaseOutCubic},{label:"EaseInOutCubic",value:Fy.EaseInOutCubic},{label:"EaseInQuart",value:Fy.EaseInQuart},{label:"EaseOutQuart",value:Fy.EaseOutQuart},{label:"EaseInOutQuart",value:Fy.EaseInOutQuart},{label:"EaseInQuint",value:Fy.EaseInQuint},{label:"EaseOutQuint",value:Fy.EaseOutQuint},{label:"EaseInOutQuint",value:Fy.EaseInOutQuint},{label:"EaseInExpo",value:Fy.EaseInExpo},{label:"EaseOutExpo",value:Fy.EaseOutExpo},{label:"EaseInOutExpo",value:Fy.EaseInOutExpo},{label:"EaseInCirc",value:Fy.EaseInCirc},{label:"EaseOutCirc",value:Fy.EaseOutCirc},{label:"EaseInOutCirc",value:Fy.EaseInOutCirc},{label:"EaseInBack",value:Fy.EaseInBack},{label:"EaseOutBack",value:Fy.EaseOutBack},{label:"EaseInOutBack",value:Fy.EaseInOutBack},{label:"EaseInElastic",value:Fy.EaseInElastic},{label:"EaseOutElastic",value:Fy.EaseOutElastic},{label:"EaseInOutElastic",value:Fy.EaseInOutElastic}]})],oP.prototype,"type",null),(0,a.Y5)("BABYLON.GeometryEaseBlock",oP),function(e){e[e.Max=0]="Max",e[e.Min=1]="Min",e[e.Sum=2]="Sum"}(By||(By={}));class aP extends Ib{constructor(e){super(e),this.aggregation=By.Sum,this.evaluateContext=!0,this.registerInput("geometry",xb.Geometry),this.registerInput("source",xb.AutoDetect),this.registerOutput("output",xb.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[1]}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"AggregatorBlock"}get geometry(){return this._inputs[0]}get source(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this.source.isConnected)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=null);const t=this._vertexData.positions.length/3,i=[];for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++)i.push(this.source.getConnectedValue(e));let r,s=null;switch(this.aggregation){case By.Max:s=(e,t)=>Math.max(e,t);break;case By.Min:s=(e,t)=>Math.min(e,t);break;case By.Sum:s=(e,t)=>e+t}if(!s)return e.restoreGeometryContext(),e.restoreExecutionContext(),this.output._storedFunction=null,void(this.output._storedValue=null);switch(this.source.type){case xb.Int:case xb.Float:r=i.reduce(s);break;case xb.Vector2:{const e=i.map((e=>e.x)).reduce(s),t=i.map((e=>e.y)).reduce(s);r=new n.I9(e,t);break}case xb.Vector3:{const e=i.map((e=>e.x)).reduce(s),t=i.map((e=>e.y)).reduce(s),o=i.map((e=>e.z)).reduce(s);r=new n.Pq(e,t,o);break}case xb.Vector4:{const e=i.map((e=>e.x)).reduce(s),t=i.map((e=>e.y)).reduce(s),o=i.map((e=>e.z)).reduce(s),a=i.map((e=>e.w)).reduce(s);r=new n.IU(e,t,o,a);break}}return e.restoreGeometryContext(),e.restoreExecutionContext(),r};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`;return e+=`${this._codeVariableName}.aggregation = BABYLON.Aggregations.${By[this.aggregation]};\n`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.aggregation=this.aggregation,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext),void 0!==e.aggregation&&(this.aggregation=e.aggregation)}}(0,Ge.Cg)([xh("Aggregation",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Max",value:By.Max},{label:"Min",value:By.Min},{label:"Sum",value:By.Sum}]})],aP.prototype,"aggregation",void 0),(0,Ge.Cg)([xh("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],aP.prototype,"evaluateContext",void 0),(0,a.Y5)("BABYLON.AggregatorBlock",aP);class lP extends Ib{constructor(e){super(e),this.flatOnly=!1,this.loopWeight=1,this.registerInput("geometry",xb.Geometry),this.registerInput("level",xb.Int,!0,1,0,8),this.registerOutput("output",xb.Geometry)}getClassName(){return"SubdivideBlock"}get geometry(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){this.output._storedFunction=e=>{if(!this.geometry.isConnected)return null;const t=this.geometry.getConnectedValue(e);if(!t)return null;return gb(t,this.level.getConnectedValue(e),{flatOnly:this.flatOnly,weight:this.loopWeight})}}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.flatOnly = ${this.flatOnly?"true":"false"};\n`;return e+=`${this._codeVariableName}.loopWeight = ${this.loopWeight};\n`,e}serialize(){const e=super.serialize();return e.flatOnly=this.flatOnly,e.loopWeight=this.loopWeight,e}_deserialize(e){super._deserialize(e),this.flatOnly=e.flatOnly,this.loopWeight=e.loopWeight}}(0,Ge.Cg)([xh("Flat Only",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],lP.prototype,"flatOnly",void 0),(0,Ge.Cg)([xh("Loop weight",1,"ADVANCED",{embedded:!0,min:0,max:1,notifiers:{rebuild:!0}})],lP.prototype,"loopWeight",void 0),(0,a.Y5)("BABYLON.SubdivideBlock",lP);var hP,cP=i(98058),uP=i(50861),dP=i(84935),pP=i(99764),mP=i(30),fP=i(54561),_P=i(78439),gP=i(15105),xP=i(18507),vP=i(23451),SP=i(72657),bP=i(19226),yP=i(4044),PP=i(29700),TP=i(33570),CP=i(33619);!function(e){e[e.INIT=0]="INIT",e[e.RUNNING=1]="RUNNING",e[e.DONE=2]="DONE",e[e.ERROR=3]="ERROR"}(hP||(hP={}));class EP{constructor(e){this.name=e,this._isCompleted=!1,this._taskState=0}get isCompleted(){return this._isCompleted}get taskState(){return this._taskState}get errorObject(){return this._errorObject}_setErrorObject(e,t){this._errorObject||(this._errorObject={message:e,exception:t})}run(e,t,i){this._taskState=1,this.runTask(e,(()=>{this._onDoneCallback(t,i)}),((e,t)=>{this._onErrorCallback(i,e,t)}))}runTask(e,t,i){throw new Error("runTask is not implemented")}reset(){this._taskState=0}_onErrorCallback(e,t,i){this._taskState=3,this._errorObject={message:t,exception:i},this.onError&&this.onError(this,t,i),e()}_onDoneCallback(e,t){try{this._taskState=2,this._isCompleted=!0,this.onSuccess&&this.onSuccess(this),e()}catch(e){this._onErrorCallback(t,"Task is done, error executing success callback(s)",e)}}}class AP{constructor(e,t,i){this.remainingCount=e,this.totalCount=t,this.task=i}}class IP extends EP{constructor(e,t,i,r,s){super(e),this.name=e,this.meshesNames=t,this.rootUrl=i,this.sceneFilename=r,this.extension=s}runTask(e,t,i){sd.cn.LoadAssetContainer(this.rootUrl,this.sceneFilename,e,(e=>{this.loadedContainer=e,this.loadedMeshes=e.meshes,this.loadedTransformNodes=e.transformNodes,this.loadedParticleSystems=e.particleSystems,this.loadedSkeletons=e.skeletons,this.loadedAnimationGroups=e.animationGroups,t()}),null,((e,t,r)=>{i(t,r)}),this.extension)}}class RP extends EP{constructor(e,t,i,r,s){super(e),this.name=e,this.meshesNames=t,this.rootUrl=i,this.sceneFilename=r,this.extension=s}runTask(e,t,i){sd.cn.ImportMesh(this.meshesNames,this.rootUrl,this.sceneFilename,e,((e,i,r,s,n)=>{this.loadedMeshes=e,this.loadedTransformNodes=n,this.loadedParticleSystems=i,this.loadedSkeletons=r,this.loadedAnimationGroups=s,t()}),null,((e,t,r)=>{i(t,r)}),this.extension)}}class MP extends EP{constructor(e,t,i,r,s){super(e),this.name=e,this.rootUrl=t,this.filename=i,this.targetConverter=r,this.extension=s}runTask(e,t,i){const r=e.animatables.length,s=e.animationGroups.length;this.loadedAnimatables=[],this.loadedAnimationGroups=[],sd.cn.ImportAnimations(this.rootUrl,this.filename,e,!1,3,this.targetConverter,(()=>{this.loadedAnimatables=e.animatables.slice(r),this.loadedAnimationGroups=e.animationGroups.slice(s),t()}),null,((e,t,r)=>{i(t,r)}),this.extension)}}class DP extends EP{constructor(e,t){super(e),this.name=e,this.url=t}runTask(e,t,i){e._loadFile(this.url,(e=>{this.text=e,t()}),void 0,!1,!1,((e,t)=>{e&&i(e.status+" "+e.statusText,t)}))}}class OP extends EP{constructor(e,t){super(e),this.name=e,this.url=t}runTask(e,t,i){e._loadFile(this.url,(e=>{this.data=e,t()}),void 0,!0,!0,((e,t)=>{e&&i(e.status+" "+e.statusText,t)}))}}class NP extends EP{constructor(e,t){super(e),this.name=e,this.url=t}runTask(e,t,i){const r=new Image;H.S0.SetCorsBehavior(this.url,r),r.onload=()=>{this.image=r,t()},r.onerror=e=>{i("Error loading image",e)},r.src=this.url}}class wP extends EP{constructor(e,t,i,r=!0,s=$e.g.TRILINEAR_SAMPLINGMODE){super(e),this.name=e,this.url=t,this.noMipmap=i,this.invertY=r,this.samplingMode=s}runTask(e,t,i){this.texture=new $e.g(this.url,e,this.noMipmap,this.invertY,this.samplingMode,(()=>{t()}),((e,t)=>{i(e,t)}))}}class FP extends EP{constructor(e,t,i,r,s,n){super(e),this.name=e,this.url=t,this.extensions=i,this.noMipmap=r,this.files=s,this.prefiltered=n}runTask(e,t,i){this.texture=new Wu.CubeTexture(this.url,e,this.extensions,this.noMipmap,this.files,(()=>{t()}),((e,t)=>{i(e,t)}),void 0,this.prefiltered)}}class BP extends EP{constructor(e,t,i,r=!1,s=!0,n=!1,o=!1){super(e),this.name=e,this.url=t,this.size=i,this.noMipmap=r,this.generateHarmonics=s,this.gammaSpace=n,this.reserved=o}runTask(e,t,i){this.texture=new xm.HDRCubeTexture(this.url,e,this.size,this.noMipmap,this.generateHarmonics,this.gammaSpace,this.reserved,(()=>{t()}),((e,t)=>{i(e,t)}))}}class VP extends EP{constructor(e,t,i,r=!1,s=!0){super(e),this.name=e,this.url=t,this.size=i,this.noMipmap=r,this.gammaSpace=s}runTask(e,t,i){this.texture=new bf(this.url,e,this.size,this.noMipmap,this.gammaSpace,(()=>{t()}),((e,t)=>{i(e,t)}))}}class LP{constructor(e){this._isLoading=!1,this._tasks=new Array,this._waitingTasksCount=0,this._totalTasksCount=0,this.onTaskSuccessObservable=new s.cP,this.onTaskErrorObservable=new s.cP,this.onTasksDoneObservable=new s.cP,this.onProgressObservable=new s.cP,this.useDefaultLoadingScreen=!0,this.autoHideLoadingUI=!0,this._scene=e||C.q.LastCreatedScene}addContainerTask(e,t,i,r,s){const n=new IP(e,t,i,r,s);return this._tasks.push(n),n}addMeshTask(e,t,i,r,s){const n=new RP(e,t,i,r,s);return this._tasks.push(n),n}addTextFileTask(e,t){const i=new DP(e,t);return this._tasks.push(i),i}addBinaryFileTask(e,t){const i=new OP(e,t);return this._tasks.push(i),i}addImageTask(e,t){const i=new NP(e,t);return this._tasks.push(i),i}addTextureTask(e,t,i,r,s=$e.g.TRILINEAR_SAMPLINGMODE){const n=new wP(e,t,i,r,s);return this._tasks.push(n),n}addCubeTextureTask(e,t,i,r,s,n){const o=new FP(e,t,i,r,s,n);return this._tasks.push(o),o}addHDRCubeTextureTask(e,t,i,r=!1,s=!0,n=!1,o=!1){const a=new BP(e,t,i,r,s,n,o);return this._tasks.push(a),a}addEquiRectangularCubeTextureAssetTask(e,t,i,r=!1,s=!0){const n=new VP(e,t,i,r,s);return this._tasks.push(n),n}removeTask(e){const t=this._tasks.indexOf(e);t>-1&&this._tasks.splice(t,1)}_decreaseWaitingTasksCount(e){this._waitingTasksCount--;try{this.onProgress&&this.onProgress(this._waitingTasksCount,this._totalTasksCount,e),this.onProgressObservable.notifyObservers(new AP(this._waitingTasksCount,this._totalTasksCount,e))}catch(e){m.V.Error("Error running progress callbacks."),m.V.Log(e)}if(0===this._waitingTasksCount){try{const e=this._tasks.slice();this.onFinish&&this.onFinish(e);for(const t of e)if(2===t.taskState){const e=this._tasks.indexOf(t);e>-1&&this._tasks.splice(e,1)}this.onTasksDoneObservable.notifyObservers(this._tasks)}catch(e){m.V.Error("Error running tasks-done callbacks."),m.V.Log(e)}this._isLoading=!1,this.autoHideLoadingUI&&this._scene.getEngine().hideLoadingUI()}}_runTask(e){const t=(t,i)=>{e._setErrorObject(t,i),this.onTaskError?this.onTaskError(e):e.onError||m.V.Error(this._formatTaskErrorMessage(e)),this.onTaskErrorObservable.notifyObservers(e),this._decreaseWaitingTasksCount(e)};e.run(this._scene,(()=>{try{this.onTaskSuccess&&this.onTaskSuccess(e),this.onTaskSuccessObservable.notifyObservers(e),this._decreaseWaitingTasksCount(e)}catch(e){t("Error executing task success callbacks",e)}}),t)}_formatTaskErrorMessage(e){let t="Unable to complete task "+e.name;return e.errorObject.message&&(t+=`: ${e.errorObject.message}`),e.errorObject.exception&&(t+=`: ${e.errorObject.exception}`),t}reset(){return this._isLoading=!1,this._tasks=new Array,this}load(){if(this._isLoading)return this;if(this._isLoading=!0,this._waitingTasksCount=this._tasks.length,this._totalTasksCount=this._tasks.length,0===this._waitingTasksCount)return this._isLoading=!1,this.onFinish&&this.onFinish(this._tasks),this.onTasksDoneObservable.notifyObservers(this._tasks),this;this.useDefaultLoadingScreen&&this._scene.getEngine().displayLoadingUI();for(let e=0;e<this._tasks.length;e++){const t=this._tasks[e];0===t.taskState&&this._runTask(t)}return this}loadAsync(){return new Promise(((e,t)=>{this._isLoading?e():(this.onTasksDoneObservable.addOnce((i=>{i&&i.length?t(i):e()})),this.load())}))}}var kP=i(59057),GP=i(36464),zP=i(39018);class UP{constructor(e,t){this._meshesOrigins=[],this._toCenterVectors=[],this._scaledDirection=new n.Pq(1,1,1),this._newPosition=n.Pq.Zero(),this._centerPosition=n.Pq.Zero(),this._meshes=e.slice(),t?this._centerMesh=t:this._setCenterMesh(),this._centerMesh.computeWorldMatrix(!0);const i=this._meshes.indexOf(this._centerMesh);i>=0&&this._meshes.splice(i,1),this._centerPosition=this._centerMesh.getAbsolutePosition().clone();for(let e=0;e<this._meshes.length;e++)if(this._meshes[e]){const t=this._meshes[e];this._meshesOrigins[e]=t.getAbsolutePosition().clone(),this._toCenterVectors[e]=n.Pq.Zero(),t.hasBoundingInfo&&this._centerMesh.hasBoundingInfo&&(t.computeWorldMatrix(!0),t.getBoundingInfo().boundingBox.centerWorld.subtractToRef(this._centerMesh.getBoundingInfo().boundingBox.centerWorld,this._toCenterVectors[e]))}}_setCenterMesh(){let e=n.Pq.Zero();const t=n.Pq.Zero();let i=Number.MAX_VALUE;for(let e=0;e<this._meshes.length;e++)if(this._meshes[e]){const i=this._meshes[e].getBoundingInfo();i&&t.addInPlace(i.boundingBox.centerWorld)}e=t.scale(1/this._meshes.length);for(let t=0;t<this._meshes.length;t++)if(this._meshes[t]){const r=this._meshes[t],s=r.getBoundingInfo();if(s){const t=s.boundingBox.centerWorld.subtract(e).lengthSquared();t<i&&(this._centerMesh=r,i=t)}}}getClassName(){return"MeshExploder"}getMeshes(){const e=this._meshes.slice();return e.unshift(this._centerMesh),e}explode(e=1){for(let t=0;t<this._meshes.length;t++)this._meshes[t]&&this._meshesOrigins[t]&&this._toCenterVectors[t]&&(this._toCenterVectors[t].scaleToRef(e,this._scaledDirection),this._meshesOrigins[t].addToRef(this._scaledDirection,this._newPosition),this._meshes[t].setAbsolutePosition(this._newPosition));this._centerMesh.setAbsolutePosition(this._centerPosition)}}var WP=i(60715);class HP{static get FilesToLoad(){return WP.T.FilesToLoad}constructor(e,t,i,r,s,n,o,a,l,h=!1,c=!1){this.useAppend=h,this.dontInjectRenderLoop=c,this.onProcessFileCallback=()=>!0,this.displayLoadingUI=!0,this.loadAsync=(e,t)=>this.useAppend?sd.cn.AppendAsync("file:",e,this._currentScene,t):sd.cn.LoadAsync("file:",e,this._engine,t),this._engine=e,this._currentScene=t,this._sceneLoadedCallback=i,this._progressCallback=r,this._additionalRenderLoopLogicCallback=s,this._textureLoadingCallback=n,this._startingProcessingFilesCallback=o,this._onReloadCallback=a,this._errorCallback=l}monitorElementForDragNDrop(e){e&&(this._elementToMonitor=e,this._dragEnterHandler=e=>{this._drag(e)},this._dragOverHandler=e=>{this._drag(e)},this._dropHandler=e=>{this._drop(e)},this._elementToMonitor.addEventListener("dragenter",this._dragEnterHandler,!1),this._elementToMonitor.addEventListener("dragover",this._dragOverHandler,!1),this._elementToMonitor.addEventListener("drop",this._dropHandler,!1))}get filesToLoad(){return this._filesToLoad}dispose(){this._elementToMonitor&&(this._elementToMonitor.removeEventListener("dragenter",this._dragEnterHandler),this._elementToMonitor.removeEventListener("dragover",this._dragOverHandler),this._elementToMonitor.removeEventListener("drop",this._dropHandler))}_renderFunction(){if(this._additionalRenderLoopLogicCallback&&this._additionalRenderLoopLogicCallback(),this._currentScene){if(this._textureLoadingCallback){const e=this._currentScene.getWaitingItemsCount();e>0&&this._textureLoadingCallback(e)}this._currentScene.render()}}_drag(e){e.stopPropagation(),e.preventDefault()}_drop(e){e.stopPropagation(),e.preventDefault(),this.loadFiles(e)}_traverseFolder(e,t,i,r){const s=e.createReader(),n=e.fullPath.replace(/^\//,"").replace(/(.+?)\/?$/,"$1/");s.readEntries((e=>{i.count+=e.length;for(const s of e)s.isFile?s.file((e=>{e.correctName=n+e.name,t.push(e),0==--i.count&&r()})):s.isDirectory&&this._traverseFolder(s,t,i,r);0==--i.count&&r()}))}_processFiles(e){for(let t=0;t<e.length;t++){const i=e[t].correctName.toLowerCase(),r=i.split(".").pop();this.onProcessFileCallback(e[t],i,r,(e=>this._sceneFileToLoad=e))&&(sd.cn.IsPluginForExtensionAvailable("."+r)&&(this._sceneFileToLoad=e[t]),HP.FilesToLoad[i]=e[t])}}loadFiles(e){if(e&&e.dataTransfer&&e.dataTransfer.files&&(this._filesToLoad=e.dataTransfer.files),e&&e.target&&e.target.files&&(this._filesToLoad=e.target.files),this._filesToLoad&&0!==this._filesToLoad.length&&(this._startingProcessingFilesCallback&&this._startingProcessingFilesCallback(this._filesToLoad),this._filesToLoad&&this._filesToLoad.length>0)){const t=[],i=[],r=e.dataTransfer?e.dataTransfer.items:null;for(let e=0;e<this._filesToLoad.length;e++){const s=this._filesToLoad[e],n=s.name.toLowerCase();let o;if(s.correctName=n,r){const t=r[e];t.getAsEntry?o=t.getAsEntry():t.webkitGetAsEntry&&(o=t.webkitGetAsEntry())}o&&o.isDirectory?i.push(o):t.push(s)}if(0===i.length)this._processFiles(t),this._processReload();else{const e={count:i.length};for(const r of i)this._traverseFolder(r,t,e,(()=>{this._processFiles(t),0===e.count&&this._processReload()}))}}}_processReload(){this._onReloadCallback?this._onReloadCallback(this._sceneFileToLoad):this.reload()}reload(){if(this._sceneFileToLoad)this.useAppend||this._currentScene&&(m.V.errorsCount>0&&m.V.ClearLogCache(),this._engine.stopRenderLoop()),sd.cn.ShowLoadingScreen=!1,this.displayLoadingUI&&this._engine.displayLoadingUI(),this.loadAsync(this._sceneFileToLoad,this._progressCallback).then((e=>{this.useAppend?this.displayLoadingUI&&this._engine.hideLoadingUI():(this._currentScene&&this._currentScene.dispose(),this._currentScene=e,this._currentScene.executeWhenReady((()=>{this.displayLoadingUI&&this._engine.hideLoadingUI(),this.dontInjectRenderLoop||this._engine.runRenderLoop((()=>{this._renderFunction()}))}))),this._sceneLoadedCallback&&this._currentScene&&this._sceneLoadedCallback(this._sceneFileToLoad,this._currentScene)})).catch((e=>{this.displayLoadingUI&&this._engine.hideLoadingUI(),this._errorCallback&&this._errorCallback(this._sceneFileToLoad,this._currentScene,e.message)}));else{if(1===this._filesToLoad.length){const e=this._filesToLoad[0].name.toLowerCase().split(".").pop();if(e)switch(e.toLowerCase()){case"dds":case"env":case"hdr":return}}m.V.Error("Please provide a valid .babylon file.")}}}var $P=i(36755),qP=i(82814),YP=i(6443);class XP{dispose(){if(this._observers&&this._observables)for(let e=0;e<this._observers.length;e++)this._observables[e].remove(this._observers[e]);this._observers=null,this._observables=null}static Watch(e,t,i=-1,r=null){const s=new XP;s._observers=new Array,s._observables=e;for(const n of e){const e=n.add(t,i,!1,r);e&&s._observers.push(e)}return s}}s.cP.prototype.notifyObserversWithPromise=async function(e,t=-1,i,r,s){let n=Promise.resolve(e);if(!this.observers.length)return n;const o=this._eventState;return o.mask=t,o.target=i,o.currentTarget=r,o.skipNextObservers=!1,o.userInfo=s,this.observers.forEach((i=>{o.skipNextObservers||i._willBeUnregistered||i.mask&t&&(n=i.scope?n.then((t=>(o.lastReturnValue=t,i.callback.apply(i.scope,[e,o])))):n.then((t=>(o.lastReturnValue=t,i.callback(e,o)))),i.unregisterOnNextCall&&this._deferUnregister(i))})),await n,e};var jP=i(84085),ZP=i(41546);let QP=[];const KP=(e,t)=>{e.doNotSerialize||(t.vertexData.push(e.serializeVerticeData()),QP[e.id]=!0)},JP=(e,t)=>{const i={},r=e._geometry;return r&&(e.getScene().getGeometryById(r.id)||KP(r,t.geometries)),e.serialize&&e.serialize(i),i};class eT{static ClearCache(){QP=[]}static Serialize(e){return eT._Serialize(e)}static _Serialize(e,t=!0){const i={};if(t&&!e.getEngine()._features.supportSyncTextureRead&&$e.g.ForceSerializeBuffers&&m.V.Warn("The serialization object may not contain the proper base64 encoded texture data! You should use the SerializeAsync method instead."),eT.ClearCache(),i.useDelayedTextureLoading=e.useDelayedTextureLoading,i.autoClear=e.autoClear,i.clearColor=e.clearColor.asArray(),i.ambientColor=e.ambientColor.asArray(),i.gravity=e.gravity.asArray(),i.collisionsEnabled=e.collisionsEnabled,i.useRightHandedSystem=e.useRightHandedSystem,void 0!==e.fogMode&&null!==e.fogMode&&(i.fogMode=e.fogMode),void 0!==e.fogColor&&null!==e.fogColor&&(i.fogColor=e.fogColor.asArray()),void 0!==e.fogStart&&null!==e.fogStart&&(i.fogStart=e.fogStart),void 0!==e.fogEnd&&null!==e.fogEnd&&(i.fogEnd=e.fogEnd),void 0!==e.fogDensity&&null!==e.fogDensity&&(i.fogDensity=e.fogDensity),e.isPhysicsEnabled&&e.isPhysicsEnabled()){const t=e.getPhysicsEngine();t&&(i.physicsEnabled=!0,i.physicsGravity=t.gravity.asArray(),i.physicsEngine=t.getPhysicsPluginName())}e.metadata&&(i.metadata=e.metadata),i.morphTargetManagers=[];for(const t of e.meshes){const e=t.morphTargetManager;e&&i.morphTargetManagers.push(e.serialize())}let r,s,n;for(i.lights=[],r=0;r<e.lights.length;r++)s=e.lights[r],s.doNotSerialize||i.lights.push(s.serialize());for(i.cameras=[],r=0;r<e.cameras.length;r++){const t=e.cameras[r];t.doNotSerialize||i.cameras.push(t.serialize())}if(e.activeCamera&&(i.activeCameraID=e.activeCamera.id),Ue.p.AppendSerializedAnimations(e,i),e.animationGroups&&e.animationGroups.length>0){i.animationGroups=[];for(let t=0;t<e.animationGroups.length;t++){const r=e.animationGroups[t];i.animationGroups.push(r.serialize())}}if(e.reflectionProbes&&e.reflectionProbes.length>0)for(i.reflectionProbes=[],r=0;r<e.reflectionProbes.length;r++){const t=e.reflectionProbes[r];i.reflectionProbes.push(t.serialize())}for(i.materials=[],i.multiMaterials=[],r=0;r<e.materials.length;r++)n=e.materials[r],n.doNotSerialize||i.materials.push(n.serialize());for(i.multiMaterials=[],r=0;r<e.multiMaterials.length;r++){const t=e.multiMaterials[r];i.multiMaterials.push(t.serialize())}for(e.environmentTexture&&(e.environmentTexture._files?i.environmentTexture=e.environmentTexture.serialize():(i.environmentTexture=e.environmentTexture.name,i.environmentTextureRotationY=e.environmentTexture.rotationY)),i.environmentIntensity=e.environmentIntensity,i.skeletons=[],r=0;r<e.skeletons.length;r++){const t=e.skeletons[r];t.doNotSerialize||i.skeletons.push(t.serialize())}for(i.transformNodes=[],r=0;r<e.transformNodes.length;r++)e.transformNodes[r].doNotSerialize||i.transformNodes.push(e.transformNodes[r].serialize());i.geometries={},i.geometries.boxes=[],i.geometries.spheres=[],i.geometries.cylinders=[],i.geometries.toruses=[],i.geometries.grounds=[],i.geometries.planes=[],i.geometries.torusKnots=[],i.geometries.vertexData=[],QP=[];const o=e.getGeometries();for(r=0;r<o.length;r++){const e=o[r];e.isReady()&&KP(e,i.geometries)}for(i.meshes=[],r=0;r<e.meshes.length;r++){const t=e.meshes[r];if(t instanceof tt.e){const e=t;e.doNotSerialize||1!==e.delayLoadState&&0!==e.delayLoadState||i.meshes.push(JP(e,i))}}for(i.particleSystems=[],r=0;r<e.particleSystems.length;r++)i.particleSystems.push(e.particleSystems[r].serialize(!1));for(i.postProcesses=[],r=0;r<e.postProcesses.length;r++)i.postProcesses.push(e.postProcesses[r].serialize());e.actionManager&&(i.actions=e.actionManager.serialize("scene"));for(const t of e._serializableComponents)t.serialize(i);if(e.spriteManagers)for(i.spriteManagers=[],r=0;r<e.spriteManagers.length;r++)i.spriteManagers.push(e.spriteManagers[r].serialize(!0));return i}static SerializeAsync(e){const t=eT._Serialize(e,!1),i=[];return this._CollectPromises(t,i),Promise.all(i).then((()=>t))}static _CollectPromises(e,t){if(Array.isArray(e))for(let i=0;i<e.length;++i){const r=e[i];r instanceof Promise?t.push(r.then((t=>e[i]=t))):(r instanceof Object||Array.isArray(r))&&this._CollectPromises(r,t)}else if(e instanceof Object)for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i)){const r=e[i];r instanceof Promise?t.push(r.then((t=>e[i]=t))):(r instanceof Object||Array.isArray(r))&&this._CollectPromises(r,t)}}static SerializeMesh(e,t=!1,i=!1){const r={meshes:[],transformNodes:[],cameras:[],lights:[]};if(eT.ClearCache(),e=e instanceof Array?e:[e],t||i)for(let r=0;r<e.length;++r)i&&e[r].getDescendants().forEach((t=>{e.indexOf(t)<0&&!t.doNotSerialize&&e.push(t)})),t&&e[r].parent&&e.indexOf(e[r].parent)<0&&!e[r].parent.doNotSerialize&&e.push(e[r].parent);return e.forEach((e=>{((e,t)=>{if(e._isMesh){const i=e;if(1===i.delayLoadState||0===i.delayLoadState){const e=e=>{t.materials=t.materials||[],i.material&&!t.materials.some((e=>e.id===i.material.id))&&t.materials.push(e.serialize())};if(i.material&&!i.material.doNotSerialize)if(i.material instanceof gm.F){if(t.multiMaterials=t.multiMaterials||[],!t.multiMaterials.some((e=>e.id===i.material.id))){t.multiMaterials.push(i.material.serialize());for(const t of i.material.subMaterials)t&&e(t)}}else e(i.material);else i.material||e(i.getScene().defaultMaterial);const r=i._geometry;r&&(t.geometries||(t.geometries={},t.geometries.boxes=[],t.geometries.spheres=[],t.geometries.cylinders=[],t.geometries.toruses=[],t.geometries.grounds=[],t.geometries.planes=[],t.geometries.torusKnots=[],t.geometries.vertexData=[]),KP(r,t.geometries)),i.skeleton&&!i.skeleton.doNotSerialize&&(t.skeletons=t.skeletons||[],t.skeletons.push(i.skeleton.serialize())),t.meshes=t.meshes||[],t.meshes.push(JP(i,t))}}else if("TransformNode"===e.getClassName()){const i=e;t.transformNodes.push(i.serialize())}else if(-1!==e.getClassName().indexOf("Camera")){const i=e;t.cameras.push(i.serialize())}else if(-1!==e.getClassName().indexOf("Light")){const i=e;t.lights.push(i.serialize())}})(e,r)})),r}}var tT=i(27152),iT=i(92905),rT=i(19278),sT=i(91650),nT=i(3613),oT=i(52053);class aT{static IsSupported(e,t){const i=t??e.getRenderingCanvas();return!!i&&"function"==typeof i.captureStream}get isRecording(){return!!this._canvas&&this._isRecording}constructor(e,t={}){if(!aT.IsSupported(e,t.canvas))throw"Your browser does not support recording so far.";const i=t.canvas??e.getRenderingCanvas();if(!i)throw"The babylon engine must have a canvas to be recorded";this._canvas=i,this._isRecording=!1,this._options={...aT._DefaultOptions,...t};const r=this._canvas.captureStream(this._options.fps);if(this._options.audioTracks)for(const e of this._options.audioTracks)r.addTrack(e);this._mediaRecorder=new MediaRecorder(r,{mimeType:this._options.mimeType}),this._mediaRecorder.ondataavailable=e=>this._handleDataAvailable(e),this._mediaRecorder.onerror=e=>this._handleError(e),this._mediaRecorder.onstop=()=>this._handleStop()}stopRecording(){this._canvas&&this._mediaRecorder&&this.isRecording&&(this._isRecording=!1,this._mediaRecorder.stop())}startRecording(e="babylonjs.webm",t=7){if(!this._canvas||!this._mediaRecorder)throw"Recorder has already been disposed";if(this.isRecording)throw"Recording already in progress";return t>0&&setTimeout((()=>{this.stopRecording()}),1e3*t),this._fileName=e,this._recordedChunks=[],this._resolve=null,this._reject=null,this._isRecording=!0,this._mediaRecorder.start(this._options.recordChunckSize),new Promise(((e,t)=>{this._resolve=e,this._reject=t}))}dispose(){this._canvas=null,this._mediaRecorder=null,this._recordedChunks=[],this._fileName=null,this._resolve=null,this._reject=null}_handleDataAvailable(e){e.data.size>0&&this._recordedChunks.push(e.data)}_handleError(e){if(this.stopRecording(),!this._reject)throw new e.error;this._reject(e.error)}_handleStop(){this.stopRecording();const e=new Blob(this._recordedChunks);this._resolve&&this._resolve(e),window.URL.createObjectURL(e),this._fileName&&H.S0.Download(e,this._fileName)}}aT._DefaultOptions={mimeType:"video/webm",fps:25,recordChunckSize:3e3};var lT=i(97573);class hT extends Fi.w{getClassName(){return"FxaaPostProcess"}constructor(e,t,i=null,r,s,n,o=0){super(e,"fxaa",["texelSize"],null,t,i,r||$e.g.BILINEAR_SAMPLINGMODE,s,n,null,o,"fxaa",void 0,!0);const a=this._getDefines();this.updateEffect(a),this.onApplyObservable.add((e=>{const t=this.texelSize;e.setFloat2("texelSize",t.x,t.y)}))}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,72578)),Promise.resolve().then(i.bind(i,53208))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,5499)),Promise.resolve().then(i.bind(i,9669))])),super._gatherImports(e,t)}_getDefines(){const e=this.getEngine();if(!e)return null;return e.extractDriverInfo().toLowerCase().indexOf("mali")>-1?"#define MALI 1\n":null}static _Parse(e,t,i,r){return Ue.p.Parse((()=>new hT(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,r)}}(0,a.Y5)("BABYLON.FxaaPostProcess",hT);var cT=i(89928);let uT=null;function dT(e,t,i,r,s="image/png",n=!1,o,a=!1){const{height:l,width:h}=gT(e,t,i);if(!l||!h)return void m.V.Error("Invalid 'size' parameter !");t.getScene().activeCamera===t?e.onEndFrameObservable.addOnce((()=>{uT||(uT=document.createElement("canvas")),uT.width=h,uT.height=l;const t=uT.getContext("2d"),i=e.getRenderingCanvas();if(!t||!i)return void m.V.Error("Failed to create screenshot. Rendering context or rendering canvas is not available.");const c=i.width,u=i.height,d=uT.width,p=uT.height,f=d/c,_=p/u,g=a?Math.max(f,_):Math.min(f,_),x=c*g,v=u*g,S=(d-x)/2,b=(p-v)/2;t.drawImage(i,0,0,c,u,S,b,x,v),n?(H.S0.EncodeScreenshotCanvasData(uT,void 0,s,void 0,o),r&&r("")):H.S0.EncodeScreenshotCanvasData(uT,r,s,void 0,o)})):fT(e,t,i,(e=>{if(n){const t=new Blob([e]);H.S0.DownloadBlob(t),r&&r("")}else r&&r(e)}),s,1,e.getCreationOptions().antialias,void 0,void 0,void 0,void 0,o)}function pT(e,t,i,r="image/png",s,n=!1){return new Promise(((o,a)=>{dT(e,t,i,(e=>{void 0!==e?o(e):a(new Error("Data is undefined"))}),r,void 0,s,n)}))}function mT(e,t,i,r,s="image/png",n,o=!1){return new Promise((a=>{dT(e,t,{width:i,height:r},(()=>{a()}),s,!0,n,o)}))}function fT(e,t,r,s,n="image/png",o=1,a=!1,l,h=!1,c=!1,u=!0,d,p,f){const{height:_,width:g,finalWidth:x,finalHeight:v}=gT(e,t,r),S={width:g,height:_};if(!_||!g)return void m.V.Error("Invalid 'size' parameter !");e.skipFrameRender=!0;const b=e.getRenderWidth,y=e.getRenderHeight;e.getRenderWidth=(t=!1)=>!t&&e._currentRenderTarget?e._currentRenderTarget.width:g,e.getRenderHeight=(t=!1)=>!t&&e._currentRenderTarget?e._currentRenderTarget.height:_,e.onResizeObservable.hasObservers()&&e.onResizeObservable.notifyObservers(e);const P=t.getScene(),T=new cr.$("screenShot",S,P,!1,!1,0,!1,$e.g.BILINEAR_SAMPLINGMODE,void 0,c,void 0,void 0,void 0,o);T.renderList=P.meshes.slice(),T.samples=o,T.renderSprites=h,T.activeCamera=t,T.forceLayerMaskCheck=u,p?.(T);const C=f||cT.DumpData,E=()=>{P.incrementRenderId(),P.resetCachedMaterial(),(0,us.F)((()=>T.isReadyForRendering()&&t.isReady(!0)),(()=>{e.onEndFrameObservable.addOnce((()=>{x===g&&v===_?T.readPixels(void 0,void 0,void 0,!1).then((e=>{C(g,_,e,s,n,l,!0,void 0,d),T.dispose()})):(e.isWebGPU?Promise.resolve().then(i.bind(i,99965)):Promise.resolve().then(i.bind(i,79820))).then((()=>(0,Vy.Qs)("pass",T.getInternalTexture(),P,void 0,void 0,void 0,x,v).then((t=>{e._readTexturePixels(t,x,v,-1,0,null,!0,!1,0,0).then((e=>{C(x,v,e,s,n,l,!0,void 0,d),t.dispose()}))}))))})),P.incrementRenderId(),P.resetCachedMaterial();const r=P.activeCamera,o=P.activeCameras,a=t.outputRenderTarget,c=P.spritesEnabled;P.activeCamera=t,P.activeCameras=null,t.outputRenderTarget=T,P.spritesEnabled=h;const u=P.meshes;P.meshes=T.renderList||P.meshes;try{P.render()}finally{P.activeCamera=r,P.activeCameras=o,t.outputRenderTarget=a,P.spritesEnabled=c,P.meshes=u,e.getRenderWidth=b,e.getRenderHeight=y,e.onResizeObservable.hasObservers()&&e.onResizeObservable.notifyObservers(e),t.getProjectionMatrix(!0),e.skipFrameRender=!1}}),(()=>{e.skipFrameRender=!1,e.getRenderWidth=b,e.getRenderHeight=y}))};if(a){const e=new hT("antialiasing",1,P.activeCamera);T.addPostProcess(e),e.onEffectCreatedObservable.addOnce((e=>{e.isReady()?E():e.onCompiled=()=>{E()}}))}else E()}function _T(e,t,i,r="image/png",s=1,n=!1,o,a=!1,l=!1,h=!0,c,u,d){return new Promise(((p,m)=>{fT(e,t,i,(e=>{void 0!==e?p(e):m(new Error("Data is undefined"))}),r,s,n,o,a,l,h,c,u,d)}))}function gT(e,t,i){let r=0,s=0,n=0,o=0;if("object"==typeof i){const a=i.precision?Math.abs(i.precision):1;i.width&&i.height?(r=i.height*a,s=i.width*a):i.width&&!i.height?(s=i.width*a,r=Math.round(s/e.getAspectRatio(t))):i.height&&!i.width?(r=i.height*a,s=Math.round(r*e.getAspectRatio(t))):(s=Math.round(e.getRenderWidth()*a),r=Math.round(s/e.getAspectRatio(t))),i.finalWidth&&i.finalHeight?(o=i.finalHeight,n=i.finalWidth):i.finalWidth&&!i.finalHeight?(n=i.finalWidth,o=Math.round(n/e.getAspectRatio(t))):i.finalHeight&&!i.finalWidth?(o=i.finalHeight,n=Math.round(o*e.getAspectRatio(t))):(n=s,o=r)}else isNaN(i)||(r=i,s=i,n=i,o=i);return s&&(s=Math.floor(s)),r&&(r=Math.floor(r)),n&&(n=Math.floor(n)),o&&(o=Math.floor(o)),{height:0|r,width:0|s,finalWidth:0|n,finalHeight:0|o}}const xT={CreateScreenshot:dT,CreateScreenshotAsync:pT,CreateScreenshotWithResizeAsync:mT,CreateScreenshotUsingRenderTarget:fT,CreateScreenshotUsingRenderTargetAsync:_T};var vT;H.S0.CreateScreenshot=dT,H.S0.CreateScreenshotAsync=pT,H.S0.CreateScreenshotUsingRenderTarget=fT,H.S0.CreateScreenshotUsingRenderTargetAsync=_T,function(e){e[e.Checkbox=0]="Checkbox",e[e.Slider=1]="Slider",e[e.Vector3=2]="Vector3",e[e.Quaternion=3]="Quaternion",e[e.Color3=4]="Color3",e[e.String=5]="String",e[e.Button=6]="Button",e[e.Options=7]="Options",e[e.Tab=8]="Tab",e[e.FileButton=9]="FileButton",e[e.Vector2=10]="Vector2"}(vT||(vT={}));var ST=i(97126);class bT{constructor(e,t,i){this.gradient=e,this.color1=t,this.color2=i}getColorToRef(e){this.color2?o.ov.LerpToRef(this.color1,this.color2,Math.random(),e):e.copyFrom(this.color1)}}class yT{constructor(e,t){this.gradient=e,this.color=t}}class PT{constructor(e,t,i){this.gradient=e,this.factor1=t,this.factor2=i}getFactor(){return void 0===this.factor2||this.factor2===this.factor1?this.factor1:this.factor1+(this.factor2-this.factor1)*Math.random()}}class TT{static GetCurrentGradient(e,t,i){if(t[0].gradient>e)return void i(t[0],t[0],1);for(let r=0;r<t.length-1;r++){const s=t[r],n=t[r+1];if(e>=s.gradient&&e<=n.gradient){return void i(s,n,(e-s.gradient)/(n.gradient-s.gradient))}}const r=t.length-1;i(t[r],t[r],1)}}var CT=i(61326),ET=i(97974);class AT{static _GetStorage(){try{return localStorage.setItem("test",""),localStorage.removeItem("test"),localStorage}catch{const e={};return{getItem:t=>{const i=e[t];return void 0===i?null:i},setItem:(t,i)=>{e[t]=i}}}}static ReadString(e,t){const i=this._Storage.getItem(e);return null!==i?i:t}static WriteString(e,t){this._Storage.setItem(e,t)}static ReadBoolean(e,t){const i=this._Storage.getItem(e);return null!==i?"true"===i:t}static WriteBoolean(e,t){this._Storage.setItem(e,t?"true":"false")}static ReadNumber(e,t){const i=this._Storage.getItem(e);return null!==i?parseFloat(i):t}static WriteNumber(e,t){this._Storage.setItem(e,t.toString())}}AT._Storage=AT._GetStorage();class IT{constructor(e){this.particleSystem=e,this.position=n.Pq.Zero(),this.direction=n.Pq.Zero(),this.color=new o.ov(0,0,0,0),this.colorStep=new o.ov(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new n.I9(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._attachedSubEmitters=null,this._currentColor1=new o.ov(0,0,0,0),this._currentColor2=new o.ov(0,0,0,0),this._currentSize1=0,this._currentSize2=0,this._currentAngularSpeed1=0,this._currentAngularSpeed2=0,this._currentVelocity1=0,this._currentVelocity2=0,this._currentLimitVelocity1=0,this._currentLimitVelocity2=0,this._currentDrag1=0,this._currentDrag2=0,this.id=IT._Count++,this.particleSystem.isAnimationSheetEnabled&&this._updateCellInfoFromSystem()}_updateCellInfoFromSystem(){this.cellIndex=this.particleSystem.startSpriteCellID}updateCellIndex(){let e=this.age,t=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(void 0===this._randomCellOffset&&(this._randomCellOffset=Math.random()*this.lifeTime),0===t?(t=1,e=this._randomCellOffset):e+=this._randomCellOffset);const i=this._initialEndSpriteCellID-this._initialStartSpriteCellID+1;let r;r=this._initialSpriteCellLoop?(0,yt.Clamp)(e*t%this.lifeTime/this.lifeTime):(0,yt.Clamp)(e*t/this.lifeTime),this.cellIndex=this._initialStartSpriteCellID+r*i|0}_inheritParticleInfoToSubEmitter(e){if(e.particleSystem.emitter.position){const t=e.particleSystem.emitter;if(t.position.copyFrom(this.position),e.inheritDirection){const e=n.AA.Vector3[0];this.direction.normalizeToRef(e),t.setDirection(e,0,Math.PI/2)}}else{e.particleSystem.emitter.copyFrom(this.position)}this.direction.scaleToRef(e.inheritedVelocityAmount/2,n.AA.Vector3[0]),e.particleSystem._inheritedVelocityOffset.copyFrom(n.AA.Vector3[0])}_inheritParticleInfoToSubEmitters(){this._attachedSubEmitters&&this._attachedSubEmitters.length>0&&this._attachedSubEmitters.forEach((e=>{this._inheritParticleInfoToSubEmitter(e)}))}_reset(){this.age=0,this.id=IT._Count++,this._currentColorGradient=null,this._currentSizeGradient=null,this._currentAngularSpeedGradient=null,this._currentVelocityGradient=null,this._currentLimitVelocityGradient=null,this._currentDragGradient=null,this.cellIndex=this.particleSystem.startSpriteCellID,this._randomCellOffset=void 0}copyTo(e){e.position.copyFrom(this.position),this._initialDirection?e._initialDirection?e._initialDirection.copyFrom(this._initialDirection):e._initialDirection=this._initialDirection.clone():e._initialDirection=null,e.direction.copyFrom(this.direction),this._localPosition&&(e._localPosition?e._localPosition.copyFrom(this._localPosition):e._localPosition=this._localPosition.clone()),e.color.copyFrom(this.color),e.colorStep.copyFrom(this.colorStep),e.lifeTime=this.lifeTime,e.age=this.age,e._randomCellOffset=this._randomCellOffset,e.size=this.size,e.scale.copyFrom(this.scale),e.angle=this.angle,e.angularSpeed=this.angularSpeed,e.particleSystem=this.particleSystem,e.cellIndex=this.cellIndex,e.id=this.id,e._attachedSubEmitters=this._attachedSubEmitters,this._currentColorGradient&&(e._currentColorGradient=this._currentColorGradient,e._currentColor1.copyFrom(this._currentColor1),e._currentColor2.copyFrom(this._currentColor2)),this._currentSizeGradient&&(e._currentSizeGradient=this._currentSizeGradient,e._currentSize1=this._currentSize1,e._currentSize2=this._currentSize2),this._currentAngularSpeedGradient&&(e._currentAngularSpeedGradient=this._currentAngularSpeedGradient,e._currentAngularSpeed1=this._currentAngularSpeed1,e._currentAngularSpeed2=this._currentAngularSpeed2),this._currentVelocityGradient&&(e._currentVelocityGradient=this._currentVelocityGradient,e._currentVelocity1=this._currentVelocity1,e._currentVelocity2=this._currentVelocity2),this._currentLimitVelocityGradient&&(e._currentLimitVelocityGradient=this._currentLimitVelocityGradient,e._currentLimitVelocity1=this._currentLimitVelocity1,e._currentLimitVelocity2=this._currentLimitVelocity2),this._currentDragGradient&&(e._currentDragGradient=this._currentDragGradient,e._currentDrag1=this._currentDrag1,e._currentDrag2=this._currentDrag2),this.particleSystem.isAnimationSheetEnabled&&(e._initialStartSpriteCellID=this._initialStartSpriteCellID,e._initialEndSpriteCellID=this._initialEndSpriteCellID,e._initialSpriteCellLoop=this._initialSpriteCellLoop),this.particleSystem.useRampGradients&&(e.remapData&&this.remapData?e.remapData.copyFrom(this.remapData):e.remapData=new n.IU(0,0,0,0)),this._randomNoiseCoordinates1&&(e._randomNoiseCoordinates1?(e._randomNoiseCoordinates1.copyFrom(this._randomNoiseCoordinates1),e._randomNoiseCoordinates2.copyFrom(this._randomNoiseCoordinates2)):(e._randomNoiseCoordinates1=this._randomNoiseCoordinates1.clone(),e._randomNoiseCoordinates2=this._randomNoiseCoordinates2.clone()))}}IT._Count=0;class RT{constructor(){this.direction1=new n.Pq(0,1,0),this.direction2=new n.Pq(0,1,0),this.minEmitBox=new n.Pq(-.5,-.5,-.5),this.maxEmitBox=new n.Pq(.5,.5,.5)}startDirectionFunction(e,t,i,r){const s=(0,yt.RandomRange)(this.direction1.x,this.direction2.x),o=(0,yt.RandomRange)(this.direction1.y,this.direction2.y),a=(0,yt.RandomRange)(this.direction1.z,this.direction2.z);if(r)return t.x=s,t.y=o,void(t.z=a);n.Pq.TransformNormalFromFloatsToRef(s,o,a,e,t)}startPositionFunction(e,t,i,r){const s=(0,yt.RandomRange)(this.minEmitBox.x,this.maxEmitBox.x),o=(0,yt.RandomRange)(this.minEmitBox.y,this.maxEmitBox.y),a=(0,yt.RandomRange)(this.minEmitBox.z,this.maxEmitBox.z);if(r)return t.x=s,t.y=o,void(t.z=a);n.Pq.TransformCoordinatesFromFloatsToRef(s,o,a,e,t)}clone(){const e=new RT;return E.r.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2),e.setVector3("minEmitBox",this.minEmitBox),e.setVector3("maxEmitBox",this.maxEmitBox)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3),e.addUniform("minEmitBox",3),e.addUniform("maxEmitBox",3)}getEffectDefines(){return"#define BOXEMITTER"}getClassName(){return"BoxParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e}parse(e){n.Pq.FromArrayToRef(e.direction1,0,this.direction1),n.Pq.FromArrayToRef(e.direction2,0,this.direction2),n.Pq.FromArrayToRef(e.minEmitBox,0,this.minEmitBox),n.Pq.FromArrayToRef(e.maxEmitBox,0,this.maxEmitBox)}}var MT,DT=i(80010);class OT extends qd{set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get useRampGradients(){return this._useRampGradients}set useRampGradients(e){this._useRampGradients!==e&&(this._useRampGradients=e,this._resetEffect())}get particles(){return this._particles}get shaderLanguage(){return this._shaderLanguage}getActiveCount(){return this._particles.length}getClassName(){return"ParticleSystem"}isStopping(){return this._stopped&&this.isAlive()}getCustomEffect(e=0){return this._customWrappers[e]?.effect??this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){return this._customWrappers[e]??this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new Ah.E(this._engine),this._customWrappers[t].effect=e,this._customWrappers[t].drawContext&&(this._customWrappers[t].drawContext.useInstancing=this._useInstancing)}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new s.cP),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"particles"}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}constructor(e,t,i,r=null,a=!1,l=.01){super(e),this._emitterInverseWorldMatrix=n.uq.Identity(),this._inheritedVelocityOffset=new n.Pq,this.onDisposeObservable=new s.cP,this.onStoppedObservable=new s.cP,this._particles=new Array,this._stockParticles=new Array,this._newPartsExcess=0,this._vertexBuffers={},this._scaledColorStep=new o.ov(0,0,0,0),this._colorDiff=new o.ov(0,0,0,0),this._scaledDirection=n.Pq.Zero(),this._scaledGravity=n.Pq.Zero(),this._currentRenderId=-1,this._useInstancing=!1,this._started=!1,this._stopped=!1,this._actualFrame=0,this._currentEmitRate1=0,this._currentEmitRate2=0,this._currentStartSize1=0,this._currentStartSize2=0,this.updateInAnimate=!0,this._rawTextureWidth=256,this._useRampGradients=!1,this.isLocal=!1,this.isGPU=!1,this._shaderLanguage=0,this._onBeforeDrawParticlesObservable=null,this._emitFromParticle=e=>{},this.recycleParticle=e=>{const t=this._particles.pop();t!==e&&t.copyTo(e),this._stockParticles.push(t)},this._createParticle=()=>{let e;return 0!==this._stockParticles.length?(e=this._stockParticles.pop(),e._reset()):e=new IT(this),this._prepareParticle(e),e},this._shadersLoaded=!1,this._capacity=t,this._epsilon=l,this._isAnimationSheetEnabled=a,i&&"Scene"!==i.getClassName()?(this._engine=i,this.defaultProjectionMatrix=n.uq.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)):(this._scene=i||C.q.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)),this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._initShaderSourceAsync(),this._attachImageProcessingConfiguration(null),this._customWrappers={0:new Ah.E(this._engine)},this._customWrappers[0].effect=r,this._drawWrappers=[],this._useInstancing=this._engine.getCaps().instancedArrays,this._createIndexBuffer(),this._createVertexBuffers(),this.particleEmitterType=new RT;let h=null;this.updateFunction=e=>{let t=null;this.noiseTexture&&(t=this.noiseTexture.getSize(),this.noiseTexture.getContent()?.then((e=>{h=e})));const i=e===this._particles;for(let r=0;r<e.length;r++){const s=e[r];let a=this._scaledUpdateSpeed;const l=s.age;if(s.age+=a,s.age>s.lifeTime){const e=s.age-l;a=(s.lifeTime-l)*a/e,s.age=s.lifeTime}const c=s.age/s.lifeTime;this._colorGradients&&this._colorGradients.length>0?TT.GetCurrentGradient(c,this._colorGradients,((e,t,i)=>{e!==s._currentColorGradient&&(s._currentColor1.copyFrom(s._currentColor2),t.getColorToRef(s._currentColor2),s._currentColorGradient=e),o.ov.LerpToRef(s._currentColor1,s._currentColor2,i,s.color)})):(s.colorStep.scaleToRef(a,this._scaledColorStep),s.color.addInPlace(this._scaledColorStep),s.color.a<0&&(s.color.a=0)),this._angularSpeedGradients&&this._angularSpeedGradients.length>0&&TT.GetCurrentGradient(c,this._angularSpeedGradients,((e,t,i)=>{e!==s._currentAngularSpeedGradient&&(s._currentAngularSpeed1=s._currentAngularSpeed2,s._currentAngularSpeed2=t.getFactor(),s._currentAngularSpeedGradient=e),s.angularSpeed=(0,yt.Lerp)(s._currentAngularSpeed1,s._currentAngularSpeed2,i)})),s.angle+=s.angularSpeed*a;let u=a;if(this._velocityGradients&&this._velocityGradients.length>0&&TT.GetCurrentGradient(c,this._velocityGradients,((e,t,i)=>{e!==s._currentVelocityGradient&&(s._currentVelocity1=s._currentVelocity2,s._currentVelocity2=t.getFactor(),s._currentVelocityGradient=e),u*=(0,yt.Lerp)(s._currentVelocity1,s._currentVelocity2,i)})),s.direction.scaleToRef(u,this._scaledDirection),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&TT.GetCurrentGradient(c,this._limitVelocityGradients,((e,t,i)=>{e!==s._currentLimitVelocityGradient&&(s._currentLimitVelocity1=s._currentLimitVelocity2,s._currentLimitVelocity2=t.getFactor(),s._currentLimitVelocityGradient=e);const r=(0,yt.Lerp)(s._currentLimitVelocity1,s._currentLimitVelocity2,i);s.direction.length()>r&&s.direction.scaleInPlace(this.limitVelocityDamping)})),this._dragGradients&&this._dragGradients.length>0&&TT.GetCurrentGradient(c,this._dragGradients,((e,t,i)=>{e!==s._currentDragGradient&&(s._currentDrag1=s._currentDrag2,s._currentDrag2=t.getFactor(),s._currentDragGradient=e);const r=(0,yt.Lerp)(s._currentDrag1,s._currentDrag2,i);this._scaledDirection.scaleInPlace(1-r)})),this.isLocal&&s._localPosition?(s._localPosition.addInPlace(this._scaledDirection),n.Pq.TransformCoordinatesToRef(s._localPosition,this._emitterWorldMatrix,s.position)):s.position.addInPlace(this._scaledDirection),h&&t&&s._randomNoiseCoordinates1){const e=this._fetchR(s._randomNoiseCoordinates1.x,s._randomNoiseCoordinates1.y,t.width,t.height,h),i=this._fetchR(s._randomNoiseCoordinates1.z,s._randomNoiseCoordinates2.x,t.width,t.height,h),r=this._fetchR(s._randomNoiseCoordinates2.y,s._randomNoiseCoordinates2.z,t.width,t.height,h),o=n.AA.Vector3[0],l=n.AA.Vector3[1];o.copyFromFloats((2*e-1)*this.noiseStrength.x,(2*i-1)*this.noiseStrength.y,(2*r-1)*this.noiseStrength.z),o.scaleToRef(a,l),s.direction.addInPlace(l)}this.gravity.scaleToRef(a,this._scaledGravity),s.direction.addInPlace(this._scaledGravity),this._sizeGradients&&this._sizeGradients.length>0&&TT.GetCurrentGradient(c,this._sizeGradients,((e,t,i)=>{e!==s._currentSizeGradient&&(s._currentSize1=s._currentSize2,s._currentSize2=t.getFactor(),s._currentSizeGradient=e),s.size=(0,yt.Lerp)(s._currentSize1,s._currentSize2,i)})),this._useRampGradients&&(this._colorRemapGradients&&this._colorRemapGradients.length>0&&TT.GetCurrentGradient(c,this._colorRemapGradients,((e,t,i)=>{const r=(0,yt.Lerp)(e.factor1,t.factor1,i),n=(0,yt.Lerp)(e.factor2,t.factor2,i);s.remapData.x=r,s.remapData.y=n-r})),this._alphaRemapGradients&&this._alphaRemapGradients.length>0&&TT.GetCurrentGradient(c,this._alphaRemapGradients,((e,t,i)=>{const r=(0,yt.Lerp)(e.factor1,t.factor1,i),n=(0,yt.Lerp)(e.factor2,t.factor2,i);s.remapData.z=r,s.remapData.w=n-r}))),this._isAnimationSheetEnabled&&s.updateCellIndex(),s._inheritParticleInfoToSubEmitters(),s.age>=s.lifeTime&&(this._emitFromParticle(s),s._attachedSubEmitters&&(s._attachedSubEmitters.forEach((e=>{e.particleSystem.disposeOnStop=!0,e.particleSystem.stop()})),s._attachedSubEmitters=null),this.recycleParticle(s),i&&r--)}}}serialize(e){throw new Error("Method not implemented.")}clone(e,t,i=!1){throw new Error("Method not implemented.")}_addFactorGradient(e,t,i,r){const s=new PT(t,i,r);e.push(s),e.sort(((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0))}_removeFactorGradient(e,t){if(!e)return;let i=0;for(const r of e){if(r.gradient===t){e.splice(i,1);break}i++}}addLifeTimeGradient(e,t,i){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,e,t,i),this}removeLifeTimeGradient(e){return this._removeFactorGradient(this._lifeTimeGradients,e),this}addSizeGradient(e,t,i){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t,i),this}removeSizeGradient(e){return this._removeFactorGradient(this._sizeGradients,e),this}addColorRemapGradient(e,t,i){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,e,t,i),this}removeColorRemapGradient(e){return this._removeFactorGradient(this._colorRemapGradients,e),this}addAlphaRemapGradient(e,t,i){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,e,t,i),this}removeAlphaRemapGradient(e){return this._removeFactorGradient(this._alphaRemapGradients,e),this}addAngularSpeedGradient(e,t,i){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t,i),this}removeAngularSpeedGradient(e){return this._removeFactorGradient(this._angularSpeedGradients,e),this}addVelocityGradient(e,t,i){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t,i),this}removeVelocityGradient(e){return this._removeFactorGradient(this._velocityGradients,e),this}addLimitVelocityGradient(e,t,i){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t,i),this}removeLimitVelocityGradient(e){return this._removeFactorGradient(this._limitVelocityGradients,e),this}addDragGradient(e,t,i){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t,i),this}removeDragGradient(e){return this._removeFactorGradient(this._dragGradients,e),this}addEmitRateGradient(e,t,i){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,e,t,i),this}removeEmitRateGradient(e){return this._removeFactorGradient(this._emitRateGradients,e),this}addStartSizeGradient(e,t,i){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,e,t,i),this}removeStartSizeGradient(e){return this._removeFactorGradient(this._startSizeGradients,e),this}_createRampGradientTexture(){if(!this._rampGradients||!this._rampGradients.length||this._rampGradientsTexture||!this._scene)return;const e=new Uint8Array(4*this._rawTextureWidth),t=o.IG.Color3[0];for(let i=0;i<this._rawTextureWidth;i++){const r=i/this._rawTextureWidth;TT.GetCurrentGradient(r,this._rampGradients,((r,s,n)=>{o.v9.LerpToRef(r.color,s.color,n,t),e[4*i]=255*t.r,e[4*i+1]=255*t.g,e[4*i+2]=255*t.b,e[4*i+3]=255}))}this._rampGradientsTexture=He.I.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1)}getRampGradients(){return this._rampGradients}forceRefreshGradients(){this._syncRampGradientTexture()}_syncRampGradientTexture(){this._rampGradients&&(this._rampGradients.sort(((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0)),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture())}addRampGradient(e,t){this._rampGradients||(this._rampGradients=[]);const i=new yT(e,t);return this._rampGradients.push(i),this._syncRampGradientTexture(),this}removeRampGradient(e){return this._removeGradientAndTexture(e,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this}addColorGradient(e,t,i){this._colorGradients||(this._colorGradients=[]);const r=new bT(e,t,i);return this._colorGradients.push(r),this._colorGradients.sort(((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0)),this}removeColorGradient(e){if(!this._colorGradients)return this;let t=0;for(const i of this._colorGradients){if(i.gradient===e){this._colorGradients.splice(t,1);break}t++}return this}resetDrawCache(){for(const e of this._drawWrappers)if(e)for(const t of e)t?.dispose();this._drawWrappers=[]}_fetchR(e,t,i,r,s){return s[4*(((e=.5*Math.abs(e)+.5)*i%i|0)+((t=.5*Math.abs(t)+.5)*r%r|0)*i)]/255}_reset(){this._resetEffect()}_resetEffect(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this._createVertexBuffers()}_createVertexBuffers(){this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),this._isBillboardBased&&8!==this.billboardMode&&9!==this.billboardMode||(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);const e=this._engine,t=this._vertexBufferSize*(this._useInstancing?1:4);this._vertexData=new Float32Array(this._capacity*t),this._vertexBuffer=new Ot.h(e,this._vertexData,!0,t);let i=0;const r=this._vertexBuffer.createVertexBuffer(Ot.R.PositionKind,i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[Ot.R.PositionKind]=r,i+=3;const s=this._vertexBuffer.createVertexBuffer(Ot.R.ColorKind,i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[Ot.R.ColorKind]=s,i+=4;const n=this._vertexBuffer.createVertexBuffer("angle",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=n,i+=1;const o=this._vertexBuffer.createVertexBuffer("size",i,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=o,i+=2,this._isAnimationSheetEnabled){const e=this._vertexBuffer.createVertexBuffer("cellIndex",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=e,i+=1}if(!this._isBillboardBased||8===this.billboardMode||9===this.billboardMode){const e=this._vertexBuffer.createVertexBuffer("direction",i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=e,i+=3}if(this._useRampGradients){const e=this._vertexBuffer.createVertexBuffer("remapData",i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=e,i+=4}let a;if(this._useInstancing){const t=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new Ot.h(e,t,!1,2),a=this._spriteBuffer.createVertexBuffer("offset",0,2)}else a=this._vertexBuffer.createVertexBuffer("offset",i,2,this._vertexBufferSize,this._useInstancing),i+=2;this._vertexBuffers.offset=a,this.resetDrawCache()}_createIndexBuffer(){if(this._useInstancing)return void(this._linesIndexBufferUseInstancing=this._engine.createIndexBuffer(new Uint32Array([0,1,1,3,3,2,2,0,0,3])));const e=[],t=[];let i=0;for(let r=0;r<this._capacity;r++)e.push(i),e.push(i+1),e.push(i+2),e.push(i),e.push(i+2),e.push(i+3),t.push(i,i+1,i+1,i+2,i+2,i+3,i+3,i,i,i+3),i+=4;this._indexBuffer=this._engine.createIndexBuffer(e),this._linesIndexBuffer=this._engine.createIndexBuffer(t)}getCapacity(){return this._capacity}isAlive(){return this._alive}isStarted(){return this._started}_preStart(){}start(e=this.startDelay){if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e)setTimeout((()=>{this.start(0)}),e);else{if(this._started=!0,this._stopped=!1,this._actualFrame=0,this._preStart(),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){-1!==this.emitter?.getClassName().indexOf("Mesh")&&this.emitter.computeWorldMatrix(!0);const e=this.noiseTexture;if(e&&e.onGeneratedObservable)e.onGeneratedObservable.addOnce((()=>{setTimeout((()=>{for(let t=0;t<this.preWarmCycles;t++)this.animate(!0),e.render()}))}));else for(let e=0;e<this.preWarmCycles;e++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}}stop(e=!0){this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0,this._postStop(e))}_postStop(e){}reset(){this._stockParticles.length=0,this._particles.length=0}_appendParticleVertex(e,t,i,r){let s=e*this._vertexBufferSize;if(this._vertexData[s++]=t.position.x+this.worldOffset.x,this._vertexData[s++]=t.position.y+this.worldOffset.y,this._vertexData[s++]=t.position.z+this.worldOffset.z,this._vertexData[s++]=t.color.r,this._vertexData[s++]=t.color.g,this._vertexData[s++]=t.color.b,this._vertexData[s++]=t.color.a,this._vertexData[s++]=t.angle,this._vertexData[s++]=t.scale.x*t.size,this._vertexData[s++]=t.scale.y*t.size,this._isAnimationSheetEnabled&&(this._vertexData[s++]=t.cellIndex),this._isBillboardBased)8!==this.billboardMode&&9!==this.billboardMode||(this._vertexData[s++]=t.direction.x,this._vertexData[s++]=t.direction.y,this._vertexData[s++]=t.direction.z);else if(t._initialDirection){let e=t._initialDirection;this.isLocal&&(n.Pq.TransformNormalToRef(e,this._emitterWorldMatrix,n.AA.Vector3[0]),e=n.AA.Vector3[0]),0===e.x&&0===e.z&&(e.x=.001),this._vertexData[s++]=e.x,this._vertexData[s++]=e.y,this._vertexData[s++]=e.z}else{let e=t.direction;this.isLocal&&(n.Pq.TransformNormalToRef(e,this._emitterWorldMatrix,n.AA.Vector3[0]),e=n.AA.Vector3[0]),0===e.x&&0===e.z&&(e.x=.001),this._vertexData[s++]=e.x,this._vertexData[s++]=e.y,this._vertexData[s++]=e.z}this._useRampGradients&&t.remapData&&(this._vertexData[s++]=t.remapData.x,this._vertexData[s++]=t.remapData.y,this._vertexData[s++]=t.remapData.z,this._vertexData[s++]=t.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(0===i?i=this._epsilon:1===i&&(i=1-this._epsilon),0===r?r=this._epsilon:1===r&&(r=1-this._epsilon)),this._vertexData[s++]=i,this._vertexData[s++]=r)}_prepareParticle(e){}_update(e){if(this._alive=this._particles.length>0,this.emitter.position){const e=this.emitter;this._emitterWorldMatrix=e.getWorldMatrix()}else{const e=this.emitter;this._emitterWorldMatrix=n.uq.Translation(e.x,e.y,e.z)}let t;this._emitterWorldMatrix.invertToRef(this._emitterInverseWorldMatrix),this.updateFunction(this._particles);for(let i=0;i<e&&this._particles.length!==this._capacity;i++){if(t=this._createParticle(),this._particles.push(t),this.targetStopDuration&&this._lifeTimeGradients&&this._lifeTimeGradients.length>0){const e=(0,yt.Clamp)(this._actualFrame/this.targetStopDuration);TT.GetCurrentGradient(e,this._lifeTimeGradients,((i,r)=>{const s=i,n=r,o=s.getFactor(),a=n.getFactor(),l=(e-s.gradient)/(n.gradient-s.gradient);t.lifeTime=(0,yt.Lerp)(o,a,l)}))}else t.lifeTime=(0,yt.RandomRange)(this.minLifeTime,this.maxLifeTime);const e=(0,yt.RandomRange)(this.minEmitPower,this.maxEmitPower);if(this.startPositionFunction?this.startPositionFunction(this._emitterWorldMatrix,t.position,t,this.isLocal):this.particleEmitterType.startPositionFunction(this._emitterWorldMatrix,t.position,t,this.isLocal),this.isLocal&&(t._localPosition?t._localPosition.copyFrom(t.position):t._localPosition=t.position.clone(),n.Pq.TransformCoordinatesToRef(t._localPosition,this._emitterWorldMatrix,t.position)),this.startDirectionFunction?this.startDirectionFunction(this._emitterWorldMatrix,t.direction,t,this.isLocal):this.particleEmitterType.startDirectionFunction(this._emitterWorldMatrix,t.direction,t,this.isLocal,this._emitterInverseWorldMatrix),0===e?t._initialDirection?t._initialDirection.copyFrom(t.direction):t._initialDirection=t.direction.clone():t._initialDirection=null,t.direction.scaleInPlace(e),this._sizeGradients&&0!==this._sizeGradients.length?(t._currentSizeGradient=this._sizeGradients[0],t._currentSize1=t._currentSizeGradient.getFactor(),t.size=t._currentSize1,this._sizeGradients.length>1?t._currentSize2=this._sizeGradients[1].getFactor():t._currentSize2=t._currentSize1):t.size=(0,yt.RandomRange)(this.minSize,this.maxSize),t.scale.copyFromFloats((0,yt.RandomRange)(this.minScaleX,this.maxScaleX),(0,yt.RandomRange)(this.minScaleY,this.maxScaleY)),this._startSizeGradients&&this._startSizeGradients[0]&&this.targetStopDuration){const e=this._actualFrame/this.targetStopDuration;TT.GetCurrentGradient(e,this._startSizeGradients,((e,i,r)=>{e!==this._currentStartSizeGradient&&(this._currentStartSize1=this._currentStartSize2,this._currentStartSize2=i.getFactor(),this._currentStartSizeGradient=e);const s=(0,yt.Lerp)(this._currentStartSize1,this._currentStartSize2,r);t.scale.scaleInPlace(s)}))}if(this._angularSpeedGradients&&0!==this._angularSpeedGradients.length?(t._currentAngularSpeedGradient=this._angularSpeedGradients[0],t.angularSpeed=t._currentAngularSpeedGradient.getFactor(),t._currentAngularSpeed1=t.angularSpeed,this._angularSpeedGradients.length>1?t._currentAngularSpeed2=this._angularSpeedGradients[1].getFactor():t._currentAngularSpeed2=t._currentAngularSpeed1):t.angularSpeed=(0,yt.RandomRange)(this.minAngularSpeed,this.maxAngularSpeed),t.angle=(0,yt.RandomRange)(this.minInitialRotation,this.maxInitialRotation),this._velocityGradients&&this._velocityGradients.length>0&&(t._currentVelocityGradient=this._velocityGradients[0],t._currentVelocity1=t._currentVelocityGradient.getFactor(),this._velocityGradients.length>1?t._currentVelocity2=this._velocityGradients[1].getFactor():t._currentVelocity2=t._currentVelocity1),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&(t._currentLimitVelocityGradient=this._limitVelocityGradients[0],t._currentLimitVelocity1=t._currentLimitVelocityGradient.getFactor(),this._limitVelocityGradients.length>1?t._currentLimitVelocity2=this._limitVelocityGradients[1].getFactor():t._currentLimitVelocity2=t._currentLimitVelocity1),this._dragGradients&&this._dragGradients.length>0&&(t._currentDragGradient=this._dragGradients[0],t._currentDrag1=t._currentDragGradient.getFactor(),this._dragGradients.length>1?t._currentDrag2=this._dragGradients[1].getFactor():t._currentDrag2=t._currentDrag1),this._colorGradients&&0!==this._colorGradients.length)t._currentColorGradient=this._colorGradients[0],t._currentColorGradient.getColorToRef(t.color),t._currentColor1.copyFrom(t.color),this._colorGradients.length>1?this._colorGradients[1].getColorToRef(t._currentColor2):t._currentColor2.copyFrom(t.color);else{const e=(0,yt.RandomRange)(0,1);o.ov.LerpToRef(this.color1,this.color2,e,t.color),this.colorDead.subtractToRef(t.color,this._colorDiff),this._colorDiff.scaleToRef(1/t.lifeTime,t.colorStep)}this._isAnimationSheetEnabled&&(t._initialStartSpriteCellID=this.startSpriteCellID,t._initialEndSpriteCellID=this.endSpriteCellID,t._initialSpriteCellLoop=this.spriteCellLoop),t.direction.addInPlace(this._inheritedVelocityOffset),this._useRampGradients&&(t.remapData=new n.IU(0,1,0,1)),this.noiseTexture&&(t._randomNoiseCoordinates1?(t._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),t._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(t._randomNoiseCoordinates1=new n.Pq(Math.random(),Math.random(),Math.random()),t._randomNoiseCoordinates2=new n.Pq(Math.random(),Math.random(),Math.random()))),t._inheritParticleInfoToSubEmitters()}}static _GetAttributeNamesOrOptions(e=!1,t=!1,i=!1){const r=[Ot.R.PositionKind,Ot.R.ColorKind,"angle","offset","size"];return e&&r.push("cellIndex"),t||r.push("direction"),i&&r.push("remapData"),r}static _GetEffectCreationOptions(e=!1,t=!1,i=!1){const r=["invView","view","projection","textureMask","translationPivot","eyePosition"];return(0,es.TV)(r),e&&r.push("particlesInfos"),t&&r.push("logarithmicDepthConstant"),i&&(r.push("vFogInfos"),r.push("vFogColor")),r}fillDefines(e,t,i=!0){if(this._scene&&((0,es.tv)(this,this._scene,e),this.applyFog&&this._scene.fogEnabled&&0!==this._scene.fogMode&&e.push("#define FOG")),this._isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),t===qd.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&e.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case 2:e.push("#define BILLBOARDY");break;case 8:case 9:e.push("#define BILLBOARDSTRETCHED"),9===this.billboardMode&&e.push("#define BILLBOARDSTRETCHED_LOCAL");break;case 7:e.push("#define BILLBOARDMODE_ALL")}i&&this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,i){t.push(...OT._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&8!==this.billboardMode&&9!==this.billboardMode,this._useRampGradients)),e.push(...OT._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth,this.applyFog)),i.push("diffuseSampler","rampSampler"),this._imageProcessingConfiguration&&((0,DT._)(e,this._imageProcessingConfigurationDefines),(0,DT.C)(i,this._imageProcessingConfigurationDefines))}_getWrapper(e){const t=this._getCustomDrawWrapper(e);if(t?.effect)return t;const i=[];this.fillDefines(i,e);const r=this._engine._features.supportRenderPasses?this._engine.currentRenderPassId:0;let s=this._drawWrappers[r];s||(s=this._drawWrappers[r]=[]);let n=s[e];n||(n=new Ah.E(this._engine),n.drawContext&&(n.drawContext.useInstancing=this._useInstancing),s[e]=n);const o=i.join("\n");if(n.defines!==o){const e=[],t=[],i=[];this.fillUniformsAttributesAndSamplerNames(t,e,i),n.setEffect(this._engine.createEffect("particles",e,t,i,o,void 0,void 0,void 0,void 0,this._shaderLanguage),o)}return n}animate(e=!1){if(!this._started)return;if(!e&&this._scene){if(!this.isReady())return;if(this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}let t;if(this._scaledUpdateSpeed=this.updateSpeed*(e?this.preWarmStepOffset:this._scene?.getAnimationRatio()||1),this.manualEmitCount>-1)t=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{let e=this.emitRate;if(this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration){const t=this._actualFrame/this.targetStopDuration;TT.GetCurrentGradient(t,this._emitRateGradients,((t,i,r)=>{t!==this._currentEmitRateGradient&&(this._currentEmitRate1=this._currentEmitRate2,this._currentEmitRate2=i.getFactor(),this._currentEmitRateGradient=t),e=(0,yt.Lerp)(this._currentEmitRate1,this._currentEmitRate2,r)}))}t=e*this._scaledUpdateSpeed|0,this._newPartsExcess+=e*this._scaledUpdateSpeed-t}if(this._newPartsExcess>1&&(t+=this._newPartsExcess|0,this._newPartsExcess-=this._newPartsExcess|0),this._alive=!1,this._stopped?t=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(t),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene&&this._scene._toBeDisposed.push(this))),!e){let e=0;for(let t=0;t<this._particles.length;t++){const i=this._particles[t];this._appendParticleVertices(e,i),e+=this._useInstancing?1:4}this._vertexBuffer&&this._vertexBuffer.updateDirectly(this._vertexData,0,this._particles.length)}0===this.manualEmitCount&&this.disposeOnStop&&this.stop()}_appendParticleVertices(e,t){this._appendParticleVertex(e++,t,0,0),this._useInstancing||(this._appendParticleVertex(e++,t,1,0),this._appendParticleVertex(e++,t,1,1),this._appendParticleVertex(e++,t,0,1))}rebuild(){this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._createIndexBuffer(),this._spriteBuffer?._rebuild(),this._createVertexBuffers(),this.resetDrawCache()}async _initShaderSourceAsync(){this._engine.isWebGPU&&!OT.ForceGLSL?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,27323)),Promise.resolve().then(i.bind(i,96913))])):await Promise.all([Promise.resolve().then(i.bind(i,59384)),Promise.resolve().then(i.bind(i,16066))]),this._shadersLoaded=!0}isReady(){if(!this._shadersLoaded)return!1;if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==qd.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else{if(!this._getWrapper(qd.BLENDMODE_MULTIPLY).effect.isReady())return!1;if(!this._getWrapper(qd.BLENDMODE_ADD).effect.isReady())return!1}return!0}_render(e){const t=this._getWrapper(e),i=t.effect,r=this._engine;r.enableEffect(t);const s=this.defaultViewMatrix??this._scene.getViewMatrix();if(i.setTexture("diffuseSampler",this.particleTexture),i.setMatrix("view",s),i.setMatrix("projection",this.defaultProjectionMatrix??this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){const e=this.particleTexture.getBaseSize();i.setFloat3("particlesInfos",this.spriteCellWidth/e.width,this.spriteCellHeight/e.height,this.spriteCellWidth/e.width)}if(i.setVector2("translationPivot",this.translationPivot),i.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased&&this._scene){const e=this._scene.activeCamera;i.setVector3("eyePosition",e.globalPosition)}this._rampGradientsTexture&&(this._rampGradients&&this._rampGradients.length||(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),i.setTexture("rampSampler",this._rampGradientsTexture));const o=i.defines;switch(this._scene&&((0,es.gS)(i,this,this._scene),this.applyFog&&(0,ts.Yy)(this._scene,void 0,i)),o.indexOf("#define BILLBOARDMODE_ALL")>=0&&(s.invertToRef(n.AA.Matrix[0]),i.setMatrix("invView",n.AA.Matrix[0])),void 0!==this._vertexArrayObject?this._scene?.forceWireframe?r.bindBuffers(this._vertexBuffers,this._linesIndexBufferUseInstancing,i):(this._vertexArrayObject||(this._vertexArrayObject=this._engine.recordVertexArrayObject(this._vertexBuffers,null,i)),this._engine.bindVertexArrayObject(this._vertexArrayObject,this._scene?.forceWireframe?this._linesIndexBufferUseInstancing:this._indexBuffer)):this._indexBuffer?r.bindBuffers(this._vertexBuffers,this._scene?.forceWireframe?this._linesIndexBuffer:this._indexBuffer,i):r.bindBuffers(this._vertexBuffers,this._scene?.forceWireframe?this._linesIndexBufferUseInstancing:null,i),this.useLogarithmicDepth&&this._scene&&(0,ts.DL)(o,i,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(i),e){case qd.BLENDMODE_ADD:r.setAlphaMode(1);break;case qd.BLENDMODE_ONEONE:r.setAlphaMode(6);break;case qd.BLENDMODE_STANDARD:r.setAlphaMode(2);break;case qd.BLENDMODE_MULTIPLY:r.setAlphaMode(4)}return this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(i),this._useInstancing?this._scene?.forceWireframe?r.drawElementsType(6,0,10,this._particles.length):r.drawArraysType(7,0,4,this._particles.length):this._scene?.forceWireframe?r.drawElementsType(1,0,10*this._particles.length):r.drawElementsType(0,0,6*this._particles.length),this._particles.length}render(){if(!this.isReady()||!this._particles.length)return 0;const e=this._engine;e.setState&&(e.setState(!1),this.forceDepthWrite&&e.setDepthWrite(!0));let t=0;return t=this.blendMode===qd.BLENDMODE_MULTIPLYADD?this._render(qd.BLENDMODE_MULTIPLY)+this._render(qd.BLENDMODE_ADD):this._render(this.blendMode),this._engine.unbindInstanceAttributes(),this._engine.setAlphaMode(0),t}_onDispose(e=!1,t=!1){}dispose(e=!0,t=!1,i=!1){if(this.resetDrawCache(),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._linesIndexBuffer&&(this._engine._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null),this._linesIndexBufferUseInstancing&&(this._engine._releaseBuffer(this._linesIndexBufferUseInstancing),this._linesIndexBufferUseInstancing=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._onDispose(t,i),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.clear(),this._scene){const e=this._scene.particleSystems.indexOf(this);e>-1&&this._scene.particleSystems.splice(e,1),this._scene._activeParticleSystems.dispose()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.reset()}}OT.ForceGLSL=!1,function(e){e[e.ATTACHED=0]="ATTACHED",e[e.END=1]="END"}(MT||(MT={}));class NT{constructor(e){if(this.particleSystem=e,this.type=1,this.inheritDirection=!1,this.inheritedVelocityAmount=0,!e.emitter||!e.emitter.dispose){const t=(0,a.n9)("BABYLON.AbstractMesh");e.emitter=new t("SubemitterSystemEmitter",e.getScene()),e._disposeEmitterOnDispose=!0}}clone(){let e=this.particleSystem.emitter;if(e){if(e instanceof n.Pq)e=e.clone();else if(-1!==e.getClassName().indexOf("Mesh")){e=new((0,a.n9)("BABYLON.Mesh"))("",e.getScene()),e.isVisible=!1}}else e=new n.Pq;const t=new NT(this.particleSystem.clone(this.particleSystem.name,e));return t.particleSystem.name+="Clone",t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem._disposeEmitterOnDispose=!0,t.particleSystem.disposeOnStop=!0,t}serialize(e=!1){const t={};return t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem=this.particleSystem.serialize(e),t}static _ParseParticleSystem(e,t,i,r=!1){throw(0,Ph.n)("ParseParticle")}static Parse(e,t,i){const r=e.particleSystem,s=new NT(NT._ParseParticleSystem(r,t,i,!0));return s.type=e.type,s.inheritDirection=e.inheritDirection,s.inheritedVelocityAmount=e.inheritedVelocityAmount,s.particleSystem._isSubEmitter=!0,s}dispose(){this.particleSystem.dispose()}}class wT{get mesh(){return this._mesh}set mesh(e){this._mesh!==e&&(this._mesh=e,e?(this._indices=e.getIndices(),this._positions=e.getVerticesData(Ot.R.PositionKind),this._normals=e.getVerticesData(Ot.R.NormalKind)):(this._indices=null,this._positions=null,this._normals=null))}constructor(e=null){this._indices=null,this._positions=null,this._normals=null,this._storedNormal=n.Pq.Zero(),this._mesh=null,this.direction1=new n.Pq(0,1,0),this.direction2=new n.Pq(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=e}startDirectionFunction(e,t,i,r){if(this.useMeshNormalsForDirection&&this._normals)return void n.Pq.TransformNormalToRef(this._storedNormal,e,t);const s=(0,yt.RandomRange)(this.direction1.x,this.direction2.x),o=(0,yt.RandomRange)(this.direction1.y,this.direction2.y),a=(0,yt.RandomRange)(this.direction1.z,this.direction2.z);r?t.copyFromFloats(s,o,a):n.Pq.TransformNormalFromFloatsToRef(s,o,a,e,t)}startPositionFunction(e,t,i,r){if(!this._indices||!this._positions)return;const s=3*Math.random()*(this._indices.length/3)|0,o=Math.random(),a=Math.random()*(1-o),l=1-o-a,h=this._indices[s],c=this._indices[s+1],u=this._indices[s+2],d=n.AA.Vector3[0],p=n.AA.Vector3[1],m=n.AA.Vector3[2],f=n.AA.Vector3[3];n.Pq.FromArrayToRef(this._positions,3*h,d),n.Pq.FromArrayToRef(this._positions,3*c,p),n.Pq.FromArrayToRef(this._positions,3*u,m),f.x=o*d.x+a*p.x+l*m.x,f.y=o*d.y+a*p.y+l*m.y,f.z=o*d.z+a*p.z+l*m.z,r?t.copyFromFloats(f.x,f.y,f.z):n.Pq.TransformCoordinatesFromFloatsToRef(f.x,f.y,f.z,e,t),this.useMeshNormalsForDirection&&this._normals&&(n.Pq.FromArrayToRef(this._normals,3*h,d),n.Pq.FromArrayToRef(this._normals,3*c,p),n.Pq.FromArrayToRef(this._normals,3*u,m),this._storedNormal.x=o*d.x+a*p.x+l*m.x,this._storedNormal.y=o*d.y+a*p.y+l*m.y,this._storedNormal.z=o*d.z+a*p.z+l*m.z)}clone(){const e=new wT(this.mesh);return E.r.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return""}getClassName(){return"MeshParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.meshId=this.mesh?.id,e.useMeshNormalsForDirection=this.useMeshNormalsForDirection,e}parse(e,t){n.Pq.FromArrayToRef(e.direction1,0,this.direction1),n.Pq.FromArrayToRef(e.direction2,0,this.direction2),e.meshId&&t&&(this.mesh=t.getLastMeshById(e.meshId)),this.useMeshNormalsForDirection=e.useMeshNormalsForDirection}}class FT{constructor(){this.particlePositionGenerator=()=>{},this.particleDestinationGenerator=()=>{}}startDirectionFunction(e,t,i,r){const s=n.AA.Vector3[0];if(this.particleDestinationGenerator){this.particleDestinationGenerator(-1,i,s);const e=n.AA.Vector3[1];s.subtractToRef(i.position,e),e.scaleToRef(1/i.lifeTime,s)}else s.set(0,0,0);r?t.copyFrom(s):n.Pq.TransformNormalToRef(s,e,t)}startPositionFunction(e,t,i,r){const s=n.AA.Vector3[0];this.particlePositionGenerator?this.particlePositionGenerator(-1,i,s):s.set(0,0,0),r?t.copyFrom(s):n.Pq.TransformCoordinatesToRef(s,e,t)}clone(){const e=new FT;return E.r.DeepCopy(this,e),e}applyToShader(e){}buildUniformLayout(e){}getEffectDefines(){return"#define CUSTOMEMITTER"}getClassName(){return"CustomParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.particlePositionGenerator=this.particlePositionGenerator,e.particleDestinationGenerator=this.particleDestinationGenerator,e}parse(e){e.particlePositionGenerator&&(this.particlePositionGenerator=e.particlePositionGenerator),e.particleDestinationGenerator&&(this.particleDestinationGenerator=e.particleDestinationGenerator)}}class BT{constructor(){this.direction1=new n.Pq(0,1,0),this.direction2=new n.Pq(0,1,0)}startDirectionFunction(e,t,i,r){const s=(0,yt.RandomRange)(this.direction1.x,this.direction2.x),o=(0,yt.RandomRange)(this.direction1.y,this.direction2.y),a=(0,yt.RandomRange)(this.direction1.z,this.direction2.z);r?t.copyFromFloats(s,o,a):n.Pq.TransformNormalFromFloatsToRef(s,o,a,e,t)}startPositionFunction(e,t,i,r){r?t.copyFromFloats(0,0,0):n.Pq.TransformCoordinatesFromFloatsToRef(0,0,0,e,t)}clone(){const e=new BT;return E.r.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define POINTEMITTER"}getClassName(){return"PointParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){n.Pq.FromArrayToRef(e.direction1,0,this.direction1),n.Pq.FromArrayToRef(e.direction2,0,this.direction2)}}class VT{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,r){const s=i.position.subtract(e.getTranslation()).normalize(),o=(0,yt.RandomRange)(0,this.directionRandomizer),a=(0,yt.RandomRange)(0,this.directionRandomizer),l=(0,yt.RandomRange)(0,this.directionRandomizer);s.x+=o,s.y+=a,s.z+=l,s.normalize(),r?t.copyFrom(s):n.Pq.TransformNormalFromFloatsToRef(s.x,s.y,s.z,e,t)}startPositionFunction(e,t,i,r){const s=this.radius-(0,yt.RandomRange)(0,this.radius*this.radiusRange),o=(0,yt.RandomRange)(0,1),a=(0,yt.RandomRange)(0,2*Math.PI),l=Math.acos(2*o-1),h=s*Math.cos(a)*Math.sin(l),c=s*Math.cos(l),u=s*Math.sin(a)*Math.sin(l);r?t.copyFromFloats(h,Math.abs(c),u):n.Pq.TransformCoordinatesFromFloatsToRef(h,Math.abs(c),u,e,t)}clone(){const e=new VT(this.radius,this.directionRandomizer);return E.r.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define HEMISPHERICEMITTER"}getClassName(){return"HemisphericParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class LT{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,r){const s=i.position.subtract(e.getTranslation()).normalize(),o=(0,yt.RandomRange)(0,this.directionRandomizer),a=(0,yt.RandomRange)(0,this.directionRandomizer),l=(0,yt.RandomRange)(0,this.directionRandomizer);s.x+=o,s.y+=a,s.z+=l,s.normalize(),r?t.copyFrom(s):n.Pq.TransformNormalFromFloatsToRef(s.x,s.y,s.z,e,t)}startPositionFunction(e,t,i,r){const s=this.radius-(0,yt.RandomRange)(0,this.radius*this.radiusRange),o=(0,yt.RandomRange)(0,1),a=(0,yt.RandomRange)(0,2*Math.PI),l=Math.acos(2*o-1),h=s*Math.cos(a)*Math.sin(l),c=s*Math.cos(l),u=s*Math.sin(a)*Math.sin(l);r?t.copyFromFloats(h,c,u):n.Pq.TransformCoordinatesFromFloatsToRef(h,c,u,e,t)}clone(){const e=new LT(this.radius,this.directionRandomizer);return E.r.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define SPHEREEMITTER"}getClassName(){return"SphereParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class kT extends LT{constructor(e=1,t=new n.Pq(0,1,0),i=new n.Pq(0,1,0)){super(e),this.direction1=t,this.direction2=i}startDirectionFunction(e,t){const i=(0,yt.RandomRange)(this.direction1.x,this.direction2.x),r=(0,yt.RandomRange)(this.direction1.y,this.direction2.y),s=(0,yt.RandomRange)(this.direction1.z,this.direction2.z);n.Pq.TransformNormalFromFloatsToRef(i,r,s,e,t)}clone(){const e=new kT(this.radius,this.direction1,this.direction2);return E.r.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define SPHEREEMITTER\n#define DIRECTEDSPHEREEMITTER"}getClassName(){return"SphereDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class GT{constructor(e=1,t=1,i=1,r=0){this.radius=e,this.height=t,this.radiusRange=i,this.directionRandomizer=r,this._tempVector=n.Pq.Zero()}startDirectionFunction(e,t,i,r,s){i.position.subtractToRef(e.getTranslation(),this._tempVector),this._tempVector.normalize(),n.Pq.TransformNormalToRef(this._tempVector,s,this._tempVector);const o=(0,yt.RandomRange)(-this.directionRandomizer/2,this.directionRandomizer/2);let a=Math.atan2(this._tempVector.x,this._tempVector.z);a+=(0,yt.RandomRange)(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=o,this._tempVector.x=Math.sin(a),this._tempVector.z=Math.cos(a),this._tempVector.normalize(),r?t.copyFrom(this._tempVector):n.Pq.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,e,t)}startPositionFunction(e,t,i,r){const s=(0,yt.RandomRange)(-this.height/2,this.height/2),o=(0,yt.RandomRange)(0,2*Math.PI),a=(0,yt.RandomRange)((1-this.radiusRange)*(1-this.radiusRange),1),l=Math.sqrt(a)*this.radius,h=l*Math.cos(o),c=l*Math.sin(o);r?t.copyFromFloats(h,s,c):n.Pq.TransformCoordinatesFromFloatsToRef(h,s,c,e,t)}clone(){const e=new GT(this.radius,this.directionRandomizer);return E.r.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define CYLINDEREMITTER"}getClassName(){return"CylinderParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.height=this.height,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.height=e.height,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class zT extends GT{constructor(e=1,t=1,i=1,r=new n.Pq(0,1,0),s=new n.Pq(0,1,0)){super(e,t,i),this.direction1=r,this.direction2=s}startDirectionFunction(e,t,i,r){const s=(0,yt.RandomRange)(this.direction1.x,this.direction2.x),o=(0,yt.RandomRange)(this.direction1.y,this.direction2.y),a=(0,yt.RandomRange)(this.direction1.z,this.direction2.z);r?t.copyFromFloats(s,o,a):n.Pq.TransformNormalFromFloatsToRef(s,o,a,e,t)}clone(){const e=new zT(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return E.r.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define CYLINDEREMITTER\n#define DIRECTEDCYLINDEREMITTER"}getClassName(){return"CylinderDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),n.Pq.FromArrayToRef(e.direction1,0,this.direction1),n.Pq.FromArrayToRef(e.direction2,0,this.direction2)}}class UT{get radius(){return this._radius}set radius(e){this._radius=e,this._buildHeight()}get angle(){return this._angle}set angle(e){this._angle=e,this._buildHeight()}_buildHeight(){0!==this._angle?this._height=this._radius/Math.tan(this._angle/2):this._height=1}constructor(e=1,t=Math.PI,i=0){this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=t,this.radius=e}startDirectionFunction(e,t,i,r){r?n.AA.Vector3[0].copyFrom(i._localPosition).normalize():i.position.subtractToRef(e.getTranslation(),n.AA.Vector3[0]).normalize();const s=(0,yt.RandomRange)(0,this.directionRandomizer),o=(0,yt.RandomRange)(0,this.directionRandomizer),a=(0,yt.RandomRange)(0,this.directionRandomizer);t.x=n.AA.Vector3[0].x+s,t.y=n.AA.Vector3[0].y+o,t.z=n.AA.Vector3[0].z+a,t.normalize()}startPositionFunction(e,t,i,r){const s=(0,yt.RandomRange)(0,2*Math.PI);let o;this.emitFromSpawnPointOnly?o=1e-4:(o=(0,yt.RandomRange)(0,this.heightRange),o=1-o*o);let a=this._radius-(0,yt.RandomRange)(0,this._radius*this.radiusRange);a*=o;const l=a*Math.sin(s),h=a*Math.cos(s),c=o*this._height;if(r)return t.x=l,t.y=c,void(t.z=h);n.Pq.TransformCoordinatesFromFloatsToRef(l,c,h,e,t)}clone(){const e=new UT(this._radius,this._angle,this.directionRandomizer);return E.r.DeepCopy(this,e),e}applyToShader(e){e.setFloat2("radius",this._radius,this.radiusRange),e.setFloat("coneAngle",this._angle),e.setFloat2("height",this._height,this.heightRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",2),e.addUniform("coneAngle",1),e.addUniform("height",2),e.addUniform("directionRandomizer",1)}getEffectDefines(){let e="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(e+="\n#define CONEEMITTERSPAWNPOINT"),e}getClassName(){return"ConeParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this._radius,e.angle=this._angle,e.directionRandomizer=this.directionRandomizer,e.radiusRange=this.radiusRange,e.heightRange=this.heightRange,e.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,e}parse(e){this.radius=e.radius,this.angle=e.angle,this.directionRandomizer=e.directionRandomizer,this.radiusRange=void 0!==e.radiusRange?e.radiusRange:1,this.heightRange=void 0!==e.radiusRange?e.heightRange:1,this.emitFromSpawnPointOnly=void 0!==e.emitFromSpawnPointOnly&&e.emitFromSpawnPointOnly}}class WT extends UT{constructor(e=1,t=Math.PI,i=new n.Pq(0,1,0),r=new n.Pq(0,1,0)){super(e,t),this.direction1=i,this.direction2=r}startDirectionFunction(e,t){const i=(0,yt.RandomRange)(this.direction1.x,this.direction2.x),r=(0,yt.RandomRange)(this.direction1.y,this.direction2.y),s=(0,yt.RandomRange)(this.direction1.z,this.direction2.z);n.Pq.TransformNormalFromFloatsToRef(i,r,s,e,t)}clone(){const e=new WT(this.radius,this.angle,this.direction1,this.direction2);return E.r.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define CONEEMITTER\n#define DIRECTEDCONEEMITTER"}getClassName(){return"ConeDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}function HT(e,t){const i=new BT;return i.direction1=e,i.direction2=t,i}function $T(e=1,t=1){return new VT(e,t)}function qT(e=1,t=1){return new LT(e,t)}function YT(e=1,t=new n.Pq(0,1,0),i=new n.Pq(0,1,0)){return new kT(e,t,i)}function XT(e=1,t=1,i=1,r=0){return new GT(e,t,i,r)}function jT(e=1,t=1,i=1,r=new n.Pq(0,1,0),s=new n.Pq(0,1,0)){return new zT(e,t,i,r,s)}function ZT(e=1,t=Math.PI/4){return new UT(e,t)}function QT(e=1,t=Math.PI/4,i=new n.Pq(0,1,0),r=new n.Pq(0,1,0)){return new WT(e,t,i,r)}class KT extends OT{constructor(){super(...arguments),this._disposeEmitterOnDispose=!1,this._emitFromParticle=e=>{if(!this._subEmitters||0===this._subEmitters.length)return;const t=Math.floor(Math.random()*this._subEmitters.length);this._subEmitters[t].forEach((t=>{if(1===t.type){const i=t.clone();e._inheritParticleInfoToSubEmitter(i),i.particleSystem._rootParticleSystem=this,this.activeSubSystems.push(i.particleSystem),i.particleSystem.start()}}))}}createPointEmitter(e,t){const i=HT(e,t);return this.particleEmitterType=i,i}createHemisphericEmitter(e=1,t=1){const i=$T(e,t);return this.particleEmitterType=i,i}createSphereEmitter(e=1,t=1){const i=qT(e,t);return this.particleEmitterType=i,i}createDirectedSphereEmitter(e=1,t=new n.Pq(0,1,0),i=new n.Pq(0,1,0)){const r=YT(e,t,i);return this.particleEmitterType=r,r}createCylinderEmitter(e=1,t=1,i=1,r=0){const s=XT(e,t,i,r);return this.particleEmitterType=s,s}createDirectedCylinderEmitter(e=1,t=1,i=1,r=new n.Pq(0,1,0),s=new n.Pq(0,1,0)){const o=jT(e,t,i,r,s);return this.particleEmitterType=o,o}createConeEmitter(e=1,t=Math.PI/4){const i=ZT(e,t);return this.particleEmitterType=i,i}createDirectedConeEmitter(e=1,t=Math.PI/4,i=new n.Pq(0,1,0),r=new n.Pq(0,1,0)){const s=QT(e,t,i,r);return this.particleEmitterType=s,s}createBoxEmitter(e,t,i,r){const s=new RT;return this.particleEmitterType=s,this.direction1=e,this.direction2=t,this.minEmitBox=i,this.maxEmitBox=r,s}_prepareSubEmitterInternalArray(){this._subEmitters=new Array,this.subEmitters&&this.subEmitters.forEach((e=>{e instanceof KT?this._subEmitters.push([new NT(e)]):e instanceof NT?this._subEmitters.push([e]):e instanceof Array&&this._subEmitters.push(e)}))}_stopSubEmitters(){this.activeSubSystems&&(this.activeSubSystems.forEach((e=>{e.stop(!0)})),this.activeSubSystems=[])}_removeFromRoot(){if(!this._rootParticleSystem)return;const e=this._rootParticleSystem.activeSubSystems.indexOf(this);-1!==e&&this._rootParticleSystem.activeSubSystems.splice(e,1),this._rootParticleSystem=null}_preStart(){this._prepareSubEmitterInternalArray(),this._subEmitters&&0!=this._subEmitters.length&&(this.activeSubSystems=[])}_postStop(e){e&&this._stopSubEmitters()}_prepareParticle(e){if(this._subEmitters&&this._subEmitters.length>0){const t=this._subEmitters[Math.floor(Math.random()*this._subEmitters.length)];e._attachedSubEmitters=[],t.forEach((t=>{if(0===t.type){const i=t.clone();e._attachedSubEmitters.push(i),i.particleSystem.start()}}))}}_onDispose(e=!1,t=!1){if(this._removeFromRoot(),this.subEmitters&&!this._subEmitters&&this._prepareSubEmitterInternalArray(),e&&this.particles?.forEach((e=>{if(e._attachedSubEmitters)for(let t=e._attachedSubEmitters.length-1;t>=0;t-=1)e._attachedSubEmitters[t].dispose()})),t&&this.activeSubSystems)for(let e=this.activeSubSystems.length-1;e>=0;e-=1)this.activeSubSystems[e].dispose();if(this._subEmitters&&this._subEmitters.length){for(let e=0;e<this._subEmitters.length;e++)for(const t of this._subEmitters[e])t.dispose();this._subEmitters=[],this.subEmitters=[]}this._disposeEmitterOnDispose&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0)}static _Parse(e,t,i,r){let s;s=i instanceof $.$?null:i;const l=(0,a.n9)("BABYLON.Texture");if(l&&s&&(e.texture?t.particleTexture=l.Parse(e.texture,s,r):e.textureName&&(t.particleTexture=new l(r+e.textureName,s,!1,void 0===e.invertY||e.invertY),t.particleTexture.name=e.textureName)),e.emitterId||0===e.emitterId||void 0!==e.emitter?e.emitterId&&s?t.emitter=s.getLastMeshById(e.emitterId):t.emitter=n.Pq.FromArray(e.emitter):t.emitter=n.Pq.Zero(),t.isLocal=!!e.isLocal,void 0!==e.renderingGroupId&&(t.renderingGroupId=e.renderingGroupId),void 0!==e.isBillboardBased&&(t.isBillboardBased=e.isBillboardBased),void 0!==e.billboardMode&&(t.billboardMode=e.billboardMode),void 0!==e.useLogarithmicDepth&&(t.useLogarithmicDepth=e.useLogarithmicDepth),e.animations){for(let i=0;i<e.animations.length;i++){const r=e.animations[i],s=(0,a.n9)("BABYLON.Animation");s&&t.animations.push(s.Parse(r))}t.beginAnimationOnStart=e.beginAnimationOnStart,t.beginAnimationFrom=e.beginAnimationFrom,t.beginAnimationTo=e.beginAnimationTo,t.beginAnimationLoop=e.beginAnimationLoop}if(e.autoAnimate&&s&&s.beginAnimation(t,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),t.startDelay=0|e.startDelay,t.minAngularSpeed=e.minAngularSpeed,t.maxAngularSpeed=e.maxAngularSpeed,t.minSize=e.minSize,t.maxSize=e.maxSize,e.minScaleX&&(t.minScaleX=e.minScaleX,t.maxScaleX=e.maxScaleX,t.minScaleY=e.minScaleY,t.maxScaleY=e.maxScaleY),void 0!==e.preWarmCycles&&(t.preWarmCycles=e.preWarmCycles,t.preWarmStepOffset=e.preWarmStepOffset),void 0!==e.minInitialRotation&&(t.minInitialRotation=e.minInitialRotation,t.maxInitialRotation=e.maxInitialRotation),t.minLifeTime=e.minLifeTime,t.maxLifeTime=e.maxLifeTime,t.minEmitPower=e.minEmitPower,t.maxEmitPower=e.maxEmitPower,t.emitRate=e.emitRate,t.gravity=n.Pq.FromArray(e.gravity),e.noiseStrength&&(t.noiseStrength=n.Pq.FromArray(e.noiseStrength)),t.color1=o.ov.FromArray(e.color1),t.color2=o.ov.FromArray(e.color2),t.colorDead=o.ov.FromArray(e.colorDead),t.updateSpeed=e.updateSpeed,t.targetStopDuration=e.targetStopDuration,t.blendMode=e.blendMode,e.colorGradients)for(const i of e.colorGradients)t.addColorGradient(i.gradient,o.ov.FromArray(i.color1),i.color2?o.ov.FromArray(i.color2):void 0);if(e.rampGradients){for(const i of e.rampGradients)t.addRampGradient(i.gradient,o.v9.FromArray(i.color));t.useRampGradients=e.useRampGradients}if(e.colorRemapGradients)for(const i of e.colorRemapGradients)t.addColorRemapGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.alphaRemapGradients)for(const i of e.alphaRemapGradients)t.addAlphaRemapGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.sizeGradients)for(const i of e.sizeGradients)t.addSizeGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.angularSpeedGradients)for(const i of e.angularSpeedGradients)t.addAngularSpeedGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.velocityGradients)for(const i of e.velocityGradients)t.addVelocityGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.dragGradients)for(const i of e.dragGradients)t.addDragGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.emitRateGradients)for(const i of e.emitRateGradients)t.addEmitRateGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.startSizeGradients)for(const i of e.startSizeGradients)t.addStartSizeGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.lifeTimeGradients)for(const i of e.lifeTimeGradients)t.addLifeTimeGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.limitVelocityGradients){for(const i of e.limitVelocityGradients)t.addLimitVelocityGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);t.limitVelocityDamping=e.limitVelocityDamping}if(e.noiseTexture&&s){const i=(0,a.n9)("BABYLON.ProceduralTexture");t.noiseTexture=i.Parse(e.noiseTexture,s,r)}let h;if(e.particleEmitterType){switch(e.particleEmitterType.type){case"SphereParticleEmitter":h=new LT;break;case"SphereDirectedParticleEmitter":h=new kT;break;case"ConeEmitter":case"ConeParticleEmitter":h=new UT;break;case"ConeDirectedParticleEmitter":h=new WT;break;case"CylinderParticleEmitter":h=new GT;break;case"CylinderDirectedParticleEmitter":h=new zT;break;case"HemisphericParticleEmitter":h=new VT;break;case"PointParticleEmitter":h=new BT;break;case"MeshParticleEmitter":h=new wT;break;case"CustomParticleEmitter":h=new FT;break;default:h=new RT}h.parse(e.particleEmitterType,s)}else h=new RT,h.parse(e,s);t.particleEmitterType=h,t.startSpriteCellID=e.startSpriteCellID,t.endSpriteCellID=e.endSpriteCellID,t.spriteCellLoop=e.spriteCellLoop??!0,t.spriteCellWidth=e.spriteCellWidth,t.spriteCellHeight=e.spriteCellHeight,t.spriteCellChangeSpeed=e.spriteCellChangeSpeed,t.spriteRandomStartCell=e.spriteRandomStartCell,t.disposeOnStop=e.disposeOnStop??!1,t.manualEmitCount=e.manualEmitCount??-1}static Parse(e,t,i,r=!1,s){const a=e.name;let l,h,c=null,u=null;if(t instanceof $.$?l=t:(h=t,l=h.getEngine()),e.customShader&&l.createEffectForParticles){u=e.customShader;const t=u.shaderOptions.defines.length>0?u.shaderOptions.defines.join("\n"):"";c=l.createEffectForParticles(u.shaderPath.fragmentElement,u.shaderOptions.uniforms,u.shaderOptions.samplers,t)}const d=new KT(a,s||e.capacity,t,c,e.isAnimationSheetEnabled);if(d.customShader=u,d._rootUrl=i,e.id&&(d.id=e.id),e.subEmitters){d.subEmitters=[];for(const r of e.subEmitters){const e=[];for(const s of r)e.push(NT.Parse(s,t,i));d.subEmitters.push(e)}}return KT._Parse(e,d,t,i),e.textureMask&&(d.textureMask=o.ov.FromArray(e.textureMask)),e.worldOffset&&(d.worldOffset=n.Pq.FromArray(e.worldOffset)),e.preventAutoStart&&(d.preventAutoStart=e.preventAutoStart),r||d.preventAutoStart||d.start(),d}serialize(e=!1){const t={};if(KT._Serialize(t,this,e),t.textureMask=this.textureMask.asArray(),t.customShader=this.customShader,t.preventAutoStart=this.preventAutoStart,t.worldOffset=this.worldOffset.asArray(),this.subEmitters){t.subEmitters=[],this._subEmitters||this._prepareSubEmitterInternalArray();for(const i of this._subEmitters){const r=[];for(const t of i)r.push(t.serialize(e));t.subEmitters.push(r)}}return t}static _Serialize(e,t,i){if(e.name=t.name,e.id=t.id,e.capacity=t.getCapacity(),e.disposeOnStop=t.disposeOnStop,e.manualEmitCount=t.manualEmitCount,t.emitter.position){const i=t.emitter;e.emitterId=i.id}else{const i=t.emitter;e.emitter=i.asArray()}t.particleEmitterType&&(e.particleEmitterType=t.particleEmitterType.serialize()),t.particleTexture&&(i?e.texture=t.particleTexture.serialize():(e.textureName=t.particleTexture.name,e.invertY=!!t.particleTexture._invertY)),e.isLocal=t.isLocal,Ue.p.AppendSerializedAnimations(t,e),e.beginAnimationOnStart=t.beginAnimationOnStart,e.beginAnimationFrom=t.beginAnimationFrom,e.beginAnimationTo=t.beginAnimationTo,e.beginAnimationLoop=t.beginAnimationLoop,e.startDelay=t.startDelay,e.renderingGroupId=t.renderingGroupId,e.isBillboardBased=t.isBillboardBased,e.billboardMode=t.billboardMode,e.minAngularSpeed=t.minAngularSpeed,e.maxAngularSpeed=t.maxAngularSpeed,e.minSize=t.minSize,e.maxSize=t.maxSize,e.minScaleX=t.minScaleX,e.maxScaleX=t.maxScaleX,e.minScaleY=t.minScaleY,e.maxScaleY=t.maxScaleY,e.minEmitPower=t.minEmitPower,e.maxEmitPower=t.maxEmitPower,e.minLifeTime=t.minLifeTime,e.maxLifeTime=t.maxLifeTime,e.emitRate=t.emitRate,e.gravity=t.gravity.asArray(),e.noiseStrength=t.noiseStrength.asArray(),e.color1=t.color1.asArray(),e.color2=t.color2.asArray(),e.colorDead=t.colorDead.asArray(),e.updateSpeed=t.updateSpeed,e.targetStopDuration=t.targetStopDuration,e.blendMode=t.blendMode,e.preWarmCycles=t.preWarmCycles,e.preWarmStepOffset=t.preWarmStepOffset,e.minInitialRotation=t.minInitialRotation,e.maxInitialRotation=t.maxInitialRotation,e.startSpriteCellID=t.startSpriteCellID,e.spriteCellLoop=t.spriteCellLoop,e.endSpriteCellID=t.endSpriteCellID,e.spriteCellChangeSpeed=t.spriteCellChangeSpeed,e.spriteCellWidth=t.spriteCellWidth,e.spriteCellHeight=t.spriteCellHeight,e.spriteRandomStartCell=t.spriteRandomStartCell,e.isAnimationSheetEnabled=t.isAnimationSheetEnabled,e.useLogarithmicDepth=t.useLogarithmicDepth;const r=t.getColorGradients();if(r){e.colorGradients=[];for(const t of r){const i={gradient:t.gradient,color1:t.color1.asArray()};t.color2?i.color2=t.color2.asArray():i.color2=t.color1.asArray(),e.colorGradients.push(i)}}const s=t.getRampGradients();if(s){e.rampGradients=[];for(const t of s){const i={gradient:t.gradient,color:t.color.asArray()};e.rampGradients.push(i)}e.useRampGradients=t.useRampGradients}const n=t.getColorRemapGradients();if(n){e.colorRemapGradients=[];for(const t of n){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.colorRemapGradients.push(i)}}const o=t.getAlphaRemapGradients();if(o){e.alphaRemapGradients=[];for(const t of o){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.alphaRemapGradients.push(i)}}const a=t.getSizeGradients();if(a){e.sizeGradients=[];for(const t of a){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.sizeGradients.push(i)}}const l=t.getAngularSpeedGradients();if(l){e.angularSpeedGradients=[];for(const t of l){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.angularSpeedGradients.push(i)}}const h=t.getVelocityGradients();if(h){e.velocityGradients=[];for(const t of h){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.velocityGradients.push(i)}}const c=t.getDragGradients();if(c){e.dragGradients=[];for(const t of c){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.dragGradients.push(i)}}const u=t.getEmitRateGradients();if(u){e.emitRateGradients=[];for(const t of u){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.emitRateGradients.push(i)}}const d=t.getStartSizeGradients();if(d){e.startSizeGradients=[];for(const t of d){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.startSizeGradients.push(i)}}const p=t.getLifeTimeGradients();if(p){e.lifeTimeGradients=[];for(const t of p){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.lifeTimeGradients.push(i)}}const m=t.getLimitVelocityGradients();if(m){e.limitVelocityGradients=[];for(const t of m){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.limitVelocityGradients.push(i)}e.limitVelocityDamping=t.limitVelocityDamping}t.noiseTexture&&(e.noiseTexture=t.noiseTexture.serialize())}clone(e,t,i=!1){const r={...this._customWrappers};let s=null;const n=this._engine;if(n.createEffectForParticles&&null!=this.customShader){s=this.customShader;const e=s.shaderOptions.defines.length>0?s.shaderOptions.defines.join("\n"):"",t=n.createEffectForParticles(s.shaderPath.fragmentElement,s.shaderOptions.uniforms,s.shaderOptions.samplers,e);r[0]?r[0].effect=t:this.setCustomEffect(t,0)}const o=this.serialize(i),a=KT.Parse(o,this._scene||this._engine,this._rootUrl);return a.name=e,a.customShader=s,a._customWrappers=r,void 0===t&&(t=this.emitter),this.noiseTexture&&(a.noiseTexture=this.noiseTexture.clone()),a.emitter=t,this.preventAutoStart||a.start(),a}}KT.BILLBOARDMODE_Y=2,KT.BILLBOARDMODE_ALL=7,KT.BILLBOARDMODE_STRETCHED=8,KT.BILLBOARDMODE_STRETCHED_LOCAL=9,NT._ParseParticleSystem=KT.Parse;class JT{constructor(){this._trackedScene=null}track(e){this._trackedScene=e,Ue.p.AllowLoadingUniqueId=!0,this._savedJSON=eT.Serialize(e),Ue.p.AllowLoadingUniqueId=!1}getDelta(){if(!this._trackedScene)return null;const e=$e.g.ForceSerializeBuffers;$e.g.ForceSerializeBuffers=!1,Ue.p.AllowLoadingUniqueId=!0;const t=eT.Serialize(this._trackedScene);Ue.p.AllowLoadingUniqueId=!1;const i={};for(const e in t)this._compareCollections(e,this._savedJSON[e],t[e],i);return $e.g.ForceSerializeBuffers=e,i}_compareArray(e,t,i,r){if(0===t.length&&0===i.length)return!0;if(t.length&&!isNaN(t[0])||i.length&&!isNaN(i[0])){if(t.length!==i.length)return!1;if(0===t.length)return!0;for(let s=0;s<t.length;s++)if(t[s]!==i[s])return r[e]=i,!1;return!0}const s=[];for(let n=0;n<t.length;n++){const o=t[n],a=o.uniqueId;s.push(a);const l=i.filter((e=>e.uniqueId===a));if(l.length){const t=l[0],i={};this._compareObjects(o,t,i)||(r[e]||(r[e]=[]),i.__state={id:t.id||t.name},r[e].push(i))}else{const t={__state:{deleteId:o.id||o.name}};r[e]||(r[e]=[]),r[e].push(t)}}for(let t=0;t<i.length;t++){const n=i[t],o=n.uniqueId;-1===s.indexOf(o)&&(r[e]||(r[e]=[]),r[e].push(n))}return!0}_compareObjects(e,t,i){let r=!1;for(const s in e){if(!Object.prototype.hasOwnProperty.call(e,s))continue;const n=e[s],o=t[s];let a=!1;if(Array.isArray(n))a=JSON.stringify(n)!==JSON.stringify(o);else if(isNaN(n)&&"[object String]"!=Object.prototype.toString.call(n)){if("object"==typeof n&&"object"==typeof o){const e={};this._compareObjects(n,o,e)||(i[s]=e,r=!0)}}else a=n!==o;a&&(r=!0,i[s]=o)}return!r}_compareCollections(e,t,i,r){if(t!==i&&t&&i)if(Array.isArray(t)&&Array.isArray(i)){if(this._compareArray(e,t,i,r))return}else if("object"==typeof t&&"object"==typeof i){const s={};return void(this._compareObjects(t,i,s)||(r[e]=s))}}static GetShadowGeneratorById(e,t){const i=e.lights.map((e=>e.getShadowGenerators()));for(const e of i)if(e){const i=e.values();for(let e=i.next();!0!==e.done;e=i.next()){const i=e.value;if(i&&i.id===t)return i}}return null}static ApplyDelta(e,t){"string"==typeof e&&(e=JSON.parse(e));const i=t;for(const r in e){const s=e[r],n=i[r];if(Array.isArray(n)||"shadowGenerators"===r)switch(r){case"cameras":this._ApplyDeltaForEntity(s,t,t.getCameraById.bind(t),(e=>ft.i.Parse(e,t)));break;case"lights":this._ApplyDeltaForEntity(s,t,t.getLightById.bind(t),(e=>Ns.v.Parse(e,t)));break;case"shadowGenerators":this._ApplyDeltaForEntity(s,t,(e=>this.GetShadowGeneratorById(t,e)),(e=>Ih.Parse(e,t)));break;case"meshes":this._ApplyDeltaForEntity(s,t,t.getMeshById.bind(t),(e=>tt.e.Parse(e,t,"")));break;case"skeletons":this._ApplyDeltaForEntity(s,t,t.getSkeletonById.bind(t),(e=>Ye.E.Parse(e,t)));break;case"materials":this._ApplyDeltaForEntity(s,t,t.getMaterialById.bind(t),(e=>fn.i.Parse(e,t,"")));break;case"multiMaterials":this._ApplyDeltaForEntity(s,t,t.getMaterialById.bind(t),(e=>gm.F.Parse(e,t,"")));break;case"transformNodes":this._ApplyDeltaForEntity(s,t,t.getTransformNodeById.bind(t),(e=>mt.V.Parse(e,t,"")));break;case"particleSystems":this._ApplyDeltaForEntity(s,t,t.getParticleSystemById.bind(t),(e=>KT.Parse(e,t,"")));break;case"morphTargetManagers":this._ApplyDeltaForEntity(s,t,t.getMorphTargetById.bind(t),(e=>vm.j.Parse(e,t)));break;case"postProcesses":this._ApplyDeltaForEntity(s,t,t.getPostProcessByName.bind(t),(e=>Fi.w.Parse(e,t,"")))}else isNaN(n)?n.fromArray&&n.fromArray(s):i[r]=s}}static _ApplyPropertiesToEntity(e,t){for(const i in e){const r=e[i],s=t[i];void 0!==s&&(!isNaN(s)||Array.isArray(s)?t[i]=r:s.fromArray?s.fromArray(r):"object"==typeof s&&null!==s&&this._ApplyPropertiesToEntity(r,s))}}static _ApplyDeltaForEntity(e,t,i,r){for(const s of e)if(s.__state&&void 0!==s.__state.id){const e=i(s.__state.id);e&&(this._ApplyPropertiesToEntity(s,e),Ue.p.ParseProperties(s,e,t,null))}else if(s.__state&&void 0!==s.__state.deleteId){const e=i(s.__state.deleteId);e?.dispose()}else r(s)}}var eC,tC=i(77502);!function(e){class t{serialize(){const e={},t=new Array(this._characterToIdx.size);return this._characterToIdx.forEach(((e,i)=>{t[e]=i})),e.characters=t,e.insertionCosts=this._insertionCosts,e.deletionCosts=this._deletionCosts,e.substitutionCosts=this._substitutionCosts,JSON.stringify(e)}static Deserialize(e){const i=JSON.parse(e),r=new t(i.characters);return r._insertionCosts=i.insertionCosts,r._deletionCosts=i.deletionCosts,r._substitutionCosts=i.substitutionCosts,r}constructor(e,t=null,i=null,r=null){let s;t=t??(()=>1),i=i??(()=>1),r=r??((e,t)=>e===t?0:1),this._characterToIdx=new Map,this._insertionCosts=new Array(e.length),this._deletionCosts=new Array(e.length),this._substitutionCosts=new Array(e.length);for(let n=0;n<e.length;++n){s=e[n],this._characterToIdx.set(s,n),this._insertionCosts[n]=t(s),this._deletionCosts[n]=i(s),this._substitutionCosts[n]=new Array(e.length);for(let t=n;t<e.length;++t)this._substitutionCosts[n][t]=r(s,e[t])}}getCharacterIdx(e){return this._characterToIdx.get(e)}getInsertionCost(e){return this._insertionCosts[e]}getDeletionCost(e){return this._deletionCosts[e]}getSubstitutionCost(e,t){const i=Math.min(e,t),r=Math.max(e,t);return this._substitutionCosts[i][r]}}e.Alphabet=t;class i{serialize(){return JSON.stringify(this._characters)}static Deserialize(e,t){const r=new i([],t);return r._characters=JSON.parse(e),r}constructor(e,t){if(e.length>i._MAX_SEQUENCE_LENGTH)throw new Error("Sequences longer than "+i._MAX_SEQUENCE_LENGTH+" not supported.");this._alphabet=t,this._characters=e.map((e=>this._alphabet.getCharacterIdx(e)))}distance(e){return i._Distance(this,e)}static _Distance(e,t){const r=e._alphabet;if(r!==t._alphabet)throw new Error("Cannot Levenshtein compare Sequences built from different alphabets.");const s=e._characters,n=t._characters,o=s.length,a=n.length,l=i._CostMatrix;l[0][0]=0;for(let e=0;e<o;++e)l[e+1][0]=l[e][0]+r.getInsertionCost(s[e]);for(let e=0;e<a;++e)l[0][e+1]=l[0][e]+r.getInsertionCost(n[e]);for(let e=0;e<o;++e)for(let t=0;t<a;++t)i._InsertionCost=l[e+1][t]+r.getInsertionCost(n[t]),i._DeletionCost=l[e][t+1]+r.getDeletionCost(s[e]),i._SubstitutionCost=l[e][t]+r.getSubstitutionCost(s[e],n[t]),l[e+1][t+1]=Math.min(i._InsertionCost,i._DeletionCost,i._SubstitutionCost);return l[o][a]}}i._MAX_SEQUENCE_LENGTH=256,i._CostMatrix=[...Array(i._MAX_SEQUENCE_LENGTH+1)].map((()=>new Array(i._MAX_SEQUENCE_LENGTH+1))),e.Sequence=i}(eC||(eC={}));class iC{serialize(){return JSON.stringify(this)}static Deserialize(e){const t=JSON.parse(e),i=new iC(t._segmentLength);return i._points=t._points.map((e=>new n.Pq(e._x,e._y,e._z))),i}constructor(e=.01){this._points=[],this._segmentLength=e}getLength(){return this._points.length*this._segmentLength}add(e){let t=this._points.length;if(0===t)this._points.push(e.clone());else{const i=()=>this._segmentLength/n.Pq.Distance(this._points[t-1],e);for(let r=i();r<=1;r=i()){const i=this._points[t-1].scale(1-r);e.scaleAndAddToRef(r,i),this._points.push(i),++t}}}resampleAtTargetResolution(e){const t=new iC(this.getLength()/e);return this._points.forEach((e=>{t.add(e)})),t}tokenize(e){const t=[],i=new n.Pq;for(let r=2;r<this._points.length;++r)iC._TransformSegmentDirToRef(this._points[r-2],this._points[r-1],this._points[r],i)&&t.push(iC._TokenizeSegment(i,e));return t}static _TransformSegmentDirToRef(e,t,i,r){return t.subtractToRef(e,iC._ForwardDir),iC._ForwardDir.normalize(),t.scaleToRef(-1,iC._InverseFromVec),iC._InverseFromVec.normalize(),!(Math.abs(n.Pq.Dot(iC._ForwardDir,iC._InverseFromVec))>.98)&&(n.Pq.CrossToRef(iC._ForwardDir,iC._InverseFromVec,iC._UpDir),iC._UpDir.normalize(),n.uq.LookAtLHToRef(e,t,iC._UpDir,iC._LookMatrix),i.subtractToRef(t,iC._FromToVec),iC._FromToVec.normalize(),n.Pq.TransformNormalToRef(iC._FromToVec,iC._LookMatrix,r),!0)}static _TokenizeSegment(e,t){iC._BestMatch=0,iC._Score=n.Pq.Dot(e,t[0]),iC._BestScore=iC._Score;for(let i=1;i<t.length;++i)iC._Score=n.Pq.Dot(e,t[i]),iC._Score>iC._BestScore&&(iC._BestMatch=i,iC._BestScore=iC._Score);return iC._BestMatch}}iC._ForwardDir=new n.Pq,iC._InverseFromVec=new n.Pq,iC._UpDir=new n.Pq,iC._FromToVec=new n.Pq,iC._LookMatrix=new n.uq;class rC{static Generate(e=64,t=256,i=.1,r=.001,s=[]){const o=new rC(e);for(let t=0;t<e;++t)o.chars[t]=new n.Pq(Math.random()-.5,Math.random()-.5,Math.random()-.5),o.chars[t].normalize();for(let e=0;e<s.length;++e)o.chars[e].copyFrom(s[e]);let a,l;const h=new n.Pq,c=new n.Pq;for(let e=0;e<t;++e){a=(1-(u=e/(t-1)))*i+u*r;for(let e=s.length;e<o.chars.length;++e)h.copyFromFloats(0,0,0),o.chars.forEach((t=>{o.chars[e].subtractToRef(t,c),l=c.lengthSquared(),l>1e-6&&c.scaleAndAddToRef(1/(c.lengthSquared()*l),h)})),h.scaleInPlace(a),o.chars[e].addInPlace(h),o.chars[e].normalize()}var u;return o}serialize(){return JSON.stringify(this.chars)}static Deserialize(e){const t=JSON.parse(e),i=new rC(t.length);for(let e=0;e<t.length;++e)i.chars[e]=new n.Pq(t[e]._x,t[e]._y,t[e]._z);return i}constructor(e){this.chars=new Array(e)}}class sC{serialize(){return JSON.stringify(this._sequences.map((e=>e.serialize())))}static Deserialize(e,t){const i=new sC;return i._sequences=JSON.parse(e).map((e=>eC.Sequence.Deserialize(e,t))),i}static CreateFromTrajectory(e,t,i){return sC.CreateFromTokenizationPyramid(sC._GetTokenizationPyramid(e,t),i)}static CreateFromTokenizationPyramid(e,t){const i=new sC;return i._sequences=e.map((e=>new eC.Sequence(e,t))),i}constructor(){this._sequences=[]}static _GetTokenizationPyramid(e,t,i=sC._FINEST_DESCRIPTOR_RESOLUTION){const r=[];for(let s=i;s>4;s=Math.floor(s/2))r.push(e.resampleAtTargetResolution(s).tokenize(t.chars));return r}distance(e){let t,i=0;for(let r=0;r<this._sequences.length;++r)t=Math.pow(2,r),i+=t*this._sequences[r].distance(e._sequences[r]);return i}}sC._FINEST_DESCRIPTOR_RESOLUTION=32;class nC{serialize(){const e={};return e.descriptors=this._descriptors.map((e=>e.serialize())),e.centroidIdx=this._centroidIdx,e.averageDistance=this._averageDistance,JSON.stringify(e)}static Deserialize(e,t){const i=JSON.parse(e),r=new nC;return r._descriptors=i.descriptors.map((e=>sC.Deserialize(e,t))),r._centroidIdx=i.centroidIdx,r._averageDistance=i.averageDistance,r}constructor(e=[]){this._descriptors=e,this._centroidIdx=-1,this._averageDistance=0,this._refreshDescription()}add(e){this._descriptors.push(e),this._refreshDescription()}getMatchCost(e){return e.distance(this._descriptors[this._centroidIdx])/this._averageDistance}getMatchMinimumDistance(e){return Math.min(...this._descriptors.map((t=>t.distance(e))))}_refreshDescription(){let e;this._centroidIdx=-1;const t=this._descriptors.map((t=>(e=0,this._descriptors.forEach((i=>{e+=t.distance(i)})),e)));for(let e=0;e<t.length;++e)(this._centroidIdx<0||t[e]<t[this._centroidIdx])&&(this._centroidIdx=e);this._averageDistance=0,this._descriptors.forEach((e=>{this._averageDistance+=e.distance(this._descriptors[this._centroidIdx])})),this._descriptors.length>0&&(this._averageDistance=Math.max(this._averageDistance/this._descriptors.length,nC._MIN_AVERAGE_DISTANCE))}}nC._MIN_AVERAGE_DISTANCE=1;class oC{serialize(){const e={};return e.maximumAllowableMatchCost=this._maximumAllowableMatchCost,e.vector3Alphabet=this._vector3Alphabet.serialize(),e.levenshteinAlphabet=this._levenshteinAlphabet.serialize(),e.nameToDescribedTrajectory=[],this._nameToDescribedTrajectory.forEach(((t,i)=>{e.nameToDescribedTrajectory.push(i),e.nameToDescribedTrajectory.push(t.serialize())})),JSON.stringify(e)}static Deserialize(e){const t=JSON.parse(e),i=new oC;i._maximumAllowableMatchCost=t.maximumAllowableMatchCost,i._vector3Alphabet=rC.Deserialize(t.vector3Alphabet),i._levenshteinAlphabet=eC.Alphabet.Deserialize(t.levenshteinAlphabet);for(let e=0;e<t.nameToDescribedTrajectory.length;e+=2)i._nameToDescribedTrajectory.set(t.nameToDescribedTrajectory[e],nC.Deserialize(t.nameToDescribedTrajectory[e+1],i._levenshteinAlphabet));return i}static Generate(){const e=rC.Generate(64,256,.1,.001,[n.Pq.Forward()]),t=new Array(e.chars.length);for(let e=0;e<t.length;++e)t[e]=e;const i=new eC.Alphabet(t,(e=>0===e?0:1),(e=>0===e?0:1),((t,i)=>Math.min(1-n.Pq.Dot(e.chars[t],e.chars[i]),1))),r=new oC;return r._vector3Alphabet=e,r._levenshteinAlphabet=i,r}constructor(){this._maximumAllowableMatchCost=4,this._nameToDescribedTrajectory=new Map}addTrajectoryToClassification(e,t){this._nameToDescribedTrajectory.has(t)||this._nameToDescribedTrajectory.set(t,new nC),this._nameToDescribedTrajectory.get(t).add(sC.CreateFromTrajectory(e,this._vector3Alphabet,this._levenshteinAlphabet))}deleteClassification(e){return this._nameToDescribedTrajectory.delete(e)}classifyTrajectory(e){const t=sC.CreateFromTrajectory(e,this._vector3Alphabet,this._levenshteinAlphabet),i=[];if(this._nameToDescribedTrajectory.forEach(((e,r)=>{e.getMatchCost(t)<this._maximumAllowableMatchCost&&i.push(r)})),0===i.length)return null;let r,s=0,n=this._nameToDescribedTrajectory.get(i[s]).getMatchMinimumDistance(t);for(let e=0;e<i.length;++e)r=this._nameToDescribedTrajectory.get(i[e]).getMatchMinimumDistance(t),r<n&&(n=r,s=e);return i[s]}}var aC=i(95625);class lC{constructor(e,t,i){this._scene=e,m.V.Log(`[Reflector] Connecting to ws://${t}:${i}`),this._webSocket=new WebSocket(`ws://${t}:${i}`),this._webSocket.onmessage=e=>{const t=e.data;if(t.startsWith(lC._SERVER_PREFIX)){const e=t.substring(lC._SERVER_PREFIX.length);return m.V.Log(`[Reflector] Received server message: ${e.substring(0,64)}`),void this._handleServerMessage(e)}m.V.Log(`[Reflector] Received client message: ${t.substring(0,64)}`),this._handleClientMessage()},this._webSocket.onclose=e=>{m.V.Log(`[Reflector] Disconnected ${e.code} ${e.reason}`)}}close(){this._webSocket.close()}_handleServerMessage(e){if("connected"===e)eT.SerializeAsync(this._scene).then((e=>{this._webSocket.send(`load|${JSON.stringify(e)}`)}))}_handleClientMessage(){}}lC._SERVER_PREFIX="$$";class hC{constructor(e){this._observer=null,this._currentState=[],this.onPressureChanged=new s.cP,hC.IsAvailable&&(this._observer=new PressureObserver((e=>{this._currentState=e,this.onPressureChanged.notifyObservers(e)}),e))}static get IsAvailable(){return"undefined"!=typeof PressureObserver&&PressureObserver.knownSources&&PressureObserver.knownSources.includes("cpu")}observe(e){try{this._observer?.observe(e),this.onPressureChanged.notifyObservers(this._currentState)}catch{}}unobserve(e){try{this._observer?.unobserve(e)}catch{}}dispose(){this._observer?.disconnect(),this._observer=null,this.onPressureChanged.clear()}}class cC{constructor(e){this._view=new Float32Array(e),this._itemLength=0}get itemLength(){return this._itemLength}at(e){return e<0||e>=this._itemLength?NaN:this._view[e]}subarray(e,t){return e>=t||e<0?new Float32Array(0):(t>this._itemLength&&(t=this._itemLength),this._view.subarray(e,t))}push(e){this._view[this._itemLength]=e,this._itemLength++,this._itemLength>=this._view.length&&this._growArray()}_growArray(){const e=Math.floor(1.5*this._view.length),t=new Float32Array(e);t.set(this._view),this._view=t}}const uC=1800,dC="timestamp",pC="numPoints",mC=/\r/g;class fC{static get SliceDataOffset(){return 2}static get NumberOfPointsOffset(){return 1}constructor(e,t){this._scene=e,this._collectDataAtFrame=()=>{const e=Md.j.Now-this._startingTimestamp,t=this.datasets.ids.length,i=this.datasets.startingIndices.itemLength;let r=0;if(i>0){const e=this.datasets.startingIndices.at(i-1);r=e+this.datasets.data.at(e+fC.NumberOfPointsOffset)+fC.SliceDataOffset}if(this.datasets.startingIndices.push(r),this.datasets.data.push(e),this.datasets.data.push(t),this.datasets.ids.forEach((e=>{const t=this._strategies.get(e);t&&this.datasets.data.push(t.getData())})),this.datasetObservable.hasObservers()){const i=[e,t];for(let e=0;e<t;e++)i.push(this.datasets.data.at(r+fC.SliceDataOffset+e));this.datasetObservable.notifyObservers(i)}},this.datasets={ids:[],data:new cC(uC),startingIndices:new cC(uC)},this._strategies=new Map,this._datasetMeta=new Map,this._eventRestoreSet=new Set,this._customEventObservable=new s.cP,this.datasetObservable=new s.cP,this.metadataObservable=new s.cP((e=>e.callback(this._datasetMeta,new s.qO(0)))),t&&this.addCollectionStrategies(...t)}registerEvent(e,t,i){if(this._strategies.has(e)&&!t)return;this._strategies.has(e)&&t&&(this._strategies.get(e)?.dispose(),this._strategies.delete(e));const r={name:e};return this._eventRestoreSet.add(e),this.addCollectionStrategies({strategyCallback:t=>{let i=0,r=0;const s=t.onAfterRenderObservable.add((()=>{r=i,i=0})),n=this._customEventObservable.add((t=>{e===t.name&&(void 0!==t.value?i=t.value:i++)}));return{id:e,getData:()=>r,dispose:()=>{t.onAfterRenderObservable.remove(s),this._customEventObservable.remove(n)}}},category:i}),r}sendEvent(e){this._customEventObservable.notifyObservers(e)}_restoreStringEvents(){this._eventRestoreSet.size!==this._customEventObservable.observers.length&&this._eventRestoreSet.forEach((e=>{this.registerEvent(e,!0)}))}addCollectionStrategies(...e){for(let{strategyCallback:t,category:i,hidden:r}of e){const e=t(this._scene);this._strategies.has(e.id)?e.dispose():(this.datasets.ids.push(e.id),i&&(i=i.replace(new RegExp("@","g"),"")),this._datasetMeta.set(e.id,{color:this._getHexColorFromId(e.id),category:i,hidden:r}),this._strategies.set(e.id,e))}this.metadataObservable.notifyObservers(this._datasetMeta)}_getHexColorFromId(e){let t=0;for(let i=0;i<e.length;i++)t=e.charCodeAt(i)+((t<<5)-t);let i="#";for(let e=0;e<24;e+=8){const r="0"+(t>>e&255).toString(16);i+=r.substring(r.length-2)}return i}getCurrentSlice(){const e=[Md.j.Now-this._startingTimestamp,this.datasets.ids.length];this.datasets.ids.forEach((t=>{const i=this._strategies.get(t);i&&this.datasetObservable.hasObservers()&&e.push(i.getData())})),this.datasetObservable.hasObservers()&&this.datasetObservable.notifyObservers(e)}updateMetadata(e,t,i){const r=this._datasetMeta.get(e);r&&(r[t]=i,this.metadataObservable.notifyObservers(this._datasetMeta))}clear(e){this.datasets.data=new cC(uC),this.datasets.ids.length=0,this.datasets.startingIndices=new cC(uC),this._datasetMeta.clear(),this._strategies.forEach((e=>e.dispose())),this._strategies.clear(),e||this._eventRestoreSet.clear(),this._hasLoadedData=!1}get hasLoadedData(){return this._hasLoadedData}loadFromFileData(e,t){const i=e.replace(mC,"").split("\n").map((e=>e.split(",").filter((e=>e.length>0)))).filter((e=>e.length>0)),r=fC.NumberOfPointsOffset;if(i.length<2)return!1;const s={ids:[],data:new cC(uC),startingIndices:new cC(uC)},[n,...o]=i;if(n.length<2||n[0]!==dC||n[r]!==pC)return!1;const a=new Map;for(let e=fC.SliceDataOffset;e<n.length;e++){const[t,i]=n[e].split("@");s.ids.push(t),a.set(t,i)}let l=0;for(const e of o){if(e.length<2)return!1;const t=parseFloat(e[0]),i=parseInt(e[r]);if(isNaN(i)||isNaN(t))return!1;if(s.data.push(t),s.data.push(i),i+fC.SliceDataOffset!==e.length)return!1;for(let t=fC.SliceDataOffset;t<e.length;t++){const i=parseFloat(e[t]);if(isNaN(i))return!1;s.data.push(i)}s.startingIndices.push(l),l+=e.length}if(this.datasets.ids=s.ids,this.datasets.data=s.data,this.datasets.startingIndices=s.startingIndices,t||this._datasetMeta.clear(),this._strategies.forEach((e=>e.dispose())),this._strategies.clear(),!t)for(const e of this.datasets.ids){const t=a.get(e);this._datasetMeta.set(e,{category:t,color:this._getHexColorFromId(e)})}return this.metadataObservable.notifyObservers(this._datasetMeta),this._hasLoadedData=!0,!0}exportDataToCsv(){let e="";e+=`${dC},${pC}`;for(let t=0;t<this.datasets.ids.length;t++)if(e+=`,${this.datasets.ids[t]}`,this._datasetMeta){const i=this._datasetMeta.get(this.datasets.ids[t]);i?.category&&(e+=`@${i.category}`)}e+="\n";for(let t=0;t<this.datasets.startingIndices.itemLength;t++){const i=this.datasets.startingIndices.at(t),r=this.datasets.data.at(i),s=this.datasets.data.at(i+fC.NumberOfPointsOffset);e+=`${r},${s}`;for(let t=0;t<s;t++)e+=`,${this.datasets.data.at(i+fC.SliceDataOffset+t)}`;for(let t=0;t<this.datasets.ids.length-s;t++)e+=",";e+="\n"}const t=`${(new Date).toISOString()}-perfdata.csv`;H.S0.Download(new Blob([e],{type:"text/csv"}),t)}start(e){e?void 0===this._startingTimestamp&&(this._startingTimestamp=Md.j.Now):(this.datasets.data=new cC(uC),this.datasets.startingIndices=new cC(uC),this._startingTimestamp=Md.j.Now),this._scene.onAfterRenderObservable.add(this._collectDataAtFrame),this._restoreStringEvents(),this._isStarted=!0}stop(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._isStarted=!1}get isStarted(){return this._isStarted}dispose(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._datasetMeta.clear(),this._strategies.forEach((e=>{e.dispose()})),this.datasetObservable.clear(),this.metadataObservable.clear(),this._isStarted=!1,this.datasets=null}}const _C=()=>{};class gC{static FpsStrategy(){return e=>{const t=e.getEngine();return{id:"FPS",getData:()=>t.getFps(),dispose:_C}}}static ThermalStrategy(){return this._PressureStrategy("Thermal utilization","thermal")}static PowerSupplyStrategy(){return this._PressureStrategy("Power supply utilization","power-supply")}static PressureStrategy(){return this._PressureStrategy("Pressure")}static _PressureStrategy(e,t=null){return()=>{let i=0;const r=new hC;return r.observe("cpu"),r.onPressureChanged.add((e=>{for(const r of e)if(t&&r.factors.includes(t)||!t&&0===(r.factors?.length??0))switch(r.state){case"nominal":i=0;break;case"fair":i=.25;break;case"serious":i=.5;break;case"critical":i=1}})),{id:e,getData:()=>i,dispose:()=>r.dispose()}}}static TotalMeshesStrategy(){return e=>({id:"Total meshes",getData:()=>e.meshes.length,dispose:_C})}static ActiveMeshesStrategy(){return e=>({id:"Active meshes",getData:()=>e.getActiveMeshes().length,dispose:_C})}static ActiveIndicesStrategy(){return e=>({id:"Active indices",getData:()=>e.getActiveIndices(),dispose:_C})}static ActiveFacesStrategy(){return e=>({id:"Active faces",getData:()=>e.getActiveIndices()/3,dispose:_C})}static ActiveBonesStrategy(){return e=>({id:"Active bones",getData:()=>e.getActiveBones(),dispose:_C})}static ActiveParticlesStrategy(){return e=>({id:"Active particles",getData:()=>e.getActiveParticles(),dispose:_C})}static DrawCallsStrategy(){return e=>{let t=0;const i=e.onBeforeAnimationsObservable.add((()=>{e.getEngine()._drawCalls.fetchNewFrame()})),r=e.onAfterRenderObservable.add((()=>{t=e.getEngine()._drawCalls.current}));return{id:"Draw calls",getData:()=>t,dispose:()=>{e.onBeforeAnimationsObservable.remove(i),e.onAfterRenderObservable.remove(r)}}}}static TotalLightsStrategy(){return e=>({id:"Total lights",getData:()=>e.lights.length,dispose:_C})}static TotalVerticesStrategy(){return e=>({id:"Total vertices",getData:()=>e.getTotalVertices(),dispose:_C})}static TotalMaterialsStrategy(){return e=>({id:"Total materials",getData:()=>e.materials.length,dispose:_C})}static TotalTexturesStrategy(){return e=>({id:"Total textures",getData:()=>e.textures.length,dispose:_C})}static AbsoluteFpsStrategy(){return e=>{const t=new Tp(e);return t.captureFrameTime=!0,{id:"Absolute FPS",getData:()=>1e3/t.frameTimeCounter.lastSecAverage,dispose:_C}}}static MeshesSelectionStrategy(){return e=>{let t=Md.j.Now,i=0;const r=e.onBeforeActiveMeshesEvaluationObservable.add((()=>{t=Md.j.Now})),s=e.onAfterActiveMeshesEvaluationObservable.add((()=>{i=Md.j.Now-t}));return{id:"Meshes Selection",getData:()=>i,dispose:()=>{e.onBeforeActiveMeshesEvaluationObservable.remove(r),e.onAfterActiveMeshesEvaluationObservable.remove(s)}}}}static RenderTargetsStrategy(){return e=>{let t=Md.j.Now,i=0;const r=e.onBeforeRenderTargetsRenderObservable.add((()=>{t=Md.j.Now})),s=e.onAfterRenderTargetsRenderObservable.add((()=>{i=Md.j.Now-t}));return{id:"Render Targets",getData:()=>i,dispose:()=>{e.onBeforeRenderTargetsRenderObservable.remove(r),e.onAfterRenderTargetsRenderObservable.remove(s)}}}}static ParticlesStrategy(){return e=>{let t=Md.j.Now,i=0;const r=e.onBeforeParticlesRenderingObservable.add((()=>{t=Md.j.Now})),s=e.onAfterParticlesRenderingObservable.add((()=>{i=Md.j.Now-t}));return{id:"Particles",getData:()=>i,dispose:()=>{e.onBeforeParticlesRenderingObservable.remove(r),e.onAfterParticlesRenderingObservable.remove(s)}}}}static SpritesStrategy(){return e=>{let t=Md.j.Now,i=0;const r=e.onBeforeSpritesRenderingObservable?.add((()=>{t=Md.j.Now})),s=e.onAfterSpritesRenderingObservable?.add((()=>{i=Md.j.Now-t}));return{id:"Sprites",getData:()=>i,dispose:()=>{e.onBeforeSpritesRenderingObservable?.remove(r),e.onAfterSpritesRenderingObservable?.remove(s)}}}}static AnimationsStrategy(){return e=>{let t=Md.j.Now,i=0;const r=e.onBeforeAnimationsObservable.add((()=>{t=Md.j.Now})),s=e.onAfterAnimationsObservable.add((()=>{i=Md.j.Now-t}));return{id:"Animations",getData:()=>i,dispose:()=>{e.onBeforeAnimationsObservable.remove(r),e.onAfterAnimationsObservable.remove(s)}}}}static PhysicsStrategy(){return e=>{let t=Md.j.Now,i=0;const r=e.onBeforePhysicsObservable?.add((()=>{t=Md.j.Now})),s=e.onAfterPhysicsObservable?.add((()=>{i=Md.j.Now-t}));return{id:"Physics",getData:()=>i,dispose:()=>{e.onBeforePhysicsObservable?.remove(r),e.onAfterPhysicsObservable?.remove(s)}}}}static RenderStrategy(){return e=>{let t=Md.j.Now,i=0;const r=e.onBeforeDrawPhaseObservable.add((()=>{t=Md.j.Now})),s=e.onAfterDrawPhaseObservable.add((()=>{i=Md.j.Now-t}));return{id:"Render",getData:()=>i,dispose:()=>{e.onBeforeDrawPhaseObservable.remove(r),e.onAfterDrawPhaseObservable.remove(s)}}}}static FrameTotalStrategy(){return e=>{let t=Md.j.Now,i=0;const r=e.onBeforeAnimationsObservable.add((()=>{t=Md.j.Now})),s=e.onAfterRenderObservable.add((()=>{i=Md.j.Now-t}));return{id:"Frame Total",getData:()=>i,dispose:()=>{e.onBeforeAnimationsObservable.remove(r),e.onAfterRenderObservable.remove(s)}}}}static InterFrameStrategy(){return e=>{let t=Md.j.Now,i=0;const r=e.onBeforeAnimationsObservable.add((()=>{i=Md.j.Now-t})),s=e.onAfterRenderObservable.add((()=>{t=Md.j.Now}));return{id:"Inter-frame",getData:()=>i,dispose:()=>{e.onBeforeAnimationsObservable.remove(r),e.onAfterRenderObservable.remove(s)}}}}static GpuFrameTimeStrategy(){return e=>{const t=new Pp(e.getEngine());return t.captureGPUFrameTime=!0,{id:"GPU frame time",getData:()=>Math.max(1e-6*t.gpuFrameTimeCounter.current,0),dispose:()=>{t.dispose()}}}}}it.Z.prototype.getPerfCollector=function(){return this._perfCollector||(this._perfCollector=new fC(this)),this._perfCollector};var xC=i(80163),vC=i(21797);s.cP.prototype.runCoroutineAsync=function(e){if(!this._coroutineScheduler){const e=function(e){const t=new Array,i=new Array,r=new Array,s=e.add((()=>{const e=t.length;for(let s=0;s<e;s++)(0,xC.FE)(t.shift(),i.shift(),r.shift())}));return{scheduler:(e,s,n)=>{t.push(e),i.push(s),r.push(n)},dispose:()=>{e.remove(s)}}}(this);this._coroutineScheduler=e.scheduler,this._coroutineSchedulerDispose=e.dispose}return(0,xC.kj)(e,this._coroutineScheduler)},s.cP.prototype.cancelAllCoroutines=function(){this._coroutineSchedulerDispose&&this._coroutineSchedulerDispose(),this._coroutineScheduler=void 0,this._coroutineSchedulerDispose=void 0};const SC="equirectangularPanoramaPixelShader",bC="#ifdef GL_ES\nprecision highp float;\n#endif\n#define M_PI 3.1415926535897932384626433832795\nvarying vec2 vUV;uniform samplerCube cubeMap;void main(void) {vec2 uv=vUV;float longitude=uv.x*2.*M_PI-M_PI+M_PI/2.;float latitude=(1.-uv.y)*M_PI;vec3 dir=vec3(\n- sin( longitude )*sin( latitude ),\ncos( latitude ),\n- cos( longitude )*sin( latitude )\n);normalize( dir );gl_FragColor=textureCube( cubeMap,dir );}";qi.l.ShadersStore[SC]=bC;async function yC(e,t){const i=t.probe??new Em("tempProbe",t.size,e),r=!!t.probe;r||(t.position?i.position=t.position.clone():e.activeCamera&&(i.position=e.activeCamera.position.clone()));const s=t.meshesFilter?e.meshes.filter(t.meshesFilter):e.meshes;i.renderList?.push(...s),i.refreshRate=cr.$.REFRESHRATE_RENDER_ONCE,i.cubeTexture.render();const n=new Gf("tempProceduralTexture","equirectangularPanorama",{width:2*t.size,height:t.size},e);return n.setTexture("cubeMap",i.cubeTexture),new Promise(((e,s)=>{n.onGeneratedObservable.addOnce((()=>{const o=n.readPixels();if(!o)return s(new Error("No Pixel Data found on procedural texture")),n.dispose(),void(r||i.dispose());o.then((s=>{n.dispose(),r||i.dispose(),t.filename?((0,cT.DumpData)(2*t.size,t.size,s,void 0,"image/png",t.filename),e(null)):e(s)}))}))}))}var PC=i(88394),TC=i(2001),CC=i(96789),EC=i(9682),AC=i(32646),IC=i(30371),RC=i(85035),MC=i(45963),DC=i(17770),OC=i(80706);class NC{constructor(e=Recast){this.bjsRECAST={},this.name="RecastJSPlugin",this._maximumSubStepCount=10,this._timeStep=1/60,this._timeFactor=1,this._worker=null,"function"==typeof e?m.V.Error("RecastJS is not ready. Please make sure you await Recast() before using the plugin."):this.bjsRECAST=e,this.isSupported()?(this.setTimeStep(),this._tempVec1=new this.bjsRECAST.Vec3,this._tempVec2=new this.bjsRECAST.Vec3):m.V.Error("RecastJS is not available. Please make sure you included the js file.")}setWorkerURL(e){return!(!window||!window.Worker)&&(this._worker=new Worker(e),!0)}setTimeStep(e=1/60){this._timeStep=e}getTimeStep(){return this._timeStep}setMaximumSubStepCount(e=10){this._maximumSubStepCount=e}getMaximumSubStepCount(){return this._maximumSubStepCount}set timeFactor(e){this._timeFactor=Math.max(e,0)}get timeFactor(){return this._timeFactor}createNavMesh(e,t,i){let r,s,n;this._worker&&!i?m.V.Warn("A worker is avaible but no completion callback. Defaulting to blocking navmesh creation"):!this._worker&&i&&m.V.Warn("A completion callback is avaible but no worker. Defaulting to blocking navmesh creation"),this.navMesh=new this.bjsRECAST.NavMesh;const o=[],a=[];let l=0;for(r=0;r<e.length;r++)if(e[r]){const t=e[r],i=t.getIndices();if(!i)continue;const h=t.getVerticesData(Ot.R.PositionKind,!1,!1);if(!h)continue;const c=[],u=t.computeWorldMatrix(!0);if(t.hasThinInstances){const e=t.thinInstanceGetWorldMatrices();for(let t=0;t<e.length;t++){const i=new ku.uq;e[t].multiplyToRef(u,i),c.push(i)}}else c.push(u);for(let e=0;e<c.length;e++){const t=c[e];for(s=0;s<i.length;s++)o.push(i[s]+l);const r=ku.Pq.Zero(),u=ku.Pq.Zero();for(n=0;n<h.length;n+=3)ku.Pq.FromArrayToRef(h,n,u),ku.Pq.TransformCoordinatesToRef(u,t,r),a.push(r.x,r.y,r.z);l+=h.length/3}}if(this._worker&&i)this._worker.postMessage([a,l,o,o.length,t]),this._worker.onmessage=function(e){i(e.data)};else{const e=new this.bjsRECAST.rcConfig;e.cs=t.cs,e.ch=t.ch,e.borderSize=t.borderSize?t.borderSize:0,e.tileSize=t.tileSize?t.tileSize:0,e.walkableSlopeAngle=t.walkableSlopeAngle,e.walkableHeight=t.walkableHeight,e.walkableClimb=t.walkableClimb,e.walkableRadius=t.walkableRadius,e.maxEdgeLen=t.maxEdgeLen,e.maxSimplificationError=t.maxSimplificationError,e.minRegionArea=t.minRegionArea,e.mergeRegionArea=t.mergeRegionArea,e.maxVertsPerPoly=t.maxVertsPerPoly,e.detailSampleDist=t.detailSampleDist,e.detailSampleMaxError=t.detailSampleMaxError,this.navMesh.build(a,l,o,o.length,e)}}createDebugNavMesh(e){let t,i;const r=this.navMesh.getDebugNavMesh(),s=r.getTriangleCount(),n=[],o=[];for(t=0;t<3*s;t++)n.push(t);for(t=0;t<s;t++)for(i=0;i<3;i++){const e=r.getTriangle(t).getPoint(i);o.push(e.x,e.y,e.z)}const a=new tt.e("NavMeshDebug",e),l=new ot.P;return l.indices=n,l.positions=o,l.applyToMesh(a,!1),a}getClosestPoint(e){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z;const t=this.navMesh.getClosestPoint(this._tempVec1);return new ku.Pq(t.x,t.y,t.z)}getClosestPointToRef(e,t){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z;const i=this.navMesh.getClosestPoint(this._tempVec1);t.set(i.x,i.y,i.z)}getRandomPointAround(e,t){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z;const i=this.navMesh.getRandomPointAround(this._tempVec1,t);return new ku.Pq(i.x,i.y,i.z)}getRandomPointAroundToRef(e,t,i){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z;const r=this.navMesh.getRandomPointAround(this._tempVec1,t);i.set(r.x,r.y,r.z)}moveAlong(e,t){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this._tempVec2.x=t.x,this._tempVec2.y=t.y,this._tempVec2.z=t.z;const i=this.navMesh.moveAlong(this._tempVec1,this._tempVec2);return new ku.Pq(i.x,i.y,i.z)}moveAlongToRef(e,t,i){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this._tempVec2.x=t.x,this._tempVec2.y=t.y,this._tempVec2.z=t.z;const r=this.navMesh.moveAlong(this._tempVec1,this._tempVec2);i.set(r.x,r.y,r.z)}_convertNavPathPoints(e){let t;const i=e.getPointCount(),r=[];for(t=0;t<i;t++){const i=e.getPoint(t);r.push(new ku.Pq(i.x,i.y,i.z))}return r}computePath(e,t){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this._tempVec2.x=t.x,this._tempVec2.y=t.y,this._tempVec2.z=t.z;const i=this.navMesh.computePath(this._tempVec1,this._tempVec2);return this._convertNavPathPoints(i)}computePathSmooth(e,t){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this._tempVec2.x=t.x,this._tempVec2.y=t.y,this._tempVec2.z=t.z;const i=this.navMesh.computePathSmooth(this._tempVec1,this._tempVec2);return this._convertNavPathPoints(i)}createCrowd(e,t,i){return new wC(this,e,t,i)}setDefaultQueryExtent(e){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this.navMesh.setDefaultQueryExtent(this._tempVec1)}getDefaultQueryExtent(){const e=this.navMesh.getDefaultQueryExtent();return new ku.Pq(e.x,e.y,e.z)}buildFromNavmeshData(e){const t=e.length*e.BYTES_PER_ELEMENT,i=this.bjsRECAST._malloc(t),r=new Uint8Array(this.bjsRECAST.HEAPU8.buffer,i,t);r.set(e);const s=new this.bjsRECAST.NavmeshData;s.dataPointer=r.byteOffset,s.size=e.length,this.navMesh=new this.bjsRECAST.NavMesh,this.navMesh.buildFromNavmeshData(s),this.bjsRECAST._free(r.byteOffset)}getNavmeshData(){const e=this.navMesh.getNavmeshData(),t=new Uint8Array(this.bjsRECAST.HEAPU8.buffer,e.dataPointer,e.size),i=new Uint8Array(e.size);return i.set(t),this.navMesh.freeNavmeshData(e),i}getDefaultQueryExtentToRef(e){const t=this.navMesh.getDefaultQueryExtent();e.set(t.x,t.y,t.z)}dispose(){}addCylinderObstacle(e,t,i){return this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this.navMesh.addCylinderObstacle(this._tempVec1,t,i)}addBoxObstacle(e,t,i){return this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this._tempVec2.x=t.x,this._tempVec2.y=t.y,this._tempVec2.z=t.z,this.navMesh.addBoxObstacle(this._tempVec1,this._tempVec2,i)}removeObstacle(e){this.navMesh.removeObstacle(e)}isSupported(){return void 0!==this.bjsRECAST}getRandomSeed(){return this.bjsRECAST._getRandomSeed()}setRandomSeed(e){this.bjsRECAST._setRandomSeed(e)}}class wC{constructor(e,t,i,r){this.recastCrowd={},this.transforms=new Array,this.agents=new Array,this.reachRadii=new Array,this._agentDestinationArmed=new Array,this._agentDestination=new Array,this._onBeforeAnimationsObserver=null,this.onReachTargetObservable=new s.cP,this.bjsRECASTPlugin=e,this.recastCrowd=new this.bjsRECASTPlugin.bjsRECAST.Crowd(t,i,this.bjsRECASTPlugin.navMesh.getNavMesh()),this._scene=r,this._onBeforeAnimationsObserver=r.onBeforeAnimationsObservable.add((()=>{this.update(.001*r.getEngine().getDeltaTime()*e.timeFactor)}))}addAgent(e,t,i){const r=new this.bjsRECASTPlugin.bjsRECAST.dtCrowdAgentParams;r.radius=t.radius,r.height=t.height,r.maxAcceleration=t.maxAcceleration,r.maxSpeed=t.maxSpeed,r.collisionQueryRange=t.collisionQueryRange,r.pathOptimizationRange=t.pathOptimizationRange,r.separationWeight=t.separationWeight,r.updateFlags=7,r.obstacleAvoidanceType=0,r.queryFilterType=0,r.userData=0;const s=this.recastCrowd.addAgent(new this.bjsRECASTPlugin.bjsRECAST.Vec3(e.x,e.y,e.z),r);return this.transforms.push(i),this.agents.push(s),this.reachRadii.push(t.reachRadius?t.reachRadius:t.radius),this._agentDestinationArmed.push(!1),this._agentDestination.push(new ku.Pq(0,0,0)),s}getAgentPosition(e){const t=this.recastCrowd.getAgentPosition(e);return new ku.Pq(t.x,t.y,t.z)}getAgentPositionToRef(e,t){const i=this.recastCrowd.getAgentPosition(e);t.set(i.x,i.y,i.z)}getAgentVelocity(e){const t=this.recastCrowd.getAgentVelocity(e);return new ku.Pq(t.x,t.y,t.z)}getAgentVelocityToRef(e,t){const i=this.recastCrowd.getAgentVelocity(e);t.set(i.x,i.y,i.z)}getAgentNextTargetPath(e){const t=this.recastCrowd.getAgentNextTargetPath(e);return new ku.Pq(t.x,t.y,t.z)}getAgentNextTargetPathToRef(e,t){const i=this.recastCrowd.getAgentNextTargetPath(e);t.set(i.x,i.y,i.z)}getAgentState(e){return this.recastCrowd.getAgentState(e)}overOffmeshConnection(e){return this.recastCrowd.overOffmeshConnection(e)}agentGoto(e,t){this.recastCrowd.agentGoto(e,new this.bjsRECASTPlugin.bjsRECAST.Vec3(t.x,t.y,t.z));const i=this.agents.indexOf(e);i>-1&&(this._agentDestinationArmed[i]=!0,this._agentDestination[i].set(t.x,t.y,t.z))}agentTeleport(e,t){this.recastCrowd.agentTeleport(e,new this.bjsRECASTPlugin.bjsRECAST.Vec3(t.x,t.y,t.z))}updateAgentParameters(e,t){const i=this.recastCrowd.getAgentParameters(e);void 0!==t.radius&&(i.radius=t.radius),void 0!==t.height&&(i.height=t.height),void 0!==t.maxAcceleration&&(i.maxAcceleration=t.maxAcceleration),void 0!==t.maxSpeed&&(i.maxSpeed=t.maxSpeed),void 0!==t.collisionQueryRange&&(i.collisionQueryRange=t.collisionQueryRange),void 0!==t.pathOptimizationRange&&(i.pathOptimizationRange=t.pathOptimizationRange),void 0!==t.separationWeight&&(i.separationWeight=t.separationWeight),this.recastCrowd.setAgentParameters(e,i)}removeAgent(e){this.recastCrowd.removeAgent(e);const t=this.agents.indexOf(e);t>-1&&(this.agents.splice(t,1),this.transforms.splice(t,1),this.reachRadii.splice(t,1),this._agentDestinationArmed.splice(t,1),this._agentDestination.splice(t,1))}getAgents(){return this.agents}update(e){if(this.bjsRECASTPlugin.navMesh.update(),e<=ku.bH)return;const t=this.bjsRECASTPlugin.getTimeStep(),i=this.bjsRECASTPlugin.getMaximumSubStepCount();if(t<=ku.bH)this.recastCrowd.update(e);else{let r=Math.floor(e/t);i&&r>i&&(r=i),r<1&&(r=1);const s=e/r;for(let e=0;e<r;e++)this.recastCrowd.update(s)}for(let e=0;e<this.agents.length;e++){const t=this.agents[e],i=this.getAgentPosition(t);if(this.transforms[e].position=i,this._agentDestinationArmed[e]){const r=i.x-this._agentDestination[e].x,s=i.z-this._agentDestination[e].z,n=this.reachRadii[e],o=this._agentDestination[e].y-this.reachRadii[e],a=this._agentDestination[e].y+this.reachRadii[e],l=r*r+s*s;i.y>o&&i.y<a&&l<n*n&&(this._agentDestinationArmed[e]=!1,this.onReachTargetObservable.notifyObservers({agentIndex:t,destination:this._agentDestination[e]}))}}}setDefaultQueryExtent(e){const t=new this.bjsRECASTPlugin.bjsRECAST.Vec3(e.x,e.y,e.z);this.recastCrowd.setDefaultQueryExtent(t)}getDefaultQueryExtent(){const e=this.recastCrowd.getDefaultQueryExtent();return new ku.Pq(e.x,e.y,e.z)}getDefaultQueryExtentToRef(e){const t=this.recastCrowd.getDefaultQueryExtent();e.set(t.x,t.y,t.z)}getCorners(e){let t;const i=this.recastCrowd.getCorners(e),r=i.getPointCount(),s=[];for(t=0;t<r;t++){const e=i.getPoint(t);s.push(new ku.Pq(e.x,e.y,e.z))}return s}dispose(){this.recastCrowd.destroy(),this._scene.onBeforeAnimationsObservable.remove(this._onBeforeAnimationsObserver),this._onBeforeAnimationsObserver=null,this.onReachTargetObservable.clear()}}$.$.OfflineProviderFactory=(e,t,i=!1)=>new FC(e,t,i);class FC{get enableSceneOffline(){return this._enableSceneOffline}get enableTexturesOffline(){return this._enableTexturesOffline}constructor(e,t,i=!1){this._idbFactory="undefined"!=typeof indexedDB?indexedDB:void 0,this._currentSceneUrl=FC._ReturnFullUrlLocation(e),this._db=null,this._enableSceneOffline=!1,this._enableTexturesOffline=!1,this._manifestVersionFound=0,this._mustUpdateRessources=!1,this._hasReachedQuota=!1,FC.IDBStorageEnabled?i?(this._enableSceneOffline=!0,this._enableTexturesOffline=!0,this._manifestVersionFound=1,H.S0.SetImmediate((()=>{t(!0)}))):this._checkManifestFile(t):t(!0)}_checkManifestFile(e){const t=()=>{this._enableSceneOffline=!1,this._enableTexturesOffline=!1,e(!1)},i=()=>{try{if("function"==typeof URL&&0===this._currentSceneUrl.indexOf("http")){const e=new URL(this._currentSceneUrl);return e.pathname+=".manifest",e.toString()}}catch(e){}return`${this._currentSceneUrl}.manifest`};let r=!1,s=i();const n=new Kr.u;navigator.onLine&&(r=!0,s=s+(null==s.match(/\?/)?"?":"&")+Date.now()),n.open("GET",s),n.addEventListener("load",(()=>{if(200===n.status||FC._ValidateXHRData(n,1))try{const t=JSON.parse(n.response);this._enableSceneOffline=t.enableSceneOffline,this._enableTexturesOffline=t.enableTexturesOffline&&FC._IsUASupportingBlobStorage,t.version&&!isNaN(parseInt(t.version))&&(this._manifestVersionFound=t.version),e(!0)}catch(e){t()}else t()}),!1),n.addEventListener("error",(()=>{if(r){r=!1;const e=i();n.open("GET",e),n.send()}else t()}),!1);try{n.send()}catch(t){m.V.Error("Error on XHR send request."),e(!1)}}open(e,t){const i=()=>{this._isSupported=!1,t&&t()};if(this._idbFactory&&(this._enableSceneOffline||this._enableTexturesOffline))if(this._db)e&&e();else{this._hasReachedQuota=!1,this._isSupported=!0;const t=this._idbFactory.open("babylonjs",1);t.onerror=()=>{i()},t.onblocked=()=>{m.V.Error("IDB request blocked. Please reload the page."),i()},t.onsuccess=()=>{this._db=t.result,e()},t.onupgradeneeded=e=>{if(this._db=e.target.result,this._db)try{this._db.createObjectStore("scenes",{keyPath:"sceneUrl"}),this._db.createObjectStore("versions",{keyPath:"sceneUrl"}),this._db.createObjectStore("textures",{keyPath:"textureUrl"})}catch(e){m.V.Error("Error while creating object stores. Exception: "+e.message),i()}}}else this._isSupported=!1,t&&t()}loadImage(e,t){const i=FC._ReturnFullUrlLocation(e),r=()=>{this._hasReachedQuota||null===this._db?t.src=e:this._saveImageIntoDBAsync(i,t)};this._mustUpdateRessources?r():this._loadImageFromDBAsync(i,t,r)}_loadImageFromDBAsync(e,t,i){if(this._isSupported&&null!==this._db){let r;const s=this._db.transaction(["textures"]);s.onabort=()=>{t.src=e},s.oncomplete=()=>{let s;r&&"function"==typeof URL?(s=URL.createObjectURL(r.data),t.onerror=()=>{m.V.Error("Error loading image from blob URL: "+s+" switching back to web url: "+e),t.src=e},t.src=s):i()};const n=s.objectStore("textures").get(e);n.onsuccess=e=>{r=e.target.result},n.onerror=()=>{m.V.Error("Error loading texture "+e+" from DB."),t.src=e}}else m.V.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t.src=e}_saveImageIntoDBAsync(e,t){let i;if(this._isSupported){const r=()=>{let e;if(i&&"function"==typeof URL)try{e=URL.createObjectURL(i)}catch(t){e=URL.createObjectURL(i)}e&&(t.src=e)};if(FC._IsUASupportingBlobStorage){const s=new Kr.u;s.open("GET",e),s.responseType="blob",s.addEventListener("load",(()=>{if(200===s.status&&this._db){i=s.response;const n=this._db.transaction(["textures"],"readwrite");n.onabort=e=>{try{const t=e.target.error;t&&"QuotaExceededError"===t.name&&(this._hasReachedQuota=!0)}catch(e){}r()},n.oncomplete=()=>{r()};const o={textureUrl:e,data:i};try{const e=n.objectStore("textures").put(o);e.onsuccess=()=>{},e.onerror=()=>{r()}}catch(i){25===i.code&&(FC._IsUASupportingBlobStorage=!1,this._enableTexturesOffline=!1),t.src=e}}else t.src=e}),!1),s.addEventListener("error",(()=>{m.V.Error("Error in XHR request in BABYLON.Database."),t.src=e}),!1),s.send()}else t.src=e}else m.V.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),t.src=e}_checkVersionFromDB(e,t){this._loadVersionFromDBAsync(e,t,(()=>{this._saveVersionIntoDBAsync(e,t)}))}_loadVersionFromDBAsync(e,t,i){if(this._isSupported&&this._db){let r;try{const s=this._db.transaction(["versions"]);s.oncomplete=()=>{r?this._manifestVersionFound!==r.data?(this._mustUpdateRessources=!0,i()):t(r.data):(this._mustUpdateRessources=!0,i())},s.onabort=()=>{t(-1)};const n=s.objectStore("versions").get(e);n.onsuccess=e=>{r=e.target.result},n.onerror=()=>{m.V.Error("Error loading version for scene "+e+" from DB."),t(-1)}}catch(e){m.V.Error("Error while accessing 'versions' object store (READ OP). Exception: "+e.message),t(-1)}}else m.V.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),t(-1)}_saveVersionIntoDBAsync(e,t){if(this._isSupported&&!this._hasReachedQuota&&this._db)try{const i=this._db.transaction(["versions"],"readwrite");i.onabort=e=>{try{const t=e.target.error;t&&"QuotaExceededError"===t.name&&(this._hasReachedQuota=!0)}catch(e){}t(-1)},i.oncomplete=()=>{t(this._manifestVersionFound)};const r={sceneUrl:e,data:this._manifestVersionFound},s=i.objectStore("versions").put(r);s.onsuccess=()=>{},s.onerror=()=>{m.V.Error("Error in DB add version request in BABYLON.Database.")}}catch(e){m.V.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+e.message),t(-1)}else t(-1)}loadFile(e,t,i,r,s){const n=FC._ReturnFullUrlLocation(e),o=()=>{this._saveFileAsync(n,t,i,s,r)};this._checkVersionFromDB(n,(e=>{-1!==e?this._mustUpdateRessources?this._saveFileAsync(n,t,i,s,r):this._loadFileAsync(n,t,o,i):r&&r()}))}_loadFileAsync(e,t,i,r){if(this._isSupported&&this._db){let s,n;s=-1!==e.indexOf(".babylon")?"scenes":"textures";const o=this._db.transaction([s]);o.oncomplete=()=>{if(n){if(r){const e=n.data?.byteLength||0;r({total:e,loaded:e,lengthComputable:!0})}t(n.data)}else i()},o.onabort=()=>{i()};const a=o.objectStore(s).get(e);a.onsuccess=e=>{n=e.target.result},a.onerror=()=>{m.V.Error("Error loading file "+e+" from DB."),i()}}else m.V.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t()}_saveFileAsync(e,t,i,r,s){if(this._isSupported){let n;n=-1!==e.indexOf(".babylon")?"scenes":"textures";const o=new Kr.u;let a;o.open("GET",e+(null==e.match(/\?/)?"?":"&")+Date.now()),r&&(o.responseType="arraybuffer"),i&&(o.onprogress=i),o.addEventListener("load",(()=>{if(200===o.status||o.status<400&&FC._ValidateXHRData(o,r?6:1))if(a=r?o.response:o.responseText,!this._hasReachedQuota&&this._db){const i=this._db.transaction([n],"readwrite");let r;i.onabort=e=>{try{const t=e.target.error;t&&"QuotaExceededError"===t.name&&(this._hasReachedQuota=!0)}catch(e){}t(a)},i.oncomplete=()=>{t(a)},r="scenes"===n?{sceneUrl:e,data:a,version:this._manifestVersionFound}:{textureUrl:e,data:a};try{const e=i.objectStore(n).put(r);e.onsuccess=()=>{},e.onerror=()=>{m.V.Error("Error in DB add file request in BABYLON.Database.")}}catch(e){t(a)}}else t(a);else o.status>=400&&s?s(o):t()}),!1),o.addEventListener("error",(()=>{m.V.Error("error on XHR request."),s&&s()}),!1),o.send()}else m.V.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),s&&s()}static _ValidateXHRData(e,t=7){try{if(1&t){if(e.responseText&&e.responseText.length>0)return!0;if(1===t)return!1}if(2&t){const i=(0,oT.O_)(e.response);if(i.width&&i.height&&i.width>0&&i.height>0)return!0;if(2===t)return!1}if(4&t){const t=new Uint8Array(e.response,0,3);return 68===t[0]&&68===t[1]&&83===t[2]}}catch(e){}return!1}}FC._IsUASupportingBlobStorage=!0,FC.IDBStorageEnabled=!1,FC._ParseURL=e=>{document.createElement("a").href=e;const t=e.substring(0,e.lastIndexOf("#")),i=e.substring(t.lastIndexOf("/")+1,e.length);return e.substring(0,e.indexOf(i,0))},FC._ReturnFullUrlLocation=e=>-1===e.indexOf("http:/")&&-1===e.indexOf("https:/")&&"undefined"!=typeof window?FC._ParseURL(window.location.href)+e:e;class BC{_isUbo(e){return void 0!==e.addUniform}constructor(e){this._isUbo(e)?(this.setMatrix3x3=e.updateMatrix3x3.bind(e),this.setMatrix2x2=e.updateMatrix2x2.bind(e),this.setFloat=e.updateFloat.bind(e),this.setFloat2=e.updateFloat2.bind(e),this.setFloat3=e.updateFloat3.bind(e),this.setFloat4=e.updateFloat4.bind(e),this.setFloatArray=e.updateFloatArray.bind(e),this.setArray=e.updateArray.bind(e),this.setIntArray=e.updateIntArray.bind(e),this.setMatrix=e.updateMatrix.bind(e),this.setMatrices=e.updateMatrices.bind(e),this.setVector3=e.updateVector3.bind(e),this.setVector4=e.updateVector4.bind(e),this.setColor3=e.updateColor3.bind(e),this.setColor4=e.updateColor4.bind(e),this.setDirectColor4=e.updateDirectColor4.bind(e),this.setInt=e.updateInt.bind(e),this.setInt2=e.updateInt2.bind(e),this.setInt3=e.updateInt3.bind(e),this.setInt4=e.updateInt4.bind(e)):(this.setMatrix3x3=e.setMatrix3x3.bind(e),this.setMatrix2x2=e.setMatrix2x2.bind(e),this.setFloat=e.setFloat.bind(e),this.setFloat2=e.setFloat2.bind(e),this.setFloat3=e.setFloat3.bind(e),this.setFloat4=e.setFloat4.bind(e),this.setFloatArray=e.setFloatArray.bind(e),this.setArray=e.setArray.bind(e),this.setIntArray=e.setIntArray.bind(e),this.setMatrix=e.setMatrix.bind(e),this.setMatrices=e.setMatrices.bind(e),this.setVector3=e.setVector3.bind(e),this.setVector4=e.setVector4.bind(e),this.setColor3=e.setColor3.bind(e),this.setColor4=e.setColor4.bind(e),this.setDirectColor4=e.setDirectColor4.bind(e),this.setInt=e.setInt.bind(e),this.setInt2=e.setInt2.bind(e),this.setInt3=e.setInt3.bind(e),this.setInt4=e.setInt4.bind(e))}}const VC="gpuUpdateParticlesPixelShader",LC="#version 300 es\nvoid main() {discard;}\n";qi.l.ShadersStore[VC]=LC;const kC="gpuUpdateParticlesVertexShader",GC="#version 300 es\n#define PI 3.14159\nuniform float currentCount;uniform float timeDelta;uniform float stopFactor;\n#ifndef LOCAL\nuniform mat4 emitterWM;\n#endif\nuniform vec2 lifeTime;uniform vec2 emitPower;uniform vec2 sizeRange;uniform vec4 scaleRange;\n#ifndef COLORGRADIENTS\nuniform vec4 color1;uniform vec4 color2;\n#endif\nuniform vec3 gravity;uniform sampler2D randomSampler;uniform sampler2D randomSampler2;uniform vec4 angleRange;\n#ifdef BOXEMITTER\nuniform vec3 direction1;uniform vec3 direction2;uniform vec3 minEmitBox;uniform vec3 maxEmitBox;\n#endif\n#ifdef POINTEMITTER\nuniform vec3 direction1;uniform vec3 direction2;\n#endif\n#ifdef HEMISPHERICEMITTER\nuniform float radius;uniform float radiusRange;uniform float directionRandomizer;\n#endif\n#ifdef SPHEREEMITTER\nuniform float radius;uniform float radiusRange;\n#ifdef DIRECTEDSPHEREEMITTER\nuniform vec3 direction1;uniform vec3 direction2;\n#else\nuniform float directionRandomizer;\n#endif\n#endif\n#ifdef CYLINDEREMITTER\nuniform float radius;uniform float height;uniform float radiusRange;\n#ifdef DIRECTEDCYLINDEREMITTER\nuniform vec3 direction1;uniform vec3 direction2;\n#else\nuniform float directionRandomizer;\n#endif\n#endif\n#ifdef CONEEMITTER\nuniform vec2 radius;uniform float coneAngle;uniform vec2 height;\n#ifdef DIRECTEDCONEEMITTER\nuniform vec3 direction1;uniform vec3 direction2;\n#else\nuniform float directionRandomizer;\n#endif\n#endif\nin vec3 position;\n#ifdef CUSTOMEMITTER\nin vec3 initialPosition;\n#endif\nin float age;in float life;in vec4 seed;in vec3 size;\n#ifndef COLORGRADIENTS\nin vec4 color;\n#endif\nin vec3 direction;\n#ifndef BILLBOARD\nin vec3 initialDirection;\n#endif\n#ifdef ANGULARSPEEDGRADIENTS\nin float angle;\n#else\nin vec2 angle;\n#endif\n#ifdef ANIMATESHEET\nin float cellIndex;\n#ifdef ANIMATESHEETRANDOMSTART\nin float cellStartOffset;\n#endif\n#endif\n#ifdef NOISE\nin vec3 noiseCoordinates1;in vec3 noiseCoordinates2;\n#endif\nout vec3 outPosition;\n#ifdef CUSTOMEMITTER\nout vec3 outInitialPosition;\n#endif\nout float outAge;out float outLife;out vec4 outSeed;out vec3 outSize;\n#ifndef COLORGRADIENTS\nout vec4 outColor;\n#endif\nout vec3 outDirection;\n#ifndef BILLBOARD\nout vec3 outInitialDirection;\n#endif\n#ifdef ANGULARSPEEDGRADIENTS\nout float outAngle;\n#else\nout vec2 outAngle;\n#endif\n#ifdef ANIMATESHEET\nout float outCellIndex;\n#ifdef ANIMATESHEETRANDOMSTART\nout float outCellStartOffset;\n#endif\n#endif\n#ifdef NOISE\nout vec3 outNoiseCoordinates1;out vec3 outNoiseCoordinates2;\n#endif\n#ifdef SIZEGRADIENTS\nuniform sampler2D sizeGradientSampler;\n#endif \n#ifdef ANGULARSPEEDGRADIENTS\nuniform sampler2D angularSpeedGradientSampler;\n#endif \n#ifdef VELOCITYGRADIENTS\nuniform sampler2D velocityGradientSampler;\n#endif\n#ifdef LIMITVELOCITYGRADIENTS\nuniform sampler2D limitVelocityGradientSampler;uniform float limitVelocityDamping;\n#endif\n#ifdef DRAGGRADIENTS\nuniform sampler2D dragGradientSampler;\n#endif\n#ifdef NOISE\nuniform vec3 noiseStrength;uniform sampler2D noiseSampler;\n#endif\n#ifdef ANIMATESHEET\nuniform vec4 cellInfos;\n#endif\nvec3 getRandomVec3(float offset) {return texture(randomSampler2,vec2(float(gl_VertexID)*offset/currentCount,0)).rgb;}\nvec4 getRandomVec4(float offset) {return texture(randomSampler,vec2(float(gl_VertexID)*offset/currentCount,0));}\nvoid main() {float newAge=age+timeDelta; \nif (newAge>=life && stopFactor != 0.) {vec3 newPosition;vec3 newDirection;vec4 randoms=getRandomVec4(seed.x);outLife=lifeTime.x+(lifeTime.y-lifeTime.x)*randoms.r;outAge=newAge-life;outSeed=seed;\n#ifdef SIZEGRADIENTS \noutSize.x=texture(sizeGradientSampler,vec2(0,0)).r;\n#else\noutSize.x=sizeRange.x+(sizeRange.y-sizeRange.x)*randoms.g;\n#endif\noutSize.y=scaleRange.x+(scaleRange.y-scaleRange.x)*randoms.b;outSize.z=scaleRange.z+(scaleRange.w-scaleRange.z)*randoms.a; \n#ifndef COLORGRADIENTS\noutColor=color1+(color2-color1)*randoms.b;\n#endif\n#ifndef ANGULARSPEEDGRADIENTS \noutAngle.y=angleRange.x+(angleRange.y-angleRange.x)*randoms.a;outAngle.x=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;\n#else\noutAngle=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;\n#endif \n#ifdef POINTEMITTER\nvec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);newPosition=vec3(0,0,0);newDirection=direction1+(direction2-direction1)*randoms3;\n#elif defined(BOXEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);newPosition=minEmitBox+(maxEmitBox-minEmitBox)*randoms2;newDirection=direction1+(direction2-direction1)*randoms3; \n#elif defined(HEMISPHERICEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float phi=2.0*PI*randoms2.x;float theta=acos(2.0*randoms2.y-1.0);float randX=cos(phi)*sin(theta);float randY=cos(theta);float randZ=sin(phi)*sin(theta);newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,abs(randY),randZ);newDirection=newPosition+directionRandomizer*randoms3; \n#elif defined(SPHEREEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float phi=2.0*PI*randoms2.x;float theta=acos(2.0*randoms2.y-1.0);float randX=cos(phi)*sin(theta);float randY=cos(theta);float randZ=sin(phi)*sin(theta);newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,randY,randZ);\n#ifdef DIRECTEDSPHEREEMITTER\nnewDirection=normalize(direction1+(direction2-direction1)*randoms3);\n#else\nnewDirection=normalize(newPosition+directionRandomizer*randoms3);\n#endif\n#elif defined(CYLINDEREMITTER)\nvec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float yPos=(randoms2.x-0.5)*height;float angle=randoms2.y*PI*2.;float inverseRadiusRangeSquared=((1.-radiusRange)*(1.-radiusRange));float positionRadius=radius*sqrt(inverseRadiusRangeSquared+(randoms2.z*(1.-inverseRadiusRangeSquared)));float xPos=positionRadius*cos(angle);float zPos=positionRadius*sin(angle);newPosition=vec3(xPos,yPos,zPos);\n#ifdef DIRECTEDCYLINDEREMITTER\nnewDirection=direction1+(direction2-direction1)*randoms3;\n#else\nangle=angle+((randoms3.x-0.5)*PI)*directionRandomizer;newDirection=vec3(cos(angle),(randoms3.y-0.5)*directionRandomizer,sin(angle));newDirection=normalize(newDirection);\n#endif\n#elif defined(CONEEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);float s=2.0*PI*randoms2.x;\n#ifdef CONEEMITTERSPAWNPOINT\nfloat h=0.0001;\n#else\nfloat h=randoms2.y*height.y;h=1.-h*h; \n#endif\nfloat lRadius=radius.x-radius.x*randoms2.z*radius.y;lRadius=lRadius*h;float randX=lRadius*sin(s);float randZ=lRadius*cos(s);float randY=h *height.x;newPosition=vec3(randX,randY,randZ); \nvec3 randoms3=getRandomVec3(seed.z);\n#ifdef DIRECTEDCONEEMITTER\nnewDirection=direction1+(direction2-direction1)*randoms3;\n#else\nif (abs(cos(coneAngle))==1.0) {newDirection=vec3(0.,1.0,0.);} else {newDirection=normalize(newPosition+directionRandomizer*randoms3); }\n#endif\n#elif defined(CUSTOMEMITTER)\nnewPosition=initialPosition;outInitialPosition=initialPosition;\n#else \nnewPosition=vec3(0.,0.,0.);newDirection=2.0*(getRandomVec3(seed.w)-vec3(0.5,0.5,0.5));\n#endif\nfloat power=emitPower.x+(emitPower.y-emitPower.x)*randoms.a;\n#ifdef LOCAL\noutPosition=newPosition;\n#else\noutPosition=(emitterWM*vec4(newPosition,1.)).xyz;\n#endif\n#ifdef CUSTOMEMITTER\noutDirection=direction;\n#ifndef BILLBOARD \noutInitialDirection=direction;\n#endif\n#else\n#ifdef LOCAL\nvec3 initial=newDirection;\n#else \nvec3 initial=(emitterWM*vec4(newDirection,0.)).xyz;\n#endif\noutDirection=initial*power;\n#ifndef BILLBOARD \noutInitialDirection=initial;\n#endif\n#endif\n#ifdef ANIMATESHEET \noutCellIndex=cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\noutCellStartOffset=randoms.a*outLife;\n#endif \n#endif\n#ifdef NOISE\noutNoiseCoordinates1=noiseCoordinates1;outNoiseCoordinates2=noiseCoordinates2;\n#endif\n} else {float directionScale=timeDelta;outAge=newAge;float ageGradient=newAge/life;\n#ifdef VELOCITYGRADIENTS\ndirectionScale*=texture(velocityGradientSampler,vec2(ageGradient,0)).r;\n#endif\n#ifdef DRAGGRADIENTS\ndirectionScale*=1.0-texture(dragGradientSampler,vec2(ageGradient,0)).r;\n#endif\n#if defined(CUSTOMEMITTER)\noutPosition=position+(direction-position)*ageGradient; \noutInitialPosition=initialPosition;\n#else\noutPosition=position+direction*directionScale;\n#endif\noutLife=life;outSeed=seed;\n#ifndef COLORGRADIENTS \noutColor=color;\n#endif\n#ifdef SIZEGRADIENTS\noutSize.x=texture(sizeGradientSampler,vec2(ageGradient,0)).r;outSize.yz=size.yz;\n#else\noutSize=size;\n#endif \n#ifndef BILLBOARD \noutInitialDirection=initialDirection;\n#endif\n#ifdef CUSTOMEMITTER\noutDirection=direction;\n#else\nvec3 updatedDirection=direction+gravity*timeDelta;\n#ifdef LIMITVELOCITYGRADIENTS\nfloat limitVelocity=texture(limitVelocityGradientSampler,vec2(ageGradient,0)).r;float currentVelocity=length(updatedDirection);if (currentVelocity>limitVelocity) {updatedDirection=updatedDirection*limitVelocityDamping;}\n#endif\noutDirection=updatedDirection;\n#ifdef NOISE\nfloat fetchedR=texture(noiseSampler,vec2(noiseCoordinates1.x,noiseCoordinates1.y)*vec2(0.5)+vec2(0.5)).r;float fetchedG=texture(noiseSampler,vec2(noiseCoordinates1.z,noiseCoordinates2.x)*vec2(0.5)+vec2(0.5)).r;float fetchedB=texture(noiseSampler,vec2(noiseCoordinates2.y,noiseCoordinates2.z)*vec2(0.5)+vec2(0.5)).r;vec3 force=vec3(2.*fetchedR-1.,2.*fetchedG-1.,2.*fetchedB-1.)*noiseStrength;outDirection=outDirection+force*timeDelta;outNoiseCoordinates1=noiseCoordinates1;outNoiseCoordinates2=noiseCoordinates2;\n#endif \n#endif \n#ifdef ANGULARSPEEDGRADIENTS\nfloat angularSpeed=texture(angularSpeedGradientSampler,vec2(ageGradient,0)).r;outAngle=angle+angularSpeed*timeDelta;\n#else\noutAngle=vec2(angle.x+angle.y*timeDelta,angle.y);\n#endif\n#ifdef ANIMATESHEET \nfloat offsetAge=outAge;float dist=cellInfos.y-cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\noutCellStartOffset=cellStartOffset;offsetAge+=cellStartOffset;\n#else\nfloat cellStartOffset=0.;\n#endif \nfloat ratio=0.;if (cellInfos.w==1.0) {ratio=clamp(mod(cellStartOffset+cellInfos.z*offsetAge,life)/life,0.,1.0);}\nelse {ratio=clamp(cellStartOffset+cellInfos.z*offsetAge/life,0.,1.0);}\noutCellIndex=float(int(cellInfos.x+ratio*dist));\n#endif\n}}";qi.l.ShadersStore[kC]=GC;class zC{constructor(e,t){this._renderVAO=[],this._updateVAO=[],this.alignDataInBuffer=!1,this._parent=e,this._engine=t,this._updateEffectOptions={attributes:["position","initialPosition","age","life","seed","size","color","direction","initialDirection","angle","cellIndex","cellStartOffset","noiseCoordinates1","noiseCoordinates2"],uniformsNames:["currentCount","timeDelta","emitterWM","lifeTime","color1","color2","sizeRange","scaleRange","gravity","emitPower","direction1","direction2","minEmitBox","maxEmitBox","radius","directionRandomizer","height","coneAngle","stopFactor","angleRange","radiusRange","cellInfos","noiseStrength","limitVelocityDamping"],uniformBuffersNames:[],samplers:["randomSampler","randomSampler2","sizeGradientSampler","angularSpeedGradientSampler","velocityGradientSampler","limitVelocityGradientSampler","noiseSampler","dragGradientSampler"],defines:"",fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:[]}}contextLost(){this._updateEffect=void 0,this._renderVAO.length=0,this._updateVAO.length=0}isUpdateBufferCreated(){return!!this._updateEffect}isUpdateBufferReady(){return this._updateEffect?.isReady()??!1}createUpdateBuffer(e){return this._updateEffectOptions.transformFeedbackVaryings=["outPosition"],this._updateEffectOptions.transformFeedbackVaryings.push("outAge"),this._updateEffectOptions.transformFeedbackVaryings.push("outSize"),this._updateEffectOptions.transformFeedbackVaryings.push("outLife"),this._updateEffectOptions.transformFeedbackVaryings.push("outSeed"),this._updateEffectOptions.transformFeedbackVaryings.push("outDirection"),this._parent.particleEmitterType instanceof FT&&this._updateEffectOptions.transformFeedbackVaryings.push("outInitialPosition"),this._parent._colorGradientsTexture||this._updateEffectOptions.transformFeedbackVaryings.push("outColor"),this._parent._isBillboardBased||this._updateEffectOptions.transformFeedbackVaryings.push("outInitialDirection"),this._parent.noiseTexture&&(this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates1"),this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates2")),this._updateEffectOptions.transformFeedbackVaryings.push("outAngle"),this._parent.isAnimationSheetEnabled&&(this._updateEffectOptions.transformFeedbackVaryings.push("outCellIndex"),this._parent.spriteRandomStartCell&&this._updateEffectOptions.transformFeedbackVaryings.push("outCellStartOffset")),this._updateEffectOptions.defines=e,this._updateEffect=this._engine.createEffect("gpuUpdateParticles",this._updateEffectOptions,this._engine),new BC(this._updateEffect)}createVertexBuffers(e,t){this._updateVAO.push(this._createUpdateVAO(e)),this._renderVAO.push(this._engine.recordVertexArrayObject(t,null,this._parent._getWrapper(this._parent.blendMode).effect)),this._engine.bindArrayBuffer(null),this._renderVertexBuffers=t}createParticleBuffer(e){return e}bindDrawBuffers(e,t,i){i?this._engine.bindBuffers(this._renderVertexBuffers,i,t):this._engine.bindVertexArrayObject(this._renderVAO[e],null)}preUpdateParticleBuffer(){const e=this._engine;if(this._engine.enableEffect(this._updateEffect),!e.setState)throw new Error("GPU particles cannot work without a full Engine. ThinEngine is not supported")}updateParticleBuffer(e,t,i){this._updateEffect.setTexture("randomSampler",this._parent._randomTexture),this._updateEffect.setTexture("randomSampler2",this._parent._randomTexture2),this._parent._sizeGradientsTexture&&this._updateEffect.setTexture("sizeGradientSampler",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateEffect.setTexture("angularSpeedGradientSampler",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateEffect.setTexture("velocityGradientSampler",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateEffect.setTexture("limitVelocityGradientSampler",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateEffect.setTexture("dragGradientSampler",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateEffect.setTexture("noiseSampler",this._parent.noiseTexture),this._engine.bindVertexArrayObject(this._updateVAO[e],null);const r=this._engine;r.bindTransformFeedbackBuffer(t.getBuffer()),r.setRasterizerState(!1),r.beginTransformFeedback(!0),r.drawArraysType(3,0,i),r.endTransformFeedback(),r.setRasterizerState(!0),r.bindTransformFeedbackBuffer(null)}releaseBuffers(){}releaseVertexBuffers(){for(let e=0;e<this._updateVAO.length;e++)this._engine.releaseVertexArrayObject(this._updateVAO[e]);this._updateVAO.length=0;for(let e=0;e<this._renderVAO.length;e++)this._engine.releaseVertexArrayObject(this._renderVAO[e]);this._renderVAO.length=0}_createUpdateVAO(e){const t={};t.position=e.createVertexBuffer("position",0,3);let i=3;t.age=e.createVertexBuffer("age",i,1),i+=1,t.size=e.createVertexBuffer("size",i,3),i+=3,t.life=e.createVertexBuffer("life",i,1),i+=1,t.seed=e.createVertexBuffer("seed",i,4),i+=4,t.direction=e.createVertexBuffer("direction",i,3),i+=3,this._parent.particleEmitterType instanceof FT&&(t.initialPosition=e.createVertexBuffer("initialPosition",i,3),i+=3),this._parent._colorGradientsTexture||(t.color=e.createVertexBuffer("color",i,4),i+=4),this._parent._isBillboardBased||(t.initialDirection=e.createVertexBuffer("initialDirection",i,3),i+=3),this._parent.noiseTexture&&(t.noiseCoordinates1=e.createVertexBuffer("noiseCoordinates1",i,3),i+=3,t.noiseCoordinates2=e.createVertexBuffer("noiseCoordinates2",i,3),i+=3),this._parent._angularSpeedGradientsTexture?(t.angle=e.createVertexBuffer("angle",i,1),i+=1):(t.angle=e.createVertexBuffer("angle",i,2),i+=2),this._parent._isAnimationSheetEnabled&&(t.cellIndex=e.createVertexBuffer("cellIndex",i,1),i+=1,this._parent.spriteRandomStartCell&&(t.cellStartOffset=e.createVertexBuffer("cellStartOffset",i,1),i+=1));const r=this._engine.recordVertexArrayObject(t,null,this._updateEffect);return this._engine.bindArrayBuffer(null),r}}(0,a.Y5)("BABYLON.WebGL2ParticleSystem",zC);const UC="gpuUpdateParticlesComputeShader",WC="struct Particle {position : vec3<f32>,\nage : f32,\nsize : vec3<f32>,\nlife : f32,\nseed : vec4<f32>,\ndirection : vec3<f32>,\ndummy0: f32,\n#ifdef CUSTOMEMITTER\ninitialPosition : vec3<f32>,\ndummy1: f32,\n#endif\n#ifndef COLORGRADIENTS\ncolor : vec4<f32>,\n#endif\n#ifndef BILLBOARD\ninitialDirection : vec3<f32>,\ndummy2: f32,\n#endif\n#ifdef NOISE\nnoiseCoordinates1 : vec3<f32>,\ndummy3: f32,\nnoiseCoordinates2 : vec3<f32>,\ndummy4: f32,\n#endif\n#ifdef ANGULARSPEEDGRADIENTS\nangle : f32,\n#else\nangle : vec2<f32>,\n#endif\n#ifdef ANIMATESHEET\ncellIndex : f32,\n#ifdef ANIMATESHEETRANDOMSTART\ncellStartOffset : f32,\n#endif\n#endif\n};struct Particles {particles : array<Particle>,};struct SimParams {currentCount : f32,\ntimeDelta : f32,\nstopFactor : f32,\nrandomTextureSize: i32,\nlifeTime : vec2<f32>,\nemitPower : vec2<f32>,\n#ifndef COLORGRADIENTS\ncolor1 : vec4<f32>,\ncolor2 : vec4<f32>,\n#endif\nsizeRange : vec2<f32>,\nscaleRange : vec4<f32>,\nangleRange : vec4<f32>,\ngravity : vec3<f32>,\n#ifdef LIMITVELOCITYGRADIENTS\nlimitVelocityDamping : f32,\n#endif\n#ifdef ANIMATESHEET\ncellInfos : vec4<f32>,\n#endif\n#ifdef NOISE\nnoiseStrength : vec3<f32>,\n#endif\n#ifndef LOCAL\nemitterWM : mat4x4<f32>,\n#endif\n#ifdef BOXEMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\nminEmitBox : vec3<f32>,\nmaxEmitBox : vec3<f32>,\n#endif\n#ifdef CONEEMITTER\nradius : vec2<f32>,\nconeAngle : f32,\nheight : vec2<f32>,\n#ifdef DIRECTEDCONEEMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\n#else\ndirectionRandomizer : f32,\n#endif\n#endif\n#ifdef CYLINDEREMITTER\nradius : f32,\nheight : f32,\nradiusRange : f32,\n#ifdef DIRECTEDCYLINDEREMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\n#else\ndirectionRandomizer : f32,\n#endif\n#endif\n#ifdef HEMISPHERICEMITTER\nradius : f32,\nradiusRange : f32,\ndirectionRandomizer : f32,\n#endif\n#ifdef POINTEMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\n#endif\n#ifdef SPHEREEMITTER\nradius : f32,\nradiusRange : f32,\n#ifdef DIRECTEDSPHEREEMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\n#else\ndirectionRandomizer : f32,\n#endif\n#endif\n};@binding(0) @group(0) var<uniform> params : SimParams;@binding(1) @group(0) var<storage,read> particlesIn : Particles;@binding(2) @group(0) var<storage,read_write> particlesOut : Particles;@binding(3) @group(0) var randomTexture : texture_2d<f32>;@binding(4) @group(0) var randomTexture2 : texture_2d<f32>;\n#ifdef SIZEGRADIENTS\n@binding(0) @group(1) var sizeGradientSampler : sampler;@binding(1) @group(1) var sizeGradientTexture : texture_2d<f32>;\n#endif \n#ifdef ANGULARSPEEDGRADIENTS\n@binding(2) @group(1) var angularSpeedGradientSampler : sampler;@binding(3) @group(1) var angularSpeedGradientTexture : texture_2d<f32>;\n#endif \n#ifdef VELOCITYGRADIENTS\n@binding(4) @group(1) var velocityGradientSampler : sampler;@binding(5) @group(1) var velocityGradientTexture : texture_2d<f32>;\n#endif\n#ifdef LIMITVELOCITYGRADIENTS\n@binding(6) @group(1) var limitVelocityGradientSampler : sampler;@binding(7) @group(1) var limitVelocityGradientTexture : texture_2d<f32>;\n#endif\n#ifdef DRAGGRADIENTS\n@binding(8) @group(1) var dragGradientSampler : sampler;@binding(9) @group(1) var dragGradientTexture : texture_2d<f32>;\n#endif\n#ifdef NOISE\n@binding(10) @group(1) var noiseSampler : sampler;@binding(11) @group(1) var noiseTexture : texture_2d<f32>;\n#endif\nfn getRandomVec3(offset : f32,vertexID : f32)->vec3<f32> {return textureLoad(randomTexture2,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0).rgb;}\nfn getRandomVec4(offset : f32,vertexID : f32)->vec4<f32> {return textureLoad(randomTexture,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0);}\n@compute @workgroup_size(64)\nfn main(@builtin(global_invocation_id) GlobalInvocationID : vec3<u32>) {let index : u32=GlobalInvocationID.x;let vertexID : f32=f32(index);if (index>=u32(params.currentCount)) {return;}\nlet PI : f32=3.14159;let timeDelta : f32=params.timeDelta;let newAge : f32=particlesIn.particles[index].age+timeDelta;let life : f32=particlesIn.particles[index].life;let seed : vec4<f32>=particlesIn.particles[index].seed;let direction : vec3<f32>=particlesIn.particles[index].direction;if (newAge>=life && params.stopFactor != 0.) {var newPosition : vec3<f32>;var newDirection : vec3<f32>;let randoms : vec4<f32>=getRandomVec4(seed.x,vertexID);let outLife : f32=params.lifeTime.x+(params.lifeTime.y-params.lifeTime.x)*randoms.r;particlesOut.particles[index].life=outLife;particlesOut.particles[index].age=newAge-life;particlesOut.particles[index].seed=seed;var sizex : f32;\n#ifdef SIZEGRADIENTS \nsizex=textureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(0.,0.),0.).r;\n#else\nsizex=params.sizeRange.x+(params.sizeRange.y-params.sizeRange.x)*randoms.g;\n#endif\nparticlesOut.particles[index].size=vec3<f32>(\nsizex,\nparams.scaleRange.x+(params.scaleRange.y-params.scaleRange.x)*randoms.b,\nparams.scaleRange.z+(params.scaleRange.w-params.scaleRange.z)*randoms.a);\n#ifndef COLORGRADIENTS\nparticlesOut.particles[index].color=params.color1+(params.color2-params.color1)*randoms.b;\n#endif\n#ifndef ANGULARSPEEDGRADIENTS \nparticlesOut.particles[index].angle=vec2<f32>(\nparams.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r,\nparams.angleRange.x+(params.angleRange.y-params.angleRange.x)*randoms.a);\n#else\nparticlesOut.particles[index].angle=params.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r;\n#endif \n#if defined(POINTEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);newPosition=vec3<f32>(0.,0.,0.);newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;\n#elif defined(BOXEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);newPosition=params.minEmitBox+(params.maxEmitBox-params.minEmitBox)*randoms2;newDirection=params.direction1+(params.direction2-params.direction1)*randoms3; \n#elif defined(HEMISPHERICEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let phi : f32=2.0*PI*randoms2.x;let theta : f32=acos(-1.0+2.0*randoms2.y);let randX : f32=cos(phi)*sin(theta);let randY : f32=cos(theta);let randZ : f32=sin(phi)*sin(theta);newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,abs(randY),randZ);newDirection=normalize(newPosition+params.directionRandomizer*randoms3);\n#elif defined(SPHEREEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let phi : f32=2.0*PI*randoms2.x;let theta : f32=acos(-1.0+2.0*randoms2.y);let randX : f32=cos(phi)*sin(theta);let randY : f32=cos(theta);let randZ : f32=sin(phi)*sin(theta);newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,randY,randZ);\n#ifdef DIRECTEDSPHEREEMITTER\nnewDirection=normalize(params.direction1+(params.direction2-params.direction1)*randoms3);\n#else\nnewDirection=normalize(newPosition+params.directionRandomizer*randoms3);\n#endif\n#elif defined(CYLINDEREMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let yPos : f32=(-0.5+randoms2.x)*params.height;var angle : f32=randoms2.y*PI*2.;let inverseRadiusRangeSquared : f32=(1.-params.radiusRange)*(1.-params.radiusRange);let positionRadius : f32=params.radius*sqrt(inverseRadiusRangeSquared+randoms2.z*(1.-inverseRadiusRangeSquared));let xPos : f32=positionRadius*cos(angle);let zPos : f32=positionRadius*sin(angle);newPosition=vec3<f32>(xPos,yPos,zPos);\n#ifdef DIRECTEDCYLINDEREMITTER\nnewDirection=params.direction1+(params.direction2-params.direction1)*randoms3;\n#else\nangle=angle+(-0.5+randoms3.x)*PI*params.directionRandomizer;newDirection=vec3<f32>(cos(angle),(-0.5+randoms3.y)*params.directionRandomizer,sin(angle));newDirection=normalize(newDirection);\n#endif\n#elif defined(CONEEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let s : f32=2.0*PI*randoms2.x;\n#ifdef CONEEMITTERSPAWNPOINT\nlet h : f32=0.0001;\n#else\nvar h : f32=randoms2.y*params.height.y;h=1.-h*h; \n#endif\nvar lRadius : f32=params.radius.x-params.radius.x*randoms2.z*params.radius.y;lRadius=lRadius*h;let randX : f32=lRadius*sin(s);let randZ : f32=lRadius*cos(s);let randY : f32=h *params.height.x;newPosition=vec3<f32>(randX,randY,randZ); \nlet randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);\n#ifdef DIRECTEDCONEEMITTER\nnewDirection=params.direction1+(params.direction2-params.direction1)*randoms3;\n#else\nif (abs(cos(params.coneAngle))==1.0) {newDirection=vec3<f32>(0.,1.0,0.);} else {newDirection=normalize(newPosition+params.directionRandomizer*randoms3); }\n#endif\n#elif defined(CUSTOMEMITTER)\nnewPosition=particlesIn.particles[index].initialPosition;particlesOut.particles[index].initialPosition=newPosition;\n#else \nnewPosition=vec3<f32>(0.,0.,0.);newDirection=2.0*(getRandomVec3(seed.w,vertexID)-vec3<f32>(0.5,0.5,0.5));\n#endif\nlet power : f32=params.emitPower.x+(params.emitPower.y-params.emitPower.x)*randoms.a;\n#ifdef LOCAL\nparticlesOut.particles[index].position=newPosition;\n#else\nparticlesOut.particles[index].position=(params.emitterWM*vec4<f32>(newPosition,1.)).xyz;\n#endif\n#ifdef CUSTOMEMITTER\nparticlesOut.particles[index].direction=direction;\n#ifndef BILLBOARD \nparticlesOut.particles[index].initialDirection=direction;\n#endif\n#else\n#ifdef LOCAL\nlet initial : vec3<f32>=newDirection;\n#else \nlet initial : vec3<f32>=(params.emitterWM*vec4<f32>(newDirection,0.)).xyz;\n#endif\nparticlesOut.particles[index].direction=initial*power;\n#ifndef BILLBOARD \nparticlesOut.particles[index].initialDirection=initial;\n#endif\n#endif\n#ifdef ANIMATESHEET \nparticlesOut.particles[index].cellIndex=params.cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\nparticlesOut.particles[index].cellStartOffset=randoms.a*outLife;\n#endif \n#endif\n#ifdef NOISE\nparticlesOut.particles[index].noiseCoordinates1=particlesIn.particles[index].noiseCoordinates1;particlesOut.particles[index].noiseCoordinates2=particlesIn.particles[index].noiseCoordinates2;\n#endif\n} else {var directionScale : f32=timeDelta;particlesOut.particles[index].age=newAge;let ageGradient : f32=newAge/life;\n#ifdef VELOCITYGRADIENTS\ndirectionScale=directionScale*textureSampleLevel(velocityGradientTexture,velocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;\n#endif\n#ifdef DRAGGRADIENTS\ndirectionScale=directionScale*(1.0-textureSampleLevel(dragGradientTexture,dragGradientSampler,vec2<f32>(ageGradient,0.),0.).r);\n#endif\nlet position : vec3<f32>=particlesIn.particles[index].position;\n#if defined(CUSTOMEMITTER)\nparticlesOut.particles[index].position=position+(direction-position)*ageGradient; \nparticlesOut.particles[index].initialPosition=particlesIn.particles[index].initialPosition;\n#else\nparticlesOut.particles[index].position=position+direction*directionScale;\n#endif\nparticlesOut.particles[index].life=life;particlesOut.particles[index].seed=seed;\n#ifndef COLORGRADIENTS \nparticlesOut.particles[index].color=particlesIn.particles[index].color;\n#endif\n#ifdef SIZEGRADIENTS\nparticlesOut.particles[index].size=vec3<f32>(\ntextureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(ageGradient,0.),0.).r,\nparticlesIn.particles[index].size.yz);\n#else\nparticlesOut.particles[index].size=particlesIn.particles[index].size;\n#endif \n#ifndef BILLBOARD \nparticlesOut.particles[index].initialDirection=particlesIn.particles[index].initialDirection;\n#endif\n#ifdef CUSTOMEMITTER\nparticlesOut.particles[index].direction=direction;\n#else\nvar updatedDirection : vec3<f32>=direction+params.gravity*timeDelta;\n#ifdef LIMITVELOCITYGRADIENTS\nlet limitVelocity : f32=textureSampleLevel(limitVelocityGradientTexture,limitVelocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;let currentVelocity : f32=length(updatedDirection);if (currentVelocity>limitVelocity) {updatedDirection=updatedDirection*params.limitVelocityDamping;}\n#endif\nparticlesOut.particles[index].direction=updatedDirection;\n#ifdef NOISE\nlet noiseCoordinates1 : vec3<f32>=particlesIn.particles[index].noiseCoordinates1;let noiseCoordinates2 : vec3<f32>=particlesIn.particles[index].noiseCoordinates2;let fetchedR : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.x,noiseCoordinates1.y)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let fetchedG : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.z,noiseCoordinates2.x)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let fetchedB : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates2.y,noiseCoordinates2.z)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let force : vec3<f32>=vec3<f32>(-1.+2.*fetchedR,-1.+2.*fetchedG,-1.+2.*fetchedB)*params.noiseStrength;particlesOut.particles[index].direction=particlesOut.particles[index].direction+force*timeDelta;particlesOut.particles[index].noiseCoordinates1=noiseCoordinates1;particlesOut.particles[index].noiseCoordinates2=noiseCoordinates2;\n#endif \n#endif \n#ifdef ANGULARSPEEDGRADIENTS\nlet angularSpeed : f32=textureSampleLevel(angularSpeedGradientTexture,angularSpeedGradientSampler,vec2<f32>(ageGradient,0.),0.).r;particlesOut.particles[index].angle=particlesIn.particles[index].angle+angularSpeed*timeDelta;\n#else\nlet angle : vec2<f32>=particlesIn.particles[index].angle;particlesOut.particles[index].angle=vec2<f32>(angle.x+angle.y*timeDelta,angle.y);\n#endif\n#ifdef ANIMATESHEET \nvar offsetAge : f32=particlesOut.particles[index].age;let dist : f32=params.cellInfos.y-params.cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\nlet cellStartOffset : f32=particlesIn.particles[index].cellStartOffset;particlesOut.particles[index].cellStartOffset=cellStartOffset;offsetAge=offsetAge+cellStartOffset;\n#else\nlet cellStartOffset : f32=0.;\n#endif \nvar ratio : f32;if (params.cellInfos.w==1.0) {ratio=clamp(((cellStartOffset+params.cellInfos.z*offsetAge) % life)/life,0.,1.0);}\nelse {ratio=clamp((cellStartOffset+params.cellInfos.z*offsetAge)/life,0.,1.0);}\nparticlesOut.particles[index].cellIndex=f32(i32(params.cellInfos.x+ratio*dist));\n#endif\n}}\n";qi.l.ShadersStoreWGSL[UC]=WC;class HC{constructor(e,t){this._bufferComputeShader=[],this._renderVertexBuffers=[],this.alignDataInBuffer=!0,this._parent=e,this._engine=t}contextLost(){this._updateComputeShader=void 0,this._bufferComputeShader.length=0,this._renderVertexBuffers.length=0}isUpdateBufferCreated(){return!!this._updateComputeShader}isUpdateBufferReady(){return this._updateComputeShader?.isReady()??!1}createUpdateBuffer(e){const t={params:{group:0,binding:0},particlesIn:{group:0,binding:1},particlesOut:{group:0,binding:2},randomTexture:{group:0,binding:3},randomTexture2:{group:0,binding:4}};return this._parent._sizeGradientsTexture&&(t.sizeGradientTexture={group:1,binding:1}),this._parent._angularSpeedGradientsTexture&&(t.angularSpeedGradientTexture={group:1,binding:3}),this._parent._velocityGradientsTexture&&(t.velocityGradientTexture={group:1,binding:5}),this._parent._limitVelocityGradientsTexture&&(t.limitVelocityGradientTexture={group:1,binding:7}),this._parent._dragGradientsTexture&&(t.dragGradientTexture={group:1,binding:9}),this._parent.noiseTexture&&(t.noiseTexture={group:1,binding:11}),this._updateComputeShader=new ps.H("updateParticles",this._engine,"gpuUpdateParticles",{bindingsMapping:t,defines:e.split("\n")}),this._simParamsComputeShader?.dispose(),this._simParamsComputeShader=new hr.D(this._engine,void 0,void 0,"ComputeShaderParticleSystemUBO"),this._simParamsComputeShader.addUniform("currentCount",1),this._simParamsComputeShader.addUniform("timeDelta",1),this._simParamsComputeShader.addUniform("stopFactor",1),this._simParamsComputeShader.addUniform("randomTextureSize",1),this._simParamsComputeShader.addUniform("lifeTime",2),this._simParamsComputeShader.addUniform("emitPower",2),this._parent._colorGradientsTexture||(this._simParamsComputeShader.addUniform("color1",4),this._simParamsComputeShader.addUniform("color2",4)),this._simParamsComputeShader.addUniform("sizeRange",2),this._simParamsComputeShader.addUniform("scaleRange",4),this._simParamsComputeShader.addUniform("angleRange",4),this._simParamsComputeShader.addUniform("gravity",3),this._parent._limitVelocityGradientsTexture&&this._simParamsComputeShader.addUniform("limitVelocityDamping",1),this._parent.isAnimationSheetEnabled&&this._simParamsComputeShader.addUniform("cellInfos",4),this._parent.noiseTexture&&this._simParamsComputeShader.addUniform("noiseStrength",3),this._parent.isLocal||this._simParamsComputeShader.addUniform("emitterWM",16),this._parent.particleEmitterType&&this._parent.particleEmitterType.buildUniformLayout(this._simParamsComputeShader),this._updateComputeShader.setUniformBuffer("params",this._simParamsComputeShader),new BC(this._simParamsComputeShader)}createVertexBuffers(e,t){this._renderVertexBuffers.push(t)}createParticleBuffer(e){const t=new Ft.K(this._engine,4*e.length,11,"ComputeShaderParticleSystemBuffer");return t.update(e),this._bufferComputeShader.push(t),t.getBuffer()}bindDrawBuffers(e,t,i){this._engine.bindBuffers(this._renderVertexBuffers[e],i,t)}preUpdateParticleBuffer(){}updateParticleBuffer(e,t,i){this._simParamsComputeShader.update(),this._updateComputeShader.setTexture("randomTexture",this._parent._randomTexture,!1),this._updateComputeShader.setTexture("randomTexture2",this._parent._randomTexture2,!1),this._parent._sizeGradientsTexture&&this._updateComputeShader.setTexture("sizeGradientTexture",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateComputeShader.setTexture("angularSpeedGradientTexture",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateComputeShader.setTexture("velocityGradientTexture",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateComputeShader.setTexture("limitVelocityGradientTexture",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateComputeShader.setTexture("dragGradientTexture",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateComputeShader.setTexture("noiseTexture",this._parent.noiseTexture),this._updateComputeShader.setStorageBuffer("particlesIn",this._bufferComputeShader[e]),this._updateComputeShader.setStorageBuffer("particlesOut",this._bufferComputeShader[1^e]),this._updateComputeShader.dispatch(Math.ceil(i/64))}releaseBuffers(){for(let e=0;e<this._bufferComputeShader.length;++e)this._bufferComputeShader[e].dispose();this._bufferComputeShader.length=0,this._simParamsComputeShader?.dispose(),this._simParamsComputeShader=null,this._updateComputeShader=null}releaseVertexBuffers(){this._renderVertexBuffers.length=0}}(0,a.Y5)("BABYLON.ComputeShaderParticleSystem",HC);const $C="clipPlaneFragmentDeclaration2",qC="#ifdef CLIPPLANE\nin float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nin float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nin float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nin float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nin float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nin float fClipDistance6;\n#endif\n";qi.l.IncludesShadersStore[$C]=qC;i(34581),i(29741),i(2360);const YC="gpuRenderParticlesPixelShader",XC="precision highp float;\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nuniform sampler2D diffuseSampler;varying vec2 vUV;varying vec4 vColor;\n#include<clipPlaneFragmentDeclaration2> \n#include<imageProcessingDeclaration>\n#include<logDepthDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#include<fogFragmentDeclaration>\nvoid main() {\n#include<clipPlaneFragment> \nvec4 textureColor=texture2D(diffuseSampler,vUV);gl_FragColor=textureColor*vColor;\n#ifdef BLENDMULTIPLYMODE\nfloat alpha=vColor.a*textureColor.a;gl_FragColor.rgb=gl_FragColor.rgb*alpha+vec3(1.0)*(1.0-alpha);\n#endif \n#include<logDepthFragment>\n#include<fogFragment>(color,gl_FragColor)\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ngl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);\n#else\n#ifdef IMAGEPROCESSING\ngl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);gl_FragColor=applyImageProcessing(gl_FragColor);\n#endif\n#endif\n}\n";qi.l.ShadersStore[YC]=XC;const jC="clipPlaneVertexDeclaration2",ZC="#ifdef CLIPPLANE\nuniform vec4 vClipPlane;out float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nuniform vec4 vClipPlane2;out float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nuniform vec4 vClipPlane3;out float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nuniform vec4 vClipPlane4;out float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nuniform vec4 vClipPlane5;out float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nuniform vec4 vClipPlane6;out float fClipDistance6;\n#endif\n";qi.l.IncludesShadersStore[jC]=ZC;i(86560),i(16470),i(2215);const QC="gpuRenderParticlesVertexShader",KC="precision highp float;uniform mat4 view;uniform mat4 projection;uniform vec2 translationPivot;uniform vec3 worldOffset;\n#ifdef LOCAL\nuniform mat4 emitterWM;\n#endif\nattribute vec3 position;attribute float age;attribute float life;attribute vec3 size;\n#ifndef BILLBOARD\nattribute vec3 initialDirection;\n#endif\n#ifdef BILLBOARDSTRETCHED\nattribute vec3 direction;\n#endif\nattribute float angle;\n#ifdef ANIMATESHEET\nattribute float cellIndex;\n#endif\nattribute vec2 offset;attribute vec2 uv;varying vec2 vUV;varying vec4 vColor;varying vec3 vPositionW;\n#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)\nuniform mat4 invView;\n#endif\n#include<clipPlaneVertexDeclaration2>\n#include<fogVertexDeclaration>\n#include<logDepthDeclaration>\n#ifdef COLORGRADIENTS\nuniform sampler2D colorGradientSampler;\n#else\nuniform vec4 colorDead;attribute vec4 color;\n#endif\n#ifdef ANIMATESHEET\nuniform vec3 sheetInfos;\n#endif\n#ifdef BILLBOARD\nuniform vec3 eyePosition;\n#endif\nvec3 rotate(vec3 yaxis,vec3 rotatedCorner) {vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));vec3 zaxis=normalize(cross(yaxis,xaxis));vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;\n#ifdef LOCAL\nreturn ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;\n#else\nreturn (position+worldOffset)+alignedCorner;\n#endif\n}\n#ifdef BILLBOARDSTRETCHED\nvec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {vec3 normalizedToCamera=normalize(toCamera);vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;\n#ifdef LOCAL\nreturn ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;\n#else\nreturn (position+worldOffset)+alignedCorner;\n#endif\n}\n#endif\nvoid main() {\n#ifdef ANIMATESHEET\nfloat rowOffset=floor(cellIndex/sheetInfos.z);float columnOffset=cellIndex-rowOffset*sheetInfos.z;vec2 uvScale=sheetInfos.xy;vec2 uvOffset=vec2(uv.x ,1.0-uv.y);vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;\n#else\nvUV=uv;\n#endif\nfloat ratio=min(1.0,age/life);\n#ifdef COLORGRADIENTS\nvColor=texture2D(colorGradientSampler,vec2(ratio,0));\n#else\nvColor=color*vec4(1.0-ratio)+colorDead*vec4(ratio);\n#endif\nvec2 cornerPos=(offset-translationPivot)*size.yz*size.x;\n#ifdef BILLBOARD\nvec4 rotatedCorner;rotatedCorner.w=0.;\n#ifdef BILLBOARDY\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=(position+worldOffset)-eyePosition;yaxis.y=0.;vPositionW=rotate(normalize(yaxis),rotatedCorner.xyz);vec4 viewPosition=(view*vec4(vPositionW,1.0));\n#elif defined(BILLBOARDSTRETCHED)\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 toCamera=(position+worldOffset)-eyePosition;vPositionW=rotateAlign(toCamera,rotatedCorner.xyz);vec4 viewPosition=(view*vec4(vPositionW,1.0));\n#else\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;\n#ifdef LOCAL\nvec4 viewPosition=view*vec4(((emitterWM*vec4(position,1.0)).xyz+worldOffset),1.0)+rotatedCorner;\n#else\nvec4 viewPosition=view*vec4((position+worldOffset),1.0)+rotatedCorner;\n#endif\nvPositionW=(invView*viewPosition).xyz;\n#endif\n#else\nvec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=0.;rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.xz+=translationPivot;vec3 yaxis=normalize(initialDirection);vPositionW=rotate(yaxis,rotatedCorner);vec4 viewPosition=view*vec4(vPositionW,1.0);\n#endif\ngl_Position=projection*viewPosition;\n#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6) || defined(FOG)\nvec4 worldPos=vec4(vPositionW,1.0);\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<logDepthVertex>\n}";qi.l.ShadersStore[QC]=KC;class JC extends qd{static get IsSupported(){if(!C.q.LastCreatedEngine)return!1;const e=C.q.LastCreatedEngine.getCaps();return e.supportTransformFeedbacks||e.supportComputeShaders}_createIndexBuffer(){this._linesIndexBufferUseInstancing=this._engine.createIndexBuffer(new Uint32Array([0,1,1,3,3,2,2,0,0,3]),void 0,"GPUParticleSystemLinesIndexBuffer")}getCapacity(){return this._capacity}get maxActiveParticleCount(){return this._maxActiveParticleCount}set maxActiveParticleCount(e){this._maxActiveParticleCount=Math.min(e,this._capacity)}get activeParticleCount(){return this.maxActiveParticleCount}set activeParticleCount(e){this.maxActiveParticleCount=e}createPointEmitter(e,t){const i=HT(e,t);return this.particleEmitterType=i,i}createHemisphericEmitter(e=1,t=1){const i=$T(e,t);return this.particleEmitterType=i,i}createSphereEmitter(e=1,t=1){const i=qT(e,t);return this.particleEmitterType=i,i}createDirectedSphereEmitter(e=1,t=new n.Pq(0,1,0),i=new n.Pq(0,1,0)){const r=YT(e,t,i);return this.particleEmitterType=r,r}createCylinderEmitter(e=1,t=1,i=1,r=0){const s=XT(e,t,i,r);return this.particleEmitterType=s,s}createDirectedCylinderEmitter(e=1,t=1,i=1,r=new n.Pq(0,1,0),s=new n.Pq(0,1,0)){const o=jT(e,t,i,r,s);return this.particleEmitterType=o,o}createConeEmitter(e=1,t=Math.PI/4){const i=ZT(e,t);return this.particleEmitterType=i,i}createDirectedConeEmitter(e=1,t=Math.PI/4,i=new n.Pq(0,1,0),r=new n.Pq(0,1,0)){const s=QT(e,t,i,r);return this.particleEmitterType=s,s}createBoxEmitter(e,t,i,r){const s=new RT;return this.particleEmitterType=s,this.direction1=e,this.direction2=t,this.minEmitBox=i,this.maxEmitBox=r,s}isReady(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady()||this._rebuildingAfterContextLost)return!1;if(this.blendMode!==KT.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else{if(!this._getWrapper(KT.BLENDMODE_MULTIPLY).effect.isReady())return!1;if(!this._getWrapper(KT.BLENDMODE_ADD).effect.isReady())return!1}return this._platform.isUpdateBufferCreated()?this._platform.isUpdateBufferReady():(this._recreateUpdateEffect(),!1)}isStarted(){return this._started}isStopped(){return this._stopped}isStopping(){return!1}getActiveCount(){return this._currentActiveCount}start(e=this.startDelay){if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";e?setTimeout((()=>{this.start(0)}),e):(this._started=!0,this._stopped=!1,this._preWarmDone=!1,this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop))}stop(){this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0)}reset(){this._releaseBuffers(),this._platform.releaseVertexBuffers(),this._currentActiveCount=0,this._targetIndex=0}getClassName(){return"GPUParticleSystem"}getCustomEffect(e=0){return this._customWrappers[e]?.effect??this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){return this._customWrappers[e]??this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new Ah.E(this._engine),this._customWrappers[t].effect=e}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new s.cP),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"gpuRenderParticles"}get vertexBuffers(){return this._renderVertexBuffers[1^this._targetIndex]}get indexBuffer(){return null}_removeGradientAndTexture(e,t,i){return super._removeGradientAndTexture(e,t,i),this._releaseBuffers(),this}addColorGradient(e,t){this._colorGradients||(this._colorGradients=[]);const i=new bT(e,t);return this._colorGradients.push(i),this._refreshColorGradient(!0),this._releaseBuffers(),this}_refreshColorGradient(e=!1){this._colorGradients&&(e&&this._colorGradients.sort(((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0)),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null))}forceRefreshGradients(){this._refreshColorGradient(),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture"),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture"),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture"),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture"),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture"),this.reset()}removeColorGradient(e){return this._removeGradientAndTexture(e,this._colorGradients,this._colorGradientsTexture),this._colorGradientsTexture=null,this}resetDrawCache(){for(const e in this._drawWrappers){const t=this._drawWrappers[e];t.drawContext?.reset()}}_addFactorGradient(e,t,i){const r=new PT(t,i);e.push(r),this._releaseBuffers()}addSizeGradient(e,t){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture",!0),this._releaseBuffers(),this}removeSizeGradient(e){return this._removeGradientAndTexture(e,this._sizeGradients,this._sizeGradientsTexture),this._sizeGradientsTexture=null,this}_refreshFactorGradient(e,t,i=!1){if(!e)return;i&&e.sort(((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0));const r=this;r[t]&&(r[t].dispose(),r[t]=null)}addAngularSpeedGradient(e,t){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture",!0),this._releaseBuffers(),this}removeAngularSpeedGradient(e){return this._removeGradientAndTexture(e,this._angularSpeedGradients,this._angularSpeedGradientsTexture),this._angularSpeedGradientsTexture=null,this}addVelocityGradient(e,t){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture",!0),this._releaseBuffers(),this}removeVelocityGradient(e){return this._removeGradientAndTexture(e,this._velocityGradients,this._velocityGradientsTexture),this._velocityGradientsTexture=null,this}addLimitVelocityGradient(e,t){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture",!0),this._releaseBuffers(),this}removeLimitVelocityGradient(e){return this._removeGradientAndTexture(e,this._limitVelocityGradients,this._limitVelocityGradientsTexture),this._limitVelocityGradientsTexture=null,this}addDragGradient(e,t){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture",!0),this._releaseBuffers(),this}removeDragGradient(e){return this._removeGradientAndTexture(e,this._dragGradients,this._dragGradientsTexture),this._dragGradientsTexture=null,this}addEmitRateGradient(){return this}removeEmitRateGradient(){return this}addStartSizeGradient(){return this}removeStartSizeGradient(){return this}addColorRemapGradient(){return this}removeColorRemapGradient(){return this}addAlphaRemapGradient(){return this}removeAlphaRemapGradient(){return this}addRampGradient(){return this}removeRampGradient(){return this}getRampGradients(){return null}get useRampGradients(){return!1}set useRampGradients(e){}addLifeTimeGradient(){return this}removeLifeTimeGradient(){return this}constructor(e,t,i,r=null,o=!1){if(super(e),this.layerMask=268435455,this._accumulatedCount=0,this._renderVertexBuffers=[],this._targetIndex=0,this._currentRenderId=-1,this._currentRenderingCameraUniqueId=-1,this._started=!1,this._stopped=!1,this._timeDelta=0,this.updateInAnimate=!1,this._actualFrame=0,this._rawTextureWidth=256,this._rebuildingAfterContextLost=!1,this.onDisposeObservable=new s.cP,this.onStoppedObservable=new s.cP,this.forceDepthWrite=!1,this._preWarmDone=!1,this.isLocal=!1,this.isGPU=!0,this._onBeforeDrawParticlesObservable=null,i&&"Scene"!==i.getClassName()?(this._engine=i,this.defaultProjectionMatrix=n.uq.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)):(this._scene=i||C.q.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)),this._engine.getCaps().supportComputeShaders){if(!(0,a.n9)("BABYLON.ComputeShaderParticleSystem"))throw new Error("The ComputeShaderParticleSystem class is not available! Make sure you have imported it.");this._platform=new((0,a.n9)("BABYLON.ComputeShaderParticleSystem"))(this,this._engine)}else{if(!(0,a.n9)("BABYLON.WebGL2ParticleSystem"))throw new Error("The WebGL2ParticleSystem class is not available! Make sure you have imported it.");this._platform=new((0,a.n9)("BABYLON.WebGL2ParticleSystem"))(this,this._engine)}this._customWrappers={0:new Ah.E(this._engine)},this._customWrappers[0].effect=r,this._drawWrappers={0:new Ah.E(this._engine)},this._drawWrappers[0].drawContext&&(this._drawWrappers[0].drawContext.useInstancing=!0),this._createIndexBuffer(),this._attachImageProcessingConfiguration(null),(t=t??{}).randomTextureSize||delete t.randomTextureSize;const l={capacity:5e4,randomTextureSize:this._engine.getCaps().maxTextureSize,...t},h=t;isFinite(h)&&(l.capacity=h),this._capacity=l.capacity,this._maxActiveParticleCount=l.capacity,this._currentActiveCount=0,this._isAnimationSheetEnabled=o,this.particleEmitterType=new RT;const c=Math.min(this._engine.getCaps().maxTextureSize,l.randomTextureSize);let u=[];for(let e=0;e<c;++e)u.push(Math.random()),u.push(Math.random()),u.push(Math.random()),u.push(Math.random());this._randomTexture=new He.I(new Float32Array(u),c,1,5,i,!1,!1,1,1),this._randomTexture.name="GPUParticleSystem_random1",this._randomTexture.wrapU=1,this._randomTexture.wrapV=1,u=[];for(let e=0;e<c;++e)u.push(Math.random()),u.push(Math.random()),u.push(Math.random()),u.push(Math.random());this._randomTexture2=new He.I(new Float32Array(u),c,1,5,i,!1,!1,1,1),this._randomTexture2.name="GPUParticleSystem_random2",this._randomTexture2.wrapU=1,this._randomTexture2.wrapV=1,this._randomTextureSize=c}_reset(){this._releaseBuffers()}_createVertexBuffers(e,t,i){const r={};r.position=t.createVertexBuffer("position",0,3,this._attributesStrideSize,!0);let s=3;r.age=t.createVertexBuffer("age",s,1,this._attributesStrideSize,!0),s+=1,r.size=t.createVertexBuffer("size",s,3,this._attributesStrideSize,!0),s+=3,r.life=t.createVertexBuffer("life",s,1,this._attributesStrideSize,!0),s+=1,s+=4,this.billboardMode===KT.BILLBOARDMODE_STRETCHED&&(r.direction=t.createVertexBuffer("direction",s,3,this._attributesStrideSize,!0)),s+=3,this._platform.alignDataInBuffer&&(s+=1),this.particleEmitterType instanceof FT&&(s+=3,this._platform.alignDataInBuffer&&(s+=1)),this._colorGradientsTexture||(r.color=t.createVertexBuffer("color",s,4,this._attributesStrideSize,!0),s+=4),this._isBillboardBased||(r.initialDirection=t.createVertexBuffer("initialDirection",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1)),this.noiseTexture&&(r.noiseCoordinates1=t.createVertexBuffer("noiseCoordinates1",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1),r.noiseCoordinates2=t.createVertexBuffer("noiseCoordinates2",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1)),r.angle=t.createVertexBuffer("angle",s,1,this._attributesStrideSize,!0),this._angularSpeedGradientsTexture?s++:s+=2,this._isAnimationSheetEnabled&&(r.cellIndex=t.createVertexBuffer("cellIndex",s,1,this._attributesStrideSize,!0),s+=1,this.spriteRandomStartCell&&(r.cellStartOffset=t.createVertexBuffer("cellStartOffset",s,1,this._attributesStrideSize,!0),s+=1)),r.offset=i.createVertexBuffer("offset",0,2),r.uv=i.createVertexBuffer("uv",2,2),this._renderVertexBuffers.push(r),this._platform.createVertexBuffers(e,r),this.resetDrawCache()}_initialize(e=!1){if(this._buffer0&&!e)return;const t=this._engine,i=[];this._attributesStrideSize=21,this._targetIndex=0,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1),this.particleEmitterType instanceof FT&&(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this.isBillboardBased||(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this._colorGradientsTexture&&(this._attributesStrideSize-=4),this._angularSpeedGradientsTexture&&(this._attributesStrideSize-=1),this._isAnimationSheetEnabled&&(this._attributesStrideSize+=1,this.spriteRandomStartCell&&(this._attributesStrideSize+=1)),this.noiseTexture&&(this._attributesStrideSize+=6,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=2)),this._platform.alignDataInBuffer&&(this._attributesStrideSize+=3-(this._attributesStrideSize+3&3));const r=this.particleEmitterType instanceof FT,s=n.AA.Vector3[0];let o=0;for(let e=0;e<this._capacity;e++)if(i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),r?(this.particleEmitterType.particleDestinationGenerator(e,null,s),i.push(s.x),i.push(s.y),i.push(s.z)):(i.push(0),i.push(0),i.push(0)),this._platform.alignDataInBuffer&&i.push(0),o+=16,r&&(this.particleEmitterType.particlePositionGenerator(e,null,s),i.push(s.x),i.push(s.y),i.push(s.z),this._platform.alignDataInBuffer&&i.push(0),o+=4),this._colorGradientsTexture||(i.push(0),i.push(0),i.push(0),i.push(0),o+=4),this.isBillboardBased||(i.push(0),i.push(0),i.push(0),this._platform.alignDataInBuffer&&i.push(0),o+=4),this.noiseTexture&&(i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),o+=8),i.push(0),o+=1,this._angularSpeedGradientsTexture||(i.push(0),o+=1),this._isAnimationSheetEnabled&&(i.push(0),o+=1,this.spriteRandomStartCell&&(i.push(0),o+=1)),this._platform.alignDataInBuffer){let e=3-(o+3&3);for(o+=e;e-- >0;)i.push(0)}const a=new Float32Array([.5,.5,1,1,-.5,.5,0,1,.5,-.5,1,0,-.5,-.5,0,0]),l=this._platform.createParticleBuffer(i),h=this._platform.createParticleBuffer(i);this._buffer0=new Ot.h(t,l,!1,this._attributesStrideSize),this._buffer1=new Ot.h(t,h,!1,this._attributesStrideSize),this._spriteBuffer=new Ot.h(t,a,!1,4),this._renderVertexBuffers=[],this._createVertexBuffers(this._buffer0,this._buffer1,this._spriteBuffer),this._createVertexBuffers(this._buffer1,this._buffer0,this._spriteBuffer),this._sourceBuffer=this._buffer0,this._targetBuffer=this._buffer1}_recreateUpdateEffect(){this._createColorGradientTexture(),this._createSizeGradientTexture(),this._createAngularSpeedGradientTexture(),this._createVelocityGradientTexture(),this._createLimitVelocityGradientTexture(),this._createDragGradientTexture();let e=this.particleEmitterType?this.particleEmitterType.getEffectDefines():"";return this._isBillboardBased&&(e+="\n#define BILLBOARD"),this._colorGradientsTexture&&(e+="\n#define COLORGRADIENTS"),this._sizeGradientsTexture&&(e+="\n#define SIZEGRADIENTS"),this._angularSpeedGradientsTexture&&(e+="\n#define ANGULARSPEEDGRADIENTS"),this._velocityGradientsTexture&&(e+="\n#define VELOCITYGRADIENTS"),this._limitVelocityGradientsTexture&&(e+="\n#define LIMITVELOCITYGRADIENTS"),this._dragGradientsTexture&&(e+="\n#define DRAGGRADIENTS"),this.isAnimationSheetEnabled&&(e+="\n#define ANIMATESHEET",this.spriteRandomStartCell&&(e+="\n#define ANIMATESHEETRANDOMSTART")),this.noiseTexture&&(e+="\n#define NOISE"),this.isLocal&&(e+="\n#define LOCAL"),this._platform.isUpdateBufferCreated()&&this._cachedUpdateDefines===e||(this._cachedUpdateDefines=e,this._updateBuffer=this._platform.createUpdateBuffer(e)),this._platform.isUpdateBufferReady()}_getWrapper(e){const t=this._getCustomDrawWrapper(e);if(t?.effect)return t;const i=[];this.fillDefines(i,e);let r=this._drawWrappers[e];r||(r=new Ah.E(this._engine),r.drawContext&&(r.drawContext.useInstancing=!0),this._drawWrappers[e]=r);const s=i.join("\n");if(r.defines!==s){const e=[],t=[],i=[];this.fillUniformsAttributesAndSamplerNames(t,e,i),r.setEffect(this._engine.createEffect("gpuRenderParticles",e,t,i,s),s)}return r}static _GetAttributeNamesOrOptions(e=!1,t=!1,i=!1,r=!1){const s=[Ot.R.PositionKind,"age","life","size","angle"];return e||s.push(Ot.R.ColorKind),t&&s.push("cellIndex"),i||s.push("initialDirection"),r&&s.push("direction"),s.push("offset",Ot.R.UVKind),s}static _GetEffectCreationOptions(e=!1,t=!1,i=!1){const r=["emitterWM","worldOffset","view","projection","colorDead","invView","translationPivot","eyePosition"];return(0,es.TV)(r),e&&r.push("sheetInfos"),t&&r.push("logarithmicDepthConstant"),i&&(r.push("vFogInfos"),r.push("vFogColor")),r}fillDefines(e,t=0,i=!0){if(this._scene&&((0,es.tv)(this,this._scene,e),this.applyFog&&this._scene.fogEnabled&&this._scene.fogMode!==it.Z.FOGMODE_NONE&&e.push("#define FOG")),t===KT.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this.isLocal&&e.push("#define LOCAL"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case KT.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case KT.BILLBOARDMODE_STRETCHED:e.push("#define BILLBOARDSTRETCHED");break;case KT.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL")}this._colorGradientsTexture&&e.push("#define COLORGRADIENTS"),this.isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),i&&this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(""+this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,i){t.push(...JC._GetAttributeNamesOrOptions(!!this._colorGradientsTexture,this._isAnimationSheetEnabled,this._isBillboardBased,this._isBillboardBased&&this.billboardMode===KT.BILLBOARDMODE_STRETCHED)),e.push(...JC._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth,this.applyFog)),i.push("diffuseSampler","colorGradientSampler"),this._imageProcessingConfiguration&&(Sr.p.PrepareUniforms(e,this._imageProcessingConfigurationDefines),Sr.p.PrepareSamplers(i,this._imageProcessingConfigurationDefines))}animate(e=!1){this._timeDelta=this.updateSpeed*(e?this.preWarmStepOffset:this._scene?.getAnimationRatio()||1),this._actualFrame+=this._timeDelta,this._stopped||this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop(),this.updateInAnimate&&this._update()}_createFactorGradientTexture(e,t){const i=this[t];if(!e||!e.length||i)return;const r=new Float32Array(this._rawTextureWidth);for(let t=0;t<this._rawTextureWidth;t++){const i=t/this._rawTextureWidth;TT.GetCurrentGradient(i,e,((e,i,s)=>{r[t]=(0,yt.Lerp)(e.factor1,i.factor1,s)}))}this[t]=He.I.CreateRTexture(r,this._rawTextureWidth,1,this._scene||this._engine,!1,!1,1),this[t].name=t.substring(1)}_createSizeGradientTexture(){this._createFactorGradientTexture(this._sizeGradients,"_sizeGradientsTexture")}_createAngularSpeedGradientTexture(){this._createFactorGradientTexture(this._angularSpeedGradients,"_angularSpeedGradientsTexture")}_createVelocityGradientTexture(){this._createFactorGradientTexture(this._velocityGradients,"_velocityGradientsTexture")}_createLimitVelocityGradientTexture(){this._createFactorGradientTexture(this._limitVelocityGradients,"_limitVelocityGradientsTexture")}_createDragGradientTexture(){this._createFactorGradientTexture(this._dragGradients,"_dragGradientsTexture")}_createColorGradientTexture(){if(!this._colorGradients||!this._colorGradients.length||this._colorGradientsTexture)return;const e=new Uint8Array(4*this._rawTextureWidth),t=o.IG.Color4[0];for(let i=0;i<this._rawTextureWidth;i++){const r=i/this._rawTextureWidth;TT.GetCurrentGradient(r,this._colorGradients,((r,s,n)=>{o.ov.LerpToRef(r.color1,s.color1,n,t),e[4*i]=255*t.r,e[4*i+1]=255*t.g,e[4*i+2]=255*t.b,e[4*i+3]=255*t.a}))}this._colorGradientsTexture=He.I.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1),this._colorGradientsTexture.name="colorGradients"}_render(e,t){const i=this._getWrapper(e),r=i.effect;this._engine.enableEffect(i);const s=this._scene?.getViewMatrix()||n.uq.IdentityReadOnly;if(r.setMatrix("view",s),r.setMatrix("projection",this.defaultProjectionMatrix??this._scene.getProjectionMatrix()),r.setTexture("diffuseSampler",this.particleTexture),r.setVector2("translationPivot",this.translationPivot),r.setVector3("worldOffset",this.worldOffset),this.isLocal&&r.setMatrix("emitterWM",t),this._colorGradientsTexture?r.setTexture("colorGradientSampler",this._colorGradientsTexture):r.setDirectColor4("colorDead",this.colorDead),this._isAnimationSheetEnabled&&this.particleTexture){const e=this.particleTexture.getBaseSize();r.setFloat3("sheetInfos",this.spriteCellWidth/e.width,this.spriteCellHeight/e.height,e.width/this.spriteCellWidth)}if(this._isBillboardBased&&this._scene){const e=this._scene.activeCamera;r.setVector3("eyePosition",e.globalPosition)}const o=r.defines;if(this._scene&&((0,es.gS)(r,this,this._scene),this.applyFog&&(0,ts.Yy)(this._scene,void 0,r)),o.indexOf("#define BILLBOARDMODE_ALL")>=0){const e=s.clone();e.invert(),r.setMatrix("invView",e)}switch(this.useLogarithmicDepth&&this._scene&&(0,ts.DL)(o,r,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(r),e){case KT.BLENDMODE_ADD:this._engine.setAlphaMode(1);break;case KT.BLENDMODE_ONEONE:this._engine.setAlphaMode(6);break;case KT.BLENDMODE_STANDARD:this._engine.setAlphaMode(2);break;case KT.BLENDMODE_MULTIPLY:this._engine.setAlphaMode(4)}return this._platform.bindDrawBuffers(this._targetIndex,r,this._scene?.forceWireframe?this._linesIndexBufferUseInstancing:null),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(r),this._scene?.forceWireframe?this._engine.drawElementsType(6,0,10,this._currentActiveCount):this._engine.drawArraysType(7,0,4,this._currentActiveCount),this._engine.setAlphaMode(0),this._scene?.forceWireframe&&this._engine.unbindInstanceAttributes(),this._currentActiveCount}_update(e){if(!this.emitter||!this._targetBuffer)return;if(!this._recreateUpdateEffect()||this._rebuildingAfterContextLost)return;if(!e)if(this.emitter.position){e=this.emitter.getWorldMatrix()}else{const t=this.emitter;e=n.AA.Matrix[0],n.uq.TranslationToRef(t.x,t.y,t.z,e)}const t=this._engine,i=t.getDepthWrite();t.setDepthWrite(!1),this._platform.preUpdateParticleBuffer(),this._updateBuffer.setFloat("currentCount",this._currentActiveCount),this._updateBuffer.setFloat("timeDelta",this._timeDelta),this._updateBuffer.setFloat("stopFactor",this._stopped?0:1),this._updateBuffer.setInt("randomTextureSize",this._randomTextureSize),this._updateBuffer.setFloat2("lifeTime",this.minLifeTime,this.maxLifeTime),this._updateBuffer.setFloat2("emitPower",this.minEmitPower,this.maxEmitPower),this._colorGradientsTexture||(this._updateBuffer.setDirectColor4("color1",this.color1),this._updateBuffer.setDirectColor4("color2",this.color2)),this._updateBuffer.setFloat2("sizeRange",this.minSize,this.maxSize),this._updateBuffer.setFloat4("scaleRange",this.minScaleX,this.maxScaleX,this.minScaleY,this.maxScaleY),this._updateBuffer.setFloat4("angleRange",this.minAngularSpeed,this.maxAngularSpeed,this.minInitialRotation,this.maxInitialRotation),this._updateBuffer.setVector3("gravity",this.gravity),this._limitVelocityGradientsTexture&&this._updateBuffer.setFloat("limitVelocityDamping",this.limitVelocityDamping),this.particleEmitterType&&this.particleEmitterType.applyToShader(this._updateBuffer),this._isAnimationSheetEnabled&&this._updateBuffer.setFloat4("cellInfos",this.startSpriteCellID,this.endSpriteCellID,this.spriteCellChangeSpeed,this.spriteCellLoop?1:0),this.noiseTexture&&this._updateBuffer.setVector3("noiseStrength",this.noiseStrength),this.isLocal||this._updateBuffer.setMatrix("emitterWM",e),this._platform.updateParticleBuffer(this._targetIndex,this._targetBuffer,this._currentActiveCount),this._targetIndex++,2===this._targetIndex&&(this._targetIndex=0);const r=this._sourceBuffer;this._sourceBuffer=this._targetBuffer,this._targetBuffer=r,t.setDepthWrite(i)}render(e=!1,t=!1){if(!this._started)return 0;if(!this.isReady())return 0;if(!e&&this._scene){if(!this._preWarmDone&&this.preWarmCycles){for(let e=0;e<this.preWarmCycles;e++)this.animate(!0),this.render(!0,!0);this._preWarmDone=!0}if(this._currentRenderId===this._scene.getRenderId()&&(!this._scene.activeCamera||this._scene.activeCamera&&this._currentRenderingCameraUniqueId===this._scene.activeCamera.uniqueId))return 0;this._currentRenderId=this._scene.getRenderId(),this._scene.activeCamera&&(this._currentRenderingCameraUniqueId=this._scene.activeCamera.uniqueId)}if(this._initialize(),this.manualEmitCount>-1?(this._accumulatedCount+=this.manualEmitCount,this.manualEmitCount=0):this._accumulatedCount+=this.emitRate*this._timeDelta,this._accumulatedCount>=1){const e=0|this._accumulatedCount;this._accumulatedCount-=e,this._currentActiveCount+=e}if(this._currentActiveCount=Math.min(this._maxActiveParticleCount,this._currentActiveCount),!this._currentActiveCount)return 0;let i;if(this.emitter.position){i=this.emitter.getWorldMatrix()}else{const e=this.emitter;i=n.AA.Matrix[0],n.uq.TranslationToRef(e.x,e.y,e.z,i)}const r=this._engine;this.updateInAnimate||this._update(i);let s=0;return e||t||(r.setState(!1),this.forceDepthWrite&&r.setDepthWrite(!0),s=this.blendMode===KT.BLENDMODE_MULTIPLYADD?this._render(KT.BLENDMODE_MULTIPLY,i)+this._render(KT.BLENDMODE_ADD,i):this._render(this.blendMode,i),this._engine.setAlphaMode(0)),s}rebuild(){const e=()=>{this._recreateUpdateEffect()&&this._platform.isUpdateBufferReady()?(this._initialize(!0),this._rebuildingAfterContextLost=!1):setTimeout(e,10)};this._createIndexBuffer(),this._cachedUpdateDefines="",this._platform.contextLost(),this._rebuildingAfterContextLost=!0,e()}_releaseBuffers(){this._buffer0&&(this._buffer0.dispose(),this._buffer0=null),this._buffer1&&(this._buffer1.dispose(),this._buffer1=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._platform.releaseBuffers()}dispose(e=!0){for(const e in this._drawWrappers){this._drawWrappers[e].dispose()}if(this._drawWrappers={},this._scene){const e=this._scene.particleSystems.indexOf(this);e>-1&&this._scene.particleSystems.splice(e,1)}this._releaseBuffers(),this._platform.releaseVertexBuffers();for(let e=0;e<this._renderVertexBuffers.length;++e){const t=this._renderVertexBuffers[e];for(const e in t)t[e].dispose()}this._renderVertexBuffers=[],this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null),this._sizeGradientsTexture&&(this._sizeGradientsTexture.dispose(),this._sizeGradientsTexture=null),this._angularSpeedGradientsTexture&&(this._angularSpeedGradientsTexture.dispose(),this._angularSpeedGradientsTexture=null),this._velocityGradientsTexture&&(this._velocityGradientsTexture.dispose(),this._velocityGradientsTexture=null),this._limitVelocityGradientsTexture&&(this._limitVelocityGradientsTexture.dispose(),this._limitVelocityGradientsTexture=null),this._dragGradientsTexture&&(this._dragGradientsTexture.dispose(),this._dragGradientsTexture=null),this._randomTexture&&(this._randomTexture.dispose(),this._randomTexture=null),this._randomTexture2&&(this._randomTexture2.dispose(),this._randomTexture2=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this.onStoppedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}clone(e,t,i=!1){const r={...this._customWrappers};let s=null;const n=this._engine;if(n.createEffectForParticles&&null!=this.customShader){s=this.customShader;const e=s.shaderOptions.defines.length>0?s.shaderOptions.defines.join("\n"):"";r[0]=n.createEffectForParticles(s.shaderPath.fragmentElement,s.shaderOptions.uniforms,s.shaderOptions.samplers,e,void 0,void 0,void 0,this)}const o=this.serialize(i),a=JC.Parse(o,this._scene||this._engine,this._rootUrl);return a.name=e,a.customShader=s,a._customWrappers=r,void 0===t&&(t=this.emitter),this.noiseTexture&&(a.noiseTexture=this.noiseTexture.clone()),a.emitter=t,a}serialize(e=!1){const t={};return KT._Serialize(t,this,e),t.activeParticleCount=this.activeParticleCount,t.randomTextureSize=this._randomTextureSize,t.customShader=this.customShader,t}static Parse(e,t,i,r=!1,s){const n=e.name;let o,a;t instanceof $.$?o=t:(a=t,o=a.getEngine());const l=new JC(n,{capacity:s||e.capacity,randomTextureSize:e.randomTextureSize},t,null,e.isAnimationSheetEnabled);if(l._rootUrl=i,e.customShader&&o.createEffectForParticles){const t=e.customShader,i=t.shaderOptions.defines.length>0?t.shaderOptions.defines.join("\n"):"",r=o.createEffectForParticles(t.shaderPath.fragmentElement,t.shaderOptions.uniforms,t.shaderOptions.samplers,i,void 0,void 0,void 0,l);l.setCustomEffect(r,0),l.customShader=t}return e.id&&(l.id=e.id),e.activeParticleCount&&(l.activeParticleCount=e.activeParticleCount),KT._Parse(e,l,t,i),e.preventAutoStart&&(l.preventAutoStart=e.preventAutoStart),r||l.preventAutoStart||l.start(),l}}class eE{constructor(){this._emitterNodeIsOwned=!0,this.systems=[]}get emitterNode(){return this._emitterNode}set emitterNode(e){this._emitterNodeIsOwned&&this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!1);for(const t of this.systems)t.emitter=e;this._emitterNode=e}setEmitterAsSphere(e,t,i){this._emitterNodeIsOwned&&this._emitterNode&&this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!0,this._emitterCreationOptions={kind:"Sphere",options:e,renderingGroupId:t};const r=zs("emitterSphere",{diameter:e.diameter,segments:e.segments},i);r.renderingGroupId=t;const s=new br.F("emitterSphereMaterial",i);s.emissiveColor=e.color,r.material=s;for(const e of this.systems)e.emitter=r;this._emitterNode=r}start(e){for(const t of this.systems)e&&(t.emitter=e),t.start()}dispose(){for(const e of this.systems)e.dispose();this.systems.length=0,this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNode=null)}serialize(e=!1){const t={systems:[]};for(const i of this.systems)t.systems.push(i.serialize(e));return this._emitterNode&&(t.emitter=this._emitterCreationOptions),t}static Parse(e,t,i=!1,r){const s=new eE,n=this.BaseAssetsUrl+"/textures/";t=t||C.q.LastCreatedScene;for(const o of e.systems)s.systems.push(i?JC.Parse(o,t,n,!0,r):KT.Parse(o,t,n,!0,r));if(e.emitter){const i=e.emitter.options;if("Sphere"===e.emitter.kind)s.setEmitterAsSphere({diameter:i.diameter,segments:i.segments,color:o.v9.FromArray(i.color)},e.emitter.renderingGroupId,t)}return s}}eE.BaseAssetsUrl="https://assets.babylonjs.com/particles";class tE{static CreateDefault(e,t=500,i,r=!1){let s;s=r?new JC("default system",{capacity:t},i):new KT("default system",t,i),s.emitter=e;const n=H.S0.GetAssetUrl("https://assets.babylonjs.com/core/textures/flare.png");return s.particleTexture=new $e.g(n,s.getScene()),s.createConeEmitter(.1,Math.PI/4),s.color1=new o.ov(1,1,1,1),s.color2=new o.ov(1,1,1,1),s.colorDead=new o.ov(1,1,1,0),s.minSize=.1,s.maxSize=.1,s.minEmitPower=2,s.maxEmitPower=2,s.updateSpeed=1/60,s.emitRate=30,s}static CreateAsync(e,t,i=!1,r){t||(t=C.q.LastCreatedScene);const s={};return t.addPendingData(s),new Promise(((n,o)=>{if(i&&!JC.IsSupported)return t.removePendingData(s),o("Particle system with GPU is not supported.");H.S0.LoadFile(`${tE.BaseAssetsUrl}/systems/${e}.json`,(e=>{t.removePendingData(s);const o=JSON.parse(e.toString());return n(eE.Parse(o,t,i,r))}),void 0,void 0,void 0,(()=>(t.removePendingData(s),o(`An error occurred with the creation of your particle system. Check if your type '${e}' exists.`))))}))}static ExportSet(e){const t=new eE;for(const i of e)t.systems.push(i);return t}static ParseFromFileAsync(e,t,i,r=!1,s="",n){return new Promise(((o,a)=>{const l=new Kr.u;l.addEventListener("readystatechange",(()=>{if(4==l.readyState)if(200==l.status){const t=JSON.parse(l.responseText);let a;a=r?JC.Parse(t,i,s,!1,n):KT.Parse(t,i,s,!1,n),e&&(a.name=e),o(a)}else a("Unable to load the particle system")})),l.open("GET",t),l.send()}))}static ParseFromSnippetAsync(e,t,i=!1,r="",s){if("_BLANK"===e){const e=this.CreateDefault(null);return e.start(),Promise.resolve(e)}return new Promise(((n,o)=>{const a=new Kr.u;a.addEventListener("readystatechange",(()=>{if(4==a.readyState)if(200==a.status){const o=JSON.parse(JSON.parse(a.responseText).jsonPayload),l=JSON.parse(o.particleSystem);let h;h=i?JC.Parse(l,t,r,!1,s):KT.Parse(l,t,r,!1,s),h.snippetId=e,n(h)}else o("Unable to load the snippet "+e)})),a.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),a.send()}))}}tE.BaseAssetsUrl=eE.BaseAssetsUrl,tE.SnippetUrl="https://snippet.babylonjs.com",tE.CreateFromSnippetAsync=tE.ParseFromSnippetAsync,(0,Ep.ji)(Ei.v.NAME_PARTICLESYSTEM,((e,t,i,r)=>{const s=(0,Ep.LO)(Ei.v.NAME_PARTICLESYSTEM);if(s&&void 0!==e.particleSystems&&null!==e.particleSystems)for(let n=0,o=e.particleSystems.length;n<o;n++){const o=e.particleSystems[n];i.particleSystems.push(s(o,t,r))}})),(0,Ep.cf)(Ei.v.NAME_PARTICLESYSTEM,((e,t,i)=>{if(e.activeParticleCount){return JC.Parse(e,t,i)}return KT.Parse(e,t,i)})),$.$.prototype.createEffectForParticles=function(e,t=[],r=[],s="",n,o,a,l,h=0,c){let u=[],d=[];const p=[];return l?l.fillUniformsAttributesAndSamplerNames(d,u,p):(u=KT._GetAttributeNamesOrOptions(),d=KT._GetEffectCreationOptions()),-1===s.indexOf(" BILLBOARD")&&(s+="\n#define BILLBOARD\n"),l?.isAnimationSheetEnabled&&-1===s.indexOf(" ANIMATESHEET")&&(s+="\n#define ANIMATESHEET\n"),-1===r.indexOf("diffuseSampler")&&r.push("diffuseSampler"),this.createEffect({vertex:c??l?.vertexShaderName??"particles",fragmentElement:e},u,d.concat(t),p.concat(r),s,n,o,a,void 0,h,(async()=>{0===h?await Promise.resolve().then(i.bind(i,59384)):await Promise.resolve().then(i.bind(i,27323))}))},tt.e.prototype.getEmittedParticleSystems=function(){const e=[];for(let t=0;t<this.getScene().particleSystems.length;t++){const i=this.getScene().particleSystems[t];i.emitter===this&&e.push(i)}return e},tt.e.prototype.getHierarchyEmittedParticleSystems=function(){const e=[],t=this.getDescendants();t.push(this);for(let i=0;i<this.getScene().particleSystems.length;i++){const r=this.getScene().particleSystems[i],s=r.emitter;s.position&&-1!==t.indexOf(s)&&e.push(r)}return e};class iE{getBoundingInfo(){return this._boundingInfo}get hasBoundingInfo(){return null!==this._boundingInfo}constructor(e,t,i,r,s,a,l,h,c=null,u=null){this.idx=0,this.id=0,this.color=new o.ov(1,1,1,1),this.position=n.Pq.Zero(),this.rotation=n.Pq.Zero(),this.scaling=n.Pq.One(),this.uvs=new n.IU(0,0,1,1),this.velocity=n.Pq.Zero(),this.pivot=n.Pq.Zero(),this.translateFromPivot=!1,this.alive=!0,this.isVisible=!0,this._pos=0,this._ind=0,this.shapeId=0,this.idxInShape=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this.materialIndex=null,this.props=null,this.cullingStrategy=Ps.u.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this._globalPosition=n.Pq.Zero(),this.idx=e,this.id=t,this._pos=i,this._ind=r,this._model=s,this.shapeId=a,this.idxInShape=l,this._sps=h,c&&(this._modelBoundingInfo=c,this._boundingInfo=new fs.j(c.minimum,c.maximum)),null!==u&&(this.materialIndex=u)}copyToRef(e){return e.position.copyFrom(this.position),e.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(e.rotationQuaternion?e.rotationQuaternion.copyFrom(this.rotationQuaternion):e.rotationQuaternion=this.rotationQuaternion.clone()),e.scaling.copyFrom(this.scaling),this.color&&(e.color?e.color.copyFrom(this.color):e.color=this.color.clone()),e.uvs.copyFrom(this.uvs),e.velocity.copyFrom(this.velocity),e.pivot.copyFrom(this.pivot),e.translateFromPivot=this.translateFromPivot,e.alive=this.alive,e.isVisible=this.isVisible,e.parentId=this.parentId,e.cullingStrategy=this.cullingStrategy,null!==this.materialIndex&&(e.materialIndex=this.materialIndex),this}get scale(){return this.scaling}set scale(e){this.scaling=e}get quaternion(){return this.rotationQuaternion}set quaternion(e){this.rotationQuaternion=e}intersectsMesh(e){return!(!this._boundingInfo||!e.hasBoundingInfo)&&(this._sps._bSphereOnly?vs.i.Intersects(this._boundingInfo.boundingSphere,e.getBoundingInfo().boundingSphere):this._boundingInfo.intersects(e.getBoundingInfo(),!1))}isInFrustum(e){return null!==this._boundingInfo&&this._boundingInfo.isInFrustum(e,this.cullingStrategy)}getRotationMatrix(e){let t;if(this.rotationQuaternion)t=this.rotationQuaternion;else{t=n.AA.Quaternion[0];const e=this.rotation;n.PT.RotationYawPitchRollToRef(e.y,e.x,e.z,t)}t.toRotationMatrix(e)}}class rE{get shapeID(){return this.shapeId}set shapeID(e){this.shapeId=e}constructor(e,t,i,r,s,n,o,a,l){this._indicesLength=0,this.shapeId=e,this._shape=t,this._indices=i,this._indicesLength=i.length,this._shapeUV=n,this._shapeColors=s,this._normals=r,this._positionFunction=o,this._vertexFunction=a,this._material=l}}class sE{constructor(e,t,i,r){this.idx=0,this.ind=0,this.indicesLength=0,this.sqDistance=0,this.materialIndex=0,this.idx=e,this.ind=t,this.indicesLength=i,this.materialIndex=r}}class nE{constructor(){this.position=n.Pq.Zero(),this.color=new o.ov(1,1,1,1),this.uv=n.I9.Zero()}get x(){return this.position.x}set x(e){this.position.x=e}get y(){return this.position.y}set y(e){this.position.y=e}get z(){return this.position.z}set z(e){this.position.z=e}}class oE{constructor(e,t,i){this.particles=new Array,this.nbParticles=0,this.billboard=!1,this.recomputeNormals=!1,this.counter=0,this.vars={},this._bSphereOnly=!1,this._bSphereRadiusFactor=1,this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._index=0,this._updatable=!0,this._pickable=!1,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._depthSort=!1,this._expandable=!1,this._shapeCounter=0,this._copy=new iE(0,0,0,0,null,0,0,this),this._color=new o.ov(0,0,0,0),this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeParticleVertex=!1,this._computeBoundingBox=!1,this._autoFixFaceOrientation=!1,this._depthSortParticles=!0,this._mustUnrotateFixedNormals=!1,this._particlesIntersect=!1,this._needs32Bits=!1,this._isNotBuilt=!0,this._lastParticleId=0,this._idxOfId=[],this._multimaterialEnabled=!1,this._useModelMaterial=!1,this._depthSortFunction=(e,t)=>t.sqDistance-e.sqDistance,this._materialSortFunction=(e,t)=>e.materialIndex-t.materialIndex,this._autoUpdateSubMeshes=!1,this._recomputeInvisibles=!1,this.name=e,this._scene=t||C.q.LastCreatedScene,this._camera=t.activeCamera,this._pickable=!!i&&i.isPickable,this._depthSort=!!i&&i.enableDepthSort,this._multimaterialEnabled=!!i&&i.enableMultiMaterial,this._useModelMaterial=!!i&&i.useModelMaterial,this._multimaterialEnabled=!!this._useModelMaterial||this._multimaterialEnabled,this._expandable=!!i&&i.expandable,this._particlesIntersect=!!i&&i.particleIntersection,this._bSphereOnly=!!i&&i.boundingSphereOnly,this._bSphereRadiusFactor=i&&i.bSphereRadiusFactor?i.bSphereRadiusFactor:1,this._computeBoundingBox=!!i?.computeBoundingBox&&i.computeBoundingBox,this._autoFixFaceOrientation=!!i?.autoFixFaceOrientation&&i.autoFixFaceOrientation,i&&void 0!==i.updatable?this._updatable=i.updatable:this._updatable=!0,this._pickable&&(this.pickedBySubMesh=[[]],this.pickedParticles=this.pickedBySubMesh[0]),(this._depthSort||this._multimaterialEnabled)&&(this.depthSortedParticles=[]),this._multimaterialEnabled&&(this._multimaterial=new gm.F(this.name+"MultiMaterial",this._scene),this._materials=[],this._materialIndexesById={}),this._tmpVertex=new nE}buildMesh(){if(!this._isNotBuilt&&this.mesh)return this.mesh;if(0===this.nbParticles&&!this.mesh){const e=rn("",{radius:1,tessellation:3},this._scene);this.addShape(e,1),e.dispose()}if(this._indices32=this._needs32Bits?new Uint32Array(this._indices):new Uint16Array(this._indices),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors),!this.mesh){const e=new tt.e(this.name,this._scene);this.mesh=e}!this._updatable&&this._multimaterialEnabled&&this._sortParticlesByMaterial(),this.recomputeNormals&&ot.P.ComputeNormals(this._positions32,this._indices32,this._normals),this._normals32=new Float32Array(this._normals),this._fixedNormal32=new Float32Array(this._normals),this._mustUnrotateFixedNormals&&this._unrotateFixedNormals();const e=new ot.P;if(e.indices=this._depthSort?this._indices:this._indices32,e.set(this._positions32,Ot.R.PositionKind),e.set(this._normals32,Ot.R.NormalKind),this._uvs32.length>0&&e.set(this._uvs32,Ot.R.UVKind),this._colors32.length>0&&e.set(this._colors32,Ot.R.ColorKind),e.applyToMesh(this.mesh,this._updatable),this.mesh.isPickable=this._pickable,this._pickable){let e=0;for(let t=0;t<this.nbParticles;t++){const i=this.particles[t],r=i._model._indicesLength;for(let t=0;t<r;t++){if(0==t%3){const t={idx:i.idx,faceId:e};this.pickedParticles[e]=t,e++}}}}return this._multimaterialEnabled&&this.setMultiMaterial(this._materials),this._expandable||(this._depthSort||this._multimaterialEnabled||this._autoFixFaceOrientation||(this._indices=null),this._positions=null,this._normals=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0)),this._isNotBuilt=!1,this.recomputeNormals=!1,this._recomputeInvisibles=!0,this.mesh}_getUVKind(e,t){return-1===t&&(e.material?.diffuseTexture?t=e.material.diffuseTexture.coordinatesIndex:e.material?.albedoTexture&&(t=e.material.albedoTexture.coordinatesIndex)),"uv"+(t?t+1:"")}digest(e,t){let i=t&&t.facetNb||1,r=t&&t.number||0,s=t&&t.delta||0;const o=e.getVerticesData(Ot.R.PositionKind),a=e.getIndices(),l=e.getVerticesData(this._getUVKind(e,t?.uvKind??0)),h=e.getVerticesData(Ot.R.ColorKind),c=e.getVerticesData(Ot.R.NormalKind),u=t&&t.storage?t.storage:null;let d=0;const p=a.length/3;r?(r=r>p?p:r,i=Math.round(p/r),s=0):i=i>p?p:i;const m=[],f=[],_=[],g=[],x=[],v=n.Pq.Zero(),S=i;for(;d<p;){i=S+Math.floor((1+s)*Math.random()),d>p-i&&(i=p-d),m.length=0,f.length=0,_.length=0,g.length=0,x.length=0;let t=0;for(let e=3*d;e<3*(d+i);e++){_.push(t);const i=a[e],r=3*i;if(m.push(o[r],o[r+1],o[r+2]),f.push(c[r],c[r+1],c[r+2]),l){const e=2*i;g.push(l[e],l[e+1])}if(h){const e=4*i;x.push(h[e],h[e+1],h[e+2],h[e+3])}t++}let r=this.nbParticles;const b=this._posToShape(m),y=this._uvsToShapeUV(g),P=_.slice(),T=x.slice(),C=f.slice();let E;for(v.copyFromFloats(0,0,0),E=0;E<b.length;E++)v.addInPlace(b[E]);v.scaleInPlace(1/b.length);const A=new n.Pq(1/0,1/0,1/0),I=new n.Pq(-1/0,-1/0,-1/0);for(E=0;E<b.length;E++)b[E].subtractInPlace(v),A.minimizeInPlaceFromFloats(b[E].x,b[E].y,b[E].z),I.maximizeInPlaceFromFloats(b[E].x,b[E].y,b[E].z);let R;this._particlesIntersect&&(R=new fs.j(A,I));let M=null;this._useModelMaterial&&(M=e.material?e.material:this._setDefaultMaterial());const D=new rE(this._shapeCounter,b,P,C,T,y,null,null,M),O=this._positions.length,N=this._indices.length;this._meshBuilder(this._index,N,b,this._positions,P,this._indices,g,this._uvs,T,this._colors,C,this._normals,r,0,null,D),this._addParticle(r,this._lastParticleId,O,N,D,this._shapeCounter,0,R,u),this.particles[this.nbParticles].position.addInPlace(v),u||(this._index+=b.length,r++,this.nbParticles++,this._lastParticleId++),this._shapeCounter++,d+=i}return this._isNotBuilt=!0,this}_unrotateFixedNormals(){let e=0,t=0;const i=n.AA.Vector3[0],r=n.AA.Quaternion[0],s=n.AA.Matrix[0];for(let o=0;o<this.particles.length;o++){const a=this.particles[o],l=a._model._shape;if(a.rotationQuaternion)a.rotationQuaternion.conjugateToRef(r);else{const e=a.rotation;n.PT.RotationYawPitchRollToRef(e.y,e.x,e.z,r),r.conjugateInPlace()}r.toRotationMatrix(s);for(let r=0;r<l.length;r++)t=e+3*r,n.Pq.TransformNormalFromFloatsToRef(this._normals32[t],this._normals32[t+1],this._normals32[t+2],s,i),i.toArray(this._fixedNormal32,t);e=t+3}}_resetCopy(){const e=this._copy;e.position.setAll(0),e.rotation.setAll(0),e.rotationQuaternion=null,e.scaling.setAll(1),e.uvs.copyFromFloats(0,0,1,1),e.color=null,e.translateFromPivot=!1,e.shapeId=0,e.materialIndex=null}_meshBuilder(e,t,i,r,s,o,a,l,h,c,u,d,p,m,f,_){let g,x=0,v=0,S=0;this._resetCopy();const b=this._copy,y=!(!f||!f.storage);if(b.idx=p,b.idxInShape=m,b.shapeId=_.shapeId,this._useModelMaterial){const e=_._material.uniqueId,t=this._materialIndexesById;Object.prototype.hasOwnProperty.call(t,e)||(t[e]=this._materials.length,this._materials.push(_._material));const i=t[e];b.materialIndex=i}if(f&&f.positionFunction&&(f.positionFunction(b,p,m),this._mustUnrotateFixedNormals=!0),y)return b;const P=n.AA.Matrix[0],T=this._tmpVertex,C=T.position,E=T.color,A=T.uv,I=n.AA.Vector3[1],R=n.AA.Vector3[2],M=n.AA.Vector3[3];n.uq.IdentityToRef(P),b.getRotationMatrix(P),b.pivot.multiplyToRef(b.scaling,M),b.translateFromPivot?R.setAll(0):R.copyFrom(M);const D=f&&f.vertexFunction;for(g=0;g<i.length;g++){if(C.copyFrom(i[g]),b.color&&E.copyFrom(b.color),a&&A.copyFromFloats(a[x],a[x+1]),D&&f.vertexFunction(b,T,g),C.multiplyInPlace(b.scaling).subtractInPlace(M),n.Pq.TransformCoordinatesToRef(C,P,I),I.addInPlace(R).addInPlace(b.position),r.push(I.x,I.y,I.z),a){const e=b.uvs;l.push((e.z-e.x)*A.x+e.x,(e.w-e.y)*A.y+e.y),x+=2}if(b.color)this._color.copyFrom(E);else{const e=this._color;h&&void 0!==h[v]?(e.r=h[v],e.g=h[v+1],e.b=h[v+2],e.a=h[v+3]):(e.r=1,e.g=1,e.b=1,e.a=1)}c.push(this._color.r,this._color.g,this._color.b,this._color.a),v+=4,!this.recomputeNormals&&u&&(n.Pq.TransformNormalFromFloatsToRef(u[S],u[S+1],u[S+2],P,C),d.push(C.x,C.y,C.z),S+=3)}for(g=0;g<s.length;g++){const t=e+s[g];o.push(t),t>65535&&(this._needs32Bits=!0)}if(this._depthSort||this._multimaterialEnabled){const e=null!==b.materialIndex?b.materialIndex:0;this.depthSortedParticles.push(new sE(p,t,s.length,e))}return b}_posToShape(e){const t=[];for(let i=0;i<e.length;i+=3)t.push(n.Pq.FromArray(e,i));return t}_uvsToShapeUV(e){const t=[];if(e)for(let i=0;i<e.length;i++)t.push(e[i]);return t}_addParticle(e,t,i,r,s,n,o,a=null,l=null){const h=new iE(e,t,i,r,s,n,o,this,a);return(l||this.particles).push(h),h}addShape(e,t,i){const r=e.getVerticesData(Ot.R.PositionKind),s=e.getIndices(),n=e.getVerticesData(Ot.R.UVKind),o=e.getVerticesData(Ot.R.ColorKind),a=e.getVerticesData(Ot.R.NormalKind);this.recomputeNormals=!a;const l=Array.from(s),h=a?Array.from(a):[],c=o?Array.from(o):[],u=i&&i.storage?i.storage:null;let d=null;this._particlesIntersect&&(d=e.getBoundingInfo());const p=this._posToShape(r),m=this._uvsToShapeUV(n),f=i?i.positionFunction:null,_=i?i.vertexFunction:null;let g=null;this._useModelMaterial&&(g=e.material?e.material:this._setDefaultMaterial());const x=new rE(this._shapeCounter,p,l,h,c,m,f,_,g);for(let e=0;e<t;e++)this._insertNewParticle(this.nbParticles,e,x,p,s,n,o,a,d,u,i);return this._shapeCounter++,this._isNotBuilt=!0,this._shapeCounter-1}_rebuildParticle(e,t=!1){this._resetCopy();const i=this._copy;e._model._positionFunction&&e._model._positionFunction(i,e.idx,e.idxInShape);const r=n.AA.Matrix[0],s=n.AA.Vector3[0],o=n.AA.Vector3[1],a=n.AA.Vector3[2],l=n.AA.Vector3[3];i.getRotationMatrix(r),e.pivot.multiplyToRef(e.scaling,l),i.translateFromPivot?a.copyFromFloats(0,0,0):a.copyFrom(l);const h=e._model._shape;for(let t=0;t<h.length;t++)s.copyFrom(h[t]),e._model._vertexFunction&&e._model._vertexFunction(i,s,t),s.multiplyInPlace(i.scaling).subtractInPlace(l),n.Pq.TransformCoordinatesToRef(s,r,o),o.addInPlace(a).addInPlace(i.position).toArray(this._positions32,e._pos+3*t);t&&(e.position.setAll(0),e.rotation.setAll(0),e.rotationQuaternion=null,e.scaling.setAll(1),e.uvs.setAll(0),e.pivot.setAll(0),e.translateFromPivot=!1,e.parentId=null)}rebuildMesh(e=!1){for(let t=0;t<this.particles.length;t++)this._rebuildParticle(this.particles[t],e);return this.mesh.updateVerticesData(Ot.R.PositionKind,this._positions32,!1,!1),this}removeParticles(e,t){const i=t-e+1;if(!this._expandable||i<=0||i>=this.nbParticles||!this._updatable)return[];const r=this.particles,s=this.nbParticles;if(t<s-1){const i=t+1,n=r[i]._pos-r[e]._pos,o=r[i]._ind-r[e]._ind;for(let e=i;e<s;e++){const t=r[e];t._pos-=n,t._ind-=o}}const n=r.splice(e,i);this._positions.length=0,this._indices.length=0,this._colors.length=0,this._uvs.length=0,this._normals.length=0,this._index=0,this._idxOfId.length=0,(this._depthSort||this._multimaterialEnabled)&&(this.depthSortedParticles=[]);let o=0;const a=r.length;for(let e=0;e<a;e++){const t=r[e],i=t._model,s=i._shape,n=i._indices,a=i._normals,l=i._shapeColors,h=i._shapeUV;t.idx=e,this._idxOfId[t.id]=e,this._meshBuilder(this._index,o,s,this._positions,n,this._indices,h,this._uvs,l,this._colors,a,this._normals,t.idx,t.idxInShape,null,i),this._index+=s.length,o+=n.length}return this.nbParticles-=i,this._isNotBuilt=!0,n}insertParticlesFromArray(e){if(!this._expandable)return this;let t=0,i=e[0].shapeId;const r=e.length;for(let s=0;s<r;s++){const r=e[s],n=r._model,o=n._shape,a=n._indices,l=n._shapeUV,h=n._shapeColors,c=n._normals,u=!c;this.recomputeNormals=u||this.recomputeNormals;const d=r.getBoundingInfo(),p=this._insertNewParticle(this.nbParticles,t,n,o,a,l,h,c,d,null,null);r.copyToRef(p),t++,i!=r.shapeId&&(i=r.shapeId,t=0)}return this._isNotBuilt=!0,this}_insertNewParticle(e,t,i,r,s,n,o,a,l,h,c){const u=this._positions.length,d=this._indices.length,p=this._meshBuilder(this._index,d,r,this._positions,s,this._indices,n,this._uvs,o,this._colors,a,this._normals,e,t,c,i);let m=null;return this._updatable&&(m=this._addParticle(this.nbParticles,this._lastParticleId,u,d,i,this._shapeCounter,t,l,h),m.position.copyFrom(p.position),m.rotation.copyFrom(p.rotation),p.rotationQuaternion&&(m.rotationQuaternion?m.rotationQuaternion.copyFrom(p.rotationQuaternion):m.rotationQuaternion=p.rotationQuaternion.clone()),p.color&&(m.color?m.color.copyFrom(p.color):m.color=p.color.clone()),m.scaling.copyFrom(p.scaling),m.uvs.copyFrom(p.uvs),null!==p.materialIndex&&(m.materialIndex=p.materialIndex),this.expandable&&(this._idxOfId[m.id]=m.idx)),h||(this._index+=r.length,this.nbParticles++,this._lastParticleId++),m}setParticles(e=0,t=this.nbParticles-1,i=!0){if(!this._updatable||this._isNotBuilt)return this;this.beforeUpdateParticles(e,t,i);const r=n.AA.Matrix[0],s=n.AA.Matrix[1],o=this.mesh,a=this._colors32,l=this._positions32,h=this._normals32,c=this._uvs32,u=this._indices32,d=this._indices,p=this._fixedNormal32,m=this._depthSort&&this._depthSortParticles,f=n.AA.Vector3,_=f[5].copyFromFloats(1,0,0),g=f[6].copyFromFloats(0,1,0),x=f[7].copyFromFloats(0,0,1),v=f[8].setAll(Number.MAX_VALUE),S=f[9].setAll(-Number.MAX_VALUE),b=f[10].setAll(0),y=this._tmpVertex,P=y.position,T=y.color,C=y.uv;if((this.billboard||this._depthSort)&&(this.mesh.computeWorldMatrix(!0),this.mesh._worldMatrix.invertToRef(s)),this.billboard){const e=f[0];this._camera.getDirectionToRef(Mt._0.Z,e),n.Pq.TransformNormalToRef(e,s,x),x.normalize();const t=this._camera.getViewMatrix(!0);n.Pq.TransformNormalFromFloatsToRef(t.m[1],t.m[5],t.m[9],s,g),n.Pq.CrossToRef(g,x,_),g.normalize(),_.normalize()}this._depthSort&&n.Pq.TransformCoordinatesToRef(this._camera.globalPosition,s,b),n.uq.IdentityToRef(r);let E=0,A=0,I=0,R=0,M=0,D=0,O=0;if(this.mesh.isFacetDataEnabled&&(this._computeBoundingBox=!0),t=t>=this.nbParticles?this.nbParticles-1:t,this._computeBoundingBox&&(0!=e||t!=this.nbParticles-1)){const e=this.mesh.getBoundingInfo();e&&(v.copyFrom(e.minimum),S.copyFrom(e.maximum))}A=this.particles[e]._pos;const N=A/3|0;R=4*N,D=2*N;for(let i=e;i<=t;i++){const e=this.particles[i];this.updateParticle(e);const t=e._model._shape,s=e._model._shapeUV,u=e._rotationMatrix,d=e.position,N=e.rotation,w=e.scaling,F=e._globalPosition;if(m){const t=this.depthSortedParticles[i];t.idx=e.idx,t.ind=e._ind,t.indicesLength=e._model._indicesLength,t.sqDistance=n.Pq.DistanceSquared(e.position,b)}if(e.alive&&(!e._stillInvisible||e.isVisible||this._recomputeInvisibles)){if(e.isVisible){e._stillInvisible=!1;const i=f[12];e.pivot.multiplyToRef(w,i),this.billboard&&(N.x=0,N.y=0),(this._computeParticleRotation||this.billboard)&&e.getRotationMatrix(r);if(null!==e.parentId){const t=this.getParticleById(e.parentId);if(t){const e=t._rotationMatrix,i=t._globalPosition,s=d.x*e[1]+d.y*e[4]+d.z*e[7],n=d.x*e[0]+d.y*e[3]+d.z*e[6],o=d.x*e[2]+d.y*e[5]+d.z*e[8];if(F.x=i.x+n,F.y=i.y+s,F.z=i.z+o,this._computeParticleRotation||this.billboard){const t=r.m;u[0]=t[0]*e[0]+t[1]*e[3]+t[2]*e[6],u[1]=t[0]*e[1]+t[1]*e[4]+t[2]*e[7],u[2]=t[0]*e[2]+t[1]*e[5]+t[2]*e[8],u[3]=t[4]*e[0]+t[5]*e[3]+t[6]*e[6],u[4]=t[4]*e[1]+t[5]*e[4]+t[6]*e[7],u[5]=t[4]*e[2]+t[5]*e[5]+t[6]*e[8],u[6]=t[8]*e[0]+t[9]*e[3]+t[10]*e[6],u[7]=t[8]*e[1]+t[9]*e[4]+t[10]*e[7],u[8]=t[8]*e[2]+t[9]*e[5]+t[10]*e[8]}}else e.parentId=null}else if(F.x=d.x,F.y=d.y,F.z=d.z,this._computeParticleRotation||this.billboard){const e=r.m;u[0]=e[0],u[1]=e[1],u[2]=e[2],u[3]=e[4],u[4]=e[5],u[5]=e[6],u[6]=e[8],u[7]=e[9],u[8]=e[10]}const n=f[11];for(e.translateFromPivot?n.setAll(0):n.copyFrom(i),O=0;O<t.length;O++){E=A+3*O,I=R+4*O,M=D+2*O;const r=2*O,o=r+1;P.copyFrom(t[O]),this._computeParticleColor&&e.color&&T.copyFrom(e.color),this._computeParticleTexture&&C.copyFromFloats(s[r],s[o]),this._computeParticleVertex&&this.updateParticleVertex(e,y,O);const a=P.x*w.x-i.x,d=P.y*w.y-i.y,m=P.z*w.z-i.z;let f=a*u[0]+d*u[3]+m*u[6],b=a*u[1]+d*u[4]+m*u[7],N=a*u[2]+d*u[5]+m*u[8];f+=n.x,b+=n.y,N+=n.z;const B=l[E]=F.x+_.x*f+g.x*b+x.x*N,V=l[E+1]=F.y+_.y*f+g.y*b+x.y*N,L=l[E+2]=F.z+_.z*f+g.z*b+x.z*N;if(this._computeBoundingBox&&(v.minimizeInPlaceFromFloats(B,V,L),S.maximizeInPlaceFromFloats(B,V,L)),!this._computeParticleVertex){const e=p[E],t=p[E+1],i=p[E+2],r=e*u[0]+t*u[3]+i*u[6],s=e*u[1]+t*u[4]+i*u[7],n=e*u[2]+t*u[5]+i*u[8];h[E]=_.x*r+g.x*s+x.x*n,h[E+1]=_.y*r+g.y*s+x.y*n,h[E+2]=_.z*r+g.z*s+x.z*n}if(this._computeParticleColor&&e.color){const e=this._colors32;e[I]=T.r,e[I+1]=T.g,e[I+2]=T.b,e[I+3]=T.a}if(this._computeParticleTexture){const t=e.uvs;c[M]=C.x*(t.z-t.x)+t.x,c[M+1]=C.y*(t.w-t.y)+t.y}}}else for(e._stillInvisible=!0,O=0;O<t.length;O++){if(E=A+3*O,I=R+4*O,M=D+2*O,l[E]=l[E+1]=l[E+2]=0,h[E]=h[E+1]=h[E+2]=0,this._computeParticleColor&&e.color){const t=e.color;a[I]=t.r,a[I+1]=t.g,a[I+2]=t.b,a[I+3]=t.a}if(this._computeParticleTexture){const t=e.uvs;c[M]=s[2*O]*(t.z-t.x)+t.x,c[M+1]=s[2*O+1]*(t.w-t.y)+t.y}}if(this._particlesIntersect){const t=e.getBoundingInfo(),i=t.boundingBox,r=t.boundingSphere,s=e._modelBoundingInfo;if(!this._bSphereOnly){const e=s.boundingBox.vectors,t=f[1],r=f[2];t.setAll(Number.MAX_VALUE),r.setAll(-Number.MAX_VALUE);for(let i=0;i<8;i++){const s=e[i].x*w.x,n=e[i].y*w.y,o=e[i].z*w.z,a=s*u[0]+n*u[3]+o*u[6],l=s*u[1]+n*u[4]+o*u[7],h=s*u[2]+n*u[5]+o*u[8],c=d.x+_.x*a+g.x*l+x.x*h,p=d.y+_.y*a+g.y*l+x.y*h,m=d.z+_.z*a+g.z*l+x.z*h;t.minimizeInPlaceFromFloats(c,p,m),r.maximizeInPlaceFromFloats(c,p,m)}i.reConstruct(t,r,o._worldMatrix)}const n=s.minimum.multiplyToRef(w,f[1]),a=s.maximum.multiplyToRef(w,f[2]),l=a.addToRef(n,f[3]).scaleInPlace(.5).addInPlace(F),h=a.subtractToRef(n,f[4]).scaleInPlace(.5*this._bSphereRadiusFactor),c=l.subtractToRef(h,f[1]),p=l.addToRef(h,f[2]);r.reConstruct(c,p,o._worldMatrix)}A=E+3,R=I+4,D=M+2}else O=t.length,A+=3*O,R+=4*O,D+=2*O}if(i){if(this._computeParticleColor){const e=o.getVertexBuffer(Ot.R.ColorKind);e&&!o.isPickable?e.updateDirectly(a,0):o.updateVerticesData(Ot.R.ColorKind,a,!1,!1)}if(this._computeParticleTexture){const e=o.getVertexBuffer(Ot.R.UVKind);e&&!o.isPickable?e.updateDirectly(c,0):o.updateVerticesData(Ot.R.UVKind,c,!1,!1)}const e=o.getVertexBuffer(Ot.R.PositionKind);if(e&&!o.isPickable?e.updateDirectly(l,0):o.updateVerticesData(Ot.R.PositionKind,l,!1,!1),!o.areNormalsFrozen||o.isFacetDataEnabled){if(this._computeParticleVertex||o.isFacetDataEnabled){const e=o.isFacetDataEnabled?o.getFacetDataParameters():null;ot.P.ComputeNormals(l,u,h,e);for(let e=0;e<h.length;e++)p[e]=h[e]}if(!o.areNormalsFrozen){const e=o.getVertexBuffer(Ot.R.NormalKind);e&&!o.isPickable?e.updateDirectly(h,0):o.updateVerticesData(Ot.R.NormalKind,h,!1,!1)}}if(m){const e=this.depthSortedParticles;e.sort(this._depthSortFunction);const t=e.length;let i=0,r=0;for(let s=0;s<t;s++){const t=e[s],n=t.indicesLength,o=t.ind;for(let e=0;e<n;e++)if(u[i]=d[o+e],i++,this._pickable){if(0==e%3){const e=this.pickedParticles[r];e.idx=t.idx,e.faceId=r,r++}}}}if(this._autoFixFaceOrientation){let e=0;for(let t=0;t<this.particles.length;t++){const i=m?this.particles[this.depthSortedParticles[t].idx]:this.particles[t];if(i.scale.x*i.scale.y*i.scale.z<0)for(let t=0;t<i._model._indicesLength;t+=3){const r=d[i._ind+t];u[e+t]=d[i._ind+t+1],u[e+t+1]=r}e+=i._model._indicesLength}}(m||this._autoFixFaceOrientation)&&o.updateIndices(u)}return this._computeBoundingBox&&(o.hasBoundingInfo?o.getBoundingInfo().reConstruct(v,S,o._worldMatrix):o.buildBoundingInfo(v,S,o._worldMatrix)),this._autoUpdateSubMeshes&&this.computeSubMeshes(),this._recomputeInvisibles=!1,this.afterUpdateParticles(e,t,i),this}dispose(){this.mesh.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._normals32=null,this._fixedNormal32=null,this._uvs32=null,this._colors32=null,this.pickedParticles=null,this.pickedBySubMesh=null,this._materials=null,this._materialIndexes=null,this._indicesByMaterial=null,this._idxOfId=null}pickedParticle(e){if(e.hit){const t=e.subMeshId,i=e.faceId-this.mesh.subMeshes[t].indexStart/3,r=this.pickedBySubMesh;if(r[t]&&r[t][i])return r[t][i]}return null}getParticleById(e){const t=this.particles[e];if(t&&t.id==e)return t;const i=this.particles,r=this._idxOfId[e];if(void 0!==r)return i[r];let s=0;const n=this.nbParticles;for(;s<n;){const t=i[s];if(t.id==e)return t;s++}return null}getParticlesByShapeId(e){const t=[];return this.getParticlesByShapeIdToRef(e,t),t}getParticlesByShapeIdToRef(e,t){t.length=0;for(let i=0;i<this.nbParticles;i++){const r=this.particles[i];r.shapeId==e&&t.push(r)}return this}computeSubMeshes(){if(!this.mesh||!this._multimaterialEnabled)return this;const e=this.depthSortedParticles;if(this.particles.length>0)for(let t=0;t<this.particles.length;t++){const i=this.particles[t];i.materialIndex||(i.materialIndex=0);const r=e[t];r.materialIndex=i.materialIndex,r.ind=i._ind,r.indicesLength=i._model._indicesLength,r.idx=i.idx}this._sortParticlesByMaterial();const t=this._indicesByMaterial,i=this._materialIndexes,r=this.mesh;r.subMeshes=[];const s=r.getTotalVertices();for(let e=0;e<i.length;e++){const n=t[e],o=t[e+1]-n,a=i[e];new ip.K(a,0,s,n,o,r)}return this}_sortParticlesByMaterial(){const e=[0];this._indicesByMaterial=e;const t=[];this._materialIndexes=t;const i=this.depthSortedParticles;i.sort(this._materialSortFunction);const r=i.length,s=this._indices32,n=this._indices;let o=0,a=0,l=0,h=i[0].materialIndex;t.push(h),this._pickable&&(this.pickedBySubMesh=[[]],this.pickedParticles=this.pickedBySubMesh[0]);for(let c=0;c<r;c++){const r=i[c],u=r.indicesLength,d=r.ind;r.materialIndex!==h&&(h=r.materialIndex,e.push(l),t.push(h),this._pickable&&(o++,this.pickedBySubMesh[o]=[],a=0));let p=0;for(let e=0;e<u;e++){if(s[l]=n[d+e],this._pickable){if(0==e%3){const e=this.pickedBySubMesh[o][a];e?(e.idx=r.idx,e.faceId=p):this.pickedBySubMesh[o][a]={idx:r.idx,faceId:p},a++,p++}}l++}}return e.push(s.length),this._updatable&&this.mesh.updateIndices(s),this}_setMaterialIndexesById(){this._materialIndexesById={};for(let e=0;e<this._materials.length;e++){const t=this._materials[e].uniqueId;this._materialIndexesById[t]=e}}_filterUniqueMaterialId(e){return e.filter((function(e,t,i){return i.indexOf(e)===t}))}_setDefaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=new br.F(this.name+"DefaultMaterial",this._scene)),this._defaultMaterial}refreshVisibleSize(){return this._isVisibilityBoxLocked||this.mesh.refreshBoundingInfo(),this}setVisibilityBox(e){const t=e/2;this.mesh.buildBoundingInfo(new n.Pq(-t,-t,-t),new n.Pq(t,t,t))}get isAlwaysVisible(){return this._alwaysVisible}set isAlwaysVisible(e){this._alwaysVisible=e,this.mesh.alwaysSelectAsActiveMesh=e}set isVisibilityBoxLocked(e){this._isVisibilityBoxLocked=e;this.mesh.getBoundingInfo().isLocked=e}get isVisibilityBoxLocked(){return this._isVisibilityBoxLocked}set computeParticleRotation(e){this._computeParticleRotation=e}set computeParticleColor(e){this._computeParticleColor=e}set computeParticleTexture(e){this._computeParticleTexture=e}set computeParticleVertex(e){this._computeParticleVertex=e}set computeBoundingBox(e){this._computeBoundingBox=e}set depthSortParticles(e){this._depthSortParticles=e}get computeParticleRotation(){return this._computeParticleRotation}get computeParticleColor(){return this._computeParticleColor}get computeParticleTexture(){return this._computeParticleTexture}get computeParticleVertex(){return this._computeParticleVertex}get computeBoundingBox(){return this._computeBoundingBox}get depthSortParticles(){return this._depthSortParticles}get expandable(){return this._expandable}get multimaterialEnabled(){return this._multimaterialEnabled}get useModelMaterial(){return this._useModelMaterial}get materials(){return this._materials}setMultiMaterial(e){this._materials=this._filterUniqueMaterialId(e),this._setMaterialIndexesById(),this._multimaterial&&this._multimaterial.dispose(),this._multimaterial=new gm.F(this.name+"MultiMaterial",this._scene);for(let e=0;e<this._materials.length;e++)this._multimaterial.subMaterials.push(this._materials[e]);this.computeSubMeshes(),this.mesh.material=this._multimaterial}get multimaterial(){return this._multimaterial}set multimaterial(e){this._multimaterial=e}get autoUpdateSubMeshes(){return this._autoUpdateSubMeshes}set autoUpdateSubMeshes(e){this._autoUpdateSubMeshes=e}initParticles(){}recycleParticle(e){return e}updateParticle(e){return e}updateParticleVertex(e,t,i){return this}beforeUpdateParticles(e,t,i){}afterUpdateParticles(e,t,i){}}var aE,lE,hE,cE,uE,dE,pE,mE,fE,_E,gE,xE,vE,SE,bE,yE=i(99083),PE=i(13833),TE=i(16066),CE=i(59384),EE=i(96913),AE=i(27323);Object.defineProperty(Ps.u.prototype,"physicsImpostor",{get:function(){return this._physicsImpostor},set:function(e){this._physicsImpostor!==e&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsImpostor=e,e&&(this._disposePhysicsObserver=this.onDisposeObservable.add((()=>{this.physicsImpostor&&(this.physicsImpostor.dispose(),this.physicsImpostor=null)}))))},enumerable:!0,configurable:!0}),Ps.u.prototype.getPhysicsImpostor=function(){return this.physicsImpostor},Ps.u.prototype.applyImpulse=function(e,t){return this.physicsImpostor?(this.physicsImpostor.applyImpulse(e,t),this):this},Ps.u.prototype.setPhysicsLinkWith=function(e,t,i,r){return this.physicsImpostor&&e.physicsImpostor?(this.physicsImpostor.createJoint(e.physicsImpostor,Ws.HingeJoint,{mainPivot:t,connectedPivot:i,nativeParams:r}),this):this};class IE{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw(0,Ph.n)("")}constructor(e,t=IE.DefaultPluginFactory()){this._physicsPlugin=t,this._physicsBodies=[],this._subTimeStep=0,e=e||new n.Pq(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}setVelocityLimits(e,t){this._physicsPlugin.setVelocityLimits(e,t)}getMaxLinearVelocity(){return this._physicsPlugin.getMaxLinearVelocity()}getMaxAngularVelocity(){return this._physicsPlugin.getMaxAngularVelocity()}_step(e){e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._physicsBodies)}addBody(e){this._physicsBodies.push(e)}removeBody(e){const t=this._physicsBodies.indexOf(e);t>-1&&this._physicsBodies.splice(t,1)}getBodies(){return this._physicsBodies}getPhysicsPlugin(){return this._physicsPlugin}raycastToRef(e,t,i,r){this._physicsPlugin.raycast(e,t,i,r)}raycast(e,t,i){const r=new bm;return this._physicsPlugin.raycast(e,t,r,i),r}}!function(e){e[e.FREE=0]="FREE",e[e.LIMITED=1]="LIMITED",e[e.LOCKED=2]="LOCKED"}(aE||(aE={})),function(e){e[e.LINEAR_X=0]="LINEAR_X",e[e.LINEAR_Y=1]="LINEAR_Y",e[e.LINEAR_Z=2]="LINEAR_Z",e[e.ANGULAR_X=3]="ANGULAR_X",e[e.ANGULAR_Y=4]="ANGULAR_Y",e[e.ANGULAR_Z=5]="ANGULAR_Z",e[e.LINEAR_DISTANCE=6]="LINEAR_DISTANCE"}(lE||(lE={})),function(e){e[e.BALL_AND_SOCKET=1]="BALL_AND_SOCKET",e[e.DISTANCE=2]="DISTANCE",e[e.HINGE=3]="HINGE",e[e.SLIDER=4]="SLIDER",e[e.LOCK=5]="LOCK",e[e.PRISMATIC=6]="PRISMATIC",e[e.SIX_DOF=7]="SIX_DOF"}(hE||(hE={})),function(e){e[e.SPHERE=0]="SPHERE",e[e.CAPSULE=1]="CAPSULE",e[e.CYLINDER=2]="CYLINDER",e[e.BOX=3]="BOX",e[e.CONVEX_HULL=4]="CONVEX_HULL",e[e.CONTAINER=5]="CONTAINER",e[e.MESH=6]="MESH",e[e.HEIGHTFIELD=7]="HEIGHTFIELD"}(cE||(cE={})),function(e){e[e.NONE=0]="NONE",e[e.VELOCITY=1]="VELOCITY",e[e.POSITION=2]="POSITION"}(uE||(uE={})),function(e){e.COLLISION_STARTED="COLLISION_STARTED",e.COLLISION_CONTINUED="COLLISION_CONTINUED",e.COLLISION_FINISHED="COLLISION_FINISHED",e.TRIGGER_ENTERED="TRIGGER_ENTERED",e.TRIGGER_EXITED="TRIGGER_EXITED"}(dE||(dE={})),function(e){e[e.STATIC=0]="STATIC",e[e.ANIMATED=1]="ANIMATED",e[e.DYNAMIC=2]="DYNAMIC"}(pE||(pE={})),function(e){e[e.DISABLED=0]="DISABLED",e[e.TELEPORT=1]="TELEPORT",e[e.ACTION=2]="ACTION"}(mE||(mE={})),function(e){e[e.SIMULATION_CONTROLLED=0]="SIMULATION_CONTROLLED",e[e.ALWAYS_ACTIVE=1]="ALWAYS_ACTIVE",e[e.ALWAYS_INACTIVE=2]="ALWAYS_INACTIVE"}(fE||(fE={}));class RE{get disablePreStep(){return this._prestepType==mE.DISABLED}set disablePreStep(e){this._prestepType=e?mE.DISABLED:mE.TELEPORT}constructor(e,t,i,r){if(this._pluginData=void 0,this._pluginDataInstances=[],this._collisionCBEnabled=!1,this._collisionEndedCBEnabled=!1,this.disableSync=!1,this._isDisposed=!1,this._shape=null,this._prestepType=mE.DISABLED,!r)return;const s=r.getPhysicsEngine();if(!s)throw new Error("No Physics Engine available.");if(this._physicsEngine=s,2!=s.getPluginVersion())throw new Error("Plugin version is incorrect. Expected version 2.");const o=s.getPhysicsPlugin();if(!o)throw new Error("No Physics Plugin available.");this._physicsPlugin=o,e.rotationQuaternion||(e.rotationQuaternion=n.PT.FromEulerAngles(e.rotation.x,e.rotation.y,e.rotation.z)),this.startAsleep=i,this._motionType=t,this.disableSync=0==t;const a=e;a.hasThinInstances?this._physicsPlugin.initBodyInstances(this,t,a):(e.parent&&e.computeWorldMatrix(!0),this._physicsPlugin.initBody(this,t,e.absolutePosition,e.absoluteRotationQuaternion)),this.transformNode=e,e.physicsBody=this,s.addBody(this),this._nodeDisposeObserver=e.onDisposeObservable.add((()=>{this.dispose()}))}getClassName(){return"PhysicsBody"}clone(e){const t=new RE(e,this.getMotionType(),this.startAsleep,this.transformNode.getScene());return t.shape=this.shape,t.setMassProperties(this.getMassProperties()),t.setLinearDamping(this.getLinearDamping()),t.setAngularDamping(this.getAngularDamping()),t}updateBodyInstances(){const e=this.transformNode;e.hasThinInstances&&this._physicsPlugin.updateBodyInstances(this,e)}get numInstances(){return this._pluginDataInstances.length}get motionType(){return this._motionType}set shape(e){this._shape=e,e&&this._physicsPlugin.setShape(this,e)}get shape(){return this._shape}getBoundingBox(){return this._physicsPlugin.getBodyBoundingBox(this)}setEventMask(e,t){this._physicsPlugin.setEventMask(this,e,t)}getEventMask(e){return this._physicsPlugin.getEventMask(this,e)}setMotionType(e,t){this.disableSync=0==e,this._physicsPlugin.setMotionType(this,e,t)}getMotionType(e){return this._physicsPlugin.getMotionType(this,e)}setPrestepType(e){this._prestepType=e}getPrestepType(){return this._prestepType}computeMassProperties(e){return this._physicsPlugin.computeMassProperties(this,e)}setMassProperties(e,t){this._physicsPlugin.setMassProperties(this,e,t)}getMassProperties(e){return this._physicsPlugin.getMassProperties(this,e)}setLinearDamping(e,t){this._physicsPlugin.setLinearDamping(this,e,t)}getLinearDamping(e){return this._physicsPlugin.getLinearDamping(this,e)}setAngularDamping(e,t){this._physicsPlugin.setAngularDamping(this,e,t)}getAngularDamping(e){return this._physicsPlugin.getAngularDamping(this,e)}setLinearVelocity(e,t){this._physicsPlugin.setLinearVelocity(this,e,t)}getLinearVelocityToRef(e,t){this._physicsPlugin.getLinearVelocityToRef(this,e,t)}getLinearVelocity(e){const t=new n.Pq;return this.getLinearVelocityToRef(t,e),t}setAngularVelocity(e,t){this._physicsPlugin.setAngularVelocity(this,e,t)}getAngularVelocityToRef(e,t){this._physicsPlugin.getAngularVelocityToRef(this,e,t)}getAngularVelocity(e){const t=new n.Pq;return this.getAngularVelocityToRef(t,e),t}applyImpulse(e,t,i){this._physicsPlugin.applyImpulse(this,e,t,i)}applyAngularImpulse(e,t){this._physicsPlugin.applyAngularImpulse(this,e,t)}applyForce(e,t,i){this._physicsPlugin.applyForce(this,e,t,i)}getGeometry(){return this._physicsPlugin.getBodyGeometry(this)}getCollisionObservable(){return this._physicsPlugin.getCollisionObservable(this)}getCollisionEndedObservable(){return this._physicsPlugin.getCollisionEndedObservable(this)}setCollisionCallbackEnabled(e){this._collisionCBEnabled=e,this._physicsPlugin.setCollisionCallbackEnabled(this,e)}setCollisionEndedCallbackEnabled(e){this._collisionEndedCBEnabled=e,this._physicsPlugin.setCollisionEndedCallbackEnabled(this,e)}getObjectCenterWorld(e){const t=new n.Pq;return this.getObjectCenterWorldToRef(t,e)}getObjectCenterWorldToRef(e,t){if(this._pluginDataInstances?.length>0){const i=t||0,r=this.transformNode._thinInstanceDataStorage.matrixData;r&&e.set(r[16*i+12],r[16*i+13],r[16*i+14])}else e.copyFrom(this.transformNode.position);return e}addConstraint(e,t,i,r){this._physicsPlugin.addConstraint(this,e,t,i,r)}syncWithBone(e,t,i,r,s,o){const a=this.transformNode;if(a.rotationQuaternion)if(s){const i=n.AA.Quaternion[0];e.getRotationQuaternionToRef(1,t,i),i.multiplyToRef(s,a.rotationQuaternion)}else e.getRotationQuaternionToRef(1,t,a.rotationQuaternion);const l=n.AA.Vector3[0],h=n.AA.Vector3[1];o||((o=n.AA.Vector3[2]).x=0,o.y=1,o.z=0),e.getDirectionToRef(o,t,h),e.getAbsolutePositionToRef(t,l),null==r&&i&&(r=i.length()),null!=r&&(l.x+=h.x*r,l.y+=h.y*r,l.z+=h.z*r),a.setAbsolutePosition(l)}iterateOverAllInstances(e){if(this._pluginDataInstances?.length>0)for(let t=0;t<this._pluginDataInstances.length;t++)e(this,t);else e(this,void 0)}setGravityFactor(e,t){this._physicsPlugin.setGravityFactor(this,e,t)}getGravityFactor(e){return this._physicsPlugin.getGravityFactor(this,e)}setTargetTransform(e,t,i){this._physicsPlugin.setTargetTransform(this,e,t,i)}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed||(this._collisionCBEnabled&&this.setCollisionCallbackEnabled(!1),this._collisionEndedCBEnabled&&this.setCollisionEndedCallbackEnabled(!1),this._nodeDisposeObserver&&(this.transformNode.onDisposeObservable.remove(this._nodeDisposeObserver),this._nodeDisposeObserver=null),this._physicsEngine.removeBody(this),this._physicsPlugin.removeBody(this),this._physicsPlugin.disposeBody(this),this.transformNode.physicsBody=null,this._pluginData=null,this._pluginDataInstances.length=0,this._isDisposed=!0,this.shape=null)}}class ME{constructor(e,t){if(this._pluginData=void 0,this._isTrigger=!1,this._isDisposed=!1,!t)return;const i=t.getPhysicsEngine();if(!i)throw new Error("No Physics Engine available.");if(2!=i.getPluginVersion())throw new Error("Plugin version is incorrect. Expected version 2.");const r=i.getPhysicsPlugin();if(!r)throw new Error("No Physics Plugin available.");if(this._physicsPlugin=r,void 0!==e.pluginData&&null!==e.pluginData)this._pluginData=e.pluginData,this._type=this._physicsPlugin.getShapeType(this);else if(void 0!==e.type&&null!==e.type){this._type=e.type;const t=e.parameters??{};this._physicsPlugin.initShape(this,e.type,t)}}getClassName(){return"PhysicsShape"}get type(){return this._type}set filterMembershipMask(e){this._physicsPlugin.setShapeFilterMembershipMask(this,e)}get filterMembershipMask(){return this._physicsPlugin.getShapeFilterMembershipMask(this)}set filterCollideMask(e){this._physicsPlugin.setShapeFilterCollideMask(this,e)}get filterCollideMask(){return this._physicsPlugin.getShapeFilterCollideMask(this)}set material(e){this._physicsPlugin.setMaterial(this,e),this._material=e}get material(){return this._material||(this._material=this._physicsPlugin.getMaterial(this)),this._material}set density(e){this._physicsPlugin.setDensity(this,e)}get density(){return this._physicsPlugin.getDensity(this)}addChildFromParent(e,t,i){const r=i.computeWorldMatrix(!0),s=e.computeWorldMatrix(!0),o=n.AA.Matrix[0];r.multiplyToRef(n.uq.Invert(s),o);const a=n.AA.Vector3[0],l=n.AA.Quaternion[0],h=n.AA.Vector3[1];o.decompose(h,l,a),this._physicsPlugin.addChild(this,t,a,l,h)}addChild(e,t,i,r){this._physicsPlugin.addChild(this,e,t,i,r)}removeChild(e){this._physicsPlugin.removeChild(this,e)}getNumChildren(){return this._physicsPlugin.getNumChildren(this)}getBoundingBox(){return this._physicsPlugin.getBoundingBox(this)}set isTrigger(e){this._isTrigger!==e&&(this._isTrigger=e,this._physicsPlugin.setTrigger(this,e))}get isTrigger(){return this._isTrigger}dispose(){this._isDisposed||(this._physicsPlugin.disposeShape(this),this._isDisposed=!0)}}class DE extends ME{constructor(e,t,i){super({type:0,parameters:{center:e,radius:t}},i)}static FromMesh(e){const t=e.getBoundingInfo(),i=t.boundingSphere.center,r=t.boundingBox.extendSize,s=Math.max(r.x,r.y,r.z);return new DE(i,s,e.getScene())}}class OE extends ME{constructor(e,t,i,r){super({type:1,parameters:{pointA:e,pointB:t,radius:i}},r)}static FromMesh(e){const t=e.getBoundingInfo(),i=t.boundingBox.extendSize.x,r=new n.Pq(0,t.boundingBox.extendSize.y-i,0),s=t.boundingBox.center.add(r),o=t.boundingBox.center.subtract(r);return new OE(s,o,i,e.getScene())}}class NE extends ME{constructor(e,t,i,r){super({type:2,parameters:{pointA:e,pointB:t,radius:i}},r)}static FromMesh(e){const t=e.getBoundingInfo(),i=t.boundingBox.extendSize.x,r=new n.Pq(0,t.boundingBox.extendSize.y,0),s=t.boundingBox.center.add(r),o=t.boundingBox.center.subtract(r);return new NE(s,o,i,e.getScene())}}class wE extends ME{constructor(e,t,i,r){super({type:3,parameters:{center:e,rotation:t,extents:i}},r)}static FromMesh(e){const t=e.getBoundingInfo(),i=t.boundingBox.center,r=t.boundingBox.extendSize.scale(2);return new wE(i,n.PT.Identity(),r,e.getScene())}}class FE extends ME{constructor(e,t){super({type:4,parameters:{mesh:e}},t)}}class BE extends ME{constructor(e,t){super({type:6,parameters:{mesh:e}},t)}}class VE extends ME{constructor(e){super({type:5,parameters:{}},e)}}class LE extends ME{constructor(e,t,i,r,s,n){super({type:7,parameters:{heightFieldSizeX:e,heightFieldSizeZ:t,numHeightFieldSamplesX:i,numHeightFieldSamplesZ:r,heightFieldData:s}},n)}}class kE extends ME{constructor(e,t){super({type:7,parameters:{groundMesh:e}},t)}}class GE{constructor(e,t,i){if(this._pluginData=void 0,!i)throw new Error("Missing scene parameter for constraint constructor.");const r=i.getPhysicsEngine();if(!r)throw new Error("No Physics Engine available.");if(2!=r.getPluginVersion())throw new Error("Plugin version is incorrect. Expected version 2.");const s=r.getPhysicsPlugin();if(!s)throw new Error("No Physics Plugin available.");this._physicsPlugin=s,this._options=t,this._type=e}get type(){return this._type}get options(){return this._options}set isEnabled(e){this._physicsPlugin.setEnabled(this,e)}get isEnabled(){return this._physicsPlugin.getEnabled(this)}set isCollisionsEnabled(e){this._physicsPlugin.setCollisionsEnabled(this,e)}get isCollisionsEnabled(){return this._physicsPlugin.getCollisionsEnabled(this)}getBodiesUsingConstraint(){return this._physicsPlugin.getBodiesUsingConstraint(this)}dispose(){this._physicsPlugin.disposeConstraint(this)}}class zE{}class UE extends GE{constructor(e,t,i){super(7,e,i),this.limits=t}setAxisFriction(e,t){this._physicsPlugin.setAxisFriction(this,e,t)}getAxisFriction(e){return this._physicsPlugin.getAxisFriction(this,e)}setAxisMode(e,t){this._physicsPlugin.setAxisMode(this,e,t)}getAxisMode(e){return this._physicsPlugin.getAxisMode(this,e)}setAxisMinLimit(e,t){this._physicsPlugin.setAxisMinLimit(this,e,t)}getAxisMinLimit(e){return this._physicsPlugin.getAxisMinLimit(this,e)}setAxisMaxLimit(e,t){this._physicsPlugin.setAxisMaxLimit(this,e,t)}getAxisMaxLimit(e){return this._physicsPlugin.getAxisMaxLimit(this,e)}setAxisMotorType(e,t){this._physicsPlugin.setAxisMotorType(this,e,t)}getAxisMotorType(e){return this._physicsPlugin.getAxisMotorType(this,e)}setAxisMotorTarget(e,t){this._physicsPlugin.setAxisMotorTarget(this,e,t)}getAxisMotorTarget(e){return this._physicsPlugin.getAxisMotorTarget(this,e)}setAxisMotorMaxForce(e,t){this._physicsPlugin.setAxisMotorMaxForce(this,e,t)}getAxisMotorMaxForce(e){return this._physicsPlugin.getAxisMotorMaxForce(this,e)}}class WE extends GE{constructor(e,t,i,r,s){super(1,{pivotA:e,pivotB:t,axisA:i,axisB:r},s)}}class HE extends GE{constructor(e,t){super(2,{maxDistance:e},t)}}class $E extends GE{constructor(e,t,i,r,s){super(3,{pivotA:e,pivotB:t,axisA:i,axisB:r},s)}}class qE extends GE{constructor(e,t,i,r,s){super(4,{pivotA:e,pivotB:t,axisA:i,axisB:r},s)}}class YE extends GE{constructor(e,t,i,r,s){super(5,{pivotA:e,pivotB:t,axisA:i,axisB:r},s)}}class XE extends GE{constructor(e,t,i,r,s){super(6,{pivotA:e,pivotB:t,axisA:i,axisB:r},s)}}class jE extends UE{constructor(e,t,i,r,s,n,o,a,l){super({pivotA:e,pivotB:t,axisA:i,axisB:r},[{axis:6,minLimit:s,maxLimit:n,stiffness:o,damping:a}],l)}}!function(e){e[e.GEOMETRIC_MEAN=0]="GEOMETRIC_MEAN",e[e.MINIMUM=1]="MINIMUM",e[e.MAXIMUM=2]="MAXIMUM",e[e.ARITHMETIC_MEAN=3]="ARITHMETIC_MEAN",e[e.MULTIPLY=4]="MULTIPLY"}(_E||(_E={}));class ZE{constructor(e,t,i={mass:0},r){if(this.transformNode=e,this.type=t,this._options=i,this._scene=r,this._disposeShapeWhenDisposed=!0,!this.transformNode)return void m.V.Error("No object was provided. A physics object is obligatory");const s=e;if(this.transformNode.parent&&0!==this._options.mass&&s.hasThinInstances&&m.V.Warn("A physics body has been created for an object which has a parent and thin instances. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),!this._scene)return;this._options.mass=void 0===i.mass?0:i.mass,this._options.friction=void 0===i.friction?.2:i.friction,this._options.restitution=void 0===i.restitution?.2:i.restitution;const n=0===this._options.mass?0:2,o=this._options.startAsleep??!1;this.body=new RE(e,n,o,this._scene),this._addSizeOptions(),t.getClassName&&"PhysicsShape"===t.getClassName()?(this.shape=t,this._disposeShapeWhenDisposed=!1):this.shape=new ME({type:t,parameters:this._options},this._scene),this._options.isTriggerShape&&(this.shape.isTrigger=!0),this.material={friction:this._options.friction,restitution:this._options.restitution},this.body.shape=this.shape,this.shape.material=this.material,this.body.setMassProperties({mass:this._options.mass}),this._nodeDisposeObserver=this.transformNode.onDisposeObservable.add((()=>{this.dispose()}))}_getObjectBoundingBox(){return this.transformNode.getRawBoundingInfo?this.transformNode.getRawBoundingInfo().boundingBox:new ms.I(new n.Pq(-.5,-.5,-.5),new n.Pq(.5,.5,.5))}_hasVertices(e){return e?.getTotalVertices()>0}_addSizeOptions(){this.transformNode.computeWorldMatrix(!0);const e=this._getObjectBoundingBox(),t=n.AA.Vector3[0];t.copyFrom(e.extendSize),t.scaleInPlace(2),t.multiplyInPlace(this.transformNode.absoluteScaling),t.x=Math.abs(t.x),t.y=Math.abs(t.y),t.z=Math.abs(t.z);const i=n.AA.Vector3[1];if(i.copyFrom(e.minimum),i.multiplyInPlace(this.transformNode.absoluteScaling),!this._options.center){const t=new n.Pq;t.copyFrom(e.center),t.multiplyInPlace(this.transformNode.absoluteScaling),this._options.center=t}switch(this.type){case 0:!this._options.radius&&(0,yt.WithinEpsilon)(t.x,t.y,1e-4)&&(0,yt.WithinEpsilon)(t.x,t.z,1e-4)?this._options.radius=t.x/2:this._options.radius||(m.V.Warn("Non uniform scaling is unsupported for sphere shapes. Setting the radius to the biggest bounding box extent."),this._options.radius=Math.max(t.x,t.y,t.z)/2);break;case 1:{const e=t.x/2;this._options.radius=this._options.radius??e,this._options.pointA=this._options.pointA??new n.Pq(0,i.y+e,0),this._options.pointB=this._options.pointB??new n.Pq(0,i.y+t.y-e,0)}break;case 2:{const e=t.x/2;this._options.radius=this._options.radius??e,this._options.pointA=this._options.pointA??new n.Pq(0,i.y,0),this._options.pointB=this._options.pointB??new n.Pq(0,i.y+t.y,0)}break;case 6:case 4:case 7:if(!this._options.mesh&&this._hasVertices(this.transformNode))this._options.mesh=this.transformNode;else if(!this._options.mesh||!this._hasVertices(this._options.mesh))throw new Error("No valid mesh was provided for mesh or convex hull shape parameter. Please provide a mesh with valid geometry (number of vertices greater than 0).");break;case 3:this._options.extents=this._options.extents??new n.Pq(t.x,t.y,t.z),this._options.rotation=this._options.rotation??n.PT.Identity()}}dispose(){this._nodeDisposeObserver&&(this.body.transformNode.onDisposeObservable.remove(this._nodeDisposeObserver),this._nodeDisposeObserver=null),this.body.dispose(),this._disposeShapeWhenDisposed&&this.shape.dispose()}}class QE{}class KE{constructor(e,t,i){this._boxConfigs=new Array,this._constraints=new Array,this._bones=new Array,this._initialRotation=new Array,this._initialRotation2=new Array,this._boneNames=[],this._transforms=new Array,this._aggregates=new Array,this._ragdollMode=!1,this._rootBoneName="",this._rootBoneIndex=-1,this._mass=10,this._restitution=0,this.pauseSync=!1,this._defaultJoint=3,this._defaultJointMin=-90,this._defaultJointMax=90,this._skeleton=e,this._scene=e.getScene(),this._rootTransformNode=t,this._config=i,this._boxConfigs=[],this._putBoxesInBoneCenter=!1,this._defaultJoint=3,this._init()}getConstraints(){return this._constraints}getAggregate(e){return e<0||e>=this._aggregates.length?this._aggregates[this._rootBoneIndex]:this._aggregates[e]}_createColliders(){this._rootTransformNode.computeWorldMatrix(),this._skeleton.computeAbsoluteMatrices(!0),this._skeleton.prepare(!0);const e=this._config;for(let t=0;t<e.length;t++){const i=void 0!==e[t].bone?[e[t].bone]:e[t].bones;for(let r=0;r<i.length;r++){const s=this._skeleton.bones[this._skeleton.getBoneIndexByName(i[r])];if(null==s)return;const o={width:this._config[t].width,depth:this._config[t].depth,height:this._config[t].height,size:this._config[t].size};o.width=o.width??o.size,o.depth=o.depth??o.size,o.height=o.height??o.size;const a=new mt.V(i[r]+"_transform",this._scene);o.joint=void 0!==e[t].joint?e[t].joint:this._defaultJoint,o.rotationAxis=void 0!==e[t].rotationAxis?e[t].rotationAxis:Mt._0.X,o.min=void 0!==e[t].min?e[t].min:this._defaultJointMin,o.max=void 0!==e[t].max?e[t].max:this._defaultJointMax;let l=0;void 0!==e[t].putBoxInBoneCenter&&e[t].putBoxInBoneCenter||this._putBoxesInBoneCenter?(void 0===s.length&&m.V.Log("The length property is not defined for bone "+s.name),l=s.length/2):void 0!==e[t].boxOffset&&(l=e[t].boxOffset),o.boxOffset=l;const h=void 0!==e[t].boneOffsetAxis?e[t].boneOffsetAxis:Mt._0.Y,c=s.getDirection(h,this._rootTransformNode);o.boneOffsetAxis=h,a.position=s.getAbsolutePosition(this._rootTransformNode).add(c.scale(l));const u=void 0!==e[t].mass?e[t].mass:this._mass,d=void 0!==e[t].restitution?e[t].restitution:this._restitution,p=new ZE(a,3,{mass:u,restitution:d,friction:.6,extents:new n.Pq(o.width,o.height,o.depth)},this._scene);p.body.setCollisionCallbackEnabled(!0),p.body.disablePreStep=!1,p.body.setMotionType(1),this._aggregates.push(p),this._bones.push(s),this._boneNames.push(s.name),this._transforms.push(a),this._boxConfigs.push(o),this._initialRotation.push(s.getRotationQuaternion(1,this._rootTransformNode)),this._initialRotation2.push(s.getRotationQuaternion(1))}}}_initJoints(){this._rootTransformNode.computeWorldMatrix();for(let e=0;e<this._bones.length;e++){if(e==this._rootBoneIndex)continue;const t=this._findNearestParent(e);if(null==t)return void m.V.Warn("Couldn't find a nearest parent bone in the configs for bone called "+this._boneNames[e]);const i=this._boneNames.indexOf(t.name);let r=this._bones[e].getAbsolutePosition(this._rootTransformNode).subtract(this._transforms[i].position);const s=this._transforms[i].computeWorldMatrix(),o=n.uq.Invert(s);r=n.Pq.TransformCoordinates(this._bones[e].getAbsolutePosition(this._rootTransformNode),o);const a=this._bones[e].getAbsolutePosition(this._rootTransformNode),l=this._transforms[e].position.clone(),h=a.subtract(l),c=this._boxConfigs[e].joint??this._defaultJoint,u=new GE(c,{pivotA:r,pivotB:h,axisA:this._boxConfigs[e].rotationAxis,axisB:this._boxConfigs[e].rotationAxis,collision:!1},this._scene);this._aggregates[i].body.addConstraint(this._aggregates[e].body,u),u.isEnabled=!1,this._constraints.push(u)}}_syncBonesToPhysics(){const e=this._rootTransformNode.getWorldMatrix();for(let t=0;t<this._bones.length;t++){const i=this._aggregates[t].transformNode,r=this._bones[t].getAbsolutePosition();n.Pq.TransformCoordinatesToRef(r,e,i.position),this._bones[t].getDirectionToRef(this._boxConfigs[t].boneOffsetAxis,this._rootTransformNode,n.AA.Vector3[0]),n.AA.Vector3[0].scaleInPlace(this._boxConfigs[t].boxOffset??0),i.position.addInPlace(n.AA.Vector3[0]),this._setBoneOrientationToBody(t)}}_setBoneOrientationToBody(e){const t=this._aggregates[e].transformNode,i=this._bones[e];this._initialRotation[e].conjugateToRef(n.AA.Quaternion[0]),i.getRotationQuaternionToRef(1,this._rootTransformNode,n.AA.Quaternion[1]),n.AA.Quaternion[1].multiplyToRef(n.AA.Quaternion[0],t.rotationQuaternion),t.rotationQuaternion.normalize()}_syncBonesAndBoxes(){if(!this.pauseSync)if(this._ragdollMode){this._setBodyOrientationToBone(this._rootBoneIndex);const e=this._aggregates[this._rootBoneIndex].body.transformNode.position;this._rootTransformNode.getWorldMatrix().invertToRef(n.AA.Matrix[0]),n.Pq.TransformCoordinatesToRef(e,n.AA.Matrix[0],n.AA.Vector3[0]),this._bones[this._rootBoneIndex].setAbsolutePosition(n.AA.Vector3[0]);for(let e=0;e<this._bones.length;e++)e!=this._rootBoneIndex&&this._setBodyOrientationToBone(e)}else this._syncBonesToPhysics()}_setBodyOrientationToBone(e){const t=this._rootTransformNode.rotationQuaternion??n.PT.FromEulerAngles(this._rootTransformNode.rotation.x,this._rootTransformNode.rotation.y,this._rootTransformNode.rotation.z),i=this._initialRotation2[e],r=this._aggregates[e].body?.transformNode?.rotationQuaternion;t.multiplyToRef(i,n.AA.Quaternion[1]),r.multiplyToRef(n.AA.Quaternion[1],n.AA.Quaternion[0]),this._bones[e].setRotationQuaternion(n.AA.Quaternion[0],1,this._rootTransformNode)}_defineRootBone(){const e=this._skeleton.getChildren();return 1!=e.length?(m.V.Log("Ragdoll creation failed: there can only be one root in the skeleton."),!1):(this._rootBoneName=e[0].name,this._rootBoneIndex=this._boneNames.indexOf(this._rootBoneName),-1!=this._rootBoneIndex||(m.V.Log("Ragdoll creation failed: the array boneNames doesn't have the root bone. The root bone is "+this._skeleton.getChildren()),!1))}_findNearestParent(e){let t=this._bones[e].getParent();do{if(null!=t&&this._boneNames.includes(t.name))break;t=t?.getParent()}while(null!=t);return t}_init(){this._createColliders(),this._defineRootBone()&&(this._initJoints(),this._scene.registerBeforeRender((()=>{this._syncBonesAndBoxes()})),this._syncBonesToPhysics())}ragdoll(){this._ragdollMode=!0,this._skeleton.bones.forEach((e=>{e.linkTransformNode(null)}));for(let e=0;e<this._constraints.length;e++)this._constraints[e].isEnabled=!0;for(let e=0;e<this._aggregates.length;e++)this._aggregates[e].body.setMotionType(2)}dispose(){this._aggregates.forEach((e=>{e.dispose()}))}}!function(e){e[e.UNSUPPORTED=0]="UNSUPPORTED",e[e.SLIDING=1]="SLIDING",e[e.SUPPORTED=2]="SUPPORTED"}(gE||(gE={})),function(e){e[e.OK=0]="OK",e[e.FAILURE_3D=1]="FAILURE_3D",e[e.FAILURE_2D=2]="FAILURE_2D"}(xE||(xE={}));class JE{}class eA{copyFrom(e){this.index=e.index,this.constraint=e.constraint,this.interaction=e.interaction}}class tA{constructor(){this.supportPlanes=new Array(4),this.numSupportPlanes=0,this.currentTime=0}getOutput(e){return this.outputInteractions[this.inputConstraints.indexOf(e)]}}function iA(e,t,i,r,s){const o=e._bodies,a=n.Pq.FromArray(t[4]),l=-r*i.dot(a);return{position:n.Pq.FromArray(t[3]),normal:a,distance:l,fraction:r,bodyB:o.get(t[0][0]),allowedPenetration:Math.min(Math.max(s-l,0),s)}}class rA{constructor(e,t,i){this._orientation=n.PT.Identity(),this._manifold=[],this._contactAngleSensitivity=10,this._tmpMatrix=new n.uq,this._tmpVecs=(0,Rt.mI)(31,n.Pq.Zero),this.keepDistance=.05,this.keepContactTolerance=.1,this.maxCastIterations=10,this.penetrationRecoverySpeed=1,this.staticFriction=0,this.dynamicFriction=1,this.maxSlopeCosine=.5,this.maxCharacterSpeedForSolver=10,this.up=new n.Pq(0,1,0),this.characterStrength=1e38,this.acceleration=.05,this.maxAcceleration=50,this.characterMass=0,this._position=e.clone(),this._velocity=n.Pq.Zero(),this._lastVelocity=n.Pq.Zero();const r=t.capsuleRadius??.6,s=t.capsuleHeight??1.8;this._tmpVecs[0].set(0,.5*s-r,0),this._tmpVecs[1].set(0,.5*-s+r,0),this._shape=t.shape??new OE(this._tmpVecs[0],this._tmpVecs[1],r,i),this._lastInvDeltaTime=1/60,this._lastDisplacement=n.Pq.Zero(),this._scene=i;const o=this._scene.getPhysicsEngine().getPhysicsPlugin()._hknp;this._startCollector=o.HP_QueryCollector_Create(16)[1],this._castCollector=o.HP_QueryCollector_Create(16)[1]}getPosition(){return this._position}getVelocity(){return this._velocity}setVelocity(e){this._velocity.copyFrom(e)}_validateManifold(){const e=[];for(let t=0;t<this._manifold.length;t++)this._manifold[t].bodyB.body.isDisposed||e.push(this._manifold[t]);this._manifold=e}_getPointVelocityToRef(e,t,i){const r=this._tmpVecs[10];this._getComWorldToRef(e,r);const s=this._tmpVecs[11];t.subtractToRef(r,s);const o=this._tmpVecs[12];e.body.getAngularVelocityToRef(o,e.index);const a=this._tmpVecs[13];n.Pq.CrossToRef(o,s,a),a.addToRef(e.body.getLinearVelocity(e.index),i)}_compareContacts(e,t){const i=(1-e.normal.dot(t.normal))*this._contactAngleSensitivity*this._contactAngleSensitivity,r=(e.distance-t.distance)*(e.distance*t.distance),s=this._tmpVecs[7];this._getPointVelocityToRef(e.bodyB,e.position,s);const n=this._tmpVecs[8];this._getPointVelocityToRef(t.bodyB,t.position,n);const o=this._tmpVecs[9];s.subtractToRef(n,o);return 10*i+.1*o.lengthSquared()+r}_findContact(e,t,i){let r=-1,s=i;for(let i=0;i<t.length;i++){const n=this._compareContacts(e,t[i]);n<s&&(s=n,r=i)}return r}_updateManifold(e,t,i){const r=this._scene.getPhysicsEngine().getPhysicsPlugin(),s=r._hknp,o=s.HP_QueryCollector_GetNumHits(e)[1];if(o>0){const t=[];let i=1e38;const a=r._bodies;for(let r=0;r<o;r++){const[o,,l]=s.HP_QueryCollector_GetShapeProximityResult(e,r)[1];i=Math.min(i,o),t.push({position:n.Pq.FromArray(l[3]),normal:n.Pq.FromArray(l[4]),distance:o,fraction:0,bodyB:a.get(l[0][0]),allowedPenetration:Math.min(Math.max(this.keepDistance-o,0),this.keepDistance)})}for(let e=this._manifold.length-1;e>=0;e--){const i=this._manifold[e],r=this._findContact(i,t,1.1);if(r>=0){const s=Math.min(Math.max(this.keepDistance-t[r].distance,0),i.allowedPenetration);this._manifold[e]=t[r],this._manifold[e].allowedPenetration=s,t.splice(r,1)}else this._manifold.splice(e,1)}const l=t.findIndex((e=>e.distance==i));if(l>=0){const e=this._findContact(t[l],this._manifold,.1);if(e>=0){const i=Math.min(Math.max(this.keepDistance-t[l].distance,0),this._manifold[e].allowedPenetration);this._manifold[e]=t[l],this._manifold[e].allowedPenetration=i}else this._manifold.push(t[l])}}else this._manifold.length=0;let a=0;const l=s.HP_QueryCollector_GetNumHits(t)[1];if(l>0){let e=null;for(let n=0;n<l;n++){const[o,,l]=s.HP_QueryCollector_GetShapeCastResult(t,n)[1];if(null==e){const t=iA(r,l,i,o,this.keepDistance);e=l[0][0];if(-1==this._findContact(t,this._manifold,.1)&&this._manifold.push(t),0==t.bodyB.body.getMotionType(t.bodyB.index))break}else if(e._pluginData&&l[0]!=e._pluginData.hpBodyId){a++;break}}}for(let e=this._manifold.length-1;e>=0;e--){let t=e-1;for(;t>=0;t--){if(this._compareContacts(this._manifold[e],this._manifold[t])<.1)break}t>=0&&this._manifold.slice(e,1)}return a}_createSurfaceConstraint(e,t){const i={planeNormal:e.normal.clone(),planeDistance:e.distance,staticFriction:this.staticFriction,dynamicFriction:this.dynamicFriction,extraUpStaticFriction:0,extraDownStaticFriction:0,velocity:n.Pq.Zero(),angularVelocity:n.Pq.Zero(),priority:0},r=Math.max(this.maxSlopeCosine,.1),s=e.normal.dot(this.up),o=e.position.clone();if(s>r){const t=this.getPosition(),i=this._tmpVecs[20];e.position.subtractToRef(t,i);const r=e.normal.dot(i);o.x=t.x+this.up.x*r,o.y=t.y+this.up.y*r,o.z=t.z+this.up.z*r}const a=e.bodyB.body.getMotionType(e.bodyB.index),l=i.velocity.dot(i.planeNormal)*t;return i.planeDistance-=l,0==a?i.priority=2:1==a&&(i.priority=1),i}_addMaxSlopePlane(e,t,i,r,s){const n=r[i].planeNormal.dot(t);if(n>.01&&n<e){const e={planeNormal:r[i].planeNormal.clone(),planeDistance:r[i].planeDistance,velocity:r[i].velocity.clone(),angularVelocity:r[i].angularVelocity.clone(),priority:r[i].priority,dynamicFriction:r[i].dynamicFriction,staticFriction:r[i].staticFriction,extraDownStaticFriction:r[i].extraDownStaticFriction,extraUpStaticFriction:r[i].extraUpStaticFriction},o=e.planeDistance;if(e.planeNormal.subtractInPlace(t.scale(n)),e.planeNormal.normalize(),o>=0)e.planeDistance=o*e.planeNormal.dot(r[i].planeNormal);else{const t=Math.min(0,o+s);e.planeDistance=t/e.planeNormal.dot(r[i].planeNormal),r[i].planeDistance=0,this._resolveConstraintPenetration(e,this.penetrationRecoverySpeed)}return r.push(e),!0}return!1}_resolveConstraintPenetration(e,t){e.planeDistance<-1e-6&&(e.planeNormal.scaleToRef(e.planeDistance*t,this._tmpVecs[6]),e.velocity.subtractInPlace(this._tmpVecs[6]))}_createConstraintsFromManifold(e,t){const i=[];for(let e=0;e<this._manifold.length;e++){const r=this._createSurfaceConstraint(this._manifold[e],t);i.push(r),this._addMaxSlopePlane(this.maxSlopeCosine,this.up,e,i,this._manifold[e].allowedPenetration),this._resolveConstraintPenetration(r,this.penetrationRecoverySpeed)}return i}_simplexSolverSortInfo(e){for(let t=0;t<e.numSupportPlanes-1;t++)for(let i=t+1;i<e.numSupportPlanes;i++){const r=e.supportPlanes[t],s=e.supportPlanes[i];if(!(r.constraint.priority<s.constraint.priority)){if(r.constraint.priority==s.constraint.priority){if(r.constraint.velocity.lengthSquared()<s.constraint.velocity.lengthSquared())continue}e.supportPlanes[t]=s,e.supportPlanes[i]=r}}}_simplexSolverSolve1d(e,t,i,r){const s=1e-5,n=t.velocity,o=this._tmpVecs[22];i.subtractToRef(n,o);const a=o.dot(t.planeNormal),l=o.lengthSquared();o.subtractInPlace(t.planeNormal.scale(a));{const e=a*a,i=o.dot(this.up)>0?t.extraUpStaticFriction:t.extraDownStaticFriction;if(i>0){const a=this.up.cross(t.planeNormal),h=a.lengthSquared();let c=0;if(h>s){a.scaleInPlace(1/Math.sqrt(h)),c=o.dot(a);{const i=c*c;e*(t.staticFriction*t.staticFriction)>=i&&(o.subtractInPlace(a.scale(c)),c=0)}}{const s=l-c*c-e;if(e*((t.staticFriction+i)*(t.staticFriction+i))>=s&&0==c)return void r.copyFrom(n)}}else{if(e*(1+t.staticFriction*t.staticFriction)>=l)return void r.copyFrom(n)}}if(t.dynamicFriction<1){const e=o.lengthSquared();if(e>=s&&e>1e-4*l){let i=Math.sqrt(l/e);i=t.dynamicFriction+(1-t.dynamicFriction)*i,o.scaleInPlace(i);const r=t.planeNormal.dot(o);o.subtractInPlace(t.planeNormal.scale(r))}}r.copyFrom(o),r.addInPlace(n)}_simplexSolverSolveTest1d(e,t){const i=this._tmpVecs[23];return t.subtractToRef(e.velocity,i),i.dot(e.planeNormal)<-.001}_simplexSolverSolve2d(e,t,i,r,s,o){const a=i.planeNormal.cross(r.planeNormal),l=a.lengthSquared();let h=!1,c=null;for(;;){if(l<=1e-5||h)return e.getOutput(i).status=2,e.getOutput(r).status=2,void(i.priority>r.priority?(this._simplexSolverSolve1d(e,r,s,o),this._simplexSolverSolve1d(e,i,s,o)):(this._simplexSolverSolve1d(e,i,s,o),this._simplexSolverSolve1d(e,r,s,o)));const u=1/Math.sqrt(l);a.scaleInPlace(u);{const e=i.planeNormal.cross(r.planeNormal),s=r.planeNormal.cross(a),o=a.cross(i.planeNormal),l=i.velocity.add(r.velocity),d=this._tmpVecs[2];d.set(.5*a.dot(l),i.planeNormal.dot(i.velocity),r.planeNormal.dot(r.velocity));const p=n.uq.FromValues(e.x,s.x,o.x,0,e.y,s.y,o.y,0,e.z,s.z,o.z,0,0,0,0,1);if(c=n.Pq.TransformNormal(d,p),c.scaleInPlace(u),!(Math.abs(c.x)>t.x||Math.abs(c.y)>t.y||Math.abs(c.z)>t.z))break;h=!0}}const u=c,d=this._tmpVecs[24];s.subtractToRef(u,d);const p=d.lengthSquared(),m=this.up.dot(a);let f=d.dot(a),_=i.staticFriction+r.staticFriction;_+=m*f>0?(i.extraUpStaticFriction+r.extraUpStaticFriction)*m:(i.extraDownStaticFriction+r.extraDownStaticFriction)*m,_*=.5;const g=.5*(i.dynamicFriction+r.dynamicFriction),x=f*f;if((p-x)*(_*_)>=x)o.copyFrom(u);else{if(g<1&&f*f>1e-4*p){const e=1/f;f*=Math.abs(e)*Math.sqrt(p)*(1-g)+g}o.copyFrom(u),o.addInPlace(a.scale(f))}}_simplexSolverSolve3d(e,t,i,r,s,o,a,l){let h=null;{const c=r.planeNormal.cross(s.planeNormal),u=s.planeNormal.cross(i.planeNormal),d=i.planeNormal.cross(r.planeNormal),p=c.dot(i.planeNormal);let m=!1;for(;;){if(Math.abs(p)<1e-5||m){o&&(this._simplexSolverSortInfo(e),i=e.supportPlanes[0].constraint,r=e.supportPlanes[1].constraint,s=e.supportPlanes[2].constraint),e.getOutput(i).status=1,e.getOutput(r).status=1,e.getOutput(s).status=1;const n=e.numSupportPlanes;return this._simplexSolverSolve2d(e,t,i,r,a,l),n==e.numSupportPlanes&&this._simplexSolverSolve2d(e,t,i,s,a,l),void(n==e.numSupportPlanes&&this._simplexSolverSolve2d(e,t,r,s,a,l))}const f=this._tmpVecs[2];f.set(i.planeNormal.dot(i.velocity),r.planeNormal.dot(r.velocity),s.planeNormal.dot(s.velocity));const _=n.uq.FromValues(c.x,c.y,c.z,0,u.x,u.y,u.z,0,d.x,d.y,d.z,0,0,0,0,1);if(h=n.Pq.TransformNormal(f,_),h.scaleInPlace(1/p),!(Math.abs(h.x)>t.x||Math.abs(h.y)>t.y||Math.abs(h.z)>t.z))break;m=!0}}l.copyFrom(h)}_simplexSolverExamineActivePlanes(e,t,i,r){for(;;)switch(e.numSupportPlanes){case 1:{const t=e.supportPlanes[0].constraint;return void this._simplexSolverSolve1d(e,t,i,r)}case 2:{const s=n.Pq.Zero();this._simplexSolverSolve1d(e,e.supportPlanes[1].constraint,i,s);return void(this._simplexSolverSolveTest1d(e.supportPlanes[0].constraint,s)?this._simplexSolverSolve2d(e,t,e.supportPlanes[0].constraint,e.supportPlanes[1].constraint,i,r):(e.supportPlanes[0].copyFrom(e.supportPlanes[1]),e.numSupportPlanes=1,r.copyFrom(s)))}case 3:{const t=n.Pq.Zero();this._simplexSolverSolve1d(e,e.supportPlanes[2].constraint,i,r);if(!this._simplexSolverSolveTest1d(e.supportPlanes[0].constraint,t)){if(!this._simplexSolverSolveTest1d(e.supportPlanes[1].constraint,t)){r.copyFrom(t),e.supportPlanes[0].copyFrom(e.supportPlanes[2]),e.numSupportPlanes=1;continue}}}{let s=!1;for(let o=0;o<2;o++){const a=n.Pq.Zero();this._simplexSolverSolve2d(e,t,e.supportPlanes[o].constraint,e.supportPlanes[2].constraint,i,r);if(!this._simplexSolverSolveTest1d(e.supportPlanes[1-o].constraint,a)){e.supportPlanes[0].copyFrom(e.supportPlanes[o]),e.supportPlanes[1].copyFrom(e.supportPlanes[2]),e.numSupportPlanes--,s=!0;break}}if(s)continue}return void this._simplexSolverSolve3d(e,t,e.supportPlanes[0].constraint,e.supportPlanes[1].constraint,e.supportPlanes[2].constraint,!0,i,r);case 4:{this._simplexSolverSortInfo(e);let s=!1;for(let r=0;r<3;r++){const o=n.Pq.Zero();this._simplexSolverSolve3d(e,t,e.supportPlanes[(r+1)%3].constraint,e.supportPlanes[(r+2)%3].constraint,e.supportPlanes[3].constraint,!1,i,o);if(!this._simplexSolverSolveTest1d(e.supportPlanes[r].constraint,o)){e.supportPlanes[r].copyFrom(e.supportPlanes[2]),e.supportPlanes[2].copyFrom(e.supportPlanes[3]),e.numSupportPlanes=3,s=!0;break}}if(s)continue;{const s=i.clone(),n=e.supportPlanes[0].constraint,o=e.supportPlanes[1].constraint,a=e.supportPlanes[2].constraint,l=e.supportPlanes[3].constraint,h=e.numSupportPlanes;h==e.numSupportPlanes?this._simplexSolverSolve3d(e,t,n,o,a,!1,s,s):h==e.numSupportPlanes?this._simplexSolverSolve3d(e,t,n,o,l,!1,s,s):h==e.numSupportPlanes?this._simplexSolverSolve3d(e,t,n,a,l,!1,s,s):h==e.numSupportPlanes&&this._simplexSolverSolve3d(e,t,o,a,l,!1,s,s),r.copyFrom(s)}{let t=0;for(let i=0;i<4;i++)t=Math.max(t,e.supportPlanes[i].interaction.status);let i=0;for(;i<4;i++){if(t==e.supportPlanes[i].interaction.status){e.supportPlanes[i].copyFrom(e.supportPlanes[3]);break}e.numSupportPlanes--}}for(let t=0;t<3;t++)e.supportPlanes[t].interaction.status=0;continue}}}_simplexSolverSolve(e,t,i,r,s,o){const a=1e-6,l=new JE;l.position=n.Pq.Zero(),l.velocity=t.clone(),l.planeInteractions=[];let h=i;for(let t=0;t<e.length;t++)l.planeInteractions.push({touched:!1,stopped:!1,surfaceTime:0,penaltyDistance:0,status:0});const c=new tA;for(c.inputConstraints=e,c.outputInteractions=l.planeInteractions,c.supportPlanes[0]=new eA,c.supportPlanes[1]=new eA,c.supportPlanes[2]=new eA,c.supportPlanes[3]=new eA;h>0;){let s=-1,n=h;for(let t=0;t<e.length;t++){if(c.numSupportPlanes>=1&&c.supportPlanes[0].index==t)continue;if(c.numSupportPlanes>=2&&c.supportPlanes[1].index==t)continue;if(c.numSupportPlanes>=3&&c.supportPlanes[2].index==t)continue;if(0!=l.planeInteractions[t].status)continue;const i=e[t],r=this._tmpVecs[25];l.velocity.subtractToRef(i.velocity,r);const o=-r.dot(i.planeNormal);if(o<=0)continue;const h=this._tmpVecs[26];i.velocity.scaleToRef(c.currentTime,this._tmpVecs[27]),l.position.subtractToRef(this._tmpVecs[27],h);let u=i.planeNormal.dot(h);const d=l.planeInteractions[t].penaltyDistance;d<a&&(u=0),u+=d,u<n*o&&(n=u/o,s=t)}if(n>1e-4){c.currentTime+=n,h-=n,l.position.addInPlace(l.velocity.scale(n));for(let e=0;e<c.numSupportPlanes;e++)c.supportPlanes[e].interaction.surfaceTime+=n,c.supportPlanes[e].interaction.touched=!0;if(l.deltaTime=c.currentTime,c.currentTime>r)return l}if(s<0){l.deltaTime=i;break}const u=c.supportPlanes[c.numSupportPlanes++];u.constraint=e[s],u.interaction=l.planeInteractions[s],u.interaction.penaltyDistance=2*(u.interaction.penaltyDistance+a),u.index=s,this._simplexSolverExamineActivePlanes(c,o,t,l.velocity)}return l}checkSupport(e,t){const i={isSurfaceDynamic:!1,supportedState:0,averageSurfaceNormal:n.Pq.Zero(),averageSurfaceVelocity:n.Pq.Zero(),averageAngularSurfaceVelocity:n.Pq.Zero()};return this.checkSupportToRef(e,t,i),i}checkSupportToRef(e,t,i){const r=1e-4;this._validateManifold();const s=this._createConstraintsFromManifold(e,0),n=[];for(let e=0;e<s.length;e++)n.push(s[e].velocity.clone()),s[e].velocity.setAll(0);const o=this._tmpVecs[3];o.set(this.maxCharacterSpeedForSolver,this.maxCharacterSpeedForSolver,this.maxCharacterSpeedForSolver);const a=this._simplexSolverSolve(s,t,e,e,this.up,o);if(i.averageSurfaceVelocity.setAll(0),i.averageAngularSurfaceVelocity.setAll(0),i.averageSurfaceNormal.setAll(0),i.isSurfaceDynamic=!1,a.velocity.equalsWithEpsilon(t,r))return void(i.supportedState=0);if(a.velocity.lengthSquared()<r)i.supportedState=2;else{a.velocity.normalize();const e=a.velocity.dot(t);1-e*e<this.maxSlopeCosine*this.maxSlopeCosine?i.supportedState=1:i.supportedState=2}let l=0;for(let e=-0;e<s.length;e++)a.planeInteractions[e].touched&&s[e].planeNormal.dot(t)<-.08&&(i.averageSurfaceNormal.addInPlace(s[e].planeNormal),i.averageSurfaceVelocity.addInPlace(n[e]),i.averageAngularSurfaceVelocity.addInPlace(s[e].angularVelocity),l++);if(l>0&&(i.averageSurfaceNormal.normalize(),i.averageSurfaceVelocity.scaleInPlace(1/l),i.averageAngularSurfaceVelocity.scaleInPlace(1/l)),2==i.supportedState)for(let e=0;e<this._manifold.length;e++){const r=this._manifold[e].bodyB;if(this._manifold[e].normal.dot(t)<-.08&&2==r.body.getMotionType(0)){i.isSurfaceDynamic=!0;break}}}_castWithCollectors(e,t,i,r){const s=this._scene.getPhysicsEngine().getPhysicsPlugin(),n=s._hknp,o=[e.x,e.y,e.z],a=[this._orientation.x,this._orientation.y,this._orientation.z,this._orientation.w];if(null!=r){const e=[this._shape._pluginData,o,a,this.keepDistance+this.keepContactTolerance,!1,[BigInt(0)]];n.HP_World_ShapeProximityWithCollector(s.world,r,e)}{const e=[this._shape._pluginData,a,o,[t.x,t.y,t.z],!1,[BigInt(0)]];n.HP_World_ShapeCastWithCollector(s.world,i,e)}}_resolveContacts(e,t){for(let i=0;i<this._manifold.length;i++){const r=this._manifold[i],s=this._manifold[i].bodyB;if(2==s.body.getMotionType(s.index)){let i=0,o=0,a=n.Pq.Zero();const l=r.position,h=this._tmpVecs[19];this._getPointVelocityToRef(s,r.position,h),h.subtractInPlace(this._velocity);const c=h.dot(r.normal);let u=-c*.9;if(r.distance<0){const t=.4;u+=r.distance*t/e}if(u<0){const t=this._getInverseInertiaWorld(s),l=this._tmpVecs[15];this._getComWorldToRef(s,l);const h=this._tmpVecs[16];r.position.subtractToRef(l,h);const c=this._tmpVecs[17];n.Pq.CrossToRef(h,r.normal,c);const d=this._tmpVecs[18];n.Pq.TransformNormalToRef(c,t,d),i=d.dot(c)+this._getInvMass(s),o=u/i;const p=-this.characterStrength*e;o<p&&(o=p),a=r.normal.scale(o)}else o=0,i=this._getInvMass(s);{let i=r.normal.dot(t.scale(e));c<0&&(i-=c),i<-1e-12&&a.addInPlace(r.normal.scale(this.characterMass*i))}s.body.applyImpulse(a,l,s.index)}}}_getInverseInertiaWorld(e){const t=e.body.getMassProperties(e.index);if(!t.inertia||!t.inertiaOrientation)return n.uq.IdentityReadOnly;const i=n.uq.FromQuaternionToRef(t.inertiaOrientation,n.AA.Matrix[0]).invert(),r=n.AA.Matrix[1],s=i.getRowToRef(0,n.AA.Vector4[0]);return r.setRowFromFloats(0,t.inertia.x*s.x,t.inertia.x*s.y,t.inertia.x*s.z,0),i.getRowToRef(1,s),r.setRowFromFloats(0,t.inertia.y*s.x,t.inertia.y*s.y,t.inertia.y*s.z,0),i.getRowToRef(2,s),r.setRowFromFloats(0,t.inertia.z*s.x,t.inertia.z*s.y,t.inertia.z*s.z,0),i.multiplyToRef(r,this._tmpMatrix),this._tmpMatrix}_getComWorldToRef(e,t){const i=e.body.getMassProperties(e.index);n.Pq.TransformCoordinatesToRef(i.centerOfMass,e.body.transformNode.getWorldMatrix(),t)}_getInvMass(e){return 1/e.body.getMassProperties(e.index).mass}integrate(e,t,i){const r=this._scene.getPhysicsEngine().getPhysicsPlugin(),s=1/e;let o=e,a=n.Pq.Zero();const l=1e-4;{const e=l*s;if(this._velocity.equalsWithEpsilon(this._lastVelocity,e))this._lastDisplacement.scaleInPlace(o*this._lastInvDeltaTime);else{const e=this._velocity;if(2==t.supportedState){const i=this._tmpVecs[28];this._velocity.subtractToRef(t.averageSurfaceVelocity,i);const r=t.averageSurfaceNormal.dot(i);r<0&&(i.subtractInPlace(t.averageSurfaceNormal.scale(r)),e.copyFrom(i),e.addInPlace(t.averageSurfaceVelocity))}this._lastDisplacement.copyFrom(e),this._lastDisplacement.scaleInPlace(o)}this._lastVelocity.copyFrom(this._velocity),this._lastInvDeltaTime=s}this._validateManifold();for(let t=0;t<this.maxCastIterations&&o>1e-5;t++){this._castWithCollectors(this._position,this._position.add(this._lastDisplacement),this._castCollector,this._startCollector);const t=this._updateManifold(this._startCollector,this._castCollector,this._lastDisplacement),s=this._createConstraintsFromManifold(e,e-o),n=this._tmpVecs[3];n.set(this.maxCharacterSpeedForSolver,this.maxCharacterSpeedForSolver,this.maxCharacterSpeedForSolver);const h=0==this._velocity.lengthSquared()?0:.5*this.keepDistance/this._velocity.length(),c=this._simplexSolverSolve(s,this._velocity,o,h,this.up,n),u=c.position,d=c.deltaTime;a=c.velocity,this._resolveContacts(e,i);let p=-1;if(0!=t||u.lengthSquared()>1e-8&&!this._lastDisplacement.equalsWithEpsilon(u,l)){this._castWithCollectors(this._position,this._position.add(u),this._castCollector,this._startCollector);const e=r._hknp,t=e.HP_QueryCollector_GetNumHits(this._castCollector)[1];if(t>0)for(let i=0;i<t;i++){const[t,s,n]=e.HP_QueryCollector_GetShapeCastResult(this._castCollector,i)[1],o=iA(r,n,u,t,this.keepDistance);if(-1==this._findContact(o,this._manifold,.1)){p=this._manifold.length,this._manifold.push(o);break}}}if(p>=0){const e=this._manifold[p],t=1/u.length(),i=u.dot(e.normal)*t,r=this.keepDistance/-i;let s=e.fraction-r*t;s=Math.min(Math.max(s,0),1);const n=u.scale(s);this._position.addInPlace(n),o-=d*s}else this._position.addInPlace(u),o-=d;this._lastDisplacement.copyFrom(u)}this._velocity.copyFrom(a)}calculateMovementToRef(e,t,i,r,s,o,a,l){let h=t.cross(a);if(h.lengthSquared()<1e-5)return!1;h.normalize();const c=h.cross(i);c.normalize(),h=c.cross(i),h.normalize();const u=n.uq.FromValues(c.x,c.y,c.z,0,h.x,h.y,h.z,0,i.x,i.y,i.z,0,0,0,0,1),d=u.clone().invert();r.subtractToRef(s,this._tmpVecs[29]);const p=this._tmpVecs[30];n.Pq.TransformNormalToRef(this._tmpVecs[29],d,p);const m=a.cross(t),f=o.dot(t),_=o.dot(m),g=o.length(),x=this._tmpVecs[4];x.set(-f,_,0),x.normalize(),x.scaleInPlace(g);const v=this._tmpVecs[5];x.subtractToRef(p,v);{const t=v.lengthSquared(),i=this.maxAcceleration*e;let r;r=t*this.acceleration*this.acceleration>i*i?i/Math.sqrt(t):this.acceleration,v.scaleInPlace(r)}return p.addInPlace(v),n.Pq.TransformNormalToRef(p,u,l),l.addInPlace(s),!0}calculateMovement(e,t,i,r,s,o,a){const l=new n.Pq(0,0,0);return this.calculateMovementToRef(e,t,i,r,s,o,a,l),l}}class sA{constructor(e,t,i){this._vertices=[],this._indices=[],this._isRightHanded=i.useRightHandedSystem,this._collectIndices=t}addNodeMeshes(e,t){e.computeWorldMatrix(!0);const i=n.AA.Matrix[0];if(n.uq.ScalingToRef(e.absoluteScaling.x,e.absoluteScaling.y,e.absoluteScaling.z,i),e instanceof tt.e?this._addMesh(e,i):e instanceof mn.Z&&this._addMesh(e.sourceMesh,i),t){const t=n.AA.Matrix[1];e.computeWorldMatrix().invertToRef(t);const r=n.AA.Matrix[2];t.multiplyToRef(i,r);e.getChildMeshes(!1).filter((e=>!e.physicsBody)).forEach((e=>{const t=e.computeWorldMatrix(),i=n.AA.Matrix[3];t.multiplyToRef(r,i),e instanceof tt.e?this._addMesh(e,i):e instanceof mn.Z&&this._addMesh(e.sourceMesh,i)}))}}_addMesh(e,t){const i=e.getVerticesData(Ot.R.PositionKind)||[],r=i.length/3,s=this._vertices.length;for(let e=0;e<r;e++){const r=new n.Pq(i[3*e+0],i[3*e+1],i[3*e+2]);this._vertices.push(n.Pq.TransformCoordinates(r,t))}if(this._collectIndices){const t=e.getIndices();if(t)for(let e=0;e<t.length;e+=3)this._isRightHanded?(this._indices.push(t[e+0]+s),this._indices.push(t[e+1]+s),this._indices.push(t[e+2]+s)):(this._indices.push(t[e+2]+s),this._indices.push(t[e+1]+s),this._indices.push(t[e+0]+s))}}getVertices(e){const t=3*this._vertices.length,i=4*t,r=e._malloc(i),s=new Float32Array(e.HEAPU8.buffer,r,t);for(let e=0;e<this._vertices.length;e++)s[3*e+0]=this._vertices[e].x,s[3*e+1]=this._vertices[e].y,s[3*e+2]=this._vertices[e].z;return{offset:r,numObjects:t}}freeBuffer(e,t){e._free(t.offset)}getTriangles(e){const t=4*this._indices.length,i=e._malloc(t),r=new Int32Array(e.HEAPU8.buffer,i,this._indices.length);for(let e=0;e<this._indices.length;e++)r[e]=this._indices[e];return{offset:i,numObjects:this._indices.length}}}class nA{constructor(e){this.hpBodyId=e,this.userMassProps={centerOfMass:void 0,mass:void 0,inertia:void 0,inertiaOrientation:void 0}}}class oA{constructor(){this.bodyId=BigInt(0),this.position=new n.Pq,this.normal=new n.Pq}}class aA{constructor(){this.contactOnA=new oA,this.contactOnB=new oA,this.impulseApplied=0,this.type=0}static readToRef(e,t,i){const r=new Int32Array(e,t),s=new Float32Array(e,t);i.contactOnA.bodyId=BigInt(r[2]),i.contactOnA.position.set(s[10],s[11],s[12]),i.contactOnA.normal.set(s[13],s[14],s[15]);i.contactOnB.bodyId=BigInt(r[18]),i.contactOnB.position.set(s[26],s[27],s[28]),i.contactOnB.normal.set(s[29],s[30],s[31]),i.impulseApplied=s[34],i.type=r[0]}}class lA{constructor(){this.bodyIdA=BigInt(0),this.bodyIdB=BigInt(0),this.type=0}static readToRef(e,t,i){const r=new Int32Array(e,t);i.type=r[0],i.bodyIdA=BigInt(r[2]),i.bodyIdB=BigInt(r[6])}}class hA{constructor(e=!0,t=HK){this._useDeltaForWorldStep=e,this._hknp={},this.name="HavokPlugin",this._fixedTimeStep=1/60,this._tmpVec3=(0,Rt.mI)(3,n.Pq.Zero),this._bodies=new Map,this._shapes=new Map,this._bodyCollisionObservable=new Map,this._constraintToBodyIdPair=new Map,this._bodyCollisionEndedObservable=new Map,this.onCollisionObservable=new s.cP,this.onCollisionEndedObservable=new s.cP,this.onTriggerCollisionObservable=new s.cP,"function"!=typeof t?(this._hknp=t,this.isSupported()?(this.world=this._hknp.HP_World_Create()[1],this._queryCollector=this._hknp.HP_QueryCollector_Create(1)[1]):m.V.Error("Havok is not available. Please make sure you included the js file.")):m.V.Error("Havok is not ready. Please make sure you await HK() before using the plugin.")}isSupported(){return void 0!==this._hknp}setGravity(e){this._hknp.HP_World_SetGravity(this.world,this._bVecToV3(e))}setTimeStep(e){this._fixedTimeStep=e}getTimeStep(){return this._fixedTimeStep}executeStep(e,t){for(const e of t)e.disablePreStep||this.setPhysicsBodyTransformation(e,e.transformNode);const i=this._useDeltaForWorldStep?e:this._fixedTimeStep;this._hknp.HP_World_SetIdealStepTime(this.world,i),this._hknp.HP_World_Step(this.world,i),this._bodyBuffer=this._hknp.HP_World_GetBodyBuffer(this.world)[1];for(const e of t)e.disableSync||this.sync(e);this._notifyCollisions(),this._notifyTriggers()}getPluginVersion(){return 2}setVelocityLimits(e,t){this._hknp.HP_World_SetSpeedLimit(this.world,e,t)}getMaxLinearVelocity(){return this._hknp.HP_World_GetSpeedLimit(this.world)[1]}getMaxAngularVelocity(){return this._hknp.HP_World_GetSpeedLimit(this.world)[2]}initBody(e,t,i,r){e._pluginData=new nA(this._hknp.HP_Body_Create()[1]),this._internalSetMotionType(e._pluginData,t);const s=[this._bVecToV3(i),this._bQuatToV4(r)];this._hknp.HP_Body_SetQTransform(e._pluginData.hpBodyId,s),this._hknp.HP_World_AddBody(this.world,e._pluginData.hpBodyId,e.startAsleep),this._bodies.set(e._pluginData.hpBodyId[0],{body:e,index:0})}removeBody(e){if(e._pluginDataInstances&&e._pluginDataInstances.length>0)for(const t of e._pluginDataInstances)this._bodyCollisionObservable.delete(t.hpBodyId[0]),this._hknp.HP_World_RemoveBody(this.world,t.hpBodyId),this._bodies.delete(t.hpBodyId[0]);e._pluginData&&(this._bodyCollisionObservable.delete(e._pluginData.hpBodyId[0]),this._hknp.HP_World_RemoveBody(this.world,e._pluginData.hpBodyId),this._bodies.delete(e._pluginData.hpBodyId[0]))}initBodyInstances(e,t,i){const r=i._thinInstanceDataStorage?.instancesCount??0,s=i._thinInstanceDataStorage.matrixData;s&&(this._createOrUpdateBodyInstances(e,t,s,0,r,!1),e._pluginDataInstances.forEach(((t,i)=>{this._bodies.set(t.hpBodyId[0],{body:e,index:i})})))}_createOrUpdateBodyInstances(e,t,i,r,s,o){const a=n.AA.Quaternion[0],l=n.uq.Identity();for(let h=r;h<s;h++){const r=[i[16*h+12],i[16*h+13],i[16*h+14]];let s;s=o?e._pluginDataInstances[h].hpBodyId:this._hknp.HP_Body_Create()[1],l.setRowFromFloats(0,i[16*h+0],i[16*h+1],i[16*h+2],0),l.setRowFromFloats(1,i[16*h+4],i[16*h+5],i[16*h+6],0),l.setRowFromFloats(2,i[16*h+8],i[16*h+9],i[16*h+10],0),n.PT.FromRotationMatrixToRef(l,a);const c=[r,[a.x,a.y,a.z,a.w]];if(this._hknp.HP_Body_SetQTransform(s,c),!o){const i=new nA(s);e._pluginDataInstances.length&&(i.userMassProps=e._pluginDataInstances[0].userMassProps),this._internalSetMotionType(i,t),this._internalUpdateMassProperties(i),e._pluginDataInstances.push(i),this._hknp.HP_World_AddBody(this.world,s,e.startAsleep),i.worldTransformOffset=this._hknp.HP_Body_GetWorldTransformOffset(s)[1]}}}updateBodyInstances(e,t){const i=t._thinInstanceDataStorage?.instancesCount??0,r=t._thinInstanceDataStorage.matrixData;if(!r)return;const s=e._pluginDataInstances.length,n=this.getMotionType(e);if(i>s){this._createOrUpdateBodyInstances(e,n,r,s,i,!1);const t=this._hknp.HP_Body_GetShape(e._pluginDataInstances[0].hpBodyId)[1];t[0]||(t[0]=e.shape?._pluginData[0]);for(let r=s;r<i;r++)this._hknp.HP_Body_SetShape(e._pluginDataInstances[r].hpBodyId,t),this._internalUpdateMassProperties(e._pluginDataInstances[r]),this._bodies.set(e._pluginDataInstances[r].hpBodyId[0],{body:e,index:r})}else if(i<s){const t=s-i;for(let i=0;i<t;i++){const t=e._pluginDataInstances.pop();this._bodies.delete(t.hpBodyId[0]),this._hknp.HP_World_RemoveBody(this.world,t.hpBodyId),this._hknp.HP_Body_Release(t.hpBodyId)}this._createOrUpdateBodyInstances(e,n,r,0,i,!0)}}sync(e){this.syncTransform(e,e.transformNode)}syncTransform(e,t){if(e._pluginDataInstances.length){const i=t,r=i._thinInstanceDataStorage.matrixData;if(!r)return;const s=e._pluginDataInstances.length;for(let t=0;t<s;t++){const i=e._pluginDataInstances[t].worldTransformOffset,s=new Float32Array(this._hknp.HEAPU8.buffer,this._bodyBuffer+i,16),n=16*t;for(let e=0;e<15;e++)3&~e&&(r[n+e]=s[e]);r[n+15]=1}i.thinInstanceBufferUpdated("matrix")}else try{const i=this._hknp.HP_Body_GetQTransform(e._pluginData.hpBodyId)[1],r=i[0],s=i[1],o=n.AA.Quaternion[0];o.set(s[0],s[1],s[2],s[3]);const a=t.parent;if(a&&!a.getWorldMatrix().isIdentity()){a.computeWorldMatrix(!0),n.AA.Vector3[1].copyFrom(t.scaling),o.normalize();const e=n.AA.Matrix[0],i=n.AA.Vector3[0];i.copyFromFloats(r[0],r[1],r[2]),n.uq.ComposeToRef(t.absoluteScaling,o,i,e);const s=n.AA.Matrix[1];a.getWorldMatrix().invertToRef(s);const l=n.AA.Matrix[2];e.multiplyToRef(s,l),l.decomposeToTransformNode(t),t.rotationQuaternion?.normalize(),t.scaling.copyFrom(n.AA.Vector3[1])}else t.position.set(r[0],r[1],r[2]),t.rotationQuaternion?t.rotationQuaternion.copyFrom(o):o.toEulerAnglesToRef(t.rotation)}catch(e){m.V.Error(`Syncing transform failed for node ${t.name}: ${e.message}...`)}}setShape(e,t){const i=t&&t._pluginData?t._pluginData:BigInt(0);if(!(e.transformNode instanceof tt.e&&e.transformNode._thinInstanceDataStorage?.matrixData))return this._hknp.HP_Body_SetShape(e._pluginData.hpBodyId,i),void this._internalUpdateMassProperties(e._pluginData);const r=e.transformNode,s=r._thinInstanceDataStorage?.instancesCount??0;for(let t=0;t<s;t++)this._hknp.HP_Body_SetShape(e._pluginDataInstances[t].hpBodyId,i),this._internalUpdateMassProperties(e._pluginDataInstances[t])}_getPluginReference(e,t){return e._pluginDataInstances?.length?e._pluginDataInstances[t??0]:e._pluginData}getShape(e){const t=this._getPluginReference(e),i=this._hknp.HP_Body_GetShape(t.hpBodyId)[1];if(0!=i){const t=e.transformNode.getScene();return new ME({pluginData:i},t)}return null}getShapeType(e){return e.type?e.type:this._hknp.HP_Shape_GetType(e._pluginData)}setEventMask(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetEventMask(e.hpBodyId,t)}),i)}getEventMask(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetEventMask(i.hpBodyId)[1]}_fromMassPropertiesTuple(e){return{centerOfMass:n.Pq.FromArray(e[0]),mass:e[1],inertia:n.Pq.FromArray(e[2]),inertiaOrientation:n.PT.FromArray(e[3])}}_internalUpdateMassProperties(e){const t=this._internalComputeMassProperties(e),i=e.userMassProps;i.centerOfMass&&(t[0]=i.centerOfMass.asArray()),null!=i.mass&&(t[1]=i.mass),i.inertia&&(t[2]=i.inertia.asArray()),i.inertiaOrientation&&(t[3]=i.inertiaOrientation.asArray()),this._hknp.HP_Body_SetMassProperties(e.hpBodyId,t)}_internalSetMotionType(e,t){switch(t){case 0:this._hknp.HP_Body_SetMotionType(e.hpBodyId,this._hknp.MotionType.STATIC);break;case 1:this._hknp.HP_Body_SetMotionType(e.hpBodyId,this._hknp.MotionType.KINEMATIC);break;case 2:this._hknp.HP_Body_SetMotionType(e.hpBodyId,this._hknp.MotionType.DYNAMIC)}}setMotionType(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._internalSetMotionType(e,t)}),i)}getMotionType(e,t){const i=this._getPluginReference(e,t),r=this._hknp.HP_Body_GetMotionType(i.hpBodyId)[1];switch(r){case this._hknp.MotionType.STATIC:return 0;case this._hknp.MotionType.KINEMATIC:return 1;case this._hknp.MotionType.DYNAMIC:return 2}throw new Error("Unknown motion type: "+r)}setActivationControl(e,t){switch(t){case 1:this._hknp.HP_Body_SetActivationControl(e._pluginData.hpBodyId,this._hknp.ActivationControl.ALWAYS_ACTIVE);break;case 2:this._hknp.HP_Body_SetActivationControl(e._pluginData.hpBodyId,this._hknp.ActivationControl.ALWAYS_INACTIVE);break;case 0:this._hknp.HP_Body_SetActivationControl(e._pluginData.hpBodyId,this._hknp.ActivationControl.SIMULATION_CONTROLLED)}}_internalComputeMassProperties(e){const t=this._hknp.HP_Body_GetShape(e.hpBodyId);if(t[0]==this._hknp.Result.RESULT_OK){const e=this._hknp.HP_Shape_BuildMassProperties(t[1]);if(e[0]==this._hknp.Result.RESULT_OK)return e[1]}return[[0,0,0],1,[1,1,1],[0,0,0,1]]}computeMassProperties(e,t){const i=this._getPluginReference(e,t),r=this._internalComputeMassProperties(i);return this._fromMassPropertiesTuple(r)}setMassProperties(e,t,i){this._applyToBodyOrInstances(e,(e=>{e.userMassProps=t,this._internalUpdateMassProperties(e)}),i)}getMassProperties(e,t){const i=this._getPluginReference(e,t),r=this._hknp.HP_Body_GetMassProperties(i.hpBodyId)[1];return this._fromMassPropertiesTuple(r)}setLinearDamping(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetLinearDamping(e.hpBodyId,t)}),i)}getLinearDamping(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetLinearDamping(i.hpBodyId)[1]}setAngularDamping(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetAngularDamping(e.hpBodyId,t)}),i)}getAngularDamping(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetAngularDamping(i.hpBodyId)[1]}setLinearVelocity(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetLinearVelocity(e.hpBodyId,this._bVecToV3(t))}),i)}getLinearVelocityToRef(e,t,i){const r=this._getPluginReference(e,i),s=this._hknp.HP_Body_GetLinearVelocity(r.hpBodyId)[1];this._v3ToBvecRef(s,t)}_applyToBodyOrInstances(e,t,i){if(e._pluginDataInstances?.length>0&&void 0===i)for(let i=0;i<e._pluginDataInstances.length;i++)t(e._pluginDataInstances[i]);else t(this._getPluginReference(e,i))}applyImpulse(e,t,i,r){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_ApplyImpulse(e.hpBodyId,this._bVecToV3(i),this._bVecToV3(t))}),r)}applyAngularImpulse(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_ApplyAngularImpulse(e.hpBodyId,this._bVecToV3(t))}),i)}applyForce(e,t,i,r){t.scaleToRef(this.getTimeStep(),this._tmpVec3[0]),this.applyImpulse(e,this._tmpVec3[0],i,r)}setAngularVelocity(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetAngularVelocity(e.hpBodyId,this._bVecToV3(t))}),i)}getAngularVelocityToRef(e,t,i){const r=this._getPluginReference(e,i),s=this._hknp.HP_Body_GetAngularVelocity(r.hpBodyId)[1];this._v3ToBvecRef(s,t)}setPhysicsBodyTransformation(e,t){if(e.getPrestepType()==mE.TELEPORT){const i=e.transformNode;if(e.numInstances>0){const t=i._thinInstanceDataStorage.matrixData;if(!t)return;const r=e.numInstances;this._createOrUpdateBodyInstances(e,e.getMotionType(),t,0,r,!0)}else this._hknp.HP_Body_SetQTransform(e._pluginData.hpBodyId,this._getTransformInfos(t))}else e.getPrestepType()==mE.ACTION?this.setTargetTransform(e,t.absolutePosition,t.absoluteRotationQuaternion):e.getPrestepType()==mE.DISABLED?m.V.Warn("Prestep type is set to DISABLED. Unable to set physics body transformation."):m.V.Warn("Invalid prestep type set to physics body.")}setTargetTransform(e,t,i,r){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetTargetQTransform(e.hpBodyId,[this._bVecToV3(t),this._bQuatToV4(i)])}),r)}setGravityFactor(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetGravityFactor(e.hpBodyId,t)}),i)}getGravityFactor(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetGravityFactor(i.hpBodyId)[1]}disposeBody(e){if(e._pluginDataInstances&&e._pluginDataInstances.length>0)for(const t of e._pluginDataInstances)this._hknp.HP_Body_Release(t.hpBodyId),t.hpBodyId=void 0;e._pluginData&&(this._hknp.HP_Body_Release(e._pluginData.hpBodyId),e._pluginData.hpBodyId=void 0)}_createOptionsFromGroundMesh(e){const t=e.groundMesh;if(!t)return;let i=t.getVerticesData(Ot.R.PositionKind);const r=t.computeWorldMatrix(!0),s=[];let o;for(o=0;o<i.length;o+=3)n.Pq.FromArrayToRef(i,o,n.AA.Vector3[0]),n.Pq.TransformCoordinatesToRef(n.AA.Vector3[0],r,n.AA.Vector3[1]),n.AA.Vector3[1].toArray(s,o);i=s;const a=~~(Math.sqrt(i.length/3)-1),l=t.getBoundingInfo(),h=Math.min(l.boundingBox.extendSizeWorld.x,l.boundingBox.extendSizeWorld.z),c=l.boundingBox.minimumWorld.x,u=l.boundingBox.minimumWorld.y,d=l.boundingBox.minimumWorld.z,p=new Float32Array((a+1)*(a+1)),m=2*h/a;for(let e=0;e<p.length;e++)p[e]=u;for(let e=0;e<i.length;e+=3){const t=Math.round((i[e+0]-c)/m),r=a-Math.round((i[e+2]-d)/m),s=i[e+1]-u;p[r*(a+1)+t]=s}e.numHeightFieldSamplesX=a+1,e.numHeightFieldSamplesZ=a+1,e.heightFieldSizeX=2*l.boundingBox.extendSizeWorld.x,e.heightFieldSizeZ=2*l.boundingBox.extendSizeWorld.z,e.heightFieldData=p}initShape(e,t,i){switch(t){case 0:{const t=i.radius||1,r=i.center?this._bVecToV3(i.center):[0,0,0];e._pluginData=this._hknp.HP_Shape_CreateSphere(r,t)[1]}break;case 3:{const t=i.rotation?this._bQuatToV4(i.rotation):[0,0,0,1],r=i.extents?this._bVecToV3(i.extents):[1,1,1],s=i.center?this._bVecToV3(i.center):[0,0,0];e._pluginData=this._hknp.HP_Shape_CreateBox(s,t,r)[1]}break;case 1:{const t=i.pointA?this._bVecToV3(i.pointA):[0,0,0],r=i.pointB?this._bVecToV3(i.pointB):[0,1,0],s=i.radius||0;e._pluginData=this._hknp.HP_Shape_CreateCapsule(t,r,s)[1]}break;case 5:e._pluginData=this._hknp.HP_Shape_CreateContainer()[1];break;case 2:{const t=i.pointA?this._bVecToV3(i.pointA):[0,0,0],r=i.pointB?this._bVecToV3(i.pointB):[0,1,0],s=i.radius||0;e._pluginData=this._hknp.HP_Shape_CreateCylinder(t,r,s)[1]}break;case 4:case 6:{const r=i.mesh;if(!r)throw new Error("No mesh provided to create physics shape.");{const s=!!i.includeChildMeshes,n=new sA(r,4!=t,r?.getScene());n.addNodeMeshes(r,s);const o=n.getVertices(this._hknp),a=o.numObjects/3;if(4==t)e._pluginData=this._hknp.HP_Shape_CreateConvexHull(o.offset,a)[1];else{const t=n.getTriangles(this._hknp),i=t.numObjects/3;e._pluginData=this._hknp.HP_Shape_CreateMesh(o.offset,a,t.offset,i)[1],n.freeBuffer(this._hknp,t)}n.freeBuffer(this._hknp,o)}}break;case 7:if(i.groundMesh&&this._createOptionsFromGroundMesh(i),!(i.numHeightFieldSamplesX&&i.numHeightFieldSamplesZ&&i.heightFieldSizeX&&i.heightFieldSizeZ&&i.heightFieldData))throw new Error("Missing required heightfield parameters");{const t=i.numHeightFieldSamplesX*i.numHeightFieldSamplesZ,r=4*t,s=this._hknp._malloc(r),n=new Float32Array(this._hknp.HEAPU8.buffer,s,t);for(let e=0;e<i.numHeightFieldSamplesX;e++)for(let t=0;t<i.numHeightFieldSamplesZ;t++){const r=t*i.numHeightFieldSamplesX+e,s=(i.numHeightFieldSamplesX-1-e)*i.numHeightFieldSamplesZ+t;n[r]=i.heightFieldData[s]}const o=i.heightFieldSizeX/(i.numHeightFieldSamplesX-1),a=i.heightFieldSizeZ/(i.numHeightFieldSamplesZ-1);e._pluginData=this._hknp.HP_Shape_CreateHeightField(i.numHeightFieldSamplesX,i.numHeightFieldSamplesZ,[o,1,a],s)[1],this._hknp._free(s)}break;default:throw new Error("Unsupported Shape Type.")}this._shapes.set(e._pluginData[0],e)}setShapeFilterMembershipMask(e,t){const i=this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][1];this._hknp.HP_Shape_SetFilterInfo(e._pluginData,[t,i])}getShapeFilterMembershipMask(e){return this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][0]}setShapeFilterCollideMask(e,t){const i=this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][0];this._hknp.HP_Shape_SetFilterInfo(e._pluginData,[i,t])}getShapeFilterCollideMask(e){return this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][1]}setMaterial(e,t){const i=t.friction??.5,r=t.staticFriction??i,s=t.restitution??0,n=t.frictionCombine??1,o=t.restitutionCombine??2,a=[r,i,s,this._materialCombineToNative(n),this._materialCombineToNative(o)];this._hknp.HP_Shape_SetMaterial(e._pluginData,a)}getMaterial(e){const t=this._hknp.HP_Shape_GetMaterial(e._pluginData)[1];return{staticFriction:t[0],friction:t[1],restitution:t[2],frictionCombine:this._nativeToMaterialCombine(t[3]),restitutionCombine:this._nativeToMaterialCombine(t[4])}}setDensity(e,t){this._hknp.HP_Shape_SetDensity(e._pluginData,t)}getDensity(e){return this._hknp.HP_Shape_GetDensity(e._pluginData)[1]}_getTransformInfos(e){if(e.parent)return e.computeWorldMatrix(!0),[this._bVecToV3(e.absolutePosition),this._bQuatToV4(e.absoluteRotationQuaternion)];let t=n.AA.Quaternion[0];if(e.rotationQuaternion)t=e.rotationQuaternion;else{const i=e.rotation;n.PT.FromEulerAnglesToRef(i.x,i.y,i.z,t)}return[this._bVecToV3(e.position),this._bQuatToV4(t)]}addChild(e,t,i,r,s){const n=[i?this._bVecToV3(i):[0,0,0],r?this._bQuatToV4(r):[0,0,0,1],s?this._bVecToV3(s):[1,1,1]];this._hknp.HP_Shape_AddChild(e._pluginData,t._pluginData,n)}removeChild(e,t){this._hknp.HP_Shape_RemoveChild(e._pluginData,t)}getNumChildren(e){return this._hknp.HP_Shape_GetNumChildren(e._pluginData)[1]}setTrigger(e,t){this._hknp.HP_Shape_SetTrigger(e._pluginData,t)}getBoundingBox(e){const t=this._hknp.HP_Shape_GetBoundingBox(e._pluginData,[[0,0,0],[0,0,0,1]])[1];n.AA.Vector3[0].set(t[0][0],t[0][1],t[0][2]),n.AA.Vector3[1].set(t[1][0],t[1][1],t[1][2]);return new ms.I(n.AA.Vector3[0],n.AA.Vector3[1],n.uq.IdentityReadOnly)}getBodyBoundingBox(e){const t=this.getBoundingBox(e.shape);return new ms.I(t.minimum,t.maximum,e.transformNode.getWorldMatrix())}getBodyGeometry(e){const t=e._pluginDataInstances?.length>0?e._pluginDataInstances[0]:e._pluginData,i=this._hknp.HP_Body_GetShape(t.hpBodyId)[1],r=this._hknp.HP_Shape_CreateDebugDisplayGeometry(i);if(r[0]!=this._hknp.Result.RESULT_OK)return{positions:[],indices:[]};const s=this._hknp.HP_DebugGeometry_GetInfo(r[1])[1],n=new Float32Array(this._hknp.HEAPU8.buffer,s[0],3*s[1]),o=new Uint32Array(this._hknp.HEAPU8.buffer,s[2],3*s[3]),a=n.slice(0),l=o.slice(0);return this._hknp.HP_DebugGeometry_Release(r[1]),{positions:a,indices:l}}disposeShape(e){this._hknp.HP_Shape_Release(e._pluginData),e._pluginData=void 0}initConstraint(e,t,i,r,s){const o=e.type,a=e.options;if(!o||!a)return void m.V.Warn("No constraint type or options. Constraint is invalid.");if(t._pluginDataInstances.length>0&&void 0===r||i._pluginDataInstances.length>0&&void 0===s)return void m.V.Warn("Body is instanced but no instance index was specified. Constraint will not be applied.");e._pluginData=e._pluginData??[];const l=this._hknp.HP_Constraint_Create()[1];e._pluginData.push(l);const h=this._getPluginReference(t,r).hpBodyId,c=this._getPluginReference(i,s).hpBodyId;this._hknp.HP_Constraint_SetParentBody(l,h),this._hknp.HP_Constraint_SetChildBody(l,c),this._constraintToBodyIdPair.set(l[0],[h[0],c[0]]);const u=a.pivotA?this._bVecToV3(a.pivotA):this._bVecToV3(n.Pq.Zero()),d=a.axisA??new n.Pq(1,0,0),p=this._tmpVec3[0];a.perpAxisA?p.copyFrom(a.perpAxisA):d.getNormalToRef(p),this._hknp.HP_Constraint_SetAnchorInParent(l,u,this._bVecToV3(d),this._bVecToV3(p));const f=a.pivotB?this._bVecToV3(a.pivotB):this._bVecToV3(n.Pq.Zero()),_=a.axisB??new n.Pq(1,0,0),g=this._tmpVec3[0];if(a.perpAxisB?g.copyFrom(a.perpAxisB):_.getNormalToRef(g),this._hknp.HP_Constraint_SetAnchorInChild(l,f,this._bVecToV3(_),this._bVecToV3(g)),e._initOptions||(e._initOptions={axisA:d.clone(),axisB:_.clone(),perpAxisA:p.clone(),perpAxisB:g.clone(),pivotA:new n.Pq(u[0],u[1],u[2]),pivotB:new n.Pq(f[0],f[1],f[2])}),5==o)this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(2==o){const e=a.maxDistance||0,t=this._hknp.ConstraintAxis.LINEAR_DISTANCE;this._hknp.HP_Constraint_SetAxisMode(l,t,this._hknp.ConstraintAxisLimitMode.LIMITED),this._hknp.HP_Constraint_SetAxisMinLimit(l,t,e),this._hknp.HP_Constraint_SetAxisMaxLimit(l,t,e)}else if(3==o)this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(6==o)this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(4==o)this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(1==o)this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else{if(7!=o)throw new Error("Unsupported Constraint Type.");{const t=e;for(const e of t.limits){const t=this._constraintAxisToNative(e.axis);0==(e.minLimit??-1)&&0==(e.maxLimit??-1)?this._hknp.HP_Constraint_SetAxisMode(l,t,this._hknp.ConstraintAxisLimitMode.LOCKED):(null!=e.minLimit&&(this._hknp.HP_Constraint_SetAxisMode(l,t,this._hknp.ConstraintAxisLimitMode.LIMITED),this._hknp.HP_Constraint_SetAxisMinLimit(l,t,e.minLimit)),null!=e.maxLimit&&(this._hknp.HP_Constraint_SetAxisMode(l,t,this._hknp.ConstraintAxisLimitMode.LIMITED),this._hknp.HP_Constraint_SetAxisMaxLimit(l,t,e.maxLimit))),e.stiffness&&this._hknp.HP_Constraint_SetAxisStiffness(l,t,e.stiffness),e.damping&&this._hknp.HP_Constraint_SetAxisDamping(l,t,e.damping)}}}const x=!!a.collision;this._hknp.HP_Constraint_SetCollisionsEnabled(l,x),this._hknp.HP_Constraint_SetEnabled(l,!0)}getBodiesUsingConstraint(e){const t=[];for(const i of e._pluginData){const e=this._constraintToBodyIdPair.get(i[0]);if(e){const i=this._bodies.get(e[0]),r=this._bodies.get(e[1]);i&&r&&t.push({parentBody:i.body,parentBodyIndex:i.index,childBody:r.body,childBodyIndex:r.index})}}return t}addConstraint(e,t,i,r,s){this.initConstraint(i,e,t,r,s)}setEnabled(e,t){for(const i of e._pluginData)this._hknp.HP_Constraint_SetEnabled(i,t)}getEnabled(e){const t=e._pluginData&&e._pluginData[0];return!!t&&this._hknp.HP_Constraint_GetEnabled(t)[1]}setCollisionsEnabled(e,t){for(const i of e._pluginData)this._hknp.HP_Constraint_SetCollisionsEnabled(i,t)}getCollisionsEnabled(e){const t=e._pluginData&&e._pluginData[0];return!!t&&this._hknp.HP_Constraint_GetCollisionsEnabled(t)[1]}setAxisFriction(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisFriction(r,this._constraintAxisToNative(t),i)}getAxisFriction(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisFriction(i,this._constraintAxisToNative(t))[1]:null}setAxisMode(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisMode(r,this._constraintAxisToNative(t),this._limitModeToNative(i))}getAxisMode(e,t){const i=e._pluginData&&e._pluginData[0];if(i){const e=this._hknp.HP_Constraint_GetAxisMode(i,this._constraintAxisToNative(t))[1];return this._nativeToLimitMode(e)}return null}setAxisMinLimit(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisMinLimit(r,this._constraintAxisToNative(t),i)}getAxisMinLimit(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisMinLimit(i,this._constraintAxisToNative(t))[1]:null}setAxisMaxLimit(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisMaxLimit(r,this._constraintAxisToNative(t),i)}getAxisMaxLimit(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisMaxLimit(i,this._constraintAxisToNative(t))[1]:null}setAxisMotorType(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisMotorType(r,this._constraintAxisToNative(t),this._constraintMotorTypeToNative(i))}getAxisMotorType(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._nativeToMotorType(this._hknp.HP_Constraint_GetAxisMotorType(i,this._constraintAxisToNative(t))[1]):null}setAxisMotorTarget(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisMotorTarget(r,this._constraintAxisToNative(t),i)}getAxisMotorTarget(e,t){return e._pluginData&&e._pluginData[0]?this._hknp.HP_Constraint_GetAxisMotorTarget(e._pluginData,this._constraintAxisToNative(t))[1]:null}setAxisMotorMaxForce(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisMotorMaxForce(r,this._constraintAxisToNative(t),i)}getAxisMotorMaxForce(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisMotorMaxForce(i,this._constraintAxisToNative(t))[1]:null}disposeConstraint(e){for(const t of e._pluginData)this._hknp.HP_Constraint_SetEnabled(t,!1),this._hknp.HP_Constraint_Release(t);e._pluginData.length=0}_populateHitData(e,t){const i=this._bodies.get(e[0][0]);t.body=i?.body,t.bodyIndex=i?.index;const r=this._shapes.get(e[1][0]);t.shape=r;const s=e[3],n=e[4],o=e[5];t.setHitData({x:n[0],y:n[1],z:n[2]},{x:s[0],y:s[1],z:s[2]},o)}raycast(e,t,i,r){const s=r?.membership??-1,n=r?.collideWith??-1,o=r?.shouldHitTriggers??!1;i.reset(e,t);const a=[BigInt(0)],l=[this._bVecToV3(e),this._bVecToV3(t),[s,n],o,a];if(this._hknp.HP_World_CastRayWithCollector(this.world,this._queryCollector,l),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){const[,e]=this._hknp.HP_QueryCollector_GetCastRayResult(this._queryCollector,0)[1];this._populateHitData(e,i),i.calculateHitDistance()}}pointProximity(e,t){const i=e?.collisionFilter?.membership??-1,r=e?.collisionFilter?.collideWith??-1;t.reset();const s=e.ignoreBody?[BigInt(e.ignoreBody._pluginData.hpBodyId[0])]:[BigInt(0)],n=[this._bVecToV3(e.position),e.maxDistance,[i,r],e.shouldHitTriggers,s];if(this._hknp.HP_World_PointProximityWithCollector(this.world,this._queryCollector,n),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){const[e,i]=this._hknp.HP_QueryCollector_GetPointProximityResult(this._queryCollector,0)[1];this._populateHitData(i,t),t.setHitDistance(e)}}shapeProximity(e,t,i){t.reset(),i.reset();const r=e.shape._pluginData,s=e.ignoreBody?[BigInt(e.ignoreBody._pluginData.hpBodyId[0])]:[BigInt(0)],n=[r,this._bVecToV3(e.position),this._bQuatToV4(e.rotation),e.maxDistance,e.shouldHitTriggers,s];if(this._hknp.HP_World_ShapeProximityWithCollector(this.world,this._queryCollector,n),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){const[e,r,s]=this._hknp.HP_QueryCollector_GetShapeProximityResult(this._queryCollector,0)[1];this._populateHitData(r,t),this._populateHitData(s,i),t.setHitDistance(e),i.setHitDistance(e)}}shapeCast(e,t,i){t.reset(),i.reset();const r=e.shape._pluginData,s=e.ignoreBody?[BigInt(e.ignoreBody._pluginData.hpBodyId[0])]:[BigInt(0)],n=[r,this._bQuatToV4(e.rotation),this._bVecToV3(e.startPosition),this._bVecToV3(e.endPosition),e.shouldHitTriggers,s];if(this._hknp.HP_World_ShapeCastWithCollector(this.world,this._queryCollector,n),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){const[e,r,s]=this._hknp.HP_QueryCollector_GetShapeCastResult(this._queryCollector,0)[1];this._populateHitData(r,t),this._populateHitData(s,i),t.setHitFraction(e),i.setHitFraction(e)}}getCollisionObservable(e){const t=e._pluginData.hpBodyId[0];let i=this._bodyCollisionObservable.get(t);return i||(i=new s.cP,this._bodyCollisionObservable.set(t,i)),i}getCollisionEndedObservable(e){const t=e._pluginData.hpBodyId[0];let i=this._bodyCollisionEndedObservable.get(t);return i||(i=new s.cP,this._bodyCollisionEndedObservable.set(t,i)),i}setCollisionCallbackEnabled(e,t){const i=this._hknp.EventType.COLLISION_STARTED.value|this._hknp.EventType.COLLISION_CONTINUED.value|this._hknp.EventType.COLLISION_FINISHED.value;e._pluginDataInstances&&e._pluginDataInstances.length?e._pluginDataInstances.forEach((e=>{this._hknp.HP_Body_SetEventMask(e.hpBodyId,t?i:0)})):e._pluginData&&this._hknp.HP_Body_SetEventMask(e._pluginData.hpBodyId,t?i:0)}setCollisionEndedCallbackEnabled(e,t){const i=this._getPluginReference(e);let r=this._hknp.HP_Body_GetEventMask(i.hpBodyId)[1];r=t?r|this._hknp.EventType.COLLISION_FINISHED.value:r&~this._hknp.EventType.COLLISION_FINISHED.value,e._pluginDataInstances&&e._pluginDataInstances.length?e._pluginDataInstances.forEach((e=>{this._hknp.HP_Body_SetEventMask(e.hpBodyId,r)})):e._pluginData&&this._hknp.HP_Body_SetEventMask(e._pluginData.hpBodyId,r)}_notifyTriggers(){let e=this._hknp.HP_World_GetTriggerEvents(this.world)[1];const t=new lA;for(;e;){lA.readToRef(this._hknp.HEAPU8.buffer,e,t);const i=this._bodies.get(t.bodyIdA),r=this._bodies.get(t.bodyIdB);if(i&&r){const e={collider:i.body,colliderIndex:i.index,collidedAgainst:r.body,collidedAgainstIndex:r.index,type:this._nativeTriggerCollisionValueToCollisionType(t.type)};this.onTriggerCollisionObservable.notifyObservers(e)}e=this._hknp.HP_World_GetNextTriggerEvent(this.world,e)}}_notifyCollisions(){let e=this._hknp.HP_World_GetCollisionEvents(this.world)[1];const t=new aA,i=Number(this.world);for(;e;){aA.readToRef(this._hknp.HEAPU8.buffer,e,t);const r=this._bodies.get(t.contactOnA.bodyId),s=this._bodies.get(t.contactOnB.bodyId);if(r&&s){const e={collider:r.body,colliderIndex:r.index,collidedAgainst:s.body,collidedAgainstIndex:s.index,type:this._nativeCollisionValueToCollisionType(t.type)};if("COLLISION_FINISHED"===e.type)this.onCollisionEndedObservable.notifyObservers(e);else{t.contactOnB.position.subtractToRef(t.contactOnA.position,this._tmpVec3[0]);const i=n.Pq.Dot(this._tmpVec3[0],t.contactOnA.normal);e.point=t.contactOnA.position,e.distance=i,e.impulse=t.impulseApplied,e.normal=t.contactOnA.normal,this.onCollisionObservable.notifyObservers(e)}if(this._bodyCollisionObservable.size&&"COLLISION_FINISHED"!==e.type){const i=this._bodyCollisionObservable.get(t.contactOnA.bodyId),o=this._bodyCollisionObservable.get(t.contactOnB.bodyId);t.contactOnA.position.subtractToRef(t.contactOnB.position,this._tmpVec3[0]);const a=n.Pq.Dot(this._tmpVec3[0],t.contactOnB.normal);if(i&&i.notifyObservers(e),o){const e={collider:s.body,colliderIndex:s.index,collidedAgainst:r.body,collidedAgainstIndex:r.index,point:t.contactOnB.position,distance:a,impulse:t.impulseApplied,normal:t.contactOnB.normal,type:this._nativeCollisionValueToCollisionType(t.type)};o.notifyObservers(e)}}else if(this._bodyCollisionEndedObservable.size){const i=this._bodyCollisionEndedObservable.get(t.contactOnA.bodyId),o=this._bodyCollisionEndedObservable.get(t.contactOnB.bodyId);t.contactOnA.position.subtractToRef(t.contactOnB.position,this._tmpVec3[0]);const a=n.Pq.Dot(this._tmpVec3[0],t.contactOnB.normal);if(i&&i.notifyObservers(e),o){const e={collider:s.body,colliderIndex:s.index,collidedAgainst:r.body,collidedAgainstIndex:r.index,point:t.contactOnB.position,distance:a,impulse:t.impulseApplied,normal:t.contactOnB.normal,type:this._nativeCollisionValueToCollisionType(t.type)};o.notifyObservers(e)}}}e=this._hknp.HP_World_GetNextCollisionEvent(i,e)}}get numBodies(){return this._hknp.HP_World_GetNumBodies(this.world)[1]}dispose(){this._queryCollector&&(this._hknp.HP_QueryCollector_Release(this._queryCollector),this._queryCollector=void 0),this.world&&(this._hknp.HP_World_Release(this.world),this.world=void 0)}_v3ToBvecRef(e,t){t.set(e[0],e[1],e[2])}_bVecToV3(e){return[e._x,e._y,e._z]}_bQuatToV4(e){return[e._x,e._y,e._z,e._w]}_constraintMotorTypeToNative(e){switch(e){case 2:return this._hknp.ConstraintMotorType.POSITION;case 1:return this._hknp.ConstraintMotorType.VELOCITY}return this._hknp.ConstraintMotorType.NONE}_nativeToMotorType(e){switch(e){case this._hknp.ConstraintMotorType.POSITION:return 2;case this._hknp.ConstraintMotorType.VELOCITY:return 1}return 0}_materialCombineToNative(e){switch(e){case 0:return this._hknp.MaterialCombine.GEOMETRIC_MEAN;case 1:return this._hknp.MaterialCombine.MINIMUM;case 2:return this._hknp.MaterialCombine.MAXIMUM;case 3:return this._hknp.MaterialCombine.ARITHMETIC_MEAN;case 4:return this._hknp.MaterialCombine.MULTIPLY}}_nativeToMaterialCombine(e){switch(e){case this._hknp.MaterialCombine.GEOMETRIC_MEAN:return 0;case this._hknp.MaterialCombine.MINIMUM:return 1;case this._hknp.MaterialCombine.MAXIMUM:return 2;case this._hknp.MaterialCombine.ARITHMETIC_MEAN:return 3;case this._hknp.MaterialCombine.MULTIPLY:return 4;default:return}}_constraintAxisToNative(e){switch(e){case 0:return this._hknp.ConstraintAxis.LINEAR_X;case 1:return this._hknp.ConstraintAxis.LINEAR_Y;case 2:return this._hknp.ConstraintAxis.LINEAR_Z;case 3:return this._hknp.ConstraintAxis.ANGULAR_X;case 4:return this._hknp.ConstraintAxis.ANGULAR_Y;case 5:return this._hknp.ConstraintAxis.ANGULAR_Z;case 6:return this._hknp.ConstraintAxis.LINEAR_DISTANCE}}_nativeToLimitMode(e){switch(e){case this._hknp.ConstraintAxisLimitMode.FREE:return 0;case this._hknp.ConstraintAxisLimitMode.LIMITED:return 1;case this._hknp.ConstraintAxisLimitMode.LOCKED:return 2}return 0}_limitModeToNative(e){switch(e){case 0:return this._hknp.ConstraintAxisLimitMode.FREE;case 1:return this._hknp.ConstraintAxisLimitMode.LIMITED;case 2:return this._hknp.ConstraintAxisLimitMode.LOCKED}}_nativeCollisionValueToCollisionType(e){switch(e){case this._hknp.EventType.COLLISION_STARTED.value:return"COLLISION_STARTED";case this._hknp.EventType.COLLISION_FINISHED.value:return"COLLISION_FINISHED";case this._hknp.EventType.COLLISION_CONTINUED.value:return"COLLISION_CONTINUED"}return"COLLISION_STARTED"}_nativeTriggerCollisionValueToCollisionType(e){switch(e){case 8:return"TRIGGER_ENTERED";case 16:return"TRIGGER_EXITED"}return"TRIGGER_ENTERED"}}it.Z.prototype.getPhysicsEngine=function(){return this._physicsEngine},it.Z.prototype.enablePhysics=function(e=null,t){if(this._physicsEngine)return!0;let i=this._getComponent(Ei.v.NAME_PHYSICSENGINE);i||(i=new cA(this),this._addComponent(i));try{if(t&&1!==t?.getPluginVersion()){if(2!==t?.getPluginVersion())throw new Error("Unsupported Physics plugin version.");this._physicsEngine=new IE(e,t)}else this._physicsEngine=new ym(e,t);return this._physicsTimeAccumulator=0,!0}catch(e){return m.V.Error(e.message),!1}},it.Z.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=null)},it.Z.prototype.isPhysicsEnabled=function(){return void 0!==this._physicsEngine},it.Z.prototype.deleteCompoundImpostor=function(e){const t=e.parts[0].mesh;t.physicsImpostor&&(t.physicsImpostor.dispose(),t.physicsImpostor=null)},it.Z.prototype._advancePhysicsEngineStep=function(e){if(this._physicsEngine){const t=this._physicsEngine.getSubTimeStep();if(t>0)for(this._physicsTimeAccumulator+=e;this._physicsTimeAccumulator>t;)this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(t/1e3),this.onAfterPhysicsObservable.notifyObservers(this),this._physicsTimeAccumulator-=t;else this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(e/1e3),this.onAfterPhysicsObservable.notifyObservers(this)}};class cA{constructor(e){this.name=Ei.v.NAME_PHYSICSENGINE,this.scene=e,this.scene.onBeforePhysicsObservable=new s.cP,this.scene.onAfterPhysicsObservable=new s.cP,this.scene.getDeterministicFrameTime=()=>this.scene._physicsEngine?1e3*this.scene._physicsEngine.getTimeStep():1e3/60}register(){}rebuild(){}dispose(){this.scene.onBeforePhysicsObservable.clear(),this.scene.onAfterPhysicsObservable.clear(),this.scene._physicsEngine&&this.scene.disablePhysicsEngine()}}Object.defineProperty(mt.V.prototype,"physicsBody",{get:function(){return this._physicsBody},set:function(e){this._physicsBody!==e&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsBody=e,e&&(this._disposePhysicsObserver=this.onDisposeObservable.add((()=>{this.physicsBody&&(this.physicsBody.dispose(),this.physicsBody=null)}))))},enumerable:!0,configurable:!0}),mt.V.prototype.getPhysicsBody=function(){return this.physicsBody},mt.V.prototype.applyImpulse=function(e,t){if(!this.physicsBody)throw new Error("No Physics Body for TransformNode");return this.physicsBody.applyImpulse(e,t),this},mt.V.prototype.applyAngularImpulse=function(e){if(!this.physicsBody)throw new Error("No Physics Body for TransformNode");return this.physicsBody.applyAngularImpulse(e),this};class uA{static GetContactPointToRef(e,t,i,r,s){const n=e.getScene().getPhysicsEngine(),o=n?.getPluginVersion();if(1===o){const s=new st.Ray(t,i).intersectsMesh(e);if(s.hit&&s.pickedPoint)return r.copyFrom(s.pickedPoint),!0}else if(2===o)return e.physicsBody.getObjectCenterWorldToRef(r,s),!0;return!1}static HasAppliedForces(e,t){return 0===e.getMotionType(t)||0===(e.getMassProperties(t)?.mass??0)||0===e.transformNode?.getTotalVertices()}static IsInsideCylinder(e,t,i,r){const s=n.AA.Vector3[0];return e.subtractToRef(t,s),Math.abs(s.x)<=i&&Math.abs(s.z)<=i&&s.y>=0&&s.y<=r}}class dA{constructor(e){this._hitData={force:new n.Pq,contactPoint:new n.Pq,distanceFromOrigin:0},this._scene=e,this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine||m.V.Warn("Physics engine not enabled. Please enable the physics before you can use the methods.")}applyRadialExplosionImpulse(e,t,i,r){if(!this._physicsEngine)return m.V.Warn("Physics engine not enabled. Please enable the physics before you call this method."),null;if(1===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getImpostors().length)return null;if(2===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getBodies().length)return null;let s=!1;if("number"==typeof t){const e=t;(t=new gA).radius=e,t.strength=i??t.strength,t.falloff=r??t.falloff}else s=!(!t.affectedImpostorsCallback&&!t.affectedBodiesCallback);const n=new pA(this._scene,t),o=this._hitData;if(1===this._physicsEngine.getPluginVersion()){const t=Array();this._physicsEngine.getImpostors().forEach((i=>{n.getImpostorHitData(i,e,o)&&(i.applyImpulse(o.force,o.contactPoint),s&&t.push({impostor:i,hitData:this._copyPhysicsHitData(o)}))})),n.triggerAffectedImpostorsCallback(t)}else this._applicationForBodies(n,e,o,s,((e,t)=>{e.applyImpulse(t.force,t.contactPoint,t.instanceIndex)}));return n.dispose(!1),n}applyRadialExplosionForce(e,t,i,r){if(!this._physicsEngine)return m.V.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;if(1===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getImpostors().length)return null;if(2===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getBodies().length)return null;let s=!1;if("number"==typeof t){const e=t;(t=new gA).radius=e,t.strength=i??t.strength,t.falloff=r??t.falloff}else s=!(!t.affectedImpostorsCallback&&!t.affectedBodiesCallback);const n=new pA(this._scene,t),o=this._hitData;if(1===this._physicsEngine.getPluginVersion()){const t=Array();this._physicsEngine.getImpostors().forEach((i=>{n.getImpostorHitData(i,e,o)&&(i.applyForce(o.force,o.contactPoint),s&&t.push({impostor:i,hitData:this._copyPhysicsHitData(o)}))})),n.triggerAffectedImpostorsCallback(t)}else this._applicationForBodies(n,e,o,s,((e,t)=>{e.applyForce(t.force,t.contactPoint,t.instanceIndex)}));return n.dispose(!1),n}_applicationForBodies(e,t,i,r,s){const n=Array(),o=this._physicsEngine.getBodies();for(const a of o)a.iterateOverAllInstances(((o,a)=>{e.getBodyHitData(o,t,i,a)&&(s(o,i),r&&n.push({body:o,hitData:this._copyPhysicsHitData(i)}))}));e.triggerAffectedBodiesCallback(n)}gravitationalField(e,t,i,r){if(!this._physicsEngine)return m.V.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;if(1===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getImpostors().length)return null;if(2===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getBodies().length)return null;if("number"==typeof t){const e=t;(t=new gA).radius=e,t.strength=i??t.strength,t.falloff=r??t.falloff}const s=new mA(this,this._scene,e,t);return s.dispose(!1),s}updraft(e,t,i,r,s){if(!this._physicsEngine)return m.V.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;if(1===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getImpostors().length)return null;if(2===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getBodies().length)return null;if("number"==typeof t){const e=t;(t=new xA).radius=e,t.strength=i??t.strength,t.height=r??t.height,t.updraftMode=s??t.updraftMode}const n=new fA(this._scene,e,t);return n.dispose(!1),n}vortex(e,t,i,r){if(!this._physicsEngine)return m.V.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;if(1===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getImpostors().length)return null;if(2===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getBodies().length)return null;if("number"==typeof t){const e=t;(t=new vA).radius=e,t.strength=i??t.strength,t.height=r??t.height}const s=new _A(this._scene,e,t);return s.dispose(!1),s}_copyPhysicsHitData(e){return{force:e.force.clone(),contactPoint:e.contactPoint.clone(),distanceFromOrigin:e.distanceFromOrigin,instanceIndex:e.instanceIndex}}}class pA{constructor(e,t){this._scene=e,this._options=t,this._dataFetched=!1,this._options={...new gA,...this._options}}getData(){return this._dataFetched=!0,{sphere:this._sphere}}_getHitData(e,t,i,r){const s=n.AA.Vector3[0];s.copyFrom(t).subtractInPlace(i);const o=n.AA.Vector3[1];if(!uA.GetContactPointToRef(e,i,s,o,r.instanceIndex))return!1;const a=n.Pq.Distance(i,o);if(a>this._options.radius)return!1;const l=0===this._options.falloff?this._options.strength:this._options.strength*(1-a/this._options.radius);return s.scaleInPlace(l),r.force.copyFrom(s),r.contactPoint.copyFrom(o),r.distanceFromOrigin=a,!0}getBodyHitData(e,t,i,r){if(uA.HasAppliedForces(e,r))return!1;const s=e.transformNode,n=e.getObjectCenterWorld(r);return i.instanceIndex=r,this._getHitData(s,n,t,i)}getImpostorHitData(e,t,i){if(0===e.mass)return!1;if("Mesh"!==e.object.getClassName()&&"InstancedMesh"!==e.object.getClassName())return!1;const r=e.object;if(!this._intersectsWithSphere(r,t,this._options.radius))return!1;const s=e.getObjectCenter();return this._getHitData(r,s,t,i),!0}triggerAffectedImpostorsCallback(e){this._options.affectedImpostorsCallback&&this._options.affectedImpostorsCallback(e)}triggerAffectedBodiesCallback(e){this._options.affectedBodiesCallback&&this._options.affectedBodiesCallback(e)}dispose(e=!0){this._sphere&&(e?this._sphere.dispose():setTimeout((()=>{this._dataFetched||this._sphere.dispose()}),0))}_prepareSphere(){this._sphere||(this._sphere=zs("radialExplosionEventSphere",this._options.sphere,this._scene),this._sphere.isVisible=!1)}_intersectsWithSphere(e,t,i){return this._prepareSphere(),this._sphere.position=t,this._sphere.scaling.setAll(2*i),this._sphere._updateBoundingInfo(),this._sphere.computeWorldMatrix(!0),this._sphere.intersectsMesh(e,!0)}}class mA{constructor(e,t,i,r){this._physicsHelper=e,this._scene=t,this._origin=i,this._options=r,this._dataFetched=!1,this._options={...new gA,...this._options},this._tickCallback=()=>this._tick(),this._options.strength=-1*this._options.strength}getData(){return this._dataFetched=!0,{sphere:this._sphere}}enable(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)}disable(){this._scene.unregisterBeforeRender(this._tickCallback)}dispose(e=!0){this._sphere&&(e?this._sphere.dispose():setTimeout((()=>{this._dataFetched||this._sphere.dispose()}),0))}_tick(){if(this._sphere)this._physicsHelper.applyRadialExplosionForce(this._origin,this._options);else{const e=this._physicsHelper.applyRadialExplosionForce(this._origin,this._options);e&&(this._sphere=e.getData().sphere?.clone("radialExplosionEventSphereClone"))}}}class fA{constructor(e,t,i){this._scene=e,this._origin=t,this._options=i,this._originTop=n.Pq.Zero(),this._originDirection=n.Pq.Zero(),this._cylinderPosition=n.Pq.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options={...new xA,...this._options},this._origin.addToRef(new n.Pq(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new n.Pq(0,this._options.height,0),this._originTop),1===this._options.updraftMode&&(this._originDirection=this._origin.subtract(this._originTop).normalize()),this._tickCallback=()=>this._tick(),1===this._physicsEngine.getPluginVersion()&&this._prepareCylinder()}getData(){return this._dataFetched=!0,{cylinder:this._cylinder}}enable(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)}disable(){this._scene.unregisterBeforeRender(this._tickCallback)}dispose(e=!0){this._cylinder&&(e?(this._cylinder.dispose(),this._cylinder=void 0):setTimeout((()=>{!this._dataFetched&&this._cylinder&&(this._cylinder.dispose(),this._cylinder=void 0)}),0))}_getHitData(e,t){let i;i=1===this._options.updraftMode?this._originDirection:e.subtract(this._originTop);const r=n.Pq.Distance(this._origin,e),s=-1*this._options.strength,o=i.multiplyByFloats(s,s,s);t.force.copyFrom(o),t.contactPoint.copyFrom(e),t.distanceFromOrigin=r}_getBodyHitData(e,t,i){if(uA.HasAppliedForces(e))return!1;const r=e.getObjectCenterWorld(i);return!!uA.IsInsideCylinder(r,this._origin,this._options.radius,this._options.height)&&(t.instanceIndex=i,this._getHitData(r,t),!0)}_getImpostorHitData(e,t){if(0===e.mass)return!1;const i=e.object;if(!this._intersectsWithCylinder(i))return!1;const r=e.getObjectCenter();return this._getHitData(r,t),!0}_tick(){const e=fA._HitData;1===this._physicsEngine.getPluginVersion()?this._physicsEngine.getImpostors().forEach((t=>{this._getImpostorHitData(t,e)&&t.applyForce(e.force,e.contactPoint)})):this._physicsEngine.getBodies().forEach((t=>{t.iterateOverAllInstances(((t,i)=>{this._getBodyHitData(t,e,i)&&t.applyForce(e.force,e.contactPoint,e.instanceIndex)}))}))}_prepareCylinder(){this._cylinder||(this._cylinder=Es("updraftEventCylinder",{height:this._options.height,diameter:2*this._options.radius},this._scene),this._cylinder.isVisible=!1)}_intersectsWithCylinder(e){return!!this._cylinder&&(this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0))}}fA._HitData={force:new n.Pq,contactPoint:new n.Pq,distanceFromOrigin:0};class _A{constructor(e,t,i){this._scene=e,this._origin=t,this._options=i,this._originTop=n.Pq.Zero(),this._cylinderPosition=n.Pq.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options={...new vA,...this._options},this._origin.addToRef(new n.Pq(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new n.Pq(0,this._options.height,0),this._originTop),this._tickCallback=()=>this._tick(),1===this._physicsEngine.getPluginVersion()&&this._prepareCylinder()}getData(){return this._dataFetched=!0,{cylinder:this._cylinder}}enable(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)}disable(){this._scene.unregisterBeforeRender(this._tickCallback)}dispose(e=!0){this._cylinder&&(e?this._cylinder.dispose():setTimeout((()=>{this._dataFetched||this._cylinder.dispose()}),0))}_getHitData(e,t,i){const r=_A._OriginOnPlane;r.set(this._origin.x,t.y,this._origin.z);const s=n.AA.Vector3[0];t.subtractToRef(r,s);const o=n.AA.Vector3[1];if(!uA.GetContactPointToRef(e,r,s,o,i.instanceIndex))return!1;const a=n.Pq.Distance(o,r)/this._options.radius,l=n.AA.Vector3[2];let h,c,u;if(o.normalizeToRef(l),a>this._options.centripetalForceThreshold&&l.negateInPlace(),a>this._options.centripetalForceThreshold)h=l.x*this._options.centripetalForceMultiplier,c=l.y*this._options.updraftForceMultiplier,u=l.z*this._options.centripetalForceMultiplier;else{const e=n.Pq.Cross(r,t).normalize();h=(e.x+l.x)*this._options.centrifugalForceMultiplier,c=this._originTop.y*this._options.updraftForceMultiplier,u=(e.z+l.z)*this._options.centrifugalForceMultiplier}const d=n.AA.Vector3[3];return d.set(h,c,u),d.scaleInPlace(this._options.strength),i.force.copyFrom(d),i.contactPoint.copyFrom(t),i.distanceFromOrigin=a,!0}_getBodyHitData(e,t,i){if(uA.HasAppliedForces(e,i))return!1;const r=e.transformNode,s=e.getObjectCenterWorld(i);return!!uA.IsInsideCylinder(s,this._origin,this._options.radius,this._options.height)&&(t.instanceIndex=i,this._getHitData(r,s,t))}_getImpostorHitData(e,t){if(0===e.mass)return!1;if("Mesh"!==e.object.getClassName()&&"InstancedMesh"!==e.object.getClassName())return!1;const i=e.object;if(!this._intersectsWithCylinder(i))return!1;const r=e.getObjectCenter();return this._getHitData(i,r,t),!0}_tick(){const e=_A._HitData;1===this._physicsEngine.getPluginVersion()?this._physicsEngine.getImpostors().forEach((t=>{this._getImpostorHitData(t,e)&&t.applyForce(e.force,e.contactPoint)})):this._physicsEngine.getBodies().forEach((t=>{t.iterateOverAllInstances(((t,i)=>{this._getBodyHitData(t,e,i)&&t.applyForce(e.force,e.contactPoint,e.instanceIndex)}))}))}_prepareCylinder(){this._cylinder||(this._cylinder=Es("vortexEventCylinder",{height:this._options.height,diameter:2*this._options.radius},this._scene),this._cylinder.isVisible=!1)}_intersectsWithCylinder(e){return this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0)}}_A._OriginOnPlane=n.Pq.Zero(),_A._HitData={force:new n.Pq,contactPoint:new n.Pq,distanceFromOrigin:0};class gA{constructor(){this.radius=5,this.strength=10,this.falloff=0,this.sphere={segments:32,diameter:1}}}class xA{constructor(){this.radius=5,this.strength=10,this.height=10,this.updraftMode=0}}class vA{constructor(){this.radius=5,this.strength=10,this.height=10,this.centripetalForceThreshold=.7,this.centripetalForceMultiplier=5,this.centrifugalForceMultiplier=.5,this.updraftForceMultiplier=.02}}!function(e){e[e.Constant=0]="Constant",e[e.Linear=1]="Linear"}(vE||(vE={})),function(e){e[e.Center=0]="Center",e[e.Perpendicular=1]="Perpendicular"}(SE||(SE={}));class SA extends Sm{constructor(){super(...arguments),this._hitDistance=0}get hitDistance(){return this._hitDistance}setHitDistance(e){this._hitDistance=e}reset(){super.reset(),this._hitDistance=0}}class bA extends Sm{constructor(){super(...arguments),this._hitFraction=0}get hitFraction(){return this._hitFraction}setHitFraction(e){this._hitFraction=e}}class yA extends Fi.w{get degree(){return this._effectWrapper.degree}set degree(e){this._effectWrapper.degree=e}getClassName(){return"BlackAndWhitePostProcess"}constructor(e,t,i=null,r,s,n){const o={uniforms:vc.Uniforms,size:"number"==typeof t?t:void 0,camera:i,samplingMode:r,engine:s,reusable:n,...t};super(e,vc.FragmentUrl,{effectWrapper:"number"!=typeof t&&t.effectWrapper?void 0:new vc(e,s,o),...o})}static _Parse(e,t,i,r){return Ue.p.Parse((()=>new yA(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,r)}}(0,Ge.Cg)([(0,ze.lK)()],yA.prototype,"degree",null),(0,a.Y5)("BABYLON.BlackAndWhitePostProcess",yA);class PA{constructor(e,t,i,r){this._name=t,this._singleInstance=r||!0,this._getPostProcesses=i,this._cameras={},this._indicesForCamera={},this._postProcesses={}}get isSupported(){for(const e in this._postProcesses)if(Object.prototype.hasOwnProperty.call(this._postProcesses,e)){const t=this._postProcesses[e];for(let e=0;e<t.length;e++)if(!t[e].isSupported)return!1}return!0}_update(){}_attachCameras(e){let t;const i=H.S0.MakeArray(e||this._cameras);if(i)for(let e=0;e<i.length;e++){const r=i[e];if(!r)continue;const s=r.name;if(t=this._singleInstance?0:s,!this._postProcesses[t]){const e=this._getPostProcesses();e&&(this._postProcesses[t]=Array.isArray(e)?e:[e])}this._indicesForCamera[s]||(this._indicesForCamera[s]=[]),this._postProcesses[t].forEach((e=>{const t=r.attachPostProcess(e);this._indicesForCamera[s].push(t)})),this._cameras[s]||(this._cameras[s]=r)}}_detachCameras(e){const t=H.S0.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){const i=t[e],r=i.name,s=this._postProcesses[this._singleInstance?0:r];s&&s.forEach((e=>{i.detachPostProcess(e)})),this._cameras[r]&&(this._cameras[r]=null),delete this._indicesForCamera[r]}}_enable(e){const t=H.S0.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){const i=t[e],r=i.name,s=this._singleInstance?0:r;for(let n=0;n<this._indicesForCamera[r].length;n++){const o=this._indicesForCamera[r][n],a=i._postProcesses[o];null==a&&t[e].attachPostProcess(this._postProcesses[s][n],o)}}}_disable(e){const t=H.S0.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){const i=t[e],r=i.name;this._postProcesses[this._singleInstance?0:r].forEach((e=>{i.detachPostProcess(e)}))}}getPostProcesses(e){return this._singleInstance?this._postProcesses[0]:e?this._postProcesses[e.name]:null}}class TA extends Fi.w{get threshold(){return this._effectWrapper.threshold}set threshold(e){this._effectWrapper.threshold=e}get _exposure(){return this._effectWrapper._exposure}set _exposure(e){this._effectWrapper._exposure=e}getClassName(){return"ExtractHighlightsPostProcess"}constructor(e,t,i=null,r,s,n,o=0,a=!1){const l={uniforms:Tc.Uniforms,size:"number"==typeof t?t:void 0,camera:i,samplingMode:r,engine:s,reusable:n,textureType:o,blockCompilation:a,...t};super(e,Tc.FragmentUrl,{effectWrapper:"number"!=typeof t&&t.effectWrapper?void 0:new Tc(e,s,l),...l}),this._inputPostProcess=null,this.onApplyObservable.add((e=>{this.externalTextureSamplerBinding=!!this._inputPostProcess,this._inputPostProcess&&e.setTextureFromPostProcess("textureSampler",this._inputPostProcess)}))}}(0,Ge.Cg)([(0,ze.lK)()],TA.prototype,"threshold",null),(0,a.Y5)("BABYLON.ExtractHighlightsPostProcess",TA);class CA extends Fi.w{get weight(){return this._effectWrapper.weight}set weight(e){this._effectWrapper.weight=e}getClassName(){return"BloomMergePostProcess"}constructor(e,t,i,r,s,n=null,o,a,l,h=0,c=!1){const u="number"==typeof s?c:!!s.blockCompilation,d={uniforms:yc.Uniforms,samplers:yc.Samplers,size:"number"==typeof s?s:void 0,camera:n,samplingMode:o,engine:a,reusable:l,textureType:h,...s,blockCompilation:!0};super(e,yc.FragmentUrl,{effectWrapper:"number"!=typeof s&&s.effectWrapper?void 0:new yc(e,a,d),...d}),this.weight=r,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("textureSampler",t),e.setTextureFromPostProcessOutput("bloomBlur",i)})),u||this.updateEffect()}}(0,Ge.Cg)([(0,ze.lK)()],CA.prototype,"weight",null),(0,a.Y5)("BABYLON.BloomMergePostProcess",CA);class EA extends PA{get threshold(){return this._thinBloomEffect.threshold}set threshold(e){this._thinBloomEffect.threshold=e}get weight(){return this._thinBloomEffect.weight}set weight(e){this._thinBloomEffect.weight=e}get kernel(){return this._thinBloomEffect.kernel}set kernel(e){this._thinBloomEffect.kernel=e}get bloomScale(){return this._thinBloomEffect.scale}constructor(e,t,i,r,s=0,n=!1){const o=e._renderForCamera?e.getEngine():e;super(o,"bloom",(()=>this._effects),!0),this._effects=[],this._thinBloomEffect=new Cc("bloom",o,t,n),this._downscale=new TA("highlights",{size:1,samplingMode:$e.g.BILINEAR_SAMPLINGMODE,engine:o,textureType:s,blockCompilation:n,effectWrapper:this._thinBloomEffect._downscale}),this._blurX=new Ch("horizontal blur",this._thinBloomEffect._blurX.direction,this._thinBloomEffect._blurX.kernel,{size:t,samplingMode:$e.g.BILINEAR_SAMPLINGMODE,engine:o,textureType:s,blockCompilation:n,effectWrapper:this._thinBloomEffect._blurX}),this._blurX.alwaysForcePOT=!0,this._blurX.autoClear=!1,this._blurY=new Ch("vertical blur",this._thinBloomEffect._blurY.direction,this._thinBloomEffect._blurY.kernel,{size:t,samplingMode:$e.g.BILINEAR_SAMPLINGMODE,engine:o,textureType:s,blockCompilation:n,effectWrapper:this._thinBloomEffect._blurY}),this._blurY.alwaysForcePOT=!0,this._blurY.autoClear=!1,this.kernel=r,this._effects=[this._downscale,this._blurX,this._blurY],this._merge=new CA("bloomMerge",this._downscale,this._blurY,i,{size:t,samplingMode:$e.g.BILINEAR_SAMPLINGMODE,engine:o,textureType:s,blockCompilation:n,effectWrapper:this._thinBloomEffect._merge}),this._merge.autoClear=!1,this._effects.push(this._merge)}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){return this._thinBloomEffect.isReady()}}class AA extends Fi.w{get aberrationAmount(){return this._effectWrapper.aberrationAmount}set aberrationAmount(e){this._effectWrapper.aberrationAmount=e}get radialIntensity(){return this._effectWrapper.radialIntensity}set radialIntensity(e){this._effectWrapper.radialIntensity=e}get direction(){return this._effectWrapper.direction}set direction(e){this._effectWrapper.direction=e}get centerPosition(){return this._effectWrapper.centerPosition}set centerPosition(e){this._effectWrapper.centerPosition=e}get screenWidth(){return this._effectWrapper.screenWidth}set screenWidth(e){this._effectWrapper.screenWidth=e}get screenHeight(){return this._effectWrapper.screenHeight}set screenHeight(e){this._effectWrapper.screenHeight=e}getClassName(){return"ChromaticAberrationPostProcess"}constructor(e,t,i,r,s,n,o,a,l=0,h=!1){const c={uniforms:Mc.Uniforms,size:"number"==typeof r?r:void 0,camera:s,samplingMode:n,engine:o,reusable:a,textureType:l,blockCompilation:h,...r};super(e,Mc.FragmentUrl,{effectWrapper:"number"!=typeof r&&r.effectWrapper?void 0:new Mc(e,o,c),...c}),this.screenWidth=t,this.screenHeight=i}static _Parse(e,t,i,r){return Ue.p.Parse((()=>new AA(e.name,e.screenWidth,e.screenHeight,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1)),e,i,r)}}(0,Ge.Cg)([(0,ze.lK)()],AA.prototype,"aberrationAmount",null),(0,Ge.Cg)([(0,ze.lK)()],AA.prototype,"radialIntensity",null),(0,Ge.Cg)([(0,ze.lK)()],AA.prototype,"direction",null),(0,Ge.Cg)([(0,ze.lK)()],AA.prototype,"centerPosition",null),(0,Ge.Cg)([(0,ze.lK)()],AA.prototype,"screenWidth",null),(0,Ge.Cg)([(0,ze.lK)()],AA.prototype,"screenHeight",null),(0,a.Y5)("BABYLON.ChromaticAberrationPostProcess",AA);class IA extends Fi.w{get lensSize(){return this._effectWrapper.lensSize}set lensSize(e){this._effectWrapper.lensSize=e}get fStop(){return this._effectWrapper.fStop}set fStop(e){this._effectWrapper.fStop=e}get focusDistance(){return this._effectWrapper.focusDistance}set focusDistance(e){this._effectWrapper.focusDistance=e}get focalLength(){return this._effectWrapper.focalLength}set focalLength(e){this._effectWrapper.focalLength=e}getClassName(){return"CircleOfConfusionPostProcess"}constructor(e,t,i,r,s,n,o,a=0,l=!1){const h={uniforms:Nc.Uniforms,samplers:Nc.Samplers,defines:"object"==typeof i&&i.depthNotNormalized?Nc.DefinesDepthNotNormalized:void 0,size:"number"==typeof i?i:void 0,camera:r,samplingMode:s,engine:n,reusable:o,textureType:a,blockCompilation:l,...i};super(e,Nc.FragmentUrl,{effectWrapper:"number"!=typeof i&&i.effectWrapper?void 0:new Nc(e,n,h),...h}),this._depthTexture=null,this._depthTexture=t,this.onApplyObservable.add((e=>{this._depthTexture?(e.setTexture("depthSampler",this._depthTexture),this._effectWrapper.camera=this._depthTexture.activeCamera):m.V.Warn("No depth texture set on CircleOfConfusionPostProcess")}))}set depthTexture(e){this._depthTexture=e}}(0,Ge.Cg)([(0,ze.lK)()],IA.prototype,"lensSize",null),(0,Ge.Cg)([(0,ze.lK)()],IA.prototype,"fStop",null),(0,Ge.Cg)([(0,ze.lK)()],IA.prototype,"focusDistance",null),(0,Ge.Cg)([(0,ze.lK)()],IA.prototype,"focalLength",null),(0,a.Y5)("BABYLON.CircleOfConfusionPostProcess",IA);class RA extends Fi.w{getClassName(){return"ColorCorrectionPostProcess"}constructor(e,t,i,r,s,n,o){super(e,"colorCorrection",null,["colorTable"],i,r,s,n,o);const a=r?.getScene()||null;this._colorTableTexture=new $e.g(t,a,!0,!1,$e.g.TRILINEAR_SAMPLINGMODE),this._colorTableTexture.anisotropicFilteringLevel=1,this._colorTableTexture.wrapU=$e.g.CLAMP_ADDRESSMODE,this._colorTableTexture.wrapV=$e.g.CLAMP_ADDRESSMODE,this.colorTableUrl=t,this.onApply=e=>{e.setTexture("colorTable",this._colorTableTexture)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,53813))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,37670))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return Ue.p.Parse((()=>new RA(e.name,e.colorTableUrl,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,r)}}(0,Ge.Cg)([(0,ze.lK)()],RA.prototype,"colorTableUrl",void 0),(0,a.Y5)("BABYLON.ColorCorrectionPostProcess",RA);class MA extends Fi.w{getClassName(){return"ConvolutionPostProcess"}constructor(e,t,i,r,s,n,o,a=0){super(e,"convolution",["kernel","screenSize"],null,i,r,s,n,o,null,a),this.kernel=t,this.onApply=e=>{e.setFloat2("screenSize",this.width,this.height),e.setArray("kernel",this.kernel)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,52906))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,51537))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return Ue.p.Parse((()=>new MA(e.name,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType)),e,i,r)}}MA.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],MA.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],MA.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],MA.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],MA.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],MA.GaussianKernel=[0,1,0,1,1,1,0,1,0],(0,Ge.Cg)([(0,ze.lK)()],MA.prototype,"kernel",void 0),(0,a.Y5)("BABYLON.ConvolutionPostProcess",MA);class DA extends Ch{getClassName(){return"DepthOfFieldBlurPostProcess"}constructor(e,t,i,r,s,n,o,a=null,l=$e.g.BILINEAR_SAMPLINGMODE,h,c,u=0,d=!1,p=5){super(e,i,r,{camera:n,engine:h,reusable:c,textureType:u,defines:"#define DOF 1\n",blockCompilation:d,textureFormat:p,...s,samplingMode:2}),this.externalTextureSamplerBinding=!!a,this.onApplyObservable.add((e=>{null!=a&&e.setTextureFromPostProcess("textureSampler",a),e.setTextureFromPostProcessOutput("circleOfConfusionSampler",o)}))}}(0,a.Y5)("BABYLON.DepthOfFieldBlurPostProcess",DA);class OA extends Fi.w{getClassName(){return"DepthOfFieldMergePostProcess"}constructor(e,t,i,r,s,n,o,a,l,h=0,c=!1){const u="number"==typeof s?c:!!s.blockCompilation,d={samplers:Bc.Samplers,size:"number"==typeof s?s:void 0,camera:n,samplingMode:o,engine:a,reusable:l,textureType:h,...s,blockCompilation:!0};super(e,Bc.FragmentUrl,{effectWrapper:"number"!=typeof s&&s.effectWrapper?void 0:new Bc(e,a,d),...d}),this._blurSteps=r,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("textureSampler",t),e.setTextureFromPostProcessOutput("circleOfConfusionSampler",i),r.forEach(((t,i)=>{e.setTextureFromPostProcessOutput("blurStep"+(r.length-i-1),t)}))})),u||this.updateEffect()}updateEffect(e=null,t=null,i=null,r,s,n){e||(e="",e+="#define BLUR_LEVEL "+(this._blurSteps.length-1)+"\n"),super.updateEffect(e,t,i,r,s,n)}}!function(e){e[e.Low=0]="Low",e[e.Medium=1]="Medium",e[e.High=2]="High"}(bE||(bE={}));class NA extends PA{set focalLength(e){this._thinDepthOfFieldEffect.focalLength=e}get focalLength(){return this._thinDepthOfFieldEffect.focalLength}set fStop(e){this._thinDepthOfFieldEffect.fStop=e}get fStop(){return this._thinDepthOfFieldEffect.fStop}set focusDistance(e){this._thinDepthOfFieldEffect.focusDistance=e}get focusDistance(){return this._thinDepthOfFieldEffect.focusDistance}set lensSize(e){this._thinDepthOfFieldEffect.lensSize=e}get lensSize(){return this._thinDepthOfFieldEffect.lensSize}constructor(e,t,i=0,r=0,s=!1,n=!1){const o=e._renderForCamera?e.getEngine():e;super(o,"depth of field",(()=>this._effects),!0),this._effects=[],this._thinDepthOfFieldEffect=new Gc("Depth of Field",o,i,!1,s);const a=o.isWebGPU||o.version>1?6:5;this._circleOfConfusion=new IA("circleOfConfusion",t,{size:1,samplingMode:$e.g.BILINEAR_SAMPLINGMODE,engine:o,textureType:r,blockCompilation:s,depthNotNormalized:n,effectWrapper:this._thinDepthOfFieldEffect._circleOfConfusion},null),this._depthOfFieldBlurY=[],this._depthOfFieldBlurX=[];const l=this._thinDepthOfFieldEffect._depthOfFieldBlurX.length;for(let e=0;e<l;e++){const[t,i]=this._thinDepthOfFieldEffect._depthOfFieldBlurY[e],n=new DA("vertical blur",null,t.direction,t.kernel,{size:i,samplingMode:$e.g.BILINEAR_SAMPLINGMODE,engine:o,textureType:r,blockCompilation:s,textureFormat:0==e?a:5,effectWrapper:t},null,this._circleOfConfusion,0==e?this._circleOfConfusion:null);n.autoClear=!1;const[l,h]=this._thinDepthOfFieldEffect._depthOfFieldBlurX[e],c=new DA("horizontal blur",null,l.direction,l.kernel,{size:h,samplingMode:$e.g.BILINEAR_SAMPLINGMODE,engine:o,textureType:r,blockCompilation:s,effectWrapper:l},null,this._circleOfConfusion,null);c.autoClear=!1,this._depthOfFieldBlurY.push(n),this._depthOfFieldBlurX.push(c)}this._effects=[this._circleOfConfusion];for(let e=0;e<this._depthOfFieldBlurX.length;e++)this._effects.push(this._depthOfFieldBlurY[e]),this._effects.push(this._depthOfFieldBlurX[e]);this._dofMerge=new OA("dofMerge",this._circleOfConfusion,this._circleOfConfusion,this._depthOfFieldBlurX,{size:this._thinDepthOfFieldEffect._depthOfFieldBlurX[l-1][1],samplingMode:$e.g.BILINEAR_SAMPLINGMODE,engine:o,textureType:r,blockCompilation:s,effectWrapper:this._thinDepthOfFieldEffect._dofMerge},null),this._dofMerge.autoClear=!1,this._effects.push(this._dofMerge)}getClassName(){return"DepthOfFieldEffect"}set depthTexture(e){this._circleOfConfusion.depthTexture=e}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){return this._thinDepthOfFieldEffect.isReady()}}class wA extends Fi.w{getClassName(){return"DisplayPassPostProcess"}constructor(e,t,i,r,s,n){super(e,"displayPass",["passSampler"],["passSampler"],t,i,r,s,n)}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,54069))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,73718))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return Ue.p.Parse((()=>new wA(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,r)}}(0,a.Y5)("BABYLON.DisplayPassPostProcess",wA);class FA extends Fi.w{getClassName(){return"FilterPostProcess"}constructor(e,t,i,r,s,n,o){super(e,"filter",["kernelMatrix"],null,i,r,s,n,o),this.kernelMatrix=t,this.onApply=e=>{e.setMatrix("kernelMatrix",this.kernelMatrix)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,57912))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,97961))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return Ue.p.Parse((()=>new FA(e.name,e.kernelMatrix,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,r)}}(0,Ge.Cg)([(0,ze.GG)()],FA.prototype,"kernelMatrix",void 0),(0,a.Y5)("BABYLON.FilterPostProcess",FA);class BA extends Fi.w{getClassName(){return"GrainPostProcess"}constructor(e,t,i,r,s,n,o=0,a=!1){super(e,"grain",["intensity","animatedSeed"],[],t,i,r,s,n,null,o,void 0,null,a),this.intensity=30,this.animated=!1,this.onApplyObservable.add((e=>{e.setFloat("intensity",this.intensity),e.setFloat("animatedSeed",this.animated?Math.random()+1:1)}))}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,68625))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,50890))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return Ue.p.Parse((()=>new BA(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,r)}}(0,Ge.Cg)([(0,ze.lK)()],BA.prototype,"intensity",void 0),(0,Ge.Cg)([(0,ze.lK)()],BA.prototype,"animated",void 0),(0,a.Y5)("BABYLON.GrainPostProcess",BA);class VA extends Fi.w{getClassName(){return"HighlightsPostProcess"}constructor(e,t,i,r,s,n,o=0){super(e,"highlights",null,null,t,i,r,s,n,null,o)}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,80265))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,96920))])),super._gatherImports(e,t)}}class LA extends Fi.w{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){e.applyByPostProcess=!0,this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e,t=!1){if(e!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e)this._imageProcessingConfiguration=e;else{let e=null;const t=this.getEngine(),i=this.getCamera();if(i)e=i.getScene();else if(t&&t.scenes){const i=t.scenes;e=i[i.length-1]}else e=C.q.LastCreatedScene;this._imageProcessingConfiguration=e?e.imageProcessingConfiguration:new Sr.p}this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._updateParameters()}))),t||this._updateParameters()}}get isSupported(){const e=this.getEffect();return!e||e.isSupported}get colorCurves(){return this.imageProcessingConfiguration.colorCurves}set colorCurves(e){this.imageProcessingConfiguration.colorCurves=e}get colorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set colorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get colorGradingTexture(){return this.imageProcessingConfiguration.colorGradingTexture}set colorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get colorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set colorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get exposure(){return this.imageProcessingConfiguration.exposure}set exposure(e){this.imageProcessingConfiguration.exposure=e}get toneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set toneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get toneMappingType(){return this._imageProcessingConfiguration.toneMappingType}set toneMappingType(e){this._imageProcessingConfiguration.toneMappingType=e}get contrast(){return this.imageProcessingConfiguration.contrast}set contrast(e){this.imageProcessingConfiguration.contrast=e}get vignetteStretch(){return this.imageProcessingConfiguration.vignetteStretch}set vignetteStretch(e){this.imageProcessingConfiguration.vignetteStretch=e}get vignetteCentreX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCentreX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteCentreY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCentreY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCenterY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCenterX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteWeight(){return this.imageProcessingConfiguration.vignetteWeight}set vignetteWeight(e){this.imageProcessingConfiguration.vignetteWeight=e}get vignetteColor(){return this.imageProcessingConfiguration.vignetteColor}set vignetteColor(e){this.imageProcessingConfiguration.vignetteColor=e}get vignetteCameraFov(){return this.imageProcessingConfiguration.vignetteCameraFov}set vignetteCameraFov(e){this.imageProcessingConfiguration.vignetteCameraFov=e}get vignetteBlendMode(){return this.imageProcessingConfiguration.vignetteBlendMode}set vignetteBlendMode(e){this.imageProcessingConfiguration.vignetteBlendMode=e}get vignetteEnabled(){return this.imageProcessingConfiguration.vignetteEnabled}set vignetteEnabled(e){this.imageProcessingConfiguration.vignetteEnabled=e}get ditheringIntensity(){return this.imageProcessingConfiguration.ditheringIntensity}set ditheringIntensity(e){this.imageProcessingConfiguration.ditheringIntensity=e}get ditheringEnabled(){return this.imageProcessingConfiguration.ditheringEnabled}set ditheringEnabled(e){this.imageProcessingConfiguration.ditheringEnabled=e}get fromLinearSpace(){return this._fromLinearSpace}set fromLinearSpace(e){this._fromLinearSpace!==e&&(this._fromLinearSpace=e,this._updateParameters())}constructor(e,t,i=null,r,s,n,o=0,a){super(e,"imageProcessing",[],[],t,i,r,s,n,null,o,"postprocess",null,!0),this._fromLinearSpace=!0,this._defines={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:0,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,DITHER:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1,SKIPFINALCOLORCLAMP:!1},a?(a.applyByPostProcess=!0,this._attachImageProcessingConfiguration(a,!0),this._updateParameters()):(this._attachImageProcessingConfiguration(null,!0),this.imageProcessingConfiguration.applyByPostProcess=!0),this.onApply=e=>{this.imageProcessingConfiguration.bind(e,this.aspectRatio)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,37614)))):t.push(Promise.resolve().then(i.bind(i,83153))),super._gatherImports(e,t)}getClassName(){return"ImageProcessingPostProcess"}_updateParameters(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,!0);let e="";for(const t in this._defines){const i=this._defines[t];switch(typeof i){case"number":case"string":e+=`#define ${t} ${i};\n`;break;default:i&&(e+=`#define ${t};\n`)}}const t=["textureSampler"],i=["scale"];Sr.p&&(Sr.p.PrepareSamplers(t,this._defines),Sr.p.PrepareUniforms(i,this._defines)),this.updateEffect(e,i,t)}dispose(e){super.dispose(e),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=!1)}}(0,Ge.Cg)([(0,ze.lK)()],LA.prototype,"_fromLinearSpace",void 0);var kA=i(75007),GA=i(6739);const zA=["world","mBones","viewProjection","diffuseMatrix","view","previousWorld","previousViewProjection","mPreviousBones","bumpMatrix","reflectivityMatrix","albedoMatrix","reflectivityColor","albedoColor","metallic","glossiness","vTangentSpaceParams","vBumpInfos","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","boneTextureWidth"];(0,es.TV)(zA);class UA{get normalsAreUnsigned(){return this._normalsAreUnsigned}_linkPrePassRenderer(e){this._linkedWithPrePass=!0,this._prePassRenderer=e,this._multiRenderTarget&&(this._multiRenderTarget.onClearObservable.clear(),this._multiRenderTarget.onClearObservable.add((()=>{})))}_unlinkPrePassRenderer(){this._linkedWithPrePass=!1,this._createRenderTargets()}_resetLayout(){this._enableDepth=!0,this._enableNormal=!0,this._enablePosition=!1,this._enableReflectivity=!1,this._enableVelocity=!1,this._enableVelocityLinear=!1,this._enableScreenspaceDepth=!1,this._attachmentsFromPrePass=[]}_forceTextureType(e,t){e===UA.POSITION_TEXTURE_TYPE?(this._positionIndex=t,this._enablePosition=!0):e===UA.VELOCITY_TEXTURE_TYPE?(this._velocityIndex=t,this._enableVelocity=!0):e===UA.VELOCITY_LINEAR_TEXTURE_TYPE?(this._velocityLinearIndex=t,this._enableVelocityLinear=!0):e===UA.REFLECTIVITY_TEXTURE_TYPE?(this._reflectivityIndex=t,this._enableReflectivity=!0):e===UA.DEPTH_TEXTURE_TYPE?(this._depthIndex=t,this._enableDepth=!0):e===UA.NORMAL_TEXTURE_TYPE?(this._normalIndex=t,this._enableNormal=!0):e===UA.SCREENSPACE_DEPTH_TEXTURE_TYPE&&(this._screenspaceDepthIndex=t,this._enableScreenspaceDepth=!0)}_setAttachments(e){this._attachmentsFromPrePass=e}_linkInternalTexture(e){this._multiRenderTarget.setInternalTexture(e,0,!1)}get renderList(){return this._multiRenderTarget.renderList}set renderList(e){this._multiRenderTarget.renderList=e}get isSupported(){return this._multiRenderTarget.isSupported}getTextureIndex(e){switch(e){case UA.POSITION_TEXTURE_TYPE:return this._positionIndex;case UA.VELOCITY_TEXTURE_TYPE:return this._velocityIndex;case UA.VELOCITY_LINEAR_TEXTURE_TYPE:return this._velocityLinearIndex;case UA.REFLECTIVITY_TEXTURE_TYPE:return this._reflectivityIndex;case UA.DEPTH_TEXTURE_TYPE:return this._depthIndex;case UA.NORMAL_TEXTURE_TYPE:return this._normalIndex;case UA.SCREENSPACE_DEPTH_TEXTURE_TYPE:return this._screenspaceDepthIndex;default:return-1}}get enableDepth(){return this._enableDepth}set enableDepth(e){this._enableDepth=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableNormal(){return this._enableNormal}set enableNormal(e){this._enableNormal=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enablePosition(){return this._enablePosition}set enablePosition(e){this._enablePosition=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableVelocity(){return this._enableVelocity}set enableVelocity(e){this._enableVelocity=e,e||(this._previousTransformationMatrices={}),this._linkedWithPrePass||(this.dispose(),this._createRenderTargets()),this._scene.needsPreviousWorldMatrices=e}get enableVelocityLinear(){return this._enableVelocityLinear}set enableVelocityLinear(e){this._enableVelocityLinear=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableReflectivity(){return this._enableReflectivity}set enableReflectivity(e){this._enableReflectivity=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableScreenspaceDepth(){return this._enableScreenspaceDepth}set enableScreenspaceDepth(e){this._enableScreenspaceDepth=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get scene(){return this._scene}get ratio(){return"object"==typeof this._ratioOrDimensions?1:this._ratioOrDimensions}get shaderLanguage(){return this._shaderLanguage}constructor(e,t=1,i=15,r){this._previousTransformationMatrices={},this._previousBonesTransformationMatrices={},this.excludedSkinnedMeshesFromVelocity=[],this.renderTransparentMeshes=!0,this.generateNormalsInWorldSpace=!1,this._normalsAreUnsigned=!1,this._resizeObserver=null,this._enableDepth=!0,this._enableNormal=!0,this._enablePosition=!1,this._enableVelocity=!1,this._enableVelocityLinear=!1,this._enableReflectivity=!1,this._enableScreenspaceDepth=!1,this._clearColor=new o.ov(0,0,0,0),this._clearDepthColor=new o.ov(1e8,0,0,1),this._positionIndex=-1,this._velocityIndex=-1,this._velocityLinearIndex=-1,this._reflectivityIndex=-1,this._depthIndex=-1,this._normalIndex=-1,this._screenspaceDepthIndex=-1,this._linkedWithPrePass=!1,this.useSpecificClearForDepthTexture=!1,this._shaderLanguage=0,this._shadersLoaded=!1,this._scene=e,this._ratioOrDimensions=t,this._useUbo=e.getEngine().supportsUniformBuffers,this._depthFormat=i,this._textureTypesAndFormats=r||{},this._initShaderSourceAsync(),UA._SceneComponentInitialization(this._scene),this._createRenderTargets()}async _initShaderSourceAsync(){this._scene.getEngine().isWebGPU&&!UA.ForceGLSL?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,2564)),Promise.resolve().then(i.bind(i,38574))])):await Promise.all([Promise.resolve().then(i.bind(i,6739)),Promise.resolve().then(i.bind(i,75007))]),this._shadersLoaded=!0}isReady(e,t){if(!this._shadersLoaded)return!1;const i=e.getMaterial();if(i&&i.disableDepthWrite)return!1;const r=[],s=[Ot.R.PositionKind,Ot.R.NormalKind],n=e.getMesh();let o=!1,a=!1;if(i){let e=!1;if(i.needAlphaTestingForMesh(n)&&i.getAlphaTestTexture()&&(r.push("#define ALPHATEST"),r.push(`#define ALPHATEST_UV${i.getAlphaTestTexture().coordinatesIndex+1}`),e=!0),(i.bumpTexture||i.normalTexture)&&$u.h.BumpTextureEnabled){const t=i.bumpTexture||i.normalTexture;r.push("#define BUMP"),r.push(`#define BUMP_UV${t.coordinatesIndex+1}`),e=!0}if(this._enableReflectivity){let t=!1;"PBRMetallicRoughnessMaterial"===i.getClassName()?(i.metallicRoughnessTexture&&(r.push("#define ORMTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.metallicRoughnessTexture.coordinatesIndex+1}`),r.push("#define METALLICWORKFLOW"),e=!0,t=!0),null!=i.metallic&&(r.push("#define METALLIC"),r.push("#define METALLICWORKFLOW"),t=!0),null!=i.roughness&&(r.push("#define ROUGHNESS"),r.push("#define METALLICWORKFLOW"),t=!0),t&&(i.baseTexture&&(r.push("#define ALBEDOTEXTURE"),r.push(`#define ALBEDO_UV${i.baseTexture.coordinatesIndex+1}`),i.baseTexture.gammaSpace&&r.push("#define GAMMAALBEDO"),e=!0),i.baseColor&&r.push("#define ALBEDOCOLOR"))):"PBRSpecularGlossinessMaterial"===i.getClassName()?(i.specularGlossinessTexture?(r.push("#define SPECULARGLOSSINESSTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.specularGlossinessTexture.coordinatesIndex+1}`),e=!0,i.specularGlossinessTexture.gammaSpace&&r.push("#define GAMMAREFLECTIVITYTEXTURE")):i.specularColor&&r.push("#define REFLECTIVITYCOLOR"),null!=i.glossiness&&r.push("#define GLOSSINESS")):"PBRMaterial"===i.getClassName()?(i.metallicTexture&&(r.push("#define ORMTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.metallicTexture.coordinatesIndex+1}`),r.push("#define METALLICWORKFLOW"),e=!0,t=!0),null!=i.metallic&&(r.push("#define METALLIC"),r.push("#define METALLICWORKFLOW"),t=!0),null!=i.roughness&&(r.push("#define ROUGHNESS"),r.push("#define METALLICWORKFLOW"),t=!0),t?(i.albedoTexture&&(r.push("#define ALBEDOTEXTURE"),r.push(`#define ALBEDO_UV${i.albedoTexture.coordinatesIndex+1}`),i.albedoTexture.gammaSpace&&r.push("#define GAMMAALBEDO"),e=!0),i.albedoColor&&r.push("#define ALBEDOCOLOR")):(i.reflectivityTexture?(r.push("#define SPECULARGLOSSINESSTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.reflectivityTexture.coordinatesIndex+1}`),i.reflectivityTexture.gammaSpace&&r.push("#define GAMMAREFLECTIVITYTEXTURE"),e=!0):i.reflectivityColor&&r.push("#define REFLECTIVITYCOLOR"),null!=i.microSurface&&r.push("#define GLOSSINESS"))):"StandardMaterial"===i.getClassName()&&(i.specularTexture&&(r.push("#define REFLECTIVITYTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.specularTexture.coordinatesIndex+1}`),i.specularTexture.gammaSpace&&r.push("#define GAMMAREFLECTIVITYTEXTURE"),e=!0),i.specularColor&&r.push("#define REFLECTIVITYCOLOR"))}e&&(r.push("#define NEED_UV"),n.isVerticesDataPresent(Ot.R.UVKind)&&(s.push(Ot.R.UVKind),r.push("#define UV1"),o=!0),n.isVerticesDataPresent(Ot.R.UV2Kind)&&(s.push(Ot.R.UV2Kind),r.push("#define UV2"),a=!0))}this._enableDepth&&(r.push("#define DEPTH"),r.push("#define DEPTH_INDEX "+this._depthIndex)),this._enableNormal&&(r.push("#define NORMAL"),r.push("#define NORMAL_INDEX "+this._normalIndex)),this._enablePosition&&(r.push("#define POSITION"),r.push("#define POSITION_INDEX "+this._positionIndex)),this._enableVelocity&&(r.push("#define VELOCITY"),r.push("#define VELOCITY_INDEX "+this._velocityIndex),-1===this.excludedSkinnedMeshesFromVelocity.indexOf(n)&&r.push("#define BONES_VELOCITY_ENABLED")),this._enableVelocityLinear&&(r.push("#define VELOCITY_LINEAR"),r.push("#define VELOCITY_LINEAR_INDEX "+this._velocityLinearIndex),-1===this.excludedSkinnedMeshesFromVelocity.indexOf(n)&&r.push("#define BONES_VELOCITY_ENABLED")),this._enableReflectivity&&(r.push("#define REFLECTIVITY"),r.push("#define REFLECTIVITY_INDEX "+this._reflectivityIndex)),this._enableScreenspaceDepth&&-1!==this._screenspaceDepthIndex&&(r.push("#define SCREENSPACE_DEPTH_INDEX "+this._screenspaceDepthIndex),r.push("#define SCREENSPACE_DEPTH")),this.generateNormalsInWorldSpace&&r.push("#define NORMAL_WORLDSPACE"),this._normalsAreUnsigned&&r.push("#define ENCODE_NORMAL"),n.useBones&&n.computeBonesUsingShaders&&n.skeleton?(s.push(Ot.R.MatricesIndicesKind),s.push(Ot.R.MatricesWeightsKind),n.numBoneInfluencers>4&&(s.push(Ot.R.MatricesIndicesExtraKind),s.push(Ot.R.MatricesWeightsExtraKind)),r.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers),r.push("#define BONETEXTURE "+n.skeleton.isUsingTextureForMatrices),r.push("#define BonesPerMesh "+(n.skeleton.bones.length+1))):(r.push("#define NUM_BONE_INFLUENCERS 0"),r.push("#define BONETEXTURE false"),r.push("#define BonesPerMesh 0"));const l=n.morphTargetManager?(0,ts.Dk)(n.morphTargetManager,r,s,n,!0,!0,!1,o,a,!1):0;t&&(r.push("#define INSTANCES"),(0,ts.te)(s,this._enableVelocity||this._enableVelocityLinear),e.getRenderingMesh().hasThinInstances&&r.push("#define THIN_INSTANCES")),this._linkedWithPrePass?r.push("#define SCENE_MRT_COUNT "+this._attachmentsFromPrePass.length):r.push("#define SCENE_MRT_COUNT "+this._multiRenderTarget.textures.length),(0,es.tv)(i,this._scene,r);const h=this._scene.getEngine(),c=e._getDrawWrapper(void 0,!0),u=c.defines,d=r.join("\n");return u!==d&&c.setEffect(h.createEffect("geometry",{attributes:s,uniformsNames:zA,samplers:["diffuseSampler","bumpSampler","reflectivitySampler","albedoSampler","morphTargets","boneSampler"],defines:d,onCompiled:null,fallbacks:null,onError:null,uniformBuffersNames:["Scene"],indexParameters:{buffersCount:this._multiRenderTarget.textures.length-1,maxSimultaneousMorphTargets:l},shaderLanguage:this.shaderLanguage},h),d),c.effect.isReady()}getGBuffer(){return this._multiRenderTarget}get samples(){return this._multiRenderTarget.samples}set samples(e){this._multiRenderTarget.samples=e}dispose(){if(this._resizeObserver){this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null}this.getGBuffer().dispose()}_assignRenderTargetIndices(){const e=[],t=[];let i=0;return this._enableDepth&&(this._depthIndex=i,i++,e.push("gBuffer_Depth"),t.push(this._textureTypesAndFormats[UA.DEPTH_TEXTURE_TYPE])),this._enableNormal&&(this._normalIndex=i,i++,e.push("gBuffer_Normal"),t.push(this._textureTypesAndFormats[UA.NORMAL_TEXTURE_TYPE])),this._enablePosition&&(this._positionIndex=i,i++,e.push("gBuffer_Position"),t.push(this._textureTypesAndFormats[UA.POSITION_TEXTURE_TYPE])),this._enableVelocity&&(this._velocityIndex=i,i++,e.push("gBuffer_Velocity"),t.push(this._textureTypesAndFormats[UA.VELOCITY_TEXTURE_TYPE])),this._enableVelocityLinear&&(this._velocityLinearIndex=i,i++,e.push("gBuffer_VelocityLinear"),t.push(this._textureTypesAndFormats[UA.VELOCITY_LINEAR_TEXTURE_TYPE])),this._enableReflectivity&&(this._reflectivityIndex=i,i++,e.push("gBuffer_Reflectivity"),t.push(this._textureTypesAndFormats[UA.REFLECTIVITY_TEXTURE_TYPE])),this._enableScreenspaceDepth&&(this._screenspaceDepthIndex=i,i++,e.push("gBuffer_ScreenspaceDepth"),t.push(this._textureTypesAndFormats[UA.SCREENSPACE_DEPTH_TEXTURE_TYPE])),[i,e,t]}_createRenderTargets(){const e=this._scene.getEngine(),[t,i,r]=this._assignRenderTargetIndices();let s=0;e._caps.textureFloat&&e._caps.textureFloatLinearFiltering?s=1:e._caps.textureHalfFloat&&e._caps.textureHalfFloatLinearFiltering&&(s=2);const o=void 0!==this._ratioOrDimensions.width?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions},a=[],l=[];for(const e of r)e?(a.push(e.textureType),l.push(e.textureFormat)):(a.push(s),l.push(5));if(this._normalsAreUnsigned=11===a[UA.NORMAL_TEXTURE_TYPE]||13===a[UA.NORMAL_TEXTURE_TYPE],this._multiRenderTarget=new Vf("gBuffer",o,t,this._scene,{generateMipMaps:!1,generateDepthTexture:!0,types:a,formats:l,depthTextureFormat:this._depthFormat},i.concat("gBuffer_DepthBuffer")),!this.isSupported)return;this._multiRenderTarget.wrapU=$e.g.CLAMP_ADDRESSMODE,this._multiRenderTarget.wrapV=$e.g.CLAMP_ADDRESSMODE,this._multiRenderTarget.refreshRate=1,this._multiRenderTarget.renderParticles=!1,this._multiRenderTarget.renderList=null;const h=[!0],c=[!1],u=[!0];for(let e=1;e<t;++e)h.push(!0),u.push(!1),c.push(!0);const d=e.buildTextureLayout(h),p=e.buildTextureLayout(c),m=e.buildTextureLayout(u);this._multiRenderTarget.onClearObservable.add((e=>{e.bindAttachments(this.useSpecificClearForDepthTexture?p:d),e.clear(this._clearColor,!0,!0,!0),this.useSpecificClearForDepthTexture&&(e.bindAttachments(m),e.clear(this._clearDepthColor,!0,!0,!0)),e.bindAttachments(d)})),this._resizeObserver=e.onResizeObservable.add((()=>{if(this._multiRenderTarget){const t=void 0!==this._ratioOrDimensions.width?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions};this._multiRenderTarget.resize(t)}}));const f=e=>{const t=e.getRenderingMesh(),i=e.getEffectiveMesh(),r=this._scene,s=r.getEngine(),o=e.getMaterial();if(!o)return;if(i._internalAbstractMeshDataInfo._isActiveIntermediate=!1,(this._enableVelocity||this._enableVelocityLinear)&&!this._previousTransformationMatrices[i.uniqueId]&&(this._previousTransformationMatrices[i.uniqueId]={world:n.uq.Identity(),viewProjection:r.getTransformMatrix()},t.skeleton)){const e=t.skeleton.getTransformMatrices(t);this._previousBonesTransformationMatrices[t.uniqueId]=this._copyBonesTransformationMatrices(e,new Float32Array(e.length))}const a=t._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(a.mustReturn)return;const l=s.getCaps().instancedArrays&&(null!==a.visibleInstances[e._id]||t.hasThinInstances),h=i.getWorldMatrix();if(this.isReady(e,l)){const n=e._getDrawWrapper();if(!n)return;const c=n.effect;let u;s.enableEffect(n),l||t._bind(e,c,o.fillMode),this._useUbo?((0,ts._8)(c,this._scene.getSceneUniformBuffer()),this._scene.finalizeSceneUbo()):(c.setMatrix("viewProjection",r.getTransformMatrix()),c.setMatrix("view",r.getViewMatrix()));const d=t._instanceDataStorage;if(d.isFrozen||!o.backFaceCulling&&null===o.sideOrientation)u=d.sideOrientation;else{const e=i._getWorldMatrixDeterminant();u=o._getEffectiveOrientation(t),e<0&&(u=u===fn.i.ClockWiseSideOrientation?fn.i.CounterClockWiseSideOrientation:fn.i.ClockWiseSideOrientation)}if(o._preBind(n,u),o.needAlphaTestingForMesh(i)){const e=o.getAlphaTestTexture();e&&(c.setTexture("diffuseSampler",e),c.setMatrix("diffuseMatrix",e.getTextureMatrix()))}if((o.bumpTexture||o.normalTexture)&&r.getEngine().getCaps().standardDerivatives&&$u.h.BumpTextureEnabled){const e=o.bumpTexture||o.normalTexture;c.setFloat3("vBumpInfos",e.coordinatesIndex,1/e.level,o.parallaxScaleBias),c.setMatrix("bumpMatrix",e.getTextureMatrix()),c.setTexture("bumpSampler",e),c.setFloat2("vTangentSpaceParams",o.invertNormalMapX?-1:1,o.invertNormalMapY?-1:1)}if(this._enableReflectivity&&("PBRMetallicRoughnessMaterial"===o.getClassName()?(null!==o.metallicRoughnessTexture&&(c.setTexture("reflectivitySampler",o.metallicRoughnessTexture),c.setMatrix("reflectivityMatrix",o.metallicRoughnessTexture.getTextureMatrix())),null!==o.metallic&&c.setFloat("metallic",o.metallic),null!==o.roughness&&c.setFloat("glossiness",1-o.roughness),null!==o.baseTexture&&(c.setTexture("albedoSampler",o.baseTexture),c.setMatrix("albedoMatrix",o.baseTexture.getTextureMatrix())),null!==o.baseColor&&c.setColor3("albedoColor",o.baseColor)):"PBRSpecularGlossinessMaterial"===o.getClassName()?(null!==o.specularGlossinessTexture?(c.setTexture("reflectivitySampler",o.specularGlossinessTexture),c.setMatrix("reflectivityMatrix",o.specularGlossinessTexture.getTextureMatrix())):null!==o.specularColor&&c.setColor3("reflectivityColor",o.specularColor),null!==o.glossiness&&c.setFloat("glossiness",o.glossiness)):"PBRMaterial"===o.getClassName()?(null!==o.metallicTexture&&(c.setTexture("reflectivitySampler",o.metallicTexture),c.setMatrix("reflectivityMatrix",o.metallicTexture.getTextureMatrix())),null!==o.metallic&&c.setFloat("metallic",o.metallic),null!==o.roughness&&c.setFloat("glossiness",1-o.roughness),null!==o.roughness||null!==o.metallic||null!==o.metallicTexture?(null!==o.albedoTexture&&(c.setTexture("albedoSampler",o.albedoTexture),c.setMatrix("albedoMatrix",o.albedoTexture.getTextureMatrix())),null!==o.albedoColor&&c.setColor3("albedoColor",o.albedoColor)):(null!==o.reflectivityTexture?(c.setTexture("reflectivitySampler",o.reflectivityTexture),c.setMatrix("reflectivityMatrix",o.reflectivityTexture.getTextureMatrix())):null!==o.reflectivityColor&&c.setColor3("reflectivityColor",o.reflectivityColor),null!==o.microSurface&&c.setFloat("glossiness",o.microSurface))):"StandardMaterial"===o.getClassName()&&(null!==o.specularTexture&&(c.setTexture("reflectivitySampler",o.specularTexture),c.setMatrix("reflectivityMatrix",o.specularTexture.getTextureMatrix())),null!==o.specularColor&&c.setColor3("reflectivityColor",o.specularColor))),(0,es.gS)(c,o,this._scene),t.useBones&&t.computeBonesUsingShaders&&t.skeleton){const e=t.skeleton;if(e.isUsingTextureForMatrices&&c.getUniformIndex("boneTextureWidth")>-1){const i=e.getTransformMatrixTexture(t);c.setTexture("boneSampler",i),c.setFloat("boneTextureWidth",4*(e.bones.length+1))}else c.setMatrices("mBones",t.skeleton.getTransformMatrices(t));(this._enableVelocity||this._enableVelocityLinear)&&c.setMatrices("mPreviousBones",this._previousBonesTransformationMatrices[t.uniqueId])}(0,ts.nR)(t,c),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(c),(this._enableVelocity||this._enableVelocityLinear)&&(c.setMatrix("previousWorld",this._previousTransformationMatrices[i.uniqueId].world),c.setMatrix("previousViewProjection",this._previousTransformationMatrices[i.uniqueId].viewProjection)),l&&t.hasThinInstances&&c.setMatrix("world",h),t._processRendering(i,e,c,o.fillMode,a,l,((e,t)=>{e||c.setMatrix("world",t)}))}(this._enableVelocity||this._enableVelocityLinear)&&(this._previousTransformationMatrices[i.uniqueId].world=h.clone(),this._previousTransformationMatrices[i.uniqueId].viewProjection=this._scene.getTransformMatrix().clone(),t.skeleton&&this._copyBonesTransformationMatrices(t.skeleton.getTransformMatrices(t),this._previousBonesTransformationMatrices[i.uniqueId]))};this._multiRenderTarget.customIsReadyFunction=(t,i,r)=>{if((r||0===i)&&t.subMeshes)for(let i=0;i<t.subMeshes.length;++i){const r=t.subMeshes[i],s=r.getMaterial(),n=r.getRenderingMesh();if(!s)continue;const o=n._getInstancesRenderList(r._id,!!r.getReplacementMesh()),a=e.getCaps().instancedArrays&&(null!==o.visibleInstances[r._id]||n.hasThinInstances);if(!this.isReady(r,a))return!1}return!0},this._multiRenderTarget.customRenderFunction=(t,i,r,s)=>{let n;if(this._linkedWithPrePass){if(!this._prePassRenderer.enabled)return;this._scene.getEngine().bindAttachments(this._attachmentsFromPrePass)}if(s.length){for(e.setColorWrite(!1),n=0;n<s.length;n++)f(s.data[n]);e.setColorWrite(!0)}for(n=0;n<t.length;n++)f(t.data[n]);for(e.setDepthWrite(!1),n=0;n<i.length;n++)f(i.data[n]);if(this.renderTransparentMeshes)for(n=0;n<r.length;n++)f(r.data[n]);e.setDepthWrite(!0)}}_copyBonesTransformationMatrices(e,t){for(let i=0;i<e.length;i++)t[i]=e[i];return t}}UA.ForceGLSL=!1,UA.DEPTH_TEXTURE_TYPE=0,UA.NORMAL_TEXTURE_TYPE=1,UA.POSITION_TEXTURE_TYPE=2,UA.VELOCITY_TEXTURE_TYPE=3,UA.REFLECTIVITY_TEXTURE_TYPE=4,UA.SCREENSPACE_DEPTH_TEXTURE_TYPE=5,UA.VELOCITY_LINEAR_TEXTURE_TYPE=6,UA._SceneComponentInitialization=e=>{throw(0,Ph.n)("GeometryBufferRendererSceneComponent")};class WA{constructor(){this.enabled=!1,this.name="motionBlur",this.texturesRequired=[2]}}Object.defineProperty(it.Z.prototype,"geometryBufferRenderer",{get:function(){return this._geometryBufferRenderer},set:function(e){e&&e.isSupported&&(this._geometryBufferRenderer=e)},enumerable:!0,configurable:!0}),it.Z.prototype.enableGeometryBufferRenderer=function(e=1,t=15,i){return this._geometryBufferRenderer||(this._geometryBufferRenderer=new UA(this,e,t,i),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null)),this._geometryBufferRenderer},it.Z.prototype.disableGeometryBufferRenderer=function(){this._geometryBufferRenderer&&(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)};class HA{constructor(e){this.name=Ei.v.NAME_GEOMETRYBUFFERRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(Ei.v.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this._gatherRenderTargets)}rebuild(){}dispose(){}_gatherRenderTargets(e){this.scene._geometryBufferRenderer&&e.push(this.scene._geometryBufferRenderer.getGBuffer())}}UA._SceneComponentInitialization=e=>{let t=e._getComponent(Ei.v.NAME_GEOMETRYBUFFERRENDERER);t||(t=new HA(e),e._addComponent(t))};class $A extends Fi.w{get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this._motionBlurSamples=e,this._updateEffect()}get isObjectBased(){return this._isObjectBased}set isObjectBased(e){this._isObjectBased!==e&&(this._isObjectBased=e,this._applyMode())}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"MotionBlurPostProcess"}constructor(e,t,i,r,s,n,o,a=0,l=!1,h=!1){super(e,"motionBlur",["motionStrength","motionScale","screenSize","inverseViewProjection","prevViewProjection","projection"],["velocitySampler","depthSampler"],i,r,s,n,o,"#define GEOMETRY_SUPPORTED\n#define SAMPLES 64.0\n#define OBJECT_BASED",a,void 0,null,l),this.motionStrength=1,this._motionBlurSamples=32,this._isObjectBased=!0,this._forceGeometryBuffer=!1,this._invViewProjection=null,this._previousViewProjection=null,this._forceGeometryBuffer=h,this._forceGeometryBuffer?(t.enableGeometryBufferRenderer(),this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=this._isObjectBased)):(t.enablePrePassRenderer(),this._prePassRenderer&&(this._prePassRenderer.markAsDirty(),this._prePassEffectConfiguration=new WA)),this._applyMode()}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,8075))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,25830))])),super._gatherImports(e,t)}excludeSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else{if(!this._prePassRenderer)return;t=this._prePassRenderer.excludedSkinnedMesh}t.push(e)}}removeExcludedSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else{if(!this._prePassRenderer)return;t=this._prePassRenderer.excludedSkinnedMesh}const i=t.indexOf(e);-1!==i&&t.splice(i,1)}}dispose(e){this._geometryBufferRenderer&&(this._geometryBufferRenderer._previousTransformationMatrices={},this._geometryBufferRenderer._previousBonesTransformationMatrices={},this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity=[]),super.dispose(e)}_applyMode(){if(!this._geometryBufferRenderer&&!this._prePassRenderer)return m.V.Warn("Multiple Render Target support needed to compute object based motion blur"),this.updateEffect();this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=this._isObjectBased),this._updateEffect(),this._invViewProjection=null,this._previousViewProjection=null,this.isObjectBased?(this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=2),this.onApply=e=>this._onApplyObjectBased(e)):(this._invViewProjection=n.uq.Identity(),this._previousViewProjection=this._scene.getTransformMatrix().clone(),this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=5),this.onApply=e=>this._onApplyScreenBased(e))}_onApplyObjectBased(e){if(e.setVector2("screenSize",new n.I9(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){const t=this._geometryBufferRenderer.getTextureIndex(UA.VELOCITY_TEXTURE_TYPE);e.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){const t=this._prePassRenderer.getIndex(2);e.setTexture("velocitySampler",this._prePassRenderer.getRenderTarget().textures[t])}}_onApplyScreenBased(e){const t=n.AA.Matrix[0];if(t.copyFrom(this._scene.getTransformMatrix()),t.invertToRef(this._invViewProjection),e.setMatrix("inverseViewProjection",this._invViewProjection),e.setMatrix("prevViewProjection",this._previousViewProjection),this._previousViewProjection.copyFrom(t),e.setMatrix("projection",this._scene.getProjectionMatrix()),e.setVector2("screenSize",new n.I9(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){const t=this._geometryBufferRenderer.getTextureIndex(UA.DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){const t=this._prePassRenderer.getIndex(5);e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[t])}}_updateEffect(){if(this._geometryBufferRenderer||this._prePassRenderer){const e=["#define GEOMETRY_SUPPORTED","#define SAMPLES "+this._motionBlurSamples.toFixed(1),this._isObjectBased?"#define OBJECT_BASED":"#define SCREEN_BASED"];this.updateEffect(e.join("\n"))}}static _Parse(e,t,i,r){return Ue.p.Parse((()=>new $A(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1)),e,i,r)}}(0,Ge.Cg)([(0,ze.lK)()],$A.prototype,"motionStrength",void 0),(0,Ge.Cg)([(0,ze.lK)()],$A.prototype,"motionBlurSamples",null),(0,Ge.Cg)([(0,ze.lK)()],$A.prototype,"isObjectBased",null),(0,a.Y5)("BABYLON.MotionBlurPostProcess",$A);const qA="refractionPixelShader",YA="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D refractionSampler;uniform vec3 baseColor;uniform float depth;uniform float colorLevel;void main() {float ref=1.0-texture2D(refractionSampler,vUV).r;vec2 uv=vUV-vec2(0.5);vec2 offset=uv*depth*ref;vec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;gl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);}";qi.l.ShadersStore[qA]=YA;class XA extends Fi.w{get refractionTexture(){return this._refTexture}set refractionTexture(e){this._refTexture&&this._ownRefractionTexture&&this._refTexture.dispose(),this._refTexture=e,this._ownRefractionTexture=!1}getClassName(){return"RefractionPostProcess"}constructor(e,t,i,r,s,n,o,a,l,h){super(e,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],n,o,a,l,h),this._ownRefractionTexture=!0,this.color=i,this.depth=r,this.colorLevel=s,this.refractionTextureUrl=t,this.onActivateObservable.add((e=>{this._refTexture=this._refTexture||new $e.g(t,e.getScene())})),this.onApplyObservable.add((e=>{e.setColor3("baseColor",this.color),e.setFloat("depth",this.depth),e.setFloat("colorLevel",this.colorLevel),e.setTexture("refractionSampler",this._refTexture)}))}dispose(e){this._refTexture&&this._ownRefractionTexture&&(this._refTexture.dispose(),this._refTexture=null),super.dispose(e)}static _Parse(e,t,i,r){return Ue.p.Parse((()=>new XA(e.name,e.refractionTextureUrl,e.color,e.depth,e.colorLevel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,r)}}(0,Ge.Cg)([(0,ze.lK)()],XA.prototype,"color",void 0),(0,Ge.Cg)([(0,ze.lK)()],XA.prototype,"depth",void 0),(0,Ge.Cg)([(0,ze.lK)()],XA.prototype,"colorLevel",void 0),(0,Ge.Cg)([(0,ze.lK)()],XA.prototype,"refractionTextureUrl",void 0),(0,a.Y5)("BABYLON.RefractionPostProcess",XA);var jA=i(78438);class ZA extends Fi.w{getClassName(){return"SharpenPostProcess"}constructor(e,t,i,r,s,n,o=0,a=!1){super(e,"sharpen",["sharpnessAmounts","screenSize"],null,t,i,r,s,n,null,o,void 0,null,a),this.colorAmount=1,this.edgeAmount=.3,this.onApply=e=>{e.setFloat2("screenSize",this.width,this.height),e.setFloat2("sharpnessAmounts",this.edgeAmount,this.colorAmount)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,35381))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,78438))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return Ue.p.Parse((()=>new ZA(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable)),e,i,r)}}(0,Ge.Cg)([(0,ze.lK)()],ZA.prototype,"colorAmount",void 0),(0,Ge.Cg)([(0,ze.lK)()],ZA.prototype,"edgeAmount",void 0),(0,a.Y5)("BABYLON.SharpenPostProcess",ZA);class QA{get name(){return this._name}get cameras(){return this._cameras}get engine(){return this._engine}constructor(e,t){this._engine=e,this._name=t,this._renderEffects={},this._renderEffectsForIsolatedPass=new Array,this._cameras=[]}getClassName(){return"PostProcessRenderPipeline"}get isSupported(){for(const e in this._renderEffects)if(Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&!this._renderEffects[e].isSupported)return!1;return!0}addEffect(e){this._renderEffects[e._name]=e}_rebuild(){}_enableEffect(e,t){const i=this._renderEffects[e];i&&i._enable(H.S0.MakeArray(t||this._cameras))}_disableEffect(e,t){const i=this._renderEffects[e];i&&i._disable(H.S0.MakeArray(t||this._cameras))}_attachCameras(e,t){const i=H.S0.MakeArray(e||this._cameras);if(!i)return;const r=[];let s;for(s=0;s<i.length;s++){const e=i[s];e&&(-1===this._cameras.indexOf(e)?this._cameras.push(e):t&&r.push(s))}for(s=0;s<r.length;s++)i.splice(r[s],1);for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._attachCameras(i)}_detachCameras(e){const t=H.S0.MakeArray(e||this._cameras);if(t){for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._detachCameras(t);for(let e=0;e<t.length;e++)this._cameras.splice(this._cameras.indexOf(t[e]),1)}}_update(){for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._update();for(let e=0;e<this._cameras.length;e++){if(!this._cameras[e])continue;const t=this._cameras[e].name;this._renderEffectsForIsolatedPass[t]&&this._renderEffectsForIsolatedPass[t]._update()}}_reset(){this._renderEffects={},this._renderEffectsForIsolatedPass=new Array}_enableMSAAOnFirstPostProcess(e){if(!this._engine._features.supportMSAA)return!1;const t=Object.keys(this._renderEffects);if(t.length>0){const i=this._renderEffects[t[0]].getPostProcesses();i&&(i[0].samples=e)}return!0}_adaptPostProcessesToViewPort(){const e=Object.keys(this._renderEffects);for(const t of e){const e=this._renderEffects[t].getPostProcesses();if(e)for(const t of e)t.adaptScaleToCurrentViewport=!0}}setPrePassRenderer(e){return!1}dispose(){}}(0,Ge.Cg)([(0,ze.lK)()],QA.prototype,"_name",void 0);class KA{constructor(){this._renderPipelines={}}get supportedPipelines(){const e=[];for(const t in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,t)){const i=this._renderPipelines[t];i.isSupported&&e.push(i)}return e}addPipeline(e){this._renderPipelines[e._name]=e}removePipeline(e){delete this._renderPipelines[e]}attachCamerasToRenderPipeline(e,t,i=!1){const r=this._renderPipelines[e];r&&r._attachCameras(t,i)}detachCamerasFromRenderPipeline(e,t){const i=this._renderPipelines[e];i&&i._detachCameras(t)}enableEffectInPipeline(e,t,i){const r=this._renderPipelines[e];r&&r._enableEffect(t,i)}disableEffectInPipeline(e,t,i){const r=this._renderPipelines[e];r&&r._disableEffect(t,i)}update(){for(const e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){const t=this._renderPipelines[e];t.isSupported?t._update():(t.dispose(),delete this._renderPipelines[e])}}_rebuild(){for(const e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){this._renderPipelines[e]._rebuild()}}dispose(){for(const e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){this._renderPipelines[e].dispose()}}}Object.defineProperty(it.Z.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){let e=this._getComponent(Ei.v.NAME_POSTPROCESSRENDERPIPELINEMANAGER);e||(e=new JA(this),this._addComponent(e)),this._postProcessRenderPipelineManager=new KA}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});class JA{constructor(e){this.name=Ei.v.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(Ei.v.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)}rebuild(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()}dispose(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()}_gatherRenderTargets(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()}}class eI extends QA{get automaticBuild(){return this._buildAllowed}set automaticBuild(e){this._buildAllowed=e}get scene(){return this._scene}set sharpenEnabled(e){this._sharpenEnabled!==e&&(this._sharpenEnabled=e,this._buildPipeline())}get sharpenEnabled(){return this._sharpenEnabled}get bloomKernel(){return this._bloomKernel}set bloomKernel(e){this._bloomKernel=e,this.bloom.kernel=e/this._hardwareScaleLevel}set bloomWeight(e){this._bloomWeight!==e&&(this.bloom.weight=e,this._bloomWeight=e)}get bloomWeight(){return this._bloomWeight}set bloomThreshold(e){this._bloomThreshold!==e&&(this.bloom.threshold=e,this._bloomThreshold=e)}get bloomThreshold(){return this._bloomThreshold}set bloomScale(e){this._bloomScale!==e&&(this._bloomScale=e,this._rebuildBloom(),this._buildPipeline())}get bloomScale(){return this._bloomScale}set bloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get bloomEnabled(){return this._bloomEnabled}_rebuildBloom(){const e=this.bloom;this.bloom=new EA(this._scene,this.bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!1),this.bloom.threshold=e.threshold;for(let t=0;t<this._cameras.length;t++)e.disposeEffects(this._cameras[t])}get depthOfFieldEnabled(){return this._depthOfFieldEnabled}set depthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get depthOfFieldBlurLevel(){return this._depthOfFieldBlurLevel}set depthOfFieldBlurLevel(e){if(this._depthOfFieldBlurLevel===e)return;this._depthOfFieldBlurLevel=e;const t=this.depthOfField;this.depthOfField=new NA(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!1),this.depthOfField.focalLength=t.focalLength,this.depthOfField.focusDistance=t.focusDistance,this.depthOfField.fStop=t.fStop,this.depthOfField.lensSize=t.lensSize;for(let e=0;e<this._cameras.length;e++)t.disposeEffects(this._cameras[e]);this._buildPipeline()}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}set imageProcessingEnabled(e){this._imageProcessingEnabled!==e&&(this._scene.imageProcessingConfiguration.isEnabled=e)}get imageProcessingEnabled(){return this._imageProcessingEnabled}set glowLayerEnabled(e){e&&!this._glowLayer?this._glowLayer=new Ip("",this._scene):!e&&this._glowLayer&&(this._glowLayer.dispose(),this._glowLayer=null)}get glowLayerEnabled(){return null!=this._glowLayer}get glowLayer(){return this._glowLayer}set chromaticAberrationEnabled(e){this._chromaticAberrationEnabled!==e&&(this._chromaticAberrationEnabled=e,this._buildPipeline())}get chromaticAberrationEnabled(){return this._chromaticAberrationEnabled}set grainEnabled(e){this._grainEnabled!==e&&(this._grainEnabled=e,this._buildPipeline())}get grainEnabled(){return this._grainEnabled}constructor(e="",t=!0,i=C.q.LastCreatedScene,r,n=!0){super(i.getEngine(),e),this._camerasToBeAttached=[],this.SharpenPostProcessId="SharpenPostProcessEffect",this.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect",this.FxaaPostProcessId="FxaaPostProcessEffect",this.ChromaticAberrationPostProcessId="ChromaticAberrationPostProcessEffect",this.GrainPostProcessId="GrainPostProcessEffect",this._glowLayer=null,this.animations=[],this._imageProcessingConfigurationObserver=null,this._sharpenEnabled=!1,this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._depthOfFieldBlurLevel=0,this._fxaaEnabled=!1,this._imageProcessingEnabled=!0,this._bloomScale=.5,this._chromaticAberrationEnabled=!1,this._grainEnabled=!1,this._buildAllowed=!0,this.onBuildObservable=new s.cP,this._resizeObserver=null,this._hardwareScaleLevel=1,this._bloomKernel=64,this._bloomWeight=.15,this._bloomThreshold=.9,this._samples=1,this._hasCleared=!1,this._prevPostProcess=null,this._prevPrevPostProcess=null,this._depthOfFieldSceneObserver=null,this._activeCameraChangedObserver=null,this._activeCamerasChangedObserver=null,this._cameras=r||i.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._buildAllowed=n,this._scene=i;const o=this._scene.getEngine().getCaps();this._hdr=t&&(o.textureHalfFloatRender||o.textureFloatRender),this._hdr?o.textureHalfFloatRender?this._defaultPipelineTextureType=2:o.textureFloatRender&&(this._defaultPipelineTextureType=1):this._defaultPipelineTextureType=0,i.postProcessRenderPipelineManager.addPipeline(this);const a=this._scene.getEngine();this.sharpen=new ZA("sharpen",1,null,$e.g.BILINEAR_SAMPLINGMODE,a,!1,this._defaultPipelineTextureType,!0),this._sharpenEffect=new PA(a,this.SharpenPostProcessId,(()=>this.sharpen),!0),this.depthOfField=new NA(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!0),this._hardwareScaleLevel=a.getHardwareScalingLevel(),this._resizeObserver=a.onResizeObservable.add((()=>{this._hardwareScaleLevel=a.getHardwareScalingLevel(),this.bloomKernel=this._bloomKernel})),this.bloom=new EA(this._scene,this._bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!0),this.chromaticAberration=new AA("ChromaticAberration",a.getRenderWidth(),a.getRenderHeight(),1,null,$e.g.BILINEAR_SAMPLINGMODE,a,!1,this._defaultPipelineTextureType,!0),this._chromaticAberrationEffect=new PA(a,this.ChromaticAberrationPostProcessId,(()=>this.chromaticAberration),!0),this.grain=new BA("Grain",1,null,$e.g.BILINEAR_SAMPLINGMODE,a,!1,this._defaultPipelineTextureType,!0),this._grainEffect=new PA(a,this.GrainPostProcessId,(()=>this.grain),!0);let l=!0;this._imageProcessingConfigurationObserver=this._scene.imageProcessingConfiguration.onUpdateParameters.add((()=>{this.bloom._downscale._exposure=this._scene.imageProcessingConfiguration.exposure,this.imageProcessingEnabled!==this._scene.imageProcessingConfiguration.isEnabled&&(this._imageProcessingEnabled=this._scene.imageProcessingConfiguration.isEnabled,l?H.S0.SetImmediate((()=>{this._buildPipeline()})):this._buildPipeline())})),this._buildPipeline(),l=!1}getClassName(){return"DefaultRenderingPipeline"}prepare(){const e=this._buildAllowed;this._buildAllowed=!0,this._buildPipeline(),this._buildAllowed=e}_setAutoClearAndTextureSharing(e,t=!1){this._hasCleared?e.autoClear=!1:(e.autoClear=!0,this._scene.autoClear=!1,this._hasCleared=!0),t||(this._prevPrevPostProcess?e.shareOutputWith(this._prevPrevPostProcess):e.useOwnOutput(),this._prevPostProcess&&(this._prevPrevPostProcess=this._prevPostProcess),this._prevPostProcess=e)}_buildPipeline(){if(!this._buildAllowed)return;this._scene.autoClear=!0;const e=this._scene.getEngine();if(this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._prevPostProcess=null,this._prevPrevPostProcess=null,this._hasCleared=!1,this.depthOfFieldEnabled){if(this._cameras.length>1){for(const e of this._cameras){this._scene.enableDepthRenderer(e).useOnlyInActiveCamera=!0}this._depthOfFieldSceneObserver=this._scene.onAfterRenderTargetsRenderObservable.add((e=>{this._cameras.indexOf(e.activeCamera)>-1&&(this.depthOfField.depthTexture=e.enableDepthRenderer(e.activeCamera).getDepthMap())}))}else{this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);const e=this._scene.enableDepthRenderer(this._cameras[0]);this.depthOfField.depthTexture=e.getDepthMap()}this.depthOfField._isReady()||this.depthOfField._updateEffects(),this.addEffect(this.depthOfField),this._setAutoClearAndTextureSharing(this.depthOfField._effects[0],!0)}else this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);this.bloomEnabled&&(this.bloom._isReady()||this.bloom._updateEffects(),this.addEffect(this.bloom),this._setAutoClearAndTextureSharing(this.bloom._effects[0],!0)),this._imageProcessingEnabled&&(this.imageProcessing=new LA("imageProcessing",1,null,$e.g.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType,this.scene.imageProcessingConfiguration),this._hdr?(this.addEffect(new PA(e,this.ImageProcessingPostProcessId,(()=>this.imageProcessing),!0)),this._setAutoClearAndTextureSharing(this.imageProcessing)):this._scene.imageProcessingConfiguration.applyByPostProcess=!1,this._cameras&&0!==this._cameras.length||(this._scene.imageProcessingConfiguration.applyByPostProcess=!1),this.imageProcessing.getEffect()||this.imageProcessing._updateParameters()),this.sharpenEnabled&&(this.sharpen.isReady()||this.sharpen.updateEffect(),this.addEffect(this._sharpenEffect),this._setAutoClearAndTextureSharing(this.sharpen)),this.grainEnabled&&(this.grain.isReady()||this.grain.updateEffect(),this.addEffect(this._grainEffect),this._setAutoClearAndTextureSharing(this.grain)),this.chromaticAberrationEnabled&&(this.chromaticAberration.isReady()||this.chromaticAberration.updateEffect(),this.addEffect(this._chromaticAberrationEffect),this._setAutoClearAndTextureSharing(this.chromaticAberration)),this.fxaaEnabled&&(this.fxaa=new hT("fxaa",1,null,$e.g.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType),this.addEffect(new PA(e,this.FxaaPostProcessId,(()=>this.fxaa),!0)),this._setAutoClearAndTextureSharing(this.fxaa,!0)),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),(this._scene.activeCameras&&this._scene.activeCameras.length>1||this._scene.activeCamera&&-1===this._cameras.indexOf(this._scene.activeCamera))&&(this._scene.autoClear=!0),this._activeCameraChangedObserver||(this._activeCameraChangedObserver=this._scene.onActiveCameraChanged.add((()=>{this._scene.activeCamera&&-1===this._cameras.indexOf(this._scene.activeCamera)&&(this._scene.autoClear=!0)}))),this._activeCamerasChangedObserver||(this._activeCamerasChangedObserver=this._scene.onActiveCamerasChanged.add((()=>{this._scene.activeCameras&&this._scene.activeCameras.length>1&&(this._scene.autoClear=!0)}))),this._adaptPostProcessesToViewPort(),!this._enableMSAAOnFirstPostProcess(this.samples)&&this.samples>1&&m.V.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0"),this.onBuildObservable.notifyObservers(this)}_disposePostProcesses(e=!1){for(let t=0;t<this._cameras.length;t++){const i=this._cameras[t];this.imageProcessing&&this.imageProcessing.dispose(i),this.fxaa&&this.fxaa.dispose(i),e&&(this.sharpen&&this.sharpen.dispose(i),this.depthOfField&&(this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver),this.depthOfField.disposeEffects(i)),this.bloom&&this.bloom.disposeEffects(i),this.chromaticAberration&&this.chromaticAberration.dispose(i),this.grain&&this.grain.dispose(i),this._glowLayer&&this._glowLayer.dispose())}this.imageProcessing=null,this.fxaa=null,e&&(this.sharpen=null,this._sharpenEffect=null,this.depthOfField=null,this.bloom=null,this.chromaticAberration=null,this._chromaticAberrationEffect=null,this.grain=null,this._grainEffect=null,this._glowLayer=null)}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(){this._buildAllowed=!1,this.onBuildObservable.clear(),this._disposePostProcesses(!0),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene._postProcessRenderPipelineManager.removePipeline(this.name),this._scene.autoClear=!0,this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this._scene.onActiveCameraChanged.remove(this._activeCameraChangedObserver),this._scene.onActiveCamerasChanged.remove(this._activeCamerasChangedObserver),this._scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigurationObserver),super.dispose()}serialize(){const e=Ue.p.Serialize(this);return e.customType="DefaultRenderingPipeline",e}static Parse(e,t,i){return Ue.p.Parse((()=>new eI(e._name,e._name._hdr,t)),e,t,i)}}(0,Ge.Cg)([(0,ze.lK)()],eI.prototype,"sharpenEnabled",null),(0,Ge.Cg)([(0,ze.lK)()],eI.prototype,"bloomKernel",null),(0,Ge.Cg)([(0,ze.lK)()],eI.prototype,"_bloomWeight",void 0),(0,Ge.Cg)([(0,ze.lK)()],eI.prototype,"_bloomThreshold",void 0),(0,Ge.Cg)([(0,ze.lK)()],eI.prototype,"_hdr",void 0),(0,Ge.Cg)([(0,ze.lK)()],eI.prototype,"bloomWeight",null),(0,Ge.Cg)([(0,ze.lK)()],eI.prototype,"bloomThreshold",null),(0,Ge.Cg)([(0,ze.lK)()],eI.prototype,"bloomScale",null),(0,Ge.Cg)([(0,ze.lK)()],eI.prototype,"bloomEnabled",null),(0,Ge.Cg)([(0,ze.lK)()],eI.prototype,"depthOfFieldEnabled",null),(0,Ge.Cg)([(0,ze.lK)()],eI.prototype,"depthOfFieldBlurLevel",null),(0,Ge.Cg)([(0,ze.lK)()],eI.prototype,"fxaaEnabled",null),(0,Ge.Cg)([(0,ze.lK)()],eI.prototype,"samples",null),(0,Ge.Cg)([(0,ze.lK)()],eI.prototype,"imageProcessingEnabled",null),(0,Ge.Cg)([(0,ze.lK)()],eI.prototype,"glowLayerEnabled",null),(0,Ge.Cg)([(0,ze.lK)()],eI.prototype,"chromaticAberrationEnabled",null),(0,Ge.Cg)([(0,ze.lK)()],eI.prototype,"grainEnabled",null),(0,a.Y5)("BABYLON.DefaultRenderingPipeline",eI);var tI=i(32048);const iI="lensHighlightsPixelShader",rI="uniform sampler2D textureSampler; \nuniform float gain;uniform float threshold;uniform float screen_width;uniform float screen_height;varying vec2 vUV;vec4 highlightColor(vec4 color) {vec4 highlight=color;float luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));float lum_threshold;if (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }\nelse { lum_threshold=0.5+0.44*threshold; }\nluminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);highlight*=luminance*gain;highlight.a=1.0;return highlight;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 original=texture2D(textureSampler,vUV);if (gain==-1.0) {gl_FragColor=vec4(0.0,0.0,0.0,1.0);return;}\nfloat w=2.0/screen_width;float h=2.0/screen_height;float weight=1.0;vec4 blurred=vec4(0.0,0.0,0.0,0.0);\n#ifdef PENTAGON\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));\n#else\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));\n#endif\nblurred/=39.0;gl_FragColor=blurred;}";qi.l.ShadersStore[iI]=rI;const sI="depthOfFieldPixelShader",nI="uniform sampler2D textureSampler;uniform sampler2D highlightsSampler;uniform sampler2D depthSampler;uniform sampler2D grainSampler;uniform float grain_amount;uniform bool blur_noise;uniform float screen_width;uniform float screen_height;uniform float distortion;uniform bool dof_enabled;uniform float screen_distance; \nuniform float aperture;uniform float darken;uniform float edge_blur;uniform bool highlights;uniform float near;uniform float far;varying vec2 vUV;\n#define PI 3.14159265\n#define TWOPI 6.28318530\n#define inverse_focal_length 0.1 \nvec2 centered_screen_pos;vec2 distorted_coords;float radius2;float radius;vec2 rand(vec2 co)\n{float noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));float noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));return clamp(vec2(noise1,noise2),0.0,1.0);}\nvec2 getDistortedCoords(vec2 coords) {if (distortion==0.0) { return coords; }\nvec2 direction=1.0*normalize(centered_screen_pos);vec2 dist_coords=vec2(0.5,0.5);dist_coords.x=0.5+direction.x*radius2*1.0;dist_coords.y=0.5+direction.y*radius2*1.0;float dist_amount=clamp(distortion*0.23,0.0,1.0);dist_coords=mix(coords,dist_coords,dist_amount);return dist_coords;}\nfloat sampleScreen(inout vec4 color,in vec2 offset,in float weight) {vec2 coords=distorted_coords;float angle=rand(coords*100.0).x*TWOPI;coords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));color+=texture2D(textureSampler,coords)*weight;return weight;}\nfloat getBlurLevel(float size) {return min(3.0,ceil(size/1.0));}\nvec4 getBlurColor(float size) {vec4 col=texture2D(textureSampler,distorted_coords);float blur_level=getBlurLevel(size);float w=(size/screen_width);float h=(size/screen_height);float total_weight=1.0;vec2 sample_coords;total_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);total_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);total_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);total_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);total_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);total_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);total_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);total_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);total_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);total_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);if (blur_level>1.0) {total_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);total_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);total_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);total_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);total_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);total_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);total_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);total_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);total_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);total_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);}\nif (blur_level>2.0) {total_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);total_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);total_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);total_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);total_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);total_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);total_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);total_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);total_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);}\ncol/=total_weight; \nif (darken>0.0) {col.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);}\nreturn col;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{centered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);radius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;radius=sqrt(radius2);distorted_coords=getDistortedCoords(vUV); \nvec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height); \nfloat depth=texture2D(depthSampler,distorted_coords).r; \nfloat distance=near+(far-near)*depth; \nvec4 color=texture2D(textureSampler,vUV); \nfloat coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));if (dof_enabled==false || coc<0.07) { coc=0.0; }\nfloat edge_blur_amount=0.0;if (edge_blur>0.0) {edge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;}\nfloat blur_amount=max(edge_blur_amount,coc);if (blur_amount==0.0) {gl_FragColor=texture2D(textureSampler,distorted_coords);}\nelse {gl_FragColor=getBlurColor(blur_amount*1.7);if (highlights) {gl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;}\nif (blur_noise) {vec2 noise=rand(distorted_coords)*0.01*blur_amount;vec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);gl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;}}\nif (grain_amount>0.0) {vec4 grain_color=texture2D(grainSampler,texels_coords*0.003);gl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;}}\n";qi.l.ShadersStore[sI]=nI;class oI extends QA{constructor(e,t,i,r=1,s){super(i.getEngine(),e),this.LensChromaticAberrationEffect="LensChromaticAberrationEffect",this.HighlightsEnhancingEffect="HighlightsEnhancingEffect",this.LensDepthOfFieldEffect="LensDepthOfFieldEffect",this._pentagonBokehIsEnabled=!1,this._scene=i,this._depthTexture=i.enableDepthRenderer().getDepthMap(),t.grain_texture?this._grainTexture=t.grain_texture:this._createGrainTexture(),this._edgeBlur=t.edge_blur?t.edge_blur:0,this._grainAmount=t.grain_amount?t.grain_amount:0,this._chromaticAberration=t.chromatic_aberration?t.chromatic_aberration:0,this._distortion=t.distortion?t.distortion:0,this._highlightsGain=void 0!==t.dof_gain?t.dof_gain:-1,this._highlightsThreshold=t.dof_threshold?t.dof_threshold:1,this._dofDistance=void 0!==t.dof_focus_distance?t.dof_focus_distance:-1,this._dofAperture=t.dof_aperture?t.dof_aperture:1,this._dofDarken=t.dof_darken?t.dof_darken:0,this._dofPentagon=void 0===t.dof_pentagon||t.dof_pentagon,this._blurNoise=void 0===t.blur_noise||t.blur_noise,this._createChromaticAberrationPostProcess(r),this._createHighlightsPostProcess(r),this._createDepthOfFieldPostProcess(r/4),this.addEffect(new PA(i.getEngine(),this.LensChromaticAberrationEffect,(()=>this._chromaticAberrationPostProcess),!0)),this.addEffect(new PA(i.getEngine(),this.HighlightsEnhancingEffect,(()=>this._highlightsPostProcess),!0)),this.addEffect(new PA(i.getEngine(),this.LensDepthOfFieldEffect,(()=>this._depthOfFieldPostProcess),!0)),-1===this._highlightsGain&&this._disableEffect(this.HighlightsEnhancingEffect,null),i.postProcessRenderPipelineManager.addPipeline(this),s&&i.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,s)}getClassName(){return"LensRenderingPipeline"}get scene(){return this._scene}get edgeBlur(){return this._edgeBlur}set edgeBlur(e){this.setEdgeBlur(e)}get grainAmount(){return this._grainAmount}set grainAmount(e){this.setGrainAmount(e)}get chromaticAberration(){return this._chromaticAberration}set chromaticAberration(e){this.setChromaticAberration(e)}get dofAperture(){return this._dofAperture}set dofAperture(e){this.setAperture(e)}get edgeDistortion(){return this._distortion}set edgeDistortion(e){this.setEdgeDistortion(e)}get dofDistortion(){return this._dofDistance}set dofDistortion(e){this.setFocusDistance(e)}get darkenOutOfFocus(){return this._dofDarken}set darkenOutOfFocus(e){this.setDarkenOutOfFocus(e)}get blurNoise(){return this._blurNoise}set blurNoise(e){this._blurNoise=e}get pentagonBokeh(){return this._pentagonBokehIsEnabled}set pentagonBokeh(e){e?this.enablePentagonBokeh():this.disablePentagonBokeh()}get highlightsGain(){return this._highlightsGain}set highlightsGain(e){this.setHighlightsGain(e)}get highlightsThreshold(){return this._highlightsThreshold}set highlightsThreshold(e){this.setHighlightsThreshold(e)}setEdgeBlur(e){this._edgeBlur=e}disableEdgeBlur(){this._edgeBlur=0}setGrainAmount(e){this._grainAmount=e}disableGrain(){this._grainAmount=0}setChromaticAberration(e){this._chromaticAberration=e}disableChromaticAberration(){this._chromaticAberration=0}setEdgeDistortion(e){this._distortion=e}disableEdgeDistortion(){this._distortion=0}setFocusDistance(e){this._dofDistance=e}disableDepthOfField(){this._dofDistance=-1}setAperture(e){this._dofAperture=e}setDarkenOutOfFocus(e){this._dofDarken=e}enablePentagonBokeh(){this._highlightsPostProcess.updateEffect("#define PENTAGON\n"),this._pentagonBokehIsEnabled=!0}disablePentagonBokeh(){this._pentagonBokehIsEnabled=!1,this._highlightsPostProcess.updateEffect()}enableNoiseBlur(){this._blurNoise=!0}disableNoiseBlur(){this._blurNoise=!1}setHighlightsGain(e){this._highlightsGain=e}setHighlightsThreshold(e){-1===this._highlightsGain&&(this._highlightsGain=1),this._highlightsThreshold=e}disableHighlights(){this._highlightsGain=-1}dispose(e=!1){this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),this._chromaticAberrationPostProcess=null,this._highlightsPostProcess=null,this._depthOfFieldPostProcess=null,this._grainTexture.dispose(),e&&this._scene.disableDepthRenderer()}_createChromaticAberrationPostProcess(e){this._chromaticAberrationPostProcess=new Fi.w("LensChromaticAberration","chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],e,null,$e.g.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._chromaticAberrationPostProcess.onApply=e=>{e.setFloat("chromatic_aberration",this._chromaticAberration),e.setFloat("screen_width",this._scene.getEngine().getRenderWidth()),e.setFloat("screen_height",this._scene.getEngine().getRenderHeight()),e.setFloat("radialIntensity",1),e.setFloat2("direction",17,17),e.setFloat2("centerPosition",.5,.5)}}_createHighlightsPostProcess(e){this._highlightsPostProcess=new Fi.w("LensHighlights","lensHighlights",["gain","threshold","screen_width","screen_height"],[],e,null,$e.g.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,this._dofPentagon?"#define PENTAGON\n":""),this._highlightsPostProcess.externalTextureSamplerBinding=!0,this._highlightsPostProcess.onApply=e=>{e.setFloat("gain",this._highlightsGain),e.setFloat("threshold",this._highlightsThreshold),e.setTextureFromPostProcess("textureSampler",this._chromaticAberrationPostProcess),e.setFloat("screen_width",this._scene.getEngine().getRenderWidth()),e.setFloat("screen_height",this._scene.getEngine().getRenderHeight())}}_createDepthOfFieldPostProcess(e){this._depthOfFieldPostProcess=new Fi.w("LensDepthOfField","depthOfField",["grain_amount","blur_noise","screen_width","screen_height","distortion","dof_enabled","screen_distance","aperture","darken","edge_blur","highlights","near","far"],["depthSampler","grainSampler","highlightsSampler"],e,null,$e.g.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._depthOfFieldPostProcess.externalTextureSamplerBinding=!0,this._depthOfFieldPostProcess.onApply=e=>{e.setTexture("depthSampler",this._depthTexture),e.setTexture("grainSampler",this._grainTexture),e.setTextureFromPostProcess("textureSampler",this._highlightsPostProcess),e.setTextureFromPostProcess("highlightsSampler",this._depthOfFieldPostProcess),e.setFloat("grain_amount",this._grainAmount),e.setBool("blur_noise",this._blurNoise),e.setFloat("screen_width",this._scene.getEngine().getRenderWidth()),e.setFloat("screen_height",this._scene.getEngine().getRenderHeight()),e.setFloat("distortion",this._distortion),e.setBool("dof_enabled",-1!==this._dofDistance),e.setFloat("screen_distance",1/(.1-1/this._dofDistance)),e.setFloat("aperture",this._dofAperture),e.setFloat("darken",this._dofDarken),e.setFloat("edge_blur",this._edgeBlur),e.setBool("highlights",-1!==this._highlightsGain),this._scene.activeCamera&&(e.setFloat("near",this._scene.activeCamera.minZ),e.setFloat("far",this._scene.activeCamera.maxZ))}}_createGrainTexture(){const e=512,t=new Uint8Array(1048576);for(let e=0;e<t.length;){const i=Math.floor(255*(0,yt.RandomRange)(.42,.58));t[e++]=i,t[e++]=i,t[e++]=i,t[e++]=255}const i=He.I.CreateRGBATexture(t,e,e,this._scene,!1,!1,2);i.name="LensNoiseTexture",i.wrapU=$e.g.WRAP_ADDRESSMODE,i.wrapV=$e.g.WRAP_ADDRESSMODE,this._grainTexture=i}}class aI{constructor(){this.enabled=!1,this.name="ssao2",this.texturesRequired=[6,5]}}class lI extends QA{set epsilon(e){this._epsilon=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO())}get epsilon(){return this._epsilon}set samples(e){this._samples=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere()}get samples(){return this._samples}set textureSamples(e){this._textureSamples=e,this._prePassRenderer?this._prePassRenderer.samples=e:this._originalColorPostProcess.samples=e}get textureSamples(){return this._textureSamples}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}set bypassBlur(e){const t=this._getDefinesForBlur(this.expensiveBlur,e),i=this._getSamplersForBlur(e);this._blurHPostProcess.updateEffect(t.h,null,i),this._blurVPostProcess.updateEffect(t.v,null,i),this._bypassBlur=e}get bypassBlur(){return this._bypassBlur}set expensiveBlur(e){const t=this._getDefinesForBlur(e,this._bypassBlur);this._blurHPostProcess.updateEffect(t.h),this._blurVPostProcess.updateEffect(t.v),this._expensiveBlur=e}get expensiveBlur(){return this._expensiveBlur}static get IsSupported(){const e=C.q.LastCreatedEngine;return!!e&&e._features.supportSSAO2}get scene(){return this._scene}constructor(e,t,i,r,s=!1,n=0){if(super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.maxZ=100,this.minZAspect=.2,this._epsilon=.02,this._samples=8,this._textureSamples=1,this._forceGeometryBuffer=!1,this.radius=2,this.base=0,this._bypassBlur=!1,this._expensiveBlur=!0,this.bilateralSamples=16,this.bilateralSoften=0,this.bilateralTolerance=0,this._bits=new Uint32Array(1),this._scene=t,this._ratio=i,this._textureType=n,this._forceGeometryBuffer=s,!this.isSupported)return void m.V.Error("The current engine does not support SSAO 2.");const o=this._ratio.ssaoRatio||i,a=this._ratio.blurRatio||i;this._forceGeometryBuffer?(t.enableGeometryBufferRenderer(),t.geometryBufferRenderer?.generateNormalsInWorldSpace&&m.V.Error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!")):(t.enablePrePassRenderer(),t.prePassRenderer?.generateNormalsInWorldSpace&&m.V.Error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the prepass renderer!")),this._createRandomTexture(),this._originalColorPostProcess=new wi.v("SSAOOriginalSceneColor",1,null,$e.g.BILINEAR_SAMPLINGMODE,t.getEngine(),void 0,this._textureType),this._originalColorPostProcess.samples=this.textureSamples,this._createSSAOPostProcess(1,n),this._createBlurPostProcess(o,a,this._textureType),this._createSSAOCombinePostProcess(a,this._textureType),this.addEffect(new PA(t.getEngine(),this.SSAOOriginalSceneColorEffect,(()=>this._originalColorPostProcess),!0)),this.addEffect(new PA(t.getEngine(),this.SSAORenderEffect,(()=>this._ssaoPostProcess),!0)),this.addEffect(new PA(t.getEngine(),this.SSAOBlurHRenderEffect,(()=>this._blurHPostProcess),!0)),this.addEffect(new PA(t.getEngine(),this.SSAOBlurVRenderEffect,(()=>this._blurVPostProcess),!0)),this.addEffect(new PA(t.getEngine(),this.SSAOCombineRenderEffect,(()=>this._ssaoCombinePostProcess),!0)),t.postProcessRenderPipelineManager.addPipeline(this),r&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,r)}getClassName(){return"SSAO2RenderingPipeline"}dispose(e=!1){for(let e=0;e<this._scene.cameras.length;e++){const t=this._scene.cameras[e];this._originalColorPostProcess.dispose(t),this._ssaoPostProcess.dispose(t),this._blurHPostProcess.dispose(t),this._blurVPostProcess.dispose(t),this._ssaoCombinePostProcess.dispose(t)}this._randomTexture.dispose(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_rebuild(){super._rebuild()}_getSamplersForBlur(e){return e?["textureSampler"]:["textureSampler","depthSampler"]}_getDefinesForBlur(e,t){let i="#define BLUR\n";return t&&(i+="#define BLUR_BYPASS\n"),e||(i+="#define BLUR_LEGACY\n"),{h:i+"#define BLUR_H\n",v:i}}_createBlurPostProcess(e,t,i){const r=this._getDefinesForBlur(this.expensiveBlur,this.bypassBlur),s=this._getSamplersForBlur(this.bypassBlur);this._blurHPostProcess=this._createBlurFilter("BlurH",s,e,r.h,i,!0),this._blurVPostProcess=this._createBlurFilter("BlurV",s,t,r.v,i,!1)}_createBlurFilter(e,t,r,s,n,o){const a=new Fi.w(e,"ssao2",["outSize","samples","soften","tolerance"],t,r,null,$e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,s,n,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,((e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,45076))):t.push(Promise.resolve().then(i.bind(i,85363)))}));return a.onApply=e=>{if(!this._scene.activeCamera)return;const t=this._ratio.blurRatio||this._ratio,i=o?this._originalColorPostProcess.width*t:this._originalColorPostProcess.height*t,r=o?this._originalColorPostProcess.width:this._originalColorPostProcess.height;e.setFloat("outSize",i>0?i:r),e.setInt("samples",this.bilateralSamples),e.setFloat("soften",this.bilateralSoften),e.setFloat("tolerance",this.bilateralTolerance),this._geometryBufferRenderer?e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]):this._prePassRenderer&&e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)])},a.samples=this.textureSamples,a.autoClear=!1,a}_radicalInverse_VdC(e){return this._bits[0]=e,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(1431655765&this._bits[0])<<1|(2863311530&this._bits[0])>>>1>>>0,this._bits[0]=(858993459&this._bits[0])<<2|(3435973836&this._bits[0])>>>2>>>0,this._bits[0]=(252645135&this._bits[0])<<4|(4042322160&this._bits[0])>>>4>>>0,this._bits[0]=(16711935&this._bits[0])<<8|(4278255360&this._bits[0])>>>8>>>0,2.3283064365386963e-10*this._bits[0]}_hammersley(e,t){return[e/t,this._radicalInverse_VdC(e)]}_hemisphereSample_uniform(e,t){const i=2*t*Math.PI,r=1-.85*e,s=Math.sqrt(1-r*r);return new n.Pq(Math.cos(i)*s,Math.sin(i)*s,r)}_generateHemisphere(){const e=this.samples,t=[];let i,r=0;for(;r<e;){if(e<16)i=this._hemisphereSample_uniform(Math.random(),Math.random());else{const t=this._hammersley(r,e);i=this._hemisphereSample_uniform(t[0],t[1])}t.push(i.x,i.y,i.z),r++}return t}_getDefinesForSSAO(){return`#define SSAO\n#define SAMPLES ${this.samples}\n#define EPSILON ${this.epsilon.toFixed(4)}`}_createSSAOPostProcess(e,t){this._sampleSphere=this._generateHemisphere();const r=this._getDefinesForSSAO();this._ssaoPostProcess=new Fi.w("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","texelSize","xViewport","yViewport","maxZ","minZAspect","depthProjection"],["randomSampler","depthSampler","normalSampler"],e,null,$e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,r,t,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,((e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,45076))):t.push(Promise.resolve().then(i.bind(i,85363)))})),this._ssaoPostProcess.autoClear=!1,this._ssaoPostProcess.onApply=e=>{if(this._scene.activeCamera){if(e.setArray3("sampleSphere",this._sampleSphere),e.setFloat("randTextureTiles",32),e.setFloat("samplesFactor",1/this.samples),e.setFloat("totalStrength",this.totalStrength),e.setFloat2("texelSize",1/this._ssaoPostProcess.width,1/this._ssaoPostProcess.height),e.setFloat("radius",this.radius),e.setFloat("maxZ",this.maxZ),e.setFloat("minZAspect",this.minZAspect),e.setFloat("base",this.base),e.setFloat("near",this._scene.activeCamera.minZ),this._scene.activeCamera.mode===ft.i.PERSPECTIVE_CAMERA)e.setMatrix3x3("depthProjection",lI.PERSPECTIVE_DEPTH_PROJECTION),e.setFloat("xViewport",Math.tan(this._scene.activeCamera.fov/2)*this._scene.getEngine().getAspectRatio(this._scene.activeCamera,!0)),e.setFloat("yViewport",Math.tan(this._scene.activeCamera.fov/2));else{const t=this._scene.getEngine().getRenderWidth()/2,i=this._scene.getEngine().getRenderHeight()/2,r=this._scene.activeCamera.orthoLeft??-t,s=this._scene.activeCamera.orthoRight??t,n=this._scene.activeCamera.orthoBottom??-i,o=this._scene.activeCamera.orthoTop??i;e.setMatrix3x3("depthProjection",lI.ORTHO_DEPTH_PROJECTION),e.setFloat("xViewport",.5*(s-r)),e.setFloat("yViewport",.5*(o-n))}e.setMatrix("projection",this._scene.getProjectionMatrix()),this._geometryBufferRenderer?(e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]),e.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[1])):this._prePassRenderer&&(e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),e.setTexture("normalSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(6)])),e.setTexture("randomSampler",this._randomTexture)}},this._ssaoPostProcess.samples=this.textureSamples,this._forceGeometryBuffer||(this._ssaoPostProcess._prePassEffectConfiguration=new aI)}_createSSAOCombinePostProcess(e,t){this._ssaoCombinePostProcess=new Fi.w("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,$e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,void 0,t,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,((e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,68217))):t.push(Promise.resolve().then(i.bind(i,74154)))})),this._ssaoCombinePostProcess.onApply=e=>{const t=this._scene.activeCamera.viewport;e.setVector4("viewport",n.AA.Vector4[0].copyFromFloats(t.x,t.y,t.width,t.height)),e.setTextureFromPostProcessOutput("originalColor",this._originalColorPostProcess)},this._ssaoCombinePostProcess.autoClear=!1,this._ssaoCombinePostProcess.samples=this.textureSamples}_createRandomTexture(){const e=128,t=new Uint8Array(65536),i=n.I9.Zero();for(let e=0;e<t.length;)i.set((0,yt.RandomRange)(0,1),(0,yt.RandomRange)(0,1)).normalize().scaleInPlace(255),t[e++]=Math.floor(i.x),t[e++]=Math.floor(i.y),t[e++]=0,t[e++]=255;const r=He.I.CreateRGBATexture(t,e,e,this._scene,!1,!1,2);r.name="SSAORandomTexture",r.wrapU=$e.g.WRAP_ADDRESSMODE,r.wrapV=$e.g.WRAP_ADDRESSMODE,this._randomTexture=r}serialize(){const e=Ue.p.Serialize(this);return e.customType="SSAO2RenderingPipeline",e}static Parse(e,t,i){return Ue.p.Parse((()=>new lI(e._name,t,e._ratio,void 0,e._forceGeometryBuffer,e._textureType)),e,t,i)}}lI.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1],lI.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1],(0,Ge.Cg)([(0,ze.lK)()],lI.prototype,"totalStrength",void 0),(0,Ge.Cg)([(0,ze.lK)()],lI.prototype,"maxZ",void 0),(0,Ge.Cg)([(0,ze.lK)()],lI.prototype,"minZAspect",void 0),(0,Ge.Cg)([(0,ze.lK)("epsilon")],lI.prototype,"_epsilon",void 0),(0,Ge.Cg)([(0,ze.lK)("samples")],lI.prototype,"_samples",void 0),(0,Ge.Cg)([(0,ze.lK)("textureSamples")],lI.prototype,"_textureSamples",void 0),(0,Ge.Cg)([(0,ze.lK)()],lI.prototype,"_forceGeometryBuffer",void 0),(0,Ge.Cg)([(0,ze.lK)()],lI.prototype,"_ratio",void 0),(0,Ge.Cg)([(0,ze.lK)()],lI.prototype,"_textureType",void 0),(0,Ge.Cg)([(0,ze.lK)()],lI.prototype,"radius",void 0),(0,Ge.Cg)([(0,ze.lK)()],lI.prototype,"base",void 0),(0,Ge.Cg)([(0,ze.lK)("bypassBlur")],lI.prototype,"_bypassBlur",void 0),(0,Ge.Cg)([(0,ze.lK)("expensiveBlur")],lI.prototype,"_expensiveBlur",void 0),(0,Ge.Cg)([(0,ze.lK)()],lI.prototype,"bilateralSamples",void 0),(0,Ge.Cg)([(0,ze.lK)()],lI.prototype,"bilateralSoften",void 0),(0,Ge.Cg)([(0,ze.lK)()],lI.prototype,"bilateralTolerance",void 0),(0,a.Y5)("BABYLON.SSAO2RenderingPipeline",lI);const hI="ssaoPixelShader",cI="uniform sampler2D textureSampler;varying vec2 vUV;\n#ifdef SSAO\nuniform sampler2D randomSampler;uniform float randTextureTiles;uniform float samplesFactor;uniform vec3 sampleSphere[SAMPLES];uniform float totalStrength;uniform float radius;uniform float area;uniform float fallOff;uniform float base;vec3 normalFromDepth(float depth,vec2 coords)\n{vec2 offset1=vec2(0.0,radius);vec2 offset2=vec2(radius,0.0);float depth1=texture2D(textureSampler,coords+offset1).r;float depth2=texture2D(textureSampler,coords+offset2).r;vec3 p1=vec3(offset1,depth1-depth);vec3 p2=vec3(offset2,depth2-depth);vec3 normal=cross(p1,p2);normal.z=-normal.z;return normalize(normal);}\nvoid main()\n{vec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);float depth=texture2D(textureSampler,vUV).r;vec3 position=vec3(vUV,depth);vec3 normal=normalFromDepth(depth,vUV);float radiusDepth=radius/depth;float occlusion=0.0;vec3 ray;vec3 hemiRay;float occlusionDepth;float difference;for (int i=0; i<SAMPLES; i++)\n{ray=radiusDepth*reflect(sampleSphere[i],random);hemiRay=position+sign(dot(ray,normal))*ray;occlusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;difference=depth-occlusionDepth;occlusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));}\nfloat ao=1.0-totalStrength*occlusion*samplesFactor;float result=clamp(ao+base,0.0,1.0);gl_FragColor.r=result;gl_FragColor.g=result;gl_FragColor.b=result;gl_FragColor.a=1.0;}\n#endif\n";qi.l.ShadersStore[hI]=cI;var uI=i(74154);class dI extends QA{get scene(){return this._scene}constructor(e,t,i,r){super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.radius=1e-4,this.area=.0075,this.fallOff=1e-6,this.base=.5,this._firstUpdate=!0,this._scene=t,this._createRandomTexture();const s=i.ssaoRatio||i,n=i.combineRatio||i;this._originalColorPostProcess=new wi.v("SSAOOriginalSceneColor",n,null,$e.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1),this._createSSAOPostProcess(s),this._createBlurPostProcess(s),this._createSSAOCombinePostProcess(n),this.addEffect(new PA(t.getEngine(),this.SSAOOriginalSceneColorEffect,(()=>this._originalColorPostProcess),!0)),this.addEffect(new PA(t.getEngine(),this.SSAORenderEffect,(()=>this._ssaoPostProcess),!0)),this.addEffect(new PA(t.getEngine(),this.SSAOBlurHRenderEffect,(()=>this._blurHPostProcess),!0)),this.addEffect(new PA(t.getEngine(),this.SSAOBlurVRenderEffect,(()=>this._blurVPostProcess),!0)),this.addEffect(new PA(t.getEngine(),this.SSAOCombineRenderEffect,(()=>this._ssaoCombinePostProcess),!0)),t.postProcessRenderPipelineManager.addPipeline(this),r&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,r)}_attachCameras(e,t){super._attachCameras(e,t);for(const e of this._cameras)this._scene.enableDepthRenderer(e).getDepthMap()}getClassName(){return"SSAORenderingPipeline"}dispose(e=!1){for(let e=0;e<this._scene.cameras.length;e++){const t=this._scene.cameras[e];this._originalColorPostProcess.dispose(t),this._ssaoPostProcess.dispose(t),this._blurHPostProcess.dispose(t),this._blurVPostProcess.dispose(t),this._ssaoCombinePostProcess.dispose(t)}this._randomTexture.dispose(),e&&this._scene.disableDepthRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_createBlurPostProcess(e){this._blurHPostProcess=new Ch("BlurH",new n.I9(1,0),16,e,null,$e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurVPostProcess=new Ch("BlurV",new n.I9(0,1),16,e,null,$e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurHPostProcess.onActivateObservable.add((()=>{const e=this._blurHPostProcess.width/this._scene.getEngine().getRenderWidth();this._blurHPostProcess.kernel=16*e})),this._blurVPostProcess.onActivateObservable.add((()=>{const e=this._blurVPostProcess.height/this._scene.getEngine().getRenderHeight();this._blurVPostProcess.kernel=16*e}))}_rebuild(){this._firstUpdate=!0,super._rebuild()}_createSSAOPostProcess(e){const t=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271];this._ssaoPostProcess=new Fi.w("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],e,null,$e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define SAMPLES 16\n#define SSAO"),this._ssaoPostProcess.externalTextureSamplerBinding=!0,this._ssaoPostProcess.onApply=e=>{this._firstUpdate&&(e.setArray3("sampleSphere",t),e.setFloat("samplesFactor",.0625),e.setFloat("randTextureTiles",4)),e.setFloat("totalStrength",this.totalStrength),e.setFloat("radius",this.radius),e.setFloat("area",this.area),e.setFloat("fallOff",this.fallOff),e.setFloat("base",this.base),e.setTexture("textureSampler",this._scene.enableDepthRenderer(this._scene.activeCamera).getDepthMap()),e.setTexture("randomSampler",this._randomTexture)}}_createSSAOCombinePostProcess(e){this._ssaoCombinePostProcess=new Fi.w("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,$e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=e=>{e.setVector4("viewport",n.AA.Vector4[0].copyFromFloats(0,0,1,1)),e.setTextureFromPostProcess("originalColor",this._originalColorPostProcess)}}_createRandomTexture(){const e=512,t=new Uint8Array(1048576);for(let e=0;e<t.length;)t[e++]=Math.floor(255*Math.max(0,(0,yt.RandomRange)(-1,1))),t[e++]=Math.floor(255*Math.max(0,(0,yt.RandomRange)(-1,1))),t[e++]=Math.floor(255*Math.max(0,(0,yt.RandomRange)(-1,1))),t[e++]=255;const i=He.I.CreateRGBATexture(t,e,e,this._scene,!1,!1,2);i.name="SSAORandomTexture",i.wrapU=$e.g.WRAP_ADDRESSMODE,i.wrapV=$e.g.WRAP_ADDRESSMODE,this._randomTexture=i}}(0,Ge.Cg)([(0,ze.lK)()],dI.prototype,"totalStrength",void 0),(0,Ge.Cg)([(0,ze.lK)()],dI.prototype,"radius",void 0),(0,Ge.Cg)([(0,ze.lK)()],dI.prototype,"area",void 0),(0,Ge.Cg)([(0,ze.lK)()],dI.prototype,"fallOff",void 0),(0,Ge.Cg)([(0,ze.lK)()],dI.prototype,"base",void 0);class pI{constructor(){this.enabled=!1,this.name="screenSpaceReflections",this.texturesRequired=[6,3,1]}}const mI="screenSpaceReflectionPixelShader",fI="uniform sampler2D textureSampler;\n#ifdef SSR_SUPPORTED\nuniform sampler2D reflectivitySampler;uniform sampler2D normalSampler;uniform sampler2D positionSampler;\n#endif\nuniform mat4 view;uniform mat4 projection;uniform float stepSize;uniform float strength;uniform float threshold;uniform float roughnessFactor;uniform float reflectionSpecularFalloffExponent;varying vec2 vUV;\n#ifdef SSR_SUPPORTED\nstruct ReflectionInfo {vec3 color;vec4 coords;};/**\n* According to specular,see https:\n*/\nvec3 fresnelSchlick(float cosTheta,vec3 F0)\n{return F0+(1.0-F0)*pow(1.0-cosTheta,5.0);}\n/**\n* Once the pixel's coordinates has been found,let's adjust (smooth) a little bit\n* by sampling multiple reflection pixels.\n*/\nReflectionInfo smoothReflectionInfo(vec3 dir,vec3 hitCoord)\n{ReflectionInfo info;info.color=vec3(0.0);vec4 projectedCoord;float sampledDepth;for(int i=0; i<SMOOTH_STEPS; i++)\n{projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;float depth=sampledDepth-hitCoord.z;dir*=0.5;if(depth>0.0)\nhitCoord-=dir;else\nhitCoord+=dir;info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;}\nprojectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);info.coords=vec4(projectedCoord.xy,sampledDepth,1.0);info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;info.color/=float(SMOOTH_STEPS+1);return info;}\n/**\n* Tests the given world position (hitCoord) according to the given reflection vector (dir)\n* until it finds a collision (means that depth is enough close to say \"it's the pixel to sample!\").\n*/\nReflectionInfo getReflectionInfo(vec3 dir,vec3 hitCoord)\n{ReflectionInfo info;vec4 projectedCoord;float sampledDepth;dir*=stepSize;for(int i=0; i<REFLECTION_SAMPLES; i++)\n{hitCoord+=dir;projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;float depth=sampledDepth-hitCoord.z;\n#ifdef RIGHT_HANDED_SCENE\ndepth*=-1.0;\n#endif\nif(((depth-dir.z)<threshold) && depth<=0.0)\n{\n#ifdef ENABLE_SMOOTH_REFLECTIONS\nreturn smoothReflectionInfo(dir,hitCoord);\n#else\ninfo.color=texture2D(textureSampler,projectedCoord.xy).rgb;info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);return info;\n#endif\n}}\ninfo.color=texture2D(textureSampler,projectedCoord.xy).rgb;info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);return info;}\nvec3 hash(vec3 a)\n{a=fract(a*0.8);a+=dot(a,a.yxz+19.19);return fract((a.xxy+a.yxx)*a.zyx);}\n#endif\nvoid main()\n{\n#ifdef SSR_SUPPORTED\nvec4 albedoFull=texture2D(textureSampler,vUV);vec3 albedo=albedoFull.rgb;float spec=texture2D(reflectivitySampler,vUV).r;if (spec==0.0) {gl_FragColor=albedoFull;return;}\nvec3 normal=(texture2D(normalSampler,vUV)).xyz;vec3 position=(view*texture2D(positionSampler,vUV)).xyz;vec3 reflected=normalize(reflect(normalize(position),normalize(normal)));float roughness=1.0-texture2D(reflectivitySampler,vUV).a;vec3 jitt=mix(vec3(0.0),hash(position),roughness)*roughnessFactor;ReflectionInfo info=getReflectionInfo(jitt+reflected,position);vec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-info.coords.xy));float screenEdgefactor=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);vec3 F0=vec3(0.04);F0 =mix(F0,albedo,spec);vec3 fresnel=fresnelSchlick(max(dot(normalize(normal),normalize(position)),0.0),F0);\n#ifdef RIGHT_HANDED_SCENE\nreflected.z*=-1.0;\n#endif\nfloat reflectionMultiplier=clamp(pow(spec*strength,reflectionSpecularFalloffExponent)*screenEdgefactor*reflected.z,0.0,0.9);float albedoMultiplier=1.0-reflectionMultiplier;vec3 SSR=info.color*fresnel;gl_FragColor=vec4((albedo*albedoMultiplier)+(SSR*reflectionMultiplier),albedoFull.a);\n#else\ngl_FragColor=texture2D(textureSampler,vUV);\n#endif\n}\n";qi.l.ShadersStore[mI]=fI;class _I extends Fi.w{get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"ScreenSpaceReflectionPostProcess"}constructor(e,t,i,r,s,n,o,a=0,l=!1,h=!1){if(super(e,"screenSpaceReflection",["projection","view","threshold","reflectionSpecularFalloffExponent","strength","stepSize","roughnessFactor"],["textureSampler","normalSampler","positionSampler","reflectivitySampler"],i,r,s,n,o,"#define SSR_SUPPORTED\n#define REFLECTION_SAMPLES 64\n#define SMOOTH_STEPS 5\n",a,void 0,null,l),this.threshold=1.2,this.strength=1,this.reflectionSpecularFalloffExponent=3,this.step=1,this.roughnessFactor=.2,this._forceGeometryBuffer=!1,this._enableSmoothReflections=!1,this._reflectionSamples=64,this._smoothSteps=5,this._forceGeometryBuffer=h,this._forceGeometryBuffer){const e=t.enableGeometryBufferRenderer();e&&e.isSupported&&(e.enablePosition=!0,e.enableReflectivity=!0,e.generateNormalsInWorldSpace&&m.V.Error("ScreenSpaceReflectionPostProcess does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!"))}else{const e=t.enablePrePassRenderer();e?.markAsDirty(),e?.generateNormalsInWorldSpace&&m.V.Error("ScreenSpaceReflectionPostProcess does not support generateNormalsInWorldSpace=true for the prepass renderer!"),this._prePassEffectConfiguration=new pI}this._updateEffectDefines(),this.onApply=e=>{const i=this._geometryBufferRenderer,r=this._prePassRenderer;if(!r&&!i)return;if(i){const t=i.getTextureIndex(UA.POSITION_TEXTURE_TYPE),r=i.getTextureIndex(UA.REFLECTIVITY_TEXTURE_TYPE);e.setTexture("normalSampler",i.getGBuffer().textures[1]),e.setTexture("positionSampler",i.getGBuffer().textures[t]),e.setTexture("reflectivitySampler",i.getGBuffer().textures[r])}else if(r){const t=r.getIndex(1),i=r.getIndex(3),s=r.getIndex(6);e.setTexture("normalSampler",r.getRenderTarget().textures[s]),e.setTexture("positionSampler",r.getRenderTarget().textures[t]),e.setTexture("reflectivitySampler",r.getRenderTarget().textures[i])}const s=t.activeCamera;if(!s)return;const n=s.getViewMatrix(!0),o=s.getProjectionMatrix(!0);e.setMatrix("projection",o),e.setMatrix("view",n),e.setFloat("threshold",this.threshold),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("strength",this.strength),e.setFloat("stepSize",this.step),e.setFloat("roughnessFactor",this.roughnessFactor)},this._isSceneRightHanded=t.useRightHandedSystem}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get reflectionSamples(){return this._reflectionSamples}set reflectionSamples(e){e!==this._reflectionSamples&&(this._reflectionSamples=e,this._updateEffectDefines())}get smoothSteps(){return this._smoothSteps}set smoothSteps(e){e!==this._smoothSteps&&(this._smoothSteps=e,this._updateEffectDefines())}_updateEffectDefines(){const e=[];(this._geometryBufferRenderer||this._prePassRenderer)&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define ENABLE_SMOOTH_REFLECTIONS"),this._isSceneRightHanded&&e.push("#define RIGHT_HANDED_SCENE"),e.push("#define REFLECTION_SAMPLES "+(this._reflectionSamples|0)),e.push("#define SMOOTH_STEPS "+(this._smoothSteps|0)),this.updateEffect(e.join("\n"))}static _Parse(e,t,i,r){return Ue.p.Parse((()=>new _I(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable)),e,i,r)}}(0,Ge.Cg)([(0,ze.lK)()],_I.prototype,"threshold",void 0),(0,Ge.Cg)([(0,ze.lK)()],_I.prototype,"strength",void 0),(0,Ge.Cg)([(0,ze.lK)()],_I.prototype,"reflectionSpecularFalloffExponent",void 0),(0,Ge.Cg)([(0,ze.lK)()],_I.prototype,"step",void 0),(0,Ge.Cg)([(0,ze.lK)()],_I.prototype,"roughnessFactor",void 0),(0,Ge.Cg)([(0,ze.lK)()],_I.prototype,"enableSmoothReflections",null),(0,Ge.Cg)([(0,ze.lK)()],_I.prototype,"reflectionSamples",null),(0,Ge.Cg)([(0,ze.lK)()],_I.prototype,"smoothSteps",null),(0,a.Y5)("BABYLON.ScreenSpaceReflectionPostProcess",_I);const gI="standardPixelShader",xI="uniform sampler2D textureSampler;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#if defined(PASS_POST_PROCESS)\nvoid main(void)\n{vec4 color=texture2D(textureSampler,vUV);gl_FragColor=color;}\n#endif\n#if defined(DOWN_SAMPLE_X4)\nuniform vec2 dsOffsets[16];void main(void)\n{vec4 average=vec4(0.0,0.0,0.0,0.0);average=texture2D(textureSampler,vUV+dsOffsets[0]);average+=texture2D(textureSampler,vUV+dsOffsets[1]);average+=texture2D(textureSampler,vUV+dsOffsets[2]);average+=texture2D(textureSampler,vUV+dsOffsets[3]);average+=texture2D(textureSampler,vUV+dsOffsets[4]);average+=texture2D(textureSampler,vUV+dsOffsets[5]);average+=texture2D(textureSampler,vUV+dsOffsets[6]);average+=texture2D(textureSampler,vUV+dsOffsets[7]);average+=texture2D(textureSampler,vUV+dsOffsets[8]);average+=texture2D(textureSampler,vUV+dsOffsets[9]);average+=texture2D(textureSampler,vUV+dsOffsets[10]);average+=texture2D(textureSampler,vUV+dsOffsets[11]);average+=texture2D(textureSampler,vUV+dsOffsets[12]);average+=texture2D(textureSampler,vUV+dsOffsets[13]);average+=texture2D(textureSampler,vUV+dsOffsets[14]);average+=texture2D(textureSampler,vUV+dsOffsets[15]);average/=16.0;gl_FragColor=average;}\n#endif\n#if defined(BRIGHT_PASS)\nuniform vec2 dsOffsets[4];uniform float brightThreshold;void main(void)\n{vec4 average=vec4(0.0,0.0,0.0,0.0);average=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));average*=0.25;float luminance=length(average.rgb);if (luminance<brightThreshold) {average=vec4(0.0,0.0,0.0,1.0);}\ngl_FragColor=average;}\n#endif\n#if defined(TEXTURE_ADDER)\nuniform sampler2D otherSampler;uniform sampler2D lensSampler;uniform float exposure;void main(void)\n{vec3 colour=texture2D(textureSampler,vUV).rgb;colour*=exposure;vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;colour+=colour*texture2D(lensSampler,vUV).rgb;vec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);gl_FragColor=finalColor;}\n#endif\n#if defined(VLS)\n#define PI 3.1415926535897932384626433832795\nuniform mat4 shadowViewProjection;uniform mat4 lightWorld;uniform vec3 cameraPosition;uniform vec3 sunDirection;uniform vec3 sunColor;uniform vec2 depthValues;uniform float scatteringCoefficient;uniform float scatteringPower;uniform sampler2D shadowMapSampler;uniform sampler2D positionSampler;float computeScattering(float lightDotView)\n{float result=1.0-scatteringCoefficient*scatteringCoefficient;result/=(4.0*PI*pow(1.0+scatteringCoefficient*scatteringCoefficient-(2.0*scatteringCoefficient)*lightDotView,1.5));return result;}\nvoid main(void)\n{vec3 worldPos=texture2D(positionSampler,vUV).rgb;vec3 startPosition=cameraPosition;vec3 rayVector=worldPos-startPosition;float rayLength=length(rayVector);vec3 rayDirection=rayVector/rayLength;float stepLength=rayLength/NB_STEPS;vec3 stepL=rayDirection*stepLength;vec3 currentPosition=startPosition;vec3 accumFog=vec3(0.0);for (int i=0; i<int(NB_STEPS); i++)\n{vec4 worldInShadowCameraSpace=shadowViewProjection*vec4(currentPosition,1.0);float depthMetric= (worldInShadowCameraSpace.z+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depthMetric,0.0,1.0);worldInShadowCameraSpace.xyz/=worldInShadowCameraSpace.w;worldInShadowCameraSpace.xyz=0.5*worldInShadowCameraSpace.xyz+vec3(0.5);float shadowMapValue=texture2D(shadowMapSampler,worldInShadowCameraSpace.xy).r;if (shadowMapValue>shadowPixelDepth)\naccumFog+=sunColor*computeScattering(dot(rayDirection,sunDirection));currentPosition+=stepL;}\naccumFog/=NB_STEPS;vec3 color=accumFog*scatteringPower;gl_FragColor=vec4(color*exp(color) ,1.0);}\n#endif\n#if defined(VLSMERGE)\nuniform sampler2D originalSampler;void main(void)\n{gl_FragColor=texture2D(originalSampler,vUV)+texture2D(textureSampler,vUV);}\n#endif\n#if defined(LUMINANCE)\nuniform vec2 lumOffsets[4];void main()\n{float average=0.0;vec4 color=vec4(0.0);float maximum=-1e20;vec3 weight=vec3(0.299,0.587,0.114);for (int i=0; i<4; i++)\n{color=texture2D(textureSampler,vUV+ lumOffsets[i]);float GreyValue=dot(color.rgb,vec3(0.33,0.33,0.33));\n#ifdef WEIGHTED_AVERAGE\nfloat GreyValue=dot(color.rgb,weight);\n#endif\n#ifdef BRIGHTNESS\nfloat GreyValue=max(color.r,max(color.g,color.b));\n#endif\n#ifdef HSL_COMPONENT\nfloat GreyValue=0.5*(max(color.r,max(color.g,color.b))+min(color.r,min(color.g,color.b)));\n#endif\n#ifdef MAGNITUDE\nfloat GreyValue=length(color.rgb);\n#endif\nmaximum=max(maximum,GreyValue);average+=(0.25*log(1e-5+GreyValue));}\naverage=exp(average);gl_FragColor=vec4(average,maximum,0.0,1.0);}\n#endif\n#if defined(LUMINANCE_DOWN_SAMPLE)\nuniform vec2 dsOffsets[9];uniform float halfDestPixelSize;\n#ifdef FINAL_DOWN_SAMPLER\n#include<packingFunctions>\n#endif\nvoid main()\n{vec4 color=vec4(0.0);float average=0.0;for (int i=0; i<9; i++)\n{color=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);average+=color.r;}\naverage/=9.0;\n#ifdef FINAL_DOWN_SAMPLER\ngl_FragColor=pack(average);\n#else\ngl_FragColor=vec4(average,average,0.0,1.0);\n#endif\n}\n#endif\n#if defined(HDR)\nuniform sampler2D textureAdderSampler;uniform float averageLuminance;void main()\n{vec4 color=texture2D(textureAdderSampler,vUV);\n#ifndef AUTO_EXPOSURE\nvec4 adjustedColor=color/averageLuminance;color=adjustedColor;color.a=1.0;\n#endif\ngl_FragColor=color;}\n#endif\n#if defined(LENS_FLARE)\n#define GHOSTS 3\nuniform sampler2D lensColorSampler;uniform float strength;uniform float ghostDispersal;uniform float haloWidth;uniform vec2 resolution;uniform float distortionStrength;float hash(vec2 p)\n{float h=dot(p,vec2(127.1,311.7));return -1.0+2.0*fract(sin(h)*43758.5453123);}\nfloat noise(in vec2 p)\n{vec2 i=floor(p);vec2 f=fract(p);vec2 u=f*f*(3.0-2.0*f);return mix(mix(hash(i+vec2(0.0,0.0)),\nhash(i+vec2(1.0,0.0)),u.x),\nmix(hash(i+vec2(0.0,1.0)),\nhash(i+vec2(1.0,1.0)),u.x),u.y);}\nfloat fbm(vec2 p)\n{float f=0.0;f+=0.5000*noise(p); p*=2.02;f+=0.2500*noise(p); p*=2.03;f+=0.1250*noise(p); p*=2.01;f+=0.0625*noise(p); p*=2.04;f/=0.9375;return f;}\nvec3 pattern(vec2 uv)\n{vec2 p=-1.0+2.0*uv;float p2=dot(p,p);float f=fbm(vec2(15.0*p2))/2.0;float r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));float g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));float b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));return (1.0-f)*vec3(r,g,b);}\nfloat luminance(vec3 color)\n{return dot(color.rgb,vec3(0.2126,0.7152,0.0722));}\nvec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)\n{return vec4(\ntexture2D(tex,texcoord+direction*distortion.r).r,\ntexture2D(tex,texcoord+direction*distortion.g).g,\ntexture2D(tex,texcoord+direction*distortion.b).b,\n1.0\n);}\nvoid main(void)\n{vec2 uv=-vUV+vec2(1.0);vec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;vec2 texelSize=1.0/resolution;vec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);vec4 result=vec4(0.0);float ghostIndice=1.0;for (int i=0; i<GHOSTS; ++i)\n{vec2 offset=fract(uv+ghostDir*ghostIndice);float weight=length(vec2(0.5)-offset)/length(vec2(0.5));weight=pow(1.0-weight,10.0);result+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;ghostIndice+=1.0;}\nvec2 haloVec=normalize(ghostDir)*haloWidth;float weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));weight=pow(1.0-weight,10.0);result+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;result*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));gl_FragColor=result;}\n#endif\n#if defined(LENS_FLARE_COMPOSE)\nuniform sampler2D otherSampler;uniform sampler2D lensDirtSampler;uniform sampler2D lensStarSampler;uniform mat4 lensStarMatrix;void main(void)\n{vec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;vec4 lensMod=texture2D(lensDirtSampler,vUV);lensMod+=texture2D(lensStarSampler,vUV/*lensFlareCoords*/);vec4 result=texture2D(textureSampler,vUV)*lensMod;gl_FragColor=texture2D(otherSampler,vUV)+result;}\n#endif\n#if defined(DEPTH_OF_FIELD)\nuniform sampler2D otherSampler;uniform sampler2D depthSampler;uniform float distance;void main(void)\n{vec4 sharp=texture2D(otherSampler,vUV);vec4 blur=texture2D(textureSampler,vUV);float dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);float factor=0.0;if (dist<0.05)\nfactor=1.0;else if (dist<0.1)\nfactor=20.0*(0.1-dist);else if (dist<0.5)\nfactor=0.0;else\nfactor=2.0*(dist-0.5);factor=clamp(factor,0.0,0.90);gl_FragColor=mix(sharp,blur,factor);}\n#endif\n#if defined(MOTION_BLUR)\nuniform mat4 inverseViewProjection;uniform mat4 prevViewProjection;uniform vec2 screenSize;uniform float motionScale;uniform float motionStrength;uniform sampler2D depthSampler;void main(void)\n{vec2 texelSize=1.0/screenSize;float depth=texture2D(depthSampler,vUV).r;vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);cpos=cpos*inverseViewProjection;vec4 ppos=cpos*prevViewProjection;ppos.xyz/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;float speed=length(velocity/texelSize);int nSamples=int(clamp(speed,1.0,MAX_MOTION_SAMPLES));vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(MAX_MOTION_SAMPLES); ++i) {if (i>=nSamples)\nbreak;vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);result+=texture2D(textureSampler,offset1);}\ngl_FragColor=result/float(nSamples);}\n#endif\n";qi.l.ShadersStore[gI]=xI;class vI extends QA{get exposure(){return this._fixedExposure}set exposure(e){this._fixedExposure=e,this._currentExposure=e}get hdrAutoExposure(){return this._hdrAutoExposure}set hdrAutoExposure(e){if(this._hdrAutoExposure=e,this.hdrPostProcess){const t=["#define HDR"];e&&t.push("#define AUTO_EXPOSURE"),this.hdrPostProcess.updateEffect(t.join("\n"))}}get motionStrength(){return this._motionStrength}set motionStrength(e){this._motionStrength=e,this._isObjectBasedMotionBlur&&this.motionBlurPostProcess&&(this.motionBlurPostProcess.motionStrength=e)}get objectBasedMotionBlur(){return this._isObjectBasedMotionBlur}set objectBasedMotionBlur(e){const t=this._isObjectBasedMotionBlur!==e;this._isObjectBasedMotionBlur=e,t&&this._buildPipeline()}get BloomEnabled(){return this._bloomEnabled}set BloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get DepthOfFieldEnabled(){return this._depthOfFieldEnabled}set DepthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get LensFlareEnabled(){return this._lensFlareEnabled}set LensFlareEnabled(e){this._lensFlareEnabled!==e&&(this._lensFlareEnabled=e,this._buildPipeline())}get HDREnabled(){return this._hdrEnabled}set HDREnabled(e){this._hdrEnabled!==e&&(this._hdrEnabled=e,this._buildPipeline())}get VLSEnabled(){return this._vlsEnabled}set VLSEnabled(e){if(this._vlsEnabled!==e){if(e){if(!this._scene.enableGeometryBufferRenderer())return void m.V.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline")}this._vlsEnabled=e,this._buildPipeline()}}get MotionBlurEnabled(){return this._motionBlurEnabled}set MotionBlurEnabled(e){this._motionBlurEnabled!==e&&(this._motionBlurEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get screenSpaceReflectionsEnabled(){return this._screenSpaceReflectionsEnabled}set screenSpaceReflectionsEnabled(e){this._screenSpaceReflectionsEnabled!==e&&(this._screenSpaceReflectionsEnabled=e,this._buildPipeline())}get volumetricLightStepsCount(){return this._volumetricLightStepsCount}set volumetricLightStepsCount(e){this.volumetricLightPostProcess&&this.volumetricLightPostProcess.updateEffect("#define VLS\n#define NB_STEPS "+e.toFixed(1)),this._volumetricLightStepsCount=e}get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this.motionBlurPostProcess&&(this._isObjectBasedMotionBlur?this.motionBlurPostProcess.motionBlurSamples=e:this.motionBlurPostProcess.updateEffect("#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+e.toFixed(1))),this._motionBlurSamples=e}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}constructor(e,t,i,r=null,s){super(t.getEngine(),e),this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.blurHPostProcesses=[],this.blurVPostProcesses=[],this.textureAdderPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.luminancePostProcess=null,this.luminanceDownSamplePostProcesses=[],this.hdrPostProcess=null,this.textureAdderFinalPostProcess=null,this.lensFlareFinalPostProcess=null,this.hdrFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.motionBlurPostProcess=null,this.depthOfFieldPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.brightThreshold=1,this.blurWidth=512,this.horizontalBlur=!1,this.lensTexture=null,this.volumetricLightCoefficient=.2,this.volumetricLightPower=4,this.volumetricLightBlurScale=64,this.sourceLight=null,this.hdrMinimumLuminance=1,this.hdrDecreaseRate=.5,this.hdrIncreaseRate=.5,this.lensColorTexture=null,this.lensFlareStrength=20,this.lensFlareGhostDispersal=1.4,this.lensFlareHaloWidth=.7,this.lensFlareDistortionStrength=16,this.lensFlareBlurWidth=512,this.lensStarTexture=null,this.lensFlareDirtTexture=null,this.depthOfFieldDistance=10,this.depthOfFieldBlurWidth=64,this.animations=[],this._currentDepthOfFieldSource=null,this._fixedExposure=1,this._currentExposure=1,this._hdrAutoExposure=!1,this._hdrCurrentLuminance=1,this._motionStrength=1,this._isObjectBasedMotionBlur=!1,this._camerasToBeAttached=[],this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._vlsEnabled=!1,this._lensFlareEnabled=!1,this._hdrEnabled=!1,this._motionBlurEnabled=!1,this._fxaaEnabled=!1,this._screenSpaceReflectionsEnabled=!1,this._motionBlurSamples=64,this._volumetricLightStepsCount=50,this._samples=1,this._cameras=s||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._basePostProcess=r,this._ratio=i,this._floatTextureType=t.getEngine().getCaps().textureFloatRender?1:2,t.postProcessRenderPipelineManager.addPipeline(this),this._buildPipeline()}_buildPipeline(){const e=this._ratio,t=this._scene;this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._screenSpaceReflectionsEnabled&&(this.screenSpaceReflectionPostProcess=new _I("HDRPass",t,e,null,$e.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,this._floatTextureType),this.screenSpaceReflectionPostProcess.onApplyObservable.add((()=>{this._currentDepthOfFieldSource=this.screenSpaceReflectionPostProcess})),this.addEffect(new PA(t.getEngine(),"HDRScreenSpaceReflections",(()=>this.screenSpaceReflectionPostProcess),!0))),this._basePostProcess?this.originalPostProcess=this._basePostProcess:this.originalPostProcess=new Fi.w("HDRPass","standard",[],[],e,null,$e.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",this._floatTextureType),this.originalPostProcess.autoClear=!this.screenSpaceReflectionPostProcess,this.originalPostProcess.onApplyObservable.add((()=>{this._currentDepthOfFieldSource=this.originalPostProcess})),this.addEffect(new PA(t.getEngine(),"HDRPassPostProcess",(()=>this.originalPostProcess),!0)),this._bloomEnabled&&(this._createDownSampleX4PostProcess(t,e/4),this._createBrightPassPostProcess(t,e/4),this._createBlurPostProcesses(t,e/4,1),this._createTextureAdderPostProcess(t,e),this.textureAdderFinalPostProcess=new Fi.w("HDRDepthOfFieldSource","standard",[],[],e,null,$e.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new PA(t.getEngine(),"HDRBaseDepthOfFieldSource",(()=>this.textureAdderFinalPostProcess),!0))),this._vlsEnabled&&(this._createVolumetricLightPostProcess(t,e),this.volumetricLightFinalPostProcess=new Fi.w("HDRVLSFinal","standard",[],[],e,null,$e.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new PA(t.getEngine(),"HDRVLSFinal",(()=>this.volumetricLightFinalPostProcess),!0))),this._lensFlareEnabled&&(this._createLensFlarePostProcess(t,e),this.lensFlareFinalPostProcess=new Fi.w("HDRPostLensFlareDepthOfFieldSource","standard",[],[],e,null,$e.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new PA(t.getEngine(),"HDRPostLensFlareDepthOfFieldSource",(()=>this.lensFlareFinalPostProcess),!0))),this._hdrEnabled&&(this._createLuminancePostProcesses(t,this._floatTextureType),this._createHdrPostProcess(t,e),this.hdrFinalPostProcess=new Fi.w("HDRPostHDReDepthOfFieldSource","standard",[],[],e,null,$e.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new PA(t.getEngine(),"HDRPostHDReDepthOfFieldSource",(()=>this.hdrFinalPostProcess),!0))),this._depthOfFieldEnabled&&(this._createBlurPostProcesses(t,e/2,3,"depthOfFieldBlurWidth"),this._createDepthOfFieldPostProcess(t,e)),this._motionBlurEnabled&&this._createMotionBlurPostProcess(t,e),this._fxaaEnabled&&(this.fxaaPostProcess=new hT("fxaa",1,null,$e.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,0),this.addEffect(new PA(t.getEngine(),"HDRFxaa",(()=>this.fxaaPostProcess),!0))),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),!this._enableMSAAOnFirstPostProcess(this._samples)&&this._samples>1&&m.V.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")}_createDownSampleX4PostProcess(e,t){const i=new Array(32);this.downSampleX4PostProcess=new Fi.w("HDRDownSampleX4","standard",["dsOffsets"],[],t,null,$e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DOWN_SAMPLE_X4",this._floatTextureType),this.downSampleX4PostProcess.onApply=e=>{let t=0;const r=this.downSampleX4PostProcess.width,s=this.downSampleX4PostProcess.height;for(let e=-2;e<2;e++)for(let n=-2;n<2;n++)i[t]=(e+.5)*(1/r),i[t+1]=(n+.5)*(1/s),t+=2;e.setArray2("dsOffsets",i)},this.addEffect(new PA(e.getEngine(),"HDRDownSampleX4",(()=>this.downSampleX4PostProcess),!0))}_createBrightPassPostProcess(e,t){const i=new Array(8);this.brightPassPostProcess=new Fi.w("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],t,null,$e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define BRIGHT_PASS",this._floatTextureType),this.brightPassPostProcess.onApply=e=>{const t=1/this.brightPassPostProcess.width,r=1/this.brightPassPostProcess.height;i[0]=-.5*t,i[1]=.5*r,i[2]=.5*t,i[3]=.5*r,i[4]=-.5*t,i[5]=-.5*r,i[6]=.5*t,i[7]=-.5*r,e.setArray2("dsOffsets",i),e.setFloat("brightThreshold",this.brightThreshold)},this.addEffect(new PA(e.getEngine(),"HDRBrightPass",(()=>this.brightPassPostProcess),!0))}_createBlurPostProcesses(e,t,i,r="blurWidth"){const s=e.getEngine(),o=new Ch("HDRBlurH_"+i,new n.I9(1,0),this[r],t,null,$e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType),a=new Ch("HDRBlurV_"+i,new n.I9(0,1),this[r],t,null,$e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType);o.onActivateObservable.add((()=>{const e=o.width/s.getRenderWidth();o.kernel=this[r]*e})),a.onActivateObservable.add((()=>{const e=a.height/s.getRenderHeight();a.kernel=this.horizontalBlur?64*e:this[r]*e})),this.addEffect(new PA(e.getEngine(),"HDRBlurH"+i,(()=>o),!0)),this.addEffect(new PA(e.getEngine(),"HDRBlurV"+i,(()=>a),!0)),this.blurHPostProcesses.push(o),this.blurVPostProcesses.push(a)}_createTextureAdderPostProcess(e,t){this.textureAdderPostProcess=new Fi.w("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],t,null,$e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define TEXTURE_ADDER",this._floatTextureType),this.textureAdderPostProcess.onApply=e=>{e.setTextureFromPostProcess("otherSampler",this._vlsEnabled?this._currentDepthOfFieldSource:this.originalPostProcess),e.setTexture("lensSampler",this.lensTexture),e.setFloat("exposure",this._currentExposure),this._currentDepthOfFieldSource=this.textureAdderFinalPostProcess},this.addEffect(new PA(e.getEngine(),"HDRTextureAdder",(()=>this.textureAdderPostProcess),!0))}_createVolumetricLightPostProcess(e,t){const i=e.enableGeometryBufferRenderer();i.enablePosition=!0;const r=i.getGBuffer();this.volumetricLightPostProcess=new Fi.w("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],t/8,null,$e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLS\n#define NB_STEPS "+this._volumetricLightStepsCount.toFixed(1));const s=n.I9.Zero();this.volumetricLightPostProcess.onApply=e=>{if(this.sourceLight&&this.sourceLight.getShadowGenerator()&&this._scene.activeCamera){const t=this.sourceLight.getShadowGenerator();e.setTexture("shadowMapSampler",t.getShadowMap()),e.setTexture("positionSampler",r.textures[2]),e.setColor3("sunColor",this.sourceLight.diffuse),e.setVector3("sunDirection",this.sourceLight.getShadowDirection()),e.setVector3("cameraPosition",this._scene.activeCamera.globalPosition),e.setMatrix("shadowViewProjection",t.getTransformMatrix()),e.setFloat("scatteringCoefficient",this.volumetricLightCoefficient),e.setFloat("scatteringPower",this.volumetricLightPower),s.x=this.sourceLight.getDepthMinZ(this._scene.activeCamera),s.y=this.sourceLight.getDepthMaxZ(this._scene.activeCamera),e.setVector2("depthValues",s)}},this.addEffect(new PA(e.getEngine(),"HDRVLS",(()=>this.volumetricLightPostProcess),!0)),this._createBlurPostProcesses(e,t/4,0,"volumetricLightBlurScale"),this.volumetricLightMergePostProces=new Fi.w("HDRVLSMerge","standard",[],["originalSampler"],t,null,$e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLSMERGE"),this.volumetricLightMergePostProces.onApply=e=>{e.setTextureFromPostProcess("originalSampler",this._bloomEnabled?this.textureAdderFinalPostProcess:this.originalPostProcess),this._currentDepthOfFieldSource=this.volumetricLightFinalPostProcess},this.addEffect(new PA(e.getEngine(),"HDRVLSMerge",(()=>this.volumetricLightMergePostProces),!0))}_createLuminancePostProcesses(e,t){let i=Math.pow(3,vI.LuminanceSteps);this.luminancePostProcess=new Fi.w("HDRLuminance","standard",["lumOffsets"],[],{width:i,height:i},null,$e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LUMINANCE",t);const r=[];this.luminancePostProcess.onApply=e=>{const t=1/this.luminancePostProcess.width,i=1/this.luminancePostProcess.height;r[0]=-.5*t,r[1]=.5*i,r[2]=.5*t,r[3]=.5*i,r[4]=-.5*t,r[5]=-.5*i,r[6]=.5*t,r[7]=-.5*i,e.setArray2("lumOffsets",r)},this.addEffect(new PA(e.getEngine(),"HDRLuminance",(()=>this.luminancePostProcess),!0));for(let r=vI.LuminanceSteps-1;r>=0;r--){i=Math.pow(3,r);let s="#define LUMINANCE_DOWN_SAMPLE\n";0===r&&(s+="#define FINAL_DOWN_SAMPLER");const n=new Fi.w("HDRLuminanceDownSample"+r,"standard",["dsOffsets","halfDestPixelSize"],[],{width:i,height:i},null,$e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,s,t);this.luminanceDownSamplePostProcesses.push(n)}let s=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach(((t,i)=>{const r=new Array(18);t.onApply=e=>{if(!s)return;let n=0;for(let e=-1;e<2;e++)for(let t=-1;t<2;t++)r[n]=e/s.width,r[n+1]=t/s.height,n+=2;e.setArray2("dsOffsets",r),e.setFloat("halfDestPixelSize",.5/s.width),s=i===this.luminanceDownSamplePostProcesses.length-1?this.luminancePostProcess:t},i===this.luminanceDownSamplePostProcesses.length-1&&(t.onAfterRender=()=>{const t=e.getEngine().readPixels(0,0,1,1),i=new n.IU(1/16581375,1/65025,1/255,1);t.then((e=>{const t=new Uint8Array(e.buffer);this._hdrCurrentLuminance=(t[0]*i.x+t[1]*i.y+t[2]*i.z+t[3]*i.w)/100}))}),this.addEffect(new PA(e.getEngine(),"HDRLuminanceDownSample"+i,(()=>t),!0))}))}_createHdrPostProcess(e,t){const i=["#define HDR"];this._hdrAutoExposure&&i.push("#define AUTO_EXPOSURE"),this.hdrPostProcess=new Fi.w("HDR","standard",["averageLuminance"],["textureAdderSampler"],t,null,$e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,i.join("\n"),0);let r=1,s=0,n=0;this.hdrPostProcess.onApply=t=>{if(t.setTextureFromPostProcess("textureAdderSampler",this._currentDepthOfFieldSource),s+=e.getEngine().getDeltaTime(),r<0)r=this._hdrCurrentLuminance;else{const e=(n-s)/1e3;this._hdrCurrentLuminance<r+this.hdrDecreaseRate*e?r+=this.hdrDecreaseRate*e:this._hdrCurrentLuminance>r-this.hdrIncreaseRate*e?r-=this.hdrIncreaseRate*e:r=this._hdrCurrentLuminance}this.hdrAutoExposure?this._currentExposure=this._fixedExposure/r:(r=(0,yt.Clamp)(r,this.hdrMinimumLuminance,1e20),t.setFloat("averageLuminance",r)),n=s,this._currentDepthOfFieldSource=this.hdrFinalPostProcess},this.addEffect(new PA(e.getEngine(),"HDR",(()=>this.hdrPostProcess),!0))}_createLensFlarePostProcess(e,t){this.lensFlarePostProcess=new Fi.w("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],t/2,null,$e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE",0),this.addEffect(new PA(e.getEngine(),"HDRLensFlare",(()=>this.lensFlarePostProcess),!0)),this._createBlurPostProcesses(e,t/4,2,"lensFlareBlurWidth"),this.lensFlareComposePostProcess=new Fi.w("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],t,null,$e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE_COMPOSE",0),this.addEffect(new PA(e.getEngine(),"HDRLensFlareCompose",(()=>this.lensFlareComposePostProcess),!0));const i=new n.I9(0,0);this.lensFlarePostProcess.externalTextureSamplerBinding=!0,this.lensFlarePostProcess.onApply=e=>{e.setTextureFromPostProcess("textureSampler",this._bloomEnabled?this.blurHPostProcesses[0]:this.originalPostProcess),e.setTexture("lensColorSampler",this.lensColorTexture),e.setFloat("strength",this.lensFlareStrength),e.setFloat("ghostDispersal",this.lensFlareGhostDispersal),e.setFloat("haloWidth",this.lensFlareHaloWidth),i.x=this.lensFlarePostProcess.width,i.y=this.lensFlarePostProcess.height,e.setVector2("resolution",i),e.setFloat("distortionStrength",this.lensFlareDistortionStrength)};const r=n.uq.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),s=n.uq.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=e=>{if(!this._scene.activeCamera)return;e.setTextureFromPostProcess("otherSampler",this.lensFlarePostProcess),e.setTexture("lensDirtSampler",this.lensFlareDirtTexture),e.setTexture("lensStarSampler",this.lensStarTexture);const t=this._scene.activeCamera.getViewMatrix().getRow(0),i=this._scene.activeCamera.getViewMatrix().getRow(2);let o=n.Pq.Dot(t.toVector3(),new n.Pq(1,0,0))+n.Pq.Dot(i.toVector3(),new n.Pq(0,0,1));o*=4;const a=n.uq.FromValues(.5*Math.cos(o),-Math.sin(o),0,0,Math.sin(o),.5*Math.cos(o),0,0,0,0,1,0,0,0,0,1),l=s.multiply(a).multiply(r);e.setMatrix("lensStarMatrix",l),this._currentDepthOfFieldSource=this.lensFlareFinalPostProcess}}_createDepthOfFieldPostProcess(e,t){this.depthOfFieldPostProcess=new Fi.w("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],t,null,$e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DEPTH_OF_FIELD",0),this.depthOfFieldPostProcess.onApply=e=>{e.setTextureFromPostProcess("otherSampler",this._currentDepthOfFieldSource),e.setTexture("depthSampler",this._getDepthTexture()),e.setFloat("distance",this.depthOfFieldDistance)},this.addEffect(new PA(e.getEngine(),"HDRDepthOfField",(()=>this.depthOfFieldPostProcess),!0))}_createMotionBlurPostProcess(e,t){if(this._isObjectBasedMotionBlur){const i=new $A("HDRMotionBlur",e,t,null,$e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,0);i.motionStrength=this.motionStrength,i.motionBlurSamples=this.motionBlurSamples,this.motionBlurPostProcess=i}else{this.motionBlurPostProcess=new Fi.w("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],t,null,$e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+this.motionBlurSamples.toFixed(1),0);let i=0,r=n.uq.Identity();const s=n.uq.Identity();let o=n.uq.Identity();const a=n.I9.Zero();this.motionBlurPostProcess.onApply=t=>{o=e.getProjectionMatrix().multiply(e.getViewMatrix()),o.invertToRef(s),t.setMatrix("inverseViewProjection",s),t.setMatrix("prevViewProjection",r),r=o,a.x=this.motionBlurPostProcess.width,a.y=this.motionBlurPostProcess.height,t.setVector2("screenSize",a),i=e.getEngine().getFps()/60,t.setFloat("motionScale",i),t.setFloat("motionStrength",this.motionStrength),t.setTexture("depthSampler",this._getDepthTexture())}}this.addEffect(new PA(e.getEngine(),"HDRMotionBlur",(()=>this.motionBlurPostProcess),!0))}_getDepthTexture(){if(this._scene.getEngine().getCaps().drawBuffersExtension){return this._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]}return this._scene.enableDepthRenderer().getDepthMap()}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){const t=this._cameras[e];this.originalPostProcess&&this.originalPostProcess.dispose(t),this.screenSpaceReflectionPostProcess&&this.screenSpaceReflectionPostProcess.dispose(t),this.downSampleX4PostProcess&&this.downSampleX4PostProcess.dispose(t),this.brightPassPostProcess&&this.brightPassPostProcess.dispose(t),this.textureAdderPostProcess&&this.textureAdderPostProcess.dispose(t),this.volumetricLightPostProcess&&this.volumetricLightPostProcess.dispose(t),this.volumetricLightSmoothXPostProcess&&this.volumetricLightSmoothXPostProcess.dispose(t),this.volumetricLightSmoothYPostProcess&&this.volumetricLightSmoothYPostProcess.dispose(t),this.volumetricLightMergePostProces&&this.volumetricLightMergePostProces.dispose(t),this.volumetricLightFinalPostProcess&&this.volumetricLightFinalPostProcess.dispose(t),this.lensFlarePostProcess&&this.lensFlarePostProcess.dispose(t),this.lensFlareComposePostProcess&&this.lensFlareComposePostProcess.dispose(t);for(let e=0;e<this.luminanceDownSamplePostProcesses.length;e++)this.luminanceDownSamplePostProcesses[e].dispose(t);this.luminancePostProcess&&this.luminancePostProcess.dispose(t),this.hdrPostProcess&&this.hdrPostProcess.dispose(t),this.hdrFinalPostProcess&&this.hdrFinalPostProcess.dispose(t),this.depthOfFieldPostProcess&&this.depthOfFieldPostProcess.dispose(t),this.motionBlurPostProcess&&this.motionBlurPostProcess.dispose(t),this.fxaaPostProcess&&this.fxaaPostProcess.dispose(t);for(let e=0;e<this.blurHPostProcesses.length;e++)this.blurHPostProcesses[e].dispose(t);for(let e=0;e<this.blurVPostProcesses.length;e++)this.blurVPostProcesses[e].dispose(t)}this.originalPostProcess=null,this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.luminancePostProcess=null,this.hdrPostProcess=null,this.hdrFinalPostProcess=null,this.depthOfFieldPostProcess=null,this.motionBlurPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.luminanceDownSamplePostProcesses.length=0,this.blurHPostProcesses.length=0,this.blurVPostProcesses.length=0}dispose(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}serialize(){const e=Ue.p.Serialize(this);return this.sourceLight&&(e.sourceLightId=this.sourceLight.id),this.screenSpaceReflectionPostProcess&&(e.screenSpaceReflectionPostProcess=Ue.p.Serialize(this.screenSpaceReflectionPostProcess)),e.customType="StandardRenderingPipeline",e}static Parse(e,t,i){const r=Ue.p.Parse((()=>new vI(e._name,t,e._ratio)),e,t,i);return e.sourceLightId&&(r.sourceLight=t.getLightById(e.sourceLightId)),e.screenSpaceReflectionPostProcess&&Ue.p.Parse((()=>r.screenSpaceReflectionPostProcess),e.screenSpaceReflectionPostProcess,t,i),r}}vI.LuminanceSteps=6,(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"brightThreshold",void 0),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"blurWidth",void 0),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"horizontalBlur",void 0),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"exposure",null),(0,Ge.Cg)([(0,ze.uM)("lensTexture")],vI.prototype,"lensTexture",void 0),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"volumetricLightCoefficient",void 0),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"volumetricLightPower",void 0),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"volumetricLightBlurScale",void 0),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"hdrMinimumLuminance",void 0),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"hdrDecreaseRate",void 0),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"hdrIncreaseRate",void 0),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"hdrAutoExposure",null),(0,Ge.Cg)([(0,ze.uM)("lensColorTexture")],vI.prototype,"lensColorTexture",void 0),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"lensFlareStrength",void 0),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"lensFlareGhostDispersal",void 0),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"lensFlareHaloWidth",void 0),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"lensFlareDistortionStrength",void 0),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"lensFlareBlurWidth",void 0),(0,Ge.Cg)([(0,ze.uM)("lensStarTexture")],vI.prototype,"lensStarTexture",void 0),(0,Ge.Cg)([(0,ze.uM)("lensFlareDirtTexture")],vI.prototype,"lensFlareDirtTexture",void 0),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"depthOfFieldDistance",void 0),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"depthOfFieldBlurWidth",void 0),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"motionStrength",null),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"objectBasedMotionBlur",null),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"_ratio",void 0),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"BloomEnabled",null),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"DepthOfFieldEnabled",null),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"LensFlareEnabled",null),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"HDREnabled",null),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"VLSEnabled",null),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"MotionBlurEnabled",null),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"fxaaEnabled",null),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"screenSpaceReflectionsEnabled",null),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"volumetricLightStepsCount",null),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"motionBlurSamples",null),(0,Ge.Cg)([(0,ze.lK)()],vI.prototype,"samples",null),(0,a.Y5)("BABYLON.StandardRenderingPipeline",vI);class SI{constructor(e=!1){this.enabled=!1,this.name="screenSpaceReflections2",this.texturesRequired=[6,3],this.texturesRequired.push(e?10:5)}}class bI extends QA{set samples(e){this._samples!==e&&(this._samples=e,this._ssrPostProcess&&(this._ssrPostProcess.samples=this.samples))}get samples(){return this._samples}get maxDistance(){return this._thinSSRRenderingPipeline.maxDistance}set maxDistance(e){this._thinSSRRenderingPipeline.maxDistance=e}get step(){return this._thinSSRRenderingPipeline.step}set step(e){this._thinSSRRenderingPipeline.step=e}get thickness(){return this._thinSSRRenderingPipeline.thickness}set thickness(e){this._thinSSRRenderingPipeline.thickness=e}get strength(){return this._thinSSRRenderingPipeline.strength}set strength(e){this._thinSSRRenderingPipeline.strength=e}get reflectionSpecularFalloffExponent(){return this._thinSSRRenderingPipeline.reflectionSpecularFalloffExponent}set reflectionSpecularFalloffExponent(e){this._thinSSRRenderingPipeline.reflectionSpecularFalloffExponent=e}get maxSteps(){return this._thinSSRRenderingPipeline.maxSteps}set maxSteps(e){this._thinSSRRenderingPipeline.maxSteps=e}get roughnessFactor(){return this._thinSSRRenderingPipeline.roughnessFactor}set roughnessFactor(e){this._thinSSRRenderingPipeline.roughnessFactor=e}get selfCollisionNumSkip(){return this._thinSSRRenderingPipeline.selfCollisionNumSkip}set selfCollisionNumSkip(e){this._thinSSRRenderingPipeline.selfCollisionNumSkip=e}get reflectivityThreshold(){return this._thinSSRRenderingPipeline.reflectivityThreshold}set reflectivityThreshold(e){const t=this.reflectivityThreshold;e!==t&&(this._thinSSRRenderingPipeline.reflectivityThreshold=e,(0===e&&0!==t||0!==e&&0===t)&&this._buildPipeline())}get ssrDownsample(){return this._thinSSRRenderingPipeline.ssrDownsample}set ssrDownsample(e){this._thinSSRRenderingPipeline.ssrDownsample=e,this._buildPipeline()}get blurDispersionStrength(){return this._thinSSRRenderingPipeline.blurDispersionStrength}set blurDispersionStrength(e){const t=this.blurDispersionStrength;e!==t&&(this._thinSSRRenderingPipeline.blurDispersionStrength=e,(0===e&&0!==t||0!==e&&0===t)&&this._buildPipeline())}_useBlur(){return this.blurDispersionStrength>0}get blurDownsample(){return this._thinSSRRenderingPipeline.blurDownsample}set blurDownsample(e){this._thinSSRRenderingPipeline.blurDownsample=e,this._buildPipeline()}get enableSmoothReflections(){return this._thinSSRRenderingPipeline.enableSmoothReflections}set enableSmoothReflections(e){this._thinSSRRenderingPipeline.enableSmoothReflections=e}get _useScreenspaceDepth(){return this._thinSSRRenderingPipeline.useScreenspaceDepth}get environmentTexture(){return this._thinSSRRenderingPipeline.environmentTexture}set environmentTexture(e){this._thinSSRRenderingPipeline.environmentTexture=e}get environmentTextureIsProbe(){return this._thinSSRRenderingPipeline.environmentTextureIsProbe}set environmentTextureIsProbe(e){this._thinSSRRenderingPipeline.environmentTextureIsProbe=e}get attenuateScreenBorders(){return this._thinSSRRenderingPipeline.attenuateScreenBorders}set attenuateScreenBorders(e){this._thinSSRRenderingPipeline.attenuateScreenBorders=e}get attenuateIntersectionDistance(){return this._thinSSRRenderingPipeline.attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._thinSSRRenderingPipeline.attenuateIntersectionDistance=e}get attenuateIntersectionIterations(){return this._thinSSRRenderingPipeline.attenuateIntersectionIterations}set attenuateIntersectionIterations(e){this._thinSSRRenderingPipeline.attenuateIntersectionIterations=e}get attenuateFacingCamera(){return this._thinSSRRenderingPipeline.attenuateFacingCamera}set attenuateFacingCamera(e){this._thinSSRRenderingPipeline.attenuateFacingCamera=e}get attenuateBackfaceReflection(){return this._thinSSRRenderingPipeline.attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._thinSSRRenderingPipeline.attenuateBackfaceReflection=e}get clipToFrustum(){return this._thinSSRRenderingPipeline.clipToFrustum}set clipToFrustum(e){this._thinSSRRenderingPipeline.clipToFrustum=e}get useFresnel(){return this._thinSSRRenderingPipeline.useFresnel}set useFresnel(e){this._thinSSRRenderingPipeline.useFresnel=e,this._buildPipeline()}get enableAutomaticThicknessComputation(){return this._thinSSRRenderingPipeline.enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._thinSSRRenderingPipeline.enableAutomaticThicknessComputation=e,this._buildPipeline()}get backfaceDepthRenderer(){return this._depthRenderer}get backfaceDepthTextureDownsample(){return this._backfaceDepthTextureDownsample}set backfaceDepthTextureDownsample(e){this._backfaceDepthTextureDownsample!==e&&(this._backfaceDepthTextureDownsample=e,this._resizeDepthRenderer())}get backfaceForceDepthWriteTransparentMeshes(){return this._backfaceForceDepthWriteTransparentMeshes}set backfaceForceDepthWriteTransparentMeshes(e){this._backfaceForceDepthWriteTransparentMeshes!==e&&(this._backfaceForceDepthWriteTransparentMeshes=e,this._depthRenderer&&(this._depthRenderer.forceDepthWriteTransparentMeshes=e))}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,e?e&&(this._isDirty?this._buildPipeline():null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)):null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()))}get inputTextureColorIsInGammaSpace(){return this._thinSSRRenderingPipeline.inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._thinSSRRenderingPipeline.inputTextureColorIsInGammaSpace=e,this._buildPipeline()}get generateOutputInGammaSpace(){return this._thinSSRRenderingPipeline.generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._thinSSRRenderingPipeline.generateOutputInGammaSpace=e,this._buildPipeline()}get debug(){return this._thinSSRRenderingPipeline.debug}set debug(e){this._thinSSRRenderingPipeline.debug=e,this._buildPipeline()}getScene(){return this._scene}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}get scene(){return this._scene}get isSupported(){const e=this._scene.getEngine().getCaps();return e.drawBuffersExtension&&e.texelFetch}constructor(e,t,i,r=!1,s=0,n=!1){if(super(t.getEngine(),e),this.SSRRenderEffect="SSRRenderEffect",this.SSRBlurRenderEffect="SSRBlurRenderEffect",this.SSRCombineRenderEffect="SSRCombineRenderEffect",this._samples=1,this._backfaceDepthTextureDownsample=0,this._backfaceForceDepthWriteTransparentMeshes=!0,this._isEnabled=!0,this._forceGeometryBuffer=!1,this._isDirty=!1,this._camerasToBeAttached=[],this._thinSSRRenderingPipeline=new Jc(e,t),this._thinSSRRenderingPipeline.isSSRSupported=!1,this._thinSSRRenderingPipeline.useScreenspaceDepth=n,this._cameras=i||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._textureType=s,this._forceGeometryBuffer=r,this.isSupported){if(this._createSSRPostProcess(),t.postProcessRenderPipelineManager.addPipeline(this),this._forceGeometryBuffer){const e=t.enableGeometryBufferRenderer();e&&(e.enableReflectivity=!0,e.useSpecificClearForDepthTexture=!0,e.enableScreenspaceDepth=this._useScreenspaceDepth,e.enableDepth=!this._useScreenspaceDepth)}else{const e=t.enablePrePassRenderer();e&&(e.useSpecificClearForDepthTexture=!0,e.markAsDirty())}this._thinSSRRenderingPipeline.isSSRSupported=!!this._geometryBufferRenderer||!!this._prePassRenderer,this._buildPipeline()}}getClassName(){return"SSRRenderingPipeline"}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(e=!1){this._disposeDepthRenderer(),this._disposeSSRPostProcess(),this._disposeBlurPostProcesses(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._thinSSRRenderingPipeline.dispose(),super.dispose()}_getTextureSize(){const e=this._scene.getEngine(),t=this._prePassRenderer;let i={width:e.getRenderWidth(),height:e.getRenderHeight()};if(t&&this._scene.activeCamera?._getFirstPostProcess()===this._ssrPostProcess){const e=t.getRenderTarget();e&&e.textures&&(i=e.textures[t.getIndex(4)].getSize())}else this._ssrPostProcess?.inputTexture&&(i.width=this._ssrPostProcess.inputTexture.width,i.height=this._ssrPostProcess.inputTexture.height);return i}_buildPipeline(){if(!this.isSupported)return;if(!this._isEnabled)return void(this._isDirty=!0);this._isDirty=!1;const e=this._scene.getEngine();if(this._disposeDepthRenderer(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice(),this._cameras.length>0&&(this._thinSSRRenderingPipeline.camera=this._cameras[0])),this._reset(),this._thinSSRRenderingPipeline.normalsAreInWorldSpace=!!(this._geometryBufferRenderer?.generateNormalsInWorldSpace??this._prePassRenderer?.generateNormalsInWorldSpace),this.enableAutomaticThicknessComputation){const e=this._cameras?.[0];e&&(this._depthRendererCamera=e,this._depthRenderer=new Dh(this._scene,void 0,void 0,this._useScreenspaceDepth,1,!this._useScreenspaceDepth,"SSRBackDepth"),this._useScreenspaceDepth||(this._depthRenderer.clearColor.r=1e8),this._depthRenderer.reverseCulling=!0,this._depthRenderer.forceDepthWriteTransparentMeshes=this.backfaceForceDepthWriteTransparentMeshes,this._resizeDepthRenderer(),e.customRenderTargets.push(this._depthRenderer.getDepthMap()))}this.addEffect(new PA(e,this.SSRRenderEffect,(()=>this._ssrPostProcess),!0)),this._disposeBlurPostProcesses(),this._useBlur()&&(this._createBlurAndCombinerPostProcesses(),this.addEffect(new PA(e,this.SSRBlurRenderEffect,(()=>[this._blurPostProcessX,this._blurPostProcessY]),!0)),this.addEffect(new PA(e,this.SSRCombineRenderEffect,(()=>this._blurCombinerPostProcess),!0))),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}_resizeDepthRenderer(){if(!this._depthRenderer)return;const e=this._getTextureSize(),t=this._depthRenderer.getDepthMap().getSize(),i=Math.floor(e.width/(this.backfaceDepthTextureDownsample+1)),r=Math.floor(e.height/(this.backfaceDepthTextureDownsample+1));t.width===i&&t.height===r||this._depthRenderer.getDepthMap().resize({width:i,height:r})}_disposeDepthRenderer(){if(this._depthRenderer){if(this._depthRendererCamera){const e=this._depthRendererCamera.customRenderTargets.indexOf(this._depthRenderer.getDepthMap())??-1;-1!==e&&this._depthRendererCamera.customRenderTargets.splice(e,1)}this._depthRendererCamera=null,this._depthRenderer.getDepthMap().dispose()}this._depthRenderer=null}_disposeBlurPostProcesses(){for(let e=0;e<this._cameras.length;e++){const t=this._cameras[e];this._blurPostProcessX?.dispose(t),this._blurPostProcessY?.dispose(t),this._blurCombinerPostProcess?.dispose(t)}this._blurPostProcessX=null,this._blurPostProcessY=null,this._blurCombinerPostProcess=null}_disposeSSRPostProcess(){for(let e=0;e<this._cameras.length;e++){const t=this._cameras[e];this._ssrPostProcess?.dispose(t)}this._ssrPostProcess=null}_createSSRPostProcess(){this._ssrPostProcess=new Fi.w("ssr",Zc.FragmentUrl,{uniformNames:Zc.Uniforms,samplerNames:Zc.Samplers,size:1,samplingMode:2,engine:this._scene.getEngine(),textureType:this._textureType,effectWrapper:this._thinSSRRenderingPipeline._ssrPostProcess}),this._ssrPostProcess.onApply=e=>{this._resizeDepthRenderer();const t=this._geometryBufferRenderer,i=this._prePassRenderer;if(!i&&!t)return;if(t){const i=t.getTextureIndex(UA.REFLECTIVITY_TEXTURE_TYPE),r=t.getTextureIndex(UA.NORMAL_TEXTURE_TYPE);if(e.setTexture("normalSampler",t.getGBuffer().textures[r]),e.setTexture("reflectivitySampler",t.getGBuffer().textures[i]),this._useScreenspaceDepth){const i=t.getTextureIndex(UA.SCREENSPACE_DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",t.getGBuffer().textures[i])}else{const i=t.getTextureIndex(UA.DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",t.getGBuffer().textures[i])}}else if(i){const t=i.getIndex(this._useScreenspaceDepth?10:5),r=i.getIndex(3),s=i.getIndex(6);e.setTexture("normalSampler",i.getRenderTarget().textures[s]),e.setTexture("depthSampler",i.getRenderTarget().textures[t]),e.setTexture("reflectivitySampler",i.getRenderTarget().textures[r])}this.enableAutomaticThicknessComputation&&this._depthRenderer&&(e.setTexture("backDepthSampler",this._depthRenderer.getDepthMap()),e.setFloat("backSizeFactor",this.backfaceDepthTextureDownsample+1));const r=this._getTextureSize();this._thinSSRRenderingPipeline._ssrPostProcess.textureWidth=r.width,this._thinSSRRenderingPipeline._ssrPostProcess.textureHeight=r.height},this._ssrPostProcess.samples=this.samples,this._forceGeometryBuffer||(this._ssrPostProcess._prePassEffectConfiguration=new SI(this._useScreenspaceDepth))}_createBlurAndCombinerPostProcesses(){const e=this._scene.getEngine();this._blurPostProcessX=new Fi.w("SSRblurX",Qc.FragmentUrl,{uniformNames:Qc.Uniforms,samplerNames:Qc.Samplers,size:1/(this.ssrDownsample+1),samplingMode:2,engine:e,textureType:this._textureType,effectWrapper:this._thinSSRRenderingPipeline._ssrBlurXPostProcess}),this._blurPostProcessX.autoClear=!1,this._blurPostProcessX.onApplyObservable.add((()=>{this._thinSSRRenderingPipeline._ssrBlurXPostProcess.textureWidth=this._blurPostProcessX?.inputTexture.width??this._scene.getEngine().getRenderWidth(),this._thinSSRRenderingPipeline._ssrBlurXPostProcess.textureHeight=1})),this._blurPostProcessY=new Fi.w("SSRblurY",Qc.FragmentUrl,{uniformNames:Qc.Uniforms,samplerNames:Qc.Samplers,size:1/(this.blurDownsample+1),samplingMode:2,engine:e,textureType:this._textureType,effectWrapper:this._thinSSRRenderingPipeline._ssrBlurYPostProcess}),this._blurPostProcessY.autoClear=!1,this._blurPostProcessY.onApplyObservable.add((()=>{this._thinSSRRenderingPipeline._ssrBlurYPostProcess.textureWidth=1,this._thinSSRRenderingPipeline._ssrBlurYPostProcess.textureHeight=this._blurPostProcessY?.inputTexture.height??this._scene.getEngine().getRenderHeight()})),this._blurCombinerPostProcess=new Fi.w("SSRblurCombiner",Kc.FragmentUrl,{uniformNames:Kc.Uniforms,samplerNames:Kc.Samplers,size:1/(this.blurDownsample+1),samplingMode:1,engine:e,textureType:this._textureType,effectWrapper:this._thinSSRRenderingPipeline._ssrBlurCombinerPostProcess}),this._blurCombinerPostProcess.autoClear=!1,this._blurCombinerPostProcess.onApplyObservable.add((e=>{const t=this._geometryBufferRenderer,i=this._prePassRenderer;if(i||t){if(i&&this._scene.activeCamera?._getFirstPostProcess()===this._ssrPostProcess){const t=i.getRenderTarget();t&&t.textures&&e.setTexture("mainSampler",t.textures[i.getIndex(4)])}else e.setTextureFromPostProcess("mainSampler",this._ssrPostProcess);if(t){const i=t.getTextureIndex(UA.REFLECTIVITY_TEXTURE_TYPE);if(e.setTexture("reflectivitySampler",t.getGBuffer().textures[i]),this.useFresnel)if(e.setTexture("normalSampler",t.getGBuffer().textures[1]),this._useScreenspaceDepth){const i=t.getTextureIndex(UA.SCREENSPACE_DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",t.getGBuffer().textures[i])}else e.setTexture("depthSampler",t.getGBuffer().textures[0])}else if(i){const t=i.getIndex(3);if(e.setTexture("reflectivitySampler",i.getRenderTarget().textures[t]),this.useFresnel){const t=i.getIndex(this._useScreenspaceDepth?10:5),r=i.getIndex(6);e.setTexture("normalSampler",i.getRenderTarget().textures[r]),e.setTexture("depthSampler",i.getRenderTarget().textures[t])}}}}))}serialize(){const e=Ue.p.Serialize(this);return e.customType="SSRRenderingPipeline",e}static Parse(e,t,i){return Ue.p.Parse((()=>new bI(e._name,t,e._ratio)),e,t,i)}}(0,Ge.Cg)([(0,ze.lK)()],bI.prototype,"samples",null),(0,Ge.Cg)([(0,ze.lK)()],bI.prototype,"maxDistance",null),(0,Ge.Cg)([(0,ze.lK)()],bI.prototype,"step",null),(0,Ge.Cg)([(0,ze.lK)()],bI.prototype,"thickness",null),(0,Ge.Cg)([(0,ze.lK)()],bI.prototype,"strength",null),(0,Ge.Cg)([(0,ze.lK)()],bI.prototype,"reflectionSpecularFalloffExponent",null),(0,Ge.Cg)([(0,ze.lK)()],bI.prototype,"maxSteps",null),(0,Ge.Cg)([(0,ze.lK)()],bI.prototype,"roughnessFactor",null),(0,Ge.Cg)([(0,ze.lK)()],bI.prototype,"selfCollisionNumSkip",null),(0,Ge.Cg)([(0,ze.lK)()],bI.prototype,"reflectivityThreshold",null),(0,Ge.Cg)([(0,ze.lK)()],bI.prototype,"ssrDownsample",null),(0,Ge.Cg)([(0,ze.lK)("blurDispersionStrength")],bI.prototype,"blurDispersionStrength",null),(0,Ge.Cg)([(0,ze.lK)("blurDownsample")],bI.prototype,"blurDownsample",null),(0,Ge.Cg)([(0,ze.lK)("enableSmoothReflections")],bI.prototype,"enableSmoothReflections",null),(0,Ge.Cg)([(0,ze.lK)("environmentTexture")],bI.prototype,"environmentTexture",null),(0,Ge.Cg)([(0,ze.lK)("environmentTextureIsProbe")],bI.prototype,"environmentTextureIsProbe",null),(0,Ge.Cg)([(0,ze.lK)("attenuateScreenBorders")],bI.prototype,"attenuateScreenBorders",null),(0,Ge.Cg)([(0,ze.lK)("attenuateIntersectionDistance")],bI.prototype,"attenuateIntersectionDistance",null),(0,Ge.Cg)([(0,ze.lK)("attenuateIntersectionIterations")],bI.prototype,"attenuateIntersectionIterations",null),(0,Ge.Cg)([(0,ze.lK)("attenuateFacingCamera")],bI.prototype,"attenuateFacingCamera",null),(0,Ge.Cg)([(0,ze.lK)("attenuateBackfaceReflection")],bI.prototype,"attenuateBackfaceReflection",null),(0,Ge.Cg)([(0,ze.lK)("clipToFrustum")],bI.prototype,"clipToFrustum",null),(0,Ge.Cg)([(0,ze.lK)("useFresnel")],bI.prototype,"useFresnel",null),(0,Ge.Cg)([(0,ze.lK)("enableAutomaticThicknessComputation")],bI.prototype,"enableAutomaticThicknessComputation",null),(0,Ge.Cg)([(0,ze.lK)("backfaceDepthTextureDownsample")],bI.prototype,"_backfaceDepthTextureDownsample",void 0),(0,Ge.Cg)([(0,ze.lK)("backfaceForceDepthWriteTransparentMeshes")],bI.prototype,"_backfaceForceDepthWriteTransparentMeshes",void 0),(0,Ge.Cg)([(0,ze.lK)("isEnabled")],bI.prototype,"_isEnabled",void 0),(0,Ge.Cg)([(0,ze.lK)("inputTextureColorIsInGammaSpace")],bI.prototype,"inputTextureColorIsInGammaSpace",null),(0,Ge.Cg)([(0,ze.lK)("generateOutputInGammaSpace")],bI.prototype,"generateOutputInGammaSpace",null),(0,Ge.Cg)([(0,ze.lK)("debug")],bI.prototype,"debug",null),(0,a.Y5)("BABYLON.SSRRenderingPipeline",bI);class yI extends QA{set samples(e){this._taaThinPostProcess.samples=e}get samples(){return this._taaThinPostProcess.samples}set msaaSamples(e){this._msaaSamples!==e&&(this._msaaSamples=e,this._taaPostProcess&&(this._taaPostProcess.samples=e))}get msaaSamples(){return this._msaaSamples}get factor(){return this._taaThinPostProcess.factor}set factor(e){this._taaThinPostProcess.factor=e}get disableOnCameraMove(){return this._taaThinPostProcess.disableOnCameraMove}set disableOnCameraMove(e){this._taaThinPostProcess.disableOnCameraMove=e}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,e?e&&(this._isDirty?this._buildPipeline():null!==this._cameras&&(this._taaThinPostProcess._reset(),this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras))):null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()))}get scene(){return this._scene}get isSupported(){return this._scene.getEngine().getCaps().texelFetch}constructor(e,t,i,r=0){const s=t.getEngine();super(s,e),this.TAARenderEffect="TAARenderEffect",this.TAAPassEffect="TAAPassEffect",this._msaaSamples=1,this._isEnabled=!0,this._isDirty=!1,this._camerasToBeAttached=[],this._pingpong=0,this._cameras=i||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._textureType=r,this._taaThinPostProcess=new mu("TAA",this._scene.getEngine()),this.isSupported&&(this._createPingPongTextures(s.getRenderWidth(),s.getRenderHeight()),t.postProcessRenderPipelineManager.addPipeline(this),this._buildPipeline())}getClassName(){return"TAARenderingPipeline"}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._ping.dispose(),this._pong.dispose(),super.dispose()}_createPingPongTextures(e,t){const i=this._scene.getEngine();this._ping?.dispose(),this._pong?.dispose(),this._ping=i.createRenderTargetTexture({width:e,height:t},{generateMipMaps:!1,generateDepthBuffer:!1,type:2,samplingMode:1}),this._pong=i.createRenderTargetTexture({width:e,height:t},{generateMipMaps:!1,generateDepthBuffer:!1,type:2,samplingMode:1}),this._taaThinPostProcess.textureWidth=e,this._taaThinPostProcess.textureHeight=t}_buildPipeline(){if(!this.isSupported)return;if(!this._isEnabled)return void(this._isDirty=!0);this._isDirty=!1;const e=this._scene.getEngine();this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._createTAAPostProcess(),this.addEffect(new PA(e,this.TAARenderEffect,(()=>this._taaPostProcess),!0)),this._createPassPostProcess(),this.addEffect(new PA(e,this.TAAPassEffect,(()=>this._passPostProcess),!0)),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){const t=this._cameras[e];this._taaPostProcess?.dispose(t),this._passPostProcess?.dispose(t),t.getProjectionMatrix(!0)}this._taaPostProcess=null,this._passPostProcess=null}_createTAAPostProcess(){this._taaPostProcess=new Fi.w("TAA","taa",{uniforms:["factor"],samplers:["historySampler"],size:1,engine:this._scene.getEngine(),textureType:this._textureType,effectWrapper:this._taaThinPostProcess}),this._taaPostProcess.samples=this._msaaSamples,this._taaPostProcess.onActivateObservable.add((()=>{if(this._taaThinPostProcess.camera=this._scene.activeCamera,this._taaPostProcess?.width!==this._ping.width||this._taaPostProcess?.height!==this._ping.height){const e=this._scene.getEngine();this._createPingPongTextures(e.getRenderWidth(),e.getRenderHeight())}this._taaThinPostProcess.updateProjectionMatrix(),this._passPostProcess&&(this._passPostProcess.inputTexture=this._pingpong?this._ping:this._pong),this._pingpong=1^this._pingpong})),this._taaPostProcess.onApplyObservable.add((e=>{e._bindTexture("historySampler",this._pingpong?this._ping.texture:this._pong.texture)}))}_createPassPostProcess(){const e=this._scene.getEngine();this._passPostProcess=new wi.v("TAAPass",1,null,1,e),this._passPostProcess.inputTexture=this._ping,this._passPostProcess.autoClear=!1}serialize(){const e=Ue.p.Serialize(this);return e.customType="TAARenderingPipeline",e}static Parse(e,t,i){return Ue.p.Parse((()=>new yI(e._name,t,e._ratio)),e,t,i)}}(0,Ge.Cg)([(0,ze.lK)("samples")],yI.prototype,"samples",null),(0,Ge.Cg)([(0,ze.lK)("msaaSamples")],yI.prototype,"_msaaSamples",void 0),(0,Ge.Cg)([(0,ze.lK)()],yI.prototype,"factor",null),(0,Ge.Cg)([(0,ze.lK)()],yI.prototype,"disableOnCameraMove",null),(0,Ge.Cg)([(0,ze.lK)("isEnabled")],yI.prototype,"_isEnabled",void 0),(0,a.Y5)("BABYLON.TAARenderingPipeline",yI);var PI,TI=i(85363),CI=i(45076),EI=i(68217),AI=i(94354),II=i(68133),RI=i(17406),MI=i(85423),DI=i(66584),OI=i(44143);i(71405),i(37706);!function(e){e[e.Hable=0]="Hable",e[e.Reinhard=1]="Reinhard",e[e.HejiDawson=2]="HejiDawson",e[e.Photographic=3]="Photographic"}(PI||(PI={}));class NI extends Fi.w{getClassName(){return"TonemapPostProcess"}constructor(e,t,i,r,s=2,n,o=0,a){super(e,"tonemap",["_ExposureAdjustment"],null,1,r,s,n,a,null,o),this._operator=t,this.exposureAdjustment=i;let l="#define ";0===this._operator?l+="HABLE_TONEMAPPING":1===this._operator?l+="REINHARD_TONEMAPPING":2===this._operator?l+="OPTIMIZED_HEJIDAWSON_TONEMAPPING":3===this._operator&&(l+="PHOTOGRAPHIC_TONEMAPPING"),this.updateEffect(l),this.onApply=e=>{e.setFloat("_ExposureAdjustment",this.exposureAdjustment)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,18))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,17985))])),super._gatherImports(e,t)}}const wI="volumetricLightScatteringPixelShader",FI="uniform sampler2D textureSampler;uniform sampler2D lightScatteringSampler;uniform float decay;uniform float exposure;uniform float weight;uniform float density;uniform vec2 meshPositionOnScreen;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec2 tc=vUV;vec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);deltaTexCoord*=1.0/float(NUM_SAMPLES)*density;float illuminationDecay=1.0;vec4 color=texture2D(lightScatteringSampler,tc)*0.4;for(int i=0; i<NUM_SAMPLES; i++) {tc-=deltaTexCoord;vec4 dataSample=texture2D(lightScatteringSampler,tc)*0.4;dataSample*=illuminationDecay*weight;color+=dataSample;illuminationDecay*=decay;}\nvec4 realColor=texture2D(textureSampler,vUV);gl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),realColor.a))+(realColor*(1.5-0.4)));\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";qi.l.ShadersStore[wI]=FI;i(18959),i(1218),i(3298),i(65523);const BI="volumetricLightScatteringPassVertexShader",VI="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\nuniform mat4 viewProjection;uniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#if (defined(ALPHATEST) || defined(NEED_UV)) && defined(UV1)\nvec2 uvUpdated=uv;\n#endif\n#if (defined(ALPHATEST) || defined(NEED_UV)) && defined(UV2)\nvec2 uv2Updated=uv2;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#endif\n}\n";qi.l.ShadersStore[BI]=VI;const LI="volumetricLightScatteringPassPixelShader",kI="#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\n#endif\n#if defined(ALPHATEST)\nuniform sampler2D diffuseSampler;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#if defined(ALPHATEST)\nvec4 diffuseColor=texture2D(diffuseSampler,vUV);if (diffuseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);}\n";qi.l.ShadersStore[LI]=kI;class GI extends Fi.w{get useDiffuseColor(){return m.V.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1}set useDiffuseColor(e){m.V.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")}constructor(e,t,i,r,s=100,o=$e.g.BILINEAR_SAMPLINGMODE,a,l,h){super(e,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],t.postProcessRatio||t,i,o,a,l,"#define NUM_SAMPLES "+s),this._screenCoordinates=n.I9.Zero(),this.customMeshPosition=n.Pq.Zero(),this.useCustomMeshPosition=!1,this.invert=!0,this.excludedMeshes=[],this.includedMeshes=[],this.exposure=.3,this.decay=.96815,this.weight=.58767,this.density=.926,a=(h=i?.getScene()??h??this._scene).getEngine(),this._viewPort=new $i.L(0,0,1,1).toGlobal(a.getRenderWidth(),a.getRenderHeight()),this.mesh=r??GI.CreateDefaultMesh("VolumetricLightScatteringMesh",h),this._createPass(h,t.passRatio||t),this.onActivate=e=>{this.isSupported||this.dispose(e),this.onActivate=null},this.onApplyObservable.add((e=>{this._updateMeshScreenCoordinates(h),e.setTexture("lightScatteringSampler",this._volumetricLightScatteringRTT),e.setFloat("exposure",this.exposure),e.setFloat("decay",this.decay),e.setFloat("weight",this.weight),e.setFloat("density",this.density),e.setVector2("meshPositionOnScreen",this._screenCoordinates)}))}getClassName(){return"VolumetricLightScatteringPostProcess"}_isReady(e,t){const i=e.getMesh();if(i===this.mesh&&i.material)return i.material.isReady(i);const r=i._internalAbstractMeshDataInfo._materialForRenderPass?.[this._scene.getEngine().currentRenderPassId];if(r)return r.isReadyForSubMesh(i,e,t);const s=[],n=[Ot.R.PositionKind],o=e.getMaterial();let a=!1,l=!1;if(o){const e=o.needAlphaTestingForMesh(i);e&&s.push("#define ALPHATEST"),i.isVerticesDataPresent(Ot.R.UVKind)&&(n.push(Ot.R.UVKind),s.push("#define UV1"),a=e),i.isVerticesDataPresent(Ot.R.UV2Kind)&&(n.push(Ot.R.UV2Kind),s.push("#define UV2"),l=e)}const h=new Qr.J;if(i.useBones&&i.computeBonesUsingShaders&&i.skeleton){n.push(Ot.R.MatricesIndicesKind),n.push(Ot.R.MatricesWeightsKind),i.numBoneInfluencers>4&&(n.push(Ot.R.MatricesIndicesExtraKind),n.push(Ot.R.MatricesWeightsExtraKind)),s.push("#define NUM_BONE_INFLUENCERS "+i.numBoneInfluencers),i.numBoneInfluencers>0&&h.addCPUSkinningFallback(0,i);const e=i.skeleton;e.isUsingTextureForMatrices?s.push("#define BONETEXTURE"):s.push("#define BonesPerMesh "+(e.bones.length+1))}else s.push("#define NUM_BONE_INFLUENCERS 0");const c=i.morphTargetManager?(0,ts.Dk)(i.morphTargetManager,s,n,i,!0,!1,!1,a,l,!1):0;t&&(s.push("#define INSTANCES"),(0,ts.te)(n),e.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES"));const u=i.bakedVertexAnimationManager;u&&u.isEnabled&&(s.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&n.push("bakedVertexAnimationSettingsInstanced"));const d=e._getDrawWrapper(void 0,!0),p=d.defines,m=s.join("\n");if(p!==m){const e=["world","mBones","boneTextureWidth","viewProjection","diffuseMatrix","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],t=["diffuseSampler","morphTargets","boneSampler","bakedVertexAnimationTexture"];d.setEffect(i.getScene().getEngine().createEffect("volumetricLightScatteringPass",{attributes:n,uniformsNames:e,uniformBuffersNames:[],samplers:t,defines:m,fallbacks:h,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:c}},i.getScene().getEngine()),m)}return d.effect.isReady()}setCustomMeshPosition(e){this.customMeshPosition=e}getCustomMeshPosition(){return this.customMeshPosition}dispose(e){const t=e.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);-1!==t&&e.getScene().customRenderTargets.splice(t,1),this._volumetricLightScatteringRTT.dispose(),super.dispose(e)}getPass(){return this._volumetricLightScatteringRTT}_meshExcluded(e){return this.includedMeshes.length>0&&-1===this.includedMeshes.indexOf(e)||this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e)}_createPass(e,t){const i=e.getEngine();this._volumetricLightScatteringRTT=new cr.$("volumetricLightScatteringMap",{width:i.getRenderWidth()*t,height:i.getRenderHeight()*t},e,!1,!0,0),this._volumetricLightScatteringRTT.wrapU=$e.g.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=$e.g.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,this._volumetricLightScatteringRTT.ignoreCameraViewport=!0;const r=this.getCamera();r?r.customRenderTargets.push(this._volumetricLightScatteringRTT):e.customRenderTargets.push(this._volumetricLightScatteringRTT);const s=e=>{const t=e.getRenderingMesh(),i=e.getEffectiveMesh();if(this._meshExcluded(t))return;i._internalAbstractMeshDataInfo._isActiveIntermediate=!1;const r=e.getMaterial();if(!r)return;const s=t.getScene(),n=s.getEngine();n.setState(r.backFaceCulling,void 0,void 0,void 0,r.cullBackFaces);const o=t._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(o.mustReturn)return;const a=n.getCaps().instancedArrays&&(null!==o.visibleInstances[e._id]||t.hasThinInstances);if(this._isReady(e,a)){const l=i._internalAbstractMeshDataInfo._materialForRenderPass?.[n.currentRenderPassId];let h=e._getDrawWrapper();if(t!==this.mesh||h||(h=r._getDrawWrapper()),!h)return;const c=h.effect;if(n.enableEffect(h),a||t._bind(e,c,r.fillMode),t===this.mesh)r.bind(i.getWorldMatrix(),t);else if(l)l.bindForSubMesh(i.getWorldMatrix(),i,e);else{if(c.setMatrix("viewProjection",s.getTransformMatrix()),r.needAlphaTestingForMesh(i)){const e=r.getAlphaTestTexture();e&&(c.setTexture("diffuseSampler",e),c.setMatrix("diffuseMatrix",e.getTextureMatrix()))}(0,ts.f$)(t,c),(0,ts.nR)(t,c),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(c);const n=e.getMesh().bakedVertexAnimationManager;n&&n.isEnabled&&n.bind(c,a)}a&&t.hasThinInstances&&c.setMatrix("world",i.getWorldMatrix()),t._processRendering(i,e,c,fn.i.TriangleFillMode,o,a,((e,t)=>{e||c.setMatrix("world",t)}))}};let n;const a=new o.ov(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add((()=>{n=e.clearColor,e.clearColor=a})),this._volumetricLightScatteringRTT.onAfterRenderObservable.add((()=>{e.clearColor=n})),this._volumetricLightScatteringRTT.customIsReadyFunction=(e,t,r)=>{if((r||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){const r=e.subMeshes[t],s=r.getMaterial(),n=r.getRenderingMesh();if(!s)continue;const o=n._getInstancesRenderList(r._id,!!r.getReplacementMesh()),a=i.getCaps().instancedArrays&&(null!==o.visibleInstances[r._id]||n.hasThinInstances);if(!this._isReady(r,a))return!1}return!0},this._volumetricLightScatteringRTT.customRenderFunction=(t,i,r,n)=>{const o=e.getEngine();let a;if(n.length){for(o.setColorWrite(!1),a=0;a<n.length;a++)s(n.data[a]);o.setColorWrite(!0)}for(a=0;a<t.length;a++)s(t.data[a]);for(a=0;a<i.length;a++)s(i.data[a]);if(r.length){for(a=0;a<r.length;a++){const t=r.data[a],i=t.getBoundingInfo();i&&e.activeCamera&&(t._alphaIndex=t.getMesh().alphaIndex,t._distanceToCamera=i.boundingSphere.centerWorld.subtract(e.activeCamera.position).length())}const t=r.data.slice(0,r.length);for(t.sort(((e,t)=>e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0)),o.setAlphaMode(2),a=0;a<t.length;a++)s(t[a]);o.setAlphaMode(0)}}}_updateMeshScreenCoordinates(e){const t=e.getTransformMatrix();let i;i=this.useCustomMeshPosition?this.customMeshPosition:this.attachedNode?this.attachedNode.position:this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;const r=n.Pq.Project(i,n.uq.Identity(),t,this._viewPort);this._screenCoordinates.x=r.x/this._viewPort.width,this._screenCoordinates.y=r.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)}static CreateDefaultMesh(e,t){const i=ht(e,{size:1},t);i.billboardMode=Ps.u.BILLBOARDMODE_ALL;const r=new br.F(e+"Material",t);return r.emissiveColor=new o.v9(1,1,1),i.material=r,i}}(0,Ge.Cg)([(0,ze.P_)()],GI.prototype,"customMeshPosition",void 0),(0,Ge.Cg)([(0,ze.lK)()],GI.prototype,"useCustomMeshPosition",void 0),(0,Ge.Cg)([(0,ze.lK)()],GI.prototype,"invert",void 0),(0,Ge.Cg)([(0,ze.xG)()],GI.prototype,"mesh",void 0),(0,Ge.Cg)([(0,ze.lK)()],GI.prototype,"excludedMeshes",void 0),(0,Ge.Cg)([(0,ze.lK)()],GI.prototype,"includedMeshes",void 0),(0,Ge.Cg)([(0,ze.lK)()],GI.prototype,"exposure",void 0),(0,Ge.Cg)([(0,ze.lK)()],GI.prototype,"decay",void 0),(0,Ge.Cg)([(0,ze.lK)()],GI.prototype,"weight",void 0),(0,Ge.Cg)([(0,ze.lK)()],GI.prototype,"density",void 0),(0,a.Y5)("BABYLON.VolumetricLightScatteringPostProcess",GI);const zI="screenSpaceCurvaturePixelShader",UI="precision highp float;varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D normalSampler;uniform float curvature_ridge;uniform float curvature_valley;\n#ifndef CURVATURE_OFFSET\n#define CURVATURE_OFFSET 1\n#endif\nfloat curvature_soft_clamp(float curvature,float control)\n{if (curvature<0.5/control)\nreturn curvature*(1.0-curvature*control);return 0.25/control;}\nfloat calculate_curvature(ivec2 texel,float ridge,float valley)\n{vec2 normal_up =texelFetch(normalSampler,texel+ivec2(0, CURVATURE_OFFSET),0).rb;vec2 normal_down =texelFetch(normalSampler,texel+ivec2(0,-CURVATURE_OFFSET),0).rb;vec2 normal_left =texelFetch(normalSampler,texel+ivec2(-CURVATURE_OFFSET,0),0).rb;vec2 normal_right=texelFetch(normalSampler,texel+ivec2( CURVATURE_OFFSET,0),0).rb;float normal_diff=((normal_up.g-normal_down.g)+(normal_right.r-normal_left.r));if (normal_diff<0.0)\nreturn -2.0*curvature_soft_clamp(-normal_diff,valley);return 2.0*curvature_soft_clamp(normal_diff,ridge);}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{ivec2 texel=ivec2(gl_FragCoord.xy);vec4 baseColor=texture2D(textureSampler,vUV);float curvature=calculate_curvature(texel,curvature_ridge,curvature_valley);baseColor.rgb*=curvature+1.0;gl_FragColor=baseColor;}";qi.l.ShadersStore[zI]=UI;class WI extends Fi.w{getClassName(){return"ScreenSpaceCurvaturePostProcess"}constructor(e,t,i,r,s,n,o,a=0,l=!1){super(e,"screenSpaceCurvature",["curvature_ridge","curvature_valley"],["textureSampler","normalSampler"],i,r,s,n,o,void 0,a,void 0,null,l),this.ridge=1,this.valley=1,this._geometryBufferRenderer=t.enableGeometryBufferRenderer(),this._geometryBufferRenderer?(this._geometryBufferRenderer.generateNormalsInWorldSpace&&m.V.Error("ScreenSpaceCurvaturePostProcess does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!"),this.onApply=e=>{e.setFloat("curvature_ridge",.5/Math.max(this.ridge*this.ridge,1e-4)),e.setFloat("curvature_valley",.7/Math.max(this.valley*this.valley,1e-4));const t=this._geometryBufferRenderer.getGBuffer().textures[1];e.setTexture("normalSampler",t)}):m.V.Error("Multiple Render Target support needed for screen space curvature post process. Please use IsSupported test first.")}static get IsSupported(){const e=C.q.LastCreatedEngine;return!!e&&e.getCaps().drawBuffersExtension}static _Parse(e,t,i,r){return Ue.p.Parse((()=>new WI(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable)),e,i,r)}}(0,Ge.Cg)([(0,ze.lK)()],WI.prototype,"ridge",void 0),(0,Ge.Cg)([(0,ze.lK)()],WI.prototype,"valley",void 0),(0,a.Y5)("BABYLON.ScreenSpaceCurvaturePostProcess",WI);var HI=i(16612),$I=i(32083),qI=i(54509),YI=i(83802),XI=i(12850),jI=i(85417),ZI=i(79820),QI=i(4511),KI=i(99965),JI=i(67682),eR=i(21830),tR=i(57811),iR=i(37614),rR=i(83153),sR=i(35381),nR=i(50890),oR=i(68625),aR=i(89619),lR=i(19411),hR=i(89480),cR=i(97694),uR=i(22217),dR=i(39336),pR=i(96645),mR=i(55491),fR=i(95516),_R=i(5499),gR=i(9669),xR=i(72578),vR=i(53208),SR=i(3996),bR=i(65783),yR=i(69723),PR=i(91506),TR=i(51537),CR=i(52906),ER=i(37670),AR=i(53813),IR=i(25830),RR=i(8075),MR=i(97961),DR=i(57912),OR=i(96920),NR=i(80265),wR=i(73718),FR=i(54069),BR=i(17985),VR=i(18);Object.defineProperty(it.Z.prototype,"forceShowBoundingBoxes",{get:function(){return this._forceShowBoundingBoxes||!1},set:function(e){this._forceShowBoundingBoxes=e,e&&this.getBoundingBoxRenderer()},enumerable:!0,configurable:!0}),it.Z.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer||(this._boundingBoxRenderer=new WR(this)),this._boundingBoxRenderer},Object.defineProperty(Ps.u.prototype,"showBoundingBox",{get:function(){return this._showBoundingBox||!1},set:function(e){this._showBoundingBox=e,e&&this.getScene().getBoundingBoxRenderer()},enumerable:!0,configurable:!0});const LR=n.uq.Identity(),kR=new n.Pq,GR=new n.Pq,zR=LR.asArray(),UR=new ms.I(kR,kR);class WR{get shaderLanguage(){return this._shaderLanguage}constructor(e){this.name=Ei.v.NAME_BOUNDINGBOXRENDERER,this.frontColor=new o.v9(1,1,1),this.backColor=new o.v9(.1,.1,.1),this.showBackLines=!0,this.onBeforeBoxRenderingObservable=new s.cP,this.onAfterBoxRenderingObservable=new s.cP,this.onResourcesReadyObservable=new s.cP,this.enabled=!0,this._shaderLanguage=0,this.renderList=new Ss.L(32),this._vertexBuffers={},this._fillIndexBuffer=null,this._fillIndexData=null,this._matrixBuffer=null,this._matrices=null,this._useInstances=!1,this._drawWrapperFront=null,this._drawWrapperBack=null,this.scene=e;this.scene.getEngine().isWebGPU&&(this._shaderLanguage=1),e._addComponent(this),this._uniformBufferFront=new hr.D(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererFront",!0),this._buildUniformLayout(this._uniformBufferFront),this._uniformBufferBack=new hr.D(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererBack",!0),this._buildUniformLayout(this._uniformBufferBack)}_buildUniformLayout(e){e.addUniform("color",4),e.addUniform("world",16),e.addUniform("viewProjection",16),e.addUniform("viewProjectionR",16),e.create()}register(){this.scene._beforeEvaluateActiveMeshStage.registerStep(Ei.v.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER,this,this.reset),this.scene._preActiveMeshStage.registerStep(Ei.v.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER,this,this._preActiveMesh),this.scene._evaluateSubMeshStage.registerStep(Ei.v.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER,this,this._evaluateSubMesh),this.scene._afterRenderingGroupDrawStage.registerStep(Ei.v.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER,this,this.render)}_evaluateSubMesh(e,t){if(e.showSubMeshesBoundingBox){const i=t.getBoundingInfo();null!=i&&(i.boundingBox._tag=e.renderingGroupId,this.renderList.push(i.boundingBox))}}_preActiveMesh(e){if(e.showBoundingBox||this.scene.forceShowBoundingBoxes){const t=e.getBoundingInfo();t.boundingBox._tag=e.renderingGroupId,this.renderList.push(t.boundingBox)}}_prepareResources(){if(this._colorShader)return;this._colorShader=new rs("colorShader",this.scene,"boundingBoxRenderer",{attributes:[Ot.R.PositionKind,"world0","world1","world2","world3"],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,89252)),Promise.resolve().then(i.bind(i,12814))]):await Promise.all([Promise.resolve().then(i.bind(i,82187)),Promise.resolve().then(i.bind(i,33495))])}},!1),this._colorShader.setDefine("INSTANCES",this._useInstances),this._colorShader.doNotSerialize=!0,this._colorShader.reservedDataStore={hidden:!0},this._colorShaderForOcclusionQuery=new rs("colorShaderOccQuery",this.scene,"boundingBoxRenderer",{attributes:[Ot.R.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,89252)),Promise.resolve().then(i.bind(i,12814))]):await Promise.all([Promise.resolve().then(i.bind(i,82187)),Promise.resolve().then(i.bind(i,33495))])}},!0),this._colorShaderForOcclusionQuery.doNotSerialize=!0,this._colorShaderForOcclusionQuery.reservedDataStore={hidden:!0};const e=this.scene.getEngine(),t=(0,ks.KA)({size:1});this._vertexBuffers[Ot.R.PositionKind]=new Ot.R(e,t.positions,Ot.R.PositionKind,!1),this._createIndexBuffer(),this._fillIndexData=t.indices,this.onResourcesReadyObservable.notifyObservers(this)}_createIndexBuffer(){const e=this.scene.getEngine();this._indexBuffer=e.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])}rebuild(){const e=this._vertexBuffers[Ot.R.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this._matrixBuffer&&this._matrixBuffer._rebuild()}reset(){this.renderList.reset()}render(e){if(0===this.renderList.length||!this.enabled)return;if(this._useInstances)return void this._renderInstanced(e);if(this._prepareResources(),!this._colorShader.isReady())return;const t=this.scene.getEngine();t.setDepthWrite(!1);const i=this.scene.getTransformMatrix();for(let r=0;r<this.renderList.length;r++){const s=this.renderList.data[r];if(s._tag!==e)continue;this._createWrappersForBoundingBox(s),this.onBeforeBoxRenderingObservable.notifyObservers(s);const o=s.minimum,a=s.maximum.subtract(o),l=o.add(a.scale(.5)),h=n.uq.Scaling(a.x,a.y,a.z).multiply(n.uq.Translation(l.x,l.y,l.z)).multiply(s.getWorldMatrix()),c=t.useReverseDepthBuffer;if(this.showBackLines){const e=s._drawWrapperBack??this._colorShader._getDrawWrapper();this._colorShader._preBind(e),t.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),c?t.setDepthFunctionToLessOrEqual():t.setDepthFunctionToGreaterOrEqual(),this._uniformBufferBack.bindToEffect(e.effect,"BoundingBoxRenderer"),this._uniformBufferBack.updateColor4("color",this.backColor,1),this._uniformBufferBack.updateMatrix("world",h),this._uniformBufferBack.updateMatrix("viewProjection",i),this._uniformBufferBack.update(),t.drawElementsType(fn.i.LineListDrawMode,0,24)}const u=s._drawWrapperFront??this._colorShader._getDrawWrapper();this._colorShader._preBind(u),t.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),c?t.setDepthFunctionToGreater():t.setDepthFunctionToLess(),this._uniformBufferFront.bindToEffect(u.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateColor4("color",this.frontColor,1),this._uniformBufferFront.updateMatrix("world",h),this._uniformBufferFront.updateMatrix("viewProjection",i),this._uniformBufferFront.update(),t.drawElementsType(fn.i.LineListDrawMode,0,24),this.onAfterBoxRenderingObservable.notifyObservers(s)}this._colorShader.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0)}_createWrappersForBoundingBox(e){if(!e._drawWrapperFront){const t=this.scene.getEngine();e._drawWrapperFront=new Ah.E(t),e._drawWrapperBack=new Ah.E(t),e._drawWrapperFront.setEffect(this._colorShader.getEffect()),e._drawWrapperBack.setEffect(this._colorShader.getEffect())}}renderOcclusionBoundingBox(e){const t=this.scene.getEngine();void 0===this._renderPassIdForOcclusionQuery&&(this._renderPassIdForOcclusionQuery=t.createRenderPassId("Render pass for occlusion query"));const i=t.currentRenderPassId;t.currentRenderPassId=this._renderPassIdForOcclusionQuery,this._prepareResources();const r=e.subMeshes[0];if(!this._colorShaderForOcclusionQuery.isReady(e,void 0,r)||!e.hasBoundingInfo)return void(t.currentRenderPassId=i);this._fillIndexBuffer||(this._fillIndexBuffer=t.createIndexBuffer(this._fillIndexData));const s=t.useReverseDepthBuffer;t.setDepthWrite(!1),t.setColorWrite(!1);const o=e.getBoundingInfo().boundingBox,a=o.minimum,l=o.maximum.subtract(a),h=a.add(l.scale(.5)),c=n.uq.Scaling(l.x,l.y,l.z).multiply(n.uq.Translation(h.x,h.y,h.z)).multiply(o.getWorldMatrix()),u=r._drawWrapper;this._colorShaderForOcclusionQuery._preBind(u),t.bindBuffers(this._vertexBuffers,this._fillIndexBuffer,u.effect),s?t.setDepthFunctionToGreater():t.setDepthFunctionToLess(),this.scene.resetCachedMaterial(),this._uniformBufferFront.bindToEffect(u.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateMatrix("world",c),this._uniformBufferFront.updateMatrix("viewProjection",this.scene.getTransformMatrix()),this._uniformBufferFront.update(),t.drawElementsType(fn.i.TriangleFillMode,0,36),this._colorShaderForOcclusionQuery.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0),t.setColorWrite(!0),t.currentRenderPassId=i}set useInstances(e){this._useInstances=e,this._colorShader&&this._colorShader.setDefine("INSTANCES",e),e||this._cleanupInstances()}get useInstances(){return this._useInstances}_renderInstanced(e){if(0===this.renderList.length||!this.enabled)return;if(this._prepareResources(),!this._colorShader.isReady())return;const t=this._colorShader;let i=this._matrices;const r=16*this.renderList.length;(!i||i.length<r||i.length>2*r)&&(i=new Float32Array(r),this._matrices=i),this.onBeforeBoxRenderingObservable.notifyObservers(UR);let s=0;for(let t=0;t<this.renderList.length;t++){const r=this.renderList.data[t];if(r._tag!==e)continue;const n=r.minimum,o=r.maximum.subtractToRef(n,GR),a=n.addToRef(o.scaleToRef(.5,kR),kR),l=zR;l[0]=o._x,l[3]=a._x,l[5]=o._y,l[7]=a._y,l[10]=o._z,l[11]=a._z,LR.multiplyToArray(r.getWorldMatrix(),i,16*s),s++}const n=this.scene.getEngine(),o=n.getDepthFunction()??515,a=n.getDepthWrite();n.setDepthWrite(!1);const l=this._matrixBuffer;l?.isUpdatable()&&l.getData()===i?l.update(i):this._createInstanceBuffer(i),this._createWrappersForBoundingBox(this);const h=n.useReverseDepthBuffer,c=this.scene.getTransformMatrix();if(this.showBackLines){const e=this._drawWrapperBack??t._getDrawWrapper();t._preBind(e),n.bindBuffers(this._vertexBuffers,this._indexBuffer,t.getEffect()),h?n.setDepthFunctionToLessOrEqual():n.setDepthFunctionToGreaterOrEqual();const i=this._uniformBufferBack;i.bindToEffect(e.effect,"BoundingBoxRenderer"),i.updateColor4("color",this.backColor,1),i.updateMatrix("viewProjection",c),i.update(),n.drawElementsType(fn.i.LineListDrawMode,0,24,s)}const u=t._getDrawWrapper();t._preBind(u),n.bindBuffers(this._vertexBuffers,this._indexBuffer,t.getEffect()),h?n.setDepthFunctionToGreater():n.setDepthFunctionToLess();const d=this._uniformBufferFront;d.bindToEffect(u.effect,"BoundingBoxRenderer"),d.updateColor4("color",this.frontColor,1),d.updateMatrix("viewProjection",c),d.update(),n.drawElementsType(fn.i.LineListDrawMode,0,24,s),this.onAfterBoxRenderingObservable.notifyObservers(UR),t.unbind(),n.setDepthFunction(o),n.setDepthWrite(a)}_createInstanceBuffer(e){const t=this._vertexBuffers;this._cleanupInstanceBuffer();const i=new Ot.h(this.scene.getEngine(),e,!0,16,!1,!0);t.world0=i.createVertexBuffer("world0",0,4),t.world1=i.createVertexBuffer("world1",4,4),t.world2=i.createVertexBuffer("world2",8,4),t.world3=i.createVertexBuffer("world3",12,4),this._matrixBuffer=i}_cleanupInstanceBuffer(){const e=this._vertexBuffers;e.world0&&(e.world0.dispose(),delete e.world0),e.world1&&(e.world1.dispose(),delete e.world1),e.world2&&(e.world2.dispose(),delete e.world2),e.world3&&(e.world3.dispose(),delete e.world3),this._matrices=null,this._matrixBuffer&&(this._matrixBuffer.dispose(),this._matrixBuffer=null)}_cleanupInstances(){this._cleanupInstanceBuffer(),this._drawWrapperFront&&(this._drawWrapperFront.dispose(),this._drawWrapperFront=null),this._drawWrapperBack&&(this._drawWrapperBack.dispose(),this._drawWrapperBack=null)}dispose(){if(void 0!==this._renderPassIdForOcclusionQuery&&(this.scene.getEngine().releaseRenderPassId(this._renderPassIdForOcclusionQuery),this._renderPassIdForOcclusionQuery=void 0),!this._colorShader)return;this.onBeforeBoxRenderingObservable.clear(),this.onAfterBoxRenderingObservable.clear(),this.onResourcesReadyObservable.clear(),this.renderList.dispose(),this._colorShader.dispose(),this._colorShaderForOcclusionQuery.dispose(),this._uniformBufferFront.dispose(),this._uniformBufferBack.dispose();const e=this._vertexBuffers[Ot.R.PositionKind];e&&(e.dispose(),this._vertexBuffers[Ot.R.PositionKind]=null),this.scene.getEngine()._releaseBuffer(this._indexBuffer),this._fillIndexBuffer&&(this.scene.getEngine()._releaseBuffer(this._fillIndexBuffer),this._fillIndexBuffer=null),this._cleanupInstances()}}it.Z.prototype.enableDepthRenderer=function(e,t=!1,i=!1,r=3,s=!1){if(!(e=e||this.activeCamera))throw"No camera available to enable depth renderer";if(this._depthRenderer||(this._depthRenderer={}),!this._depthRenderer[e.id]){const n=!!this.getEngine().getCaps().textureFloatRender;let o=0;o=!this.getEngine().getCaps().textureHalfFloatRender||i&&n?n?1:0:2,this._depthRenderer[e.id]=new Dh(this,o,e,t,r,s)}return this._depthRenderer[e.id]},it.Z.prototype.disableDepthRenderer=function(e){(e=e||this.activeCamera)&&this._depthRenderer&&this._depthRenderer[e.id]&&this._depthRenderer[e.id].dispose()};class HR{constructor(e){this.name=Ei.v.NAME_DEPTHRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(Ei.v.STEP_GATHERRENDERTARGETS_DEPTHRENDERER,this,this._gatherRenderTargets),this.scene._gatherActiveCameraRenderTargetsStage.registerStep(Ei.v.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER,this,this._gatherActiveCameraRenderTargets)}rebuild(){}dispose(){for(const e in this.scene._depthRenderer)this.scene._depthRenderer[e].dispose()}_gatherRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&!i.useOnlyInActiveCamera&&e.push(i.getDepthMap())}}_gatherActiveCameraRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&i.useOnlyInActiveCamera&&this.scene.activeCamera.id===t&&e.push(i.getDepthMap())}}}Dh._SceneComponentInitialization=e=>{let t=e._getComponent(Ei.v.NAME_DEPTHRENDERER);t||(t=new HR(e),e._addComponent(t))};class $R{constructor(){this.enabled=!0,this.name="depthPeeling",this.texturesRequired=[4]}}class qR{get passCount(){return this._passCount}set passCount(e){this._passCount!==e&&(this._passCount=e,this._createRenderPassIds())}get useRenderPasses(){return this._useRenderPasses}set useRenderPasses(e){this._useRenderPasses!==e&&(this._useRenderPasses=e,this._createRenderPassIds())}addExcludedMesh(e){-1===this._excludedMeshes.indexOf(e.uniqueId)&&this._excludedMeshes.push(e.uniqueId)}removeExcludedMesh(e){const t=this._excludedMeshes.indexOf(e.uniqueId);-1!==t&&this._excludedMeshes.splice(t,1)}get shaderLanguage(){return this._shaderLanguage}constructor(e,t=5){if(this._thinTextures=[],this._currentPingPongState=0,this._layoutCacheFormat=[[!0],[!0,!0],[!0,!0,!0]],this._layoutCache=[],this._candidateSubMeshes=new Ss.L(10),this._excludedSubMeshes=new Ss.L(10),this._excludedMeshes=[],this._colorCache=[new o.ov(qR._DEPTH_CLEAR_VALUE,qR._DEPTH_CLEAR_VALUE,0,0),new o.ov(-qR._MIN_DEPTH,qR._MAX_DEPTH,0,0),new o.ov(0,0,0,0)],this._shaderLanguage=0,this._scene=e,this._engine=e.getEngine(),this._passCount=t,e.enablePrePassRenderer()){for(let e=0;e<this._layoutCacheFormat.length;++e)this._layoutCache[e]=this._engine.buildTextureLayout(this._layoutCacheFormat[e]);this._renderPassIds=[],this.useRenderPasses=!1,this._engine.isWebGPU&&(this._shaderLanguage=1),this._prePassEffectConfiguration=new $R,this._createTextures(),this._createEffects()}else m.V.Warn("Depth peeling for order independant transparency could not enable PrePass, aborting.")}_createRenderPassIds(){if(this._releaseRenderPassIds(),this._useRenderPasses)for(let e=0;e<this._passCount+1;++e)this._renderPassIds[e]||(this._renderPassIds[e]=this._engine.createRenderPassId(`DepthPeelingRenderer - pass #${e}`))}_releaseRenderPassIds(){for(let e=0;e<this._renderPassIds.length;++e)this._engine.releaseRenderPassId(this._renderPassIds[e]);this._renderPassIds=[]}_createTextures(){const e={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()};this._depthMrts=[new Vf("depthPeelingDepth0MRT",e,3,this._scene,void 0,["depthPeelingDepth0MRT_depth","depthPeelingDepth0MRT_frontColor","depthPeelingDepth0MRT_backColor"]),new Vf("depthPeelingDepth1MRT",e,3,this._scene,void 0,["depthPeelingDepth1MRT_depth","depthPeelingDepth1MRT_frontColor","depthPeelingDepth1MRT_backColor"])],this._colorMrts=[new Vf("depthPeelingColor0MRT",e,2,this._scene,{generateDepthBuffer:!1},["depthPeelingColor0MRT_frontColor","depthPeelingColor0MRT_backColor"]),new Vf("depthPeelingColor1MRT",e,2,this._scene,{generateDepthBuffer:!1},["depthPeelingColor1MRT_frontColor","depthPeelingColor1MRT_backColor"])],this._blendBackMrt=new Vf("depthPeelingBackMRT",e,1,this._scene,{generateDepthBuffer:!1},["depthPeelingBackMRT_blendBack"]),this._outputRT=new cr.$("depthPeelingOutputRTT",e,this._scene,!1);const t=[{format:7,samplingMode:1,type:this._engine.getCaps().textureFloatLinearFiltering?1:2,label:"DepthPeelingRenderer-DepthTexture"},{format:5,samplingMode:1,type:2,label:"DepthPeelingRenderer-ColorTexture"}];for(let i=0;i<2;i++){const r=this._engine._createInternalTexture(e,t[0],!1),s=this._engine._createInternalTexture(e,t[1],!1),n=this._engine._createInternalTexture(e,t[1],!1);this._depthMrts[i].setInternalTexture(r,0),this._depthMrts[i].setInternalTexture(s,1),this._depthMrts[i].setInternalTexture(n,2),this._colorMrts[i].setInternalTexture(s,0),this._colorMrts[i].setInternalTexture(n,1),this._thinTextures.push(new Zf.D(r),new Zf.D(s),new Zf.D(n))}}_disposeTextures(){for(let e=0;e<this._thinTextures.length;e++)6!==e&&this._thinTextures[e].dispose();for(let e=0;e<2;e++)this._depthMrts[e].dispose(!0),this._colorMrts[e].dispose(!0),this._blendBackMrt.dispose(!0);this._outputRT.dispose(),this._thinTextures=[],this._colorMrts=[],this._depthMrts=[]}_updateTextures(){return this._depthMrts[0].getSize().width===this._engine.getRenderWidth()&&this._depthMrts[0].getSize().height===this._engine.getRenderHeight()||(this._disposeTextures(),this._createTextures()),this._updateTextureReferences()}_updateTextureReferences(){const e=this._scene.prePassRenderer;if(!e)return!1;const t=e.getIndex(4),i=e.defaultRT.textures?.length?e.defaultRT.textures[t].getInternalTexture():null;return!!i&&(this._blendBackTexture!==i&&(this._blendBackTexture=i,this._blendBackMrt.setInternalTexture(this._blendBackTexture,0),this._thinTextures[6]&&this._thinTextures[6].dispose(),this._thinTextures[6]=new Zf.D(this._blendBackTexture),e.defaultRT.renderTarget.shareDepth(this._depthMrts[0].renderTarget)),!0)}_createEffects(){this._blendBackEffectWrapper=new Bi.$({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.resolve().then(i.bind(i,47312)):await Promise.resolve().then(i.bind(i,20449))}}),this._blendBackEffectWrapperPingPong=new Bi.$({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.resolve().then(i.bind(i,47312)):await Promise.resolve().then(i.bind(i,20449))}}),this._finalEffectWrapper=new Bi.$({fragmentShader:"oitFinal",useShaderStore:!0,engine:this._engine,samplerNames:["uFrontColor","uBackColor"],uniformNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.resolve().then(i.bind(i,14958)):await Promise.resolve().then(i.bind(i,19015))}}),this._effectRenderer=new Bi.J(this._engine)}setPrePassRenderer(e){e.addEffectConfiguration(this._prePassEffectConfiguration)}bind(e){e.setTexture("oitDepthSampler",this._thinTextures[3*this._currentPingPongState]),e.setTexture("oitFrontColorSampler",this._thinTextures[3*this._currentPingPongState+1])}_renderSubMeshes(e){let t;this._useRenderPasses&&(t={});for(let i=0;i<e.length;i++){const r=e.data[i].getMaterial();let s=!0,n=!1;const o=e.data[i];let a,l=!1;if(this._useRenderPasses&&(a=o._getDrawWrapper(),l=!a),r&&(s=r.allowShaderHotSwapping,n=r.backFaceCulling,r.allowShaderHotSwapping=!1,r.backFaceCulling=!1),o.render(!1),l&&(a=o._getDrawWrapper(),a.materialContext)){let e=t[a.materialContext.uniqueId];e||(e=t[a.materialContext.uniqueId]=this._engine.createMaterialContext()),o._getDrawWrapper().materialContext=e}r&&(r.allowShaderHotSwapping=s,r.backFaceCulling=n)}}_finalCompose(e){const t=this._scene.prePassRenderer?.setCustomOutput(this._outputRT);t?this._engine.bindFramebuffer(this._outputRT.renderTarget):this._engine.restoreDefaultFramebuffer(),this._engine.setAlphaMode(0),this._engine.applyStates(),this._engine.enableEffect(this._finalEffectWrapper.drawWrapper),this._finalEffectWrapper.effect.setTexture("uFrontColor",this._thinTextures[3*e+1]),this._finalEffectWrapper.effect.setTexture("uBackColor",this._thinTextures[6]),this._effectRenderer.render(this._finalEffectWrapper)}isReady(){return this._blendBackEffectWrapper.effect.isReady()&&this._blendBackEffectWrapperPingPong.effect.isReady()&&this._finalEffectWrapper.effect.isReady()&&this._updateTextures()}render(e){if(this._candidateSubMeshes.length=0,this._excludedSubMeshes.length=0,!this.isReady())return this._excludedSubMeshes;this._scene.activeCamera&&this._engine.setViewport(this._scene.activeCamera.viewport);for(let t=0;t<e.length;t++){const i=e.data[t],r=i.getMaterial(),s=r&&i.getRenderingMesh()._getRenderingFillMode(r.fillMode);!r||s!==fn.i.TriangleFanDrawMode&&s!==fn.i.TriangleFillMode&&s!==fn.i.TriangleStripDrawMode||-1!==this._excludedMeshes.indexOf(i.getMesh().uniqueId)?this._excludedSubMeshes.push(i):this._candidateSubMeshes.push(i)}if(!this._candidateSubMeshes.length)return this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget),this._finalCompose(1),this._excludedSubMeshes;const t=this._engine.currentRenderPassId;this._scene.prePassRenderer._enabled=!1,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[0]),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[1],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthMask=!1,this._engine.depthCullingState.depthTest=!0,this._engine.applyStates(),this._currentPingPongState=1,this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._scene.resetCachedMaterial();let i=0,r=0;for(let e=0;e<this._passCount;e++){i=e%2,r=1-i,this._currentPingPongState=i,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[e+1]),this._scene.activeCamera&&this._engine.setViewport(this._scene.activeCamera.viewport),this._engine.bindFramebuffer(this._depthMrts[r].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[r].renderTarget),this._engine.bindFramebuffer(this._colorMrts[r].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[r].renderTarget),this._engine.bindFramebuffer(this._depthMrts[r].renderTarget),this._engine.bindAttachments(this._layoutCache[2]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthTest=!1,this._engine.applyStates(),this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[r].renderTarget),this._scene.resetCachedMaterial(),this._engine.bindFramebuffer(this._blendBackMrt.renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaEquation(0),this._engine.setAlphaMode(17),this._engine.applyStates();const t=0!==r&&this._useRenderPasses?this._blendBackEffectWrapperPingPong:this._blendBackEffectWrapper;this._engine.enableEffect(t.drawWrapper),t.effect.setTexture("uBackColor",this._thinTextures[3*r+2]),this._effectRenderer.render(t),this._engine.unBindFramebuffer(this._blendBackMrt.renderTarget)}return this._engine.currentRenderPassId=t,this._finalCompose(r),this._scene.prePassRenderer._enabled=!0,this._engine.depthCullingState.depthMask=!0,this._engine.depthCullingState.depthTest=!0,this._excludedSubMeshes}dispose(){this._disposeTextures(),this._blendBackEffectWrapper.dispose(),this._finalEffectWrapper.dispose(),this._effectRenderer.dispose(),this._releaseRenderPassIds()}}qR._DEPTH_CLEAR_VALUE=-99999,qR._MIN_DEPTH=0,qR._MAX_DEPTH=1,Object.defineProperty(it.Z.prototype,"depthPeelingRenderer",{get:function(){if(!this._depthPeelingRenderer){let e=this._getComponent(Ei.v.NAME_DEPTHPEELINGRENDERER);e||(e=new YR(this),this._addComponent(e))}return this._depthPeelingRenderer},set:function(e){this._depthPeelingRenderer=e},enumerable:!0,configurable:!0}),Object.defineProperty(it.Z.prototype,"useOrderIndependentTransparency",{get:function(){return this._useOrderIndependentTransparency},set:function(e){this._useOrderIndependentTransparency!==e&&(this._useOrderIndependentTransparency=e,this.markAllMaterialsAsDirty(63),this.prePassRenderer?.markAsDirty())},enumerable:!0,configurable:!0});class YR{constructor(e){this.name=Ei.v.NAME_DEPTHPEELINGRENDERER,this.scene=e,e.depthPeelingRenderer=new qR(e)}register(){}rebuild(){}dispose(){this.scene.depthPeelingRenderer?.dispose(),this.scene.depthPeelingRenderer=null}}Ps.u.prototype.disableEdgesRendering=function(){return this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),this},Ps.u.prototype.enableEdgesRendering=function(e=.95,t=!1,i){return this.disableEdgesRendering(),this._edgesRenderer=new jR(this,e,t,!0,i),this},Object.defineProperty(Ps.u.prototype,"edgesRenderer",{get:function(){return this._edgesRenderer},enumerable:!0,configurable:!0}),_n.prototype.enableEdgesRendering=function(e=.95,t=!1){return this.disableEdgesRendering(),this._edgesRenderer=new ZR(this,e,t),this},gn.prototype.enableEdgesRendering=function(e=.95,t=!1){return _n.prototype.enableEdgesRendering.apply(this,arguments),this};class XR{constructor(){this.edges=[],this.edgesConnectedCount=0}}class jR{get linesPositions(){return this._linesPositions}get linesNormals(){return this._linesNormals}get linesIndices(){return this._linesIndices}get lineShader(){return this._lineShader}set lineShader(e){this._lineShader=e}static _GetShader(e,t){if(!e._edgeRenderLineShader){const r=new rs("lineShader",e,"line",{attributes:["position","normal"],uniforms:["world","viewProjection","color","width","aspectRatio"],uniformBuffers:["Scene","Mesh"],shaderLanguage:t,extraInitializationsAsync:async()=>{1===t?await Promise.all([Promise.resolve().then(i.bind(i,80574)),Promise.resolve().then(i.bind(i,85264))]):await Promise.all([Promise.resolve().then(i.bind(i,26149)),Promise.resolve().then(i.bind(i,861))])}},!1);r.disableDepthWrite=!0,r.backFaceCulling=!1,r.checkReadyOnEveryCall=e.getEngine().isWebGPU,e._edgeRenderLineShader=r,e.onDisposeObservable.add((()=>{e._edgeRenderLineShader.dispose(),e._edgeRenderLineShader=null}))}return e._edgeRenderLineShader}get shaderLanguage(){return this._shaderLanguage}constructor(e,t=.95,i=!1,r=!0,s){this.edgesWidthScalerForOrthographic=1e3,this.edgesWidthScalerForPerspective=50,this._linesPositions=new Array,this._linesNormals=new Array,this._linesIndices=new Array,this._buffers={},this._buffersForInstances={},this._checkVerticesInsteadOfIndices=!1,this.isEnabled=!0,this.customInstances=new Ss.L(32),this._shaderLanguage=0,this._source=e,this._checkVerticesInsteadOfIndices=i,this._options=s??null,this._epsilon=t;const n=this._source.getScene().getEngine();n.isWebGPU&&(this._drawWrapper=new Ah.E(n),this._shaderLanguage=1),this._prepareRessources(),r&&(s?.useAlternateEdgeFinder??1?this._generateEdgesLinesAlternate():this._generateEdgesLines()),this._meshRebuildObserver=this._source.onRebuildObservable.add((()=>{this._rebuild()})),this._meshDisposeObserver=this._source.onDisposeObservable.add((()=>{this.dispose()}))}_prepareRessources(){this._lineShader||(this._lineShader=jR._GetShader(this._source.getScene(),this._shaderLanguage))}_rebuild(){let e=this._buffers[Ot.R.PositionKind];e&&e._rebuild(),e=this._buffers[Ot.R.NormalKind],e&&e._rebuild();const t=this._source.getScene().getEngine();this._ib=t.createIndexBuffer(this._linesIndices)}dispose(){this._source.onRebuildObservable.remove(this._meshRebuildObserver),this._source.onDisposeObservable.remove(this._meshDisposeObserver);let e=this._buffers[Ot.R.PositionKind];e&&(e.dispose(),this._buffers[Ot.R.PositionKind]=null),e=this._buffers[Ot.R.NormalKind],e&&(e.dispose(),this._buffers[Ot.R.NormalKind]=null),this._ib&&this._source.getScene().getEngine()._releaseBuffer(this._ib),this._drawWrapper?.dispose()}_processEdgeForAdjacencies(e,t,i,r,s){return e===i&&t===r||e===r&&t===i?0:e===r&&t===s||e===s&&t===r?1:e===s&&t===i||e===i&&t===s?2:-1}_processEdgeForAdjacenciesWithVertices(e,t,i,r,s){const n=1e-10;return e.equalsWithEpsilon(i,n)&&t.equalsWithEpsilon(r,n)||e.equalsWithEpsilon(r,n)&&t.equalsWithEpsilon(i,n)?0:e.equalsWithEpsilon(r,n)&&t.equalsWithEpsilon(s,n)||e.equalsWithEpsilon(s,n)&&t.equalsWithEpsilon(r,n)?1:e.equalsWithEpsilon(s,n)&&t.equalsWithEpsilon(i,n)||e.equalsWithEpsilon(i,n)&&t.equalsWithEpsilon(s,n)?2:-1}_checkEdge(e,t,i,r,s){let o;if(void 0===t)o=!0;else{o=n.Pq.Dot(i[e],i[t])<this._epsilon}o&&this.createLine(r,s,this._linesPositions.length/3)}createLine(e,t,i){this._linesPositions.push(e.x,e.y,e.z,e.x,e.y,e.z,t.x,t.y,t.z,t.x,t.y,t.z),this._linesNormals.push(t.x,t.y,t.z,-1,t.x,t.y,t.z,1,e.x,e.y,e.z,-1,e.x,e.y,e.z,1),this._linesIndices.push(i,i+1,i+2,i,i+2,i+3)}_tessellateTriangle(e,t,i,r){const s=(e,t,i)=>{i>=0&&t.push(i);for(let i=0;i<e.length;++i)t.push(e[i][0])};let n=0;e[1].length>=e[0].length&&e[1].length>=e[2].length?n=1:e[2].length>=e[0].length&&e[2].length>=e[1].length&&(n=2);for(let t=0;t<3;++t)t===n?e[t].sort(((e,t)=>e[1]<t[1]?-1:e[1]>t[1]?1:0)):e[t].sort(((e,t)=>e[1]>t[1]?-1:e[1]<t[1]?1:0));const o=[],a=[];s(e[n],o,-1);const l=o.length;for(let o=n+2;o>=n+1;--o)s(e[o%3],a,o!==n+2?r[i[t+(o+1)%3]]:-1);const h=a.length;i.push(r[i[t+n]],o[0],a[0]),i.push(r[i[t+(n+1)%3]],a[h-1],o[l-1]);const c=l<=h,u=c?l:h,d=c?h:l,p=c?l-1:h-1,m=c?0:1;let f=l+h-2,_=0,g=0;const x=c?o:a,v=c?a:o;let S=0;for(;f-- >0;){let e;m?i.push(x[_],v[g]):i.push(v[g],x[_]),S+=u,S>=d&&_<p?(e=x[++_],S-=d):e=v[++g],i.push(e)}i[t+0]=i[i.length-3],i[t+1]=i[i.length-2],i[t+2]=i[i.length-1],i.length=i.length-3}_generateEdgesLinesAlternate(){const e=this._source.getVerticesData(Ot.R.PositionKind);let t=this._source.getIndices();if(!t||!e)return;Array.isArray(t)||(t=Array.from(t));const i=this._options?.useFastVertexMerger??!0,r=i?Math.round(-Math.log(this._options?.epsilonVertexMerge??1e-6)/Math.log(10)):this._options?.epsilonVertexMerge??1e-6,s=[],o=[];if(i){const t={};for(let i=0;i<e.length;i+=3){const n=e[i+0],a=e[i+1],l=e[i+2],h=n.toFixed(r)+"|"+a.toFixed(r)+"|"+l.toFixed(r);if(void 0!==t[h])s.push(t[h]);else{const e=i/3;t[h]=e,s.push(e),o.push(e)}}}else for(let t=0;t<e.length;t+=3){const i=e[t+0],n=e[t+1],a=e[t+2];let l=!1;for(let o=0;o<t&&!l;o+=3){const t=e[o+0],h=e[o+1],c=e[o+2];if(Math.abs(i-t)<r&&Math.abs(n-h)<r&&Math.abs(a-c)<r){s.push(o/3),l=!0;break}}l||(s.push(t/3),o.push(t/3))}if(this._options?.applyTessellation){const i=this._options?.epsilonVertexAligned??1e-6,r=[];for(let n=0;n<t.length;n+=3){let a;for(let l=0;l<3;++l){const h=s[t[n+l]],c=s[t[n+(l+1)%3]],u=s[t[n+(l+2)%3]];if(h===c)continue;const d=e[3*h+0],p=e[3*h+1],m=e[3*h+2],f=e[3*c+0],_=e[3*c+1],g=e[3*c+2],x=Math.sqrt((f-d)*(f-d)+(_-p)*(_-p)+(g-m)*(g-m));for(let t=0;t<o.length-1;t++){const s=o[t];if(s===h||s===c||s===u)continue;const v=e[3*s+0],S=e[3*s+1],b=e[3*s+2],y=Math.sqrt((v-d)*(v-d)+(S-p)*(S-p)+(b-m)*(b-m)),P=Math.sqrt((v-f)*(v-f)+(S-_)*(S-_)+(b-g)*(b-g));Math.abs(y+P-x)<i&&(a||(a={index:n,edgesPoints:[[],[],[]]},r.push(a)),a.edgesPoints[l].push([s,y]))}}}for(let e=0;e<r.length;++e){const i=r[e];this._tessellateTriangle(i.edgesPoints,i.index,t,s)}r.length=0}const a={};for(let i=0;i<t.length;i+=3){let r;for(let o=0;o<3;++o){let l=s[t[i+o]],h=s[t[i+(o+1)%3]];const c=s[t[i+(o+2)%3]];if(l===h||(l===c||h===c)&&this._options?.removeDegeneratedTriangles)continue;if(n.AA.Vector3[0].copyFromFloats(e[3*l+0],e[3*l+1],e[3*l+2]),n.AA.Vector3[1].copyFromFloats(e[3*h+0],e[3*h+1],e[3*h+2]),n.AA.Vector3[2].copyFromFloats(e[3*c+0],e[3*c+1],e[3*c+2]),r||(n.AA.Vector3[1].subtractToRef(n.AA.Vector3[0],n.AA.Vector3[3]),n.AA.Vector3[2].subtractToRef(n.AA.Vector3[1],n.AA.Vector3[4]),r=n.Pq.Cross(n.AA.Vector3[3],n.AA.Vector3[4]),r.normalize()),l>h){const e=l;l=h,h=e}const u=l+"_"+h,d=a[u];if(d){if(!d.done){n.Pq.Dot(r,d.normal)<this._epsilon&&this.createLine(n.AA.Vector3[0],n.AA.Vector3[1],this._linesPositions.length/3),d.done=!0}}else a[u]={normal:r,done:!1,index:i,i:o}}}for(const i in a){const r=a[i];if(!r.done){const i=s[t[r.index+r.i]],o=s[t[r.index+(r.i+1)%3]];n.AA.Vector3[0].copyFromFloats(e[3*i+0],e[3*i+1],e[3*i+2]),n.AA.Vector3[1].copyFromFloats(e[3*o+0],e[3*o+1],e[3*o+2]),this.createLine(n.AA.Vector3[0],n.AA.Vector3[1],this._linesPositions.length/3)}}const l=this._source.getScene().getEngine();this._buffers[Ot.R.PositionKind]=new Ot.R(l,this._linesPositions,Ot.R.PositionKind,!1),this._buffers[Ot.R.NormalKind]=new Ot.R(l,this._linesNormals,Ot.R.NormalKind,!1,!1,4),this._buffersForInstances[Ot.R.PositionKind]=this._buffers[Ot.R.PositionKind],this._buffersForInstances[Ot.R.NormalKind]=this._buffers[Ot.R.NormalKind],this._ib=l.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}_generateEdgesLines(){const e=this._source.getVerticesData(Ot.R.PositionKind),t=this._source.getIndices();if(!t||!e)return;const i=[],r=[];let s,o;for(s=0;s<t.length;s+=3){o=new XR;const a=t[s],l=t[s+1],h=t[s+2];o.p0=new n.Pq(e[3*a],e[3*a+1],e[3*a+2]),o.p1=new n.Pq(e[3*l],e[3*l+1],e[3*l+2]),o.p2=new n.Pq(e[3*h],e[3*h+1],e[3*h+2]);const c=n.Pq.Cross(o.p1.subtract(o.p0),o.p2.subtract(o.p1));c.normalize(),r.push(c),i.push(o)}for(s=0;s<i.length;s++){o=i[s];for(let e=s+1;e<i.length;e++){const r=i[e];if(3===o.edgesConnectedCount)break;if(3===r.edgesConnectedCount)continue;const n=t[3*e],a=t[3*e+1],l=t[3*e+2];for(let i=0;i<3;i++){let h=0;if(void 0===o.edges[i]){switch(i){case 0:h=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(o.p0,o.p1,r.p0,r.p1,r.p2):this._processEdgeForAdjacencies(t[3*s],t[3*s+1],n,a,l);break;case 1:h=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(o.p1,o.p2,r.p0,r.p1,r.p2):this._processEdgeForAdjacencies(t[3*s+1],t[3*s+2],n,a,l);break;case 2:h=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(o.p2,o.p0,r.p0,r.p1,r.p2):this._processEdgeForAdjacencies(t[3*s+2],t[3*s],n,a,l)}if(-1!==h&&(o.edges[i]=e,r.edges[h]=s,o.edgesConnectedCount++,r.edgesConnectedCount++,3===o.edgesConnectedCount))break}}}}for(s=0;s<i.length;s++){const e=i[s];this._checkEdge(s,e.edges[0],r,e.p0,e.p1),this._checkEdge(s,e.edges[1],r,e.p1,e.p2),this._checkEdge(s,e.edges[2],r,e.p2,e.p0)}const a=this._source.getScene().getEngine();this._buffers[Ot.R.PositionKind]=new Ot.R(a,this._linesPositions,Ot.R.PositionKind,!1),this._buffers[Ot.R.NormalKind]=new Ot.R(a,this._linesNormals,Ot.R.NormalKind,!1,!1,4),this._buffersForInstances[Ot.R.PositionKind]=this._buffers[Ot.R.PositionKind],this._buffersForInstances[Ot.R.NormalKind]=this._buffers[Ot.R.NormalKind],this._ib=a.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}isReady(){return this._lineShader.isReady(this._source,this._source.hasInstances&&this.customInstances.length>0||this._source.hasThinInstances)}render(){const e=this._source.getScene(),t=this._lineShader._getDrawWrapper();if(this._drawWrapper&&this._lineShader._setDrawWrapper(this._drawWrapper),!this.isReady()||!e.activeCamera)return void this._lineShader._setDrawWrapper(t);const i=this._source.hasInstances&&this.customInstances.length>0,r=i||this._source.hasThinInstances;let s=0;if(r)if(this._buffersForInstances.world0=this._source.getVertexBuffer("world0"),this._buffersForInstances.world1=this._source.getVertexBuffer("world1"),this._buffersForInstances.world2=this._source.getVertexBuffer("world2"),this._buffersForInstances.world3=this._source.getVertexBuffer("world3"),i){const e=this._source._instanceDataStorage;if(s=this.customInstances.length,!e.instancesData)return void(this._source.getScene()._activeMeshesFrozen||this.customInstances.reset());if(!e.isFrozen){let t=0;for(let i=0;i<s;++i)this.customInstances.data[i].copyToArray(e.instancesData,t),t+=16;e.instancesBuffer.updateDirectly(e.instancesData,0,s)}}else s=this._source.thinInstanceCount;const n=e.getEngine();this._lineShader._preBind(),1!==this._source.edgesColor.a?n.setAlphaMode(2):n.setAlphaMode(0),n.bindBuffers(r?this._buffersForInstances:this._buffers,this._ib,this._lineShader.getEffect()),e.resetCachedMaterial(),this._lineShader.setColor4("color",this._source.edgesColor),e.activeCamera.mode===ft.i.ORTHOGRAPHIC_CAMERA?this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForOrthographic):this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForPerspective),this._lineShader.setFloat("aspectRatio",n.getAspectRatio(e.activeCamera)),this._lineShader.bind(this._source.getWorldMatrix(),this._source),n.drawElementsType(fn.i.TriangleFillMode,0,this._indicesCount,s),this._lineShader.unbind(),r&&n.unbindInstanceAttributes(),this._source.getScene()._activeMeshesFrozen||this.customInstances.reset(),this._lineShader._setDrawWrapper(t)}}class ZR extends jR{constructor(e,t=.95,i=!1){super(e,t,i,!1),this._generateEdgesLines()}_generateEdgesLines(){const e=this._source.getVerticesData(Ot.R.PositionKind),t=this._source.getIndices();if(!t||!e)return;const i=n.AA.Vector3[0],r=n.AA.Vector3[1],s=t.length-1;for(let o=0,a=0;o<s;o+=2,a+=4)n.Pq.FromArrayToRef(e,3*t[o],i),n.Pq.FromArrayToRef(e,3*t[o+1],r),this.createLine(i,r,a);const o=this._source.getScene().getEngine();this._buffers[Ot.R.PositionKind]=new Ot.R(o,this._linesPositions,Ot.R.PositionKind,!1),this._buffers[Ot.R.NormalKind]=new Ot.R(o,this._linesNormals,Ot.R.NormalKind,!1,!1,4),this._ib=o.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}}var QR=i(89974);Object.defineProperty(it.Z.prototype,"iblCdfGenerator",{get:function(){return this._iblCdfGenerator},set:function(e){e&&(this._iblCdfGenerator=e)},enumerable:!0,configurable:!0}),it.Z.prototype.enableIblCdfGenerator=function(){return this._iblCdfGenerator||(this._iblCdfGenerator=new QR.O(this),this.environmentTexture&&(this._iblCdfGenerator.iblSource=this.environmentTexture)),this._iblCdfGenerator},it.Z.prototype.disableIblCdfGenerator=function(){this._iblCdfGenerator&&(this._iblCdfGenerator.dispose(),this._iblCdfGenerator=null)};class KR{constructor(e){this.name=Ei.v.NAME_IBLCDFGENERATOR,this._newIblObserver=null,this.scene=e}register(){this._updateIblSource(),this._newIblObserver=this.scene.onEnvironmentTextureChangedObservable.add(this._updateIblSource.bind(this))}rebuild(){}dispose(){this.scene.onEnvironmentTextureChangedObservable.remove(this._newIblObserver)}_updateIblSource(){this.scene.iblCdfGenerator&&this.scene.environmentTexture&&(this.scene.iblCdfGenerator.iblSource=this.scene.environmentTexture)}}QR.O._SceneComponentInitialization=e=>{let t=e._getComponent(Ei.v.NAME_IBLCDFGENERATOR);t||(t=new KR(e),e._addComponent(t))};class JR{getVoxelGrid(){return this._triPlanarVoxelization?this._voxelGridRT:this._voxelGridZaxis}getDebugPassPP(){return this._voxelDebugPass||this._createDebugPass(),this._voxelDebugPass}get triPlanarVoxelization(){return this._triPlanarVoxelization}set triPlanarVoxelization(e){this._triPlanarVoxelization!==e&&(this._triPlanarVoxelization=e,this._disposeVoxelTextures(),this._createTextures())}setWorldScaleMatrix(e){this._invWorldScaleMatrix=e}isVoxelizationInProgress(){return this._voxelizationInProgress}get voxelResolutionExp(){return this._voxelResolutionExp}set voxelResolutionExp(e){this._voxelResolutionExp===e&&this._voxelGridZaxis||(this._voxelResolutionExp=Math.round(Math.min(Math.max(e,3),9)),this._voxelResolution=Math.pow(2,this._voxelResolutionExp),this._disposeVoxelTextures(),this._createTextures())}set voxelDebugAxis(e){this._voxelDebugAxis=e}get voxelDebugAxis(){return this._voxelDebugAxis}setDebugDisplayParams(e,t,i,r){this._debugSizeParams.set(e,t,i,r)}setDebugMipNumber(e){this._debugMipNumber=e}get debugPassName(){return this._debugPassName}get voxelDebugEnabled(){return this._voxelDebugEnabled}set voxelDebugEnabled(e){this._voxelDebugEnabled!==e&&(this._voxelDebugEnabled=e,e&&(this._voxelSlabDebugRT=new cr.$("voxelSlabDebug",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},this._scene,{generateDepthBuffer:!0,generateMipMaps:!1,type:0,format:5,samplingMode:1}),this._voxelSlabDebugRT.noPrePassRenderer=!0),this._voxelSlabDebugRT&&this._removeVoxelRTs([this._voxelSlabDebugRT]),this._voxelDebugEnabled?(this._addRTsForRender([this._voxelSlabDebugRT],this._includedMeshes,this._voxelDebugAxis,1,!0),this._setDebugBindingsBound=this._setDebugBindings.bind(this),this._scene.onBeforeRenderObservable.add(this._setDebugBindingsBound)):this._scene.onBeforeRenderObservable.removeCallback(this._setDebugBindingsBound))}_createDebugPass(){const e=this._engine.isWebGPU;if(!this._voxelDebugPass){const t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),textureFormat:5,textureType:0,samplingMode:1,uniforms:["sizeParams","mipNumber"],samplers:["voxelTexture","voxelSlabTexture"],engine:this._engine,reusable:!1,shaderLanguage:e?1:0,extraInitializations:(e,t)=>{this._isVoxelGrid3D?e?t.push(Promise.resolve().then(i.bind(i,84237))):t.push(Promise.resolve().then(i.bind(i,96214))):e?t.push(Promise.resolve().then(i.bind(i,17537))):t.push(Promise.resolve().then(i.bind(i,88188)))}};this._voxelDebugPass=new Fi.w(this.debugPassName,this._isVoxelGrid3D?"iblVoxelGrid3dDebug":"iblVoxelGrid2dArrayDebug",t),this._voxelDebugPass.onApplyObservable.add((e=>{0===this._voxelDebugAxis?e.setTexture("voxelTexture",this._voxelGridXaxis):1===this._voxelDebugAxis?e.setTexture("voxelTexture",this._voxelGridYaxis):2===this._voxelDebugAxis?e.setTexture("voxelTexture",this._voxelGridZaxis):e.setTexture("voxelTexture",this.getVoxelGrid()),e.setTexture("voxelSlabTexture",this._voxelSlabDebugRT),e.setVector4("sizeParams",this._debugSizeParams),e.setFloat("mipNumber",this._debugMipNumber)}))}}constructor(e,t,r=6,o=!0){this._voxelMrtsXaxis=[],this._voxelMrtsYaxis=[],this._voxelMrtsZaxis=[],this._isVoxelGrid3D=!0,this.onVoxelizationCompleteObservable=new s.cP,this._renderTargets=[],this._triPlanarVoxelization=!0,this._voxelizationInProgress=!1,this._invWorldScaleMatrix=n.uq.Identity(),this._voxelResolution=64,this._voxelResolutionExp=6,this._mipArray=[],this._voxelDebugEnabled=!1,this._voxelDebugAxis=-1,this._debugSizeParams=new n.IU(0,0,0,0),this._includedMeshes=[],this._debugMipNumber=0,this._debugPassName="Voxelization Debug Pass",this._scene=e,this._engine=e.getEngine(),this._triPlanarVoxelization=o,this._engine.getCaps().drawBuffersExtension||m.V.Error("Can't do voxel rendering without the draw buffers extension.");const a=this._engine.isWebGPU;this._maxDrawBuffers=this._engine.getCaps().maxDrawBuffers||0,this._copyMipEffectRenderer=new Bi.J(this._engine),this._copyMipEffectWrapper=new Bi.$({engine:this._engine,fragmentShader:"copyTexture3DLayerToTexture",useShaderStore:!0,uniformNames:["layerNum"],samplerNames:["textureSampler"],shaderLanguage:a?1:0,extraInitializationsAsync:async()=>{a?await Promise.resolve().then(i.bind(i,95176)):await Promise.resolve().then(i.bind(i,47383))}}),this.voxelResolutionExp=r}_generateMipMaps(){const e=Math.ceil(Math.log2(this._voxelResolution));for(let t=1;t<e+1;t++)this._generateMipMap(t)}_generateMipMap(e){const t=this._mipArray[e-1];t&&(t.setTexture("srcMip",1===e?this.getVoxelGrid():this._mipArray[e-2]),t.render())}_copyMipMaps(){const e=Math.ceil(Math.log2(this._voxelResolution));for(let t=1;t<e+1;t++)this._copyMipMap(t)}_copyMipMap(e){const t=this._mipArray[e-1];if(!t)return;const i=this.getVoxelGrid();let r;if(r=i instanceof cr.$&&i.renderTarget?i.renderTarget:i._rtWrapper,r){this._copyMipEffectRenderer.saveStates();const i=t.getSize().width;for(let s=0;s<i;s++)this._engine.bindFramebuffer(r,0,i,i,!0,e,s),this._copyMipEffectRenderer.applyEffectWrapper(this._copyMipEffectWrapper),this._copyMipEffectWrapper.effect.setTexture("textureSampler",t),this._copyMipEffectWrapper.effect.setInt("layerNum",s),this._copyMipEffectRenderer.draw(),this._engine.unBindFramebuffer(r,!0);this._copyMipEffectRenderer.restoreStates()}}_computeNumberOfSlabs(){return Math.ceil(this._voxelResolution/this._maxDrawBuffers)}_createTextures(){const e=this._engine.isWebGPU,t={width:this._voxelResolution,height:this._voxelResolution,layers:this._isVoxelGrid3D?void 0:this._voxelResolution,depth:this._isVoxelGrid3D?this._voxelResolution:void 0},r={generateDepthBuffer:!1,generateMipMaps:!1,type:0,format:6,samplingMode:1},s=this._computeNumberOfSlabs(),n={generateDepthBuffer:!1,generateMipMaps:!0,type:0,format:6,samplingMode:4,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.resolve().then(i.bind(i,92199)):await Promise.resolve().then(i.bind(i,18162))}};this._triPlanarVoxelization?(this._voxelGridXaxis=new cr.$("voxelGridXaxis",t,this._scene,r),this._voxelGridYaxis=new cr.$("voxelGridYaxis",t,this._scene,r),this._voxelGridZaxis=new cr.$("voxelGridZaxis",t,this._scene,r),this._voxelMrtsXaxis=this._createVoxelMRTs("x_axis_",this._voxelGridXaxis,s),this._voxelMrtsYaxis=this._createVoxelMRTs("y_axis_",this._voxelGridYaxis,s),this._voxelMrtsZaxis=this._createVoxelMRTs("z_axis_",this._voxelGridZaxis,s),this._voxelGridRT=new jd.p("combinedVoxelGrid",t,"iblCombineVoxelGrids",this._scene,n,!1),this._scene.proceduralTextures.splice(this._scene.proceduralTextures.indexOf(this._voxelGridRT),1),this._voxelGridRT.setFloat("layer",0),this._voxelGridRT.setTexture("voxelXaxisSampler",this._voxelGridXaxis),this._voxelGridRT.setTexture("voxelYaxisSampler",this._voxelGridYaxis),this._voxelGridRT.setTexture("voxelZaxisSampler",this._voxelGridZaxis),this._voxelGridRT.autoClear=!1,this._voxelGridRT.wrapU=$e.g.CLAMP_ADDRESSMODE,this._voxelGridRT.wrapV=$e.g.CLAMP_ADDRESSMODE):(this._voxelGridZaxis=new cr.$("voxelGridZaxis",t,this._scene,n),this._voxelMrtsZaxis=this._createVoxelMRTs("z_axis_",this._voxelGridZaxis,s));const o={generateDepthBuffer:!1,generateMipMaps:!1,type:0,format:6,samplingMode:1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.resolve().then(i.bind(i,23584)):await Promise.resolve().then(i.bind(i,46043))}};this._mipArray=new Array(Math.ceil(Math.log2(this._voxelResolution)));for(let e=1;e<=this._mipArray.length;e++){const t=this._voxelResolution>>e,i={width:t,height:t,depth:t};this._mipArray[e-1]=new jd.p("voxelMip"+e,i,"iblGenerateVoxelMip",this._scene,o,!1),this._scene.proceduralTextures.splice(this._scene.proceduralTextures.indexOf(this._mipArray[e-1]),1);const r=this._mipArray[e-1];r.autoClear=!1,r.wrapU=$e.g.CLAMP_ADDRESSMODE,r.wrapV=$e.g.CLAMP_ADDRESSMODE,r.setTexture("srcMip",e>1?this._mipArray[e-2]:this.getVoxelGrid()),r.setInt("layerNum",0)}this._createVoxelMaterials()}_createVoxelMRTs(e,t,i){t.wrapU=$e.g.CLAMP_ADDRESSMODE,t.wrapV=$e.g.CLAMP_ADDRESSMODE,t.noPrePassRenderer=!0;const r=[],s=new Array(this._maxDrawBuffers).fill(this._isVoxelGrid3D?32879:35866);for(let n=0;n<i;n++){let i=new Array(this._maxDrawBuffers).fill(0);i=i.map(((e,t)=>n*this._maxDrawBuffers+t));let a=new Array(this._maxDrawBuffers).fill("");a=a.map(((t,i)=>"voxel_grid_"+e+(n*this._maxDrawBuffers+i)));const l=new Vf("mrt_"+e+n,{width:this._voxelResolution,height:this._voxelResolution,depth:this._isVoxelGrid3D?this._voxelResolution:void 0},this._maxDrawBuffers,this._scene,{types:new Array(this._maxDrawBuffers).fill(0),samplingModes:new Array(this._maxDrawBuffers).fill(3),generateMipMaps:!1,targetTypes:s,formats:new Array(this._maxDrawBuffers).fill(6),faceIndex:new Array(this._maxDrawBuffers).fill(0),layerIndex:i,layerCounts:new Array(this._maxDrawBuffers).fill(this._voxelResolution),generateDepthBuffer:!1,generateStencilBuffer:!1},a);l.clearColor=new o.ov(0,0,0,1),l.noPrePassRenderer=!0;for(let e=0;e<this._maxDrawBuffers;e++)l.setInternalTexture(t.getInternalTexture(),e);r.push(l)}return r}_disposeVoxelTextures(){this._stopVoxelization();for(let e=0;e<this._voxelMrtsZaxis.length;e++)this._triPlanarVoxelization&&(this._voxelMrtsXaxis[e].dispose(!0),this._voxelMrtsYaxis[e].dispose(!0)),this._voxelMrtsZaxis[e].dispose(!0);this._triPlanarVoxelization&&(this._voxelGridXaxis?.dispose(),this._voxelGridYaxis?.dispose(),this._voxelGridRT?.dispose()),this._voxelGridZaxis?.dispose(),this._mipArray.forEach((e=>{e.dispose()})),this._voxelMaterial?.dispose(),this._voxelSlabDebugMaterial?.dispose(),this._mipArray=[],this._voxelMrtsXaxis=[],this._voxelMrtsYaxis=[],this._voxelMrtsZaxis=[]}_createVoxelMaterials(){const e=this._engine.isWebGPU;this._voxelMaterial=new rs("voxelization",this._scene,"iblVoxelGrid",{uniforms:["world","viewMatrix","invWorldScale","nearPlane","farPlane","stepSize"],defines:["MAX_DRAW_BUFFERS "+this._maxDrawBuffers],shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(i.bind(i,39107)),Promise.resolve().then(i.bind(i,43965))]):await Promise.all([Promise.resolve().then(i.bind(i,3414)),Promise.resolve().then(i.bind(i,8444))])}}),this._voxelMaterial.cullBackFaces=!1,this._voxelMaterial.backFaceCulling=!1,this._voxelMaterial.depthFunction=Vi.Engine.ALWAYS,this._voxelSlabDebugMaterial=new rs("voxelSlabDebug",this._scene,"iblVoxelSlabDebug",{uniforms:["world","viewMatrix","cameraViewMatrix","projection","invWorldScale","nearPlane","farPlane","stepSize"],defines:["MAX_DRAW_BUFFERS "+this._maxDrawBuffers],shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(i.bind(i,1138)),Promise.resolve().then(i.bind(i,26472))]):await Promise.all([Promise.resolve().then(i.bind(i,85257)),Promise.resolve().then(i.bind(i,93968))])}})}_setDebugBindings(){this._voxelSlabDebugMaterial.setMatrix("projection",this._scene.activeCamera.getProjectionMatrix()),this._voxelSlabDebugMaterial.setMatrix("cameraViewMatrix",this._scene.activeCamera.getViewMatrix())}isReady(){let e=this.getVoxelGrid().isReady();for(let t=0;t<this._mipArray.length;t++){const i=this._mipArray[t].isReady();e&&(e=i)}return!(!e||this._voxelizationInProgress)}_stopVoxelization(){this._removeVoxelRTs(this._voxelMrtsXaxis),this._removeVoxelRTs(this._voxelMrtsYaxis),this._removeVoxelRTs(this._voxelMrtsZaxis)}_removeVoxelRTs(e){const t=this._renderTargets.findIndex((t=>t===e[0]));if(t>=0)this._renderTargets.splice(t,e.length);else{const t=this._scene.customRenderTargets.findIndex((t=>t===e[0]));t>=0&&this._scene.customRenderTargets.splice(t,e.length)}}updateVoxelGrid(e){this._stopVoxelization(),this._includedMeshes=e,this._voxelizationInProgress=!0,this._triPlanarVoxelization?(this._addRTsForRender(this._voxelMrtsXaxis,e,0),this._addRTsForRender(this._voxelMrtsYaxis,e,1),this._addRTsForRender(this._voxelMrtsZaxis,e,2)):this._addRTsForRender(this._voxelMrtsZaxis,e,2),this._voxelDebugEnabled&&this._addRTsForRender([this._voxelSlabDebugRT],e,this._voxelDebugAxis,1,!0),this._renderVoxelGridBound=this._renderVoxelGrid.bind(this),this._scene.onAfterRenderObservable.add(this._renderVoxelGridBound)}_renderVoxelGrid(){if(this._voxelizationInProgress){let e=this.getVoxelGrid().isReady();for(let t=0;t<this._mipArray.length;t++){const i=this._mipArray[t].isReady();e&&(e=i)}for(let t=0;t<this._renderTargets.length;t++){const i=this._renderTargets[t].isReadyForRendering();e&&(e=i)}e&&(this._renderTargets.forEach((e=>{e.render()})),this._stopVoxelization(),this._triPlanarVoxelization&&this._voxelGridRT.render(),this._generateMipMaps(),this._copyMipEffectWrapper.effect.whenCompiledAsync().then((()=>{this._copyMipMaps(),this._scene.onAfterRenderObservable.removeCallback(this._renderVoxelGridBound),this._voxelizationInProgress=!1,this.onVoxelizationCompleteObservable.notifyObservers()})))}}_addRTsForRender(e,t,i,r=0,s=!1){const o=1/this._computeNumberOfSlabs();let a;a=0===r?this._voxelMaterial:this._voxelSlabDebugMaterial,e.forEach(((e,r)=>{e.renderList=[];const s=r*o,l=(r+1)*o,h=o/this._maxDrawBuffers,c=new n.Pq(0,0,0);let u=new n.Pq(0,0,1);0===i?u=new n.Pq(1,0,0):1===i&&(u=new n.Pq(0,1,0));let d=new n.Pq(0,1,0);1===i&&(d=new n.Pq(1,0,0)),e.onBeforeRenderObservable.add((()=>{a.setMatrix("viewMatrix",n.uq.LookAtLH(c,u,d)),a.setMatrix("invWorldScale",this._invWorldScaleMatrix),a.setFloat("nearPlane",s),a.setFloat("farPlane",l),a.setFloat("stepSize",h)})),0!==t.length&&t.forEach((t=>{t&&(t.subMeshes&&t.subMeshes.length>0&&(e.renderList?.push(t),e.setMaterialForRendering(t,a)),t.getChildMeshes().forEach((t=>{t.subMeshes&&t.subMeshes.length>0&&(e.renderList?.push(t),e.setMaterialForRendering(t,a))})))}))})),s?e.forEach((e=>{-1===this._scene.customRenderTargets.indexOf(e)&&this._scene.customRenderTargets.push(e)})):this._renderTargets=this._renderTargets.concat(e)}resize(){this._voxelSlabDebugRT?.resize({width:this._scene.getEngine().getRenderWidth(),height:this._scene.getEngine().getRenderHeight()})}dispose(){this._disposeVoxelTextures(),this._voxelSlabDebugRT&&(this._removeVoxelRTs([this._voxelSlabDebugRT]),this._voxelSlabDebugRT.dispose()),this._voxelDebugPass&&this._voxelDebugPass.dispose()}}class eM{get voxelShadowOpacity(){return this._voxelShadowOpacity}set voxelShadowOpacity(e){this._voxelShadowOpacity=e}get ssShadowOpacity(){return this._ssShadowOpacity}set ssShadowOpacity(e){this._ssShadowOpacity=e}get sssSamples(){return this._sssSamples}set sssSamples(e){this._sssSamples=e}get sssStride(){return this._sssStride}set sssStride(e){this._sssStride=e}get sssMaxDist(){return this._sssMaxDist}set sssMaxDist(e){this._sssMaxDist=e}get sssThickness(){return this._sssThickness}set sssThickness(e){this._sssThickness=e}get voxelNormalBias(){return this._voxelNormalBias}set voxelNormalBias(e){this._voxelNormalBias=e}get voxelDirectionBias(){return this._voxelDirectionBias}set voxelDirectionBias(e){this._voxelDirectionBias=e}get sampleDirections(){return this._sampleDirections}set sampleDirections(e){this._sampleDirections=e}get envRotation(){return this._envRotation}set envRotation(e){this._envRotation=e}getOutputTexture(){return this._outputTexture}getDebugPassPP(){return this._debugPassPP||this._createDebugPass(),this._debugPassPP}get debugPassName(){return this._debugPassName}setWorldScaleMatrix(e){this._invWorldScaleMatrix=e}set coloredShadows(e){this._coloredShadows=e}get coloredShadows(){return this._coloredShadows}setDebugDisplayParams(e,t,i,r){this._debugSizeParams.set(e,t,i,r)}_createDebugPass(){const e=this._engine.isWebGPU;if(!this._debugPassPP){const t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),uniforms:["sizeParams"],samplers:["debugSampler"],engine:this._engine,reusable:!0,shaderLanguage:e?1:0,extraInitializations:(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,2730))):t.push(Promise.resolve().then(i.bind(i,22495)))}};this._debugPassPP=new Fi.w(this.debugPassName,"iblShadowDebug",t),this._debugPassPP.autoClear=!1,this._debugPassPP.onApplyObservable.add((e=>{e.setTexture("debugSampler",this._outputTexture),e.setVector4("sizeParams",this._debugSizeParams)}))}}constructor(e,t){this._voxelShadowOpacity=1,this._sssSamples=16,this._sssStride=8,this._sssMaxDist=.05,this._sssThickness=.5,this._ssShadowOpacity=1,this._cameraInvView=n.uq.Identity(),this._cameraInvProj=n.uq.Identity(),this._invWorldScaleMatrix=n.uq.Identity(),this._frameId=0,this._sampleDirections=4,this._shadowParameters=new n.IU(0,0,0,0),this._sssParameters=new n.IU(0,0,0,0),this._opacityParameters=new n.IU(0,0,0,0),this._voxelBiasParameters=new n.IU(0,0,0,0),this._voxelNormalBias=1.4,this._voxelDirectionBias=1.75,this.enabled=!0,this.debugEnabled=!1,this._debugPassName="Voxel Tracing Debug Pass",this._envRotation=0,this._coloredShadows=!1,this._debugVoxelMarchEnabled=!1,this._debugSizeParams=new n.IU(0,0,0,0),this._scene=e,this._engine=e.getEngine(),this._renderPipeline=t,this._createTextures()}_createTextures(){const e=this._createDefines(),t=this._engine.isWebGPU,r={type:0,format:5,samplingMode:1,generateDepthBuffer:!1,shaderLanguage:t?1:0,extraInitializationsAsync:async()=>{t?await Promise.all([Promise.resolve().then(i.bind(i,9461))]):await Promise.all([Promise.resolve().then(i.bind(i,16990))])}};this._outputTexture=new jd.p("voxelTracingPass",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"iblShadowVoxelTracing",this._scene,r),this._outputTexture.refreshRate=-1,this._outputTexture.autoClear=!1,this._outputTexture.defines=e,this._setBindings(this._scene.activeCamera);let s=0;this._scene.onBeforeRenderObservable.add((()=>{s=0})),this._scene.onAfterRenderTargetsRenderObservable.add((()=>{2==++s&&this.enabled&&this._outputTexture.isReady()&&(this._setBindings(this._scene.activeCamera),this._outputTexture.render())}))}_createDefines(){let e="";return this._scene.useRightHandedSystem&&(e+="#define RIGHT_HANDED\n"),this._debugVoxelMarchEnabled&&(e+="#define VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION 1u\n"),this._coloredShadows&&(e+="#define COLOR_SHADOWS 1u\n"),e}_setBindings(e){this._outputTexture.defines=this._createDefines(),this._outputTexture.setMatrix("viewMtx",e.getViewMatrix()),this._outputTexture.setMatrix("projMtx",e.getProjectionMatrix()),e.getProjectionMatrix().invertToRef(this._cameraInvProj),e.getViewMatrix().invertToRef(this._cameraInvView),this._outputTexture.setMatrix("invProjMtx",this._cameraInvProj),this._outputTexture.setMatrix("invViewMtx",this._cameraInvView),this._outputTexture.setMatrix("wsNormalizationMtx",this._invWorldScaleMatrix),this._frameId++;let t=0;this._scene.environmentTexture&&(t=this._scene.environmentTexture.rotationY??0),t=this._scene.useRightHandedSystem?-(t+.5*Math.PI):t-.5*Math.PI,t%=2*Math.PI,this._shadowParameters.set(this._sampleDirections,this._frameId,1,t),this._outputTexture.setVector4("shadowParameters",this._shadowParameters);const i=this._renderPipeline._getVoxelGridTexture(),r=Math.floor(Math.log2(i.getSize().width));this._voxelBiasParameters.set(this._voxelNormalBias,this._voxelDirectionBias,r,0),this._outputTexture.setVector4("voxelBiasParameters",this._voxelBiasParameters),this._sssParameters.set(this._sssSamples,this._sssStride,this._sssMaxDist,this._sssThickness),this._outputTexture.setVector4("sssParameters",this._sssParameters),this._opacityParameters.set(this._voxelShadowOpacity,this._ssShadowOpacity,0,0),this._outputTexture.setVector4("shadowOpacity",this._opacityParameters),this._outputTexture.setTexture("voxelGridSampler",i),this._outputTexture.setTexture("blueNoiseSampler",this._renderPipeline._getNoiseTexture());const s=this._scene.iblCdfGenerator;s&&this._outputTexture.setTexture("icdfSampler",s.getIcdfTexture()),this._coloredShadows&&this._scene.environmentTexture&&this._outputTexture.setTexture("iblSampler",this._scene.environmentTexture);const n=this._scene.geometryBufferRenderer;if(!n)return;const o=n.getTextureIndex(UA.SCREENSPACE_DEPTH_TEXTURE_TYPE);this._outputTexture.setTexture("depthSampler",n.getGBuffer().textures[o]);const a=n.getTextureIndex(UA.NORMAL_TEXTURE_TYPE);this._outputTexture.setTexture("worldNormalSampler",n.getGBuffer().textures[a])}resize(e=1){const t={width:Math.max(1,Math.floor(this._engine.getRenderWidth()*e)),height:Math.max(1,Math.floor(this._engine.getRenderHeight()*e))};this._outputTexture.resize(t,!1)}isReady(){return this._outputTexture.isReady()&&!(this._debugPassPP&&!this._debugPassPP.isReady())&&this._scene.iblCdfGenerator&&this._scene.iblCdfGenerator.getIcdfTexture().isReady()&&this._renderPipeline._getVoxelGridTexture().isReady()}dispose(){this._outputTexture.dispose(),this._debugPassPP&&this._debugPassPP.dispose()}}class tM{getOutputTexture(){return this._outputTexture}getDebugPassPP(){return this._debugPassPP||this._createDebugPass(),this._debugPassPP}get debugPassName(){return this._debugPassName}setWorldScale(e){this._worldScale=e}setDebugDisplayParams(e,t,i,r){this._debugSizeParams.set(e,t,i,r)}_createDebugPass(){if(!this._debugPassPP){const e=this._engine.isWebGPU,t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),textureFormat:6,textureType:0,samplingMode:1,uniforms:["sizeParams"],samplers:["debugSampler"],engine:this._engine,reusable:!1,shaderLanguage:e?1:0,extraInitializations:(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,2730))):t.push(Promise.resolve().then(i.bind(i,22495)))}};this._debugPassPP=new Fi.w(this.debugPassName,"iblShadowDebug",t),this._debugPassPP.autoClear=!1,this._debugPassPP.onApplyObservable.add((e=>{e.setTexture("debugSampler",this._outputTexture),e.setVector4("sizeParams",this._debugSizeParams)}))}}constructor(e,t){this._worldScale=1,this._blurParameters=new n.IU(0,0,0,0),this.enabled=!0,this._debugPassName="Spatial Blur Debug Pass",this.debugEnabled=!1,this._debugSizeParams=new n.IU(0,0,0,0),this._scene=e,this._engine=e.getEngine(),this._renderPipeline=t,this._createTextures()}_createTextures(){const e=this._engine.isWebGPU,t={type:0,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(i.bind(i,46391))]):await Promise.all([Promise.resolve().then(i.bind(i,8605))])}};this._outputTexture=new jd.p("spatialBlurPass",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"iblShadowSpatialBlur",this._scene,t,!1,!1,0),this._outputTexture.refreshRate=-1,this._outputTexture.autoClear=!1,this._setBindings();let r=0;this._scene.onBeforeRenderObservable.add((()=>{r=0})),this._scene.onAfterRenderTargetsRenderObservable.add((()=>{2==++r&&this.enabled&&this._outputTexture.isReady()&&(this._setBindings(),this._outputTexture.render())}))}_setBindings(){this._outputTexture.setTexture("voxelTracingSampler",this._renderPipeline._getVoxelTracingTexture());this._blurParameters.set(1,this._worldScale,0,0),this._outputTexture.setVector4("blurParameters",this._blurParameters);const e=this._scene.geometryBufferRenderer;if(!e)return;const t=e.getTextureIndex(UA.SCREENSPACE_DEPTH_TEXTURE_TYPE);this._outputTexture.setTexture("depthSampler",e.getGBuffer().textures[t]);const i=e.getTextureIndex(UA.NORMAL_TEXTURE_TYPE);this._outputTexture.setTexture("worldNormalSampler",e.getGBuffer().textures[i])}resize(e=1){const t={width:Math.max(1,Math.floor(this._engine.getRenderWidth()*e)),height:Math.max(1,Math.floor(this._engine.getRenderHeight()*e))};this._outputTexture.resize(t,!1)}isReady(){return this._outputTexture.isReady()&&!(this._debugPassPP&&!this._debugPassPP.isReady())}dispose(){this._outputTexture.dispose(),this._debugPassPP&&this._debugPassPP.dispose()}}class iM{getOutputTexture(){return this._outputTexture}getDebugPassPP(){return this._debugPassPP||this._createDebugPass(),this._debugPassPP}get debugPassName(){return this._debugPassName}get remanence(){return this._remanence}set remanence(e){this._remanence=e}get reset(){return this._reset}set reset(e){this._reset=e}set isMoving(e){this._isMoving=e}setDebugDisplayParams(e,t,i,r){this._debugSizeParams.set(e,t,i,r)}_createDebugPass(){if(!this._debugPassPP){const e=this._engine.isWebGPU,t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),textureFormat:5,textureType:0,samplingMode:1,uniforms:["sizeParams"],samplers:["debugSampler"],engine:this._engine,reusable:!1,shaderLanguage:e?1:0,extraInitializations:(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,2730))):t.push(Promise.resolve().then(i.bind(i,22495)))}};this._debugPassPP=new Fi.w(this.debugPassName,"iblShadowDebug",t),this._debugPassPP.autoClear=!1,this._debugPassPP.onApplyObservable.add((e=>{e.setTexture("debugSampler",this._outputTexture),e.setVector4("sizeParams",this._debugSizeParams)}))}}constructor(e,t){this._accumulationParams=new n.IU(0,0,0,0),this.debugEnabled=!1,this.enabled=!0,this.onReadyObservable=new s.cP,this._debugPassName="Shadow Accumulation Debug Pass",this._remanence=.9,this._reset=!0,this._isMoving=!1,this._debugSizeParams=new n.IU(0,0,0,0),this._scene=e,this._engine=e.getEngine(),this._renderPipeline=t,this._createTextures()}_createTextures(){const e=this._engine.isWebGPU,t={type:2,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(i.bind(i,27122))]):await Promise.all([Promise.resolve().then(i.bind(i,61089))])}};this._outputTexture=new jd.p("shadowAccumulationPass",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"iblShadowAccumulation",this._scene,t),this._outputTexture.refreshRate=-1,this._outputTexture.autoClear=!1,this._outputTexture.onGeneratedObservable.addOnce((()=>{this.onReadyObservable.notifyObservers()})),this._setOutputTextureBindings();let r=0;this._scene.onBeforeRenderObservable.add((()=>{r=0})),this._scene.onAfterRenderTargetsRenderObservable.add((()=>{2==++r&&this.enabled&&this._outputTexture.isReady()&&(this._setOutputTextureBindings(),this._outputTexture.render())}));const s={type:2,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(i.bind(i,99965))]):await Promise.all([Promise.resolve().then(i.bind(i,79820))])}};this._oldAccumulationCopy=new jd.p("oldAccumulationRT",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"pass",this._scene,s,!1),this._oldAccumulationCopy.autoClear=!1,this._oldAccumulationCopy.refreshRate=1,this._oldAccumulationCopy.onBeforeGenerationObservable.add(this._setAccumulationCopyBindings.bind(this)),this._setAccumulationCopyBindings();const n={type:2,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(i.bind(i,99965))]):await Promise.all([Promise.resolve().then(i.bind(i,79820))])}};this._oldPositionCopy=new jd.p("oldLocalPositionRT",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"pass",this._scene,n,!1),this._updatePositionCopy(),this._oldPositionCopy.autoClear=!1,this._oldPositionCopy.refreshRate=1,this._oldPositionCopy.onBeforeGenerationObservable.add(this._updatePositionCopy.bind(this))}_setOutputTextureBindings(){const e=this._isMoving?this.remanence:.99;this._accumulationParams.set(e,this.reset?1:0,this._renderPipeline.voxelGridSize,0),this._outputTexture.setTexture("spatialBlurSampler",this._renderPipeline._getSpatialBlurTexture()),this._outputTexture.setVector4("accumulationParameters",this._accumulationParams),this._outputTexture.setTexture("oldAccumulationSampler",this._oldAccumulationCopy?this._oldAccumulationCopy:this._renderPipeline._dummyTexture2d),this._outputTexture.setTexture("prevPositionSampler",this._oldPositionCopy?this._oldPositionCopy:this._renderPipeline._dummyTexture2d);const t=this._scene.geometryBufferRenderer;if(!t)return;const i=t.getTextureIndex(UA.VELOCITY_LINEAR_TEXTURE_TYPE);this._outputTexture.setTexture("motionSampler",t.getGBuffer().textures[i]);const r=t.getTextureIndex(UA.POSITION_TEXTURE_TYPE);this._outputTexture.setTexture("positionSampler",t.getGBuffer().textures[r]),this.reset=!1,this._isMoving=!1}_updatePositionCopy(){const e=this._scene.geometryBufferRenderer,t=e.getTextureIndex(UA.POSITION_TEXTURE_TYPE);this._oldPositionCopy.setTexture("textureSampler",e.getGBuffer().textures[t])}_setAccumulationCopyBindings(){this._oldAccumulationCopy.setTexture("textureSampler",this._outputTexture)}resize(e=1){const t={width:Math.max(1,Math.floor(this._engine.getRenderWidth()*e)),height:Math.max(1,Math.floor(this._engine.getRenderHeight()*e))};this._outputTexture.resize(t,!1),this._oldAccumulationCopy.resize(t,!1),this._oldPositionCopy.resize({width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},!1),this.reset=!0}_disposeTextures(){this._oldAccumulationCopy.dispose(),this._oldPositionCopy.dispose(),this._outputTexture.dispose()}isReady(){return this._oldAccumulationCopy&&this._oldAccumulationCopy.isReady()&&this._oldPositionCopy&&this._oldPositionCopy.isReady()&&this._outputTexture.isReady()&&!(this._debugPassPP&&!this._debugPassPP.isReady())}dispose(){this._disposeTextures(),this._debugPassPP&&this._debugPassPP.dispose(),this.onReadyObservable.clear()}}class rM extends Hu.M{constructor(){super(...arguments),this.RENDER_WITH_IBL_SHADOWS=!1,this.COLORED_IBL_SHADOWS=!1}}class sM extends vv.y{get isColored(){return this._isColored}set isColored(e){this._isColored!==e&&(this._isColored=e,this._markAllSubMeshesAsTexturesDirty())}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e){super(e,sM.Name,310,new rM),this.shadowOpacity=1,this._isEnabled=!1,this._isColored=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}prepareDefines(e){e.RENDER_WITH_IBL_SHADOWS=this._isEnabled,e.COLORED_IBL_SHADOWS=this.isColored}getClassName(){return"IBLShadowsPluginMaterial"}getUniforms(){return{ubo:[{name:"renderTargetSize",size:2,type:"vec2"},{name:"shadowOpacity",size:1,type:"float"}],fragment:"#ifdef RENDER_WITH_IBL_SHADOWS\n                    uniform vec2 renderTargetSize;\n                    uniform float shadowOpacity;\n                #endif"}}getSamplers(e){e.push("iblShadowsTexture")}bindForSubMesh(e){this._isEnabled&&(e.bindTexture("iblShadowsTexture",this.iblShadowsTexture),e.updateFloat2("renderTargetSize",this._material.getScene().getEngine().getRenderWidth(),this._material.getScene().getEngine().getRenderHeight()),e.updateFloat("shadowOpacity",this.shadowOpacity))}getCustomCode(e,t){let i;return 1===t?(i={CUSTOM_FRAGMENT_DEFINITIONS:"\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    var iblShadowsTextureSampler: sampler;\n                    var iblShadowsTexture: texture_2d<f32>;\n\n                    #ifdef COLORED_IBL_SHADOWS\n                        fn computeIndirectShadow() -> vec3f {\n                            var uv = fragmentInputs.position.xy / uniforms.renderTargetSize;\n                            var shadowValue: vec3f = textureSample(iblShadowsTexture, iblShadowsTextureSampler, uv).rgb;\n                            return mix(shadowValue, vec3f(1.0), 1.0 - uniforms.shadowOpacity);\n                        }\n                    #else\n                        fn computeIndirectShadow() -> vec2f {\n                            var uv = fragmentInputs.position.xy / uniforms.renderTargetSize;\n                            var shadowValue: vec2f = textureSample(iblShadowsTexture, iblShadowsTextureSampler, uv).rg;\n                            return mix(shadowValue, vec2f(1.0), 1.0 - uniforms.shadowOpacity);\n                        }\n                    #endif\n                #endif\n            "},this._material instanceof sf.d?i.CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION="\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    #ifndef UNLIT\n                        #ifdef REFLECTION\n                            #ifdef COLORED_IBL_SHADOWS\n                                var shadowValue: vec3f = computeIndirectShadow();\n                                finalIrradiance *= shadowValue;\n                                finalRadianceScaled *= mix(vec3f(1.0), shadowValue, roughness);\n                            #else\n                                var shadowValue: vec2f = computeIndirectShadow();\n                                finalIrradiance *= vec3f(shadowValue.x);\n                                finalRadianceScaled *= vec3f(mix(pow(shadowValue.y, 4.0), shadowValue.x, roughness));\n                            #endif\n                        #endif\n                    #else\n                        finalDiffuse *= computeIndirectShadow().x;\n                    #endif\n                #endif\n            ":i.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR="\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    #ifdef COLORED_IBL_SHADOWS\n                        var shadowValue: vec3f = computeIndirectShadow();\n                        color *= toGammaSpace(vec4f(shadowValue, 1.0f));\n                    #else\n                        var shadowValue: vec2f = computeIndirectShadow();\n                        color *= toGammaSpace(vec4f(shadowValue.x, shadowValue.x, shadowValue.x, 1.0f));\n                    #endif\n                #endif\n            "):(i={CUSTOM_FRAGMENT_DEFINITIONS:"\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    uniform sampler2D iblShadowsTexture;\n                #ifdef COLORED_IBL_SHADOWS\n                    vec3 computeIndirectShadow() {\n                        vec2 uv = gl_FragCoord.xy / renderTargetSize;\n                        vec3 shadowValue = texture2D(iblShadowsTexture, uv).rgb;\n                        return mix(shadowValue.rgb, vec3(1.0), 1.0 - shadowOpacity);\n                    }\n                #else\n                    vec2 computeIndirectShadow() {\n                        vec2 uv = gl_FragCoord.xy / renderTargetSize;\n                        vec2 shadowValue = texture2D(iblShadowsTexture, uv).rg;\n                        return mix(shadowValue.rg, vec2(1.0), 1.0 - shadowOpacity);\n                    }\n                #endif\n                #endif\n            "},this._material instanceof sf.d?i.CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION="\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    #ifndef UNLIT\n                        #ifdef REFLECTION\n                            #ifdef COLORED_IBL_SHADOWS\n                                vec3 shadowValue = computeIndirectShadow();\n                                finalIrradiance.rgb *= shadowValue.rgb;\n                                finalRadianceScaled *= mix(vec3(1.0), shadowValue.rgb, roughness);\n                            #else\n                                vec2 shadowValue = computeIndirectShadow();\n                                finalIrradiance *= shadowValue.x;\n                                finalRadianceScaled *= mix(pow(shadowValue.y, 4.0), shadowValue.x, roughness);\n                            #endif\n                        #endif\n                    #else\n                        finalDiffuse *= computeIndirectShadow().x;\n                    #endif\n                #endif\n            ":i.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR="\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    #ifdef COLORED_IBL_SHADOWS\n                        vec3 shadowValue = computeIndirectShadow();\n                        color.rgb *= toGammaSpace(shadowValue.rgb);\n                    #else\n                        vec2 shadowValue = computeIndirectShadow();\n                        color.rgb *= toGammaSpace(shadowValue.x);\n                    #endif\n                #endif\n            "),"vertex"===e?null:i}}sM.Name="IBLShadowsPluginMaterial",(0,Ge.Cg)([(0,ze.lK)()],sM.prototype,"iblShadowsTexture",void 0),(0,Ge.Cg)([(0,ze.lK)()],sM.prototype,"shadowOpacity",void 0),(0,Ge.Cg)([(0,ze.lK)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],sM.prototype,"isEnabled",void 0),(0,a.Y5)("BABYLON.IBLShadowsPluginMaterial",sM);class nM extends QA{resetAccumulation(){this._accumulationPass.reset=!0}get shadowOpacity(){return this._shadowOpacity}set shadowOpacity(e){this._shadowOpacity=e,this._setPluginParameters()}get coloredShadows(){return this._coloredShadows}set coloredShadows(e){this._coloredShadows=e,this._voxelTracingPass.coloredShadows=e,this._setPluginParameters()}get shadowRenderSizeFactor(){return this._renderSizeFactor}set shadowRenderSizeFactor(e){this._renderSizeFactor=Math.max(Math.min(e,1),0),this._voxelTracingPass.resize(e),this._spatialBlurPass.resize(e),this._accumulationPass.resize(e),this._setPluginParameters()}get voxelShadowOpacity(){return this._voxelTracingPass?.voxelShadowOpacity}set voxelShadowOpacity(e){this._voxelTracingPass&&(this._voxelTracingPass.voxelShadowOpacity=e)}get ssShadowOpacity(){return this._voxelTracingPass?.ssShadowOpacity}set ssShadowOpacity(e){this._voxelTracingPass&&(this._voxelTracingPass.ssShadowOpacity=e)}get ssShadowSampleCount(){return this._voxelTracingPass?.sssSamples}set ssShadowSampleCount(e){this._voxelTracingPass&&(this._voxelTracingPass.sssSamples=e)}get ssShadowStride(){return this._voxelTracingPass?.sssStride}set ssShadowStride(e){this._voxelTracingPass&&(this._voxelTracingPass.sssStride=e)}get ssShadowDistanceScale(){return this._sssMaxDistScale}set ssShadowDistanceScale(e){this._sssMaxDistScale=e,this._updateSSShadowParams()}get ssShadowThicknessScale(){return this._sssThicknessScale}set ssShadowThicknessScale(e){this._sssThicknessScale=e,this._updateSSShadowParams()}_getVoxelGridTexture(){const e=this._voxelRenderer?.getVoxelGrid();return e&&e.isReady()?e:this._dummyTexture3d}_getNoiseTexture(){const e=this._noiseTexture;return e&&e.isReady()?e:this._dummyTexture2d}_getVoxelTracingTexture(){const e=this._voxelTracingPass?.getOutputTexture();return e&&e.isReady()?e:this._dummyTexture2d}_getSpatialBlurTexture(){const e=this._spatialBlurPass.getOutputTexture();return e&&e.isReady()?e:this._dummyTexture2d}_getAccumulatedTexture(){const e=this._accumulationPass?.getOutputTexture();return e&&e.isReady()?e:this._dummyTexture2d}get gbufferDebugEnabled(){return this._gbufferDebugEnabled}set gbufferDebugEnabled(e){!e||this.allowDebugPasses?(this._gbufferDebugEnabled=e,e?this._enableEffect(this._getGBufferDebugPass().name,this.cameras):this._disableEffect(this._getGBufferDebugPass().name,this.cameras)):m.V.Warn("Can't enable G-Buffer debug view without setting allowDebugPasses to true.")}get cdfDebugEnabled(){return!!this.scene.iblCdfGenerator&&this.scene.iblCdfGenerator.debugEnabled}set cdfDebugEnabled(e){this.scene.iblCdfGenerator&&(!e||this.allowDebugPasses?e!==this.scene.iblCdfGenerator.debugEnabled&&(this.scene.iblCdfGenerator.debugEnabled=e,e?this._enableEffect(this.scene.iblCdfGenerator.debugPassName,this.cameras):this._disableEffect(this.scene.iblCdfGenerator.debugPassName,this.cameras)):m.V.Warn("Can't enable importance sampling debug view without setting allowDebugPasses to true."))}get voxelDebugEnabled(){return this._voxelRenderer?.voxelDebugEnabled}set voxelDebugEnabled(e){this._voxelRenderer&&(!e||this.allowDebugPasses?(this._voxelRenderer.voxelDebugEnabled=e,e?this._enableEffect(this._voxelRenderer.debugPassName,this.cameras):this._disableEffect(this._voxelRenderer.debugPassName,this.cameras)):m.V.Warn("Can't enable voxel debug view without setting allowDebugPasses to true."))}get voxelDebugAxis(){return this._voxelRenderer?.voxelDebugAxis}set voxelDebugAxis(e){this._voxelRenderer&&(this._voxelRenderer.voxelDebugAxis=e)}set voxelDebugDisplayMip(e){this._voxelRenderer&&this._voxelRenderer.setDebugMipNumber(e)}get voxelTracingDebugEnabled(){return this._voxelTracingPass?.debugEnabled}set voxelTracingDebugEnabled(e){this._voxelTracingPass&&(!e||this.allowDebugPasses?e!==this._voxelTracingPass.debugEnabled&&(this._voxelTracingPass.debugEnabled=e,e?this._enableEffect(this._voxelTracingPass.debugPassName,this.cameras):this._disableEffect(this._voxelTracingPass.debugPassName,this.cameras)):m.V.Warn("Can't enable voxel tracing debug view without setting allowDebugPasses to true."))}get spatialBlurPassDebugEnabled(){return this._spatialBlurPass.debugEnabled}set spatialBlurPassDebugEnabled(e){this._spatialBlurPass&&(!e||this.allowDebugPasses?e!==this._spatialBlurPass.debugEnabled&&(this._spatialBlurPass.debugEnabled=e,e?this._enableEffect(this._spatialBlurPass.debugPassName,this.cameras):this._disableEffect(this._spatialBlurPass.debugPassName,this.cameras)):m.V.Warn("Can't enable spatial blur debug view without setting allowDebugPasses to true."))}get accumulationPassDebugEnabled(){return this._accumulationPass?.debugEnabled}set accumulationPassDebugEnabled(e){this._accumulationPass&&(!e||this.allowDebugPasses?e!==this._accumulationPass.debugEnabled&&(this._accumulationPass.debugEnabled=e,e?this._enableEffect(this._accumulationPass.debugPassName,this.cameras):this._disableEffect(this._accumulationPass.debugPassName,this.cameras)):m.V.Warn("Can't enable accumulation pass debug view without setting allowDebugPasses to true."))}addShadowCastingMesh(e){if(Array.isArray(e))for(const t of e)t&&-1===this._shadowCastingMeshes.indexOf(t)&&this._shadowCastingMeshes.push(t);else e&&-1===this._shadowCastingMeshes.indexOf(e)&&this._shadowCastingMeshes.push(e)}removeShadowCastingMesh(e){if(Array.isArray(e))for(const t of e){const e=this._shadowCastingMeshes.indexOf(t);-1!==e&&this._shadowCastingMeshes.splice(e,1)}else{const t=this._shadowCastingMeshes.indexOf(e);-1!==t&&this._shadowCastingMeshes.splice(t,1)}}get resolutionExp(){return this._voxelRenderer.voxelResolutionExp}set resolutionExp(e){e!==this._voxelRenderer.voxelResolutionExp&&(this._voxelRenderer.isVoxelizationInProgress()?m.V.Warn("Can't change the resolution of the voxel grid while voxelization is in progress."):(this._voxelRenderer.voxelResolutionExp=Math.max(1,Math.min(e,8)),this._accumulationPass.reset=!0))}get sampleDirections(){return this._voxelTracingPass?.sampleDirections}set sampleDirections(e){this._voxelTracingPass&&(this._voxelTracingPass.sampleDirections=e)}get shadowRemanence(){return this._accumulationPass?.remanence}set shadowRemanence(e){this._accumulationPass&&(this._accumulationPass.remanence=e)}get envRotation(){return this._voxelTracingPass?.envRotation}set envRotation(e){this._voxelTracingPass&&(this._voxelTracingPass.envRotation=e,this._accumulationPass.reset=!0)}get allowDebugPasses(){return this._allowDebugPasses}set allowDebugPasses(e){this._allowDebugPasses!==e&&(this._allowDebugPasses=e,e&&this.scene.iblCdfGenerator?this.scene.iblCdfGenerator.isReady()?this._createDebugPasses():this.scene.iblCdfGenerator.onGeneratedObservable.addOnce((()=>{this._createDebugPasses()})):this._disposeDebugPasses())}static get IsSupported(){const e=C.q.LastCreatedEngine;return!!e&&e._features.supportIBLShadows}toggleShadow(e){this._enabled=e,this._voxelTracingPass.enabled=e,this._spatialBlurPass.enabled=e,this._accumulationPass.enabled=e,this._materialsWithRenderPlugin.forEach((t=>{if(t.pluginManager){t.pluginManager.getPlugin(sM.Name).isEnabled=e}})),this._setPluginParameters()}updateVoxelization(){0!==this._shadowCastingMeshes.length?(this._voxelRenderer.updateVoxelGrid(this._shadowCastingMeshes),this._voxelRenderer.onVoxelizationCompleteObservable.addOnce((()=>{this.onVoxelizationCompleteObservable.notifyObservers()})),this._updateSSShadowParams()):m.V.Warn("IBL Shadows: updateVoxelization called with no shadow-casting meshes to voxelize.")}updateSceneBounds(){const e={min:new n.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),max:new n.Pq(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)};this._shadowCastingMeshes.forEach((t=>{const i=t.getHierarchyBoundingVectors(!0);e.min=n.Pq.Minimize(e.min,i.min),e.max=n.Pq.Maximize(e.max,i.max)}));const t=e.max.subtract(e.min);if(this.voxelGridSize=Math.max(t.x,t.y,t.z),0===this._shadowCastingMeshes.length||!isFinite(this.voxelGridSize)||0===this.voxelGridSize)return m.V.Warn("IBL Shadows: Scene size is invalid. Can't update bounds."),void(this.voxelGridSize=1);const i=this.voxelGridSize/2,r=e.max.add(e.min).multiplyByFloats(-.5,-.5,-.5),s=n.uq.Compose(new n.Pq(1/i,1/i,1/i),new n.PT,new n.Pq(0,0,0));n.uq.Compose(new n.Pq(1,1,1),new n.PT,r).multiplyToRef(s,s),this._voxelTracingPass.setWorldScaleMatrix(s),this._voxelRenderer.setWorldScaleMatrix(s),this._spatialBlurPass.setWorldScale(2*i),this._updateSSShadowParams()}constructor(e,t,i={},r){super(t.getEngine(),e),this._allowDebugPasses=!1,this._debugPasses=[],this._shadowCastingMeshes=[],this._shadowOpacity=.8,this._enabled=!0,this._coloredShadows=!1,this._materialsWithRenderPlugin=[],this.onShadowTextureReadyObservable=new s.cP,this.onNewIblReadyObservable=new s.cP,this.onVoxelizationCompleteObservable=new s.cP,this.voxelGridSize=1,this._renderSizeFactor=1,this._gbufferDebugEnabled=!1,this._gBufferDebugSizeParams=new n.IU(0,0,0,0),this.scene=t,this._cameras=r||[t.activeCamera];const o=new Uint8Array([0,0,0,255]);this._dummyTexture2d=new He.I(o,1,1,Vi.Engine.TEXTUREFORMAT_RGBA,t,!1),this._dummyTexture3d=new Yf(o,1,1,1,Vi.Engine.TEXTUREFORMAT_RGBA,t,!1);const a={};a[UA.SCREENSPACE_DEPTH_TEXTURE_TYPE]={textureFormat:6,textureType:1},a[UA.VELOCITY_LINEAR_TEXTURE_TYPE]={textureFormat:7,textureType:2},a[UA.POSITION_TEXTURE_TYPE]={textureFormat:5,textureType:2},a[UA.NORMAL_TEXTURE_TYPE]={textureFormat:5,textureType:2};const l=t.enableGeometryBufferRenderer(void 0,14,a);l?(this._geometryBufferRenderer=l,this._geometryBufferRenderer.enableScreenspaceDepth=!0,this._geometryBufferRenderer.enableVelocityLinear=!0,this._geometryBufferRenderer.enablePosition=!0,this._geometryBufferRenderer.enableNormal=!0,this._geometryBufferRenderer.generateNormalsInWorldSpace=!0,this.scene.enableIblCdfGenerator(),this.shadowOpacity=i.shadowOpacity||.8,this._voxelRenderer=new JR(this.scene,this,i?i.resolutionExp:6,void 0===i.triPlanarVoxelization||i.triPlanarVoxelization),this._voxelTracingPass=new eM(this.scene,this),this._spatialBlurPass=new tM(this.scene,this),this._accumulationPass=new iM(this.scene,this),this._accumulationPass.onReadyObservable.addOnce((()=>{this.onShadowTextureReadyObservable.notifyObservers()})),this.sampleDirections=i.sampleDirections||2,this.voxelShadowOpacity=i.voxelShadowOpacity??1,this.envRotation=i.envRotation??0,this.shadowRenderSizeFactor=i.shadowRenderSizeFactor||1,this.ssShadowOpacity=void 0===i.ssShadowsEnabled||i.ssShadowsEnabled?1:0,this.ssShadowDistanceScale=i.ssShadowDistanceScale||1.25,this.ssShadowSampleCount=i.ssShadowSampleCount||16,this.ssShadowStride=i.ssShadowStride||8,this.ssShadowThicknessScale=i.ssShadowThicknessScale||1,this.shadowRemanence=i.shadowRemanence??.75,this._noiseTexture=new $e.g("https://assets.babylonjs.com/textures/blue_noise/blue_noise_rgb.png",this.scene,!1,!0,1),t.postProcessRenderPipelineManager.addPipeline(this),this.scene.onActiveCameraChanged.add(this._listenForCameraChanges.bind(this)),this.scene.onBeforeRenderObservable.add(this._updateBeforeRender.bind(this)),this._listenForCameraChanges(),this.scene.getEngine().onResizeObservable.add(this._handleResize.bind(this)),this.scene.iblCdfGenerator&&this.scene.iblCdfGenerator.onGeneratedObservable.add((()=>{this._setPluginParameters(),this.onNewIblReadyObservable.notifyObservers()}))):m.V.Error("Geometry buffer renderer is required for IBL shadows to work.")}_handleResize(){this._voxelRenderer.resize(),this._voxelTracingPass.resize(this.shadowRenderSizeFactor),this._spatialBlurPass.resize(this.shadowRenderSizeFactor),this._accumulationPass.resize(this.shadowRenderSizeFactor),this._setPluginParameters()}_getGBufferDebugPass(){if(this._gbufferDebugPass)return this._gbufferDebugPass;const e=this.engine.isWebGPU,t={width:this.scene.getEngine().getRenderWidth(),height:this.scene.getEngine().getRenderHeight(),samplingMode:1,engine:this.scene.getEngine(),textureType:0,textureFormat:5,uniforms:["sizeParams"],samplers:["depthSampler","normalSampler","positionSampler","velocitySampler"],reusable:!1,shaderLanguage:e?1:0,extraInitializations:(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,29533))):t.push(Promise.resolve().then(i.bind(i,95634)))}};return this._gbufferDebugPass=new Fi.w("iblShadowGBufferDebug","iblShadowGBufferDebug",t),this._gbufferDebugPass.autoClear=!1,this._gbufferDebugPass.onApplyObservable.add((e=>{const t=this._geometryBufferRenderer.getTextureIndex(UA.SCREENSPACE_DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[t]);const i=this._geometryBufferRenderer.getTextureIndex(UA.NORMAL_TEXTURE_TYPE);e.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[i]);const r=this._geometryBufferRenderer.getTextureIndex(UA.POSITION_TEXTURE_TYPE);e.setTexture("positionSampler",this._geometryBufferRenderer.getGBuffer().textures[r]);const s=this._geometryBufferRenderer.getTextureIndex(UA.VELOCITY_LINEAR_TEXTURE_TYPE);e.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[s]),e.setVector4("sizeParams",this._gBufferDebugSizeParams),this.scene.activeCamera&&e.setFloat("maxDepth",this.scene.activeCamera.maxZ)})),this._gbufferDebugPass}_createDebugPasses(){this.scene.iblCdfGenerator?this._debugPasses=[{pass:this.scene.iblCdfGenerator.getDebugPassPP(),enabled:this.cdfDebugEnabled}]:this._debugPasses=[],this._debugPasses.push({pass:this._voxelRenderer.getDebugPassPP(),enabled:this.voxelDebugEnabled},{pass:this._voxelTracingPass.getDebugPassPP(),enabled:this.voxelTracingDebugEnabled},{pass:this._spatialBlurPass.getDebugPassPP(),enabled:this.spatialBlurPassDebugEnabled},{pass:this._accumulationPass.getDebugPassPP(),enabled:this.accumulationPassDebugEnabled},{pass:this._getGBufferDebugPass(),enabled:this.gbufferDebugEnabled});for(let e=0;e<this._debugPasses.length;e++)this._debugPasses[e].pass&&this.addEffect(new PA(this.scene.getEngine(),this._debugPasses[e].pass.name,(()=>this._debugPasses[e].pass),!0));const e=this.cameras.slice();this.scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this.name,this.cameras),this.scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this.name,e);for(let e=0;e<this._debugPasses.length;e++)this._debugPasses[e].pass&&(this._debugPasses[e].enabled?this._enableEffect(this._debugPasses[e].pass.name,this.cameras):this._disableEffect(this._debugPasses[e].pass.name,this.cameras))}_disposeEffectPasses(){this.scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this.name,this.cameras),this._disposeDebugPasses(),this._reset()}_disposeDebugPasses(){for(let e=0;e<this._debugPasses.length;e++)this._disableEffect(this._debugPasses[e].pass.name,this.cameras),this._debugPasses[e].pass.dispose();this._debugPasses=[]}_updateDebugPasses(){let e=0;this._gbufferDebugEnabled&&e++,this.cdfDebugEnabled&&e++,this.voxelDebugEnabled&&e++,this.voxelTracingDebugEnabled&&e++,this.spatialBlurPassDebugEnabled&&e++,this.accumulationPassDebugEnabled&&e++;const t=Math.ceil(Math.sqrt(e)),i=Math.ceil(e/t),r=1/i,s=1/t;let n=0,o=0;this.gbufferDebugEnabled&&(this._gBufferDebugSizeParams.set(n,o,i,t),n-=r,n<=-1&&(n=0,o-=s)),this.cdfDebugEnabled&&this.scene.iblCdfGenerator&&(this.scene.iblCdfGenerator.setDebugDisplayParams(n,o,i,t),n-=r,n<=-1&&(n=0,o-=s)),this.voxelDebugEnabled&&(this._voxelRenderer.setDebugDisplayParams(n,o,i,t),n-=r,n<=-1&&(n=0,o-=s)),this.voxelTracingDebugEnabled&&(this._voxelTracingPass.setDebugDisplayParams(n,o,i,t),n-=r,n<=-1&&(n=0,o-=s)),this.spatialBlurPassDebugEnabled&&(this._spatialBlurPass.setDebugDisplayParams(n,o,i,t),n-=r,n<=-1&&(n=0,o-=s)),this.accumulationPassDebugEnabled&&(this._accumulationPass.setDebugDisplayParams(n,o,i,t),n-=r,n<=-1&&(n=0,o-=s))}_updateSSShadowParams(){this._voxelTracingPass.sssMaxDist=this._sssMaxDistScale*this.voxelGridSize/(1<<this.resolutionExp),this._voxelTracingPass.sssThickness=.005*this._sssThicknessScale*this.voxelGridSize}addShadowReceivingMaterial(e){e?Array.isArray(e)?e.forEach((e=>{this._addShadowSupportToMaterial(e)})):this._addShadowSupportToMaterial(e):this.scene.materials.forEach((e=>{this._addShadowSupportToMaterial(e)}))}removeShadowReceivingMaterial(e){if(Array.isArray(e))e.forEach((e=>{const t=this._materialsWithRenderPlugin.indexOf(e);if(-1!==t){this._materialsWithRenderPlugin.splice(t,1);const i=e.pluginManager?.getPlugin(sM.Name);i.isEnabled=!1}}));else{const t=this._materialsWithRenderPlugin.indexOf(e);if(-1!==t){this._materialsWithRenderPlugin.splice(t,1);e.pluginManager.getPlugin(sM.Name).isEnabled=!1}}}_addShadowSupportToMaterial(e){if(!(e instanceof sf.d||e instanceof br.F))return;let t=e.pluginManager?.getPlugin(sM.Name);t||(t=new sM(e)),-1===this._materialsWithRenderPlugin.indexOf(e)&&(this._enabled&&(t.iblShadowsTexture=this._getAccumulatedTexture().getInternalTexture(),t.shadowOpacity=this.shadowOpacity),t.isEnabled=this._enabled,t.isColored=this._coloredShadows,this._materialsWithRenderPlugin.push(e))}_setPluginParameters(){this._enabled&&this._materialsWithRenderPlugin.forEach((e=>{if(e.pluginManager){const t=e.pluginManager.getPlugin(sM.Name);t.iblShadowsTexture=this._getAccumulatedTexture().getInternalTexture(),t.shadowOpacity=this.shadowOpacity,t.isColored=this._coloredShadows}}))}_updateBeforeRender(){this._updateDebugPasses()}_listenForCameraChanges(){this.scene.activeCamera?.onViewMatrixChangedObservable.add((()=>{this._accumulationPass.isMoving=!0}))}isReady(){return this._noiseTexture.isReady()&&this._voxelRenderer.isReady()&&this.scene.iblCdfGenerator&&this.scene.iblCdfGenerator.isReady()&&(!this._voxelTracingPass||this._voxelTracingPass.isReady())&&(!this._spatialBlurPass||this._spatialBlurPass.isReady())&&(!this._accumulationPass||this._accumulationPass.isReady())}getClassName(){return"IBLShadowsRenderPipeline"}dispose(){this._materialsWithRenderPlugin.splice(0).forEach((e=>{this.removeShadowReceivingMaterial(e)})),this._disposeEffectPasses(),this._noiseTexture.dispose(),this._voxelRenderer.dispose(),this._voxelTracingPass.dispose(),this._spatialBlurPass.dispose(),this._accumulationPass.dispose(),this._dummyTexture2d.dispose(),this._dummyTexture3d.dispose(),this.onNewIblReadyObservable.clear(),this.onShadowTextureReadyObservable.clear(),super.dispose()}}class oM extends Vf{constructor(e,t,i,r,s,n){super(e,i,r,s,n),this._beforeCompositionPostProcesses=[],this._internalTextureDirty=!1,this.enabled=!1,this.renderTargetTexture=null,this.renderTargetTexture=t}_createCompositionEffect(){this.imageProcessingPostProcess=new LA("prePassComposition",1,null,void 0,this._engine),this.imageProcessingPostProcess._updateParameters()}_checkSize(){const e=this._engine.getRenderWidth(!0),t=this._engine.getRenderHeight(!0),i=this.getRenderWidth(),r=this.getRenderHeight();i===e&&r===t||(this.resize({width:e,height:t}),this._internalTextureDirty=!0)}updateCount(e,t,i){super.updateCount(e,t,i),this._internalTextureDirty=!0}_resetPostProcessChain(){this._beforeCompositionPostProcesses.length=0}dispose(){const e=this._scene;if(super.dispose(),e&&e.prePassRenderer){const t=e.prePassRenderer.renderTargets.indexOf(this);-1!==t&&e.prePassRenderer.renderTargets.splice(t,1)}this.imageProcessingPostProcess&&this.imageProcessingPostProcess.dispose(),this.renderTargetTexture&&(this.renderTargetTexture._prePassRenderTarget=null),this._outputPostProcess&&(this._outputPostProcess.autoClear=!0,this._outputPostProcess.restoreDefaultInputTexture())}}class aM{get generateNormalsInWorldSpace(){return this._generateNormalsInWorldSpace}set generateNormalsInWorldSpace(e){this._generateNormalsInWorldSpace!==e&&(this._generateNormalsInWorldSpace=e,this._markAllMaterialsAsPrePassDirty())}getIndex(e){return this._textureIndices[e]}get samples(){return this.defaultRT.samples}set samples(e){this.defaultRT.samples=e}get useSpecificClearForDepthTexture(){return this._useSpecificClearForDepthTexture}set useSpecificClearForDepthTexture(e){this._useSpecificClearForDepthTexture!==e&&(this._useSpecificClearForDepthTexture=e,this._isDirty=!0)}getRenderTarget(){return this._currentTarget}_setRenderTarget(e){e?this._currentTarget=e:(this._currentTarget=this.defaultRT,this._engine.currentRenderPassId=this._scene.activeCamera?.renderPassId??this._currentTarget.renderPassId)}get currentRTisSceneRT(){return this._currentTarget===this.defaultRT}_refreshGeometryBufferRendererLink(){if(this.doNotUseGeometryRendererFallback)this._geometryBuffer&&this._geometryBuffer._unlinkPrePassRenderer(),this._geometryBuffer=null,this._scene.disableGeometryBufferRenderer();else{if(this._geometryBuffer=this._scene.enableGeometryBufferRenderer(),!this._geometryBuffer)return void(this.doNotUseGeometryRendererFallback=!0);this._geometryBuffer._linkPrePassRenderer(this)}}get enabled(){return this._enabled}constructor(e){this.excludedSkinnedMesh=[],this.excludedMaterials=[],this.mrtCount=0,this._mrtTypes=[],this._mrtFormats=[],this._mrtLayout=[],this._mrtNames=[],this._textureIndices=[],this._generateNormalsInWorldSpace=!1,this._useSpecificClearForDepthTexture=!1,this._isDirty=!0,this._effectConfigurations=[],this.doNotUseGeometryRendererFallback=!0,this.renderTargets=[],this._clearColor=new o.ov(0,0,0,0),this._clearDepthColor=new o.ov(1e8,0,0,1),this._enabled=!1,this._needsCompositionForThisPass=!1,this.disableGammaTransform=!1,this._scene=e,this._engine=e.getEngine();let t=0;this._engine._caps.textureFloat&&this._engine._caps.textureFloatLinearFiltering?t=1:this._engine._caps.textureHalfFloat&&this._engine._caps.textureHalfFloatLinearFiltering&&(t=2);for(let e=0;e<aM.TextureFormats.length;++e){const i=aM.TextureFormats[e].format;1===aM.TextureFormats[e].type&&(aM.TextureFormats[e].type=t,1!==t||6!==i&&7!==i&&5!==i||this._engine._caps.supportFloatTexturesResolve||(aM.TextureFormats[e].type=2))}aM._SceneComponentInitialization(this._scene),this.defaultRT=this._createRenderTarget("sceneprePassRT",null),this._currentTarget=this.defaultRT}_createRenderTarget(e,t){const i=new oM(e,t,{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},0,this._scene,{generateMipMaps:!1,generateStencilBuffer:this._engine.isStencilEnable,defaultType:0,types:[],drawOnlyOnFirstAttachmentByDefault:!0});return this.renderTargets.push(i),this._enabled&&this._update(),i}get isSupported(){return this._scene.getEngine().getCaps().drawBuffersExtension}bindAttachmentsForEffect(e,t){const i=t.getMaterial(),r=i&&i.isPrePassCapable,s=i&&-1!==this.excludedMaterials.indexOf(i);this.enabled&&this._currentTarget.enabled&&(e._multiTarget&&r&&!s?this._engine.bindAttachments(this._multiRenderAttachments):(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment(),this._geometryBuffer&&this.currentRTisSceneRT&&!s&&this._geometryBuffer.renderList.push(t.getRenderingMesh())))}_reinitializeAttachments(){const e=[],t=[!1],i=[!1],r=[!0];for(let s=0;s<this.mrtCount;s++)e.push(!0),s>0&&(this._useSpecificClearForDepthTexture&&5===this._mrtLayout[s]?(t.push(!1),i.push(!0)):(t.push(!0),i.push(!1)),r.push(!1));this._multiRenderAttachments=this._engine.buildTextureLayout(e),this._clearAttachments=this._engine.buildTextureLayout(t),this._clearDepthAttachments=this._engine.buildTextureLayout(i),this._defaultAttachments=this._engine.buildTextureLayout(r)}_resetLayout(){for(let e=0;e<aM.TextureFormats.length;e++)this._textureIndices[aM.TextureFormats[e].purpose]=-1;this._textureIndices[4]=0,this._mrtLayout=[4],this._mrtTypes=[aM.TextureFormats[4].type],this._mrtFormats=[aM.TextureFormats[4].format],this._mrtNames=[aM.TextureFormats[4].name],this.mrtCount=1}_updateGeometryBufferLayout(){if(this._refreshGeometryBufferRendererLink(),this._geometryBuffer){this._geometryBuffer._resetLayout();const e=[];for(let t=0;t<this._mrtLayout.length;t++)e.push(!1);this._geometryBuffer._linkInternalTexture(this.defaultRT.getInternalTexture());const t=[{prePassConstant:5,geometryBufferConstant:UA.DEPTH_TEXTURE_TYPE},{prePassConstant:6,geometryBufferConstant:UA.NORMAL_TEXTURE_TYPE},{prePassConstant:1,geometryBufferConstant:UA.POSITION_TEXTURE_TYPE},{prePassConstant:3,geometryBufferConstant:UA.REFLECTIVITY_TEXTURE_TYPE},{prePassConstant:2,geometryBufferConstant:UA.VELOCITY_TEXTURE_TYPE}];for(let i=0;i<t.length;i++){const r=this._mrtLayout.indexOf(t[i].prePassConstant);-1!==r&&(this._geometryBuffer._forceTextureType(t[i].geometryBufferConstant,r),e[r]=!0)}this._geometryBuffer._setAttachments(this._engine.buildTextureLayout(e))}}restoreAttachments(){this.enabled&&this._currentTarget.enabled&&this._defaultAttachments&&(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment())}_beforeDraw(e,t,i){this._isDirty&&this._update(),this._enabled&&this._currentTarget.enabled&&(this._geometryBuffer&&(this._geometryBuffer.renderList=[]),this._setupOutputForThisPass(this._currentTarget,e))}_prepareFrame(e,t,i){e.renderTargetTexture?e.renderTargetTexture._prepareFrame(this._scene,t,i,e.renderTargetTexture.useCameraPostProcesses):this._postProcessesSourceForThisPass.length?this._scene.postProcessManager._prepareFrame():this._engine.restoreDefaultFramebuffer()}setCustomOutput(e){const t=this._postProcessesSourceForThisPass[0];return!!t&&(t.inputTexture=e.renderTarget,!0)}_renderPostProcesses(e,t){const i=this._postProcessesSourceForThisPass[0],r=i?i.inputTexture:e.renderTargetTexture?e.renderTargetTexture.renderTarget:null;let s=this._currentTarget._beforeCompositionPostProcesses;this._needsCompositionForThisPass&&(s=s.concat([this._currentTarget.imageProcessingPostProcess])),s.length&&(this._scene.postProcessManager._prepareFrame(this._currentTarget.renderTarget?.texture,s),this._scene.postProcessManager.directRender(s,r,!1,t))}_afterDraw(e,t){this._enabled&&this._currentTarget.enabled&&(this._prepareFrame(this._currentTarget,e,t),this._renderPostProcesses(this._currentTarget,e))}_clear(){this._isDirty&&this._update(),this._enabled&&this._currentTarget.enabled&&(this._bindFrameBuffer(),this._engine.bindAttachments(this._clearAttachments),this._engine.clear(this._clearColor,!0,!1,!1),this._useSpecificClearForDepthTexture&&(this._engine.bindAttachments(this._clearDepthAttachments),this._engine.clear(this._clearDepthColor,!0,!1,!1)),this._engine.bindAttachments(this._defaultAttachments))}_bindFrameBuffer(){if(this._enabled&&this._currentTarget.enabled){this._currentTarget._checkSize();const e=this._currentTarget.renderTarget;e&&this._engine.bindFramebuffer(e)}}_setEnabled(e){this._enabled=e}_setRenderTargetEnabled(e,t){e.enabled=t,t||this._unlinkInternalTexture(e)}addEffectConfiguration(e){for(let t=0;t<this._effectConfigurations.length;t++)if(this._effectConfigurations[t].name===e.name)return this._effectConfigurations[t];return this._effectConfigurations.push(e),e}getEffectConfiguration(e){for(let t=0;t<this._effectConfigurations.length;t++)if(this._effectConfigurations[t].name===e)return this._effectConfigurations[t];return null}_enable(){const e=this.mrtCount;for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled&&this._enableTextures(this._effectConfigurations[e].texturesRequired);for(let t=0;t<this.renderTargets.length;t++){this.mrtCount===e&&this.renderTargets[t].count===this.mrtCount||this.renderTargets[t].updateCount(this.mrtCount,{types:this._mrtTypes,formats:this._mrtFormats},this._mrtNames.concat("prePass_DepthBuffer")),this.renderTargets[t]._resetPostProcessChain();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled&&(!this._effectConfigurations[e].postProcess&&this._effectConfigurations[e].createPostProcess&&this._effectConfigurations[e].createPostProcess(),this._effectConfigurations[e].postProcess&&this.renderTargets[t]._beforeCompositionPostProcesses.push(this._effectConfigurations[e].postProcess))}this._reinitializeAttachments(),this._setEnabled(!0),this._updateGeometryBufferLayout()}_disable(){this._setEnabled(!1);for(let e=0;e<this.renderTargets.length;e++)this._setRenderTargetEnabled(this.renderTargets[e],!1);this._resetLayout();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled=!1}_getPostProcessesSource(e,t){if(t)return t._postProcesses;if(e.renderTargetTexture){if(e.renderTargetTexture.useCameraPostProcesses){const t=e.renderTargetTexture.activeCamera?e.renderTargetTexture.activeCamera:this._scene.activeCamera;return t?t._postProcesses:[]}return e.renderTargetTexture.postProcesses?e.renderTargetTexture.postProcesses:[]}return this._scene.activeCamera?this._scene.activeCamera._postProcesses:[]}_setupOutputForThisPass(e,t){const i=t&&this._scene.activeCameras&&!!this._scene.activeCameras.length&&0!==this._scene.activeCameras.indexOf(t);this._postProcessesSourceForThisPass=this._getPostProcessesSource(e,t),this._postProcessesSourceForThisPass=this._postProcessesSourceForThisPass.filter((e=>null!=e)),this._scene.autoClear=!0;const r=this._hasImageProcessing(this._postProcessesSourceForThisPass);this._needsCompositionForThisPass=!r&&!this.disableGammaTransform&&this._needsImageProcessing()&&!i;const s=this._getFirstPostProcess(this._postProcessesSourceForThisPass),n=e._beforeCompositionPostProcesses&&e._beforeCompositionPostProcesses[0];let o=null;this._scene.imageProcessingConfiguration.applyByPostProcess=this._needsCompositionForThisPass||r,this._needsCompositionForThisPass&&!e.imageProcessingPostProcess&&e._createCompositionEffect(),n?o=n:this._needsCompositionForThisPass?o=e.imageProcessingPostProcess:s&&(o=s),this._bindFrameBuffer(),this._linkInternalTexture(e,o)}_linkInternalTexture(e,t){t&&(t.autoClear=!1,t.inputTexture=e.renderTarget),e._outputPostProcess!==t&&(e._outputPostProcess&&this._unlinkInternalTexture(e),e._outputPostProcess=t),e._internalTextureDirty&&(this._updateGeometryBufferLayout(),e._internalTextureDirty=!1)}_unlinkInternalTexture(e){e._outputPostProcess&&(e._outputPostProcess.autoClear=!0,e._outputPostProcess.restoreDefaultInputTexture(),e._outputPostProcess=null)}_needsImageProcessing(){for(let e=0;e<this._effectConfigurations.length;e++)if(this._effectConfigurations[e].enabled&&this._effectConfigurations[e].needsImageProcessing)return!0;return!1}_hasImageProcessing(e){let t=!1;if(e)for(let i=0;i<e.length;i++)if("ImageProcessingPostProcess"===e[i]?.getClassName()){t=!0;break}return t}_getFirstPostProcess(e){for(let t=0;t<e.length;t++)if(null!==e[t])return e[t];return null}markAsDirty(){this._isDirty=!0}_enableTextures(e){this._scene.needsPreviousWorldMatrices=!1;for(let t=0;t<e.length;t++){const i=e[t];-1===this._textureIndices[i]&&(this._textureIndices[i]=this._mrtLayout.length,this._mrtLayout.push(i),this._mrtTypes.push(aM.TextureFormats[i].type),this._mrtFormats.push(aM.TextureFormats[i].format),this._mrtNames.push(aM.TextureFormats[i].name),this.mrtCount++),2!==i&&11!==i||(this._scene.needsPreviousWorldMatrices=!0)}}update(){this._isDirty&&this._update()}_update(){this._disable();let e,t=!1;this._scene.imageProcessingConfiguration.applyByPostProcess=!1,this._scene._depthPeelingRenderer&&this._scene.useOrderIndependentTransparency&&(this._scene._depthPeelingRenderer.setPrePassRenderer(this),t=!0);for(let e=0;e<this._scene.materials.length;e++)this._scene.materials[e].setPrePassRenderer(this)&&(t=!0);t&&this._setRenderTargetEnabled(this.defaultRT,!0);for(let i=0;i<this.renderTargets.length;i++){if(this.renderTargets[i].renderTargetTexture)e=this._getPostProcessesSource(this.renderTargets[i]);else{const t=this._scene.activeCamera;if(!t)continue;e=t._postProcesses}if(e&&(e=e.filter((e=>null!=e)),e)){for(let r=0;r<e.length;r++)e[r].setPrePassRenderer(this)&&(this._setRenderTargetEnabled(this.renderTargets[i],!0),t=!0);this._hasImageProcessing(e)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!0)}}this._markAllMaterialsAsPrePassDirty(),this._isDirty=!1,t&&this._enable()}_markAllMaterialsAsPrePassDirty(){const e=this._scene.materials;for(let t=0;t<e.length;t++)e[t].markAsDirty(fn.i.PrePassDirtyFlag)}dispose(){for(let e=this.renderTargets.length-1;e>=0;e--)this.renderTargets[e].dispose();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].dispose&&this._effectConfigurations[e].dispose()}}aM._SceneComponentInitialization=e=>{throw(0,Ph.n)("PrePassRendererSceneComponent")},aM.TextureFormats=[{purpose:0,type:2,format:5,name:"prePass_Irradiance"},{purpose:1,type:2,format:5,name:"prePass_Position"},{purpose:2,type:0,format:5,name:"prePass_Velocity"},{purpose:3,type:0,format:5,name:"prePass_Reflectivity"},{purpose:4,type:2,format:5,name:"prePass_Color"},{purpose:5,type:1,format:6,name:"prePass_Depth"},{purpose:6,type:2,format:5,name:"prePass_Normal"},{purpose:7,type:0,format:5,name:"prePass_Albedo"},{purpose:8,type:0,format:5,name:"prePass_WorldNormal"},{purpose:9,type:2,format:5,name:"prePass_LocalPosition"},{purpose:10,type:1,format:6,name:"prePass_ScreenDepth"},{purpose:11,type:2,format:5,name:"prePass_VelocityLinear"}],Object.defineProperty(it.Z.prototype,"prePassRenderer",{get:function(){return this._prePassRenderer},set:function(e){e&&e.isSupported&&(this._prePassRenderer=e)},enumerable:!0,configurable:!0}),it.Z.prototype.enablePrePassRenderer=function(){return this._prePassRenderer||(this._prePassRenderer=new aM(this),this._prePassRenderer.isSupported||(this._prePassRenderer=null,m.V.Error("PrePassRenderer needs WebGL 2 support.\nMaybe you tried to use the following features that need the PrePassRenderer :\n + Subsurface Scattering"))),this._prePassRenderer},it.Z.prototype.disablePrePassRenderer=function(){this._prePassRenderer&&(this._prePassRenderer.dispose(),this._prePassRenderer=null)};class lM{constructor(e){this.name=Ei.v.NAME_PREPASSRENDERER,this.scene=e}register(){this.scene._beforeCameraDrawStage.registerStep(Ei.v.STEP_BEFORECAMERADRAW_PREPASS,this,this._beforeCameraDraw),this.scene._afterCameraDrawStage.registerStep(Ei.v.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterCameraDraw),this.scene._beforeRenderTargetDrawStage.registerStep(Ei.v.STEP_BEFORERENDERTARGETDRAW_PREPASS,this,this._beforeRenderTargetDraw),this.scene._afterRenderTargetDrawStage.registerStep(Ei.v.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterRenderTargetDraw),this.scene._beforeClearStage.registerStep(Ei.v.STEP_BEFORECLEAR_PREPASS,this,this._beforeClearStage),this.scene._beforeRenderTargetClearStage.registerStep(Ei.v.STEP_BEFORERENDERTARGETCLEAR_PREPASS,this,this._beforeRenderTargetClearStage),this.scene._beforeRenderingMeshStage.registerStep(Ei.v.STEP_BEFORERENDERINGMESH_PREPASS,this,this._beforeRenderingMeshStage),this.scene._afterRenderingMeshStage.registerStep(Ei.v.STEP_AFTERRENDERINGMESH_PREPASS,this,this._afterRenderingMeshStage)}_beforeRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._beforeDraw(void 0,t,i))}_afterRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&this.scene.prePassRenderer._afterDraw(t,i)}_beforeRenderTargetClearStage(e){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(e._prePassRenderTarget||(e._prePassRenderTarget=this.scene.prePassRenderer._createRenderTarget(e.name+"_prePassRTT",e)),this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._clear())}_beforeCameraDraw(e){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._beforeDraw(e))}_afterCameraDraw(){this.scene.prePassRenderer&&this.scene.prePassRenderer._afterDraw()}_beforeClearStage(){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._clear())}_beforeRenderingMeshStage(e,t,i,r){if(!r)return;const s=e.getScene();s.prePassRenderer&&s.prePassRenderer.bindAttachmentsForEffect(r,t)}_afterRenderingMeshStage(e){const t=e.getScene();t.prePassRenderer&&t.prePassRenderer.restoreAttachments()}rebuild(){}dispose(){this.scene.disablePrePassRenderer()}}aM._SceneComponentInitialization=e=>{let t=e._getComponent(Ei.v.NAME_PREPASSRENDERER);t||(t=new lM(e),e._addComponent(t))};const hM="fibonacci",cM="#define rcp(x) 1./x\n#define GOLDEN_RATIO 1.618033988749895\n#define TWO_PI 6.2831855\nvec2 Golden2dSeq(int i,float n)\n{return vec2(float(i)/n+(0.5/n),fract(float(i)*rcp(GOLDEN_RATIO)));}\nvec2 SampleDiskGolden(int i,int sampleCount)\n{vec2 f=Golden2dSeq(i,float(sampleCount));return vec2(sqrt(f.x),TWO_PI*f.y);}";qi.l.IncludesShadersStore[hM]=cM;i(96044);const uM="diffusionProfile",dM="uniform vec3 diffusionS[5];uniform float diffusionD[5];uniform float filterRadii[5];";qi.l.IncludesShadersStore[uM]=dM;const pM="subSurfaceScatteringPixelShader",mM="#include<fibonacci>\n#include<helperFunctions>\n#include<subSurfaceScatteringFunctions>\n#include<diffusionProfile>\nvarying vec2 vUV;uniform vec2 texelSize;uniform sampler2D textureSampler;uniform sampler2D irradianceSampler;uniform sampler2D depthSampler;uniform sampler2D albedoSampler;uniform vec2 viewportSize;uniform float metersPerUnit;const float LOG2_E=1.4426950408889634;const float SSS_PIXELS_PER_SAMPLE=4.;const int _SssSampleBudget=40;\n#define rcp(x) 1./x\n#define Sq(x) x*x\n#define SSS_BILATERAL_FILTER true\nvec3 EvalBurleyDiffusionProfile(float r,vec3 S)\n{vec3 exp_13=exp2(((LOG2_E*(-1.0/3.0))*r)*S); \nvec3 expSum=exp_13*(1.+exp_13*exp_13); \nreturn (S*rcp(8.*PI))*expSum; }\nvec2 SampleBurleyDiffusionProfile(float u,float rcpS)\n{u=1.-u; \nfloat g=1.+(4.*u)*(2.*u+sqrt(1.+(4.*u)*u));float n=exp2(log2(g)*(-1.0/3.0)); \nfloat p=(g*n)*n; \nfloat c=1.+p+n; \nfloat d=(3./LOG2_E*2.)+(3./LOG2_E)*log2(u); \nfloat x=(3./LOG2_E)*log2(c)-d; \nfloat rcpExp=((c*c)*c)*rcp((4.*u)*((c*c)+(4.*u)*(4.*u)));float r=x*rcpS;float rcpPdf=(8.*PI*rcpS)*rcpExp; \nreturn vec2(r,rcpPdf);}\nvec3 ComputeBilateralWeight(float xy2,float z,float mmPerUnit,vec3 S,float rcpPdf)\n{\n#ifndef SSS_BILATERAL_FILTER\nz=0.;\n#endif\nfloat r=sqrt(xy2+(z*mmPerUnit)*(z*mmPerUnit));float area=rcpPdf;\n#if SSS_CLAMP_ARTIFACT\nreturn clamp(EvalBurleyDiffusionProfile(r,S)*area,0.0,1.0);\n#else\nreturn EvalBurleyDiffusionProfile(r,S)*area;\n#endif\n}\nvoid EvaluateSample(int i,int n,vec3 S,float d,vec3 centerPosVS,float mmPerUnit,float pixelsPerMm,\nfloat phase,inout vec3 totalIrradiance,inout vec3 totalWeight)\n{float scale =rcp(float(n));float offset=rcp(float(n))*0.5;float sinPhase,cosPhase;sinPhase=sin(phase);cosPhase=cos(phase);vec2 bdp=SampleBurleyDiffusionProfile(float(i)*scale+offset,d);float r=bdp.x;float rcpPdf=bdp.y;float phi=SampleDiskGolden(i,n).y;float sinPhi,cosPhi;sinPhi=sin(phi);cosPhi=cos(phi);float sinPsi=cosPhase*sinPhi+sinPhase*cosPhi; \nfloat cosPsi=cosPhase*cosPhi-sinPhase*sinPhi; \nvec2 vec=r*vec2(cosPsi,sinPsi);vec2 position; \nfloat xy2;position=vUV+round((pixelsPerMm*r)*vec2(cosPsi,sinPsi))*texelSize;xy2 =r*r;vec4 textureSample=texture2D(irradianceSampler,position);float viewZ=texture2D(depthSampler,position).r;vec3 irradiance =textureSample.rgb;if (testLightingForSSS(textureSample.a))\n{float relZ=viewZ-centerPosVS.z;vec3 weight=ComputeBilateralWeight(xy2,relZ,mmPerUnit,S,rcpPdf);totalIrradiance+=weight*irradiance;totalWeight +=weight;}\nelse\n{}}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec4 irradianceAndDiffusionProfile =texture2D(irradianceSampler,vUV);vec3 centerIrradiance=irradianceAndDiffusionProfile.rgb;int diffusionProfileIndex=int(round(irradianceAndDiffusionProfile.a*255.));float centerDepth =0.;vec4 inputColor=texture2D(textureSampler,vUV);bool passedStencilTest=testLightingForSSS(irradianceAndDiffusionProfile.a);if (passedStencilTest)\n{centerDepth=texture2D(depthSampler,vUV).r;}\nif (!passedStencilTest) { \ngl_FragColor=inputColor;return;}\nfloat distScale =1.;vec3 S =diffusionS[diffusionProfileIndex];float d =diffusionD[diffusionProfileIndex];float filterRadius=filterRadii[diffusionProfileIndex];vec2 centerPosNDC=vUV;vec2 cornerPosNDC=vUV+0.5*texelSize;vec3 centerPosVS =vec3(centerPosNDC*viewportSize,1.0)*centerDepth; \nvec3 cornerPosVS =vec3(cornerPosNDC*viewportSize,1.0)*centerDepth; \nfloat mmPerUnit =1000.*(metersPerUnit*rcp(distScale));float unitsPerMm=rcp(mmPerUnit);float unitsPerPixel=2.*abs(cornerPosVS.x-centerPosVS.x);float pixelsPerMm =rcp(unitsPerPixel)*unitsPerMm;float filterArea =PI*Sq(filterRadius*pixelsPerMm);int sampleCount =int(filterArea*rcp(SSS_PIXELS_PER_SAMPLE));int sampleBudget=_SssSampleBudget;int texturingMode=0;vec3 albedo =texture2D(albedoSampler,vUV).rgb;if (distScale==0. || sampleCount<1)\n{\n#ifdef DEBUG_SSS_SAMPLES\nvec3 green=vec3(0.,1.,0.);gl_FragColor=vec4(green,1.0);return;\n#endif\ngl_FragColor=vec4(inputColor.rgb+albedo*centerIrradiance,1.0);return;}\n#ifdef DEBUG_SSS_SAMPLES\nvec3 red =vec3(1.,0.,0.);vec3 blue=vec3(0.,0.,1.);gl_FragColor=vec4(mix(blue,red,clamp(float(sampleCount)/float(sampleBudget),0.0,1.0)),1.0);return;\n#endif\nfloat phase=0.;int n=min(sampleCount,sampleBudget);vec3 centerWeight =vec3(0.); \nvec3 totalIrradiance=vec3(0.);vec3 totalWeight =vec3(0.);for (int i=0; i<n; i++)\n{EvaluateSample(i,n,S,d,centerPosVS,mmPerUnit,pixelsPerMm,\nphase,totalIrradiance,totalWeight);}\ntotalWeight=max(totalWeight,HALF_MIN);gl_FragColor=vec4(inputColor.rgb+albedo*max(totalIrradiance/totalWeight,vec3(0.0)),1.);}";qi.l.ShadersStore[pM]=mM;class fM extends Fi.w{getClassName(){return"SubSurfaceScatteringPostProcess"}constructor(e,t,i,r=null,s,n,o,a=0){super(e,"subSurfaceScattering",["texelSize","viewportSize","metersPerUnit"],["diffusionS","diffusionD","filterRadii","irradianceSampler","depthSampler","albedoSampler"],i,r,s||$e.g.BILINEAR_SAMPLINGMODE,n,o,null,a,"postprocess",void 0,!0),this._scene=t,this.updateEffect(),this.onApplyObservable.add((e=>{if(!t.prePassRenderer||!t.subSurfaceConfiguration)return void m.V.Error("PrePass and subsurface configuration needs to be enabled for subsurface scattering.");const i=this.texelSize;e.setFloat("metersPerUnit",t.subSurfaceConfiguration.metersPerUnit),e.setFloat2("texelSize",i.x,i.y),e.setTexture("irradianceSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(0)]),e.setTexture("depthSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(5)]),e.setTexture("albedoSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(7)]),e.setFloat2("viewportSize",Math.tan(t.activeCamera.fov/2)*t.getEngine().getAspectRatio(t.activeCamera,!0),Math.tan(t.activeCamera.fov/2)),e.setArray3("diffusionS",t.subSurfaceConfiguration.ssDiffusionS),e.setArray("diffusionD",t.subSurfaceConfiguration.ssDiffusionD),e.setArray("filterRadii",t.subSurfaceConfiguration.ssFilterRadii)}))}}class _M{get ssDiffusionS(){return this._ssDiffusionS}get ssDiffusionD(){return this._ssDiffusionD}get ssFilterRadii(){return this._ssFilterRadii}constructor(e){this._ssDiffusionS=[],this._ssFilterRadii=[],this._ssDiffusionD=[],this.enabled=!1,this.needsImageProcessing=!0,this.name=Ei.v.NAME_SUBSURFACE,this.ssDiffusionProfileColors=[],this.metersPerUnit=1,this.texturesRequired=[5,7,4,0],this.addDiffusionProfile(new o.v9(1,1,1)),this._scene=e,_M._SceneComponentInitialization(this._scene)}addDiffusionProfile(e){if(this.ssDiffusionD.length>=5)return m.V.Error("You already reached the maximum number of diffusion profiles."),0;for(let t=0;t<this._ssDiffusionS.length/3;t++)if(this._ssDiffusionS[3*t]===e.r&&this._ssDiffusionS[3*t+1]===e.g&&this._ssDiffusionS[3*t+2]===e.b)return t;return this._ssDiffusionS.push(e.r,e.b,e.g),this._ssDiffusionD.push(Math.max(Math.max(e.r,e.b),e.g)),this._ssFilterRadii.push(this.getDiffusionProfileParameters(e)),this.ssDiffusionProfileColors.push(e),this._ssDiffusionD.length-1}createPostProcess(){return this.postProcess=new fM("subSurfaceScattering",this._scene,1,null,void 0,this._scene.getEngine()),this.postProcess.autoClear=!1,this.postProcess}clearAllDiffusionProfiles(){this._ssDiffusionD=[],this._ssDiffusionS=[],this._ssFilterRadii=[],this.ssDiffusionProfileColors=[]}dispose(){this.clearAllDiffusionProfiles(),this.postProcess&&this.postProcess.dispose()}getDiffusionProfileParameters(e){const t=Math.max(e.r,e.g,e.b);return this._sampleBurleyDiffusionProfile(.997,t)}_sampleBurleyDiffusionProfile(e,t){const i=1+4*(e=1-e)*(2*e+Math.sqrt(1+4*e*e)),r=Math.pow(i,-1/3),s=1+i*r*r+r;return 3*Math.log(s/(4*e))*t}}_M._SceneComponentInitialization=e=>{throw(0,Ph.n)("SubSurfaceSceneComponent")},(0,Ep.ji)(Ei.v.NAME_SUBSURFACE,((e,t)=>{if(void 0!==e.ssDiffusionProfileColors&&null!==e.ssDiffusionProfileColors&&(t.enableSubSurfaceForPrePass(),t.subSurfaceConfiguration))for(let i=0,r=e.ssDiffusionProfileColors.length;i<r;i++){const r=e.ssDiffusionProfileColors[i];t.subSurfaceConfiguration.addDiffusionProfile(new o.v9(r.r,r.g,r.b))}})),Object.defineProperty(it.Z.prototype,"subSurfaceConfiguration",{get:function(){return this._subSurfaceConfiguration},set:function(e){e&&this.enablePrePassRenderer()&&(this._subSurfaceConfiguration=e)},enumerable:!0,configurable:!0}),it.Z.prototype.enableSubSurfaceForPrePass=function(){if(this._subSurfaceConfiguration)return this._subSurfaceConfiguration;const e=this.enablePrePassRenderer();return e?(this._subSurfaceConfiguration=new _M(this),e.addEffectConfiguration(this._subSurfaceConfiguration),this._subSurfaceConfiguration):null},it.Z.prototype.disableSubSurfaceForPrePass=function(){this._subSurfaceConfiguration&&(this._subSurfaceConfiguration.dispose(),this._subSurfaceConfiguration=null)};class gM{constructor(e){this.name=Ei.v.NAME_PREPASSRENDERER,this.scene=e}register(){}serialize(e){if(!this.scene.subSurfaceConfiguration)return;const t=this.scene.subSurfaceConfiguration.ssDiffusionProfileColors;e.ssDiffusionProfileColors=[];for(let i=0;i<t.length;i++)e.ssDiffusionProfileColors.push({r:t[i].r,g:t[i].g,b:t[i].b})}addFromContainer(){}removeFromContainer(){this.scene.prePassRenderer&&this.scene.subSurfaceConfiguration&&this.scene.subSurfaceConfiguration.clearAllDiffusionProfiles()}rebuild(){}dispose(){}}_M._SceneComponentInitialization=e=>{let t=e._getComponent(Ei.v.NAME_SUBSURFACE);t||(t=new gM(e),e._addComponent(t))},it.Z.prototype.getOutlineRenderer=function(){return this._outlineRenderer||(this._outlineRenderer=new xM(this)),this._outlineRenderer},Object.defineProperty(tt.e.prototype,"renderOutline",{get:function(){return this._renderOutline},set:function(e){e&&this.getScene().getOutlineRenderer(),this._renderOutline=e},enumerable:!0,configurable:!0}),Object.defineProperty(tt.e.prototype,"renderOverlay",{get:function(){return this._renderOverlay},set:function(e){e&&this.getScene().getOutlineRenderer(),this._renderOverlay=e},enumerable:!0,configurable:!0});class xM{get shaderLanguage(){return this._shaderLanguage}constructor(e){this.name=Ei.v.NAME_OUTLINERENDERER,this.zOffset=1,this.zOffsetUnits=4,this._shaderLanguage=0,this.scene=e,this._engine=e.getEngine(),this.scene._addComponent(this),this._passIdForDrawWrapper=[];for(let e=0;e<4;++e)this._passIdForDrawWrapper[e]=this._engine.createRenderPassId(`Outline Renderer (${e})`);this._engine.isWebGPU&&(this._shaderLanguage=1)}register(){this.scene._beforeRenderingMeshStage.registerStep(Ei.v.STEP_BEFORERENDERINGMESH_OUTLINE,this,this._beforeRenderingMesh),this.scene._afterRenderingMeshStage.registerStep(Ei.v.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)}rebuild(){}dispose(){for(let e=0;e<this._passIdForDrawWrapper.length;++e)this._engine.releaseRenderPassId(this._passIdForDrawWrapper[e])}render(e,t,i=!1,r){r=r??this._passIdForDrawWrapper[0];const s=this.scene,n=s.getEngine(),o=n.getCaps().instancedArrays&&(null!==t.visibleInstances[e._id]&&void 0!==t.visibleInstances[e._id]||e.getRenderingMesh().hasThinInstances);if(!this.isReady(e,o,r))return;const a=e.getMesh(),l=a._internalAbstractMeshDataInfo._actAsRegularMesh?a:null,h=e.getRenderingMesh(),c=l||h,u=e.getMaterial();if(!u||!s.activeCamera)return;const d=e._getDrawWrapper(r),p=Ah.E.GetEffect(d);n.enableEffect(d),u.useLogarithmicDepth&&p.setFloat("logarithmicDepthConstant",2/(Math.log(s.activeCamera.maxZ+1)/Math.LN2)),p.setFloat("offset",i?0:h.outlineWidth),p.setColor4("color",i?h.overlayColor:h.outlineColor,i?h.overlayAlpha:u.alpha),p.setMatrix("viewProjection",s.getTransformMatrix()),p.setMatrix("world",c.getWorldMatrix()),(0,ts.f$)(h,p),(0,ts.nR)(h,p),h.morphTargetManager&&h.morphTargetManager.isUsingTextureForTargets&&h.morphTargetManager._bind(p),o||h._bind(e,p,u.fillMode);const m=e.getMesh().bakedVertexAnimationManager;if(m&&m.isEnabled&&m.bind(p,o),u&&u.needAlphaTestingForMesh(c)){const e=u.getAlphaTestTexture();e&&(p.setTexture("diffuseSampler",e),p.setMatrix("diffuseMatrix",e.getTextureMatrix()))}(0,es.gS)(p,u,s),n.setZOffset(-this.zOffset),n.setZOffsetUnits(-this.zOffsetUnits),h._processRendering(c,e,p,u.fillMode,t,o,((e,t)=>{p.setMatrix("world",t)})),n.setZOffset(0),n.setZOffsetUnits(0)}isReady(e,t,r){r=r??this._passIdForDrawWrapper[0];const s=[],n=[Ot.R.PositionKind,Ot.R.NormalKind],o=e.getMesh(),a=e.getMaterial();if(!a)return!1;const l=o.getScene();let h=!1,c=!1;a.needAlphaTestingForMesh(o)&&(s.push("#define ALPHATEST"),o.isVerticesDataPresent(Ot.R.UVKind)&&(n.push(Ot.R.UVKind),s.push("#define UV1"),h=!0),o.isVerticesDataPresent(Ot.R.UV2Kind)&&(n.push(Ot.R.UV2Kind),s.push("#define UV2"),c=!0)),a.useLogarithmicDepth&&s.push("#define LOGARITHMICDEPTH"),(0,es.tv)(a,l,s);const u=new Qr.J;if(o.useBones&&o.computeBonesUsingShaders&&o.skeleton){n.push(Ot.R.MatricesIndicesKind),n.push(Ot.R.MatricesWeightsKind),o.numBoneInfluencers>4&&(n.push(Ot.R.MatricesIndicesExtraKind),n.push(Ot.R.MatricesWeightsExtraKind));const e=o.skeleton;s.push("#define NUM_BONE_INFLUENCERS "+o.numBoneInfluencers),o.numBoneInfluencers>0&&u.addCPUSkinningFallback(0,o),e.isUsingTextureForMatrices?s.push("#define BONETEXTURE"):s.push("#define BonesPerMesh "+(e.bones.length+1))}else s.push("#define NUM_BONE_INFLUENCERS 0");const d=o.morphTargetManager?(0,ts.Dk)(o.morphTargetManager,s,n,o,!0,!0,!1,h,c,!1):0;t&&(s.push("#define INSTANCES"),(0,ts.te)(n),e.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES"));const p=o.bakedVertexAnimationManager;p&&p.isEnabled&&(s.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&n.push("bakedVertexAnimationSettingsInstanced"));const m=e._getDrawWrapper(r,!0),f=m.defines,_=s.join("\n");if(f!==_){const e=["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","boneTextureWidth","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],t=["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"];(0,es.TV)(e),m.setEffect(this.scene.getEngine().createEffect("outline",{attributes:n,uniformsNames:e,uniformBuffersNames:[],samplers:t,defines:_,fallbacks:u,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:d},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,13802)),Promise.resolve().then(i.bind(i,85520))]):await Promise.all([Promise.resolve().then(i.bind(i,2641)),Promise.resolve().then(i.bind(i,99899))])}},this.scene.getEngine()),_)}return m.effect.isReady()}_beforeRenderingMesh(e,t,i){if(this._savedDepthWrite=this._engine.getDepthWrite(),e.renderOutline){const r=t.getMaterial();r&&r.needAlphaBlendingForMesh(e)&&(this._engine.cacheStencilState(),this._engine.setDepthWrite(!1),this._engine.setColorWrite(!1),this._engine.setStencilBuffer(!0),this._engine.setStencilOperationPass(7681),this._engine.setStencilFunction(519),this._engine.setStencilMask(xM._StencilReference),this._engine.setStencilFunctionReference(xM._StencilReference),this._engine.stencilStateComposer.useStencilGlobalOnly=!0,this.render(t,i,!0,this._passIdForDrawWrapper[1]),this._engine.setColorWrite(!0),this._engine.setStencilFunction(517)),this._engine.setDepthWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[0]),this._engine.setDepthWrite(this._savedDepthWrite),r&&r.needAlphaBlendingForMesh(e)&&(this._engine.stencilStateComposer.useStencilGlobalOnly=!1,this._engine.restoreStencilState())}}_afterRenderingMesh(e,t,i){if(e.renderOverlay){const e=this._engine.getAlphaMode(),r=this._engine.alphaState.alphaBlend;this._engine.setAlphaMode(2),this.render(t,i,!0,this._passIdForDrawWrapper[3]),this._engine.setAlphaMode(e),this._engine.setDepthWrite(this._savedDepthWrite),this._engine.alphaState.alphaBlend=r}e.renderOutline&&this._savedDepthWrite&&(this._engine.setDepthWrite(!0),this._engine.setColorWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[2]),this._engine.setColorWrite(!0))}}xM._StencilReference=4;var vM,SM=i(11628);class bM{get particleSize(){return this._particleSize}set particleSize(e){e!==this._particleSize&&(this._particleSize=e,this.onParticleSizeChanged.notifyObservers(this))}get useInstancing(){return!this.indexBuffer}get useVelocity(){return this._useVelocity}set useVelocity(e){this._useVelocity!==e&&this._hasVelocity()&&(this._useVelocity=e,this._effectsAreDirty=!0)}_hasVelocity(){return!!this.vertexBuffers?.velocity}get indexBuffer(){return null}getClassName(){return"FluidRenderingObject"}get shaderLanguage(){return this._shaderLanguage}constructor(e,t){this.priority=0,this._particleSize=.1,this.onParticleSizeChanged=new s.cP,this.particleThicknessAlpha=.05,this._useVelocity=!1,this._shaderLanguage=0,this._scene=e,this._engine=e.getEngine(),this._effectsAreDirty=!0,this._depthEffectWrapper=null,this._thicknessEffectWrapper=null,this._shaderLanguage=t??(this._engine.isWebGPU?1:0)}_createEffects(){const e=["view","projection","particleRadius","size"],t=["position","offset"],r=[];this._effectsAreDirty=!1,this.useVelocity&&(t.push("velocity"),r.push("#define FLUIDRENDERING_VELOCITY")),this._scene.useRightHandedSystem&&r.push("#define FLUIDRENDERING_RHS"),this._depthEffectWrapper=new Bi.$({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleDepth",fragmentShader:"fluidRenderingParticleDepth",attributeNames:t,uniformNames:e,samplerNames:[],defines:r,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,27499)),Promise.resolve().then(i.bind(i,67297))]):await Promise.all([Promise.resolve().then(i.bind(i,13172)),Promise.resolve().then(i.bind(i,3934))])}}),e.push("particleAlpha"),this._thicknessEffectWrapper=new Bi.$({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleThickness",fragmentShader:"fluidRenderingParticleThickness",attributeNames:["position","offset"],uniformNames:e,samplerNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,63866)),Promise.resolve().then(i.bind(i,84556))]):await Promise.all([Promise.resolve().then(i.bind(i,54577)),Promise.resolve().then(i.bind(i,49079))])}})}isReady(){if(this._effectsAreDirty&&this._createEffects(),!this._depthEffectWrapper||!this._thicknessEffectWrapper)return!1;const e=this._depthEffectWrapper.drawWrapper.effect,t=this._thicknessEffectWrapper.drawWrapper.effect;return e.isReady()&&t.isReady()}renderDepthTexture(){const e=this.numParticles;if(!this._depthEffectWrapper||0===e)return;const t=this._depthEffectWrapper.drawWrapper,i=t.effect;this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),i.setFloat2("size",this._particleSize,this._particleSize),i.setFloat("particleRadius",this._particleSize/2),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e)}renderThicknessTexture(){const e=this.numParticles;if(!this._thicknessEffectWrapper||0===e)return;const t=this._thicknessEffectWrapper.drawWrapper,i=t.effect;this._engine.setAlphaMode(6),this._engine.setDepthWrite(!1),this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),i.setFloat("particleAlpha",this.particleThicknessAlpha),i.setFloat2("size",this._particleSize,this._particleSize),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e),this._engine.setDepthWrite(!0),this._engine.setAlphaMode(0)}renderDiffuseTexture(){}dispose(){this._depthEffectWrapper?.dispose(!1),this._thicknessEffectWrapper?.dispose(!1),this.onParticleSizeChanged.clear()}}class yM extends bM{get particleSystem(){return this._particleSystem}getClassName(){return"FluidRenderingObjectParticleSystem"}get useTrueRenderingForDiffuseTexture(){return this._useTrueRenderingForDiffuseTexture}set useTrueRenderingForDiffuseTexture(e){this._useTrueRenderingForDiffuseTexture!==e&&(this._useTrueRenderingForDiffuseTexture=e,e?(this._particleSystem.blendMode=this._blendMode,this._particleSystem.onBeforeDrawParticlesObservable.remove(this._onBeforeDrawParticleObserver),this._onBeforeDrawParticleObserver=null):(this._particleSystem.blendMode=-1,this._onBeforeDrawParticleObserver=this._particleSystem.onBeforeDrawParticlesObservable.add((()=>{this._engine.setAlphaMode(2)}))))}get vertexBuffers(){return this._particleSystem.vertexBuffers}get indexBuffer(){return this._particleSystem.indexBuffer}constructor(e,t,i){super(e,i),this._useTrueRenderingForDiffuseTexture=!0,this._particleSystem=t,this._originalRender=t.render.bind(t),this._blendMode=t.blendMode,this._onBeforeDrawParticleObserver=null,this._updateInAnimate=this._particleSystem.updateInAnimate,this._particleSystem.updateInAnimate=!0,this._particleSystem.render=()=>0,this.particleSize=(t.minSize+t.maxSize)/2,this.useTrueRenderingForDiffuseTexture=!1}isReady(){return super.isReady()&&this._particleSystem.isReady()}get numParticles(){return this._particleSystem.getActiveCount()}renderDiffuseTexture(){this._originalRender()}dispose(){super.dispose(),this._particleSystem.onBeforeDrawParticlesObservable.remove(this._onBeforeDrawParticleObserver),this._onBeforeDrawParticleObserver=null,this._particleSystem.render=this._originalRender,this._particleSystem.blendMode=this._blendMode,this._particleSystem.updateInAnimate=this._updateInAnimate}}class PM{get blurNumIterations(){return this._blurNumIterations}set blurNumIterations(e){if(this._blurNumIterations!==e&&(this._blurNumIterations=e,null!==this._blurPostProcesses)){const e=this._blurPostProcesses[0],t=this._blurPostProcesses[1];this._blurPostProcesses=[];for(let i=0;i<2*this._blurNumIterations;++i)this._blurPostProcesses[i]=1&i?t:e}}get renderTarget(){return this._rt}get renderTargetBlur(){return this._rtBlur}get texture(){return this._texture}get textureBlur(){return this._textureBlurred}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,r,n,o,a=1,l=6,h=1,c=6,u=!1,d=null,p=!0,m=1,f){this.enableBlur=!0,this.blurSizeDivisor=1,this.blurFilterSize=7,this._blurNumIterations=3,this.blurMaxFilterSize=100,this.blurDepthScale=10,this.particleSize=.02,this.onDisposeObservable=new s.cP,this._shaderLanguage=0,this._name=e,this._scene=t,this._camera=d,this._engine=t.getEngine(),this._width=i,this._height=r,this._blurTextureSizeX=n,this._blurTextureSizeY=o,this._textureType=a,this._textureFormat=l,this._blurTextureType=h,this._blurTextureFormat=c,this._useStandardBlur=u,this._generateDepthBuffer=p,this._samples=m,this._postProcessRunningIndex=0,this.enableBlur=0!==n&&0!==o,this._rt=null,this._texture=null,this._rtBlur=null,this._textureBlurred=null,this._blurPostProcesses=null,this._shaderLanguage=f??(this._engine.isWebGPU?1:0)}initialize(){if(this.dispose(),this._createRenderTarget(),this.enableBlur&&this._texture){const[e,t,i]=this._createBlurPostProcesses(this._texture,this._blurTextureType,this._blurTextureFormat,this.blurSizeDivisor,this._name,this._useStandardBlur);this._rtBlur=e,this._textureBlurred=t,this._blurPostProcesses=i}}applyBlurPostProcesses(){this.enableBlur&&this._blurPostProcesses&&(this._postProcessRunningIndex=0,this._scene.postProcessManager.directRender(this._blurPostProcesses,this._rtBlur,!0),this._engine.unBindFramebuffer(this._rtBlur))}_createRenderTarget(){this._rt=this._engine.createRenderTargetTexture({width:this._width,height:this._height},{generateMipMaps:!1,type:this._textureType,format:this._textureFormat,samplingMode:1,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:!1,samples:this._samples,label:`FluidRenderingRTT-${this._name}`});const e=this._rt.texture;e.incrementReferences(),this._texture=new $e.g(null,this._scene),this._texture.name="rtt"+this._name,this._texture._texture=e,this._texture.wrapU=$e.g.CLAMP_ADDRESSMODE,this._texture.wrapV=$e.g.CLAMP_ADDRESSMODE,this._texture.anisotropicFilteringLevel=1}_createBlurPostProcesses(e,t,r,s,o,a=!1){const l=this._scene.getEngine(),h=new n.I9(Math.floor(this._blurTextureSizeX/s),Math.floor(this._blurTextureSizeY/s)),c=1===t&&l.getCaps().textureFloatLinearFiltering||2===t&&l.getCaps().textureHalfFloatLinearFiltering,u=this._engine.createRenderTargetTexture({width:h.x,height:h.y},{generateMipMaps:!1,type:t,format:r,samplingMode:c?2:1,generateDepthBuffer:!1,generateStencilBuffer:!1,samples:this._samples,label:`FluidRenderingRTTBlur-${o}`}),d=u.texture;d.incrementReferences();const p=new $e.g(null,this._scene);if(p.name="rttBlurred"+o,p._texture=d,p.wrapU=$e.g.CLAMP_ADDRESSMODE,p.wrapV=$e.g.CLAMP_ADDRESSMODE,p.anisotropicFilteringLevel=1,a){const s=new Fi.w("BilateralBlurX","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,l,!0,null,t,void 0,void 0,void 0,r,this._shaderLanguage,(async()=>{1===this.shaderLanguage?await Promise.resolve().then(i.bind(i,21570)):await Promise.resolve().then(i.bind(i,75679))}));s.samples=this._samples,s.externalTextureSamplerBinding=!0,s.onApplyObservable.add((t=>{0===this._postProcessRunningIndex?t.setTexture("textureSampler",e):t._bindTexture("textureSampler",s.inputTexture.texture),t.setInt("filterSize",this.blurFilterSize),t.setFloat2("blurDir",1/this._blurTextureSizeX,0),this._postProcessRunningIndex++})),s.onSizeChangedObservable.add((()=>{s._textures.forEach((e=>{e.texture.wrapU=$e.g.CLAMP_ADDRESSMODE,e.texture.wrapV=$e.g.CLAMP_ADDRESSMODE}))})),this._fixReusablePostProcess(s);const n=new Fi.w("BilateralBlurY","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,l,!0,null,t,void 0,void 0,void 0,r,this._shaderLanguage,(async()=>{1===this.shaderLanguage?await Promise.resolve().then(i.bind(i,21570)):await Promise.resolve().then(i.bind(i,75679))}));n.samples=this._samples,n.onApplyObservable.add((e=>{e.setInt("filterSize",this.blurFilterSize),e.setFloat2("blurDir",0,1/this._blurTextureSizeY),this._postProcessRunningIndex++})),n.onSizeChangedObservable.add((()=>{n._textures.forEach((e=>{e.texture.wrapU=$e.g.CLAMP_ADDRESSMODE,e.texture.wrapV=$e.g.CLAMP_ADDRESSMODE}))})),this._fixReusablePostProcess(n),s.autoClear=!1,n.autoClear=!1;const o=[];for(let e=0;e<2*this._blurNumIterations;++e)o[e]=1&e?n:s;return[u,p,o]}{const s=["maxFilterSize","blurDir","projectedParticleConstant","depthThreshold"],n=new Fi.w("BilateralBlurX","fluidRenderingBilateralBlur",s,null,1,null,1,l,!0,null,t,void 0,void 0,void 0,r,this._shaderLanguage,(async()=>{1===this.shaderLanguage?await Promise.resolve().then(i.bind(i,97163)):await Promise.resolve().then(i.bind(i,91932))}));n.samples=this._samples,n.externalTextureSamplerBinding=!0,n.onApplyObservable.add((t=>{0===this._postProcessRunningIndex?t.setTexture("textureSampler",e):t._bindTexture("textureSampler",n.inputTexture.texture),t.setInt("maxFilterSize",this.blurMaxFilterSize),t.setFloat2("blurDir",1/this._blurTextureSizeX,0),t.setFloat("projectedParticleConstant",this._getProjectedParticleConstant()),t.setFloat("depthThreshold",this._getDepthThreshold()),this._postProcessRunningIndex++})),n.onSizeChangedObservable.add((()=>{n._textures.forEach((e=>{e.texture.wrapU=$e.g.CLAMP_ADDRESSMODE,e.texture.wrapV=$e.g.CLAMP_ADDRESSMODE}))})),this._fixReusablePostProcess(n);const o=new Fi.w("BilateralBlurY","fluidRenderingBilateralBlur",s,null,1,null,1,l,!0,null,t,void 0,void 0,void 0,r,this._shaderLanguage,(async()=>{1===this.shaderLanguage?await Promise.resolve().then(i.bind(i,97163)):await Promise.resolve().then(i.bind(i,91932))}));o.samples=this._samples,o.onApplyObservable.add((e=>{e.setInt("maxFilterSize",this.blurMaxFilterSize),e.setFloat2("blurDir",0,1/this._blurTextureSizeY),e.setFloat("projectedParticleConstant",this._getProjectedParticleConstant()),e.setFloat("depthThreshold",this._getDepthThreshold()),this._postProcessRunningIndex++})),o.onSizeChangedObservable.add((()=>{o._textures.forEach((e=>{e.texture.wrapU=$e.g.CLAMP_ADDRESSMODE,e.texture.wrapV=$e.g.CLAMP_ADDRESSMODE}))})),this._fixReusablePostProcess(o),n.autoClear=!1,o.autoClear=!1;const a=[];for(let e=0;e<2*this._blurNumIterations;++e)a[e]=1&e?o:n;return[u,p,a]}}_fixReusablePostProcess(e){e.isReusable()&&(e.onActivateObservable.add((()=>{e._currentRenderTextureInd=(e._currentRenderTextureInd+1)%2})),e.onApplyObservable.add((()=>{e._currentRenderTextureInd=(e._currentRenderTextureInd+1)%2})))}_getProjectedParticleConstant(){return this.blurFilterSize*this.particleSize*.05*(this._height/2)/Math.tan((this._camera?.fov??45*Math.PI/180)/2)}_getDepthThreshold(){return this.particleSize/2*this.blurDepthScale}dispose(){this.onDisposeObservable.hasObservers()&&this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._rt?.dispose(),this._rt=null,this._texture?.dispose(),this._texture=null,this._rtBlur?.dispose(),this._rtBlur=null,this._textureBlurred?.dispose(),this._textureBlurred=null,this._blurPostProcesses&&(this._blurPostProcesses[0].dispose(),this._blurPostProcesses[1].dispose()),this._blurPostProcesses=null}}!function(e){e[e.DepthTexture=0]="DepthTexture",e[e.DepthBlurredTexture=1]="DepthBlurredTexture",e[e.ThicknessTexture=2]="ThicknessTexture",e[e.ThicknessBlurredTexture=3]="ThicknessBlurredTexture",e[e.DiffuseTexture=4]="DiffuseTexture",e[e.Normals=5]="Normals",e[e.DiffuseRendering=6]="DiffuseRendering"}(vM||(vM={}));class TM{get needInitialization(){return this._needInitialization}get generateDiffuseTexture(){return this._generateDiffuseTexture}set generateDiffuseTexture(e){this._generateDiffuseTexture!==e&&(this._generateDiffuseTexture=e,this._needInitialization=!0)}get debugFeature(){return this._debugFeature}set debugFeature(e){this._debugFeature!==e&&(this._needInitialization=!0,this._debugFeature=e)}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._needInitialization=!0)}get environmentMap(){return this._environmentMap}set environmentMap(e){this._environmentMap!==e&&(this._needInitialization=!0,this._environmentMap=e)}get enableBlurDepth(){return this._enableBlurDepth}set enableBlurDepth(e){this._enableBlurDepth!==e&&(this._enableBlurDepth=e,this._needInitialization=!0)}get blurDepthSizeDivisor(){return this._blurDepthSizeDivisor}set blurDepthSizeDivisor(e){this._blurDepthSizeDivisor!==e&&(this._blurDepthSizeDivisor=e,this._needInitialization=!0)}get blurDepthFilterSize(){return this._blurDepthFilterSize}set blurDepthFilterSize(e){this._blurDepthFilterSize!==e&&(this._blurDepthFilterSize=e,this._setBlurParameters())}get blurDepthNumIterations(){return this._blurDepthNumIterations}set blurDepthNumIterations(e){this._blurDepthNumIterations!==e&&(this._blurDepthNumIterations=e,this._setBlurParameters())}get blurDepthMaxFilterSize(){return this._blurDepthMaxFilterSize}set blurDepthMaxFilterSize(e){this._blurDepthMaxFilterSize!==e&&(this._blurDepthMaxFilterSize=e,this._setBlurParameters())}get blurDepthDepthScale(){return this._blurDepthDepthScale}set blurDepthDepthScale(e){this._blurDepthDepthScale!==e&&(this._blurDepthDepthScale=e,this._setBlurParameters())}get enableBlurThickness(){return this._enableBlurThickness}set enableBlurThickness(e){this._enableBlurThickness!==e&&(this._enableBlurThickness=e,this._needInitialization=!0)}get blurThicknessSizeDivisor(){return this._blurThicknessSizeDivisor}set blurThicknessSizeDivisor(e){this._blurThicknessSizeDivisor!==e&&(this._blurThicknessSizeDivisor=e,this._needInitialization=!0)}get blurThicknessFilterSize(){return this._blurThicknessFilterSize}set blurThicknessFilterSize(e){this._blurThicknessFilterSize!==e&&(this._blurThicknessFilterSize=e,this._setBlurParameters())}get blurThicknessNumIterations(){return this._blurThicknessNumIterations}set blurThicknessNumIterations(e){this._blurThicknessNumIterations!==e&&(this._blurThicknessNumIterations=e,this._setBlurParameters())}get useFixedThickness(){return this._useFixedThickness}set useFixedThickness(e){this._useFixedThickness!==e&&(this._useFixedThickness=e,this._needInitialization=!0)}get useVelocity(){return this._useVelocity}set useVelocity(e){this._useVelocity!==e&&(this._useVelocity=e,this._needInitialization=!0,this._onUseVelocityChanged.notifyObservers(this))}get depthMapSize(){return this._depthMapSize}set depthMapSize(e){this._depthMapSize!==e&&(this._depthMapSize=e,this._needInitialization=!0)}get thicknessMapSize(){return this._thicknessMapSize}set thicknessMapSize(e){this._thicknessMapSize!==e&&(this._thicknessMapSize=e,this._needInitialization=!0)}get diffuseMapSize(){return this._diffuseMapSize}set diffuseMapSize(e){this._diffuseMapSize!==e&&(this._diffuseMapSize=e,this._needInitialization=!0)}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._needInitialization=!0)}get compositeMode(){return this._compositeMode}set compositeMode(e){this._compositeMode!==e&&(this._compositeMode=e,this._needInitialization=!0)}get camera(){return this._camera}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i){this._generateDiffuseTexture=!1,this.fluidColor=new o.v9(.085,.6375,.765),this.density=2,this.refractionStrength=.1,this.fresnelClamp=1,this.specularPower=250,this.minimumThickness=0,this.dirLight=new n.Pq(-2,-1,1).normalize(),this._debugFeature=1,this._debug=!1,this._enableBlurDepth=!0,this._blurDepthSizeDivisor=1,this._blurDepthFilterSize=7,this._blurDepthNumIterations=3,this._blurDepthMaxFilterSize=100,this._blurDepthDepthScale=10,this._enableBlurThickness=!0,this._blurThicknessSizeDivisor=1,this._blurThicknessFilterSize=5,this._blurThicknessNumIterations=1,this._useFixedThickness=!1,this._onUseVelocityChanged=new s.cP,this._useVelocity=!1,this._depthMapSize=null,this._thicknessMapSize=null,this._diffuseMapSize=null,this._samples=1,this._compositeMode=!1,this._shaderLanguage=0,this._scene=e,this._engine=e.getEngine(),this._camera=t??e.activeCamera,this._needInitialization=!0,this._bgDepthTexture=null,this._invProjectionMatrix=new n.uq,this._depthClearColor=new o.ov(1e6,1e6,1e6,1),this._thicknessClearColor=new o.ov(0,0,0,1),this._depthRenderTarget=null,this._diffuseRenderTarget=null,this._thicknessRenderTarget=null,this._renderPostProcess=null,this._shaderLanguage=i??(this._engine.isWebGPU?1:0)}_initialize(){this.dispose(),this._needInitialization=!1;const e=this._depthMapSize??this._engine.getRenderWidth(),t=null!==this._depthMapSize?Math.round(this._depthMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();if(this._depthRenderTarget=new PM("Depth",this._scene,e,t,e,t,1,7,1,7,!1,this._camera,!0,this._samples,this._shaderLanguage),this._initializeRenderTarget(this._depthRenderTarget),this.generateDiffuseTexture){const e=this._diffuseMapSize??this._engine.getRenderWidth(),t=null!==this._diffuseMapSize?Math.round(this._diffuseMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._diffuseRenderTarget=new PM("Diffuse",this._scene,e,t,0,0,0,5,0,5,!0,this._camera,!0,this._samples,this._shaderLanguage),this._initializeRenderTarget(this._diffuseRenderTarget)}const i=this._thicknessMapSize??this._engine.getRenderWidth(),r=null!==this._thicknessMapSize?Math.round(this._thicknessMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._useFixedThickness||(this._thicknessRenderTarget=new PM("Thickness",this._scene,i,r,i,r,2,6,2,6,!0,this._camera,!1,this._samples,this._shaderLanguage),this._initializeRenderTarget(this._thicknessRenderTarget)),this._createLiquidRenderingPostProcess()}_setBlurParameters(e=null){null!==e&&e!==this._depthRenderTarget||this._setBlurDepthParameters(),null!==e&&e!==this._thicknessRenderTarget||this._setBlurThicknessParameters()}_setBlurDepthParameters(){this._depthRenderTarget&&(this._depthRenderTarget.blurFilterSize=this.blurDepthFilterSize,this._depthRenderTarget.blurMaxFilterSize=this.blurDepthMaxFilterSize,this._depthRenderTarget.blurNumIterations=this.blurDepthNumIterations,this._depthRenderTarget.blurDepthScale=this.blurDepthDepthScale)}_setBlurThicknessParameters(){this._thicknessRenderTarget&&(this._thicknessRenderTarget.blurFilterSize=this.blurThicknessFilterSize,this._thicknessRenderTarget.blurNumIterations=this.blurThicknessNumIterations)}_initializeRenderTarget(e){e!==this._diffuseRenderTarget&&(e.enableBlur=e===this._depthRenderTarget?this.enableBlurDepth:this.enableBlurThickness,e.blurSizeDivisor=e===this._depthRenderTarget?this.blurDepthSizeDivisor:this.blurThicknessSizeDivisor),this._setBlurParameters(e),e.initialize()}_createLiquidRenderingPostProcess(){const e=this._scene.getEngine(),t=["viewMatrix","projectionMatrix","invProjectionMatrix","texelSize","dirLight","cameraFar","density","refractionStrength","fresnelClamp","specularPower"],r=["depthSampler"],s=[];if(this.dispose(!0),!this._camera)return;const o=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture,a=new n.I9(1/o.getSize().width,1/o.getSize().height);if(this._scene.useRightHandedSystem&&s.push("#define FLUIDRENDERING_RHS"),null!==this._environmentMap){(this._environmentMap??this._scene.environmentTexture)&&(r.push("reflectionSampler"),s.push("#define FLUIDRENDERING_ENVIRONMENT"))}this._diffuseRenderTarget?(r.push("diffuseSampler"),s.push("#define FLUIDRENDERING_DIFFUSETEXTURE")):t.push("diffuseColor"),this._useVelocity&&(r.push("velocitySampler"),s.push("#define FLUIDRENDERING_VELOCITY")),this._useFixedThickness?(t.push("thickness"),r.push("bgDepthSampler"),s.push("#define FLUIDRENDERING_FIXED_THICKNESS")):(t.push("minimumThickness"),r.push("thicknessSampler")),this._compositeMode&&s.push("#define FLUIDRENDERING_COMPOSITE_MODE"),this._debug&&(s.push("#define FLUIDRENDERING_DEBUG"),5===this._debugFeature?s.push("#define FLUIDRENDERING_DEBUG_SHOWNORMAL"):6===this._debugFeature?s.push("#define FLUIDRENDERING_DEBUG_DIFFUSERENDERING"):(s.push("#define FLUIDRENDERING_DEBUG_TEXTURE"),r.push("debugSampler"),0!==this._debugFeature&&1!==this._debugFeature||s.push("#define FLUIDRENDERING_DEBUG_DEPTH"))),this._renderPostProcess=new Fi.w("FluidRendering","fluidRenderingRender",t,r,1,null,2,e,!1,null,0,void 0,void 0,!0,void 0,this._shaderLanguage,(async()=>{1===this._shaderLanguage?await Promise.resolve().then(i.bind(i,52150)):await Promise.resolve().then(i.bind(i,3399))})),this._renderPostProcess.updateEffect(s.join("\n")),this._renderPostProcess.samples=this._samples;const l=e,h=l.setTextureSampler;this._renderPostProcess.onApplyObservable.add((e=>{if(this._invProjectionMatrix.copyFrom(this._scene.getProjectionMatrix()),this._invProjectionMatrix.invert(),h&&h.call(l,"textureSamplerSampler",this._renderPostProcess.inputTexture.texture),this._depthRenderTarget.enableBlur?(e.setTexture("depthSampler",this._depthRenderTarget.textureBlur),h&&h.call(l,"depthSamplerSampler",this._depthRenderTarget.textureBlur?.getInternalTexture()??null)):(e.setTexture("depthSampler",this._depthRenderTarget.texture),h&&h.call(l,"depthSamplerSampler",this._depthRenderTarget.texture?.getInternalTexture()??null)),this._diffuseRenderTarget?this._diffuseRenderTarget.enableBlur?(e.setTexture("diffuseSampler",this._diffuseRenderTarget.textureBlur),h&&h.call(l,"diffuseSamplerSampler",this._diffuseRenderTarget.textureBlur?.getInternalTexture()??null)):(e.setTexture("diffuseSampler",this._diffuseRenderTarget.texture),h&&h.call(l,"diffuseSamplerSampler",this._diffuseRenderTarget.texture?.getInternalTexture()??null)):e.setColor3("diffuseColor",this.fluidColor),this._useFixedThickness?(e.setFloat("thickness",this.minimumThickness),e._bindTexture("bgDepthSampler",this._bgDepthTexture),h&&h.call(l,"bgDepthSamplerSampler",this._bgDepthTexture??null)):(this._thicknessRenderTarget.enableBlur?(e.setTexture("thicknessSampler",this._thicknessRenderTarget.textureBlur),h&&h.call(l,"thicknessSamplerSampler",this._thicknessRenderTarget.textureBlur?.getInternalTexture()??null)):(e.setTexture("thicknessSampler",this._thicknessRenderTarget.texture),h&&h.call(l,"thicknessSamplerSampler",this._thicknessRenderTarget.texture?.getInternalTexture()??null)),e.setFloat("minimumThickness",this.minimumThickness)),null!==this._environmentMap){const t=this._environmentMap??this._scene.environmentTexture;t&&(e.setTexture("reflectionSampler",t),h&&h.call(l,"reflectionSamplerSampler",t?.getInternalTexture()??null))}if(e.setMatrix("viewMatrix",this._scene.getViewMatrix()),e.setMatrix("invProjectionMatrix",this._invProjectionMatrix),e.setMatrix("projectionMatrix",this._scene.getProjectionMatrix()),e.setVector2("texelSize",a),e.setFloat("density",this.density),e.setFloat("refractionStrength",this.refractionStrength),e.setFloat("fresnelClamp",this.fresnelClamp),e.setFloat("specularPower",this.specularPower),e.setVector3("dirLight",this.dirLight),e.setFloat("cameraFar",this._camera.maxZ),this._debug){let t=null;switch(this._debugFeature){case 0:t=this._depthRenderTarget.texture;break;case 1:t=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture;break;case 2:t=this._thicknessRenderTarget?.texture??null;break;case 3:t=this._thicknessRenderTarget?.enableBlur?this._thicknessRenderTarget?.textureBlur??null:this._thicknessRenderTarget?.texture??null;break;case 4:this._diffuseRenderTarget&&(t=this._diffuseRenderTarget.texture)}5!==this._debugFeature&&(e.setTexture("debugSampler",t),h&&h.call(l,"debugSamplerSampler",t?.getInternalTexture()??null))}}))}_clearTargets(){this._depthRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),this._engine.clear(this._depthClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),this._diffuseRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),this._thicknessRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!1,!1),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget))}_render(e){if(this._needInitialization||!e.isReady())return;const t=this._engine._currentRenderTarget;this._engine.setState(!1,void 0,void 0,void 0,!0),this._engine.setDepthBuffer(!0),this._engine.setDepthWrite(!0),this._engine.setAlphaMode(0),this._depthRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),e.renderDepthTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),this._diffuseRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),e.renderDiffuseTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),this._thicknessRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),e.renderThicknessTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget)),this._depthRenderTarget?.applyBlurPostProcesses(),this._diffuseRenderTarget?.applyBlurPostProcesses(),this._thicknessRenderTarget?.applyBlurPostProcesses(),t&&this._engine.bindFramebuffer(t)}dispose(e=!1){e||(this._depthRenderTarget?.dispose(),this._depthRenderTarget=null,this._diffuseRenderTarget?.dispose(),this._diffuseRenderTarget=null,this._thicknessRenderTarget?.dispose(),this._thicknessRenderTarget=null),this._renderPostProcess&&this._camera&&this._camera.detachPostProcess(this._renderPostProcess),this._renderPostProcess?.dispose(),this._renderPostProcess=null,this._onUseVelocityChanged.clear(),this._needInitialization=!1}}class CM extends bM{getClassName(){return"FluidRenderingObjectCustomParticles"}get vertexBuffers(){return this._vertexBuffers}constructor(e,t,i,r){super(e,r),this._numParticles=i,this._diffuseEffectWrapper=null,this._vertexBuffers={},this.addBuffers(t)}addBuffers(e){for(const t in e){let i,r=!0;switch(t){case"velocity":i=3;break;case"offset":r=!1}this._vertexBuffers[t]=new Ot.R(this._engine,e[t],t,!0,!1,i,r)}}_createEffects(){super._createEffects();this._diffuseEffectWrapper=new Bi.$({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleDiffuse",fragmentShader:"fluidRenderingParticleDiffuse",attributeNames:["position","offset","color"],uniformNames:["view","projection","size"],samplerNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.resolve().then(i.bind(i,75636)):await Promise.resolve().then(i.bind(i,23483))}})}isReady(){return this._vertexBuffers.offset||(this._vertexBuffers.offset=new Ot.R(this._engine,[0,0,1,0,0,1,1,1],"offset",!1,!1,2)),super.isReady()&&(this._diffuseEffectWrapper?.effect.isReady()??!1)}get numParticles(){return this._numParticles}setNumParticles(e){this._numParticles=e}renderDiffuseTexture(){const e=this.numParticles;if(!this._diffuseEffectWrapper||0===e)return;const t=this._diffuseEffectWrapper.drawWrapper,i=t.effect;this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),null!==this._particleSize&&i.setFloat2("size",this._particleSize,this._particleSize),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e)}dispose(){super.dispose(),this._diffuseEffectWrapper?.dispose();for(const e in this._vertexBuffers)this._vertexBuffers[e].dispose();this._vertexBuffers={}}}class EM{get depthRTWrapper(){return this._depthRTWrapper}constructor(e,t,i,r=1){this._engine=e,this._copyTextureToTexture=new oh(e,!0),this._depthRTWrapper=this._engine.createRenderTargetTexture({width:t,height:i},{generateMipMaps:!1,type:0,format:6,samplingMode:1,generateDepthBuffer:!0,generateStencilBuffer:!1,samples:r,noColorAttachment:!0,label:"FluidRenderingDepthTextureCopyRTT"});this._depthRTWrapper.createDepthStencilTexture(0,!1,!1,1,void 0,"FluidRenderingDepthTextureCopyRTTDepthStencil").label=`FluidDepthTextureCopy${t}x${i}x${r}`}copy(e){return this._copyTextureToTexture.copy(e,this._depthRTWrapper)}dispose(){this._depthRTWrapper.dispose(),this._copyTextureToTexture.dispose()}}function AM(e){return!!e.particleSystem}function IM(e){return!!e.addBuffers}Object.defineProperty(it.Z.prototype,"fluidRenderer",{get:function(){return this._fluidRenderer},set:function(e){this._fluidRenderer=e},enumerable:!0,configurable:!0}),it.Z.prototype.enableFluidRenderer=function(){return this._fluidRenderer||(this._fluidRenderer=new MM(this)),this._fluidRenderer},it.Z.prototype.disableFluidRenderer=function(){this._fluidRenderer?.dispose(),this._fluidRenderer=null};class RM{constructor(e){this.name=Ei.v.NAME_FLUIDRENDERER,this.scene=e}register(){this.scene._gatherActiveCameraRenderTargetsStage.registerStep(Ei.v.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER,this,this._gatherActiveCameraRenderTargets),this.scene._afterCameraDrawStage.registerStep(Ei.v.STEP_AFTERCAMERADRAW_FLUIDRENDERER,this,this._afterCameraDraw)}_gatherActiveCameraRenderTargets(e){this.scene.fluidRenderer?._prepareRendering()}_afterCameraDraw(e){this.scene.fluidRenderer?._render(e)}rebuild(){const e=this.scene.fluidRenderer;if(!e)return;const t=new Set;for(let i=0;i<e.renderObjects.length;++i){const r=e.renderObjects[i].object;if(IM(r)){const e=r.vertexBuffers;for(const i in e)t.add(e[i].getWrapperBuffer())}}t.forEach((e=>{e._rebuild()}))}dispose(){this.scene.disableFluidRenderer()}}class MM{static _SceneComponentInitialization(e){let t=e._getComponent(Ei.v.NAME_FLUIDRENDERER);t||(t=new RM(e),e._addComponent(t))}get shaderLanguage(){return this._shaderLanguage}constructor(e){this._shaderLanguage=0,this._scene=e,this._engine=e.getEngine(),this._onEngineResizeObserver=null,this.renderObjects=[],this.targetRenderers=[],this._cameras=new Map,MM._SceneComponentInitialization(this._scene),this._onEngineResizeObserver=this._engine.onResizeObservable.add((()=>{this._initialize()}));this._engine.isWebGPU&&(this._shaderLanguage=1)}recreate(){this._sortRenderingObjects(),this._initialize()}getRenderObjectFromParticleSystem(e){const t=this._getParticleSystemIndex(e);return-1!==t?this.renderObjects[t]:null}addParticleSystem(e,t,i,r){const s=new yM(this._scene,e,this._shaderLanguage);s.onParticleSizeChanged.add((()=>this._setParticleSizeForRenderTargets())),i||(i=new TM(this._scene,r,this._shaderLanguage),this.targetRenderers.push(i)),i._onUseVelocityChanged.hasObservers()||i._onUseVelocityChanged.add((()=>this._setUseVelocityForRenderObject())),void 0!==t&&(i.generateDiffuseTexture=t);const n={object:s,targetRenderer:i};return this.renderObjects.push(n),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),n}addCustomParticles(e,t,i,r,s){const n=new CM(this._scene,e,t,this._shaderLanguage);n.onParticleSizeChanged.add((()=>this._setParticleSizeForRenderTargets())),r||(r=new TM(this._scene,s,this._shaderLanguage),this.targetRenderers.push(r)),r._onUseVelocityChanged.hasObservers()||r._onUseVelocityChanged.add((()=>this._setUseVelocityForRenderObject())),void 0!==i&&(r.generateDiffuseTexture=i);const o={object:n,targetRenderer:r};return this.renderObjects.push(o),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),o}removeRenderObject(e,t=!0){const i=this.renderObjects.indexOf(e);return-1!==i&&(e.object.dispose(),this.renderObjects.splice(i,1),t&&this._removeUnusedTargetRenderers()?this._initialize():this._setParticleSizeForRenderTargets(),!0)}_sortRenderingObjects(){this.renderObjects.sort(((e,t)=>e.object.priority<t.object.priority?-1:e.object.priority>t.object.priority?1:0))}_removeUnusedTargetRenderers(){const e={};for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t].targetRenderer;e[this.targetRenderers.indexOf(i)]=!0}let t=!1;const i=[];for(let r=0;r<this.targetRenderers.length;++r)e[r]?i.push(this.targetRenderers[r]):(this.targetRenderers[r].dispose(),t=!0);return t&&(this.targetRenderers.length=0,this.targetRenderers.push(...i)),t}_getParticleSystemIndex(e){for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t].object;if(AM(i)&&i.particleSystem===e)return t}return-1}_initialize(){for(let e=0;e<this.targetRenderers.length;++e)this.targetRenderers[e].dispose();const e=new Map;for(let t=0;t<this.targetRenderers.length;++t){const i=this.targetRenderers[t];if(i._initialize(),i.camera&&i._renderPostProcess){let r=e.get(i.camera);r||(r=[[],{}],e.set(i.camera,r)),r[0].push(i),i.camera.attachPostProcess(i._renderPostProcess,t)}}let t=e.keys();for(let i=t.next();!0!==i.done;i=t.next()){const t=i.value,r=e.get(t),s=t._getFirstPostProcess();if(!s)continue;const[n,o]=r;s.onSizeChangedObservable.add((()=>{s.inputTexture.depthStencilTexture||s.inputTexture.createDepthStencilTexture(0,!0,this._engine.isStencilEnable,n[0].samples,this._engine.isStencilEnable?13:14,`PostProcessRTTDepthStencil-${s.name}`);for(const e of n){const t=e._thicknessRenderTarget?.renderTarget,i=t?.texture;if(t&&i){const e=i.width+"_"+i.height;let r=o[e];r||(r=o[e]=new EM(this._engine,i.width,i.height)),r.depthRTWrapper.shareDepth(t)}}}))}t=this._cameras.keys();for(let i=t.next();!0!==i.done;i=t.next()){const t=i.value,r=this._cameras.get(t)[1],s=e.get(t);if(s)for(const e in r)s[1][e]||r[e].dispose();else for(const e in r)r[e].dispose()}this._cameras.clear(),this._cameras=e,this._setParticleSizeForRenderTargets()}_setParticleSizeForRenderTargets(){const e=new Map;for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t];let r=e.get(i.targetRenderer);void 0===r&&(r=0),e.set(i.targetRenderer,Math.max(r,i.object.particleSize))}e.forEach(((e,t)=>{t._depthRenderTarget&&(t._depthRenderTarget.particleSize=e)}))}_setUseVelocityForRenderObject(){for(const e of this.renderObjects)e.object.useVelocity=e.targetRenderer.useVelocity}_prepareRendering(){for(const e of this.targetRenderers)if(e.needInitialization)return void this._initialize()}_render(e){for(let t=0;t<this.targetRenderers.length;++t)e&&this.targetRenderers[t].camera!==e||this.targetRenderers[t]._clearTargets();const t=this._cameras.keys();for(let i=t.next();!0!==i.done;i=t.next()){const t=i.value,r=this._cameras.get(t);if(e&&t!==e)continue;const s=t._getFirstPostProcess();if(!s)continue;const n=s.inputTexture?.depthStencilTexture;if(n){const[e,t]=r;for(const t of e)t._bgDepthTexture=n;for(const e in t)t[e].copy(n)}}for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t];e&&i.targetRenderer.camera!==e||i.targetRenderer._render(i.object)}}dispose(){this._engine.onResizeObservable.remove(this._onEngineResizeObserver),this._onEngineResizeObserver=null;for(let e=0;e<this.renderObjects.length;++e)this.renderObjects[e].object.dispose();for(let e=0;e<this.targetRenderers.length;++e)this.targetRenderers[e].dispose();this._cameras.forEach((e=>{const t=e[1];for(const e in t)t[e].dispose()})),this.renderObjects=[],this.targetRenderers=[],this._cameras.clear()}}var DM=i(13172),OM=i(3934),NM=i(54577),wM=i(49079);const FM="fluidRenderingParticleDiffuseVertexShader",BM="attribute vec3 position;attribute vec2 offset;attribute vec4 color;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;varying vec3 diffuseColor;void main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;vec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;gl_Position=projection*vec4(viewPos,1.0);uv=offset;diffuseColor=color.rgb;}\n";qi.l.ShadersStore[FM]=BM;const VM={name:FM,shader:BM};var LM=i(23483),kM=i(91932),GM=i(75679),zM=i(3399),UM=i(27499),WM=i(67297),HM=i(63866),$M=i(84556);const qM="fluidRenderingParticleDiffuseVertexShader",YM="attribute position: vec3f;attribute offset: vec2f;attribute color: vec4f;uniform view: mat4x4f;uniform projection: mat4x4f;uniform size: vec2f;varying uv: vec2f;varying diffuseColor: vec3f;@vertex\nfn main(input: VertexInputs)->FragmentInputs {var cornerPos: vec3f=vec3f(\nvec2f(input.offset.x-0.5,input.offset.y-0.5)*uniforms.size,\n0.0\n);var viewPos: vec3f=(uniforms.view*vec4f(input.position,1.0)).xyz+cornerPos;vertexOutputs.position=uniforms.projection*vec4f(viewPos,1.0);vertexOutputs.uv=input.offset;vertexOutputs.diffuseColor=input.color.rgb;}\n";qi.l.ShadersStoreWGSL[qM]=YM;const XM={name:qM,shader:YM};var jM=i(75636),ZM=i(97163),QM=i(21570),KM=i(52150);class JM{get enable(){return this._enable}set enable(e){this._enable!==e&&(this._enable=e,this._customRenderTarget(e))}get positionWorldTexture(){return this._mrt.textures[0]}get normalWorldTexture(){return this._mrt.textures[1]}get fluxTexture(){return this._mrt.textures[2]}get renderList(){return this._mrt.renderList}get light(){return this._light}constructor(e,t,i={width:512,height:512}){this._lightTransformMatrix=n.uq.Identity(),this._enable=!1,this.forceUpdateLightParameters=!1,this._scene=e,this._light=t,this._textureDimensions=i,this._regularMatToMatWithPlugin=new Map,this._counters=[{name:"RSM Generation "+t.name,value:0}],this._createMultiRenderTarget(),this._recomputeLightTransformationMatrix(),this.enable=!0}setTextureDimensions(e){const t=this._mrt.renderList;this._textureDimensions=e,this._disposeMultiRenderTarget(),this._createMultiRenderTarget(),t?.forEach((e=>{this._addMeshToMRT(e)}))}addMesh(e){e?this._addMeshToMRT(e):this._scene.meshes.forEach((e=>{this._addMeshToMRT(e)})),this._recomputeLightTransformationMatrix()}updateLightParameters(){this._recomputeLightTransformationMatrix()}get lightTransformationMatrix(){return this.forceUpdateLightParameters&&this.updateLightParameters(),this._lightTransformMatrix}get countersGPU(){return this._counters}dispose(){this._disposeMultiRenderTarget()}_createMultiRenderTarget(){const e=this._light.name,t=this._scene.getEngine().getCaps(),i=t.rg11b10ufColorRenderable?13:2,r=t.rg11b10ufColorRenderable?4:5;let s,n;this._mrt=new Vf("RSMmrt_"+e,this._textureDimensions,3,this._scene,{types:[2,11,i],samplingModes:[2,2,2],generateMipMaps:!1,targetTypes:[3553,3553,3553],formats:[5,5,r]},["RSMPosition_"+e,"RSMNormal_"+e,"RSMFlux_"+e]),this._mrt.renderList=[],this._mrt.clearColor=new o.ov(0,0,0,1),this._mrt.noPrePassRenderer=!0;const a=this._scene.getEngine().supportsUniformBuffers;let l;a&&(s=this._scene.createSceneUniformBuffer(`Scene for RSM (light "${e}")`)),this._mrt.onBeforeBindObservable.add((()=>{n=this._scene.getSceneUniformBuffer(),l=this._light.shadowEnabled,this._light.shadowEnabled=!1})),this._mrt.onBeforeRenderObservable.add((e=>{s&&this._scene.setSceneUniformBuffer(s);const t=this._light.getViewMatrix(e),i=this._light.getProjectionMatrix(t||void 0,this._mrt.renderList||void 0);t&&i&&this._scene.setTransformMatrix(t,i),a&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())})),this._mrt.onAfterUnbindObservable.add((()=>{s&&this._scene.setSceneUniformBuffer(n),this._scene.updateTransformMatrix(),this._light.shadowEnabled=l,this._counters[0].value=this._mrt.renderTarget.gpuTimeInFrame?.counter.lastSecAverage??0})),this._customRenderTarget(!0)}_customRenderTarget(e){const t=this._scene.customRenderTargets.indexOf(this._mrt);e?-1===t&&this._scene.customRenderTargets.push(this._mrt):-1!==t&&this._scene.customRenderTargets.splice(t,1)}_recomputeLightTransformationMatrix(){const e=this._light.getViewMatrix(),t=this._light.getProjectionMatrix(e||void 0,this._mrt.renderList||void 0);e&&t&&e.multiplyToRef(t,this._lightTransformMatrix)}_addMeshToMRT(e){this._mrt.renderList?.push(e);const t=e.material;if(0===e.getTotalVertices()||!t)return;let i=this._regularMatToMatWithPlugin.get(t);if(!i&&(i=t.clone("RSMCreate_"+t.name)||void 0,i)){Object.defineProperty(i,"canRenderToMRT",{get:function(){return!1},enumerable:!0,configurable:!0}),i.disableLighting=!0;const e=new tD(i);e.isEnabled=!0,e.light=this._light,this._regularMatToMatWithPlugin.set(t,i)}this._mrt.setMaterialForRendering(e,i)}_disposeMultiRenderTarget(){this._customRenderTarget(!1),this._mrt.dispose()}}class eD extends Hu.M{constructor(){super(...arguments),this.RSMCREATE=!1,this.RSMCREATE_PROJTEXTURE=!1,this.RSMCREATE_LIGHT_IS_SPOT=!1}}class tD extends vv.y{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e){super(e,tD.Name,300,new eD),this._lightColor=new o.v9,this._hasProjectionTexture=!1,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._varAlbedoName=e instanceof sf.d?"surfaceAlbedo":"baseColor.rgb"}prepareDefines(e){e.RSMCREATE=this._isEnabled,this._hasProjectionTexture=!1;const t=this.light.getTypeID()===Ns.v.LIGHTTYPEID_SPOTLIGHT;if(t){const e=this.light;this._hasProjectionTexture=!!e.projectionTexture&&e.projectionTexture.isReady()}e.RSMCREATE_PROJTEXTURE=this._hasProjectionTexture,e.RSMCREATE_LIGHT_IS_SPOT=t,e.SCENE_MRT_COUNT=3}getClassName(){return"RSMCreatePluginMaterial"}getUniforms(){return{ubo:[{name:"rsmTextureProjectionMatrix",size:16,type:"mat4"},{name:"rsmSpotInfo",size:4,type:"vec4"},{name:"rsmLightColor",size:3,type:"vec3"},{name:"rsmLightPosition",size:3,type:"vec3"}],fragment:"#ifdef RSMCREATE\n                    uniform mat4 rsmTextureProjectionMatrix;\n                    uniform vec4 rsmSpotInfo;\n                    uniform vec3 rsmLightColor;\n                    uniform vec3 rsmLightPosition;\n                #endif"}}getSamplers(e){e.push("rsmTextureProjectionSampler")}bindForSubMesh(e){if(this._isEnabled&&(this.light.diffuse.scaleToRef(this.light.getScaledIntensity(),this._lightColor),e.updateColor3("rsmLightColor",this._lightColor),this.light.getTypeID()===Ns.v.LIGHTTYPEID_SPOTLIGHT)){const t=this.light;this._hasProjectionTexture&&(e.updateMatrix("rsmTextureProjectionMatrix",t.projectionTextureMatrix),e.setTexture("rsmTextureProjectionSampler",t.projectionTexture));const i=n.AA.Vector3[0];t.computeTransformedInformation()?(e.updateFloat3("rsmLightPosition",this.light.transformedPosition.x,this.light.transformedPosition.y,this.light.transformedPosition.z),t.transformedDirection.normalizeToRef(i)):(e.updateFloat3("rsmLightPosition",this.light.position.x,this.light.position.y,this.light.position.z),t.direction.normalizeToRef(i)),e.updateFloat4("rsmSpotInfo",i.x,i.y,i.z,Math.cos(.5*t.angle))}}getCustomCode(e,t){return"vertex"===e?null:1===t?{CUSTOM_FRAGMENT_DEFINITIONS:"\n                #ifdef RSMCREATE\n                    #ifdef RSMCREATE_PROJTEXTURE\n                        var rsmTextureProjectionSamplerSampler: sampler;\n                        var rsmTextureProjectionSampler: texture_2d<f32>;\n                    #endif\n                #endif\n            ",CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR:`\n                #ifdef RSMCREATE\n                    var rsmColor = ${this._varAlbedoName} * uniforms.rsmLightColor;\n                    #ifdef RSMCREATE_PROJTEXTURE\n                    {\n                        var strq = uniforms.rsmTextureProjectionMatrix * vec4f(fragmentInputs.vPositionW, 1.0);\n                        strq /= strq.w;\n                        rsmColor *= textureSample(rsmTextureProjectionSampler, rsmTextureProjectionSamplerSampler, strq.xy).rgb;\n                    }\n                    #endif\n                    #ifdef RSMCREATE_LIGHT_IS_SPOT\n                    {\n                        var cosAngle = max(0., dot(uniforms.rsmSpotInfo.xyz, normalize(fragmentInputs.vPositionW - uniforms.rsmLightPosition)));\n                        rsmColor = sign(cosAngle - uniforms.rsmSpotInfo.w) * rsmColor;\n                    }\n                    #endif\n\n                    #define MRT_AND_COLOR\n                    fragmentOutputs.fragData0 = vec4f(fragmentInputs.vPositionW, 1.);\n                    fragmentOutputs.fragData1 = vec4f(normalize(normalW) * 0.5 + 0.5, 1.);\n                    fragmentOutputs.fragData2 = vec4f(rsmColor, 1.);\n                #endif\n            `}:{CUSTOM_FRAGMENT_BEGIN:"\n                #ifdef RSMCREATE\n                    #extension GL_EXT_draw_buffers : require\n                #endif\n            ",CUSTOM_FRAGMENT_DEFINITIONS:"\n                #ifdef RSMCREATE\n                    #ifdef RSMCREATE_PROJTEXTURE\n                        uniform highp sampler2D rsmTextureProjectionSampler;                    \n                    #endif\n                    layout(location = 0) out highp vec4 glFragData[3];\n                    vec4 glFragColor;\n                #endif\n            ",CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR:`\n                #ifdef RSMCREATE\n                    vec3 rsmColor = ${this._varAlbedoName} * rsmLightColor;\n                    #ifdef RSMCREATE_PROJTEXTURE\n                    {\n                        vec4 strq = rsmTextureProjectionMatrix * vec4(vPositionW, 1.0);\n                        strq /= strq.w;\n                        rsmColor *= texture2D(rsmTextureProjectionSampler, strq.xy).rgb;\n                    }\n                    #endif\n                    #ifdef RSMCREATE_LIGHT_IS_SPOT\n                    {\n                        float cosAngle = max(0., dot(rsmSpotInfo.xyz, normalize(vPositionW - rsmLightPosition)));\n                        rsmColor = sign(cosAngle - rsmSpotInfo.w) * rsmColor;\n                    }\n                    #endif\n                    glFragData[0] = vec4(vPositionW, 1.);\n                    glFragData[1] = vec4(normalize(normalW) * 0.5 + 0.5, 1.);\n                    glFragData[2] = vec4(rsmColor, 1.);\n                #endif\n            `}}}tD.Name="RSMCreate",(0,Ge.Cg)([(0,ze.lK)()],tD.prototype,"light",void 0),(0,Ge.Cg)([(0,ze.lK)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],tD.prototype,"isEnabled",void 0),(0,a.Y5)("BABYLON.RSMCreatePluginMaterial",tD);class iD{constructor(e){this.numSamples=400,this.radius=.1,this.intensity=.1,this.edgeArtifactCorrection=.1,this.rotateSample=!0,this.noiseFactor=100,this.useFullTexture=!1,this.rsm=e}dispose(){this.rsm.dispose()}}class rD{get enable(){return this._enable}set enable(e){0===this._giRSM.length&&(e=!1),e!==this._enable&&(this._enable=e,this._debugLayer.isEnabled=this._showOnlyGI&&e,this._materialsWithRenderPlugin.forEach((t=>{if(t.pluginManager){t.pluginManager.getPlugin(nD.Name).isEnabled=e}})),this.recreateResources(!e))}get enableBlur(){return this._enableBlur}set enableBlur(e){e!==this._enableBlur&&(this._enableBlur=e,this.recreateResources())}get useQualityBlur(){return this._useQualityBlur}set useQualityBlur(e){e!==this._useQualityBlur&&(this._useQualityBlur=e,this.recreateResources())}get fullSizeBlur(){return this._forceFullSizeBlur}set fullSizeBlur(e){this._forceFullSizeBlur!==e&&(this._forceFullSizeBlur=e,this.recreateResources())}get useQualityUpsampling(){return this._useQualityUpsampling}set useQualityUpsampling(e){e!==this._useQualityUpsampling&&(this._useQualityUpsampling=e,this.recreateResources())}get showOnlyGI(){return this._showOnlyGI}set showOnlyGI(e){this._showOnlyGI!==e&&(this._showOnlyGI=e,this._debugLayer.isEnabled=e)}get use32BitsDepthBuffer(){return this._use32BitsDepthBuffer}set use32BitsDepthBuffer(e){this._use32BitsDepthBuffer!==e&&(this._use32BitsDepthBuffer=e,this.recreateResources())}setOutputDimensions(e){this._outputDimensions=e,this.recreateResources()}setGITextureDimensions(e){this._giTextureDimensions=e,this.recreateResources()}get giTextureType(){return this._giTextureType}set giTextureType(e){this._giTextureType!==e&&(this._giTextureType=e,this.recreateResources())}get shaderLanguage(){return this._shaderLanguage}get giRSM(){return this._giRSM}addGIRSM(e){Array.isArray(e)?this._giRSM.push(...e):this._giRSM.push(e),this.recreateResources()}removeGIRSM(e){if(Array.isArray(e))for(let t=0;t<e.length;++t){const i=this._giRSM.indexOf(e[t]);-1!==i&&this._giRSM.splice(i,1)}else{const t=this._giRSM.indexOf(e);-1!==t&&this._giRSM.splice(t,1)}0===this._giRSM.length?this.enable=!1:this.recreateResources()}addMaterial(e){e?this._addGISupportToMaterial(e):this._scene.meshes.forEach((e=>{e.getTotalVertices()>0&&e.isEnabled()&&e.material&&this._addGISupportToMaterial(e.material)}))}get countersGPU(){return this._counters}recreateResources(e=!1){this._shadersLoaded?(this._disposePostProcesses(e),this._createPostProcesses(),this._setPluginParameters()):this._onShaderLoadedObservable.addOnce((()=>{this.recreateResources(e)}))}generateSampleTexture(e){this._sampleTexture?.dispose(),this._maxSamples=e;const t=new Float32Array(4*this._maxSamples);for(let e=0;e<this._maxSamples;e++){const i=Math.random(),r=Math.random(),s=i*Math.sin(2*Math.PI*r),n=i*Math.cos(2*Math.PI*r);t[4*e+0]=s,t[4*e+1]=n,t[4*e+2]=i*i,t[4*e+3]=1}this._sampleTexture=new He.I(t,this._maxSamples,1,5,this._scene,!1,!1,1,1),this._sampleTexture.name="GIRSMSamples"}dispose(){this._disposePostProcesses(!0),this._debugLayer.texture?.dispose(),this._debugLayer.dispose(),this._scene.onBeforeDrawPhaseObservable.remove(this._drawPhaseObserver),this._onShaderLoadedObservable.clear()}constructor(e,t,i={width:256,height:256},r=2048,o=11){this._giRSM=[],this._blurRTT=null,this._blurPostProcesses=null,this._blurXPostprocess=null,this._blurYPostprocess=null,this._upsamplingXPostprocess=null,this._upsamplingYPostprocess=null,this._ppGlobalIllumination=[],this._firstActivation=!0,this._geomBufferEnabled=!1,this._geomBufferEnablePosition=!1,this._tempMatrix=new n.uq,this._enable=!1,this.pause=!1,this._enableBlur=!0,this._useQualityBlur=!1,this.blurDepthThreshold=.05,this.blurNormalThreshold=.25,this.blurKernel=12,this._forceFullSizeBlur=!1,this._useQualityUpsampling=!1,this.upsamplerKernel=6,this._showOnlyGI=!1,this._use32BitsDepthBuffer=!1,this._shaderLanguage=0,this._shadersLoaded=!1,this._onShaderLoadedObservable=new s.cP,this._scene=e,this._engine=e.getEngine(),this._outputDimensions=t,this._giTextureDimensions=i,this._giTextureType=o,this._materialsWithRenderPlugin=[],this._maxSamples=r,this._debugLayer=new Op("debug layer",null,this._scene,!1),this._debugLayer.isEnabled=!1,this._counters=[],this._countersRTW=[],this._initShaderSourceAsync(),this.generateSampleTexture(r),this._drawPhaseObserver=this._scene.onBeforeDrawPhaseObservable.add((()=>{const e=this._engine._currentRenderTarget;let t=!1;if(this._enable&&this._shadersLoaded){!this.pause&&this._ppGlobalIllumination.length>0&&(this._scene.postProcessManager.directRender(this._ppGlobalIllumination,this._ppGlobalIllumination[0].inputTexture),this._engine.unBindFramebuffer(this._ppGlobalIllumination[0].inputTexture,!0),this._engine.setAlphaMode(0),t=!0,this.enableBlur&&this._blurPostProcesses&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,this._blurRTT.renderTarget,!0),this._engine.unBindFramebuffer(this._blurRTT.renderTarget,!0)));for(let e=0;e<this._counters.length;++e){const t=this._countersRTW[e];for(let i=0;i<t.length;++i)0===i?this._counters[e].value=this.pause?0:t[i].gpuTimeInFrame?.counter.lastSecAverage??0:this.pause||(this._counters[e].value+=t[i].gpuTimeInFrame?.counter.lastSecAverage??0)}this._scene.activeCamera&&this._engine.setViewport(this._scene.activeCamera.viewport)}t&&e&&this._engine.bindFramebuffer(e)}))}async _initShaderSourceAsync(){this._engine.isWebGPU?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,91807)),Promise.resolve().then(i.bind(i,11084)),Promise.resolve().then(i.bind(i,13118)),Promise.resolve().then(i.bind(i,82365))])):await Promise.all([Promise.resolve().then(i.bind(i,18516)),Promise.resolve().then(i.bind(i,97621)),Promise.resolve().then(i.bind(i,3157)),Promise.resolve().then(i.bind(i,88826))]),this._shadersLoaded=!0,this._onShaderLoadedObservable.notifyObservers()}_disposePostProcesses(e=!1){this._blurRTT?.dispose(),this._blurRTT=null,this._blurPostProcesses=[],this._blurXPostprocess?.dispose(),this._blurXPostprocess=null,this._blurYPostprocess?.dispose(),this._blurYPostprocess=null,this._upsamplingXPostprocess?.dispose(),this._upsamplingXPostprocess=null,this._upsamplingYPostprocess?.dispose(),this._upsamplingYPostprocess=null;for(const e of this._ppGlobalIllumination)e.dispose();this._ppGlobalIllumination=[],e&&(this._geomBufferEnabled?(this._scene.enableGeometryBufferRenderer(),this._scene.geometryBufferRenderer.enablePosition=this._geomBufferEnablePosition):this._scene.disableGeometryBufferRenderer()),this._counters=[],this._countersRTW=[]}_setPluginParameters(){this._enable&&this._materialsWithRenderPlugin.forEach((e=>{if(e.pluginManager){const t=e.pluginManager.getPlugin(nD.Name);t.textureGIContrib=this.enableBlur?this._blurRTT.renderTarget.texture:this._ppGlobalIllumination[0].inputTexture.texture,t.outputTextureWidth=this._outputDimensions.width,t.outputTextureHeight=this._outputDimensions.height}}))}_createPostProcesses(){if(!this._enable)return;const e=13===this._giTextureType?4:5;this._firstActivation&&(this._firstActivation=!1,this._geomBufferEnabled=!!this._scene.geometryBufferRenderer,this._geomBufferEnablePosition=this._scene.geometryBufferRenderer?.enablePosition??!1),this._geomBufferEnabled||this._scene.disableGeometryBufferRenderer();const t=this._scene.enableGeometryBufferRenderer(this._enableBlur?this._outputDimensions:this._giTextureDimensions,this._use32BitsDepthBuffer?14:15,rD.GeometryBufferTextureTypesAndFormats);if(!t)throw new Error("Geometry buffer renderer is not supported but is required for GIRSMManager.");t.enablePosition=!0,this._geomBufferEnabled||(t.generateNormalsInWorldSpace=!0);const i=t.normalsAreUnsigned,r=t.generateNormalsInWorldSpace;this._counters.push({name:"Geometry buffer renderer",value:0}),this._countersRTW.push([this._scene.geometryBufferRenderer.getGBuffer().renderTarget]);let s="";i&&(s+="#define DECODE_NORMAL\n"),r||(s+="#define TRANSFORM_NORMAL\n");for(let i=0;i<this._giRSM.length;++i){const n=this._giRSM[i],o=n.rsm,a=new Fi.w("RSMGlobalIllumination"+i,n.useFullTexture?"rsmFullGlobalIllumination":"rsmGlobalIllumination",{...this._giTextureDimensions,uniforms:["rsmLightMatrix","rsmInfo","rsmInfo2","invView"],samplers:["normalSampler","rsmPositionW","rsmNormalW","rsmFlux","rsmSamples"],defines:s,samplingMode:2,engine:this._engine,textureType:this._giTextureType,textureFormat:e,shaderLanguage:this._shaderLanguage});this._ppGlobalIllumination.push(a),0!==i&&(a.shareOutputWith(this._ppGlobalIllumination[0]),a.alphaMode=1),a.autoClear=!1,a.externalTextureSamplerBinding=!0,a.onApplyObservable.add((e=>{e.setTexture("textureSampler",t.getGBuffer().textures[t.getTextureIndex(UA.POSITION_TEXTURE_TYPE)]),e.setTexture("normalSampler",t.getGBuffer().textures[t.getTextureIndex(UA.NORMAL_TEXTURE_TYPE)]),e.setTexture("rsmPositionW",o.positionWorldTexture),e.setTexture("rsmNormalW",o.normalWorldTexture),e.setTexture("rsmFlux",o.fluxTexture),e.setMatrix("rsmLightMatrix",o.lightTransformationMatrix),n.useFullTexture?e.setFloat4("rsmInfo",o.fluxTexture.getInternalTexture().width,o.fluxTexture.getInternalTexture().height,n.intensity,n.edgeArtifactCorrection):(e.setTexture("rsmSamples",this._sampleTexture),e.setFloat4("rsmInfo",n.numSamples,n.radius,n.intensity,n.edgeArtifactCorrection),e.setFloat4("rsmInfo2",n.noiseFactor,n.rotateSample?1:0,o.fluxTexture.getInternalTexture().width,o.fluxTexture.getInternalTexture().height)),r||(this._tempMatrix.copyFrom(this._scene.activeCamera.getViewMatrix()),this._tempMatrix.invert(),e.setMatrix("invView",this._tempMatrix))}))}for(const e of this._ppGlobalIllumination)e.inputTexture||e.resize(this._giTextureDimensions.width,this._giTextureDimensions.height);if(this._counters.push({name:"GI generation",value:0}),this._countersRTW.push([this._ppGlobalIllumination[0].inputTexture]),this._enableBlur){const r=this._forceFullSizeBlur?this._outputDimensions:this._giTextureDimensions;this._blurRTT=new cr.$("GIRSMContribution",this._outputDimensions,this._scene,{type:this._giTextureType,format:e,generateDepthBuffer:!1}),this._blurRTT.wrapU=0,this._blurRTT.wrapV=0,this._blurRTT.updateSamplingMode(1),this._blurRTT.skipInitialClear=!0;const s=[];this._counters.push({name:"GI blur",value:0}),this._countersRTW.push(s),this._blurXPostprocess=new Fi.w(this._useQualityBlur?"BilateralBlur":"BilateralBlurX",this._useQualityBlur?"bilateralBlurQuality":"bilateralBlur",{uniforms:["filterSize","blurDir","depthThreshold","normalThreshold"],samplers:["depthSampler","normalSampler"],defines:i?"#define DECODE_NORMAL":void 0,size:r,samplingMode:2,engine:this._engine,textureType:this._giTextureType,textureFormat:e,shaderLanguage:this._shaderLanguage}),this._blurXPostprocess.onApplyObservable.add((e=>{e._bindTexture("textureSampler",this._ppGlobalIllumination[0].inputTexture.texture),e.setTexture("depthSampler",t.getGBuffer().textures[t.getTextureIndex(UA.DEPTH_TEXTURE_TYPE)]),e.setTexture("normalSampler",t.getGBuffer().textures[t.getTextureIndex(UA.NORMAL_TEXTURE_TYPE)]),e.setInt("filterSize",this.blurKernel),e.setFloat2("blurDir",1/this._giTextureDimensions.width,this._useQualityBlur?1/this._giTextureDimensions.height:0),e.setFloat("depthThreshold",this.blurDepthThreshold),e.setFloat("normalThreshold",this.blurNormalThreshold)})),this._blurXPostprocess.externalTextureSamplerBinding=!0,this._blurXPostprocess.autoClear=!1,this._useQualityBlur||(this._blurYPostprocess=new Fi.w("BilateralBlurY","bilateralBlur",{uniforms:["filterSize","blurDir","depthThreshold","normalThreshold"],samplers:["depthSampler","normalSampler"],defines:i?"#define DECODE_NORMAL":void 0,size:r,samplingMode:2,engine:this._engine,textureType:this._giTextureType,textureFormat:e,shaderLanguage:this._shaderLanguage}),this._blurYPostprocess.autoClear=!1,this._blurYPostprocess.onApplyObservable.add((e=>{e.setTexture("depthSampler",t.getGBuffer().textures[t.getTextureIndex(UA.DEPTH_TEXTURE_TYPE)]),e.setTexture("normalSampler",t.getGBuffer().textures[t.getTextureIndex(UA.NORMAL_TEXTURE_TYPE)]),e.setInt("filterSize",this.blurKernel),e.setFloat2("blurDir",0,1/this._giTextureDimensions.height),e.setFloat("depthThreshold",this.blurDepthThreshold),e.setFloat("normalThreshold",this.blurNormalThreshold)})),this._blurYPostprocess.resize(r.width,r.height),s.push(this._blurYPostprocess.inputTexture)),this._blurPostProcesses=[this._blurXPostprocess],this._blurYPostprocess&&this._blurPostProcesses.push(this._blurYPostprocess);if(this._giTextureDimensions.width>=this._outputDimensions.width&&this._giTextureDimensions.height>=this._outputDimensions.height||this._forceFullSizeBlur)s.push(this._blurRTT.renderTarget);else{const n=[];this._counters.push({name:"GI upsampling",value:0}),this._countersRTW.push(n),this._upsamplingXPostprocess=new Fi.w(this._useQualityUpsampling?"BilateralUpsampling":"BilateralUpsamplingX",this._useQualityUpsampling?"bilateralBlurQuality":"bilateralBlur",{uniforms:["filterSize","blurDir","depthThreshold","normalThreshold"],samplers:["depthSampler","normalSampler"],defines:i?"#define DECODE_NORMAL":void 0,size:r,samplingMode:2,engine:this._engine,textureType:this._giTextureType,textureFormat:e,shaderLanguage:this._shaderLanguage}),this._upsamplingXPostprocess.autoClear=!1,this._upsamplingXPostprocess.onApplyObservable.add((e=>{e.setTexture("depthSampler",t.getGBuffer().textures[t.getTextureIndex(UA.DEPTH_TEXTURE_TYPE)]),e.setTexture("normalSampler",t.getGBuffer().textures[t.getTextureIndex(UA.NORMAL_TEXTURE_TYPE)]),e.setInt("filterSize",this.upsamplerKernel),e.setFloat2("blurDir",1/this._outputDimensions.width,this._useQualityUpsampling?1/this._outputDimensions.height:0),e.setFloat("depthThreshold",this.blurDepthThreshold),e.setFloat("normalThreshold",this.blurNormalThreshold)})),this._upsamplingXPostprocess.resize(r.width,r.height),s.push(this._upsamplingXPostprocess.inputTexture),this.useQualityUpsampling||(this._upsamplingYPostprocess=new Fi.w("BilateralUpsamplingY","bilateralBlur",{uniforms:["filterSize","blurDir","depthThreshold","normalThreshold"],samplers:["depthSampler","normalSampler"],defines:i?"#define DECODE_NORMAL":void 0,size:this._outputDimensions,samplingMode:2,engine:this._engine,textureType:this._giTextureType,textureFormat:e,shaderLanguage:this._shaderLanguage}),this._upsamplingYPostprocess.autoClear=!1,this._upsamplingYPostprocess.onApplyObservable.add((e=>{e.setTexture("depthSampler",t.getGBuffer().textures[t.getTextureIndex(UA.DEPTH_TEXTURE_TYPE)]),e.setTexture("normalSampler",t.getGBuffer().textures[t.getTextureIndex(UA.NORMAL_TEXTURE_TYPE)]),e.setInt("filterSize",this.upsamplerKernel),e.setFloat2("blurDir",0,1/this._outputDimensions.height),e.setFloat("depthThreshold",this.blurDepthThreshold),e.setFloat("normalThreshold",this.blurNormalThreshold)})),this._upsamplingYPostprocess.resize(this._outputDimensions.width,this._outputDimensions.height),n.push(this._upsamplingYPostprocess.inputTexture)),n.push(this._blurRTT.renderTarget),this._blurPostProcesses.push(this._upsamplingXPostprocess),this._upsamplingYPostprocess&&this._blurPostProcesses.push(this._upsamplingYPostprocess)}}this._debugLayer.texture?.dispose(),this._debugLayer.texture=new zu.t(this._scene,this._enableBlur?this._blurRTT.renderTarget.texture:this._ppGlobalIllumination[0].inputTexture.texture)}_addGISupportToMaterial(e){if(e.pluginManager?.getPlugin(nD.Name))return;const t=new nD(e);this._enable&&this._ppGlobalIllumination.length>0&&(t.textureGIContrib=this._ppGlobalIllumination[0].inputTexture.texture,t.outputTextureWidth=this._outputDimensions.width,t.outputTextureHeight=this._outputDimensions.height),t.isEnabled=this._enable,this._materialsWithRenderPlugin.push(e)}}rD.GeometryBufferTextureTypesAndFormats={0:{textureType:2,textureFormat:6},1:{textureType:11,textureFormat:5},2:{textureType:2,textureFormat:5}};class sD extends Hu.M{constructor(){super(...arguments),this.RENDER_WITH_GIRSM=!1,this.RSMCREATE_PROJTEXTURE=!1}}class nD extends vv.y{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e){super(e,nD.Name,310,new sD),this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._isPBR=e instanceof sf.d}prepareDefines(e){e.RENDER_WITH_GIRSM=this._isEnabled}getClassName(){return"GIRSMRenderPluginMaterial"}getUniforms(){return{ubo:[{name:"girsmTextureOutputSize",size:2,type:"vec2"}],fragment:"#ifdef RENDER_WITH_GIRSM\n                    uniform vec2 girsmTextureOutputSize;\n                #endif"}}getSamplers(e){e.push("girsmTextureGIContrib")}bindForSubMesh(e){this._isEnabled&&(e.bindTexture("girsmTextureGIContrib",this.textureGIContrib),e.updateFloat2("girsmTextureOutputSize",this.outputTextureWidth,this.outputTextureHeight))}getCustomCode(e,t){let i;return 1===t?(i={CUSTOM_FRAGMENT_DEFINITIONS:"\n                #ifdef RENDER_WITH_GIRSM\n                    var girsmTextureGIContribSampler: sampler;\n                    var girsmTextureGIContrib: texture_2d<f32>;\n\n                    fn computeIndirect() -> vec3f {\n                        var uv = fragmentInputs.position.xy / uniforms.girsmTextureOutputSize;\n                        return textureSample(girsmTextureGIContrib, girsmTextureGIContribSampler, uv).rgb;\n                    }\n                #endif\n            ",CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION:"\n                #ifdef RENDER_WITH_GIRSM\n                    finalDiffuse += computeIndirect() * surfaceAlbedo.rgb;\n                #endif\n            "},this._isPBR||(i.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR="\n                #ifdef RENDER_WITH_GIRSM\n                    color = vec4f(color.rgb + computeIndirect() * baseColor.rgb, color.a);\n                #endif\n            ")):(i={CUSTOM_FRAGMENT_DEFINITIONS:"\n                #ifdef RENDER_WITH_GIRSM\n                    uniform sampler2D girsmTextureGIContrib;\n\n                    vec3 computeIndirect() {\n                        vec2 uv = gl_FragCoord.xy / girsmTextureOutputSize;\n                        return texture2D(girsmTextureGIContrib, uv).rgb;\n                    }\n                #endif\n            ",CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION:"\n                #ifdef RENDER_WITH_GIRSM\n                    finalDiffuse += computeIndirect() * surfaceAlbedo.rgb;\n                #endif\n            "},this._isPBR||(i.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR="\n                #ifdef RENDER_WITH_GIRSM\n                    color.rgb += computeIndirect() * baseColor.rgb;\n                #endif\n            ")),"vertex"===e?null:i}}nD.Name="GIRSMRender",(0,Ge.Cg)([(0,ze.lK)()],nD.prototype,"textureGIContrib",void 0),(0,Ge.Cg)([(0,ze.lK)()],nD.prototype,"outputTextureWidth",void 0),(0,Ge.Cg)([(0,ze.lK)()],nD.prototype,"outputTextureHeight",void 0),(0,Ge.Cg)([(0,ze.lK)(),(0,ze.$z)("_markAllSubMeshesAsTexturesDirty")],nD.prototype,"isEnabled",void 0),(0,a.Y5)("BABYLON.GIRSMRenderPluginMaterial",nD);var oD=i(18516),aD=i(97621),lD=i(3157),hD=i(88826),cD=i(91807),uD=i(11084),dD=i(13118),pD=i(82365),mD=i(38939),fD=i(48453),_D=i(38574),gD=i(2564),xD=i(33495),vD=i(82187),SD=i(12814),bD=i(89252),yD=i(861),PD=i(26149),TD=i(85264),CD=i(80574),ED=i(2641),AD=i(99899),ID=i(13802),RD=i(85520),MD=i(47383),DD=i(95176),OD=i(16990),ND=i(9461),wD=i(22495),FD=i(2730),BD=i(46391),VD=i(8605),LD=i(27122),kD=i(61089);const GD="iblShadowsCombinePixelShader",zD="precision highp float;varying vec2 vUV;uniform sampler2D shadowSampler;uniform sampler2D textureSampler;uniform float shadowOpacity;void main(void)\n{vec3 shadow=texture(shadowSampler,vUV).rgb;vec3 sceneColor=texture(textureSampler,vUV).rgb;float shadowValue=mix(1.0,shadow.x,shadowOpacity);gl_FragColor=vec4(sceneColor*shadowValue,1.0);}";qi.l.ShadersStore[GD]=zD;const UD={name:GD,shader:zD},WD="iblShadowsCombinePixelShader",HD="varying vUV: vec2f;var shadowSamplerSampler : sampler;var shadowSampler : texture_2d<f32>;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform shadowOpacity: f32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var shadow\n: vec3f =\ntextureSample(shadowSampler,shadowSamplerSampler,input.vUV).rgb;var color\n: vec3f =\ntextureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var shadowValue: f32=mix(1.0,shadow.x,uniforms.shadowOpacity);fragmentOutputs.color=vec4f(color*shadowValue,1.0);}";qi.l.ShadersStoreWGSL[WD]=HD;const $D={name:WD,shader:HD};var qD=i(92199),YD=i(18162),XD=i(46043),jD=i(23584),ZD=i(95634),QD=i(29533),KD=i(18900),JD=i(47671),eO=i(61245),tO=i(24030),iO=i(10461),rO=i(90982),sO=i(48137),nO=i(46762),oO=i(62099),aO=i(80234),lO=i(88188),hO=i(17537),cO=i(3414),uO=i(8444),dO=i(39107),pO=i(43965),mO=i(96214),fO=i(84237),_O=i(93968),gO=i(85257),xO=i(26472),vO=i(1138),SO=i(20449),bO=i(19015),yO=i(47312),PO=i(14958);const TO="spriteMapPixelShader",CO="#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\nprecision highp float;varying vec3 vPosition;varying vec2 vUV;varying vec2 tUV;uniform float time;uniform float spriteCount;uniform sampler2D spriteSheet;uniform vec2 spriteMapSize;uniform vec2 outputSize;uniform vec2 stageSize;uniform sampler2D frameMap;uniform sampler2D tileMaps[LAYERS];uniform sampler2D animationMap;uniform vec3 colorMul;\n#include<fogFragmentDeclaration>\n#include<logDepthDeclaration>\nfloat mt;const float fdStep=1.0*0.25;const float aFrameSteps=MAX_ANIMATION_FRAMES==0.0 ? 0.0 : 1.0/MAX_ANIMATION_FRAMES;mat4 getFrameData(float frameID) {float fX=frameID/spriteCount;return mat4(\nTEXTUREFUNC(frameMap,vec2(fX,0.0),0.0),\nTEXTUREFUNC(frameMap,vec2(fX,fdStep*1.0),0.0),\nTEXTUREFUNC(frameMap,vec2(fX,fdStep*2.0),0.0),\nvec4(0.0)\n);}\nvoid main() {vec4 color=vec4(0.0);vec2 tileUV=fract(tUV);vec2 tileID=floor(tUV);vec2 sheetUnits=1.0/spriteMapSize;float spriteUnits=1.0/spriteCount;vec2 stageUnits=1.0/stageSize;for(int i=0; i<LAYERS; i++) {float frameID;\n#define LAYER_ID_SWITCH\nvec4 animationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,0.0),0.0);if(animationData.y>0.0) {mt=mod(time*animationData.z,1.0);for(float f=0.0; f<MAX_ANIMATION_FRAMES; f++) {if(animationData.y>mt) {frameID=animationData.x;break;}\nanimationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,aFrameSteps*f),0.0);}}\nmat4 frameData=getFrameData(frameID+0.5);vec2 frameSize=(frameData[0].zw)/spriteMapSize;vec2 offset=frameData[0].xy*sheetUnits;vec2 ratio=frameData[2].xy/frameData[0].zw;\n#ifdef FR_CW\nif (frameData[2].z==1.0) {tileUV.xy=tileUV.yx;} else {tileUV.xy=fract(tUV).xy;}\n#ifdef FLIPU\ntileUV.y=1.0-tileUV.y;\n#endif\n#else\nif (frameData[2].z==1.0) {\n#ifdef FLIPU\ntileUV.y=1.0-tileUV.y;\n#endif\ntileUV.xy=tileUV.yx;} else {tileUV.xy=fract(tUV).xy;\n#ifdef FLIPU\ntileUV.y=1.0-tileUV.y;\n#endif\n}\n#endif\nvec4 nc=TEXTUREFUNC(spriteSheet,tileUV*frameSize+offset,0.0);if (i==0) {color=nc;} else {float alpha=min(color.a+nc.a,1.0);vec3 mixed=mix(color.xyz,nc.xyz,nc.a);color=vec4(mixed,alpha);}}\ncolor.xyz*=colorMul;\n#include<logDepthFragment>\n#include<fogFragment>\ngl_FragColor=color;}";qi.l.ShadersStore[TO]=CO;const EO="spriteMapVertexShader",AO="precision highp float;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;varying vec3 vPosition;varying vec2 vUV;varying vec2 tUV;uniform float time;uniform mat4 world;uniform mat4 view;uniform mat4 projection;uniform vec2 stageSize;uniform float stageScale;\n#include<fogVertexDeclaration>\n#include<logDepthDeclaration>\nvoid main() {vec4 p=vec4( position,1. );vPosition=p.xyz;vUV=uv;tUV=uv*stageSize; \nvec3 viewPos=(view*world*p).xyz; \ngl_Position=projection*vec4(viewPos,1.0); \n#ifdef FOG\nvFogDistance=viewPos;\n#endif\n#include<logDepthVertex>\n}";qi.l.ShadersStore[EO]=AO;var IO;!function(e){e[e.CCW=0]="CCW",e[e.CW=1]="CW"}(IO||(IO={}));class RO{get spriteCount(){return this.sprites.length}get position(){return this._output.position}set position(e){this._output.position=e}get rotation(){return this._output.rotation}set rotation(e){this._output.rotation=e}get animationMap(){return this._animationMap}set animationMap(e){const t=e._texture._bufferView,i=this._createTileAnimationBuffer(t);this._animationMap.dispose(),this._animationMap=i,this._material.setTexture("animationMap",this._animationMap)}get fogEnabled(){return this._material.fogEnabled}set fogEnabled(e){this._material.fogEnabled=e}get useLogarithmicDepth(){return this._material.useLogarithmicDepth}set useLogarithmicDepth(e){this._material.useLogarithmicDepth=e}constructor(e,t,i,r,s){this.name=e,this.sprites=[],this.atlasJSON=t,this.sprites=this.atlasJSON.frames,this.spriteSheet=i,this.options=r,r.stageSize=r.stageSize||new n.I9(1,1),r.outputSize=r.outputSize||r.stageSize,r.outputPosition=r.outputPosition||n.Pq.Zero(),r.outputRotation=r.outputRotation||n.Pq.Zero(),r.layerCount=r.layerCount||1,r.maxAnimationFrames=r.maxAnimationFrames||0,r.baseTile=r.baseTile||0,r.flipU=r.flipU||!1,r.colorMultiply=r.colorMultiply||new n.Pq(1,1,1),this._scene=s,this._frameMap=this._createFrameBuffer(),this._tileMaps=new Array;for(let e=0;e<r.layerCount;e++)this._tileMaps.push(this._createTileBuffer(null,e));this._animationMap=this._createTileAnimationBuffer(null);const o=[];o.push("#define LAYERS "+r.layerCount),r?.frameRotationDirection===IO.CW&&o.push("#define FR_CW"),r.flipU&&o.push("#define FLIPU"),o.push(`#define MAX_ANIMATION_FRAMES ${r.maxAnimationFrames}.0`);const a=xo.M.ShadersStore.spriteMapPixelShader;let l;if(s.getEngine()._features.supportSwitchCaseInShader){l="switch(i) {";for(let e=0;e<r.layerCount;e++)l+="case "+e+" : frameID = texture(tileMaps["+e+"], (tileID + 0.5) / stageSize, 0.).x;",l+="break;";l+="}"}else{l="";for(let e=0;e<r.layerCount;e++)l+=`if (${e} == i) { frameID = texture2D(tileMaps[${e}], (tileID + 0.5) / stageSize, 0.).x; }`}xo.M.ShadersStore["spriteMap"+this.name+"PixelShader"]=a.replace("#define LAYER_ID_SWITCH",l),this._material=new rs("spriteMap:"+this.name,this._scene,{vertex:"spriteMap",fragment:"spriteMap"+this.name},{defines:o,attributes:["position","normal","uv"],uniforms:["world","view","projection","time","stageSize","outputSize","spriteMapSize","spriteCount","time","colorMul","mousePosition","curTile","flipU"],samplers:["spriteSheet","frameMap","tileMaps","animationMap"],needAlphaBlending:!0}),this._time=0,this._material.setFloat("spriteCount",this.spriteCount),this._material.setVector2("stageSize",r.stageSize),this._material.setVector2("outputSize",r.outputSize),this._material.setTexture("spriteSheet",this.spriteSheet),this._material.setVector2("spriteMapSize",new n.I9(1,1)),this._material.setVector3("colorMul",r.colorMultiply);let h=0;const c=()=>{this.spriteSheet&&this.spriteSheet.isReady()&&this.spriteSheet._texture?this._material.setVector2("spriteMapSize",new n.I9(this.spriteSheet._texture.baseWidth||1,this.spriteSheet._texture.baseHeight||1)):h<100&&setTimeout((()=>{h++,c()}),100)};c(),this._material.setVector3("colorMul",r.colorMultiply),this._material.setTexture("frameMap",this._frameMap),this._material.setTextureArray("tileMaps",this._tileMaps),this._material.setTexture("animationMap",this._animationMap),this._material.setFloat("time",this._time),this._output=ht(e+":output",{size:1,updatable:!0},s),this._output.scaling.x=r.outputSize.x,this._output.scaling.y=r.outputSize.y,this.position=r.outputPosition,this.rotation=r.outputRotation;this._scene.onBeforeRenderObservable.add((()=>{this._time+=this._scene.getEngine().getDeltaTime(),this._material.setFloat("time",this._time)})),this._output.material=this._material}getTileIdxByName(e){return this.atlasJSON.frames.findIndex((t=>t.filename===e))}getTileID(){const e=this.getMousePosition();return e.multiplyInPlace(this.options.stageSize||n.I9.Zero()),e.x=Math.floor(e.x),e.y=Math.floor(e.y),e}getMousePosition(){const e=this._output,t=this._scene.pick(this._scene.pointerX,this._scene.pointerY,(t=>t===e));if(!t||!t.hit||!t.getTextureCoordinates)return new n.I9(-1,-1);const i=t.getTextureCoordinates();return i||new n.I9(-1,-1)}_createFrameBuffer(){const e=[];for(let t=0;t<this.spriteCount;t++)e.push(0,0,0,0),e.push(0,0,0,0),e.push(0,0,0,0),e.push(0,0,0,0);for(let t=0;t<this.spriteCount;t++){const i=this.sprites[t].frame,r=this.sprites[t].spriteSourceSize,s=this.sprites[t].sourceSize,n=this.sprites[t].rotated?1:0,o=this.sprites[t].trimmed?1:0;e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.w,e[4*t+3]=i.h,e[4*t+4*this.spriteCount]=r.x,e[4*t+1+4*this.spriteCount]=r.y,e[4*t+3+4*this.spriteCount]=r.h,e[4*t+8*this.spriteCount]=s.w,e[4*t+1+8*this.spriteCount]=s.h,e[4*t+2+8*this.spriteCount]=n,e[4*t+3+8*this.spriteCount]=o}const t=new Float32Array(e);return He.I.CreateRGBATexture(t,this.spriteCount,4,this._scene,!1,!1,$e.g.NEAREST_NEAREST,1)}_createTileBuffer(e,t=0){let i=[];const r=this.options.stageSize.y||0,s=this.options.stageSize.x||0;if(e)i=e;else{let e=this.options.baseTile;0!=t&&(e=0);for(let t=0;t<r;t++)for(let t=0;t<4*s;t+=4)i.push(e,0,0,0)}const n=new Float32Array(i);return He.I.CreateRGBATexture(n,s,r,this._scene,!1,!1,$e.g.NEAREST_NEAREST,1)}changeTiles(e=0,t,i=0){const r=this._tileMaps[e]._texture._bufferView;if(null===r)return;let s=[];t instanceof n.I9?s.push(t):s=t;const o=this.options.stageSize.x||0;for(let e=0;e<s.length;e++){const t=s[e];t.x=Math.floor(t.x),t.y=Math.floor(t.y);r[4*t.x+t.y*(4*o)]=i}const a=this._createTileBuffer(r);this._tileMaps[e].dispose(),this._tileMaps[e]=a,this._material.setTextureArray("tileMap",this._tileMaps)}_createTileAnimationBuffer(e){const t=[];let i;if(e)i=e;else{for(let e=0;e<this.spriteCount;e++){t.push(0,0,0,0);let e=1;for(;e<(this.options.maxAnimationFrames||4);)t.push(0,0,0,0),e++}i=new Float32Array(t)}return He.I.CreateRGBATexture(i,this.spriteCount,this.options.maxAnimationFrames||4,this._scene,!1,!1,$e.g.NEAREST_NEAREST,1)}addAnimationToTile(e=0,t=0,i=0,r=0,s=1){const n=this._animationMap._texture._bufferView,o=4*e+4*this.spriteCount*t;if(!n)return;n[o]=i,n[o+1]=r,n[o+2]=s;const a=this._createTileAnimationBuffer(n);this._animationMap.dispose(),this._animationMap=a,this._material.setTexture("animationMap",this._animationMap)}saveTileMaps(){let e="";for(let t=0;t<this._tileMaps.length;t++)t>0&&(e+="\n\r"),e+=this._tileMaps[t]._texture._bufferView.toString();const t=document.createElement("a");t.href="data:octet/stream;charset=utf-8,"+encodeURI(e),t.target="_blank",t.download=this.name+".tilemaps",t.click(),t.remove()}loadTileMaps(e){const t=new XMLHttpRequest;t.open("GET",e);const i=this.options.layerCount||0;t.onload=()=>{const e=t.response.split("\n\r");for(let t=0;t<i;t++){const i=e[t].split(",").map(Number),r=this._createTileBuffer(i);this._tileMaps[t].dispose(),this._tileMaps[t]=r}this._material.setTextureArray("tileMap",this._tileMaps)},t.send()}dispose(){this._output.dispose(),this._material.dispose(),this._animationMap.dispose(),this._tileMaps.forEach((e=>{e.dispose()})),this._frameMap.dispose()}}class MO extends Om{constructor(e,t,i,r,s=null,n=.01,o=$e.g.TRILINEAR_SAMPLINGMODE,a){super(e,t,i,64,r,n,o,!0,s,a),this.name=e}}var DO,OO,NO=i(87554),wO=i(79831),FO=i(62843),BO=i(24448),VO=i(26614),LO=i(86867),kO=i(56194),GO=i(82724);!function(e){e[e.ENTERING_XR=0]="ENTERING_XR",e[e.EXITING_XR=1]="EXITING_XR",e[e.IN_XR=2]="IN_XR",e[e.NOT_IN_XR=3]="NOT_IN_XR"}(DO||(DO={})),function(e){e[e.NOT_TRACKING=0]="NOT_TRACKING",e[e.TRACKING_LOST=1]="TRACKING_LOST",e[e.TRACKING=2]="TRACKING"}(OO||(OO={}));class zO extends md{constructor(e,t={}){super(e),this.options=t,this._direction=new n.Pq(0,0,-1),this._mat=new n.uq,this._onSelectEnabled=!1,this._origin=new n.Pq(0,0,0),this.lastNativeXRHitResults=[],this.onHitTestResultObservable=new s.cP,this._onHitTestResults=e=>{const t=e.map((e=>{const t=n.uq.FromArray(e.hitMatrix);return this._xrSessionManager.scene.useRightHandedSystem||t.toggleModelMatrixHandInPlace(),this.options.worldParentNode&&t.multiplyToRef(this.options.worldParentNode.getWorldMatrix(),t),{xrHitResult:e,transformationMatrix:t}}));this.lastNativeXRHitResults=e,this.onHitTestResultObservable.notifyObservers(t)},this._onSelect=e=>{this._onSelectEnabled&&zO.XRHitTestWithSelectEvent(e,this._xrSessionManager.referenceSpace)},this.xrNativeFeatureName="hit-test",H.S0.Warn("A newer version of this plugin is available")}static XRHitTestWithRay(e,t,i,r){return e.requestHitTest(t,i).then((e=>{const t=r||(e=>!!e.hitMatrix);return e.filter(t)}))}static XRHitTestWithSelectEvent(e,t){const i=e.frame.getPose(e.inputSource.targetRaySpace,t);if(!i)return Promise.resolve([]);const r=new XRRay(i.transform);return this.XRHitTestWithRay(e.frame.session,r,t)}attach(){return!!super.attach()&&(this.options.testOnPointerDownOnly&&this._xrSessionManager.session.addEventListener("select",this._onSelect,!1),!0)}detach(){return!!super.detach()&&(this._onSelectEnabled=!1,this._xrSessionManager.session.removeEventListener("select",this._onSelect),!0)}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(!this.attached||this.options.testOnPointerDownOnly)return;const t=e.getViewerPose(this._xrSessionManager.referenceSpace);if(!t)return;n.uq.FromArrayToRef(t.transform.matrix,0,this._mat),n.Pq.TransformCoordinatesFromFloatsToRef(0,0,0,this._mat,this._origin),n.Pq.TransformCoordinatesFromFloatsToRef(0,0,-1,this._mat,this._direction),this._direction.subtractInPlace(this._origin),this._direction.normalize();const i=new XRRay({x:this._origin.x,y:this._origin.y,z:this._origin.z,w:0},{x:this._direction.x,y:this._direction.y,z:this._direction.z,w:0});zO.XRHitTestWithRay(this._xrSessionManager.session,i,this._xrSessionManager.referenceSpace).then(this._onHitTestResults)}}zO.Name=Tt.HIT_TEST,zO.Version=1,Ct.AddWebXRFeature(zO.Name,((e,t)=>()=>new zO(e,t)),zO.Version,!1);let UO=0;class WO extends md{set referenceSpaceForFrameAnchors(e){this._referenceSpaceForFrameAnchors=e}constructor(e,t={}){super(e),this._options=t,this._lastFrameDetected=new Set,this._trackedAnchors=[],this._futureAnchors=[],this.onAnchorAddedObservable=new s.cP,this.onAnchorRemovedObservable=new s.cP,this.onAnchorUpdatedObservable=new s.cP,this._tmpVector=new n.Pq,this._tmpQuaternion=new n.PT,this.xrNativeFeatureName="anchors",this._options.clearAnchorsOnSessionInit&&this._xrSessionManager.onXRSessionInit.add((()=>{this._trackedAnchors.length=0,this._futureAnchors.length=0,this._lastFrameDetected.clear()}))}_populateTmpTransformation(e,t){return this._tmpVector.copyFrom(e),this._tmpQuaternion.copyFrom(t),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpVector.z*=-1,this._tmpQuaternion.z*=-1,this._tmpQuaternion.w*=-1),{position:this._tmpVector,rotationQuaternion:this._tmpQuaternion}}async addAnchorPointUsingHitTestResultAsync(e,t=new n.Pq,i=new n.PT){this._populateTmpTransformation(t,i);const r=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w});if(!e.xrHitResult.createAnchor)throw this.detach(),new Error("Anchors not enabled in this environment/browser");try{const t=await e.xrHitResult.createAnchor(r);return new Promise(((e,i)=>{this._futureAnchors.push({nativeAnchor:t,resolved:!1,submitted:!0,xrTransformation:r,resolve:e,reject:i})}))}catch(e){throw new Error(e)}}async addAnchorAtPositionAndRotationAsync(e,t=new n.PT,i=!1){this._populateTmpTransformation(e,t);const r=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w}),s=i&&this.attached&&this._xrSessionManager.currentFrame?await this._createAnchorAtTransformation(r,this._xrSessionManager.currentFrame):void 0;return new Promise(((e,t)=>{this._futureAnchors.push({nativeAnchor:s,resolved:!1,submitted:!1,xrTransformation:r,resolve:e,reject:t})}))}get anchors(){return this._trackedAnchors}detach(){if(!super.detach())return!1;if(!this._options.doNotRemoveAnchorsOnSessionEnded)for(;this._trackedAnchors.length;){const e=this._trackedAnchors.pop();e&&!e._removed&&(this.onAnchorRemovedObservable.notifyObservers(e),e._removed=!0)}return!0}dispose(){this._futureAnchors.length=0,super.dispose(),this.onAnchorAddedObservable.clear(),this.onAnchorRemovedObservable.clear(),this.onAnchorUpdatedObservable.clear()}_onXRFrame(e){if(!this.attached||!e)return;const t=e.trackedAnchors;if(t){const i=this._trackedAnchors.filter((e=>e._removed)).map((e=>this._trackedAnchors.indexOf(e)));let r=0;i.forEach((e=>{const t=this._trackedAnchors.splice(e-r,1)[0];t.xrAnchor.delete(),this.onAnchorRemovedObservable.notifyObservers(t),r++})),t.forEach((t=>{if(this._lastFrameDetected.has(t)){const i=this._findIndexInAnchorArray(t),r=this._trackedAnchors[i];try{this._updateAnchorWithXRFrame(t,r,e),r.attachedNode&&(r.attachedNode.rotationQuaternion=r.attachedNode.rotationQuaternion||new n.PT,r.transformationMatrix.decompose(r.attachedNode.scaling,r.attachedNode.rotationQuaternion,r.attachedNode.position)),this.onAnchorUpdatedObservable.notifyObservers(r)}catch(e){H.S0.Warn("Anchor could not be updated")}}else{const i={id:UO++,xrAnchor:t,remove:()=>{i._removed=!0}},r=this._updateAnchorWithXRFrame(t,i,e);this._trackedAnchors.push(r),this.onAnchorAddedObservable.notifyObservers(r);const s=this._futureAnchors.filter((e=>e.nativeAnchor===t))[0];s&&(s.resolve(r),s.resolved=!0)}})),this._lastFrameDetected=t}this._futureAnchors.forEach((t=>{t.resolved||t.submitted||(this._createAnchorAtTransformation(t.xrTransformation,e).then((e=>{t.nativeAnchor=e}),(e=>{t.resolved=!0,t.reject(e)})),t.submitted=!0)}))}_findIndexInAnchorArray(e){for(let t=0;t<this._trackedAnchors.length;++t)if(this._trackedAnchors[t].xrAnchor===e)return t;return-1}_updateAnchorWithXRFrame(e,t,i){const r=i.getPose(e.anchorSpace,this._xrSessionManager.referenceSpace);if(r){const e=t.transformationMatrix||new n.uq;n.uq.FromArrayToRef(r.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),t.transformationMatrix=e,this._options.worldParentNode&&e.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),e)}return t}async _createAnchorAtTransformation(e,t){if(!t.createAnchor)throw this.detach(),new Error("Anchors are not enabled in your browser");try{return t.createAnchor(e,this._referenceSpaceForFrameAnchors??this._xrSessionManager.referenceSpace)}catch(e){throw new Error(e)}}}WO.Name=Tt.ANCHOR_SYSTEM,WO.Version=1,Ct.AddWebXRFeature(WO.Name,((e,t)=>()=>new WO(e,t)),WO.Version);let HO=0;class $O extends md{constructor(e,t={}){super(e),this._options=t,this._detectedPlanes=[],this._enabled=!1,this._lastFrameDetected=new Set,this.onPlaneAddedObservable=new s.cP,this.onPlaneRemovedObservable=new s.cP,this.onPlaneUpdatedObservable=new s.cP,this.xrNativeFeatureName="plane-detection",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce((()=>{this._init()}))}detach(){if(!super.detach())return!1;if(!this._options.doNotRemovePlanesOnSessionEnded)for(;this._detectedPlanes.length;){const e=this._detectedPlanes.pop();e&&this.onPlaneRemovedObservable.notifyObservers(e)}return!0}dispose(){super.dispose(),this.onPlaneAddedObservable.clear(),this.onPlaneRemovedObservable.clear(),this.onPlaneUpdatedObservable.clear()}isCompatible(){return"undefined"!=typeof XRPlane}async initiateRoomCapture(){return this._xrSessionManager.session.initiateRoomCapture?this._xrSessionManager.session.initiateRoomCapture():Promise.reject("initiateRoomCapture is not supported on this session")}_onXRFrame(e){if(!this.attached||!this._enabled||!e)return;const t=e.detectedPlanes||e.worldInformation?.detectedPlanes;if(t){for(let e=0;e<this._detectedPlanes.length;e++){const i=this._detectedPlanes[e];t.has(i.xrPlane)||(this._detectedPlanes.splice(e--,1),this.onPlaneRemovedObservable.notifyObservers(i))}t.forEach((t=>{if(this._lastFrameDetected.has(t)){if(t.lastChangedTime===this._xrSessionManager.currentTimestamp){const i=this._findIndexInPlaneArray(t),r=this._detectedPlanes[i];this._updatePlaneWithXRPlane(t,r,e),this.onPlaneUpdatedObservable.notifyObservers(r)}}else{const i={id:HO++,xrPlane:t,polygonDefinition:[]},r=this._updatePlaneWithXRPlane(t,i,e);this._detectedPlanes.push(r),this.onPlaneAddedObservable.notifyObservers(r)}})),this._lastFrameDetected=t}}_init(){const e=()=>{this._enabled=!0,this._detectedPlanes.length&&(this._detectedPlanes.length=0)};this._xrSessionManager.isNative&&this._options.preferredDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions(this._options.preferredDetectorOptions),this._xrSessionManager.session.updateWorldTrackingState?(this._xrSessionManager.session.updateWorldTrackingState({planeDetectionState:{enabled:!0}}),e()):e()}_updatePlaneWithXRPlane(e,t,i){t.polygonDefinition=e.polygon.map((e=>{const t=this._xrSessionManager.scene.useRightHandedSystem?1:-1;return new n.Pq(e.x,e.y,e.z*t)}));const r=i.getPose(e.planeSpace,this._xrSessionManager.referenceSpace);if(r){const e=t.transformationMatrix||new n.uq;n.uq.FromArrayToRef(r.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),t.transformationMatrix=e,this._options.worldParentNode&&e.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),e)}return t}_findIndexInPlaneArray(e){for(let t=0;t<this._detectedPlanes.length;++t)if(this._detectedPlanes[t].xrPlane===e)return t;return-1}}$O.Name=Tt.PLANE_DETECTION,$O.Version=1,Ct.AddWebXRFeature($O.Name,((e,t)=>()=>new $O(e,t)),$O.Version);class qO extends md{constructor(e,t={}){super(e),this.options=t,this.onBackgroundStateChangedObservable=new s.cP}attach(){return this._setBackgroundState(!1),super.attach()}detach(){return this._setBackgroundState(!0),super.detach()}dispose(){super.dispose(),this.onBackgroundStateChangedObservable.clear()}_onXRFrame(e){}_setBackgroundState(e){const t=this._xrSessionManager.scene;if(!this.options.ignoreEnvironmentHelper)if(this.options.environmentHelperRemovalFlags){if(this.options.environmentHelperRemovalFlags.skyBox){const i=t.getMeshByName("BackgroundSkybox");i&&i.setEnabled(e)}if(this.options.environmentHelperRemovalFlags.ground){const i=t.getMeshByName("BackgroundPlane");i&&i.setEnabled(e)}}else{const i=t.getMeshByName("BackgroundHelper");i&&i.setEnabled(e)}this.options.backgroundMeshes&&this.options.backgroundMeshes.forEach((t=>t.setEnabled(e))),this.onBackgroundStateChangedObservable.notifyObservers(e)}}qO.Name=Tt.BACKGROUND_REMOVER,qO.Version=1,Ct.AddWebXRFeature(qO.Name,((e,t)=>()=>new qO(e,t)),qO.Version,!0);class YO{}class XO extends md{_createPhysicsImpostor(e){const t=this._options.physicsProperties.impostorType||Xs.SphereImpostor,i=this._options.physicsProperties.impostorSize||.1,r=zs("impostor-mesh-"+e.uniqueId,{diameterX:"number"==typeof i?i:i.width,diameterY:"number"==typeof i?i:i.height,diameterZ:"number"==typeof i?i:i.depth});r.isVisible=this._debugMode,r.isPickable=!1,r.rotationQuaternion=new n.PT;const s=e.grip||e.pointer;r.position.copyFrom(s.position),r.rotationQuaternion.copyFrom(s.rotationQuaternion);const o=new Xs(r,t,{mass:0,...this._options.physicsProperties});this._controllers[e.uniqueId]={xrController:e,impostor:o,impostorMesh:r}}constructor(e,t){super(e),this._options=t,this._attachController=e=>{this._controllers[e.uniqueId]||(this._xrSessionManager.scene.isPhysicsEnabled()||m.V.Warn("physics engine not enabled, skipped. Please add this controller manually."),this._options.physicsProperties.useControllerMesh&&e.inputSource.gamepad?e.onMotionControllerInitObservable.addOnce((t=>{t._doNotLoadControllerMesh?this._createPhysicsImpostor(e):t.onModelLoadedObservable.addOnce((()=>{const i=new Xs(t.rootMesh,Xs.MeshImpostor,{mass:0,...this._options.physicsProperties}),r=e.grip||e.pointer;this._controllers[e.uniqueId]={xrController:e,impostor:i,oldPos:r.position.clone(),oldRotation:r.rotationQuaternion.clone()}}))})):this._createPhysicsImpostor(e))},this._controllers={},this._debugMode=!1,this._delta=0,this._lastTimestamp=0,this._tmpQuaternion=new n.PT,this._tmpVector=new n.Pq,this._options.physicsProperties||(this._options.physicsProperties={})}_enablePhysicsDebug(){this._debugMode=!0,Object.keys(this._controllers).forEach((e=>{const t=this._controllers[e];t.impostorMesh&&(t.impostorMesh.isVisible=!0)}))}addController(e){this._attachController(e)}attach(){if(!super.attach())return!1;if(!this._options.xrInput)return!0;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),this._options.enableHeadsetImpostor){const e=this._options.headsetImpostorParams||{impostorType:Xs.SphereImpostor,restitution:.8,impostorSize:.3},t=e.impostorSize||.3;this._headsetMesh=zs("headset-mesh",{diameterX:"number"==typeof t?t:t.width,diameterY:"number"==typeof t?t:t.height,diameterZ:"number"==typeof t?t:t.depth}),this._headsetMesh.rotationQuaternion=new n.PT,this._headsetMesh.isVisible=!1,this._headsetImpostor=new Xs(this._headsetMesh,e.impostorType,{mass:0,...e})}return!0}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),this._headsetMesh&&this._headsetMesh.dispose(),!0)}getHeadsetImpostor(){return this._headsetImpostor}getImpostorForController(e){const t="string"==typeof e?e:e.uniqueId;return this._controllers[t]?this._controllers[t].impostor:null}setPhysicsProperties(e){this._options.physicsProperties={...this._options.physicsProperties,...e}}_onXRFrame(e){if(this._delta=this._xrSessionManager.currentTimestamp-this._lastTimestamp,this._lastTimestamp=this._xrSessionManager.currentTimestamp,this._headsetMesh&&this._headsetImpostor){if(this._headsetMesh.position.copyFrom(this._options.xrInput.xrCamera.globalPosition),this._headsetMesh.rotationQuaternion.copyFrom(this._options.xrInput.xrCamera.absoluteRotation),this._options.xrInput.xrCamera._lastXRViewerPose?.linearVelocity){const e=this._options.xrInput.xrCamera._lastXRViewerPose.linearVelocity;this._tmpVector.set(e.x,e.y,e.z),this._headsetImpostor.setLinearVelocity(this._tmpVector)}if(this._options.xrInput.xrCamera._lastXRViewerPose?.angularVelocity){const e=this._options.xrInput.xrCamera._lastXRViewerPose.angularVelocity;this._tmpVector.set(e.x,e.y,e.z),this._headsetImpostor.setAngularVelocity(this._tmpVector)}}Object.keys(this._controllers).forEach((e=>{const t=this._controllers[e],i=t.xrController.grip||t.xrController.pointer,r=t.oldPos||t.impostorMesh.position;if(t.xrController._lastXRPose?.linearVelocity){const e=t.xrController._lastXRPose.linearVelocity;this._tmpVector.set(e.x,e.y,e.z),t.impostor.setLinearVelocity(this._tmpVector)}else i.position.subtractToRef(r,this._tmpVector),this._tmpVector.scaleInPlace(1e3/this._delta),t.impostor.setLinearVelocity(this._tmpVector);r.copyFrom(i.position),this._debugMode&&m.V.Log([this._tmpVector,"linear"]);const s=t.oldRotation||t.impostorMesh.rotationQuaternion;if(t.xrController._lastXRPose?.angularVelocity){const e=t.xrController._lastXRPose.angularVelocity;this._tmpVector.set(e.x,e.y,e.z),t.impostor.setAngularVelocity(this._tmpVector)}else if(!s.equalsWithEpsilon(i.rotationQuaternion)){s.conjugateInPlace().multiplyToRef(i.rotationQuaternion,this._tmpQuaternion);const e=Math.sqrt(this._tmpQuaternion.x*this._tmpQuaternion.x+this._tmpQuaternion.y*this._tmpQuaternion.y+this._tmpQuaternion.z*this._tmpQuaternion.z);if(this._tmpVector.set(this._tmpQuaternion.x,this._tmpQuaternion.y,this._tmpQuaternion.z),e<.001)this._tmpVector.scaleInPlace(2);else{const t=2*Math.atan2(e,this._tmpQuaternion.w);this._tmpVector.scaleInPlace(t/(e*(this._delta/1e3)))}t.impostor.setAngularVelocity(this._tmpVector)}s.copyFrom(i.rotationQuaternion),this._debugMode&&m.V.Log([this._tmpVector,this._tmpQuaternion,"angular"])}))}_detachController(e){const t=this._controllers[e];t&&(t.impostorMesh&&t.impostorMesh.dispose(),delete this._controllers[e])}}XO.Name=Tt.PHYSICS_CONTROLLERS,XO.Version=1,Ct.AddWebXRFeature(XO.Name,((e,t)=>()=>new XO(e,t)),XO.Version,!0);class jO extends md{constructor(e,t={}){super(e),this.options=t,this._tmpMat=new n.uq,this._tmpPos=new n.Pq,this._tmpQuat=new n.PT,this._initHitTestSource=e=>{if(!e)return;const t=new XRRay(this.options.offsetRay||{}),i={space:this.options.useReferenceSpace?e:this._xrSessionManager.viewerReferenceSpace,offsetRay:t};this.options.entityTypes&&(i.entityTypes=this.options.entityTypes),i.space?this._xrSessionManager.session.requestHitTestSource(i).then((e=>{this._xrHitTestSource&&this._xrHitTestSource.cancel(),this._xrHitTestSource=e})):H.S0.Warn("waiting for viewer reference space to initialize")},this.autoCloneTransformation=!1,this.onHitTestResultObservable=new s.cP,this.paused=!1,this.xrNativeFeatureName="hit-test",H.S0.Warn("Hit test is an experimental and unstable feature.")}attach(){if(!super.attach())return!1;if(!this._xrSessionManager.session.requestHitTestSource)return!1;if(this.options.disablePermanentHitTest||(this._xrSessionManager.referenceSpace&&this._initHitTestSource(this._xrSessionManager.referenceSpace),this._xrSessionManager.onXRReferenceSpaceChanged.add(this._initHitTestSource)),this.options.enableTransientHitTest){const e=new XRRay(this.options.transientOffsetRay||{});this._xrSessionManager.session.requestHitTestSourceForTransientInput({profile:this.options.transientHitTestProfile||"generic-touchscreen",offsetRay:e,entityTypes:this.options.entityTypes}).then((e=>{this._transientXrHitTestSource=e}))}return!0}detach(){return!!super.detach()&&(this._xrHitTestSource&&(this._xrHitTestSource.cancel(),this._xrHitTestSource=null),this._xrSessionManager.onXRReferenceSpaceChanged.removeCallback(this._initHitTestSource),this._transientXrHitTestSource&&(this._transientXrHitTestSource.cancel(),this._transientXrHitTestSource=null),!0)}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(this.attached&&!this.paused){if(this._xrHitTestSource){const t=e.getHitTestResults(this._xrHitTestSource);this._processWebXRHitTestResult(t)}if(this._transientXrHitTestSource){e.getHitTestResultsForTransientInput(this._transientXrHitTestSource).forEach((e=>{this._processWebXRHitTestResult(e.results,e.inputSource)}))}}}_processWebXRHitTestResult(e,t){const i=[];e.forEach((e=>{const r=e.getPose(this._xrSessionManager.referenceSpace);if(!r)return;const s=r.transform.position,o=r.transform.orientation;this._tmpPos.set(s.x,s.y,s.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),this._tmpQuat.set(o.x,o.y,o.z,o.w),n.uq.FromFloat32ArrayToRefScaled(r.transform.matrix,0,1,this._tmpMat),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpPos.z*=-1,this._tmpQuat.z*=-1,this._tmpQuat.w*=-1,this._tmpMat.toggleModelMatrixHandInPlace());const a={position:this.autoCloneTransformation?this._tmpPos.clone():this._tmpPos,rotationQuaternion:this.autoCloneTransformation?this._tmpQuat.clone():this._tmpQuat,transformationMatrix:this.autoCloneTransformation?this._tmpMat.clone():this._tmpMat,inputSource:t,isTransient:!!t,xrHitResult:e};i.push(a)})),this.onHitTestResultObservable.notifyObservers(i)}}jO.Name=Tt.HIT_TEST,jO.Version=2,Ct.AddWebXRFeature(jO.Name,((e,t)=>()=>new jO(e,t)),jO.Version,!1);class ZO extends md{get featurePointCloud(){return this._featurePointCloud}constructor(e){super(e),this._enabled=!1,this._featurePointCloud=[],this.onFeaturePointsAddedObservable=new s.cP,this.onFeaturePointsUpdatedObservable=new s.cP,this.xrNativeFeatureName="bjsfeature-points",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce((()=>{this._init()}))}detach(){return!!super.detach()&&(this.featurePointCloud.length=0,!0)}dispose(){super.dispose(),this._featurePointCloud.length=0,this.onFeaturePointsUpdatedObservable.clear(),this.onFeaturePointsAddedObservable.clear()}_onXRFrame(e){if(!this.attached||!this._enabled||!e)return;const t=e.featurePointCloud;if(t&&0!==t.length){if(t.length%5!=0)throw new Error("Received malformed feature point cloud of length: "+t.length);const e=t.length/5,i=[],r=[];for(let s=0;s<e;s++){const e=5*s,o=t[e+4];this._featurePointCloud[o]?i.push(o):(this._featurePointCloud[o]={position:new n.Pq,confidenceValue:0},r.push(o)),this._featurePointCloud[o].position.x=t[e],this._featurePointCloud[o].position.y=t[e+1],this._featurePointCloud[o].position.z=t[e+2],this._featurePointCloud[o].confidenceValue=t[e+3]}r.length>0&&this.onFeaturePointsAddedObservable.notifyObservers(r),i.length>0&&this.onFeaturePointsUpdatedObservable.notifyObservers(i)}}_init(){this._xrSessionManager.session.trySetFeaturePointCloudEnabled&&this._xrSessionManager.session.trySetFeaturePointCloudEnabled(!0)&&(this._enabled=!0)}}ZO.Name=Tt.FEATURE_POINTS,ZO.Version=1,Ct.AddWebXRFeature(ZO.Name,(e=>()=>new ZO(e)),ZO.Version);let QO=0;class KO extends md{constructor(e,t={}){super(e),this._options=t,this._detectedMeshes=new Map,this.onMeshAddedObservable=new s.cP,this.onMeshRemovedObservable=new s.cP,this.onMeshUpdatedObservable=new s.cP,this.xrNativeFeatureName="mesh-detection",this._options.generateMeshes&&(this._options.convertCoordinateSystems=!0),this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce((()=>{this._init()}))}detach(){return!!super.detach()&&(this._xrSessionManager.isNative&&this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!1),this._options.doNotRemoveMeshesOnSessionEnded||(this._detectedMeshes.forEach((e=>{this.onMeshRemovedObservable.notifyObservers(e)})),this._detectedMeshes.clear()),!0)}dispose(){super.dispose(),this.onMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onMeshUpdatedObservable.clear()}_onXRFrame(e){try{if(!this.attached||!e)return;const t=e.detectedMeshes||e.worldInformation?.detectedMeshes;if(t){const i=new Set;this._detectedMeshes.forEach(((e,r)=>{t.has(r)||i.add(r)})),i.forEach((e=>{const t=this._detectedMeshes.get(e);t&&(this.onMeshRemovedObservable.notifyObservers(t),this._detectedMeshes.delete(e))})),t.forEach((t=>{if(this._detectedMeshes.has(t)){if(t.lastChangedTime===this._xrSessionManager.currentTimestamp){const i=this._detectedMeshes.get(t);i&&(this._updateVertexDataWithXRMesh(t,i,e),this.onMeshUpdatedObservable.notifyObservers(i))}}else{const i={id:QO++,xrMesh:t},r=this._updateVertexDataWithXRMesh(t,i,e);this._detectedMeshes.set(t,r),this.onMeshAddedObservable.notifyObservers(r)}}))}}catch(e){m.V.Log(e.stack)}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!0),this._options.preferredDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions(this._options.preferredDetectorOptions))}_updateVertexDataWithXRMesh(e,t,i){t.xrMesh=e,t.worldParentNode=this._options.worldParentNode;const r=e.vertices||e.positions;if(this._options.convertCoordinateSystems){if(this._xrSessionManager.scene.useRightHandedSystem)t.positions=r,t.normals=e.normals;else{t.positions=new Float32Array(r.length);for(let e=0;e<r.length;e+=3)t.positions[e]=r[e],t.positions[e+1]=r[e+1],t.positions[e+2]=-1*r[e+2];if(e.normals){t.normals=new Float32Array(e.normals.length);for(let i=0;i<e.normals.length;i+=3)t.normals[i]=e.normals[i],t.normals[i+1]=e.normals[i+1],t.normals[i+2]=-1*e.normals[i+2]}}t.indices=e.indices;const s=i.getPose(e.meshSpace,this._xrSessionManager.referenceSpace);if(s){const e=t.transformationMatrix||new ku.uq;ku.uq.FromArrayToRef(s.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),t.transformationMatrix=e,this._options.worldParentNode&&e.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),e)}if(this._options.generateMeshes){if(t.mesh){const e=t.mesh;e.updateVerticesData(Ot.R.PositionKind,t.positions),t.normals?e.updateVerticesData(Ot.R.NormalKind,t.normals):e.createNormals(!0),e.updateIndices(t.indices)}else{const e=new tt.e("xr mesh "+t.id,this._xrSessionManager.scene);e.rotationQuaternion=new ku.PT,e.setVerticesData(Ot.R.PositionKind,t.positions),t.normals?e.setVerticesData(Ot.R.NormalKind,t.normals):e.createNormals(!0),e.setIndices(t.indices,void 0,!0),t.mesh=e}t.transformationMatrix?.decompose(t.mesh.scaling,t.mesh.rotationQuaternion,t.mesh.position)}}return t}}var JO;KO.Name=Tt.MESH_DETECTION,KO.Version=1,Ct.AddWebXRFeature(KO.Name,((e,t)=>()=>new KO(e,t)),KO.Version,!1),function(e){e[e.NotReceived=0]="NotReceived",e[e.Waiting=1]="Waiting",e[e.Received=2]="Received"}(JO||(JO={}));class eN extends md{constructor(e,t){super(e),this.options=t,this.onUntrackableImageFoundObservable=new s.cP,this.onTrackableImageFoundObservable=new s.cP,this.onTrackedImageUpdatedObservable=new s.cP,this._trackableScoreStatus=JO.NotReceived,this._trackedImages=[],this.xrNativeFeatureName="image-tracking"}attach(){return super.attach()}detach(){return super.detach()}getTrackedImageById(e){return this._trackedImages[e]||null}dispose(){super.dispose(),this._trackedImages.forEach((e=>{e.originalBitmap.close()})),this._trackedImages.length=0,this.onTrackableImageFoundObservable.clear(),this.onUntrackableImageFoundObservable.clear(),this.onTrackedImageUpdatedObservable.clear()}async getXRSessionInitExtension(){if(!this.options.images||!this.options.images.length)return{};const e=this.options.images.map((e=>"string"==typeof e.src?this._xrSessionManager.scene.getEngine()._createImageBitmapFromSource(e.src):Promise.resolve(e.src)));try{const t=await Promise.all(e);return this._originalTrackingRequest=t.map(((e,t)=>({image:e,widthInMeters:this.options.images[t].estimatedRealWorldWidth}))),{trackedImages:this._originalTrackingRequest}}catch(e){return H.S0.Error("Error loading images for tracking, WebXRImageTracking disabled for this session."),{}}}_onXRFrame(e){if(!e.getImageTrackingResults||this._trackableScoreStatus===JO.Waiting)return;if(this._trackableScoreStatus===JO.NotReceived)return void this._checkScoresAsync();const t=e.getImageTrackingResults();for(const i of t){let t=!1;const r=i.index,s=this._trackedImages[r];if(!s)continue;s.xrTrackingResult=i,s.realWorldWidth!==i.measuredWidthInMeters&&(s.realWorldWidth=i.measuredWidthInMeters,t=!0);const o=e.getPose(i.imageSpace,this._xrSessionManager.referenceSpace);if(o){const e=s.transformationMatrix;n.uq.FromArrayToRef(o.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),t=!0}const a="emulated"===i.trackingState;s.emulated!==a&&(s.emulated=a,t=!0),t&&this.onTrackedImageUpdatedObservable.notifyObservers(s)}}async _checkScoresAsync(){if(!this._xrSessionManager.session.getTrackedImageScores||this._trackableScoreStatus!==JO.NotReceived)return;this._trackableScoreStatus=JO.Waiting;const e=await this._xrSessionManager.session.getTrackedImageScores();if(e&&0!==e.length){for(let t=0;t<e.length;++t)if("untrackable"==e[t])this.onUntrackableImageFoundObservable.notifyObservers(t);else{const e=this._originalTrackingRequest[t].image,i={id:t,originalBitmap:e,transformationMatrix:new n.uq,ratio:e.width/e.height};this._trackedImages[t]=i,this.onTrackableImageFoundObservable.notifyObservers(i)}this._trackableScoreStatus=e.length>0?JO.Received:JO.NotReceived}else this._trackableScoreStatus=JO.NotReceived}}eN.Name=Tt.IMAGE_TRACKING,eN.Version=1,Ct.AddWebXRFeature(eN.Name,((e,t)=>()=>new eN(e,t)),eN.Version,!1);class tN extends md{constructor(e,t){super(e),this.options=t,this._domOverlayType=null,this._beforeXRSelectListener=null,this._element=null,this.xrNativeFeatureName="dom-overlay",H.S0.Warn("dom-overlay is an experimental and unstable feature.")}attach(){return!!super.attach()&&(!(!this._xrSessionManager.session.domOverlayState||null===this._xrSessionManager.session.domOverlayState.type)&&(this._domOverlayType=this._xrSessionManager.session.domOverlayState.type,null!==this._element&&!0===this.options.supressXRSelectEvents&&(this._beforeXRSelectListener=e=>{e.preventDefault()},this._element.addEventListener("beforexrselect",this._beforeXRSelectListener)),!0))}get domOverlayType(){return this._domOverlayType}dispose(){super.dispose(),null!==this._element&&this._beforeXRSelectListener&&this._element.removeEventListener("beforexrselect",this._beforeXRSelectListener)}_onXRFrame(e){}async getXRSessionInitExtension(){if(void 0===this.options.element)return H.S0.Warn('"element" option must be provided to attach xr-dom-overlay feature.'),{};if("string"==typeof this.options.element){const e=document.querySelector(this.options.element);if(null===e)return H.S0.Warn(`element not found '${this.options.element}' (not requesting xr-dom-overlay)`),{};this._element=e}else this._element=this.options.element;return{domOverlay:{root:this._element}}}}tN.Name=Tt.DOM_OVERLAY,tN.Version=1,Ct.AddWebXRFeature(tN.Name,((e,t)=>()=>new tN(e,t)),tN.Version,!1);class iN extends md{get movementDirection(){return this._movementDirection}get movementEnabled(){return this._featureContext.movementEnabled}set movementEnabled(e){this._featureContext.movementEnabled=e}get movementOrientationFollowsViewerPose(){return this._featureContext.movementOrientationFollowsViewerPose}set movementOrientationFollowsViewerPose(e){this._featureContext.movementOrientationFollowsViewerPose=e}get movementSpeed(){return this._featureContext.movementSpeed}set movementSpeed(e){this._featureContext.movementSpeed=e}get movementThreshold(){return this._featureContext.movementThreshold}set movementThreshold(e){this._featureContext.movementThreshold=e}get rotationEnabled(){return this._featureContext.rotationEnabled}set rotationEnabled(e){this._featureContext.rotationEnabled=e}get rotationSpeed(){return this._featureContext.rotationSpeed}set rotationSpeed(e){this._featureContext.rotationSpeed=e}get rotationThreshold(){return this._featureContext.rotationThreshold}set rotationThreshold(e){this._featureContext.rotationThreshold=e}constructor(e,t){super(e),this._controllers={},this._currentRegistrationConfigurations=[],this._movementDirection=new n.PT,this._tmpRotationMatrix=n.uq.Identity(),this._tmpTranslationDirection=new n.Pq,this._tmpMovementTranslation=new n.Pq,this._tempCacheQuaternion=new n.PT,this._attachController=e=>{if(this._controllers[e.uniqueId])return;this._controllers[e.uniqueId]={xrController:e,registeredComponents:[]};const t=this._controllers[e.uniqueId];if("tracked-pointer"===t.xrController.inputSource.targetRayMode&&t.xrController.inputSource.gamepad){const i=()=>{if(e.motionController)for(const i of this._currentRegistrationConfigurations){let r=null;if(i.allowedComponentTypes)for(const t of i.allowedComponentTypes){const i=e.motionController.getComponentOfType(t);if(null!==i){r=i;break}}if(i.mainComponentOnly){const t=e.motionController.getMainComponent();if(null===t)continue;r=t}if("function"==typeof i.componentSelectionPredicate&&(r=i.componentSelectionPredicate(e)),r&&i.forceHandedness&&e.inputSource.handedness!==i.forceHandedness)continue;if(null===r)continue;const s={registrationConfiguration:i,component:r};t.registeredComponents.push(s),"axisChangedHandler"in i&&(s.onAxisChangedObserver=r.onAxisValueChangedObservable.add((e=>{i.axisChangedHandler(e,this._movementState,this._featureContext,this._xrInput)}))),"buttonChangedHandler"in i&&(s.onButtonChangedObserver=r.onButtonStateChangedObservable.add((e=>{e.changes.pressed&&i.buttonChangedHandler(e.changes.pressed,this._movementState,this._featureContext,this._xrInput)})))}};e.motionController?i():e.onMotionControllerInitObservable.addOnce((()=>{i()}))}},t&&void 0!==t.xrInput?(Array.isArray(t.customRegistrationConfigurations)?this._currentRegistrationConfigurations=t.customRegistrationConfigurations:this._currentRegistrationConfigurations=iN.REGISTRATIONS.default,this._featureContext={movementEnabled:t.movementEnabled||!0,movementOrientationFollowsViewerPose:t.movementOrientationFollowsViewerPose??!0,movementOrientationFollowsController:t.movementOrientationFollowsController??!1,orientationPreferredHandedness:t.orientationPreferredHandedness,movementSpeed:t.movementSpeed??1,movementThreshold:t.movementThreshold??.25,rotationEnabled:t.rotationEnabled??!0,rotationSpeed:t.rotationSpeed??1,rotationThreshold:t.rotationThreshold??.25},this._movementState={moveX:0,moveY:0,rotateX:0,rotateY:0},this._xrInput=t.xrInput):H.S0.Error('WebXRControllerMovement feature requires "xrInput" option.')}attach(){return!!super.attach()&&(this._xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),this._controllers={},!0)}_onXRFrame(e){if(this.attached){if(0!==this._movementState.rotateX&&this._featureContext.rotationEnabled){const e=.001*this._xrSessionManager.scene.getEngine().getDeltaTime()*this._featureContext.rotationSpeed*this._movementState.rotateX*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);if(this._featureContext.movementOrientationFollowsViewerPose)this._xrInput.xrCamera.cameraRotation.y+=e,n.PT.RotationYawPitchRollToRef(e,0,0,this._tempCacheQuaternion),this._xrInput.xrCamera.rotationQuaternion.multiplyToRef(this._tempCacheQuaternion,this._movementDirection);else if(this._featureContext.movementOrientationFollowsController){this._xrInput.xrCamera.cameraRotation.y+=e;const t=this._featureContext.orientationPreferredHandedness||"right",i=Object.keys(this._controllers).find((e=>this._controllers[e]?.xrController?.inputSource.handedness===t))||Object.keys(this._controllers)[0],r=this._controllers[i];n.PT.RotationYawPitchRollToRef(e,0,0,this._tempCacheQuaternion),(r?.xrController.pointer.rotationQuaternion||n.PT.Identity()).multiplyToRef(this._tempCacheQuaternion,this._movementDirection)}else n.PT.RotationYawPitchRollToRef(3*e,0,0,this._tempCacheQuaternion),this._movementDirection.multiplyInPlace(this._tempCacheQuaternion)}else if(this._featureContext.movementOrientationFollowsViewerPose)this._movementDirection.copyFrom(this._xrInput.xrCamera.rotationQuaternion);else if(this._featureContext.movementOrientationFollowsController){const e=this._featureContext.orientationPreferredHandedness||"right",t=Object.keys(this._controllers).find((t=>this._controllers[t]?.xrController.inputSource.handedness===e))||Object.keys(this._controllers)[0],i=this._controllers[t];this._movementDirection.copyFrom(i?.xrController.pointer.rotationQuaternion||n.PT.Identity())}(this._movementState.moveX||this._movementState.moveY)&&this._featureContext.movementEnabled&&(n.uq.FromQuaternionToRef(this._movementDirection,this._tmpRotationMatrix),this._tmpTranslationDirection.set(this._movementState.moveX,0,this._movementState.moveY*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),n.Pq.TransformCoordinatesToRef(this._tmpTranslationDirection,this._tmpRotationMatrix,this._tmpMovementTranslation),this._tmpMovementTranslation.scaleInPlace(this._xrInput.xrCamera._computeLocalCameraSpeed()*this._featureContext.movementSpeed),this._xrInput.xrCamera.cameraDirection.addInPlace(this._tmpMovementTranslation))}}_detachController(e){const t=this._controllers[e];if(t){for(const e of t.registeredComponents)e.onAxisChangedObserver&&e.component.onAxisValueChangedObservable.remove(e.onAxisChangedObserver),e.onButtonChangedObserver&&e.component.onButtonStateChangedObservable.remove(e.onButtonChangedObserver);delete this._controllers[e]}}}iN.Name=Tt.MOVEMENT,iN.REGISTRATIONS={default:[{allowedComponentTypes:[rd.THUMBSTICK_TYPE,rd.TOUCHPAD_TYPE],forceHandedness:"left",axisChangedHandler:(e,t,i)=>{t.rotateX=Math.abs(e.x)>i.rotationThreshold?e.x:0,t.rotateY=Math.abs(e.y)>i.rotationThreshold?e.y:0}},{allowedComponentTypes:[rd.THUMBSTICK_TYPE,rd.TOUCHPAD_TYPE],forceHandedness:"right",axisChangedHandler:(e,t,i)=>{t.moveX=Math.abs(e.x)>i.movementThreshold?e.x:0,t.moveY=Math.abs(e.y)>i.movementThreshold?e.y:0}}]},iN.Version=1,Ct.AddWebXRFeature(iN.Name,((e,t)=>()=>new iN(e,t)),iN.Version,!0);var rN=i(75515);class sN extends md{constructor(e,t){super(e),this.options=t,this._canvasContext=null,this._reflectionCubeMap=null,this._xrLightEstimate=null,this._xrLightProbe=null,this._xrWebGLBinding=null,this._lightDirection=n.Pq.Up().negateInPlace(),this._lightColor=o.v9.White(),this._intensity=1,this._sphericalHarmonics=new iS.O,this._cubeMapPollTime=Date.now(),this._lightEstimationPollTime=Date.now(),this._reflectionCubeMapTextureSize=16,this.directionalLight=null,this.onReflectionCubeMapUpdatedObservable=new s.cP,this._updateReflectionCubeMap=()=>{if(!this._xrLightProbe)return;if(this.options.cubeMapPollInterval){const e=Date.now();if(e-this._cubeMapPollTime<this.options.cubeMapPollInterval)return;this._cubeMapPollTime=e}const e=this._getXRGLBinding().getReflectionCubeMap(this._xrLightProbe);if(e&&this._reflectionCubeMap){if(this._reflectionCubeMap._texture)this._reflectionCubeMap._texture._hardwareTexture?.set(e),this._reflectionCubeMap._texture.getEngine().resetTextureCache();else{const t=new lr.h(this._xrSessionManager.scene.getEngine(),0);t.isCube=!0,t.invertY=!1,t._useSRGBBuffer="srgba8"===this.options.reflectionFormat,t.format=5,t.generateMipMaps=!0,t.type="srgba8"!==this.options.reflectionFormat?2:0,t.samplingMode=3,t.width=this._reflectionCubeMapTextureSize,t.height=this._reflectionCubeMapTextureSize,t._cachedWrapU=1,t._cachedWrapV=1,t._hardwareTexture=new Er.d(e,this._getCanvasContext()),this._reflectionCubeMap._texture=t}this._reflectionCubeMap._texture.isReady=!0,this.options.disablePreFiltering?(this._xrSessionManager.scene.markAllMaterialsAsDirty(1),this.onReflectionCubeMapUpdatedObservable.notifyObservers(this._reflectionCubeMap)):(this._xrLightProbe.removeEventListener("reflectionchange",this._updateReflectionCubeMap),this._hdrFilter.prefilter(this._reflectionCubeMap).then((()=>{this._xrSessionManager.scene.markAllMaterialsAsDirty(1),this.onReflectionCubeMapUpdatedObservable.notifyObservers(this._reflectionCubeMap),this._xrLightProbe.addEventListener("reflectionchange",this._updateReflectionCubeMap)})))}},this.xrNativeFeatureName="light-estimation",this.options.createDirectionalLightSource&&(this.directionalLight=new Hh.Z("light estimation directional",this._lightDirection,this._xrSessionManager.scene),this.directionalLight.position=new n.Pq(0,8,0),this.directionalLight.intensity=0,this.directionalLight.falloffType=rN.c.FALLOFF_GLTF),this._hdrFilter=new Pf.F(this._xrSessionManager.scene.getEngine()),H.S0.Warn("light-estimation is an experimental and unstable feature.")}get reflectionCubeMapTexture(){return this._reflectionCubeMap}get xrLightingEstimate(){return this._xrLightEstimate?{lightColor:this._lightColor,lightDirection:this._lightDirection,lightIntensity:this._intensity,sphericalHarmonics:this._sphericalHarmonics}:this._xrLightEstimate}_getCanvasContext(){return null===this._canvasContext&&(this._canvasContext=this._xrSessionManager.scene.getEngine()._gl),this._canvasContext}_getXRGLBinding(){if(null===this._xrWebGLBinding){const e=this._getCanvasContext();this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,e)}return this._xrWebGLBinding}attach(){if(!super.attach())return!1;const e=this.options.reflectionFormat??(this._xrSessionManager.session.preferredReflectionFormat||"srgba8");return this.options.reflectionFormat=e,this._xrSessionManager.session.requestLightProbe({reflectionFormat:e}).then((e=>{this._xrLightProbe=e,this.options.disableCubeMapReflection||(this._reflectionCubeMap||(this._reflectionCubeMap=new zu.t(this._xrSessionManager.scene),this._reflectionCubeMap._isCube=!0,this._reflectionCubeMap.coordinatesMode=3,this.options.setSceneEnvironmentTexture&&(this._xrSessionManager.scene.environmentTexture=this._reflectionCubeMap)),this._xrLightProbe.addEventListener("reflectionchange",this._updateReflectionCubeMap))})),!0}detach(){const e=super.detach();return null===this._xrLightProbe||this.options.disableCubeMapReflection||(this._xrLightProbe.removeEventListener("reflectionchange",this._updateReflectionCubeMap),this._xrLightProbe=null),this._canvasContext=null,this._xrLightEstimate=null,this._xrWebGLBinding=null,e}dispose(){super.dispose(),this.onReflectionCubeMapUpdatedObservable.clear(),this.directionalLight&&(this.directionalLight.dispose(),this.directionalLight=null),null!==this._reflectionCubeMap&&(this._reflectionCubeMap._texture&&this._reflectionCubeMap._texture.dispose(),this._reflectionCubeMap.dispose(),this._reflectionCubeMap=null)}_onXRFrame(e){if(null!==this._xrLightProbe){if(this.options.lightEstimationPollInterval){const e=Date.now();if(e-this._lightEstimationPollTime<this.options.lightEstimationPollInterval)return;this._lightEstimationPollTime=e}if(this._xrLightEstimate=e.getLightEstimate(this._xrLightProbe),this._xrLightEstimate){this._intensity=Math.max(1,this._xrLightEstimate.primaryLightIntensity.x,this._xrLightEstimate.primaryLightIntensity.y,this._xrLightEstimate.primaryLightIntensity.z);const e=this._xrSessionManager.scene.useRightHandedSystem?1:-1;this.options.disableVectorReuse&&(this._lightDirection=new n.Pq,this._lightColor=new o.v9,this.directionalLight&&(this.directionalLight.direction=this._lightDirection,this.directionalLight.diffuse=this._lightColor)),this._lightDirection.copyFromFloats(this._xrLightEstimate.primaryLightDirection.x,this._xrLightEstimate.primaryLightDirection.y,this._xrLightEstimate.primaryLightDirection.z*e),this._lightColor.copyFromFloats(this._xrLightEstimate.primaryLightIntensity.x/this._intensity,this._xrLightEstimate.primaryLightIntensity.y/this._intensity,this._xrLightEstimate.primaryLightIntensity.z/this._intensity),this._sphericalHarmonics.updateFromFloatsArray(this._xrLightEstimate.sphericalHarmonicsCoefficients),this._reflectionCubeMap&&!this.options.disableSphericalPolynomial&&(this._reflectionCubeMap.sphericalPolynomial=this._reflectionCubeMap.sphericalPolynomial||new iS.Q,this._reflectionCubeMap.sphericalPolynomial?.updateFromHarmonics(this._sphericalHarmonics)),this._lightDirection.negateInPlace(),this.directionalLight&&(this.directionalLight.direction.copyFrom(this._lightDirection),this.directionalLight.intensity=Math.min(this._intensity,1),this.directionalLight.diffuse.copyFrom(this._lightColor))}}}}sN.Name=Tt.LIGHT_ESTIMATION,sN.Version=1,Ct.AddWebXRFeature(sN.Name,((e,t)=>()=>new sN(e,t)),sN.Version,!1);class nN extends md{constructor(e){super(e),this.onEyeTrackingStartedObservable=new s.cP,this.onEyeTrackingEndedObservable=new s.cP,this.onEyeTrackingFrameUpdateObservable=new s.cP,this._eyeTrackingStartListener=e=>{this._latestEyeSpace=e.gazeSpace,this._gazeRay=new st.Ray(n.Pq.Zero(),n.Pq.Forward()),this.onEyeTrackingStartedObservable.notifyObservers(this._gazeRay)},this._eyeTrackingEndListener=()=>{this._latestEyeSpace=null,this._gazeRay=null,this.onEyeTrackingEndedObservable.notifyObservers()},this.xrNativeFeatureName="eye-tracking",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce((()=>{this._init()}))}dispose(){super.dispose(),this._xrSessionManager.session.removeEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.removeEventListener("eyetrackingend",this._eyeTrackingEndListener),this.onEyeTrackingStartedObservable.clear(),this.onEyeTrackingEndedObservable.clear(),this.onEyeTrackingFrameUpdateObservable.clear()}get isEyeGazeValid(){return!!this._gazeRay}getEyeGaze(){return this._gazeRay}_onXRFrame(e){if(this.attached&&e&&this._latestEyeSpace&&this._gazeRay){const t=e.getPose(this._latestEyeSpace,this._xrSessionManager.referenceSpace);if(t){this._gazeRay.origin.set(t.transform.position.x,t.transform.position.y,t.transform.position.z).scaleInPlace(this._xrSessionManager.worldScalingFactor);const e=t.transform.orientation;n.AA.Quaternion[0].set(e.x,e.y,e.z,e.w),this._xrSessionManager.scene.useRightHandedSystem?n.Pq.RightHandedForwardReadOnly.rotateByQuaternionToRef(n.AA.Quaternion[0],this._gazeRay.direction):(this._gazeRay.origin.z*=-1,n.AA.Quaternion[0].z*=-1,n.AA.Quaternion[0].w*=-1,n.Pq.LeftHandedForwardReadOnly.rotateByQuaternionToRef(n.AA.Quaternion[0],this._gazeRay.direction)),this.onEyeTrackingFrameUpdateObservable.notifyObservers(this._gazeRay)}}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.addEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.addEventListener("eyetrackingend",this._eyeTrackingEndListener))}}nN.Name=Tt.EYE_TRACKING,nN.Version=1,Ct.AddWebXRFeature(nN.Name,(e=>()=>new nN(e)),nN.Version,!1);class oN{constructor(e,t){this._samples=[],this._idx=0;for(let i=0;i<e;++i)this._samples.push(t?t():n.I9.Zero())}get length(){return this._samples.length}push(e,t){this._idx=(this._idx+this._samples.length-1)%this._samples.length,this.at(0).copyFromFloats(e,t)}at(e){if(e>=this._samples.length)throw new Error("Index out of bounds");return this._samples[(this._idx+e)%this._samples.length]}}class aN{constructor(){this._samples=new oN(20),this._entropy=0,this.onFirstStepDetected=new s.cP}update(e,t,i,r){this._samples.push(e,t);const s=this._samples.at(0);if(this._entropy*=this._entropyDecayFactor,this._entropy+=n.I9.Distance(s,this._samples.at(1)),this._entropy>this._entropyThreshold)return;let o;for(o=this._samePointCheckStartIdx;o<this._samples.length&&!(n.I9.DistanceSquared(s,this._samples.at(o))<this._samePointSquaredDistanceThreshold);++o);if(o===this._samples.length)return;let a=-1,l=0;for(let e,t=1;t<o;++t)e=n.I9.DistanceSquared(s,this._samples.at(t)),e>a&&(l=t,a=e);if(a<this._apexSquaredDistanceThreshold)return;const h=this._samples.at(l),c=h.subtract(s);c.normalize();const u=n.AA.Vector2[0];let d,p,m=0;for(let e=1;e<o;++e)p=this._samples.at(e),p.subtractToRef(s,u),d=n.I9.Dot(c,u),m+=u.lengthSquared()-d*d;if(m>o*this._squaredProjectionDistanceThreshold)return;const f=n.AA.Vector3[0];f.set(i,r,0);const _=n.AA.Vector3[1];_.set(c.x,c.y,0);const g=n.Pq.Cross(f,_).z>0,x=s.clone(),v=s.clone();h.subtractToRef(s,c),g?(c.scaleAndAddToRef(this._axisToApexShrinkFactor,x),c.scaleAndAddToRef(this._axisToApexExtendFactor,v)):(c.scaleAndAddToRef(this._axisToApexExtendFactor,x),c.scaleAndAddToRef(this._axisToApexShrinkFactor,v)),this.onFirstStepDetected.notifyObservers({leftApex:x,rightApex:v,currentPosition:s,currentStepDirection:g?"right":"left"})}reset(){for(let e=0;e<this._samples.length;++e)this._samples.at(e).copyFromFloats(0,0)}get _samePointCheckStartIdx(){return Math.floor(this._samples.length/3)}get _samePointSquaredDistanceThreshold(){return 9e-4}get _apexSquaredDistanceThreshold(){return.0081}get _squaredProjectionDistanceThreshold(){return 9e-4}get _axisToApexShrinkFactor(){return.8}get _axisToApexExtendFactor(){return-1.6}get _entropyDecayFactor(){return.93}get _entropyThreshold(){return.4}}class lN{constructor(e,t,i,r){this._leftApex=new n.I9,this._rightApex=new n.I9,this._currentPosition=new n.I9,this._axis=new n.I9,this._axisLength=-1,this._forward=new n.I9,this._steppingLeft=!1,this._t=-1,this._maxT=-1,this._maxTPosition=new n.I9,this._vitality=0,this.onMovement=new s.cP,this.onFootfall=new s.cP,this._reset(e,t,i,"left"===r)}_reset(e,t,i,r){this._leftApex.copyFrom(e),this._rightApex.copyFrom(t),this._steppingLeft=r,this._steppingLeft?(this._leftApex.subtractToRef(this._rightApex,this._axis),this._forward.copyFromFloats(-this._axis.y,this._axis.x)):(this._rightApex.subtractToRef(this._leftApex,this._axis),this._forward.copyFromFloats(this._axis.y,-this._axis.x)),this._axisLength=this._axis.length(),this._forward.scaleInPlace(1/this._axisLength),this._updateTAndVitality(i.x,i.y),this._maxT=this._t,this._maxTPosition.copyFrom(i),this._vitality=1}_updateTAndVitality(e,t){this._currentPosition.copyFromFloats(e,t),this._steppingLeft?this._currentPosition.subtractInPlace(this._rightApex):this._currentPosition.subtractInPlace(this._leftApex);const i=this._t,r=n.I9.Dot(this._currentPosition,this._axis);this._t=r/(this._axisLength*this._axisLength);const s=this._currentPosition.lengthSquared()-r/this._axisLength*(r/this._axisLength);this._vitality*=.92-100*Math.max(s-.0016,0)+Math.max(this._t-i,0)}update(e,t){if(this._vitality<this._vitalityThreshold)return!1;const i=this._t;return this._updateTAndVitality(e,t),this._t>this._maxT&&(this._maxT=this._t,this._maxTPosition.copyFromFloats(e,t)),!(this._vitality<this._vitalityThreshold)&&(this._t>i&&(this.onMovement.notifyObservers({deltaT:this._t-i}),i<.5&&this._t>=.5&&this.onFootfall.notifyObservers({foot:this._steppingLeft?"left":"right"})),this._t<.95*this._maxT&&(this._currentPosition.copyFromFloats(e,t),this._steppingLeft?this._leftApex.copyFrom(this._maxTPosition):this._rightApex.copyFrom(this._maxTPosition),this._reset(this._leftApex,this._rightApex,this._currentPosition,!this._steppingLeft)),!(this._axisLength<.03))}get _vitalityThreshold(){return.1}get forward(){return this._forward}}class hN{static get _MillisecondsPerUpdate(){return 1e3/15}constructor(e){this._detector=new aN,this._walker=null,this._movement=new n.I9,this._millisecondsSinceLastUpdate=hN._MillisecondsPerUpdate,this.movementThisFrame=n.Pq.Zero(),this._engine=e,this._detector.onFirstStepDetected.add((e=>{this._walker||(this._walker=new lN(e.leftApex,e.rightApex,e.currentPosition,e.currentStepDirection),this._walker.onFootfall.add((()=>{m.V.Log("Footfall!")})),this._walker.onMovement.add((e=>{this._walker.forward.scaleAndAddToRef(.024*e.deltaT,this._movement)})))}))}update(e,t){if(t.y=0,t.normalize(),this._millisecondsSinceLastUpdate+=this._engine.getDeltaTime(),this._millisecondsSinceLastUpdate>=hN._MillisecondsPerUpdate){if(this._millisecondsSinceLastUpdate-=hN._MillisecondsPerUpdate,this._detector.update(e.x,e.z,t.x,t.z),this._walker){this._walker.update(e.x,e.z)||(this._walker=null)}this._movement.scaleInPlace(.85)}this.movementThisFrame.set(this._movement.x,0,this._movement.y)}}class cN extends md{static get Name(){return Tt.WALKING_LOCOMOTION}static get Version(){return 1}get locomotionTarget(){return this._locomotionTarget}set locomotionTarget(e){this._locomotionTarget=e,this._isLocomotionTargetWebXRCamera="WebXRCamera"===this._locomotionTarget.getClassName()}constructor(e,t){super(e),this._up=new n.Pq,this._forward=new n.Pq,this._position=new n.Pq,this._movement=new n.Pq,this._sessionManager=e,this.locomotionTarget=t.locomotionTarget,this._isLocomotionTargetWebXRCamera&&m.V.Warn("Using walking locomotion directly on a WebXRCamera may have unintended interactions with other XR techniques. Using an XR space parent is highly recommended")}isCompatible(){return void 0===this._sessionManager.sessionMode||"immersive-vr"===this._sessionManager.sessionMode}attach(){return!(!this.isCompatible||!super.attach())&&(this._walker=new hN(this._sessionManager.scene.getEngine()),!0)}detach(){return!!super.detach()&&(this._walker=null,!0)}_onXRFrame(e){const t=e.getViewerPose(this._sessionManager.baseReferenceSpace);if(!t)return;const i=this.locomotionTarget.getScene().useRightHandedSystem?1:-1,r=t.transform.matrix;this._up.copyFromFloats(r[4],r[5],i*r[6]),this._forward.copyFromFloats(r[8],r[9],i*r[10]),this._position.copyFromFloats(r[12],r[13],i*r[14]),this._forward.scaleAndAddToRef(.05,this._position),this._up.scaleAndAddToRef(-.05,this._position),this._walker.update(this._position,this._forward),this._movement.copyFrom(this._walker.movementThisFrame),this._isLocomotionTargetWebXRCamera||n.Pq.TransformNormalToRef(this._movement,this.locomotionTarget.getWorldMatrix(),this._movement),this.locomotionTarget.position.addInPlace(this._movement)}}Ct.AddWebXRFeature(cN.Name,((e,t)=>()=>new cN(e,t)),cN.Version,!1);class uN extends Cr{constructor(e,t,i,r,s,n,o=null){super(e,t,i,r,n),this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=r,this.isMultiview=s,this.createRTTProvider=n,this._originalInternalTexture=o}}class dN extends Ar{constructor(e,t,i){super(e.scene,i),this._xrSessionManager=e,this._xrWebGLBinding=t,this.layerWrapper=i,this._lastSubImages=new Map,this.onRenderTargetTextureCreatedObservable=new s.cP,this._compositionLayer=i.layer}_getRenderTargetForSubImage(e,t="none"){const i=this._lastSubImages.get(t),r="right"==t?1:0,s=e.colorTextureWidth??e.textureWidth,n=e.colorTextureHeight??e.textureHeight;if(!this._renderTargetTextures[r]||i?.textureWidth!==s||i?.textureHeight!==n){let i;const o=e.depthStencilTextureWidth??s,a=e.depthStencilTextureHeight??n;s!==o&&n!==a||(i=e.depthStencilTexture),this._renderTargetTextures[r]=this._createRenderTargetTexture(s,n,null,e.colorTexture,i,this.layerWrapper.isMultiview),this._framebufferDimensions={framebufferWidth:s,framebufferHeight:n},this.onRenderTargetTextureCreatedObservable.notifyObservers({texture:this._renderTargetTextures[r],eye:t})}return this._lastSubImages.set(t,e),this._renderTargetTextures[r]}_getSubImageForEye(e){const t=this._xrSessionManager.currentFrame;return t?this._xrWebGLBinding.getSubImage(this._compositionLayer,t,e):null}getRenderTargetTextureForEye(e){const t=this._getSubImageForEye(e);return t?this._getRenderTargetForSubImage(t,e):null}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e?.eye)}_setViewportForSubImage(e,t){const i=t.colorTextureWidth??t.textureWidth,r=t.colorTextureHeight??t.textureHeight,s=t.viewport;e.x=s.x/i,e.y=s.y/r,e.width=s.width/i,e.height=s.height/r}trySetViewportForView(e,t){const i=this._lastSubImages.get(t.eye)||this._getSubImageForEye(t.eye);return!!i&&(this._setViewportForSubImage(e,i),!0)}}class pN extends uN{constructor(e,t,i){super((()=>e.textureWidth),(()=>e.textureHeight),e,"XRProjectionLayer",t,(e=>new mN(e,i,this))),this.layer=e}}class mN extends dN{constructor(e,t,i){super(e,t,i),this.layerWrapper=i,this._projectionLayer=i.layer}_getSubImageForView(e){return this._xrWebGLBinding.getViewSubImage(this._projectionLayer,e)}getRenderTargetTextureForView(e){return this._getRenderTargetForSubImage(this._getSubImageForView(e),e.eye)}getRenderTargetTextureForEye(e){const t=this._lastSubImages.get(e);return t?this._getRenderTargetForSubImage(t,e):null}trySetViewportForView(e,t){const i=this._lastSubImages.get(t.eye)||this._getSubImageForView(t);return!!i&&(this._setViewportForSubImage(e,i),!0)}}const fN={textureType:"texture",colorFormat:6408,depthFormat:35056,scaleFactor:1,clearOnAccess:!1},_N={};class gN extends md{constructor(e,t={}){super(e),this._options=t,this._existingLayers=[],this._isMultiviewEnabled=!1,this._projectionLayerInitialized=!1,this._compositionLayerTextureMapping=new WeakMap,this._layerToRTTProviderMapping=new WeakMap,this.xrNativeFeatureName="layers"}attach(){if(!super.attach())return!1;const e=this._xrSessionManager.scene.getEngine();this._glContext=e._gl,this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),this._existingLayers.length=0;const t={...fN,...this._options.projectionLayerInit};return this._isMultiviewEnabled=this._options.preferMultiviewOnInit&&e.getCaps().multiview,this.createProjectionLayer(t),this._projectionLayerInitialized=!0,!0}detach(){return!!super.detach()&&(this._existingLayers.forEach((e=>{e.dispose()})),this._existingLayers.length=0,this._projectionLayerInitialized=!1,!0)}createXRWebGLLayer(e=_N){const t=new XRWebGLLayer(this._xrSessionManager.session,this._glContext,e);return new Ir(t)}_validateLayerInit(e,t=this._isMultiviewEnabled){if(!this._xrSessionManager.inXRSession)throw new Error("Cannot create a layer outside of a WebXR session. Make sure the session has started before creating layers.");if(t&&"texture-array"!==e.textureType)throw new Error("Projection layers can only be made multiview if they use texture arrays. Set the textureType parameter to 'texture-array'.");if(!t&&"texture-array"===e.textureType)throw new Error("We currently only support multiview rendering when the textureType parameter is set to 'texture-array'.")}_extendXRLayerInit(e,t=this._isMultiviewEnabled){return t&&(e.textureType="texture-array"),e}createProjectionLayer(e=fN,t=this._isMultiviewEnabled){this._extendXRLayerInit(e,t),this._validateLayerInit(e,t);const i=this._xrWebGLBinding.createProjectionLayer(e),r=new pN(i,t,this._xrWebGLBinding);return this.addXRSessionLayer(r),r}_createQuadLayer(e={params:{}},t){this._extendXRLayerInit(e.params,!1);const i=this._existingLayers[0].layer.textureWidth,r=this._existingLayers[0].layer.textureHeight,s={space:this._xrSessionManager.referenceSpace,viewPixelWidth:i,viewPixelHeight:r,clearOnAccess:!0,...e.params};this._validateLayerInit(s,!1);const n=this._xrWebGLBinding.createQuadLayer(s);n.width=this._isMultiviewEnabled?1:2,n.height=1;const o=new uN((()=>n.width),(()=>n.height),n,"XRQuadLayer",!1,(e=>new dN(e,this._xrWebGLBinding,o)));t&&this._compositionLayerTextureMapping.set(n,t);const a=o.createRenderTargetTextureProvider(this._xrSessionManager);return this._layerToRTTProviderMapping.set(n,a),this.addXRSessionLayer(o),o}addFullscreenAdvancedDynamicTexture(e,t={distanceFromHeadset:1.5}){const i=this._createQuadLayer({params:{space:this._xrSessionManager.viewerReferenceSpace,textureType:"texture",layout:"mono"}},e),r=i.layer,s={x:0,y:0,z:-Math.max(.1,t.distanceFromHeadset)};r.transform=new XRRigidTransform(s,{x:0,y:0,z:0,w:1});const n=this._layerToRTTProviderMapping.get(r);if(!n)throw new Error("Could not find the RTT provider for the layer");const a=this._xrSessionManager.scene.layers.find((t=>t.texture===e));if(!a)throw new Error("Could not find the babylon layer for the texture");return n.onRenderTargetTextureCreatedObservable.add((e=>{e.eye&&"right"===e.eye||(e.texture.clearColor=new o.ov(0,0,0,0),a.renderTargetTextures.push(e.texture),a.renderOnlyInRenderTargetTextures=!0,this._xrSessionManager.scene.onBeforeRenderObservable.add((()=>{e.texture.render()})),a.renderTargetTextures.push(e.texture),a.renderOnlyInRenderTargetTextures=!0,this._xrSessionManager.onXRSessionEnded.addOnce((()=>{a.renderTargetTextures.splice(a.renderTargetTextures.indexOf(e.texture),1),a.renderOnlyInRenderTargetTextures=!1})))})),i}_addLensFlareSystem(e){const t=this._createQuadLayer({params:{space:this._xrSessionManager.viewerReferenceSpace,textureType:"texture",layout:"mono"}}),i=t.layer;i.width=2,i.height=1;const r={x:0,y:0,z:-10};i.transform=new XRRigidTransform(r,{x:0,y:0,z:0,w:1});const s=this._layerToRTTProviderMapping.get(i);if(!s)throw new Error("Could not find the RTT provider for the layer");return s.onRenderTargetTextureCreatedObservable.add((t=>{t.texture.clearColor=new o.ov(0,0,0,0),t.texture.customRenderFunction=()=>{e.render()}})),this._xrSessionManager.onXRSessionInit.add((()=>{this._xrSessionManager.scene.lensFlareSystems.splice(this._xrSessionManager.scene.lensFlareSystems.indexOf(e),1)})),this._xrSessionManager.onXRSessionEnded.add((()=>{this._xrSessionManager.scene.lensFlareSystems.push(e)})),t}addXRSessionLayer(e){this._existingLayers.push(e),this.setXRSessionLayers(this._existingLayers)}setXRSessionLayers(e=this._existingLayers){const t={...this._xrSessionManager.session.renderState};t.baseLayer=void 0,t.layers=e.map((e=>e.layer)),this._xrSessionManager.updateRenderState(t),this._projectionLayerInitialized||this._xrSessionManager._setBaseLayerWrapper(e.length>0?e.at(0):null)}isCompatible(){return!this._xrSessionManager.isNative&&"undefined"!=typeof XRWebGLBinding&&!!XRWebGLBinding.prototype.createProjectionLayer}dispose(){super.dispose()}_onXRFrame(e){const t=this._existingLayers;for(let i=0;i<t.length;++i){const r=t[i];if("XRProjectionLayer"!==r.layerType){const t=this._layerToRTTProviderMapping.get(r.layer);if(!t)continue;if(t.layerWrapper.isMultiview){const i=e.getViewerPose(this._xrSessionManager.referenceSpace);if(i){const e=i.views;for(let i=0;i<e.length;++i){const r=e[i];t.getRenderTargetTextureForView(r)}}}else t.getRenderTargetTextureForView()}}}}gN.Name=Tt.LAYERS,gN.Version=1,Ct.AddWebXRFeature(gN.Name,((e,t)=>()=>new gN(e,t)),gN.Version,!1);class xN extends Hu.M{constructor(){super(...arguments),this.DEPTH_SENSING=!1,this.DEPTH_SENSING_TEXTURE_ARRAY=!1,this.DEPTH_SENSING_TEXTURE_AL=!1,this.DEPTH_SENSING_DISCARD=!0}}let vN=!1,SN=null,bN=!1;const yN={width:512,height:512},PN={x:0,y:0,width:1,height:1};let TN=1,CN=0,EN=!0;const AN=n.uq.Identity(),IN=[];class RN extends vv.y{_markAllDefinesAsDirty(){this._enable(this._isEnabled),this.markAllDefinesAsDirty()}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._markAllDefinesAsDirty())}isCompatible(e){return!0}constructor(e){super(e,"DepthSensing",222,new xN),this._isEnabled=!1,this._varColorName=e instanceof sf.d?"finalColor":"color",IN.push(this)}prepareDefines(e){e.DEPTH_SENSING=!!SN&&vN,e.DEPTH_SENSING_TEXTURE_ARRAY=SN?.is2DArray??!1,e.DEPTH_SENSING_TEXTURE_AL=bN,e.DEPTH_SENSING_DISCARD=EN}getUniforms(){return{ubo:[{name:"ds_invScreenSize",size:2,type:"vec2"},{name:"ds_rawValueToMeters",size:1,type:"float"},{name:"ds_viewIndex",size:1,type:"float"},{name:"ds_shaderViewport",size:4,type:"vec4"},{name:"ds_uvTransform",size:16,type:"mat4"}],fragment:"#ifdef DEPTH_SENSING\n                uniform vec2 ds_invScreenSize;\n                uniform float ds_rawValueToMeters;\n                uniform float ds_viewIndex;\n                uniform vec4 ds_shaderViewport;\n                uniform mat4 ds_uvTransform;\n                #endif\n                "}}getSamplers(e){e.push("ds_depthSampler")}bindForSubMesh(e){vN&&SN&&(e.updateFloat2("ds_invScreenSize",1/yN.width,1/yN.height),e.updateFloat("ds_rawValueToMeters",TN),e.updateFloat("ds_viewIndex",CN),e.updateFloat4("ds_shaderViewport",PN.x,PN.y,PN.width,PN.height),e.setTexture("ds_depthSampler",SN),e.updateMatrix("ds_uvTransform",AN))}getClassName(){return"DepthSensingMaterialPlugin"}getCustomCode(e){return"vertex"===e?{CUSTOM_VERTEX_MAIN_BEGIN:"\n                #ifdef DEPTH_SENSING\n                #ifdef MULTIVIEW\n                    ds_viewIndexMultiview = float(gl_ViewID_OVR);\n                #endif\n                #endif\n                ",CUSTOM_VERTEX_DEFINITIONS:"\n                #ifdef DEPTH_SENSING\n                #ifdef MULTIVIEW\n                    varying float ds_viewIndexMultiview;\n                #endif\n                #endif\n                "}:{CUSTOM_FRAGMENT_DEFINITIONS:"\n                    #ifdef DEPTH_SENSING\n                        #ifdef DEPTH_SENSING_TEXTURE_ARRAY\n                            uniform highp sampler2DArray ds_depthSampler;\n                        #else\n                            uniform sampler2D ds_depthSampler;\n                        #endif\n                        #ifdef MULTIVIEW\n                            varying float ds_viewIndexMultiview;\n                        #endif\n                    #endif\n                  ",CUSTOM_FRAGMENT_MAIN_BEGIN:"\n#ifdef DEPTH_SENSING\n    #ifdef MULTIVIEW\n        float ds_viewIndexSet = ds_viewIndexMultiview;\n        vec2 ds_compensation = vec2(0.0, 0.0);\n    #else\n        float ds_viewIndexSet = ds_viewIndex;\n        vec2 ds_compensation = vec2(ds_viewIndexSet, 0.0);\n    #endif\n    vec2 ds_baseUv = gl_FragCoord.xy * ds_invScreenSize;\n    #ifdef DEPTH_SENSING_TEXTURE_ARRAY\n        vec2 ds_uv = ds_baseUv - ds_compensation;\n        vec3 ds_depthUv = vec3((ds_uvTransform * vec4(ds_uv, 0.0, 1.0)).xy, ds_viewIndexSet);\n    #else\n        vec2 ds_depthUv = (ds_uvTransform * vec4(ds_baseUv.x, 1.0 - ds_baseUv.y, 0.0, 1.0)).xy;\n    #endif\n    #ifdef DEPTH_SENSING_TEXTURE_AL\n        // from alpha-luminance - taken from the explainer\n        vec2 ds_alphaLuminance = texture(ds_depthSampler, ds_depthUv).ra;\n        float ds_cameraDepth = dot(ds_alphaLuminance, vec2(255.0, 256.0 * 255.0));\n    #else\n        float ds_cameraDepth = texture(ds_depthSampler, ds_depthUv).r;\n    #endif\n\n    ds_cameraDepth = ds_cameraDepth * ds_rawValueToMeters;\n\n    float ds_assetDepth = gl_FragCoord.z;\n    #ifdef DEPTH_SENSING_DISCARD\n    if(ds_cameraDepth < ds_assetDepth) {\n        discard;\n    }\n    #endif\n#endif  \n                  ",CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR:`\n#ifdef DEPTH_SENSING\n    #ifndef DEPTH_SENSING_DISCARD\n        const float ds_depthTolerancePerM = 0.005;\n        float ds_occlusion = clamp(1.0 - 0.5 * (ds_cameraDepth - ds_assetDepth) / (ds_depthTolerancePerM * ds_assetDepth) +\n            0.5, 0.0, 1.0);\n        ${this._varColorName} *= (1.0 - ds_occlusion);\n    #endif\n#endif                  \n                  `}}dispose(e){const t=IN.indexOf(this);-1!==t&&IN.splice(t,1),super.dispose(e)}}class MN extends md{get width(){return this._width}get height(){return this._height}get rawValueToMeters(){return this._rawValueToMeters}get normDepthBufferFromNormView(){return this._normDepthBufferFromNormView}get depthUsage(){switch(this._xrSessionManager.session.depthUsage){case"cpu-optimized":return"cpu";case"gpu-optimized":return"gpu"}}get depthDataFormat(){switch(this._xrSessionManager.session.depthDataFormat){case"luminance-alpha":case"unsigned-short":return"ushort";case"float32":return"float"}}get latestInternalTexture(){return this._cachedWebGLTexture?this._getInternalTextureFromDepthInfo():null}get latestDepthBuffer(){return this._cachedDepthBuffer?"float"===this.depthDataFormat?new Float32Array(this._cachedDepthBuffer):new Uint16Array(this._cachedDepthBuffer):null}get latestDepthImageTexture(){return this._cachedDepthImageTexture}constructor(e,t){super(e),this.options=t,this._width=null,this._height=null,this._rawValueToMeters=null,this._textureType=null,this._normDepthBufferFromNormView=null,this._cachedDepthBuffer=null,this._cachedWebGLTexture=null,this._cachedDepthImageTexture=null,this._onCameraObserver=null,this.onGetDepthInMetersAvailable=new s.cP,this.xrNativeFeatureName="depth-sensing",H.S0.Warn("depth-sensing is an experimental and unstable feature."),EN=!t.useToleranceFactorForDepthSensing}attach(e){if(!super.attach(e))return!1;return null!=this._xrSessionManager.session.depthDataFormat&&null!=this._xrSessionManager.session.depthUsage&&(this._glBinding=new XRWebGLBinding(this._xrSessionManager.session,this._xrSessionManager.scene.getEngine()._gl),vN=!this.options.disableDepthSensingOnMaterials,vN&&(IN.forEach((e=>{e.isEnabled=!0})),this._onCameraObserver=this._xrSessionManager.scene.onBeforeCameraRenderObservable.add((e=>{if(vN&&e.outputRenderTarget){const t=e.rigCameras.length>0?e.rigCameras[0].viewport:e.viewport;yN.width=e.outputRenderTarget.getRenderWidth()/(e.rigParent&&e.rigParent.rigCameras.length||1),yN.height=e.outputRenderTarget.getRenderHeight(),PN.x=t.x,PN.y=t.y,PN.width=t.width,PN.height=t.height,e.rigParent&&(CN=e.isLeftCamera?0:1)}}))),!0)}detach(){return vN=!1,SN=null,this._cachedWebGLTexture=null,this._cachedDepthBuffer=null,IN.forEach((e=>{e.isEnabled=!1})),this._onCameraObserver&&this._xrSessionManager.scene.onBeforeCameraRenderObservable.remove(this._onCameraObserver),super.detach()}dispose(){this._cachedDepthImageTexture?.dispose(),this.onGetDepthInMetersAvailable.clear(),this._onCameraObserver&&this._xrSessionManager.scene.onBeforeCameraRenderObservable.remove(this._onCameraObserver)}_onXRFrame(e){const t=this._xrSessionManager.referenceSpace,i=e.getViewerPose(t);if(null!=i)for(const t of i.views)switch(this.depthUsage){case"cpu":this._updateDepthInformationAndTextureCPUDepthUsage(e,t,this.depthDataFormat);break;case"gpu":if(!this._glBinding)break;this._updateDepthInformationAndTextureWebGLDepthUsage(this._glBinding,t,this.depthDataFormat);break;default:H.S0.Error("Unknown depth usage"),this.detach()}}_updateDepthInformationAndTextureCPUDepthUsage(e,t,i){const r=e.getDepthInformation(t);if(null===r)return;const{data:s,width:n,height:o,rawValueToMeters:a,getDepthInMeters:l,normDepthBufferFromNormView:h}=r;this._width=n,this._height=o,this._rawValueToMeters=a,this._cachedDepthBuffer=s,TN=a,bN="luminance-alpha"===i,AN.fromArray(h.matrix),this.onGetDepthInMetersAvailable.notifyObservers(l.bind(r)),this._cachedDepthImageTexture||(this._cachedDepthImageTexture=He.I.CreateRTexture(null,n,o,this._xrSessionManager.scene,!1,!1,$e.g.NEAREST_SAMPLINGMODE,1),SN=this._cachedDepthImageTexture);let c=null;switch(i){case"ushort":case"luminance-alpha":c=Float32Array.from(new Uint16Array(s));break;case"float":c=new Float32Array(s)}c&&(this.options.prepareTextureForVisualization&&(c=c.map((e=>e*a))),this._cachedDepthImageTexture.update(c))}_updateDepthInformationAndTextureWebGLDepthUsage(e,t,i){const r=e.getDepthInformation(t);if(null===r)return;const{texture:s,width:n,height:o,textureType:a,rawValueToMeters:l,normDepthBufferFromNormView:h}=r;if(TN=l,bN="luminance-alpha"===i,AN.fromArray(h.matrix),this._cachedWebGLTexture)return;this._width=n,this._height=o,this._cachedWebGLTexture=s,this._textureType=a;const c=this._xrSessionManager.scene,u=this._getInternalTextureFromDepthInfo();this._cachedDepthImageTexture||(this._cachedDepthImageTexture=He.I.CreateRTexture(null,n,o,c,!1,!0,$e.g.NEAREST_SAMPLINGMODE,"float"===i?1:0)),this._cachedDepthImageTexture._texture=u,SN=this._cachedDepthImageTexture,this._xrSessionManager.scene.markAllMaterialsAsDirty(1)}getXRSessionInitExtension(){const e=null!=this.options.usagePreference&&0!==this.options.usagePreference.length,t=null!=this.options.dataFormatPreference&&0!==this.options.dataFormatPreference.length;return new Promise((i=>{if(e&&t){i({depthSensing:{usagePreference:this.options.usagePreference.map((e=>{switch(e){case"cpu":return"cpu-optimized";case"gpu":return"gpu-optimized"}})),dataFormatPreference:this.options.dataFormatPreference.map((e=>{switch(e){case"luminance-alpha":return"luminance-alpha";case"float":return"float32";case"ushort":return"unsigned-short"}}))}})}else i({})}))}_getInternalTextureFromDepthInfo(){const e=this._xrSessionManager.scene.getEngine(),t=this.depthDataFormat,i=this._textureType;if(!this._width||!this._height||!this._cachedWebGLTexture)throw new Error("Depth information is not available");const r=e.wrapWebGLTexture(this._cachedWebGLTexture,!1,1,this._width||256,this._height||256);return r.isCube=!1,r.invertY=!1,r._useSRGBBuffer=!1,r.format="luminance-alpha"===t?2:5,r.generateMipMaps=!1,r.type="float"===t?1:"ushort"===t?5:0,r._cachedWrapU=1,r._cachedWrapV=1,r._hardwareTexture=new Er.d(this._cachedWebGLTexture,e._gl),r.is2DArray="texture-array"===i,r}}MN.Name=Tt.DEPTH_SENSING,MN.Version=1,Ct.AddWebXRFeature(MN.Name,((e,t)=>()=>new MN(e,t)),MN.Version,!1),(0,Sv.YC)("WebXRDepthSensingMaterialPlugin",(e=>new RN(e)));const DN="velocityPixelShader",ON="precision highp float;\n#define CUSTOM_FRAGMENT_BEGIN\nvarying vec4 clipPos;varying vec4 previousClipPos;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nhighp vec4 motionVector=( clipPos/clipPos.w-previousClipPos/previousClipPos.w );gl_FragColor=motionVector;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";qi.l.ShadersStore[DN]=ON;const NN="velocityVertexShader",wN="#define CUSTOM_VERTEX_BEGIN\n#define VELOCITY\nattribute vec3 position;\n#include<instancesDeclaration>\nuniform mat4 viewProjection;uniform mat4 previousViewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;uniform mat4 previousViewProjectionR;\n#endif\nvarying vec4 clipPos;varying vec4 previousClipPos;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#include<instancesVertex>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vec4 previousWorldPos=finalPreviousWorld*vec4(positionUpdated,1.0);\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {clipPos=viewProjection*worldPos;previousClipPos=previousViewProjection*previousWorldPos;gl_Position=clipPos;} else {clipPos=viewProjectionR*worldPos;previousClipPos=previousViewProjectionR*previousWorldPos;gl_Position=clipPos;}\n#elif\nclipPos=viewProjection*worldPos;previousClipPos=previousViewProjection*previousWorldPos;gl_Position=clipPos;\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}";qi.l.ShadersStore[NN]=wN;class FN extends cr.${constructor(e,t,i,r=512){super("spacewarp rtt",r,i,!1,!0,2,!1,void 0,!1,!1,!0,void 0,!0),this._originalPairing=[],this._previousWorldMatrices=[],this._previousTransforms=[n.uq.Identity(),n.uq.Identity()],this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight(),e,t),this._renderTarget._disposeOnlyFramebuffers=!0,this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,i&&(this._velocityMaterial=new rs("velocity shader material",i,{vertex:"velocity",fragment:"velocity"},{uniforms:["world","previousWorld","viewProjection","viewProjectionR","previousViewProjection","previousViewProjectionR"]}),this._velocityMaterial._materialHelperNeedsPreviousMatrices=!0,this._velocityMaterial.onBindObservable.add((e=>{this._previousWorldMatrices[e.uniqueId]=this._previousWorldMatrices[e.uniqueId]||e.getWorldMatrix(),this._velocityMaterial.getEffect().setMatrix("previousWorld",this._previousWorldMatrices[e.uniqueId]),this._previousWorldMatrices[e.uniqueId]=e.getWorldMatrix(),this._velocityMaterial.getEffect().setMatrix("previousViewProjection",this._previousTransforms[0]),this._velocityMaterial.getEffect().setMatrix("previousViewProjectionR",this._previousTransforms[1]),this._previousTransforms[0].copyFrom(i.getTransformMatrix()),this._previousTransforms[1].copyFrom(i._transformMatrixR)})),this._velocityMaterial.freeze())}render(e=!1,t=!1){this._originalPairing.length=0;const i=this.getScene();i&&this._velocityMaterial&&i.getActiveMeshes().forEach((e=>{this._originalPairing.push([e,e.material]),e.material=this._velocityMaterial})),super.render(e,t),this._originalPairing.forEach((e=>{e[0].material=e[1]}))}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindSpaceWarpFramebuffer(this._renderTarget)}getViewCount(){return 2}dispose(){super.dispose(),this._velocityMaterial.dispose(),this._previousTransforms.length=0,this._previousWorldMatrices.length=0,this._originalPairing.length=0}}class BN{constructor(e,t,i){this._scene=e,this._xrSessionManager=t,this._xrWebGLBinding=i,this._lastSubImages=new Map,this._renderTargetTextures=new Map,this._engine=e.getEngine()}_getSubImageForView(e){const t=this._xrSessionManager._getBaseLayerWrapper();if(!t)throw new Error("For Space Warp, the base layer should be a WebXR Projection Layer.");if("XRProjectionLayer"!==t.layerType)throw new Error('For Space Warp, the base layer type should "XRProjectionLayer".');const i=t.layer;return this._xrWebGLBinding.getViewSubImage(i,e)}_setViewportForSubImage(e,t){e.x=0,e.y=0,e.width=t.motionVectorTextureWidth,e.height=t.motionVectorTextureHeight}_createRenderTargetTexture(e,t,i,r,s){if(!this._engine)throw new Error("Engine is disposed");const n={width:e,height:t},o=new FN(r,s,this._scene,n),a=o.renderTarget;return i&&(a._framebuffer=i),a._colorTextureArray=r,a._depthStencilTextureArray=s,o.disableRescaling(),o.renderListPredicate=()=>!0,o}_getRenderTargetForSubImage(e,t){const i=this._lastSubImages.get(t);let r=this._renderTargetTextures.get(t.eye);const s=e.motionVectorTextureWidth,n=e.motionVectorTextureHeight;return r&&i?.textureWidth===s&&i?.textureHeight==n||(r=this._createRenderTargetTexture(s,n,null,e.motionVectorTexture,e.depthStencilTexture),this._renderTargetTextures.set(t.eye,r),this._framebufferDimensions={framebufferWidth:s,framebufferHeight:n}),this._lastSubImages.set(t,e),r}trySetViewportForView(e,t){const i=this._lastSubImages.get(t)||this._getSubImageForView(t);return!!i&&(this._setViewportForSubImage(e,i),!0)}accessMotionVector(e){const t=this._getSubImageForView(e);t&&(t.motionVectorTexture,t.depthStencilTexture)}getRenderTargetTextureForEye(e){return null}getRenderTargetTextureForView(e){const t=this._getSubImageForView(e);return t?this._getRenderTargetForSubImage(t,e):null}dispose(){this._renderTargetTextures.forEach((e=>e.dispose())),this._renderTargetTextures.clear()}}class VN extends md{constructor(e){super(e),this._onAfterRenderObserver=null,this.dependsOn=[Tt.LAYERS],this.xrNativeFeatureName="space-warp",this._xrSessionManager.scene.needsPreviousWorldMatrices=!0}attach(){if(!super.attach())return!1;const e=this._xrSessionManager.scene.getEngine();return this._glContext=e._gl,this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),this.spaceWarpRTTProvider=new BN(this._xrSessionManager.scene,this._xrSessionManager,this._xrWebGLBinding),this._onAfterRenderObserver=this._xrSessionManager.scene.onAfterRenderObservable.add((()=>this._onAfterRender())),!0}detach(){return this._xrSessionManager.scene.onAfterRenderObservable.remove(this._onAfterRenderObserver),super.detach()}_onAfterRender(){this.attached&&this._renderTargetTexture&&this._renderTargetTexture.render(!1,!1)}isCompatible(){return this._xrSessionManager.scene.getEngine().getCaps().colorBufferHalfFloat||!1}dispose(){super.dispose()}_onXRFrame(e){const t=e.getViewerPose(this._xrSessionManager.referenceSpace);if(!t)return;const i=t.views[0];this._renderTargetTexture=this._renderTargetTexture||this.spaceWarpRTTProvider.getRenderTargetTextureForView(i),this.spaceWarpRTTProvider.accessMotionVector(i)}}VN.Name=Tt.SPACE_WARP,VN.Version=1,Ct.AddWebXRFeature(VN.Name,(e=>()=>new VN(e)),VN.Version,!1);class LN extends md{constructor(e,t={}){super(e),this.options=t,this._cachedInternalTextures=[],this.texturesData=[],this.viewIndex=[],this.cameraIntrinsics=[],this.onTexturesUpdatedObservable=new s.cP,this.xrNativeFeatureName="camera-access"}attach(e){return!!super.attach(e)&&(this._glContext=this._xrSessionManager.scene.getEngine()._gl,this._glBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),!0)}detach(){return!!super.detach()&&(this._glBinding=void 0,this.options.doNotDisposeOnDetach||(this._cachedInternalTextures.forEach((e=>e.dispose())),this.texturesData.forEach((e=>e.dispose())),this._cachedInternalTextures.length=0,this.texturesData.length=0,this.cameraIntrinsics.length=0),!0)}dispose(){super.dispose(),this.onTexturesUpdatedObservable.clear()}_updateCameraIntrinsics(e,t){const i={width:e.camera.width,height:e.camera.height,x:0,y:0},r=e.projectionMatrix,s=(1-r[8])*i.width/2+i.x,n=(1-r[9])*i.height/2+i.y,o=i.width/2*r[0],a=i.height/2*r[5],l=i.width/2*r[4];this.cameraIntrinsics[t]={u0:s,v0:n,ax:o,ay:a,gamma:l,width:i.width,height:i.height,viewportX:i.x,viewportY:i.y}}_updateInternalTextures(e,t=0){if(!e.camera)return!1;this.viewIndex[t]=e.eye;const i=this._glBinding?.getCameraImage(e.camera);if(this._cachedInternalTextures[t])this._cachedInternalTextures[t]._hardwareTexture?.set(i);else{const r=new lr.h(this._xrSessionManager.scene.getEngine(),0,!0);r.invertY=!1,r.format=5,r.generateMipMaps=!0,r.type=0,r.samplingMode=3,r.width=e.camera.width,r.height=e.camera.height,r._cachedWrapU=1,r._cachedWrapV=1,r._hardwareTexture=new Er.d(i,this._glContext),this._cachedInternalTextures[t]=r;const s=new zu.t(this._xrSessionManager.scene);s.name=`WebXR Raw Camera Access (${t})`,s._texture=this._cachedInternalTextures[t],this.texturesData[t]=s,this._updateCameraIntrinsics(e,t)}return this._cachedInternalTextures[t].isReady=!0,!0}_onXRFrame(e){const t=this._xrSessionManager.referenceSpace,i=e.getViewerPose(t);if(!i||!i.views)return;let r=!0;i.views.forEach(((e,t)=>{r=r&&this._updateInternalTextures(e,t)})),r&&this.onTexturesUpdatedObservable.notifyObservers(this.texturesData)}}LN.Name=Tt.RAW_CAMERA_ACCESS,LN.Version=1,Ct.AddWebXRFeature(LN.Name,((e,t)=>()=>new LN(e,t)),LN.Version,!1);class kN extends nd{constructor(e,t,i){super(e,GN[i],t,i,!0),this.profileId="generic-hand-select-grasp"}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){}_updateModel(){}}cd.RegisterController("generic-hand-select-grasp",((e,t)=>new kN(t,e.gamepad,e.handedness)));const GN={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-none",assetPath:"none.glb"}};class zN extends nd{constructor(e,t,i){super(e,UN["left-right"],t,i),this._mapping={defaultButton:{valueNodeName:"VALUE",unpressedNodeName:"UNPRESSED",pressedNodeName:"PRESSED"},defaultAxis:{valueNodeName:"VALUE",minNodeName:"MIN",maxNodeName:"MAX"},buttons:{"xr-standard-trigger":{rootNodeName:"SELECT",componentProperty:"button",states:["default","touched","pressed"]},"xr-standard-squeeze":{rootNodeName:"GRASP",componentProperty:"state",states:["pressed"]},"xr-standard-touchpad":{rootNodeName:"TOUCHPAD_PRESS",labelAnchorNodeName:"squeeze-label",touchPointNodeName:"TOUCH"},"xr-standard-thumbstick":{rootNodeName:"THUMBSTICK_PRESS",componentProperty:"state",states:["pressed"]}},axes:{"xr-standard-touchpad":{"x-axis":{rootNodeName:"TOUCHPAD_TOUCH_X"},"y-axis":{rootNodeName:"TOUCHPAD_TOUCH_Y"}},"xr-standard-thumbstick":{"x-axis":{rootNodeName:"THUMBSTICK_X"},"y-axis":{rootNodeName:"THUMBSTICK_Y"}}}},this.profileId="microsoft-mixed-reality"}_getFilenameAndPath(){let e="";e="left"===this.handedness?zN.MODEL_LEFT_FILENAME:zN.MODEL_RIGHT_FILENAME;return{filename:e,path:zN.MODEL_BASE_URL+"default/"}}_getModelLoadingConstraints(){const e=sd.cn.IsPluginForExtensionAvailable(".glb");return e||m.V.Warn("glTF / glb loaded was not registered, using generic controller instead"),e}_processLoadedModel(e){this.rootMesh&&(this.getComponentIds().forEach(((e,t)=>{if(!this.disableAnimation&&e&&this.rootMesh){const i=this._mapping.buttons[e],r=i.rootNodeName;if(!r)return void m.V.Log("Skipping unknown button at index: "+t+" with mapped name: "+e);const s=this._getChildByName(this.rootMesh,r);if(!s)return void m.V.Warn("Missing button mesh with name: "+r);if(i.valueMesh=this._getImmediateChildByName(s,this._mapping.defaultButton.valueNodeName),i.pressedMesh=this._getImmediateChildByName(s,this._mapping.defaultButton.pressedNodeName),i.unpressedMesh=this._getImmediateChildByName(s,this._mapping.defaultButton.unpressedNodeName),i.valueMesh&&i.pressedMesh&&i.unpressedMesh){const t=this.getComponent(e);t&&t.onButtonStateChangedObservable.add((e=>{this._lerpTransform(i,e.value)}),void 0,!0)}else m.V.Warn("Missing button submesh under mesh with name: "+r)}})),this.getComponentIds().forEach((e=>{const t=this.getComponent(e);t.isAxes()&&["x-axis","y-axis"].forEach((i=>{if(!this.rootMesh)return;const r=this._mapping.axes[e][i],s=this._getChildByName(this.rootMesh,r.rootNodeName);s?(r.valueMesh=this._getImmediateChildByName(s,this._mapping.defaultAxis.valueNodeName),r.minMesh=this._getImmediateChildByName(s,this._mapping.defaultAxis.minNodeName),r.maxMesh=this._getImmediateChildByName(s,this._mapping.defaultAxis.maxNodeName),r.valueMesh&&r.minMesh&&r.maxMesh?t&&t.onAxisValueChangedObservable.add((e=>{const t="x-axis"===i?e.x:e.y;this._lerpTransform(r,t,!0)}),void 0,!0):m.V.Warn("Missing axis submesh under mesh with name: "+r.rootNodeName)):m.V.Warn("Missing axis mesh with name: "+r.rootNodeName)}))})))}_setRootMesh(e){let t;this.rootMesh=new tt.e(this.profileId+" "+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(let i=0;i<e.length;i++){const r=e[i];r.isPickable=!1,r.parent||(t=r)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=n.PT.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}zN.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/",zN.MODEL_LEFT_FILENAME="left.glb",zN.MODEL_RIGHT_FILENAME="right.glb",cd.RegisterController("windows-mixed-reality",((e,t)=>new zN(t,e.gamepad,e.handedness)));const UN={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-right",assetPath:"right.glb"}};class WN extends nd{constructor(e,t,i,r=!1,s=!1){super(e,HN[i],t,i),this._forceLegacyControllers=s,this.profileId="oculus-touch"}_getFilenameAndPath(){let e="";e="left"===this.handedness?WN.MODEL_LEFT_FILENAME:WN.MODEL_RIGHT_FILENAME;return{filename:e,path:this._isQuest()?WN.QUEST_MODEL_BASE_URL:WN.MODEL_BASE_URL}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){const t=this._isQuest(),i="right"===this.handedness?-1:1;this.getComponentIds().forEach((e=>{const r=e&&this.getComponent(e);r&&r.onButtonStateChangedObservable.add((r=>{if(this.rootMesh&&!this.disableAnimation)switch(e){case"xr-standard-trigger":return void(t||(this._modelRootNode.getChildren()[3].rotation.x=.2*-r.value,this._modelRootNode.getChildren()[3].position.y=.005*-r.value,this._modelRootNode.getChildren()[3].position.z=.005*-r.value));case"xr-standard-squeeze":return void(t||(this._modelRootNode.getChildren()[4].position.x=i*r.value*.0035));case"xr-standard-thumbstick":return;case"a-button":case"x-button":return void(t||(r.pressed?this._modelRootNode.getChildren()[1].position.y=-.001:this._modelRootNode.getChildren()[1].position.y=0));case"b-button":case"y-button":return void(t||(r.pressed?this._modelRootNode.getChildren()[2].position.y=-.001:this._modelRootNode.getChildren()[2].position.y=0))}}),void 0,!0)}))}_setRootMesh(e){this.rootMesh=new tt.e(this.profileId+" "+this.handedness,this.scene),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=n.PT.FromEulerAngles(0,Math.PI,0)),e.forEach((e=>{e.isPickable=!1})),this._isQuest()?this._modelRootNode=e[0]:(this._modelRootNode=e[1],this.rootMesh.position.y=.034,this.rootMesh.position.z=.052),this._modelRootNode.parent=this.rootMesh}_updateModel(){}_isQuest(){return!!navigator.userAgent.match(/Quest/gi)&&!this._forceLegacyControllers}}WN.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/",WN.MODEL_LEFT_FILENAME="left.babylon",WN.MODEL_RIGHT_FILENAME="right.babylon",WN.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/",cd.RegisterController("oculus-touch",((e,t)=>new WN(t,e.gamepad,e.handedness))),cd.RegisterController("oculus-touch-legacy",((e,t)=>new WN(t,e.gamepad,e.handedness,!0)));const HN={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"x-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"x_button",visualResponses:{}},"y-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"y_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"a-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"a_button",visualResponses:{}},"b-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"b_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-right",assetPath:"right.glb"}};class $N extends nd{constructor(e,t,i){super(e,qN[i],t,i),this.profileId="htc-vive"}_getFilenameAndPath(){return{filename:$N.MODEL_FILENAME,path:$N.MODEL_BASE_URL}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){this.getComponentIds().forEach((e=>{const t=e&&this.getComponent(e);t&&t.onButtonStateChangedObservable.add((t=>{if(this.rootMesh&&!this.disableAnimation)switch(e){case"xr-standard-trigger":return void(this._modelRootNode.getChildren()[6].rotation.x=.15*-t.value);case"xr-standard-touchpad":case"xr-standard-squeeze":return}}),void 0,!0)}))}_setRootMesh(e){this.rootMesh=new tt.e(this.profileId+" "+this.handedness,this.scene),e.forEach((e=>{e.isPickable=!1})),this._modelRootNode=e[1],this._modelRootNode.parent=this.rootMesh,this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=n.PT.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}$N.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/",$N.MODEL_FILENAME="wand.babylon",cd.RegisterController("htc-vive",((e,t)=>new $N(t,e.gamepad,e.handedness)));const qN={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc-vive-none",assetPath:"none.glb"}};class YN{get session(){return this._nativeImpl.session}constructor(e){this._nativeImpl=e,this._xrTransform=new XRRigidTransform,this._xrPose={transform:this._xrTransform,emulatedPosition:!1},this._xrPoseVectorData=new Float32Array(8),this.fillPoses=this._nativeImpl.fillPoses.bind(this._nativeImpl),this.getViewerPose=this._nativeImpl.getViewerPose.bind(this._nativeImpl),this.getHitTestResults=this._nativeImpl.getHitTestResults.bind(this._nativeImpl),this.getHitTestResultsForTransientInput=()=>{throw new Error("XRFrame.getHitTestResultsForTransientInput not supported on native.")},this.createAnchor=this._nativeImpl.createAnchor.bind(this._nativeImpl),this.getJointPose=this._nativeImpl.getJointPose.bind(this._nativeImpl),this.fillJointRadii=this._nativeImpl.fillJointRadii.bind(this._nativeImpl),this.getLightEstimate=()=>{throw new Error("XRFrame.getLightEstimate not supported on native.")},this.getImageTrackingResults=()=>this._nativeImpl._imageTrackingResults??[]}getPose(e,t){if(!this._nativeImpl.getPoseData(e,t,this._xrPoseVectorData.buffer,this._xrTransform.matrix.buffer))return;const i=this._xrTransform.position;i.x=this._xrPoseVectorData[0],i.y=this._xrPoseVectorData[1],i.z=this._xrPoseVectorData[2],i.w=this._xrPoseVectorData[3];const r=this._xrTransform.orientation;return r.x=this._xrPoseVectorData[4],r.y=this._xrPoseVectorData[5],r.z=this._xrPoseVectorData[6],r.w=this._xrPoseVectorData[7],this._xrPose}get trackedAnchors(){return this._nativeImpl.trackedAnchors}get worldInformation(){return this._nativeImpl.worldInformation}get detectedPlanes(){return this._nativeImpl.detectedPlanes}get featurePointCloud(){return this._nativeImpl.featurePointCloud}getDepthInformation(e){throw new Error("This function is not available in Babylon Native")}}na("NativeXRFrame",YN)},6739:(e,t,i)=>{i.r(t),i.d(t,{geometryVertexShader:()=>c});var r=i(69610);i(69707),i(18959),i(27999),i(90738),i(1218);const s="geometryVertexDeclaration",n="uniform mat4 viewProjection;uniform mat4 view;";r.l.IncludesShadersStore[s]=n;i(28764);const o="geometryUboDeclaration",a="#include<sceneUboDeclaration>\n";r.l.IncludesShadersStore[o]=a;i(71636),i(48451),i(15060),i(3298),i(3361),i(65523),i(47314),i(19440);const l="geometryVertexShader",h="precision highp float;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\n#include<__decl__geometryVertex>\n#include<clipPlaneVertexDeclaration>\nattribute vec3 position;attribute vec3 normal;\n#ifdef NEED_UV\nvarying vec2 vUV;\n#ifdef ALPHATEST\nuniform mat4 diffuseMatrix;\n#endif\n#ifdef BUMP\nuniform mat4 bumpMatrix;varying vec2 vBumpUV;\n#endif\n#ifdef REFLECTIVITY\nuniform mat4 reflectivityMatrix;uniform mat4 albedoMatrix;varying vec2 vReflectivityUV;varying vec2 vAlbedoUV;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#ifdef BUMP\nvarying mat4 vWorldView;\n#endif\n#ifdef BUMP\nvarying vec3 vNormalW;\n#else\nvarying vec3 vNormalV;\n#endif\nvarying vec4 vViewPos;\n#if defined(POSITION) || defined(BUMP)\nvarying vec3 vPositionW;\n#endif\n#if defined(VELOCITY) || defined(VELOCITY_LINEAR)\nuniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;vec3 normalUpdated=normal;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef UV2\nvec2 uv2Updated=uv2;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=vec4(finalWorld*vec4(positionUpdated,1.0));\n#ifdef BUMP\nvWorldView=view*finalWorld;mat3 normalWorld=mat3(finalWorld);vNormalW=normalize(normalWorld*normalUpdated);\n#else\n#ifdef NORMAL_WORLDSPACE\nvNormalV=normalize(vec3(finalWorld*vec4(normalUpdated,0.0)));\n#else\nvNormalV=normalize(vec3((view*finalWorld)*vec4(normalUpdated,0.0)));\n#endif\n#endif\nvViewPos=view*worldPos;\n#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#if NUM_BONE_INFLUENCERS>0\nmat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);\n#else\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#endif\n#if defined(POSITION) || defined(BUMP)\nvPositionW=worldPos.xyz/worldPos.w;\n#endif\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#include<clipPlaneVertex>\n#ifdef NEED_UV\n#ifdef UV1\n#if defined(ALPHATEST) && defined(ALPHATEST_UV1)\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#else\nvUV=uvUpdated;\n#endif\n#ifdef BUMP_UV1\nvBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef REFLECTIVITY_UV1\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef ALBEDO_UV1\nvAlbedoUV=vec2(albedoMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#endif\n#ifdef UV2\n#if defined(ALPHATEST) && defined(ALPHATEST_UV2)\nvUV=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));\n#else\nvUV=uv2Updated;\n#endif\n#ifdef BUMP_UV2\nvBumpUV=vec2(bumpMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#ifdef REFLECTIVITY_UV2\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#ifdef ALBEDO_UV2\nvAlbedoUV=vec2(albedoMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#endif\n#endif\n#include<bumpVertex>\n}\n";r.l.ShadersStore[l]=h;const c={name:l,shader:h}},7101:(e,t,i)=>{i.r(t),i.d(t,{glowMapMergeVertexShaderWGSL:()=>n});const r="glowMapMergeVertexShader",s="attribute position: vec2f;varying vUV: vec2f;\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {const madd: vec2f= vec2f(0.5,0.5);\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.vUV=input.position*madd+madd;vertexOutputs.position= vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},7169:(e,t,i)=>{i.r(t),i.d(t,{_TGATextureLoader:()=>s});var r=i(52053);class s{constructor(){this.supportCascades=!1}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),n=(0,r.O_)(s);i(n.width,n.height,t.generateMipMaps,!1,(()=>{(0,r.FA)(t,s)}))}}},8075:(e,t,i)=>{i.r(t),i.d(t,{motionBlurPixelShaderWGSL:()=>n});const r="motionBlurPixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform motionStrength: f32;uniform motionScale: f32;uniform screenSize: vec2f;\n#ifdef OBJECT_BASED\nvar velocitySamplerSampler: sampler;var velocitySampler: texture_2d<f32>;\n#else\nvar depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;uniform inverseViewProjection: mat4x4f;uniform prevViewProjection: mat4x4f;uniform projection: mat4x4f;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#ifdef GEOMETRY_SUPPORTED\n#ifdef OBJECT_BASED\nvar texelSize: vec2f=1.0/uniforms.screenSize;var velocityColor: vec4f=textureSample(velocitySampler,velocitySamplerSampler,input.vUV);velocityColor=vec4f(velocityColor.rg*2.0- vec2f(1.0),velocityColor.b,velocityColor.a);var velocity: vec2f= vec2f(pow(velocityColor.r,3.0),pow(velocityColor.g,3.0))*velocityColor.a;velocity*=uniforms.motionScale*uniforms.motionStrength;var speed: f32=length(velocity/texelSize);var samplesCount: i32= i32(clamp(speed,1.0,SAMPLES));velocity=normalize(velocity)*texelSize;var hlim: f32= f32(-samplesCount)*0.5+0.5;var result: vec4f=textureSample(textureSampler,textureSamplerSampler, input.vUV);for (var i: i32=1; i< i32(SAMPLES); i++)\n{if (i>=samplesCount) {break;}\nvar offset: vec2f=input.vUV+velocity*(hlim+ f32(i));\n#if defined(WEBGPU)\nresult+=textureSampleLevel(textureSampler,textureSamplerSampler, offset,0.0);\n#else\nresult+=textureSample(textureSampler,textureSamplerSampler, offset);\n#endif\n}\nfragmentOutputs.color=vec4f(result.rgb/ f32(samplesCount),1.0);\n#else\nvar texelSize: vec2f=1.0/uniforms.screenSize;var depth: f32=textureSample(depthSampler,depthSamplerSampler,input.vUV).r;depth=uniforms.projection[2].z+uniforms.projection[3].z/depth; \nvar cpos: vec4f= vec4f(input.vUV*2.0-1.0,depth,1.0);cpos=uniforms.inverseViewProjection*cpos;cpos/=cpos.w;var ppos: vec4f=uniforms.prevViewProjection*cpos;ppos/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;var velocity: vec2f=(ppos.xy-input.vUV)*uniforms.motionScale*uniforms.motionStrength;var speed: f32=length(velocity/texelSize);var nSamples: i32= i32(clamp(speed,1.0,SAMPLES));var result: vec4f=textureSample(textureSampler,textureSamplerSampler, input.vUV);for (var i: i32=1; i< i32(SAMPLES); i++) {if (i>=nSamples) {break;}\nvar offset1: vec2f=input.vUV+velocity*( f32(i)/ f32(nSamples-1)-0.5);\n#if defined(WEBGPU)\nresult+=textureSampleLevel(textureSampler,textureSamplerSampler, offset1,0.0);\n#else\nresult+=textureSample(textureSampler,textureSamplerSampler, offset1);\n#endif\n}\nfragmentOutputs.color=result/ f32(nSamples);\n#endif\n#else\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler, input.vUV);\n#endif\n}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},8334:(e,t,i)=>{i.r(t),i.d(t,{packingFunctions:()=>n});const r="packingFunctions",s="vec4 pack(float depth)\n{const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\nfloat unpack(vec4 color)\n{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}";i(69610).l.IncludesShadersStore[r]=s;const n={name:r,shader:s}},8444:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelGridVertexShader:()=>n});const r="iblVoxelGridVertexShader",s="attribute vec3 position;attribute vec3 normal;varying vec3 vNormalizedPosition;uniform mat4 world;uniform mat4 invWorldScale;uniform mat4 viewMatrix;void main(void) {gl_Position=viewMatrix*invWorldScale*world*vec4(position,1.);vNormalizedPosition.xyz=gl_Position.xyz*0.5+0.5;\n#ifdef IS_NDC_HALF_ZRANGE\ngl_Position.z=gl_Position.z*0.5+0.5;\n#endif\n}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},8605:(e,t,i)=>{i.r(t),i.d(t,{iblShadowSpatialBlurPixelShader:()=>n});const r="iblShadowSpatialBlurPixelShader",s="precision highp sampler2D;\n#define PI 3.1415927\nvarying vec2 vUV;uniform sampler2D depthSampler;uniform sampler2D worldNormalSampler;uniform sampler2D voxelTracingSampler;uniform vec4 blurParameters;\n#define stridef blurParameters.x\n#define worldScale blurParameters.y\nconst float weights[5]=float[5](0.0625,0.25,0.375,0.25,0.0625);const int nbWeights=5;vec2 max2(vec2 v,vec2 w) {return vec2(max(v.x,w.x),max(v.y,w.y));}\nvoid main(void)\n{vec2 gbufferRes=vec2(textureSize(depthSampler,0));ivec2 gbufferPixelCoord=ivec2(vUV*gbufferRes);vec2 shadowRes=vec2(textureSize(voxelTracingSampler,0));ivec2 shadowPixelCoord=ivec2(vUV*shadowRes);vec3 N=texelFetch(worldNormalSampler,gbufferPixelCoord,0).xyz;if (length(N)<0.01) {glFragColor=vec4(1.0,1.0,0.0,1.0);return;}\nfloat depth=-texelFetch(depthSampler,gbufferPixelCoord,0).x;vec4 X=vec4(0.0);for(int y=0; y<nbWeights; ++y) {for(int x=0; x<nbWeights; ++x) {ivec2 gBufferCoords=gbufferPixelCoord+int(stridef)*ivec2(x-(nbWeights>>1),y-(nbWeights>>1));ivec2 shadowCoords=shadowPixelCoord+int(stridef)*ivec2(x-(nbWeights>>1),y-(nbWeights>>1));vec4 T=texelFetch(voxelTracingSampler,shadowCoords,0);float ddepth=-texelFetch(depthSampler,gBufferCoords,0).x-depth;vec3 dN=texelFetch(worldNormalSampler,gBufferCoords,0).xyz-N;float w=weights[x]*weights[y] *\nexp2(max(-1000.0/(worldScale*worldScale),-0.5) *\n(ddepth*ddepth) -\n1e1*dot(dN,dN));X+=vec4(w*T.x,w*T.y,w*T.z,w);}}\ngl_FragColor=vec4(X.x/X.w,X.y/X.w,X.z/X.w,1.0);}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},8993:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphSetDelayBlock:()=>l});var r=i(51e3),s=i(4720),n=i(20472),o=i(51137),a=i(56552);class l extends r.M{constructor(e){super(e),this.cancel=this._registerSignalInput("cancel"),this.duration=this.registerDataInput("duration",s.Es),this.lastDelayIndex=this.registerDataOutput("lastDelayIndex",s.Es,-1)}_preparePendingTasks(e){const t=this.duration.getValue(e);if(t<0||isNaN(t)||!isFinite(t))return this._reportError(e,"Invalid duration in SetDelay block");if(e._getGlobalContextVariable("activeDelays",0)>=l.MaxParallelDelayCount)return this._reportError(e,"Max parallel delays reached");const i=e._getGlobalContextVariable("lastDelayIndex",-1),r=e._getExecutionVariable(this,"pendingDelays",[]),s=e.configuration.scene,o=new n.Qz({timeout:1e3*t,contextObservable:s.onBeforeRenderObservable,onEnded:()=>this._onEnded(o,e)});o.start();const a=i+1;this.lastDelayIndex.setValue(a,e),e._setGlobalContextVariable("lastDelayIndex",a),r[a]=o,e._setExecutionVariable(this,"pendingDelays",r)}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"pendingDelays",[]);for(const e of t)e?.dispose();e._deleteExecutionVariable(this,"pendingDelays"),this.lastDelayIndex.setValue(-1,e)}_execute(e,t){t!==this.cancel?(this._preparePendingTasks(e),this.out._activateSignal(e)):this._cancelPendingTasks(e)}getClassName(){return"FlowGraphSetDelayBlock"}_onEnded(e,t){const i=t._getExecutionVariable(this,"pendingDelays",[]),r=i.indexOf(e);-1!==r?i.splice(r,1):o.V.Warn("FlowGraphTimerBlock: Timer ended but was not found in the running timers list"),t._removePendingBlock(this),this.done._activateSignal(t)}}l.MaxParallelDelayCount=100,(0,a.Y5)("FlowGraphSetDelayBlock",l)},9461:(e,t,i)=>{i.r(t),i.d(t,{iblShadowVoxelTracingPixelShaderWGSL:()=>n});const r="iblShadowVoxelTracingPixelShader",s="#define PI 3.1415927\nvarying vUV: vec2f;\n#define DISABLE_UNIFORMITY_ANALYSIS\nvar depthSampler: texture_2d<f32>;var worldNormalSampler : texture_2d<f32>;var blueNoiseSampler: texture_2d<f32>;var icdfSamplerSampler: sampler;var icdfSampler: texture_2d<f32>;var voxelGridSamplerSampler: sampler;var voxelGridSampler: texture_3d<f32>;\n#ifdef COLOR_SHADOWS\nvar iblSamplerSampler: sampler;var iblSampler: texture_cube<f32>;\n#endif\nuniform shadowParameters: vec4f;\n#define SHADOWdirs uniforms.shadowParameters.x\n#define SHADOWframe uniforms.shadowParameters.y\n#define SHADOWenvRot uniforms.shadowParameters.w\nuniform voxelBiasParameters : vec4f;\n#define highestMipLevel uniforms.voxelBiasParameters.z\nuniform sssParameters: vec4f;\n#define SSSsamples uniforms.sssParameters.x\n#define SSSstride uniforms.sssParameters.y\n#define SSSmaxDistance uniforms.sssParameters.z\n#define SSSthickness uniforms.sssParameters.w\nuniform shadowOpacity: vec4f;uniform projMtx: mat4x4f;uniform viewMtx: mat4x4f;uniform invProjMtx: mat4x4f;uniform invViewMtx: mat4x4f;uniform wsNormalizationMtx: mat4x4f;uniform invVPMtx: mat4x4f;\n#define PI 3.1415927\n#define GOLD 0.618034\nstruct AABB3f {m_min: vec3f,\nm_max: vec3f,};struct Ray {orig: vec3f,\ndir: vec3f,\ndir_rcp: vec3f,\nt_min: f32,\nt_max: f32,};fn make_ray(origin: vec3f,direction: vec3f,tmin: f32,\ntmax: f32)->Ray {var ray: Ray;ray.orig=origin;ray.dir=direction;ray.dir_rcp=1.0f/direction;ray.t_min=tmin;ray.t_max=tmax;return ray;}\nfn ray_box_intersection(aabb: AABB3f,ray: Ray ,\ndistance_near: ptr<function,f32>,distance_far: ptr<function,f32>)->bool{var tbot: vec3f=ray.dir_rcp*(aabb.m_min-ray.orig);var ttop: vec3f=ray.dir_rcp*(aabb.m_max-ray.orig);var tmin: vec3f=min(ttop,tbot);var tmax: vec3f=max(ttop,tbot);*distance_near=max(ray.t_min,max(tmin.x,max(tmin.y,tmin.z)));*distance_far=min(ray.t_max,min(tmax.x,min(tmax.y,tmax.z)));return *distance_near<=*distance_far;}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nstruct VoxelMarchDiagnosticInfo {heat: f32,\nvoxel_intersect_coords: vec3i,};\n#endif\nfn hash(i: u32)->u32 {var temp=i ^ (i>>16u);temp*=0x7FEB352Du;temp ^= temp>>15u;temp*=0x846CA68Bu;temp ^= temp>>16u;return temp;}\nfn uintBitsToFloat(x: u32)->f32 {return bitcast<f32>(x);}\nfn uint2float(i: u32)->f32 {return uintBitsToFloat(0x3F800000u | (i>>9u))-1.0;}\nfn uv_to_normal(uv: vec2f)->vec3f {var N: vec3f;var uvRange: vec2f=uv;var theta: f32=uvRange.x*2.0*PI;var phi: f32=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}\nfn plasticSequence(rstate: u32)->vec2f {return vec2f(uint2float(rstate*3242174889u),\nuint2float(rstate*2447445414u));}\nfn goldenSequence(rstate: u32)->f32 {return uint2float(rstate*2654435769u);}\nfn distanceSquared(a: vec2f,b: vec2f)->f32 {var diff: vec2f=a-b;return dot(diff,diff);}\nfn genTB(N: vec3f,T: ptr<function,vec3f>,B: ptr<function,vec3f>) {var s: f32=select(1.0,-1.0,N.z<0.0);var a: f32=-1.0/(s+N.z);var b: f32=N.x*N.y*a;*T= vec3f(1.0+s*N.x*N.x*a,s*b,-s*N.x);*B= vec3f(b,s+N.y*N.y*a,-N.y);}\nfn lessThan(x: vec3f,y: vec3f)->vec3<bool> {return x<y;}\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nfn anyHitVoxels(ray_vs: Ray,\nvoxel_march_diagnostic_info: ptr<function,VoxelMarchDiagnosticInfo>)->bool {\n#else\nfn anyHitVoxels(ray_vs: Ray)->bool {\n#endif\nvar stack=array<i32,24>(); \nvar invD: vec3f=ray_vs.dir_rcp;var D: vec3f=ray_vs.dir;var O: vec3f=ray_vs.orig;var negD=vec3i(lessThan(D, vec3f(0,0,0)));var voxel0: i32=negD.x | (negD.y<<1) | (negD.z<<2);var t0: vec3f=-O*invD;var t1=(vec3f(1.0)-O)*invD;var maxLod: i32= i32(highestMipLevel);var stackLevel: i32=0;\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nvar steps: u32=0u;\n#endif\nstack[stackLevel]=maxLod<<24;stackLevel++;while (stackLevel>0) {stackLevel=stackLevel-1;var elem: i32=stack[stackLevel];var Coords: vec4i =\nvec4i(elem & 0xFF,(elem>>8) & 0xFF,(elem>>16) & 0xFF,elem>>24);if (Coords.w==0) {\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\n*voxel_march_diagnostic_info.heat= f32(steps)/24.0;\n#endif\nreturn true;}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\n++steps;\n#endif\nvar invRes: f32=exp2(f32(Coords.w-maxLod));var bbmin: vec3f=invRes*vec3f(Coords.xyz+negD);var bbmax: vec3f=invRes*vec3f(Coords.xyz-negD+vec3i(1));var mint: vec3f=mix(t0,t1,bbmin);var maxt: vec3f=mix(t0,t1,bbmax);var midt: vec3f=0.5*(mint+maxt);mint.x=max(0.0,mint.x);midt.x=max(0.0,midt.x);var nodeMask: u32= u32(\nround(textureLoad(voxelGridSampler,Coords.xyz,Coords.w).x*255.0));Coords.w--;var voxelBit: u32=u32(voxel0);Coords=vec4i((Coords.xyz<<vec3u(1))+negD,Coords.w);var packedCoords: i32 =\nCoords.x | (Coords.y<<8) | (Coords.z<<16) | (Coords.w<<24);if (max(mint.x,max(mint.y,mint.z))<min(midt.x,min(midt.y,midt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(mint.y,mint.z))<min(maxt.x,min(midt.y,midt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(midt.y,mint.z))<min(maxt.x,min(maxt.y,midt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(midt.y,mint.z))<min(midt.x,min(maxt.y,midt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x4;packedCoords ^= 0x10000;if (max(mint.x,max(midt.y,midt.z))<min(midt.x,min(maxt.y,maxt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(midt.y,midt.z))<min(maxt.x,min(maxt.y,maxt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(mint.y,midt.z))<min(maxt.x,min(midt.y,maxt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(mint.y,midt.z))<min(midt.x,min(midt.y,maxt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\n*voxel_march_diagnostic_info.heat= f32(steps)/24.0;\n#endif\nreturn false;}\nfn linearizeDepth(depth: f32,near: f32,far: f32)->f32 {return (near*far)/(far-depth*(far-near));}\nfn screenSpaceShadow(csOrigin: vec3f,csDirection: vec3f,csZBufferSize: vec2f,\nnearPlaneZ: f32,farPlaneZ: f32,noise: f32)->f32 {\n#ifdef RIGHT_HANDED\nvar csZDir : f32=-1.0;\n#else \nvar csZDir : f32=1.0;\n#endif\nvar ssSamples: f32=SSSsamples;var ssMaxDist: f32=SSSmaxDistance;var ssStride: f32=SSSstride;var ssThickness: f32=SSSthickness;var rayLength: f32 =\nselect(ssMaxDist,(nearPlaneZ-csOrigin.z)/csDirection.z,\ncsZDir*(csOrigin.z+ssMaxDist*csDirection.z)<csZDir*nearPlaneZ);var csEndPoint: vec3f=csOrigin+rayLength*csDirection;var H0: vec4f=uniforms.projMtx*vec4f(csOrigin,1.0);var H1: vec4f=uniforms.projMtx*vec4f(csEndPoint,1.0);var Z0=vec2f(csOrigin.z ,1.0)/H0.w;var Z1=vec2f(csEndPoint.z,1.0)/H1.w;var P0=csZBufferSize*(0.5*H0.xy*Z0.y+0.5);var P1=csZBufferSize*(0.5*H1.xy*Z1.y+0.5);P1+= vec2f(select(0.0,0.01,distanceSquared(P0,P1)<0.0001));var delta: vec2f=P1-P0;var permute: bool=false;if (abs(delta.x)<abs(delta.y)) {permute=true;P0=P0.yx;P1=P1.yx;delta=delta.yx;}\nvar stepDirection: f32=sign(delta.x);var invdx: f32=stepDirection/delta.x;var dP: vec2f=ssStride* vec2f(stepDirection,invdx*delta.y);var dZ: vec2f=ssStride*invdx*(Z1-Z0);var opacity: f32=0.0;var P: vec2f=P0+noise*dP;var Z: vec2f=Z0+noise*dZ;var end: f32=P1.x*stepDirection;var rayZMax=csZDir*Z.x/Z.y;var sceneDepth=rayZMax;Z+=dZ;for (var stepCount: f32=0.0; \nopacity<1.0 && P.x*stepDirection<end && sceneDepth>0.0 && stepCount<ssSamples;stepCount+=1) { \nvar coords=vec2i(select(P,P.yx,permute));sceneDepth=textureLoad(depthSampler,coords,0).x;sceneDepth=linearizeDepth(sceneDepth,nearPlaneZ,farPlaneZ);sceneDepth=csZDir*sceneDepth;if (sceneDepth<=0.0) {break;}\nvar rayZMin: f32=rayZMax;rayZMax=csZDir*Z.x/Z.y;opacity+=max(opacity,step(rayZMax,sceneDepth+ssThickness)*step(sceneDepth,rayZMin));P+=dP;Z+=dZ;}\nreturn opacity;}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nfn voxelShadow(wsOrigin: vec3f,wsDirection: vec3f,wsNormal: vec3f,\nDitherNoise: vec2f,\nvoxel_march_diagnostic_info: ptr<function,VoxelMarchDiagnosticInfo>)->f32 {\n#else\nfn voxelShadow(wsOrigin: vec3f,wsDirection: vec3f,wsNormal: vec3f,\nDitherNoise: vec2f)->f32 {\n#endif\nvar vxResolution: f32=f32(textureDimensions(voxelGridSampler,0).x);var T: vec3f;var B: vec3f;genTB(wsDirection,&T,&B);var DitherXY: vec2f=sqrt(DitherNoise.x)* vec2f(cos(2.0*PI*DitherNoise.y),\nsin(2.0*PI*DitherNoise.y));var Dithering : vec3f=(uniforms.voxelBiasParameters.x*wsNormal +\nuniforms.voxelBiasParameters.y*wsDirection +\nDitherXY.x*T+DitherXY.y*B) /\nvxResolution;var O: vec3f=0.5*wsOrigin+0.5+Dithering;var ray_vs=make_ray(O,wsDirection,0.0,10.0);var voxel_aabb: AABB3f;voxel_aabb.m_min=vec3f(0);voxel_aabb.m_max=vec3f(1);var near: f32=0;var far: f32=0;if (!ray_box_intersection(voxel_aabb,ray_vs,&near,&far)) {return 0.0;}\nray_vs.t_min=max(ray_vs.t_min,near);ray_vs.t_max=min(ray_vs.t_max,far);\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nreturn select(0.0f,1.0f,anyHitVoxels(ray_vs,voxel_march_diagnostic_info));\n#else\nreturn select(0.0f,1.0f,anyHitVoxels(ray_vs));\n#endif\n}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var nbDirs=u32(SHADOWdirs);var frameId=u32(SHADOWframe);var envRot: f32=SHADOWenvRot;var Resolution: vec2f= vec2f(textureDimensions(depthSampler,0));var currentPixel=vec2i(fragmentInputs.vUV*Resolution);var GlobalIndex =\n(frameId*u32(Resolution.y)+u32(currentPixel.y))*u32(Resolution.x) +\nu32(currentPixel.x);var N : vec3f=textureLoad(worldNormalSampler,currentPixel,0).xyz;if (length(N)<0.01) {fragmentOutputs.color=vec4f(1.0,1.0,0.0,1.0);return fragmentOutputs;}\nvar normalizedRotation: f32=envRot/(2.0*PI);var depth : f32=textureLoad(depthSampler,currentPixel,0).x;\n#ifndef IS_NDC_HALF_ZRANGE\ndepth=depth*2.0-1.0;\n#endif\nvar temp : vec2f=(vec2f(currentPixel)+vec2f(0.5))*2.0/Resolution -\nvec2f(1.0);var VP : vec4f=uniforms.invProjMtx*vec4f(temp.x,-temp.y,depth,1.0);VP/=VP.w;N=normalize(N);var noise : vec3f=textureLoad(blueNoiseSampler,currentPixel & vec2i(0xFF),0).xyz;noise.z=fract(noise.z+goldenSequence(frameId*nbDirs));\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nvar heat: f32=0.0f;\n#endif\nvar shadowAccum: f32=0.001;var specShadowAccum: f32=0.001;var sampleWeight : f32=0.001;\n#ifdef COLOR_SHADOWS\nvar totalLight: vec3f=vec3f(0.001);var shadowedLight: vec3f=vec3f(0.0);\n#endif\nfor (var i: u32=0; i<nbDirs; i++) {var dirId: u32=nbDirs*GlobalIndex+i;var L: vec4f;var T: vec2f;{var r: vec2f=plasticSequence(frameId*nbDirs+i);r=fract(r+ vec2f(2.0)*abs(noise.xy- vec2f(0.5)));T.x=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2f(r.x,0.0),0.0).x;T.y=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2f(T.x,r.y),0.0).y;L= vec4f(uv_to_normal(vec2f(T.x-normalizedRotation,T.y)),0);\n#ifndef RIGHT_HANDED\nL.z*=-1.0;\n#endif\n}\n#ifdef COLOR_SHADOWS\nvar lightDir: vec3f=uv_to_normal(vec2f(1.0-fract(T.x+0.25),T.y));var ibl: vec3f=textureSampleLevel(iblSampler,iblSamplerSampler,lightDir,0.0).xyz;var pdf: f32=textureSampleLevel(icdfSampler,icdfSamplerSampler,T,0.0).z;\n#endif\nvar cosNL: f32=dot(N,L.xyz);var opacity: f32=0.0;if (cosNL>0.0) {var VP2: vec4f=VP;VP2.y*=-1.0;var unormWP : vec4f=uniforms.invViewMtx*VP2;var WP: vec3f=(uniforms.wsNormalizationMtx*unormWP).xyz;var vxNoise: vec2f=vec2f(uint2float(hash(dirId*2)),uint2float(hash(dirId*2+1)));\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nVoxelMarchDiagnosticInfo voxel_march_diagnostic_info;opacity=max(opacity,\nuniforms.shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise,\nvoxel_march_diagnostic_info));heat+=voxel_march_diagnostic_info.heat;\n#else\nopacity =\nmax(opacity,uniforms.shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise));\n#endif\nvar VL : vec3f=(uniforms.viewMtx*L).xyz;\n#ifdef RIGHT_HANDED\nvar nearPlaneZ: f32=-2.0*uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]-1.0); \nvar farPlaneZ: f32=-uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]+1.0);\n#else\nvar nearPlaneZ: f32=-2.0*uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]+1.0); \nvar farPlaneZ: f32=-uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]-1.0);\n#endif\nvar ssShadow: f32=uniforms.shadowOpacity.y *\nscreenSpaceShadow(VP2.xyz,VL,Resolution,nearPlaneZ,farPlaneZ,\nabs(2.0*noise.z-1.0));opacity=max(opacity,ssShadow);\n#ifdef COLOR_SHADOWS\nvar light: vec3f=select(vec3f(0.0),vec3f(cosNL)/vec3f(pdf)*ibl,pdf>1e-6);shadowedLight+=light*opacity;totalLight+=light;\n#else\nvar rcos: f32=1.0-cosNL;shadowAccum+=(1.0-opacity*(1.0-pow(rcos,8.0)));sampleWeight+=1.0;var VR : vec3f=abs((uniforms.viewMtx*vec4f(reflect(-L.xyz,N),0.0)).xyz);specShadowAccum+=max(1.0-(opacity*pow(VR.z,8.0)),0.0);\n#endif\n}\nnoise.z=fract(noise.z+GOLD);}\n#ifdef COLOR_SHADOWS\nvar shadow: vec3f=(totalLight-shadowedLight)/totalLight;var maxShadow: f32=max(max(shadow.x,max(shadow.y,shadow.z)),1.0);fragmentOutputs.color=vec4f(shadow/maxShadow,1.0);\n#else\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nfragmentOutputs.color =\nvec4f(shadowAccum/sampleWeight,specShadowAccum/sampleWeight,heat/sampleWeight,1.0);\n#else\nfragmentOutputs.color=vec4f(shadowAccum/sampleWeight,specShadowAccum/sampleWeight,0.0,1.0);\n#endif\n#endif\n}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},9669:(e,t,i)=>{i.r(t),i.d(t,{fxaaVertexShader:()=>n});const r="fxaaVertexShader",s="attribute vec2 position;uniform vec2 texelSize;varying vec2 vUV;varying vec2 sampleCoordS;varying vec2 sampleCoordE;varying vec2 sampleCoordN;varying vec2 sampleCoordW;varying vec2 sampleCoordNW;varying vec2 sampleCoordSE;varying vec2 sampleCoordNE;varying vec2 sampleCoordSW;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd);sampleCoordS=vUV+vec2( 0.0,1.0)*texelSize;sampleCoordE=vUV+vec2( 1.0,0.0)*texelSize;sampleCoordN=vUV+vec2( 0.0,-1.0)*texelSize;sampleCoordW=vUV+vec2(-1.0,0.0)*texelSize;sampleCoordNW=vUV+vec2(-1.0,-1.0)*texelSize;sampleCoordSE=vUV+vec2( 1.0,1.0)*texelSize;sampleCoordNE=vUV+vec2( 1.0,-1.0)*texelSize;sampleCoordSW=vUV+vec2(-1.0,1.0)*texelSize;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},9682:(e,t,i)=>{i.r(t),i.d(t,{rgbdDecodePixelShader:()=>o});var r=i(69610);i(73325);const s="rgbdDecodePixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},9915:(e,t,i)=>{i.r(t),i.d(t,{_WebAudioStaticSound:()=>d,_WebAudioStaticSoundBuffer:()=>p});var r=i(19375),s=i(93101),n=i(15904);class o extends n.g{}var a=i(82704),l=i(74232),h=i(97774),c=i(73383),u=i(14457);class d extends r.k{constructor(e,t,i){super(e,t),this._spatial=null,this._spatialAutoUpdate=!0,this._spatialMinUpdateTime=0,this._stereo=null,"boolean"==typeof i.spatialAutoUpdate&&(this._spatialAutoUpdate=i.spatialAutoUpdate),"number"==typeof i.spatialMinUpdateTime&&(this._spatialMinUpdateTime=i.spatialMinUpdateTime),this._options={autoplay:i.autoplay??!1,duration:i.duration??0,loop:i.loop??!1,loopEnd:i.loopEnd??0,loopStart:i.loopStart??0,maxInstances:i.maxInstances??1/0,pitch:i.pitch??0,playbackRate:i.playbackRate??1,startOffset:i.startOffset??0},this._subGraph=new d._SubGraph(this)}async init(e,t){this.audioContext=this.engine.audioContext,e instanceof p?this._buffer=e:("string"==typeof e||Array.isArray(e)||e instanceof ArrayBuffer||e instanceof AudioBuffer)&&(this._buffer=await this.engine.createSoundBufferAsync(e,t)),t.outBus?this.outBus=t.outBus:(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.init(t),(0,a.GB)(t)&&this._initSpatialProperty(),t.autoplay&&this.play(),this.engine.addNode(this)}get buffer(){return this._buffer}get inNode(){return this._subGraph.inNode}get outNode(){return this._subGraph.outNode}get spatial(){return this._spatial?this._spatial:this._initSpatialProperty()}get stereo(){return this._stereo??(this._stereo=new l.i(this._subGraph))}dispose(){super.dispose(),this._spatial?.dispose(),this._spatial=null,this._stereo=null,this._subGraph.dispose(),this.engine.removeNode(this)}getClassName(){return"_WebAudioStaticSound"}_createInstance(){return new m(this,this._options)}_connect(e){return!!super._connect(e)&&(e.inNode&&this.outNode?.connect(e.inNode),!0)}_disconnect(e){return!!super._disconnect(e)&&(e.inNode&&this.outNode?.disconnect(e.inNode),!0)}_initSpatialProperty(){return this._spatial||(this._spatial=new u.i(this._subGraph,this._spatialAutoUpdate,this._spatialMinUpdateTime)),this._spatial}}d._SubGraph=class extends c.Q{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}};class p extends s.C{constructor(e){super(e)}async init(e,t){e instanceof AudioBuffer?this.audioBuffer=e:"string"==typeof e?await this._initFromUrl(e):Array.isArray(e)?await this._initFromUrls(e,t.skipCodecCheck??!1):e instanceof ArrayBuffer&&await this._initFromArrayBuffer(e)}get channelCount(){return this.audioBuffer.numberOfChannels}get duration(){return this.audioBuffer.duration}get length(){return this.audioBuffer.length}get sampleRate(){return this.audioBuffer.sampleRate}async _initFromArrayBuffer(e){this.audioBuffer=await this.engine.audioContext.decodeAudioData(e)}async _initFromUrl(e){e=(0,h.K)(e),await this._initFromArrayBuffer(await(await fetch(e)).arrayBuffer())}async _initFromUrls(e,t){for(const i of e){if(t)await this._initFromUrl(i);else{const e=i.match(h.q),t=e?.at(1);if(t&&this.engine.isFormatValid(t))try{await this._initFromUrl(i)}catch(e){t&&0<t.length&&this.engine.flagInvalidFormat(t)}}if(this.audioBuffer)break}}}class m extends o{constructor(e,t){super(e),this._enginePlayTime=0,this._enginePauseTime=0,this._sourceNode=null,this._onEnded=()=>{this._enginePlayTime=0,this.onEndedObservable.notifyObservers(this),this._deinitSourceNode()},this._onEngineStateChanged=()=>{"running"===this.engine.state&&(this._options.loop&&2===this.state&&this.play(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged))},this._options=t,this._volumeNode=new GainNode(e.audioContext),this._initSourceNode()}get currentTime(){if(1===this._state)return 0;const e=5===this._state?0:this.engine.currentTime-this._enginePlayTime;return this._enginePauseTime+e+this._options.startOffset}set currentTime(e){const t=2===this._state||3===this._state;t&&(this.stop(),this._deinitSourceNode()),this._options.startOffset=e,t&&this.play()}get outNode(){return this._volumeNode}set pitch(e){this._options.pitch=e,this._sourceNode&&(this._sourceNode.detune.value=e)}set playbackRate(e){this._options.playbackRate=e,this._sourceNode&&(this._sourceNode.playbackRate.value=e)}get startTime(){return 1===this._state?0:this._enginePlayTime}dispose(){super.dispose(),this._sourceNode=null,this.stop(),this._deinitSourceNode(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged)}getClassName(){return"_WebAudioStaticSoundInstance"}play(e={}){if(3===this._state)return;void 0!==e.duration&&(this._options.duration=e.duration),void 0!==e.loop&&(this._options.loop=e.loop),void 0!==e.loopStart&&(this._options.loopStart=e.loopStart),void 0!==e.loopEnd&&(this._options.loopEnd=e.loopEnd),void 0!==e.pitch&&(this._options.pitch=e.pitch),void 0!==e.playbackRate&&(this._options.playbackRate=e.playbackRate),void 0!==e.startOffset&&(this._options.startOffset=e.startOffset);let t=this._options.startOffset;5===this._state&&(t+=this.currentTime,t%=this._sound.buffer.duration),this._enginePlayTime=this.engine.currentTime+(e.waitTime??0),this._volumeNode.gain.value=e.volume??1,this._initSourceNode(),"running"===this.engine.state?(this._setState(3),this._sourceNode?.start(this._enginePlayTime,t,this._options.duration>0?this._options.duration:void 0)):this._options.loop&&(this._setState(2),this.engine.stateChangedObservable.add(this._onEngineStateChanged))}pause(){5!==this._state&&(this._setState(5),this._enginePauseTime+=this.engine.currentTime-this._enginePlayTime,this._sourceNode?.stop(),this._deinitSourceNode())}resume(){5===this._state&&this.play()}stop(e={}){if(1===this._state)return;this._setState(1);const t=this.engine.currentTime+(e.waitTime??0);this._sourceNode?.stop(t),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged)}_connect(e){return!!super._connect(e)&&(e instanceof d&&e.inNode&&this.outNode?.connect(e.inNode),!0)}_disconnect(e){return!!super._disconnect(e)&&(e instanceof d&&e.inNode&&this.outNode?.disconnect(e.inNode),!0)}_deinitSourceNode(){if(this._sourceNode){if(!this._disconnect(this._sound))throw new Error("Disconnect failed");this._sourceNode.disconnect(this._volumeNode),this._sourceNode.removeEventListener("ended",this._onEnded),this._sourceNode=null}}_initSourceNode(){if(!this._sourceNode&&(this._sourceNode=new AudioBufferSourceNode(this._sound.audioContext,{buffer:this._sound.buffer.audioBuffer}),this._sourceNode.addEventListener("ended",this._onEnded,{once:!0}),this._sourceNode.connect(this._volumeNode),!this._connect(this._sound)))throw new Error("Connect failed");const e=this._sourceNode;e.detune.value=this._options.pitch,e.loop=this._options.loop,e.loopEnd=this._options.loopEnd,e.loopStart=this._options.loopStart,e.playbackRate.value=this._options.playbackRate}}},9938:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphBezierCurveEasingBlock:()=>a});var r=i(15321),s=i(71294),n=i(4720),o=i(56552);class a extends s.e{constructor(e){super(e),this.config=e,this._easingFunctions={},this.mode=this.registerDataInput("mode",n.Es,0),this.controlPoint1=this.registerDataInput("controlPoint1",n.K$),this.controlPoint2=this.registerDataInput("controlPoint2",n.K$),this.easingFunction=this.registerDataOutput("easingFunction",n.Vv)}_updateOutputs(e){const t=this.mode.getValue(e),i=this.controlPoint1.getValue(e),s=this.controlPoint2.getValue(e);if(void 0===t)return;const n=`${t}-${i.x}-${i.y}-${s.x}-${s.y}`;if(!this._easingFunctions[n]){const e=new r.Bv(i.x,i.y,s.x,s.y);e.setEasingMode(t),this._easingFunctions[n]=e}this.easingFunction.setValue(this._easingFunctions[n],e)}getClassName(){return"FlowGraphBezierCurveEasing"}}(0,o.Y5)("FlowGraphBezierCurveEasing",a)},9977:(e,t,i)=>{i.r(t),i.d(t,{depthVertexShader:()=>l});var r=i(69610);i(69707),i(18959),i(27999),i(90738),i(71636),i(1218);const s="pointCloudVertexDeclaration",n="#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n";r.l.IncludesShadersStore[s]=n;i(48451),i(15060),i(3298),i(3361),i(65523),i(47314),i(91211);const o="depthVertexShader",a="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;uniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#ifdef STORE_CAMERASPACE_Z\nuniform mat4 view;varying vec4 vViewPos;\n#endif\n#include<pointCloudVertexDeclaration>\nvarying float vDepthMetric;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef UV2\nvec2 uv2Updated=uv2;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#include<clipPlaneVertex>\ngl_Position=viewProjection*worldPos;\n#ifdef STORE_CAMERASPACE_Z\nvViewPos=view*worldPos;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));\n#else\nvDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));\n#endif\n#endif\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#endif\n#include<pointCloudVertex>\n}\n";r.l.ShadersStore[o]=a;const l={name:o,shader:a}},10355:(e,t,i)=>{i.r(t),i.d(t,{depthBoxBlurPixelShaderWGSL:()=>n});const r="depthBoxBlurPixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var colorDepth: vec4f=vec4f(0.0);for (var x: i32=-OFFSET; x<=OFFSET; x++) {for (var y: i32=-OFFSET; y<=OFFSET; y++) {colorDepth+=textureSample(textureSampler,textureSamplerSampler,input.vUV+ vec2f(f32(x),f32(y))/uniforms.screenSize);}}\nfragmentOutputs.color=(colorDepth/ f32((OFFSET*2+1)*(OFFSET*2+1)));}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},10362:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphConditionalDataBlock:()=>o});var r=i(71294),s=i(4720),n=i(56552);class o extends r.e{constructor(e){super(e),this.condition=this.registerDataInput("condition",s.RI),this.onTrue=this.registerDataInput("onTrue",s.Vv),this.onFalse=this.registerDataInput("onFalse",s.Vv),this.output=this.registerDataOutput("output",s.Vv)}_updateOutputs(e){const t=this.condition.getValue(e);this.output.setValue(t?this.onTrue.getValue(e):this.onFalse.getValue(e),e)}getClassName(){return"FlowGraphConditionalBlock"}}(0,n.Y5)("FlowGraphConditionalBlock",o)},10461:(e,t,i)=>{i.r(t),i.d(t,{iblIcdfPixelShaderWGSL:()=>o});var r=i(69610);i(79702);const s="iblIcdfPixelShader",n="#include<helperFunctions>\nvarying vUV: vec2f;\n#ifdef IBL_USE_CUBE_MAP\nvar iblSourceSampler: sampler;var iblSource: texture_cube<f32>;\n#else\nvar iblSourceSampler: sampler;var iblSource: texture_2d<f32>;\n#endif\nvar scaledLuminanceSamplerSampler : sampler;var scaledLuminanceSampler : texture_2d<f32>;var cdfx: texture_2d<f32>;var cdfy: texture_2d<f32>;fn fetchLuminance(coords: vec2f)->f32 {\n#ifdef IBL_USE_CUBE_MAP\nvar direction: vec3f=equirectangularToCubemapDirection(coords);var color: vec3f=textureSampleLevel(iblSource,iblSourceSampler,direction,0.0).rgb;\n#else\nvar color: vec3f=textureSampleLevel(iblSource,iblSourceSampler,coords,0.0).rgb;\n#endif\nreturn dot(color,LuminanceEncodeApprox);}\nfn fetchCDFx(x: u32)->f32 {return textureLoad(cdfx, vec2u(x,0),0).x;}\nfn bisectx(size: u32,targetValue: f32)->f32\n{var a: u32=0;var b=size-1;while (b-a>1) {var c: u32=(a+b)>>1;if (fetchCDFx(c)<targetValue) {a=c;}\nelse {b=c;}}\nreturn mix( f32(a), f32(b),(targetValue-fetchCDFx(a))/(fetchCDFx(b)-fetchCDFx(a)))/ f32(size-1);}\nfn fetchCDFy(y: u32,invocationId: u32)->f32 {return textureLoad(cdfy, vec2u(invocationId,y),0).x;}\nfn bisecty(size: u32,targetValue: f32,invocationId: u32)->f32\n{var a: u32=0;var b=size-1;while (b-a>1) {var c=(a+b)>>1;if (fetchCDFy(c,invocationId)<targetValue) {a=c;}\nelse {b=c;}}\nreturn mix( f32(a), f32(b),(targetValue-fetchCDFy(a,invocationId))/(fetchCDFy(b,invocationId)-fetchCDFy(a,invocationId)))/ f32(size-1);}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var cdfxSize: vec2u=textureDimensions(cdfx,0);var cdfWidth: u32=cdfxSize.x;var icdfWidth: u32=cdfWidth-1;var currentPixel: vec2u= vec2u(fragmentInputs.position.xy);var outputColor: vec3f=vec3f(1.0);if (currentPixel.x==0)\n{outputColor.x= 0.0;}\nelse if (currentPixel.x==icdfWidth-1) {outputColor.x= 1.0;} else {var targetValue: f32=fetchCDFx(cdfWidth-1)*input.vUV.x;outputColor.x= bisectx(cdfWidth,targetValue);}\nvar cdfySize: vec2u=textureDimensions(cdfy,0);var cdfHeight: u32=cdfySize.y;if (currentPixel.y==0) {outputColor.y= 0.0;}\nelse if (currentPixel.y==cdfHeight-2) {outputColor.y= 1.0;} else {var targetValue: f32=fetchCDFy(cdfHeight-1,currentPixel.x)*input.vUV.y;outputColor.y= max(bisecty(cdfHeight,targetValue,currentPixel.x),0.0);}\nvar size : vec2f=vec2f(textureDimensions(scaledLuminanceSampler,0));var highestMip: f32=floor(log2(size.x));var normalization : f32=textureSampleLevel(scaledLuminanceSampler,\nscaledLuminanceSamplerSampler,\ninput.vUV,highestMip)\n.r;var pixelLuminance: f32=fetchLuminance(input.vUV);outputColor.z=pixelLuminance/(2.0*PI*normalization);fragmentOutputs.color=vec4( outputColor,1.0);}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},10833:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphContextBlock:()=>o});var r=i(71294),s=i(4720),n=i(56552);class o extends r.e{constructor(e){super(e),this.userVariables=this.registerDataOutput("userVariables",s.Vv),this.executionId=this.registerDataOutput("executionId",s.Es)}_updateOutputs(e){this.userVariables.setValue(e.userVariables,e),this.executionId.setValue(e.executionId,e)}serialize(e){super.serialize(e)}getClassName(){return"FlowGraphContextBlock"}}(0,n.Y5)("FlowGraphContextBlock",o)},11084:(e,t,i)=>{i.r(t),i.d(t,{bilateralBlurQualityPixelShaderWGSL:()=>n});const r="bilateralBlurQualityPixelShader",s="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;uniform filterSize: i32;uniform blurDir: vec2f;uniform depthThreshold: f32;uniform normalThreshold: f32;varying vUV: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.).rgb;var depth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.).x;if (depth>=1e6 || depth<=0.) {fragmentOutputs.color= vec4f(color,1.);return fragmentOutputs;}\nvar normal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV,0.).rgb;\n#ifdef DECODE_NORMAL\nnormal=normal*2.0-1.0;\n#endif\nvar sigma: f32= f32(uniforms.filterSize);var two_sigma2: f32=2.0*sigma*sigma;var sigmaDepth: f32=uniforms.depthThreshold;var two_sigmaDepth2: f32=2.0*sigmaDepth*sigmaDepth;var sigmaNormal: f32=uniforms.normalThreshold;var two_sigmaNormal2: f32=2.0*sigmaNormal*sigmaNormal;var sum: vec3f= vec3f(0.);var wsum: f32=0.;for (var x: i32=-uniforms.filterSize; x<=uniforms.filterSize; x++) {for (var y: i32=-uniforms.filterSize; y<=uniforms.filterSize; y++) {var coords: vec2f= vec2f(f32(x),f32(y))*uniforms.blurDir;var sampleColor: vec3f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV+coords,0.).rgb;var sampleDepth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV+coords,0.).r;var sampleNormal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV+coords,0.).rgb;\n#ifdef DECODE_NORMAL\nsampleNormal=sampleNormal*2.0-1.0;\n#endif\nvar r: f32=dot(coords,coords);var w: f32=exp(-r/two_sigma2);var rDepth: f32=sampleDepth-depth;var wd: f32=exp(-rDepth*rDepth/two_sigmaDepth2);var rNormal: f32=abs(sampleNormal.x-normal.x)+abs(sampleNormal.y-normal.y)+abs(sampleNormal.z-normal.z);var wn: f32=exp(-rNormal*rNormal/two_sigmaNormal2);sum+=sampleColor*w*wd*wn;wsum+=w*wd*wn;}}\nfragmentOutputs.color= vec4f(sum/wsum,1.);}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},11114:(e,t,i)=>{i.r(t),i.d(t,{backgroundVertexShader:()=>l});var r=i(69610);const s="backgroundVertexDeclaration",n="uniform mat4 view;uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\nuniform float shadowLevel;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n";r.l.IncludesShadersStore[s]=n;i(86722),i(73325),i(69707),i(18959),i(1218),i(71636),i(86560),i(47059),i(4662),i(34581),i(3298),i(3361),i(65523),i(47314),i(16470),i(35687),i(2215);const o="backgroundVertexShader",a="precision highp float;\n#include<__decl__backgroundVertex>\n#include<helperFunctions>\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nvarying vec2 vDiffuseUV;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=position;\n#endif\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*finalWorld*vec4(position,1.0);} else {gl_Position=viewProjectionR*finalWorld*vec4(position,1.0);}\n#else\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#endif\nvec4 worldPos=finalWorld*vec4(position,1.0);vPositionW=vec3(worldPos);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normal);\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));\n#ifdef EQUIRECTANGULAR_RELFECTION_FOV\nmat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));vec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vDirectionW=normalize(segment);} else {vDirectionW=normalize(vDirectionW+(vDirectionW-segment));}\n#endif\n#endif\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uv;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nif (vDiffuseInfos.x==0.)\n{vDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));}\nelse\n{vDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));}\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#ifdef VERTEXCOLOR\nvColor=colorUpdated;\n#endif\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";r.l.ShadersStore[o]=a;const l={name:o,shader:a}},11995:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphCancelDelayBlock:()=>o});var r=i(56552),s=i(33006),n=i(4720);class o extends s.w{constructor(e){super(e),this.delayIndex=this.registerDataInput("delayIndex",n.Es)}_execute(e,t){const i=this.delayIndex.getValue(e);if(i<=0||isNaN(i)||!isFinite(i))return this._reportError(e,"Invalid delay index");const r=e._getExecutionVariable(this,"pendingDelays",[])[i];r&&r.dispose(),this.out._activateSignal(e)}getClassName(){return"FlowGraphCancelDelayBlock"}}(0,r.Y5)("FlowGraphCancelDelayBlock",o)},12814:(e,t,i)=>{i.r(t),i.d(t,{boundingBoxRendererPixelShaderWGSL:()=>n});const r="boundingBoxRendererPixelShader",s="uniform color: vec4f;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nfragmentOutputs.color=uniforms.color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},12850:(e,t,i)=>{i.r(t),i.d(t,{kernelBlurPixelShaderWGSL:()=>c});var r=i(69610);i(52383),i(5543);const s="kernelBlurFragment",n="#ifdef DOF\nfactor=sampleCoC(fragmentInputs.sampleCoord{X}); \ncomputedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCoord{X}))*computedWeight;\n#else\nblend+=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCoord{X})*computedWeight;\n#endif\n";r.l.IncludesShadersStoreWGSL[s]=n;const o="kernelBlurFragment2",a="#ifdef DOF\nfactor=sampleCoC(fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_DEP_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X}))*computedWeight;\n#else\nblend+=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X})*computedWeight;\n#endif\n";r.l.IncludesShadersStoreWGSL[o]=a;const l="kernelBlurPixelShader",h="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform delta: vec2f;varying sampleCenter: vec2f;\n#ifdef DOF\nvar circleOfConfusionSamplerSampler: sampler;var circleOfConfusionSampler: texture_2d<f32>;fn sampleCoC(offset: vec2f)->f32 {var coc: f32=textureSample(circleOfConfusionSampler,circleOfConfusionSamplerSampler,offset).r;return coc; }\n#endif\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#ifdef PACKEDFLOAT\n#include<packingFunctions>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var computedWeight: f32=0.0;\n#ifdef PACKEDFLOAT\nvar blend: f32=0.;\n#else\nvar blend: vec4f= vec4f(0.);\n#endif\n#ifdef DOF\nvar sumOfWeights: f32=CENTER_WEIGHT; \nvar factor: f32=0.0;\n#ifdef PACKEDFLOAT\nblend+=unpack(textureSample(textureSampler,textureSamplerSampler,input.sampleCenter))*CENTER_WEIGHT;\n#else\nblend+=textureSample(textureSampler,textureSamplerSampler,input.sampleCenter)*CENTER_WEIGHT;\n#endif\n#endif\n#include<kernelBlurFragment>[0..varyingCount]\n#include<kernelBlurFragment2>[0..depCount]\n#ifdef PACKEDFLOAT\nfragmentOutputs.color=pack(blend);\n#else\nfragmentOutputs.color=blend;\n#endif\n#ifdef DOF\nfragmentOutputs.color/=sumOfWeights;\n#endif\n}";r.l.ShadersStoreWGSL[l]=h;const c={name:l,shader:h}},13118:(e,t,i)=>{i.r(t),i.d(t,{rsmGlobalIlluminationPixelShaderWGSL:()=>n});const r="rsmGlobalIlluminationPixelShader",s="/**\n* The implementation is an application of the formula found in http:\n* For better results,it also adds a random (noise) rotation to the RSM samples (the noise artifacts are easier to remove than the banding artifacts).\n*/\nvarying vUV: vec2f;uniform rsmLightMatrix: mat4x4f;uniform rsmInfo: vec4f;uniform rsmInfo2: vec4f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;var rsmPositionWSampler: sampler;var rsmPositionW: texture_2d<f32>;var rsmNormalWSampler: sampler;var rsmNormalW: texture_2d<f32>;var rsmFluxSampler: sampler;var rsmFlux: texture_2d<f32>;var rsmSamples: texture_2d<f32>;\n#ifdef TRANSFORM_NORMAL\nuniform invView: mat4x4f;\n#endif\nfn mod289(x: f32)->f32{return x-floor(x*(1.0/289.0))*289.0;}\nfn mod289Vec4(x: vec4f)->vec4f {return x-floor(x*(1.0/289.0))* 289.0;}\nfn perm(x: vec4f)->vec4f {return mod289Vec4(((x*34.0)+1.0)*x) ;}\nfn noise(p: vec3f)->f32{var a: vec3f=floor(p);var d: vec3f=p-a;d=d*d*(3.0-2.0*d);var b: vec4f=a.xxyy+ vec4f(0.0,1.0,0.0,1.0);var k1: vec4f=perm(b.xyxy);var k2: vec4f=perm(k1.xyxy+b.zzww);var c: vec4f=k2+a.zzzz;var k3: vec4f=perm(c);var k4: vec4f=perm(c+1.0);var o1: vec4f=fract(k3*(1.0/41.0));var o2: vec4f=fract(k4*(1.0/41.0));var o3: vec4f=o2*d.z+o1*(1.0-d.z);var o4: vec2f=o3.yw*d.x+o3.xz*(1.0-d.x);return o4.y*d.y+o4.x*(1.0-d.y);}\nfn computeIndirect(p: vec3f,n: vec3f)->vec3f {var indirectDiffuse: vec3f= vec3f(0.);var numSamples: i32= i32(uniforms.rsmInfo.x);var radius: f32=uniforms.rsmInfo.y;var intensity: f32=uniforms.rsmInfo.z;var edgeArtifactCorrection: f32=uniforms.rsmInfo.w;var texRSM: vec4f=uniforms.rsmLightMatrix* vec4f(p,1.);texRSM=vec4f(texRSM.xy/texRSM.w,texRSM.z,texRSM.w);texRSM=vec4f(texRSM.xy*0.5+0.5,texRSM.z,texRSM.w);var angle: f32=noise(p*uniforms.rsmInfo2.x);var c: f32=cos(angle);var s: f32=sin(angle);for (var i: i32=0; i<numSamples; i++) {var rsmSample: vec3f=textureLoad(rsmSamples,vec2<i32>(i,0),0).xyz;var weightSquare: f32=rsmSample.z;if (uniforms.rsmInfo2.y==1.0){rsmSample=vec3f(rsmSample.x*c+rsmSample.y*s,-rsmSample.x*s+rsmSample.y*c,rsmSample.z);}\nvar uv: vec2f=texRSM.xy+rsmSample.xy*radius;if (uv.x<0. || uv.x>1. || uv.y<0. || uv.y>1.) {continue;}\nvar vplPositionW: vec3f=textureSampleLevel(rsmPositionW,rsmPositionWSampler,uv,0.).xyz;var vplNormalW: vec3f=textureSampleLevel(rsmNormalW,rsmNormalWSampler,uv,0.).xyz*2.0-1.0;var vplFlux: vec3f=textureSampleLevel(rsmFlux,rsmFluxSampler,uv,0.).rgb;vplPositionW-=vplNormalW*edgeArtifactCorrection; \nvar dist2: f32=dot(vplPositionW-p,vplPositionW-p);indirectDiffuse+=vplFlux*weightSquare*max(0.,dot(n,vplPositionW-p))*max(0.,dot(vplNormalW,p-vplPositionW))/(dist2*dist2);}\nreturn clamp(indirectDiffuse*intensity,vec3f(0.0),vec3f(1.0));}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var positionW: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).xyz;var normalW: vec3f=textureSample(normalSampler,normalSamplerSampler,input.vUV).xyz;\n#ifdef DECODE_NORMAL\nnormalW=normalW*2.0-1.0;\n#endif\n#ifdef TRANSFORM_NORMAL\nnormalW=(uniforms.invView* vec4f(normalW,0.)).xyz;\n#endif\nfragmentOutputs.color=vec4f(computeIndirect(positionW,normalW),1.0);}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},13172:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleDepthVertexShader:()=>n});const r="fluidRenderingParticleDepthVertexShader",s="attribute vec3 position;attribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;varying vec3 viewPos;varying float sphereRadius;\n#ifdef FLUIDRENDERING_VELOCITY\nattribute vec3 velocity;varying float velocityNorm;\n#endif\nvoid main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;viewPos=(view*vec4(position,1.0)).xyz;gl_Position=projection*vec4(viewPos+cornerPos,1.0);uv=offset;sphereRadius=size.x/2.0;\n#ifdef FLUIDRENDERING_VELOCITY\nvelocityNorm=length(velocity);\n#endif\n}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},13433:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphJsonPointerParserBlock:()=>l});var r=i(92579),s=i(4720),n=i(56552),o=i(26041),a=i(94423);class l extends a.r{constructor(e){super(s.Vv,e),this.config=e,this.object=this.registerDataOutput("object",s.Vv),this.propertyName=this.registerDataOutput("propertyName",s.Vv),this.setterFunction=this.registerDataOutput("setFunction",s.Vv,this._setPropertyValue.bind(this)),this.getterFunction=this.registerDataOutput("getFunction",s.Vv,this._getPropertyValue.bind(this)),this.generateAnimationsFunction=this.registerDataOutput("generateAnimationsFunction",s.Vv,this._getInterpolationAnimationPropertyInfo.bind(this)),this.templateComponent=new r.H(e.jsonPointer,this)}_doOperation(e){const t=this.templateComponent.getAccessor(this.config.pathConverter,e),i=t.info.get(t.object),r=t.info.getTarget?.(t.object),s=t.info.getPropertyName?.[0](t.object);if(!r)throw new Error("Object is undefined");return this.object.setValue(r,e),s&&this.propertyName.setValue(s,e),i}_setPropertyValue(e,t,i,r){const s=this.templateComponent.getAccessor(this.config.pathConverter,r),n=s.info.type;n.startsWith("Color")&&(i=h(i,n)),s.info.set?.(i,s.object)}_getPropertyValue(e,t,i){const r=this.templateComponent.getAccessor(this.config.pathConverter,i);return r.info.get(r.object)}_getInterpolationAnimationPropertyInfo(e,t,i){const r=this.templateComponent.getAccessor(this.config.pathConverter,i);return(e,t,i,s)=>{const n=[],o=r.info.type;return o.startsWith("Color")&&(e=e.map((e=>({frame:e.frame,value:h(e.value,o)})))),r.info.interpolation?.forEach(((t,o)=>{const a=r.info.getPropertyName?.[o](r.object)||"Animation-interpolation-"+o;let l=e;i!==t.type&&(l=e.map((e=>({frame:e.frame,value:t.getValue(void 0,e.value.asArray?e.value.asArray():[e.value],0,1)}))));t.buildAnimations(r.object,a,60,l).forEach((e=>{s&&e.babylonAnimation.setEasingFunction(s),n.push(e.babylonAnimation)}))})),n}}getClassName(){return"FlowGraphJsonPointerParserBlock"}}function h(e,t){return e.getClassName().startsWith("Color")?e:"Color3"===t?new o.v9(e.x,e.y,e.z):"Color4"===t?new o.ov(e.x,e.y,e.z,e.w):e}(0,n.Y5)("FlowGraphJsonPointerParserBlock",l)},13802:(e,t,i)=>{i.r(t),i.d(t,{outlinePixelShaderWGSL:()=>o});var r=i(69610);i(39759),i(93226),i(97715),i(38780);const s="outlinePixelShader",n="uniform color: vec4f;\n#ifdef ALPHATEST\nvarying vUV: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vUV).a<0.4) {discard;}\n#endif\n#include<logDepthFragment>\nfragmentOutputs.color=uniforms.color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},14005:(e,t,i)=>{i.r(t),i.d(t,{proceduralVertexShaderWGSL:()=>n});const r="proceduralVertexShader",s="attribute position: vec2f;varying vPosition: vec2f;varying vUV: vec2f;const madd: vec2f= vec2f(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.vPosition=input.position;vertexOutputs.vUV=input.position*madd+madd;vertexOutputs.position= vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},14268:(e,t,i)=>{i.r(t),i.d(t,{defaultVertexShader:()=>l});var r=i(69610);i(96019);const s="defaultVertexDeclaration",n="uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nmat4 viewProjectionR;\n#endif \nuniform mat4 view;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;uniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;uniform mat4 specularMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform mat4 bumpMatrix;\n#endif\n#ifdef REFLECTION\nuniform mat4 reflectionMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;uniform mat4 detailMatrix;\n#endif\n#include<decalVertexDeclaration>\n#define ADDITIONAL_VERTEX_DECLARATION\n";r.l.IncludesShadersStore[s]=n;i(81438),i(94381),i(73325),i(69707),i(18959),i(1218),i(78328),i(4980),i(85136),i(56390),i(71636),i(86560),i(47059),i(4662),i(27999),i(90738),i(34581),i(48451),i(15060),i(3298),i(3361),i(65523),i(65438),i(4981),i(41316),i(19440),i(47314),i(16470),i(35687),i(94483),i(91211),i(2215);const o="defaultVertexShader",a="#define CUSTOM_VERTEX_EXTENSION\n#include<__decl__defaultVertex>\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<mainUVVaryingDeclaration>[1..7]\n#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#if defined(SPECULARTERM)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)\n#endif\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef UV2\nvec2 uv2Updated=uv2;\n#endif\n#ifdef VERTEXCOLOR\nvec4 colorUpdated=color;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\nvPositionW=vec3(worldPos);\n#ifdef PREPASS\n#include<prePassVertex>\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2Updated=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2Updated;\n#endif\n#include<uvVariableDeclaration>[3..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#if defined(SPECULARTERM)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)\n#endif\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#include<pointCloudVertex>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";r.l.ShadersStore[o]=a;const l={name:o,shader:a}},14457:(e,t,i)=>{i.d(t,{i:()=>a});var r=i(93460),s=i(82704);class n extends s.lA{constructor(e){super();const t=(0,r.y5)(e);t?(this._position=t.position.clone(),this._rotation=t.rotation.clone(),this._rotationQuaternion=t.rotationQuaternion.clone()):(this._position=s.Qc.position.clone(),this._rotation=s.Qc.rotation.clone(),this._rotationQuaternion=s.Qc.rotationQuaternion.clone(),e.createAndAddSubNode("Spatial")),this._subGraph=e}get coneInnerAngle(){return(0,r.hG)(this._subGraph,"coneInnerAngle")??s.Qc.coneInnerAngle}set coneInnerAngle(e){(0,r.Pt)(this._subGraph,"coneInnerAngle",e)}get coneOuterAngle(){return(0,r.hG)(this._subGraph,"coneOuterAngle")}set coneOuterAngle(e){(0,r.Pt)(this._subGraph,"coneOuterAngle",e)}get coneOuterVolume(){return(0,r.hG)(this._subGraph,"coneOuterVolume")}set coneOuterVolume(e){(0,r.Pt)(this._subGraph,"coneOuterVolume",e)}get distanceModel(){return(0,r.hG)(this._subGraph,"distanceModel")}set distanceModel(e){(0,r.Pt)(this._subGraph,"distanceModel",e)}get isAttached(){return this._subGraph.getSubNode("Spatial")?.isAttached??!1}get maxDistance(){return(0,r.hG)(this._subGraph,"maxDistance")??s.Qc.maxDistance}set maxDistance(e){e<=0&&(e=1e-6),(0,r.Pt)(this._subGraph,"maxDistance",e)}get minDistance(){return(0,r.hG)(this._subGraph,"minDistance")}set minDistance(e){(0,r.Pt)(this._subGraph,"minDistance",e)}get panningModel(){return(0,r.hG)(this._subGraph,"panningModel")}set panningModel(e){(0,r.Pt)(this._subGraph,"panningModel",e)}get position(){return this._position}set position(e){this._position=e,this._updatePosition()}get rolloffFactor(){return(0,r.hG)(this._subGraph,"rolloffFactor")}set rolloffFactor(e){(0,r.Pt)(this._subGraph,"rolloffFactor",e)}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._updateRotation()}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,this._updateRotation()}attach(e,t=!1,i=3){(0,r.y5)(this._subGraph)?.attach(e,t,i)}detach(){(0,r.y5)(this._subGraph)?.detach()}update(){const e=(0,r.y5)(this._subGraph);e&&(e.isAttached?e.update():(this._updatePosition(e),this._updateRotation(e)))}_updatePosition(e=null){if(!e&&!(e=(0,r.y5)(this._subGraph)))return;e.position.equalsWithEpsilon(this._position)||(e.position.copyFrom(this._position),e._updatePosition())}_updateRotation(e=null){(e||(e=(0,r.y5)(this._subGraph)))&&(e.rotationQuaternion.equalsWithEpsilon(this._rotationQuaternion)?e.rotation.equalsWithEpsilon(this._rotation)||(e.rotation.copyFrom(this._rotation),e._updateRotation()):(e.rotationQuaternion.copyFrom(this._rotationQuaternion),e._updateRotation()))}}var o=i(41199);class a extends n{constructor(e,t,i){super(e),this._updaterComponent=new o.w(this,t,i)}get minUpdateTime(){return this._updaterComponent.minUpdateTime}set minUpdateTime(e){this._updaterComponent.minUpdateTime=e}dispose(){this._updaterComponent.dispose(),this._updaterComponent=null}}},14958:(e,t,i)=>{i.r(t),i.d(t,{oitFinalPixelShaderWGSL:()=>n});const r="oitFinalPixelShader",s="var uFrontColor: texture_2d<f32>;var uBackColor: texture_2d<f32>;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var fragCoord: vec2i=vec2i(fragmentInputs.position.xy);var frontColor: vec4f=textureLoad(uFrontColor,fragCoord,0);var backColor: vec4f=textureLoad(uBackColor,fragCoord,0);var alphaMultiplier: f32=1.0-frontColor.a;fragmentOutputs.color=vec4f(\nfrontColor.rgb+alphaMultiplier*backColor.rgb,\nfrontColor.a+backColor.a\n);}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},15105:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererFinaliserPixelShader:()=>n});const r="meshUVSpaceRendererFinaliserPixelShader",s="precision highp float;varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D maskTextureSampler;uniform vec2 textureSize;void main() {vec4 mask=texture2D(maskTextureSampler,vUV).rgba;if (mask.r>0.5) {gl_FragColor=texture2D(textureSampler,vUV);} else {vec2 texelSize=4.0/textureSize;vec2 uv_p01=vUV+vec2(-1.0,0.0)*texelSize;vec2 uv_p21=vUV+vec2(1.0,0.0)*texelSize;vec2 uv_p10=vUV+vec2(0.0,-1.0)*texelSize;vec2 uv_p12=vUV+vec2(0.0,1.0)*texelSize;float mask_p01=texture2D(maskTextureSampler,uv_p01).r;float mask_p21=texture2D(maskTextureSampler,uv_p21).r;float mask_p10=texture2D(maskTextureSampler,uv_p10).r;float mask_p12=texture2D(maskTextureSampler,uv_p12).r;vec4 col=vec4(0.0,0.0,0.0,0.0);float total_weight=0.0;if (mask_p01>0.5) {col+=texture2D(textureSampler,uv_p01);total_weight+=1.0;}\nif (mask_p21>0.5) {col+=texture2D(textureSampler,uv_p21);total_weight+=1.0;}\nif (mask_p10>0.5) {col+=texture2D(textureSampler,uv_p10);total_weight+=1.0;}\nif (mask_p12>0.5) {col+=texture2D(textureSampler,uv_p12);total_weight+=1.0;}\nif (total_weight>0.0) {gl_FragColor=col/total_weight;} else {gl_FragColor=col;}}}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},15450:(e,t,i)=>{i.r(t),i.d(t,{colorPixelShader:()=>o});var r=i(69610);i(6194),i(7806),i(7412),i(2360);const s="colorPixelShader",n="#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\n#define VERTEXCOLOR\nvarying vec4 vColor;\n#else\nuniform vec4 color;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\ngl_FragColor=vColor;\n#else\ngl_FragColor=color;\n#endif\n#include<fogFragment>(color,gl_FragColor)\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},15518:(e,t,i)=>{i.d(t,{KJ:()=>o,a7:()=>n,n9:()=>l,x8:()=>a});var r=i(80516),s=i(23694);class n extends r.e{constructor(e){super("Stereo",e)}setOptions(e){this.pan=e.stereoPan??s.uJ.pan}}function o(e){return e.getSubNode("Stereo")}function a(e,t){return o(e)?.[t]??s.uJ[t]}function l(e,t,i){e.callOnSubNode("Stereo",(e=>{e[t]=i}))}},15555:(e,t,i)=>{i.d(t,{G:()=>s});var r=i(1919);class s extends r.G{constructor(e,t){super(e,t),this._preloadedInstances=new Array}get preloadCount(){return this._options.preloadCount??1}get preloadCompletedCount(){return this._preloadedInstances.length}preloadInstance(){const e=this._createInstance();return this._addPreloadedInstance(e),e.preloadedPromise}async preloadInstances(e){for(let t=0;t<e;t++)this.preloadInstance();await Promise.all(this._preloadedInstances.map((e=>e.preloadedPromise)))}play(e={}){if(5===this.state)return void this.resume();let t;this.preloadCompletedCount>0?(t=this._preloadedInstances[0],t.startOffset=this.startOffset,this._removePreloadedInstance(t)):t=this._createInstance();const i=()=>{3===t.state&&(this._stopExcessInstances(),t.onStateChangedObservable.removeCallback(i))};t.onStateChangedObservable.add(i),e.startOffset??(e.startOffset=this.startOffset),e.loop??(e.loop=this.loop),e.volume??(e.volume=1),this._beforePlay(t),t.play(e),this._afterPlay(t)}stop(){if(this._setState(1),this._instances)for(const e of Array.from(this._instances))e.stop()}_addPreloadedInstance(e){this._preloadedInstances.includes(e)||this._preloadedInstances.push(e)}_removePreloadedInstance(e){const t=this._preloadedInstances.indexOf(e);-1!==t&&this._preloadedInstances.splice(t,1)}}},15583:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphSceneReadyEventBlock:()=>n});var r=i(22086),s=i(56552);class n extends r.i{constructor(){super(...arguments),this.initPriority=-1,this.type="SceneReady"}_executeEvent(e,t){return this._execute(e),!0}_preparePendingTasks(e){}_cancelPendingTasks(e){}getClassName(){return"FlowGraphSceneReadyEventBlock"}}(0,s.Y5)("FlowGraphSceneReadyEventBlock",n)},15682:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphSetVariableBlock:()=>o});var r=i(56552),s=i(33006),n=i(4720);class o extends s.w{constructor(e){super(e),this.value=this.registerDataInput("value",n.Vv)}_execute(e,t){const i=e._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);for(const t of i){const r=e.assetsContext.animationGroups[t];for(const s of r.targetedAnimations)if(s.target===e&&s.target===e&&s.animation.targetProperty===this.config?.variable){r.stop();const s=i.indexOf(t);s>-1&&i.splice(s,1),e._setGlobalContextVariable("currentlyRunningAnimationGroups",i);break}}e.setVariable(this.config?.variable,this.value.getValue(e)),this.out._activateSignal(e)}getClassName(){return"FlowGraphSetVariableBlock"}serialize(e){super.serialize(e),e.config.variable=this.config?.variable}}(0,r.Y5)("FlowGraphSetVariableBlock",o)},15904:(e,t,i)=>{i.d(t,{g:()=>n});var r=i(99848),s=i(26846);class n extends s.f0{constructor(e){super(e.engine,2),this._state=1,this.onEndedObservable=new r.cP,this.onErrorObservable=new r.cP,this.onStateChangedObservable=new r.cP,this._sound=e}get state(){return this._state}dispose(){super.dispose(),this.stop(),this.onEndedObservable.clear(),this.onStateChangedObservable.clear()}_setState(e){this._state!==e&&(this._state=e,this.onStateChangedObservable.notifyObservers(this))}}},16066:(e,t,i)=>{i.r(t),i.d(t,{particlesPixelShader:()=>o});var r=i(69610);i(6194),i(89392),i(34581),i(73325),i(64017),i(7806),i(7412),i(29741),i(2360);const s="particlesPixelShader",n="#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nvarying vec2 vUV;varying vec4 vColor;uniform vec4 textureMask;uniform sampler2D diffuseSampler;\n#include<clipPlaneFragmentDeclaration>\n#include<imageProcessingDeclaration>\n#include<logDepthDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#ifdef RAMPGRADIENT\nvarying vec4 remapRanges;uniform sampler2D rampSampler;\n#endif\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec4 textureColor=texture2D(diffuseSampler,vUV);vec4 baseColor=(textureColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;\n#ifdef RAMPGRADIENT\nfloat alpha=baseColor.a;float remappedColorIndex=clamp((alpha-remapRanges.x)/remapRanges.y,0.0,1.0);vec4 rampColor=texture2D(rampSampler,vec2(1.0-remappedColorIndex,0.));baseColor.rgb*=rampColor.rgb;float finalAlpha=baseColor.a;baseColor.a=clamp((alpha*rampColor.a-remapRanges.z)/remapRanges.w,0.0,1.0);\n#endif\n#ifdef BLENDMULTIPLYMODE\nfloat sourceAlpha=vColor.a*textureColor.a;baseColor.rgb=baseColor.rgb*sourceAlpha+vec3(1.0)*(1.0-sourceAlpha);\n#endif\n#include<logDepthFragment>\n#include<fogFragment>(color,baseColor)\n#ifdef IMAGEPROCESSINGPOSTPROCESS\nbaseColor.rgb=toLinearSpace(baseColor.rgb);\n#else\n#ifdef IMAGEPROCESSING\nbaseColor.rgb=toLinearSpace(baseColor.rgb);baseColor=applyImageProcessing(baseColor);\n#endif\n#endif\ngl_FragColor=baseColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},16797:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphArrayIndexBlock:()=>l});var r=i(71294),s=i(4720),n=i(56552),o=i(90868),a=i(4686);class l extends r.e{constructor(e){super(e),this.config=e,this.array=this.registerDataInput("array",s.Vv),this.index=this.registerDataInput("index",s.Vv,new o.P(-1)),this.value=this.registerDataOutput("value",s.Vv)}_updateOutputs(e){const t=this.array.getValue(e),i=(0,a.$w)(this.index.getValue(e));t&&i>=0&&i<t.length?this.value.setValue(t[i],e):this.value.setValue(null,e)}serialize(e){super.serialize(e)}getClassName(){return"FlowGraphArrayIndexBlock"}}(0,n.Y5)("FlowGraphArrayIndexBlock",l)},16913:(e,t,i)=>{i.r(t),i.d(t,{layerVertexShaderWGSL:()=>n});const r="layerVertexShader",s="attribute position: vec2f;uniform scale: vec2f;uniform offset: vec2f;uniform textureMatrix: mat4x4f;varying vUV: vec2f;const madd: vec2f= vec2f(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar shiftedPosition: vec2f=input.position*uniforms.scale+uniforms.offset;vertexOutputs.vUV=(uniforms.textureMatrix* vec4f(shiftedPosition*madd+madd,1.0,0.0)).xy;vertexOutputs.position= vec4f(shiftedPosition,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},16990:(e,t,i)=>{i.r(t),i.d(t,{iblShadowVoxelTracingPixelShader:()=>n});const r="iblShadowVoxelTracingPixelShader",s="precision highp sampler2D;precision highp sampler3D;\n#define PI 3.1415927\nvarying vec2 vUV;\n#define DISABLE_UNIFORMITY_ANALYSIS\nuniform sampler2D depthSampler;uniform sampler2D worldNormalSampler;uniform sampler2D blueNoiseSampler;uniform sampler2D icdfSampler;uniform sampler3D voxelGridSampler;\n#ifdef COLOR_SHADOWS\nuniform samplerCube iblSampler;\n#endif\nuniform vec4 shadowParameters;\n#define SHADOWdirs shadowParameters.x\n#define SHADOWframe shadowParameters.y\n#define SHADOWenvRot shadowParameters.w\nuniform vec4 voxelBiasParameters;\n#define highestMipLevel voxelBiasParameters.z\nuniform vec4 sssParameters;\n#define SSSsamples sssParameters.x\n#define SSSstride sssParameters.y\n#define SSSmaxDistance sssParameters.z\n#define SSSthickness sssParameters.w\nuniform vec4 shadowOpacity;uniform mat4 projMtx;uniform mat4 viewMtx;uniform mat4 invProjMtx;uniform mat4 invViewMtx;uniform mat4 wsNormalizationMtx;uniform mat4 invVPMtx;\n#define PI 3.1415927\n#define GOLD 0.618034\nstruct AABB3f {vec3 m_min;vec3 m_max;};struct Ray {vec3 orig;vec3 dir;vec3 dir_rcp;float t_min;float t_max;};Ray make_ray(const vec3 origin,const vec3 direction,const float tmin,\nconst float tmax) {Ray ray;ray.orig=origin;ray.dir=direction;ray.dir_rcp=1.0f/direction;ray.t_min=tmin;ray.t_max=tmax;return ray;}\nbool ray_box_intersection(const in AABB3f aabb,const in Ray ray,\nout float distance_near,out float distance_far) {vec3 tbot=ray.dir_rcp*(aabb.m_min-ray.orig);vec3 ttop=ray.dir_rcp*(aabb.m_max-ray.orig);vec3 tmin=min(ttop,tbot);vec3 tmax=max(ttop,tbot);distance_near=max(ray.t_min,max(tmin.x,max(tmin.y,tmin.z)));distance_far=min(ray.t_max,min(tmax.x,min(tmax.y,tmax.z)));return distance_near<=distance_far;}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nstruct VoxelMarchDiagnosticInfo {float heat;ivec3 voxel_intersect_coords;};\n#endif\nuint hash(uint i) {i ^= i>>16u;i*=0x7FEB352Du;i ^= i>>15u;i*=0x846CA68Bu;i ^= i>>16u;return i;}\nfloat uint2float(uint i) {return uintBitsToFloat(0x3F800000u | (i>>9u))-1.0;}\nvec3 uv_to_normal(vec2 uv) {vec3 N;vec2 uvRange=uv;float theta=uvRange.x*2.0*PI;float phi=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}\nvec2 plasticSequence(const uint rstate) {return vec2(uint2float(rstate*3242174889u),\nuint2float(rstate*2447445414u));}\nfloat goldenSequence(const uint rstate) {return uint2float(rstate*2654435769u);}\nfloat distanceSquared(vec2 a,vec2 b) {vec2 diff=a-b;return dot(diff,diff);}\nvoid genTB(const vec3 N,out vec3 T,out vec3 B) {float s=N.z<0.0 ? -1.0 : 1.0;float a=-1.0/(s+N.z);float b=N.x*N.y*a;T=vec3(1.0+s*N.x*N.x*a,s*b,-s*N.x);B=vec3(b,s+N.y*N.y*a,-N.y);}\nint stack[24]; \n#define PUSH(i) stack[stackLevel++]=i; \n#define POP() stack[--stackLevel] \n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nbool anyHitVoxels(const Ray ray_vs,\nout VoxelMarchDiagnosticInfo voxel_march_diagnostic_info) {\n#else\nbool anyHitVoxels(const Ray ray_vs) {\n#endif\nvec3 invD=ray_vs.dir_rcp;vec3 D=ray_vs.dir;vec3 O=ray_vs.orig;ivec3 negD=ivec3(lessThan(D,vec3(0,0,0)));int voxel0=negD.x | negD.y<<1 | negD.z<<2;vec3 t0=-O*invD,t1=(vec3(1.0)-O)*invD;int maxLod=int(highestMipLevel);int stackLevel=0;\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nuint steps=0u;\n#endif\nPUSH(maxLod<<24);while (stackLevel>0) {int elem=POP();ivec4 Coords =\nivec4(elem & 0xFF,elem>>8 & 0xFF,elem>>16 & 0xFF,elem>>24);if (Coords.w==0) {\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nvoxel_march_diagnostic_info.heat=float(steps)/24.0;\n#endif\nreturn true;}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\n++steps;\n#endif\nfloat invRes=exp2(float(Coords.w-maxLod));vec3 bbmin=invRes*vec3(Coords.xyz+negD);vec3 bbmax=invRes*vec3(Coords.xyz-negD+ivec3(1));vec3 mint=mix(t0,t1,bbmin);vec3 maxt=mix(t0,t1,bbmax);vec3 midt=0.5*(mint+maxt);mint.x=max(0.0,mint.x);midt.x=max(0.0,midt.x);int nodeMask=int(\nround(texelFetch(voxelGridSampler,Coords.xyz,Coords.w).x*255.0));Coords.w--;int voxelBit=voxel0;Coords.xyz=(Coords.xyz<<1)+negD;int packedCoords =\nCoords.x | Coords.y<<8 | Coords.z<<16 | Coords.w<<24;if (max(mint.x,max(mint.y,mint.z))<min(midt.x,min(midt.y,midt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(mint.y,mint.z))<min(maxt.x,min(midt.y,midt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(midt.y,mint.z))<min(maxt.x,min(maxt.y,midt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(midt.y,mint.z))<min(midt.x,min(maxt.y,midt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x4;packedCoords ^= 0x10000;if (max(mint.x,max(midt.y,midt.z))<min(midt.x,min(maxt.y,maxt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(midt.y,midt.z))<min(maxt.x,min(maxt.y,maxt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(mint.y,midt.z))<min(maxt.x,min(midt.y,maxt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(mint.y,midt.z))<min(midt.x,min(midt.y,maxt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nvoxel_march_diagnostic_info.heat=float(steps)/24.0;\n#endif\nreturn false;}\nfloat linearizeDepth(float depth,float near,float far) {return (near*far)/(far-depth*(far-near));}\nfloat screenSpaceShadow(vec3 csOrigin,vec3 csDirection,vec2 csZBufferSize,\nfloat nearPlaneZ,float farPlaneZ,float noise) {\n#ifdef RIGHT_HANDED\nfloat csZDir=-1.0;\n#else \nfloat csZDir=1.0;\n#endif\nfloat ssSamples=SSSsamples;float ssMaxDist=SSSmaxDistance;float ssStride=SSSstride;float ssThickness=SSSthickness;float rayLength =\ncsZDir*(csOrigin.z+ssMaxDist*csDirection.z)<csZDir*nearPlaneZ\n? \n(nearPlaneZ-csOrigin.z)/csDirection.z\n: ssMaxDist;vec3 csEndPoint=csOrigin+rayLength*csDirection;vec4 H0=projMtx*vec4(csOrigin,1.0);vec4 H1=projMtx*vec4(csEndPoint,1.0);vec2 Z0=vec2(csOrigin.z ,1.0)/H0.w;vec2 Z1=vec2(csEndPoint.z,1.0)/H1.w;vec2 P0=csZBufferSize*(0.5*H0.xy*Z0.y+0.5);vec2 P1=csZBufferSize*(0.5*H1.xy*Z1.y+0.5);P1+=vec2(distanceSquared(P0,P1)<0.0001 ? 0.01 : 0.0);vec2 delta=P1-P0;bool permute=false;if (abs(delta.x)<abs(delta.y)) {permute=true;P0=P0.yx;P1=P1.yx;delta=delta.yx;}\nfloat stepDirection=sign(delta.x);float invdx=stepDirection/delta.x;vec2 dP=ssStride*vec2(stepDirection,invdx*delta.y);vec2 dZ=ssStride*invdx*(Z1-Z0);float opacity=0.0;vec2 P=P0+noise*dP;vec2 Z=Z0+noise*dZ;float end=P1.x*stepDirection;float rayZMax=csZDir*Z.x/Z.y;float sceneDepth=rayZMax;Z+=dZ;for (float stepCount=0.0;opacity<1.0 && P.x*stepDirection<end && sceneDepth>0.0 && stepCount<ssSamples;stepCount++,P+=dP,\nZ+=dZ) { \nivec2 coords=ivec2(permute ? P.yx : P);sceneDepth=texelFetch(depthSampler,coords,0).x;sceneDepth=linearizeDepth(sceneDepth,nearPlaneZ,farPlaneZ);sceneDepth=csZDir*sceneDepth;if (sceneDepth<=0.0) {break;}\nfloat rayZMin=rayZMax;rayZMax=csZDir*Z.x/Z.y;opacity+=max(opacity,step(rayZMax,sceneDepth+ssThickness)*step(sceneDepth,rayZMin));}\nreturn opacity;}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nfloat voxelShadow(vec3 wsOrigin,vec3 wsDirection,vec3 wsNormal,\nvec2 DitherNoise,\nout VoxelMarchDiagnosticInfo voxel_march_diagnostic_info) {\n#else\nfloat voxelShadow(vec3 wsOrigin,vec3 wsDirection,vec3 wsNormal,\nvec2 DitherNoise) {\n#endif\nfloat vxResolution=float(textureSize(voxelGridSampler,0).x);vec3 T,B;genTB(wsDirection,T,B);vec2 DitherXY=sqrt(DitherNoise.x)*vec2(cos(2.0*PI*DitherNoise.y),\nsin(2.0*PI*DitherNoise.y));float sceneScale=wsNormalizationMtx[0][0];vec3 Dithering =\n(voxelBiasParameters.x*wsNormal+voxelBiasParameters.y*wsDirection +\nDitherXY.x*T+DitherXY.y*B) /\nvxResolution;vec3 O=0.5*wsOrigin+0.5+Dithering;Ray ray_vs=make_ray(O,wsDirection,0.0,10.0);AABB3f voxel_aabb;voxel_aabb.m_min=vec3(0);voxel_aabb.m_max=vec3(1);float near,far;if (!ray_box_intersection(voxel_aabb,ray_vs,near,far))\nreturn 0.0;ray_vs.t_min=max(ray_vs.t_min,near);ray_vs.t_max=min(ray_vs.t_max,far);\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nreturn anyHitVoxels(ray_vs,voxel_march_diagnostic_info) ? 1.0f : 0.0f;\n#else\nreturn anyHitVoxels(ray_vs) ? 1.0f : 0.0f;\n#endif\n}\nvoid main(void) {uint nbDirs=uint(SHADOWdirs);uint frameId=uint(SHADOWframe);float envRot=SHADOWenvRot;vec2 Resolution=vec2(textureSize(depthSampler,0));ivec2 currentPixel=ivec2(vUV*Resolution);uint GlobalIndex=(frameId*uint(Resolution.y)+uint(currentPixel.y)) *\nuint(Resolution.x) +\nuint(currentPixel.x);vec3 N=texelFetch(worldNormalSampler,currentPixel,0).xyz;if (length(N)<0.01) {glFragColor=vec4(1.0,1.0,0.0,1.0);return;}\nfloat normalizedRotation=envRot/(2.0*PI);float depth=texelFetch(depthSampler,currentPixel,0).x;\n#ifndef IS_NDC_HALF_ZRANGE\ndepth=depth*2.0-1.0;\n#endif\nvec2 temp=(vec2(currentPixel)+vec2(0.5))*2.0/Resolution-vec2(1.0);vec4 VP=invProjMtx*vec4(temp.x,-temp.y,depth,1.0);VP/=VP.w;N=normalize(N);vec3 noise=texelFetch(blueNoiseSampler,currentPixel & 0xFF,0).xyz;noise.z=fract(noise.z+goldenSequence(frameId*nbDirs));\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nfloat heat=0.0f;\n#endif\nfloat shadowAccum=0.001;float specShadowAccum=0.001;float sampleWeight=0.001;\n#ifdef COLOR_SHADOWS\nvec3 totalLight=vec3(0.001);vec3 shadowedLight=vec3(0.0);\n#endif\nfor (uint i=0u; i<nbDirs; i++) {uint dirId=nbDirs*GlobalIndex+i;vec4 L;vec2 T;{vec2 r=plasticSequence(frameId*nbDirs+i);r=fract(r+vec2(2.0)*abs(noise.xy-vec2(0.5)));T.x=textureLod(icdfSampler,vec2(r.x,0.0),0.0).x;T.y=textureLod(icdfSampler,vec2(T.x,r.y),0.0).y;L=vec4(uv_to_normal(vec2(T.x-normalizedRotation,T.y)),0);\n#ifndef RIGHT_HANDED\nL.z*=-1.0;\n#endif\n}\n#ifdef COLOR_SHADOWS\nvec3 lightDir=uv_to_normal(vec2(1.0-fract(T.x+0.25),T.y));vec3 ibl=textureLod(iblSampler,lightDir,0.0).xyz;float pdf=textureLod(icdfSampler,T,0.0).z;\n#endif\nfloat cosNL=dot(N,L.xyz);float opacity=0.0;if (cosNL>0.0) {vec4 VP2=VP;VP2.y*=-1.0;vec4 unormWP=invViewMtx*VP2;vec3 WP=(wsNormalizationMtx*unormWP).xyz;vec2 vxNoise=vec2(uint2float(hash(dirId*2u)),uint2float(hash(dirId*2u+1u)));\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nVoxelMarchDiagnosticInfo voxel_march_diagnostic_info;opacity=max(opacity,shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise,voxel_march_diagnostic_info));heat+=voxel_march_diagnostic_info.heat;\n#else\nopacity =\nmax(opacity,shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise));\n#endif\nvec3 VL=(viewMtx*L).xyz;\n#ifdef RIGHT_HANDED\nfloat nearPlaneZ=-projMtx[3][2]/(projMtx[2][2]-1.0); \nfloat farPlaneZ=-projMtx[3][2]/(projMtx[2][2]+1.0);\n#else\nfloat nearPlaneZ=-projMtx[3][2]/(projMtx[2][2]+1.0); \nfloat farPlaneZ=-projMtx[3][2]/(projMtx[2][2]-1.0);\n#endif\nfloat ssShadow=shadowOpacity.y *\nscreenSpaceShadow(VP2.xyz,VL,Resolution,nearPlaneZ,farPlaneZ,\nabs(2.0*noise.z-1.0));opacity=max(opacity,ssShadow);\n#ifdef COLOR_SHADOWS\nvec3 light=pdf<1e-6 ? vec3(0.0) : vec3(cosNL)/vec3(pdf)*ibl;shadowedLight+=light*opacity;totalLight+=light;\n#else\nfloat rcos=(1.0-cosNL);shadowAccum+=(1.0-opacity*(1.0-pow(rcos,8.0)));sampleWeight+=1.0;vec3 VR=-(viewMtx*vec4(reflect(-L.xyz,N),0.0)).xyz;specShadowAccum+=max(1.0-(opacity*pow(VR.z,8.0)),0.0);\n#endif\n}\nnoise.z=fract(noise.z+GOLD);}\n#ifdef COLOR_SHADOWS\nvec3 shadow=(totalLight-shadowedLight)/totalLight;float maxShadow=max(max(shadow.x,max(shadow.y,shadow.z)),1.0);glFragColor=vec4(shadow/maxShadow,1.0);\n#else\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\ngl_FragColor=vec4(shadowAccum/float(sampleWeight),\nspecShadowAccum/float(sampleWeight),heat/float(sampleWeight),1.0);\n#else\ngl_FragColor=vec4(shadowAccum/float(sampleWeight),specShadowAccum/float(sampleWeight),0.0,1.0);\n#endif\n#endif\n}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},17136:(e,t,i)=>{i.r(t),i.d(t,{_ENVTextureLoader:()=>s});var r=i(55234);class s{constructor(){this.supportCascades=!1}loadCubeData(e,t,i,s,n){if(Array.isArray(e))return;const o=(0,r.cU)(e);if(o){t.width=o.width,t.height=o.width;try{(0,r.ow)(t,o),(0,r.o5)(t,e,o).then((()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()}),(e=>{n?.("Can not upload environment levels",e)}))}catch(e){n?.("Can not upload environment file",e)}}else n&&n("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}},17156:(e,t,i)=>{i.r(t),i.d(t,{proceduralVertexShader:()=>n});const r="proceduralVertexShader",s="attribute vec2 position;varying vec2 vPosition;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvPosition=position;vUV=position*madd+madd;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},17301:(e,t,i)=>{i.r(t),i.d(t,{TransformFeedbackBoundingHelper:()=>d});var r=i(95616),s=i(80467),n=i(71139),o=i(79923),a=i(69610);i(69707),i(18959),i(27999),i(90738),i(48451),i(15060),i(3361),i(65523);const l="gpuTransformVertexShader",h="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\nout vec3 outPosition;const mat4 identity=mat4(\nvec4(1.0,0.0,0.0,0.0),\nvec4(0.0,1.0,0.0,0.0),\nvec4(0.0,0.0,1.0,0.0),\nvec4(0.0,0.0,0.0,1.0)\n);void main(void) {vec3 positionUpdated=position;\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\nmat4 finalWorld=identity;\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);outPosition=worldPos.xyz;}";a.l.ShadersStore[l]=h;const c="gpuTransformPixelShader",u="#version 300 es\nvoid main() {discard;}\n";a.l.ShadersStore[c]=u;class d{constructor(e){this._buffers={},this._effects={},this._meshListCounter=0,this._engine=e}processAsync(e){return Array.isArray(e)||(e=[e]),this._meshListCounter=0,this._processMeshList(e),Promise.resolve()}_processMeshList(e){const t=this._engine.getCaps().parallelShaderCompile;this._engine.getCaps().parallelShaderCompile=void 0;for(let t=0;t<e.length;++t){const i=e[t];if(0===i.getTotalVertices()||!i.getVertexBuffer||!i.getVertexBuffer(r.R.PositionKind))continue;let n;const o=[],a=[r.R.PositionKind];i&&i.useBones&&i.computeBonesUsingShaders&&i.skeleton?(a.push(r.R.MatricesIndicesKind),a.push(r.R.MatricesWeightsKind),i.numBoneInfluencers>4&&(a.push(r.R.MatricesIndicesExtraKind),a.push(r.R.MatricesWeightsExtraKind)),o.push("#define NUM_BONE_INFLUENCERS "+i.numBoneInfluencers),o.push("#define BONETEXTURE "+i.skeleton.isUsingTextureForMatrices),o.push("#define BonesPerMesh "+(i.skeleton.bones.length+1))):o.push("#define NUM_BONE_INFLUENCERS 0");const l=i.morphTargetManager?(0,s.Dk)(i.morphTargetManager,o,a,i,!0,!1,!1,!1,!1,!1):0,h=i.bakedVertexAnimationManager;h&&h.isEnabled&&(o.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),(0,s.J2)(a,i,o));const c=o.join("\n");if(this._effects[c])n=this._effects[c];else{const e={attributes:a,uniformsNames:["boneTextureWidth","mBones","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime"],uniformBuffersNames:[],samplers:["boneSampler","morphTargets","bakedVertexAnimationTexture"],defines:c,fallbacks:null,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:l},maxSimultaneousLights:0,transformFeedbackVaryings:["outPosition"]};n=this._engine.createEffect("gpuTransform",e,this._engine),this._effects[c]=n}this._compute(i,n)}this._engine.getCaps().parallelShaderCompile=t}_compute(e,t){const i=this._engine;let o;const a=e.getTotalVertices();if(this._buffers[e.uniqueId])o=this._buffers[e.uniqueId];else{const t=new Float32Array(3*a);o=new r.h(e.getEngine(),t,!0,3),this._buffers[e.uniqueId]=o}t.getEngine().enableEffect(t),e._bindDirect(t,null,!0),(0,s.f$)(e,t),(0,s.nR)(e,t),e.morphTargetManager&&e.morphTargetManager.isUsingTextureForTargets&&e.morphTargetManager._bind(t);const l=e.bakedVertexAnimationManager;l&&l.isEnabled&&e.bakedVertexAnimationManager?.bind(t,!1);const h=o.getData();if(i.bindTransformFeedbackBuffer(o.getBuffer()),i.setRasterizerState(!1),i.beginTransformFeedback(!0),i.drawArraysType(2,0,a),i.endTransformFeedback(),i.setRasterizerState(!0),i.readTransformFeedbackBuffer(h),i.bindTransformFeedbackBuffer(null),0===this._meshListCounter)e._refreshBoundingInfo(h,null);else{const t=e.getBoundingInfo().boundingBox,i=(0,n.b8)(h,0,a);d._Min.copyFrom(t.minimum).minimizeInPlace(i.minimum),d._Max.copyFrom(t.maximum).maximizeInPlace(i.maximum),e._refreshBoundingInfoDirect({minimum:d._Min,maximum:d._Max})}}registerMeshListAsync(e){return Array.isArray(e)||(e=[e]),this._meshList=e,this._meshListCounter=0,Promise.resolve()}processMeshList(){0!==this._meshList.length&&(this._processMeshList(this._meshList),this._meshListCounter++)}fetchResultsForMeshListAsync(){return this._meshListCounter=0,Promise.resolve()}dispose(){for(const e in this._buffers)this._buffers[e].dispose();this._buffers={},this._effects={},this._engine=null}}d._Min=new o.Pq,d._Max=new o.Pq},17382:(e,t,i)=>{const r="kernelBlurVaryingDeclaration",s="varying vec2 sampleCoord{X};";i(69610).l.IncludesShadersStore[r]=s},17399:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphBooleanToFloat:()=>a,FlowGraphBooleanToInt:()=>l,FlowGraphFloatToBoolean:()=>h,FlowGraphFloatToInt:()=>d,FlowGraphIntToBoolean:()=>c,FlowGraphIntToFloat:()=>u});var r=i(63318),s=i(4720),n=i(56552),o=i(90868);class a extends r.a{constructor(e){super(s.RI,s.Es,(e=>+e),"FlowGraphBooleanToFloat",e)}}(0,n.Y5)("FlowGraphBooleanToFloat",a);class l extends r.a{constructor(e){super(s.RI,s.x2,(e=>o.P.FromValue(+e)),"FlowGraphBooleanToInt",e)}}(0,n.Y5)("FlowGraphBooleanToInt",l);class h extends r.a{constructor(e){super(s.Es,s.RI,(e=>!!e),"FlowGraphFloatToBoolean",e)}}(0,n.Y5)("FlowGraphFloatToBoolean",h);class c extends r.a{constructor(e){super(s.x2,s.RI,(e=>!!e.value),"FlowGraphIntToBoolean",e)}}(0,n.Y5)("FlowGraphIntToBoolean",c);class u extends r.a{constructor(e){super(s.x2,s.Es,(e=>e.value),"FlowGraphIntToFloat",e)}}(0,n.Y5)("FlowGraphIntToFloat",u);class d extends r.a{constructor(e){super(s.Es,s.x2,(t=>{const i=e?.roundingMode;switch(i){case"floor":return o.P.FromValue(Math.floor(t));case"ceil":return o.P.FromValue(Math.ceil(t));case"round":return o.P.FromValue(Math.round(t));default:return o.P.FromValue(t)}}),"FlowGraphFloatToInt",e)}}(0,n.Y5)("FlowGraphFloatToInt",d)},17406:(e,t,i)=>{i.r(t),i.d(t,{screenSpaceReflection2BlurCombinerPixelShader:()=>o});var r=i(69610);i(73325),i(8709),i(69363);const s="screenSpaceReflection2BlurCombinerPixelShader",n="uniform sampler2D textureSampler; \nuniform sampler2D mainSampler;uniform sampler2D reflectivitySampler;uniform float strength;uniform float reflectionSpecularFalloffExponent;uniform float reflectivityThreshold;varying vec2 vUV;\n#include<helperFunctions>\n#ifdef SSR_BLEND_WITH_FRESNEL\n#include<pbrBRDFFunctions>\n#include<screenSpaceRayTrace>\nuniform mat4 projection;uniform mat4 invProjectionMatrix;\n#ifdef SSR_NORMAL_IS_IN_WORLDSPACE\nuniform mat4 view;\n#endif\nuniform sampler2D normalSampler;uniform sampler2D depthSampler;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nuniform float nearPlaneZ;uniform float farPlaneZ;\n#endif\n#endif\nvoid main()\n{\n#ifdef SSRAYTRACE_DEBUG\ngl_FragColor=texture2D(textureSampler,vUV);\n#else\nvec3 SSR=texture2D(textureSampler,vUV).rgb;vec4 color=texture2D(mainSampler,vUV);vec4 reflectivity=texture2D(reflectivitySampler,vUV);\n#ifndef SSR_DISABLE_REFLECTIVITY_TEST\nif (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=reflectivityThreshold) {gl_FragColor=color;return;}\n#endif\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\ncolor=toLinearSpace(color);\n#endif\n#ifdef SSR_BLEND_WITH_FRESNEL\nvec2 texSize=vec2(textureSize(depthSampler,0));vec3 csNormal=texelFetch(normalSampler,ivec2(vUV*texSize),0).xyz;\n#ifdef SSR_DECODE_NORMAL\ncsNormal=csNormal*2.0-1.0;\n#endif\n#ifdef SSR_NORMAL_IS_IN_WORLDSPACE\ncsNormal=(view*vec4(csNormal,0.0)).xyz;\n#endif\nfloat depth=texelFetch(depthSampler,ivec2(vUV*texSize),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\ndepth=linearizeDepth(depth,nearPlaneZ,farPlaneZ);\n#endif\nvec3 csPosition=computeViewPosFromUVDepth(vUV,depth,projection,invProjectionMatrix);vec3 csViewDirection=normalize(csPosition);vec3 F0=reflectivity.rgb;vec3 fresnel=fresnelSchlickGGX(max(dot(csNormal,-csViewDirection),0.0),F0,vec3(1.));vec3 reflectionMultiplier=clamp(pow(fresnel*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#else\nvec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#endif\nvec3 colorMultiplier=1.0-reflectionMultiplier;vec3 finalColor=(color.rgb*colorMultiplier)+(SSR*reflectionMultiplier);\n#ifdef SSR_OUTPUT_IS_GAMMA_SPACE\nfinalColor=toGammaSpace(finalColor);\n#endif\ngl_FragColor=vec4(finalColor,color.a);\n#endif\n}\n";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},17537:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelGrid2dArrayDebugPixelShaderWGSL:()=>n});const r="iblVoxelGrid2dArrayDebugPixelShader",s="varying vUV: vec2f;var voxelTextureSampler: sampler;var voxelTexture: texture_3d<f32>;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform slice: i32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var size: vec3u=textureDimensions(voxelTexture,0);var dimension: f32=sqrt( f32(size.z));var samplePos: vec2f=fract(input.vUV.xy* vec2f(dimension));var sampleIndex: u32= u32(floor(input.vUV.x* f32(dimension))+floor(input.vUV.y* f32(dimension))*dimension);var color=textureSample(voxelTexture,voxelTextureSampler, vec3f(samplePos.xy,sampleIndex)).rrr;color+=textureSample(textureSampler,textureSamplerSampler,input.vUV.xy).rgb;fragmentOutputs.color=vec4f(color,1.0);}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},17770:(e,t,i)=>{i.r(t),i.d(t,{copyTextureToTexturePixelShaderWGSL:()=>o});var r=i(69610);i(79702);const s="copyTextureToTexturePixelShader",n="uniform conversion: f32;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;varying vUV: vec2f;\n#include<helperFunctions>\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var color: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);\n#ifdef DEPTH_TEXTURE\nfragmentOutputs.fragDepth=color.r;\n#else\nif (uniforms.conversion==1.) {color=toLinearSpaceVec4(color);} else if (uniforms.conversion==2.) {color=toGammaSpace(color);}\nfragmentOutputs.color=color;\n#endif\n}\n";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},17985:(e,t,i)=>{i.r(t),i.d(t,{tonemapPixelShader:()=>n});const r="tonemapPixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;uniform float _ExposureAdjustment;\n#if defined(HABLE_TONEMAPPING)\nconst float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;const float W=11.2;\n#endif\nfloat Luminance(vec3 c)\n{return dot(c,vec3(0.22,0.707,0.071));}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec3 colour=texture2D(textureSampler,vUV).rgb;\n#if defined(REINHARD_TONEMAPPING)\nfloat lum=Luminance(colour.rgb); \nfloat lumTm=lum*_ExposureAdjustment;float scale=lumTm/(1.0+lumTm); \ncolour*=scale/lum;\n#elif defined(HABLE_TONEMAPPING)\ncolour*=_ExposureAdjustment;const float ExposureBias=2.0;vec3 x=ExposureBias*colour;vec3 curr=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;x=vec3(W,W,W);vec3 whiteScale=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);colour=curr*whiteScale;\n#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)\ncolour*=_ExposureAdjustment;vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;\n#elif defined(PHOTOGRAPHIC_TONEMAPPING)\ncolour= vec3(1.0,1.0,1.0)-exp2(-_ExposureAdjustment*colour);\n#endif\ngl_FragColor=vec4(colour.rgb,1.0);}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},18162:(e,t,i)=>{i.r(t),i.d(t,{iblCombineVoxelGridsPixelShader:()=>n});const r="iblCombineVoxelGridsPixelShader",s="precision highp float;precision highp sampler3D;varying vec2 vUV;uniform sampler3D voxelXaxisSampler;uniform sampler3D voxelYaxisSampler;uniform sampler3D voxelZaxisSampler;uniform float layer;void main(void) {vec3 coordZ=vec3(vUV.x,vUV.y,layer);float voxelZ=texture(voxelZaxisSampler,coordZ).r;vec3 coordX=vec3(1.0-layer,vUV.y,vUV.x);float voxelX=texture(voxelXaxisSampler,coordX).r;vec3 coordY=vec3(layer,vUV.x,vUV.y);float voxelY=texture(voxelYaxisSampler,coordY).r;float voxel=(voxelX>0.0 || voxelY>0.0 || voxelZ>0.0) ? 1.0 : 0.0;glFragColor=vec4(vec3(voxel),1.0);}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},18507:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererFinaliserVertexShader:()=>n});const r="meshUVSpaceRendererFinaliserVertexShader",s="precision highp float;attribute vec3 position;attribute vec2 uv;uniform mat4 worldViewProjection;varying vec2 vUV;void main() {gl_Position=worldViewProjection*vec4(position,1.0);vUV=uv;}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},18516:(e,t,i)=>{i.r(t),i.d(t,{bilateralBlurPixelShader:()=>n});const r="bilateralBlurPixelShader",s="uniform sampler2D textureSampler;uniform sampler2D depthSampler;uniform sampler2D normalSampler;uniform int filterSize;uniform vec2 blurDir;uniform float depthThreshold;uniform float normalThreshold;varying vec2 vUV;void main(void) {vec3 color=textureLod(textureSampler,vUV,0.).rgb;float depth=textureLod(depthSampler,vUV,0.).x;if (depth>=1e6 || depth<=0.) {glFragColor=vec4(color,1.);return;}\nvec3 normal=textureLod(normalSampler,vUV,0.).rgb;\n#ifdef DECODE_NORMAL\nnormal=normal*2.0-1.0;\n#endif\nfloat sigma=float(filterSize);float two_sigma2=2.0*sigma*sigma;float sigmaDepth=depthThreshold;float two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;float sigmaNormal=normalThreshold;float two_sigmaNormal2=2.0*sigmaNormal*sigmaNormal;vec3 sum=vec3(0.);float wsum=0.;for (int x=-filterSize; x<=filterSize; ++x) {vec2 coords=vec2(x);vec3 sampleColor=textureLod(textureSampler,vUV+coords*blurDir,0.).rgb;float sampleDepth=textureLod(depthSampler,vUV+coords*blurDir,0.).r;vec3 sampleNormal=textureLod(normalSampler,vUV+coords*blurDir,0.).rgb;\n#ifdef DECODE_NORMAL\nsampleNormal=sampleNormal*2.0-1.0;\n#endif\nfloat r=dot(coords,coords);float w=exp(-r/two_sigma2);float depthDelta=abs(sampleDepth-depth);float wd=step(depthDelta,depthThreshold);vec3 normalDelta=abs(sampleNormal-normal);float wn=step(normalDelta.x+normalDelta.y+normalDelta.z,normalThreshold);sum+=sampleColor*w*wd*wn;wsum+=w*wd*wn;}\nglFragColor=vec4(sum/wsum,1.);}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},18900:(e,t,i)=>{i.r(t),i.d(t,{iblCdfxPixelShaderWGSL:()=>n});const r="iblCdfxPixelShader",s="#define PI 3.1415927\nvarying vUV: vec2f;var cdfy: texture_2d<f32>;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var cdfyRes=textureDimensions(cdfy,0);var currentPixel=vec2u(fragmentInputs.position.xy);var cdfx: f32=0.0;for (var x: u32=1; x<=currentPixel.x; x++) {cdfx+=textureLoad(cdfy, vec2u(x-1,cdfyRes.y-1),0).x;}\nfragmentOutputs.color= vec4f( vec3f(cdfx),1.0);}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},18961:(e,t,i)=>{i.r(t),i.d(t,{hdrIrradianceFilteringPixelShader:()=>o});var r=i(69610);i(73325),i(21469),i(8709),i(78741);const s="hdrIrradianceFilteringPixelShader",n="#include<helperFunctions>\n#include<importanceSampling>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\nuniform samplerCube inputTexture;\n#ifdef IBL_CDF_FILTERING\nuniform sampler2D icdfTexture;\n#endif\nuniform vec2 vFilteringInfo;uniform float hdrScale;varying vec3 direction;void main() {vec3 color=irradiance(inputTexture,direction,vFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfTexture\n#endif\n);gl_FragColor=vec4(color*hdrScale,1.0);}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},19015:(e,t,i)=>{i.r(t),i.d(t,{oitFinalPixelShader:()=>n});const r="oitFinalPixelShader",s="precision highp float;uniform sampler2D uFrontColor;uniform sampler2D uBackColor;void main() {ivec2 fragCoord=ivec2(gl_FragCoord.xy);vec4 frontColor=texelFetch(uFrontColor,fragCoord,0);vec4 backColor=texelFetch(uBackColor,fragCoord,0);float alphaMultiplier=1.0-frontColor.a;glFragColor=vec4(\nfrontColor.rgb+alphaMultiplier*backColor.rgb,\nfrontColor.a+backColor.a\n);}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},19073:(e,t,i)=>{i.r(t),i.d(t,{glowMapGenerationPixelShaderWGSL:()=>o});var r=i(69610);i(79702),i(39759),i(97715);const s="glowMapGenerationPixelShader",n="#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)\n#include<helperFunctions>\n#endif\n#ifdef DIFFUSE\nvarying vUVDiffuse: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#ifdef OPACITY\nvarying vUVOpacity: vec2f;var opacitySamplerSampler: sampler;var opacitySampler: texture_2d<f32>;uniform opacityIntensity: f32;\n#endif\n#ifdef EMISSIVE\nvarying vUVEmissive: vec2f;var emissiveSamplerSampler: sampler;var emissiveSampler: texture_2d<f32>;\n#endif\n#ifdef VERTEXALPHA\nvarying vColor: vec4f;\n#endif\nuniform glowColor: vec4f;uniform glowIntensity: f32;\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#include<clipPlaneFragment>\nvar finalColor: vec4f=uniforms.glowColor;\n#ifdef DIFFUSE\nvar albedoTexture: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vUVDiffuse);\n#ifdef DIFFUSE_ISLINEAR\nalbedoTexture=toGammaSpace(albedoTexture);\n#endif\n#ifdef GLOW\nfinalColor=vec4f(finalColor.rgb,finalColor.a*albedoTexture.a);\n#endif\n#ifdef HIGHLIGHT\nfinalColor=vec4f(finalColor.rgb,albedoTexture.a);\n#endif\n#endif\n#ifdef OPACITY\nvar opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vUVOpacity);\n#ifdef OPACITYRGB\nfinalColor=vec4f(finalColor.rgb,finalColor.a*getLuminance(opacityMap.rgb));\n#else\nfinalColor=vec4f(finalColor.rgb,finalColor.a*opacityMap.a);\n#endif\nfinalColor=vec4f(finalColor.rgb,finalColor.a*uniforms.opacityIntensity);\n#endif\n#ifdef VERTEXALPHA\nfinalColor=vec4f(finalColor.rgb,finalColor.a*fragmentInputs.vColor.a);\n#endif\n#ifdef ALPHATEST\nif (finalColor.a<ALPHATESTVALUE) {discard;}\n#endif\n#ifdef EMISSIVE\nvar emissive: vec4f=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vUVEmissive);\n#ifdef EMISSIVE_ISLINEAR\nemissive=toGammaSpace(emissive);\n#endif\nfragmentOutputs.color=emissive*finalColor*uniforms.glowIntensity;\n#else\nfragmentOutputs.color=finalColor*uniforms.glowIntensity;\n#endif\n#ifdef HIGHLIGHT\nfragmentOutputs.color=vec4f(fragmentOutputs.color.rgb,uniforms.glowColor.a);\n#endif\n}\n";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},19145:(e,t,i)=>{i.r(t),i.d(t,{greasedLinePixelShaderWGSL:()=>n});const r="greasedLinePixelShader",s="var grlColors: texture_2d<f32>;var grlColorsSampler: sampler;uniform grlUseColors: f32;uniform grlUseDash: f32;uniform grlDashArray: f32;uniform grlDashOffset: f32;uniform grlDashRatio: f32;uniform grlVisibility: f32;uniform grlColorsWidth: f32;uniform grl_colorModeAndColorDistributionType: vec2f;uniform grlColor: vec3f;varying grlCounters: f32;varying grlColorPointer: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nlet grlColorMode: f32=uniforms.grl_colorModeAndColorDistributionType.x;let grlColorDistributionType: f32=uniforms.grl_colorModeAndColorDistributionType.y;var outColor=vec4(uniforms.grlColor,1.);outColor.a=step(fragmentInputs.grlCounters,uniforms.grlVisibility);if (outColor.a==0.0) {discard;}\nif (uniforms.grlUseDash==1.0) {let dashPosition=(fragmentInputs.grlCounters+uniforms.grlDashOffset) % uniforms.grlDashArray;outColor.a*=ceil(dashPosition-(uniforms.grlDashArray*uniforms.grlDashRatio));if (outColor.a==0.0) {discard;}}\nif (uniforms.grlUseColors==1.) {\n#ifdef GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE\nlet grlColor: vec4f=textureSample(grlColors,grlColorsSampler,vec2f(fragmentInputs.grlCounters,0.));\n#else\nlet lookup: vec2f=vec2(fract(fragmentInputs.grlColorPointer/uniforms.grlColorsWidth),1.0-floor(fragmentInputs.grlColorPointer/uniforms.grlColorsWidth));let grlColor: vec4f=textureSample(grlColors,grlColorsSampler,lookup);\n#endif\nif (grlColorMode==COLOR_MODE_SET) {outColor=grlColor;} else if (grlColorMode==COLOR_MODE_ADD) {outColor+=grlColor;} else if (grlColorMode==COLOR_MODE_MULTIPLY) {outColor*=grlColor;}}\n#if !defined(PREPASS) && !defined(ORDER_INDEPENDENT_TRANSPARENCY)\nfragmentOutputs.color=outColor;\n#endif\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {fragmentOutputs.frontColor=vec4f(fragmentOutputs.frontColor.rgb+outColor.rgb*outColor.a*alphaMultiplier,1.0-alphaMultiplier*(1.0-outColor.a));} else {fragmentOutputs.backColor+=outColor;}\n#endif\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},19181:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphCrossBlock:()=>p,FlowGraphDotBlock:()=>d,FlowGraphLengthBlock:()=>c,FlowGraphNormalizeBlock:()=>u,FlowGraphRotate2DBlock:()=>m,FlowGraphRotate3DBlock:()=>f,FlowGraphTransformBlock:()=>g,FlowGraphTransformCoordinatesBlock:()=>x});var r=i(4720),s=i(56552),n=i(77467),o=i(63318),a=i(79923),l=i(70210),h=i(4686);class c extends o.a{constructor(e){super(r.Vv,r.Es,(e=>this._polymorphicLength(e)),"FlowGraphLengthBlock",e)}_polymorphicLength(e){switch((0,h.sN)(e)){case"Vector2":case"Vector3":case"Vector4":return e.length();default:throw new Error(`Cannot compute length of value ${e}`)}}}(0,s.Y5)("FlowGraphLengthBlock",c);class u extends o.a{constructor(e){super(r.Vv,r.Vv,(e=>this._polymorphicNormalize(e)),"FlowGraphNormalizeBlock",e)}_polymorphicNormalize(e){let t;switch((0,h.sN)(e)){case"Vector2":case"Vector3":case"Vector4":if(t=e.normalizeToNew(),this.config?.nanOnZeroLength){0===e.length()&&t.setAll(NaN)}return t;default:throw new Error(`Cannot normalize value ${e}`)}}}(0,s.Y5)("FlowGraphNormalizeBlock",u);class d extends n.W{constructor(e){super(r.Vv,r.Vv,r.Es,((e,t)=>this._polymorphicDot(e,t)),"FlowGraphDotBlock",e)}_polymorphicDot(e,t){switch((0,h.sN)(e)){case"Vector2":case"Vector3":case"Vector4":return e.dot(t);default:throw new Error(`Cannot get dot product of ${e} and ${t}`)}}}(0,s.Y5)("FlowGraphDotBlock",d);class p extends n.W{constructor(e){super(r.Dx,r.Dx,r.Dx,((e,t)=>a.Pq.Cross(e,t)),"FlowGraphCrossBlock",e)}}(0,s.Y5)("FlowGraphCrossBlock",p);class m extends n.W{constructor(e){super(r.K$,r.Es,r.K$,((e,t)=>a.I9.Transform(e,a.uq.RotationZ(t))),"FlowGraphRotate2DBlock",e)}}(0,s.Y5)("FlowGraphRotate2DBlock",m);class f extends l.q{constructor(e){super(r.Dx,r.Dx,r.Es,r.Dx,((e,t,i)=>a.Pq.TransformCoordinates(e,a.uq.RotationAxis(t,i))),"FlowGraphRotate3DBlock",e)}}function _(e,t){switch((0,h.sN)(e)){case"Vector2":case"Vector3":return t.transformVector(e);case"Vector4":return new a.IU(e.x*t.m[0]+e.y*t.m[1]+e.z*t.m[2]+e.w*t.m[3],e.x*t.m[4]+e.y*t.m[5]+e.z*t.m[6]+e.w*t.m[7],e.x*t.m[8]+e.y*t.m[9]+e.z*t.m[10]+e.w*t.m[11],e.x*t.m[12]+e.y*t.m[13]+e.z*t.m[14]+e.w*t.m[15]);default:throw new Error(`Cannot transform value ${e}`)}}(0,s.Y5)("FlowGraphRotate3DBlock",f);class g extends n.W{constructor(e){const t=e?.vectorType||"Vector3",i="Vector2"===t?"Matrix2D":"Vector3"===t?"Matrix3D":"Matrix";super((0,r.Yd)(t),(0,r.Yd)(i),(0,r.Yd)(t),_,"FlowGraphTransformVectorBlock",e)}}(0,s.Y5)("FlowGraphTransformVectorBlock",g);class x extends n.W{constructor(e){super(r.Dx,r.Sp,r.Dx,((e,t)=>a.Pq.TransformCoordinates(e,t)),"FlowGraphTransformCoordinatesBlock",e)}}(0,s.Y5)("FlowGraphTransformCoordinatesBlock",x)},19226:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererMaskerVertexShaderWGSL:()=>n});const r="meshUVSpaceRendererMaskerVertexShader",s="attribute uv: vec2f;varying vUV: vec2f;@vertex\nfn main(input : VertexInputs)->FragmentInputs {vertexOutputs.position= vec4f( vec2f(input.uv.x,input.uv.y)*2.0-1.0,0.,1.0);vertexOutputs.vUV=input.uv;}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},19278:(e,t,i)=>{i.r(t),i.d(t,{lodPixelShader:()=>n});const r="lodPixelShader",s="#extension GL_EXT_shader_texture_lod : enable\nprecision highp float;const float GammaEncodePowerApprox=1.0/2.2;varying vec2 vUV;uniform sampler2D textureSampler;uniform float lod;uniform vec2 texSize;uniform int gamma;void main(void)\n{gl_FragColor=texture2DLodEXT(textureSampler,vUV,lod);if (gamma==0) {gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(GammaEncodePowerApprox));}}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},19375:(e,t,i)=>{i.d(t,{k:()=>s});var r=i(1919);class s extends r.G{constructor(e,t){super(e,t)}get duration(){return this._options.duration}set duration(e){this._options.duration=e}get loopStart(){return this._options.loopStart}set loopStart(e){this._options.loopStart=e}get loopEnd(){return this._options.loopEnd}set loopEnd(e){this._options.loopEnd=e}get pitch(){return this._options.pitch}set pitch(e){this._options.pitch=e;const t=this._getNewestInstance();t&&(t.pitch=e)}get playbackRate(){return this._options.playbackRate}set playbackRate(e){this._options.playbackRate=e;const t=this._getNewestInstance();t&&(t.playbackRate=e)}play(e={}){if(5===this.state)return void this.resume();e.duration??(e.duration=this.duration),e.loop??(e.loop=this.loop),e.loopStart??(e.loopStart=this.loopStart),e.loopEnd??(e.loopEnd=this.loopEnd),e.pitch??(e.pitch=this.pitch),e.playbackRate??(e.playbackRate=this.playbackRate),e.startOffset??(e.startOffset=this.startOffset),e.volume??(e.volume=1),e.waitTime??(e.waitTime=0);const t=this._createInstance();this._beforePlay(t),t.play(e),this._afterPlay(t),this._stopExcessInstances()}stop(e={}){if(e.waitTime&&0<e.waitTime?this._setState(0):this._setState(1),this._instances)for(const t of Array.from(this._instances))t.stop(e)}}},19411:(e,t,i)=>{i.r(t),i.d(t,{depthOfFieldMergePixelShader:()=>n});const r="depthOfFieldMergePixelShader",s="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)\n#else\n#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)\n#endif\nuniform sampler2D textureSampler;varying vec2 vUV;uniform sampler2D circleOfConfusionSampler;uniform sampler2D blurStep0;\n#if BLUR_LEVEL>0\nuniform sampler2D blurStep1;\n#endif\n#if BLUR_LEVEL>1\nuniform sampler2D blurStep2;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float coc=TEXTUREFUNC(circleOfConfusionSampler,vUV,0.0).r;\n#if BLUR_LEVEL==0\nvec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);gl_FragColor=mix(original,blurred0,coc);\n#endif\n#if BLUR_LEVEL==1\nif(coc<0.5){vec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(original,blurred1,coc/0.5);}else{vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(blurred1,blurred0,(coc-0.5)/0.5);}\n#endif\n#if BLUR_LEVEL==2\nif(coc<0.33){vec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred2=TEXTUREFUNC(blurStep2,vUV,0.0);gl_FragColor=mix(original,blurred2,coc/0.33);}else if(coc<0.66){vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);vec4 blurred2=TEXTUREFUNC(blurStep2,vUV,0.0);gl_FragColor=mix(blurred2,blurred1,(coc-0.33)/0.33);}else{vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(blurred1,blurred0,(coc-0.66)/0.34);}\n#endif\n}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},20449:(e,t,i)=>{i.r(t),i.d(t,{oitBackBlendPixelShader:()=>n});const r="oitBackBlendPixelShader",s="precision highp float;uniform sampler2D uBackColor;void main() {glFragColor=texelFetch(uBackColor,ivec2(gl_FragCoord.xy),0);if (glFragColor.a==0.0) { \ndiscard;}}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},20472:(e,t,i)=>{i.d(t,{Qz:()=>o,R$:()=>r,fj:()=>n});var r,s=i(99848);function n(e){let t=0;const i=Date.now();e.observableParameters=e.observableParameters??{};const r=e.contextObservable.add((s=>{const n=Date.now();t=n-i;const o={startTime:i,currentTime:n,deltaTime:t,completeRate:t/e.timeout,payload:s};e.onTick&&e.onTick(o),e.breakCondition&&e.breakCondition()&&(e.contextObservable.remove(r),e.onAborted&&e.onAborted(o)),t>=e.timeout&&(e.contextObservable.remove(r),e.onEnded&&e.onEnded(o))}),e.observableParameters.mask,e.observableParameters.insertFirst,e.observableParameters.scope);return r}!function(e){e[e.INIT=0]="INIT",e[e.STARTED=1]="STARTED",e[e.ENDED=2]="ENDED"}(r||(r={}));class o{constructor(e){this.onEachCountObservable=new s.cP,this.onTimerAbortedObservable=new s.cP,this.onTimerEndedObservable=new s.cP,this.onStateChangedObservable=new s.cP,this._observer=null,this._breakOnNextTick=!1,this._tick=e=>{const t=Date.now();this._timer=t-this._startTime;const i={startTime:this._startTime,currentTime:t,deltaTime:this._timer,completeRate:this._timer/this._timeToEnd,payload:e},r=this._breakOnNextTick||this._breakCondition(i);r||this._timer>=this._timeToEnd?this._stop(i,r):this.onEachCountObservable.notifyObservers(i)},this._setState(0),this._contextObservable=e.contextObservable,this._observableParameters=e.observableParameters??{},this._breakCondition=e.breakCondition??(()=>!1),this._timeToEnd=e.timeout,e.onEnded&&this.onTimerEndedObservable.add(e.onEnded),e.onTick&&this.onEachCountObservable.add(e.onTick),e.onAborted&&this.onTimerAbortedObservable.add(e.onAborted)}set breakCondition(e){this._breakCondition=e}clearObservables(){this.onEachCountObservable.clear(),this.onTimerAbortedObservable.clear(),this.onTimerEndedObservable.clear(),this.onStateChangedObservable.clear()}start(e=this._timeToEnd){if(1===this._state)throw new Error("Timer already started. Please stop it before starting again");this._timeToEnd=e,this._startTime=Date.now(),this._timer=0,this._observer=this._contextObservable.add(this._tick,this._observableParameters.mask,this._observableParameters.insertFirst,this._observableParameters.scope),this._setState(1)}stop(){1===this._state&&(this._breakOnNextTick=!0)}dispose(){this._observer&&this._contextObservable.remove(this._observer),this.clearObservables()}_setState(e){this._state=e,this.onStateChangedObservable.notifyObservers(this._state)}_stop(e,t=!1){this._contextObservable.remove(this._observer),this._setState(2),t?this.onTimerAbortedObservable.notifyObservers(e):this.onTimerEndedObservable.notifyObservers(e)}}},21570:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingStandardBlurPixelShaderWGSL:()=>n});const r="fluidRenderingStandardBlurPixelShader",s="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform filterSize: i32;uniform blurDir: vec2f;varying vUV: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var s: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.);if (s.r==0.) {fragmentOutputs.color=vec4f(0.,0.,0.,1.);return fragmentOutputs;}\nvar sigma: f32=f32(uniforms.filterSize)/3.0;var twoSigma2: f32=2.0*sigma*sigma;var sum: vec4f=vec4f(0.);var wsum: f32=0.;for (var x: i32=-uniforms.filterSize; x<=uniforms.filterSize; x++) {var coords: vec2f=vec2f(f32(x));var sampl: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV+coords*uniforms.blurDir,0.);var w: f32=exp(-coords.x*coords.x/twoSigma2);sum+=sampl*w;wsum+=w;}\nsum/=wsum;fragmentOutputs.color=vec4f(sum.rgb,1.);}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},21830:(e,t,i)=>{i.r(t),i.d(t,{vrDistortionCorrectionPixelShader:()=>n});const r="vrDistortionCorrectionPixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 LensCenter;uniform vec2 Scale;uniform vec2 ScaleIn;uniform vec4 HmdWarpParam;vec2 HmdWarp(vec2 in01) {vec2 theta=(in01-LensCenter)*ScaleIn; \nfloat rSq=theta.x*theta.x+theta.y*theta.y;vec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);return LensCenter+Scale*rvector;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 tc=HmdWarp(vUV);if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)\ngl_FragColor=vec4(0.0,0.0,0.0,0.0);else{gl_FragColor=texture2D(textureSampler,tc);}}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},21856:(e,t,i)=>{i.d(t,{GA:()=>s,IR:()=>r,zx:()=>n});const r={fftSize:2048,minDecibels:-100,maxDecibels:-30,smoothing:.8};function s(e){return e.analyzerEnabled||void 0!==e.analyzerFFTSize||void 0!==e.analyzerMinDecibels||void 0!==e.analyzerMaxDecibels||void 0!==e.analyzerSmoothing}class n{get frequencyBinCount(){return this.fftSize/2}}},21962:(e,t,i)=>{i.r(t),i.d(t,{lightsFragmentFunctions:()=>o});var r=i(69610);i(20004);const s="lightsFragmentFunctions",n="struct lightingInfo\n{vec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef NDOTL\nfloat ndl;\n#endif\n};lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 lightVectorW;float attenuation=1.0;if (lightData.w==0.)\n{vec3 direction=lightData.xyz-vPositionW;attenuation=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}\nelse\n{lightVectorW=normalize(-lightData.xyz);}\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nfloat getAttenuation(float cosAngle,float exponent) {return max(0.,pow(cosAngle,exponent));}\nfloat getIESAttenuation(float cosAngle,sampler2D iesLightSampler) {float angle=acos(cosAngle)/PI;return texture2D(iesLightSampler,vec2(angle,0.)).r;}\nlightingInfo basicSpotLighting(vec3 viewDirectionW,vec3 lightVectorW,vec3 vNormal,float attenuation,vec3 diffuseColor,vec3 specularColor,float glossiness) {lightingInfo result; \nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nlightingInfo computeIESSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness,sampler2D iesLightSampler) { \nvec3 direction=lightData.xyz-vPositionW;vec3 lightVectorW=normalize(direction);float attenuation=max(0.,1.0-length(direction)/range);float dotProduct=dot(lightDirection.xyz,-lightVectorW);float cosAngle=max(0.,dotProduct);if (cosAngle>=lightDirection.w)\n{ \nattenuation*=getIESAttenuation(dotProduct,iesLightSampler);return basicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}\nlightingInfo result;result.diffuse=vec3(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {vec3 direction=lightData.xyz-vPositionW;vec3 lightVectorW=normalize(direction);float attenuation=max(0.,1.0-length(direction)/range);float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)\n{ \nattenuation*=getAttenuation(cosAngle,lightData.w);return basicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}\nlightingInfo result;result.diffuse=vec3(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {lightingInfo result;float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightData.xyz);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;\n#endif\nreturn result;}\n#define inline\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix,vec3 posW){vec4 strq=textureProjectionMatrix*vec4(posW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return textureColor;}\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\n#include<ltcHelperFunctions>\nuniform sampler2D areaLightsLTC1Sampler;uniform sampler2D areaLightsLTC2Sampler;\n#define inline\nlightingInfo computeAreaLighting(sampler2D ltc1,sampler2D ltc2,vec3 viewDirectionW,vec3 vNormal,vec3 vPosition,vec3 lightPosition,vec3 halfWidth,vec3 halfHeight,vec3 diffuseColor,vec3 specularColor,float roughness) \n{lightingInfo result;areaLightData data=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc2,viewDirectionW,vNormal,vPosition,lightPosition,halfWidth,halfHeight,roughness);\n#ifdef SPECULARTERM\nvec3 fresnel=( specularColor*data.Fresnel.x+( vec3( 1.0 )-specularColor )*data.Fresnel.y );result.specular+=specularColor*fresnel*data.Specular;\n#endif\nresult.diffuse+=diffuseColor*data.Diffuse;return result;}\n#endif\n";r.l.IncludesShadersStore[s]=n;const o={name:s,shader:n}},22147:(e,t,i)=>{i.r(t),i.d(t,{glowMapMergePixelShaderWGSL:()=>n});const r="glowMapMergePixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#ifdef EMISSIVE\nvar textureSampler2Sampler: sampler;var textureSampler2: texture_2d<f32>;\n#endif\nuniform offset: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvar baseColor: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);\n#ifdef EMISSIVE\nbaseColor+=textureSample(textureSampler2,textureSampler2Sampler,input.vUV);baseColor*=uniforms.offset;\n#else\nbaseColor=vec4f(baseColor.rgb,abs(uniforms.offset-baseColor.a));\n#ifdef STROKE\nvar alpha: f32=smoothstep(.0,.1,baseColor.a);baseColor=vec4f(baseColor.rgb*alpha,alpha);\n#endif\n#endif\n#if LDR\nbaseColor=clamp(baseColor,vec4f(0.),vec4f(1.0));\n#endif\nfragmentOutputs.color=baseColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},22217:(e,t,i)=>{i.r(t),i.d(t,{circleOfConfusionPixelShaderWGSL:()=>n});const r="circleOfConfusionPixelShader",s="varying vUV: vec2f;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;\n#ifndef COC_DEPTH_NOT_NORMALIZED\nuniform cameraMinMaxZ: vec2f;\n#endif\nuniform focusDistance: f32;uniform cocPrecalculation: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var depth: f32=textureSample(depthSampler,depthSamplerSampler,input.vUV).r;\n#define CUSTOM_COC_DEPTH\n#ifdef COC_DEPTH_NOT_NORMALIZED\nlet pixelDistance=depth*1000.0;\n#else\nlet pixelDistance: f32=(uniforms.cameraMinMaxZ.x+uniforms.cameraMinMaxZ.y*depth)*1000.0; \n#endif\n#define CUSTOM_COC_PIXELDISTANCE\nvar coc: f32=abs(uniforms.cocPrecalculation*((uniforms.focusDistance-pixelDistance)/pixelDistance));coc=clamp(coc,0.0,1.0);fragmentOutputs.color= vec4f(coc,coc,coc,1.0);}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},22495:(e,t,i)=>{i.r(t),i.d(t,{iblShadowDebugPixelShader:()=>n});const r="iblShadowDebugPixelShader",s="#ifdef GL_ES\nprecision mediump float;\n#endif\nvarying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D debugSampler;uniform vec4 sizeParams;\n#define offsetX sizeParams.x\n#define offsetY sizeParams.y\n#define widthScale sizeParams.z\n#define heightScale sizeParams.w\nvoid main(void) {vec2 uv =\nvec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec4 background=texture2D(textureSampler,vUV);vec4 debugColour=texture2D(debugSampler,vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {gl_FragColor.rgba=background;} else {gl_FragColor.rgb=mix(debugColour.rgb,background.rgb,0.0);gl_FragColor.a=1.0;}}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},22614:(e,t,i)=>{i.r(t),i.d(t,{layerVertexShader:()=>n});const r="layerVertexShader",s="attribute vec2 position;uniform vec2 scale;uniform vec2 offset;uniform mat4 textureMatrix;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec2 shiftedPosition=position*scale+offset;vUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));gl_Position=vec4(shiftedPosition,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},23051:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphCodeExecutionBlock:()=>n});var r=i(71294),s=i(4720);class n extends r.e{constructor(e){super(e),this.config=e,this.executionFunction=this.registerDataInput("function",s.Vv),this.value=this.registerDataInput("value",s.Vv),this.result=this.registerDataOutput("result",s.Vv)}_updateOutputs(e){const t=this.executionFunction.getValue(e),i=this.value.getValue(e);t&&this.result.setValue(t(i,e),e)}getClassName(){return"FlowGraphCodeExecutionBlock"}}},23451:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererVertexShaderWGSL:()=>o});var r=i(69610);i(32806),i(98900),i(76340),i(8217),i(44559),i(18258),i(9129),i(91277),i(65470),i(40242);const s="meshUVSpaceRendererVertexShader",n="attribute position: vec3f;attribute normal: vec3f;attribute uv: vec2f;uniform projMatrix: mat4x4f;varying vDecalTC: vec2f;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;var normalUpdated: vec3f=input.normal;\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);var normWorldSM: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);var vNormalW: vec3f;\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/ vec3f(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvNormalW=normalize(normWorldSM*normalUpdated);\n#endif\nvar normalView: vec3f=normalize((uniforms.projMatrix* vec4f(vNormalW,0.0)).xyz);var decalTC: vec3f=(uniforms.projMatrix*worldPos).xyz;vertexOutputs.vDecalTC=decalTC.xy;vertexOutputs.position=vec4f(input.uv*2.0-1.0,select(decalTC.z,2.,normalView.z>0.0),1.0);}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},23483:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleDiffusePixelShader:()=>n});const r="fluidRenderingParticleDiffusePixelShader",s="uniform float particleAlpha;varying vec2 uv;varying vec3 diffuseColor;void main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;glFragColor=vec4(diffuseColor,1.0);}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},23584:(e,t,i)=>{i.r(t),i.d(t,{iblGenerateVoxelMipPixelShaderWGSL:()=>n});const r="iblGenerateVoxelMipPixelShader",s="varying vUV: vec2f;var srcMip: texture_3d<f32>;uniform layerNum: i32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var Coords=vec3i(2)*vec3i(vec2i(fragmentInputs.position.xy),uniforms.layerNum);var tex =\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,0,0),0).x>0.0f))\n<< 0u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,0,0),0).x>0.0f))\n<< 1u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,1,0),0).x>0.0f))\n<< 2u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,1,0),0).x>0.0f))\n<< 3u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,0,1),0).x>0.0f))\n<< 4u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,0,1),0).x>0.0f))\n<< 5u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,1,1),0).x>0.0f))\n<< 6u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,1,1),0).x>0.0f))\n<< 7u);fragmentOutputs.color=vec4f( f32(tex)/255.0f,0.0f,0.0f,1.0);}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},23694:(e,t,i)=>{i.d(t,{bO:()=>n,uD:()=>s,uJ:()=>r});const r={pan:0};function s(e){return e.stereoEnabled||void 0!==e.stereoPan}class n{}},24030:(e,t,i)=>{i.r(t),i.d(t,{iblCdfyPixelShader:()=>o});var r=i(69610);i(73325);const s="iblCdfyPixelShader",n="precision highp sampler2D;precision highp samplerCube;\n#include<helperFunctions>\n#define PI 3.1415927\nvarying vec2 vUV;\n#ifdef IBL_USE_CUBE_MAP\nuniform samplerCube iblSource;\n#else\nuniform sampler2D iblSource;\n#endif\nuniform int iblHeight;\n#ifdef IBL_USE_CUBE_MAP\nfloat fetchCube(vec2 uv) {vec3 direction=equirectangularToCubemapDirection(uv);return sin(PI*uv.y)*dot(textureCubeLodEXT(iblSource,direction,0.0).rgb,LuminanceEncodeApprox);}\n#else\nfloat fetchPanoramic(ivec2 Coords,float envmapHeight) {return sin(PI*(float(Coords.y)+0.5)/envmapHeight) *\ndot(texelFetch(iblSource,Coords,0).rgb,LuminanceEncodeApprox);}\n#endif\nvoid main(void) {ivec2 coords=ivec2(gl_FragCoord.x,gl_FragCoord.y);float cdfy=0.0;for (int y=1; y<=coords.y; y++) {\n#ifdef IBL_USE_CUBE_MAP\nvec2 uv=vec2(vUV.x,(float(y-1)+0.5)/float(iblHeight));cdfy+=fetchCube(uv);\n#else\ncdfy+=fetchPanoramic(ivec2(coords.x,y-1),float(iblHeight));\n#endif\n}\ngl_FragColor=vec4(cdfy,0.0,0.0,1.0);}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},24448:(e,t,i)=>{i.r(t),i.d(t,{spritesVertexShaderWGSL:()=>o});var r=i(69610);i(75757),i(93226),i(81482);const s="spritesVertexShader",n="attribute position: vec4f;attribute options: vec2f;attribute offsets: vec2f;attribute inverts: vec2f;attribute cellInfo: vec4f;attribute color: vec4f;uniform view: mat4x4f;uniform projection: mat4x4f;varying vUV: vec2f;varying vColor: vec4f;\n#include<fogVertexDeclaration>\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar viewPos: vec3f=(uniforms.view* vec4f(input.position.xyz,1.0)).xyz; \nvar cornerPos: vec2f;var angle: f32=input.position.w;var size: vec2f= vec2f(input.options.x,input.options.y);var offset: vec2f=input.offsets.xy;cornerPos= vec2f(offset.x-0.5,offset.y -0.5)*size;var rotatedCorner: vec3f;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;viewPos+=rotatedCorner;vertexOutputs.position=uniforms.projection*vec4f(viewPos,1.0); \nvertexOutputs.vColor=input.color;var uvOffset: vec2f= vec2f(abs(offset.x-input.inverts.x),abs(1.0-offset.y-input.inverts.y));var uvPlace: vec2f=input.cellInfo.xy;var uvSize: vec2f=input.cellInfo.zw;vertexOutputs.vUV.x=uvPlace.x+uvSize.x*uvOffset.x;vertexOutputs.vUV.y=uvPlace.y+uvSize.y*uvOffset.y;\n#ifdef FOG\nvertexOutputs.vFogDistance=viewPos;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},24676:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphTransformCoordinatesSystemBlock:()=>a});var r=i(71294),s=i(4720),n=i(79923),o=i(56552);class a extends r.e{constructor(e){super(e),this.sourceSystem=this.registerDataInput("sourceSystem",s.Vv),this.destinationSystem=this.registerDataInput("destinationSystem",s.Vv),this.inputCoordinates=this.registerDataInput("inputCoordinates",s.Dx),this.outputCoordinates=this.registerDataOutput("outputCoordinates",s.Dx)}_updateOutputs(e){const t=this.sourceSystem.getValue(e),i=this.destinationSystem.getValue(e),r=this.inputCoordinates.getValue(e),s=t.getWorldMatrix(),o=i.getWorldMatrix(),a=n.AA.Matrix[0].copyFrom(o);a.invert();const l=n.AA.Matrix[1];a.multiplyToRef(s,l);const h=this.outputCoordinates.getValue(e);n.Pq.TransformCoordinatesToRef(r,l,h)}getClassName(){return"FlowGraphTransformCoordinatesSystemBlock"}}(0,o.Y5)("FlowGraphTransformCoordinatesSystemBlock",a)},25595:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphIndexOfBlock:()=>a});var r=i(71294),s=i(4720),n=i(56552),o=i(90868);class a extends r.e{constructor(e){super(e),this.config=e,this.object=this.registerDataInput("object",s.Vv),this.array=this.registerDataInput("array",s.Vv),this.index=this.registerDataOutput("index",s.x2,new o.P(-1))}_updateOutputs(e){const t=this.object.getValue(e),i=this.array.getValue(e);i&&this.index.setValue(new o.P(i.indexOf(t)),e)}serialize(e){super.serialize(e)}getClassName(){return"FlowGraphIndexOfBlock"}}(0,n.Y5)("FlowGraphIndexOfBlock",a)},25830:(e,t,i)=>{i.r(t),i.d(t,{motionBlurPixelShader:()=>n});const r="motionBlurPixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;uniform float motionStrength;uniform float motionScale;uniform vec2 screenSize;\n#ifdef OBJECT_BASED\nuniform sampler2D velocitySampler;\n#else\nuniform sampler2D depthSampler;uniform mat4 inverseViewProjection;uniform mat4 prevViewProjection;uniform mat4 projection;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#ifdef GEOMETRY_SUPPORTED\n#ifdef OBJECT_BASED\nvec2 texelSize=1.0/screenSize;vec4 velocityColor=texture2D(velocitySampler,vUV);velocityColor.rg=velocityColor.rg*2.0-vec2(1.0);vec2 velocity=vec2(pow(velocityColor.r,3.0),pow(velocityColor.g,3.0))*velocityColor.a;velocity*=motionScale*motionStrength;float speed=length(velocity/texelSize);int samplesCount=int(clamp(speed,1.0,SAMPLES));velocity=normalize(velocity)*texelSize;float hlim=float(-samplesCount)*0.5+0.5;vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(SAMPLES); ++i)\n{if (i>=samplesCount)\nbreak;vec2 offset=vUV+velocity*(hlim+float(i));\n#if defined(WEBGPU)\nresult+=texture2DLodEXT(textureSampler,offset,0.0);\n#else\nresult+=texture2D(textureSampler,offset);\n#endif\n}\ngl_FragColor=result/float(samplesCount);gl_FragColor.a=1.0;\n#else\nvec2 texelSize=1.0/screenSize;float depth=texture2D(depthSampler,vUV).r;depth=projection[2].z+projection[3].z/depth; \nvec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);cpos=inverseViewProjection*cpos;cpos/=cpos.w;vec4 ppos=prevViewProjection*cpos;ppos/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;float speed=length(velocity/texelSize);int nSamples=int(clamp(speed,1.0,SAMPLES));vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(SAMPLES); ++i) {if (i>=nSamples)\nbreak;vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);\n#if defined(WEBGPU)\nresult+=texture2DLodEXT(textureSampler,offset1,0.0);\n#else\nresult+=texture2D(textureSampler,offset1);\n#endif\n}\ngl_FragColor=result/float(nSamples);\n#endif\n#else\ngl_FragColor=texture2D(textureSampler,vUV);\n#endif\n}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},26149:(e,t,i)=>{i.r(t),i.d(t,{lineVertexShader:()=>c});var r=i(69610);const s="lineVertexDeclaration",n="uniform mat4 viewProjection;\n#define ADDITIONAL_VERTEX_DECLARATION\n";r.l.IncludesShadersStore[s]=n;i(28764),i(96467);const o="lineUboDeclaration",a="layout(std140,column_major) uniform;\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";r.l.IncludesShadersStore[o]=a;i(1218),i(71636),i(34581),i(3298),i(47314),i(2215);const l="lineVertexShader",h="#include<__decl__lineVertex>\n#include<instancesDeclaration>\n#include<clipPlaneVertexDeclaration>\nattribute vec3 position;attribute vec4 normal;uniform float width;uniform float aspectRatio;\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#include<instancesVertex>\nmat4 worldViewProjection=viewProjection*finalWorld;vec4 viewPosition=worldViewProjection*vec4(position,1.0);vec4 viewPositionNext=worldViewProjection*vec4(normal.xyz,1.0);vec2 currentScreen=viewPosition.xy/viewPosition.w;vec2 nextScreen=viewPositionNext.xy/viewPositionNext.w;currentScreen.x*=aspectRatio;nextScreen.x*=aspectRatio;vec2 dir=normalize(nextScreen-currentScreen);vec2 normalDir=vec2(-dir.y,dir.x);normalDir*=width/2.0;normalDir.x/=aspectRatio;vec4 offset=vec4(normalDir*normal.w,0.0,0.0);gl_Position=viewPosition+offset;\n#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nvec4 worldPos=finalWorld*vec4(position,1.0);\n#include<clipPlaneVertex>\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStore[l]=h;const c={name:l,shader:h}},26472:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelSlabDebugVertexShaderWGSL:()=>n});const r="iblVoxelSlabDebugVertexShader",s="attribute position: vec3f;varying vNormalizedPosition: vec3f;uniform world: mat4x4f;uniform invWorldScale: mat4x4f;uniform cameraViewMatrix: mat4x4f;uniform projection: mat4x4f;uniform viewMatrix: mat4x4f;@vertex\nfn main(input : VertexInputs)->FragmentInputs {var worldPosition: vec4f=(uniforms.world* vec4f(input.position,1.));vertexOutputs.position=uniforms.projection*uniforms.cameraViewMatrix*worldPosition;vertexOutputs.vNormalizedPosition=(uniforms.viewMatrix*uniforms.invWorldScale*worldPosition).rgb;vertexOutputs.vNormalizedPosition=vertexOutputs.vNormalizedPosition* vec3f(0.5)+ vec3f(0.5);}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},26846:(e,t,i)=>{i.d(t,{D9:()=>r,Ui:()=>o,f0:()=>n});var r,s=i(99848);!function(e){e[e.HAS_INPUTS=1]="HAS_INPUTS",e[e.HAS_OUTPUTS=2]="HAS_OUTPUTS",e[e.HAS_INPUTS_AND_OUTPUTS=3]="HAS_INPUTS_AND_OUTPUTS"}(r||(r={}));class n{constructor(e,t){this.onDisposeObservable=new s.cP,this.engine=e,1&t&&(this._upstreamNodes=new Set),2&t&&(this._downstreamNodes=new Set)}dispose(){if(this._downstreamNodes){for(const e of Array.from(this._downstreamNodes))if(!this._disconnect(e))throw new Error("Disconnect failed");this._downstreamNodes.clear()}if(this._upstreamNodes){for(const e of Array.from(this._upstreamNodes))if(!e._disconnect(this))throw new Error("Disconnect failed");this._upstreamNodes.clear()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}_connect(e){return!!this._downstreamNodes&&(!this._downstreamNodes.has(e)&&(!!e._onConnect(this)&&(this._downstreamNodes.add(e),!0)))}_disconnect(e){return!!this._downstreamNodes&&(!!this._downstreamNodes.delete(e)&&e._onDisconnect(this))}_onConnect(e){return!!this._upstreamNodes&&(!this._upstreamNodes.has(e)&&(this._upstreamNodes.add(e),!0))}_onDisconnect(e){return this._upstreamNodes?.delete(e)??!1}}class o extends n{constructor(e,t,i){super(t,i),this.onNameChangedObservable=new s.cP,this._name=e}get name(){return this._name}set name(e){if(this._name===e)return;const t=this._name;this._name=e,this.onNameChangedObservable.notifyObservers({newName:e,oldName:t,node:this})}dispose(){super.dispose(),this.onNameChangedObservable.clear()}}},26892:(e,t,i)=>{i.r(t),i.d(t,{greasedLineVertexShader:()=>o});var r=i(69610);i(1218),i(3298);const s="greasedLineVertexShader",n="precision highp float;\n#include<instancesDeclaration>\nattribute float grl_widths;attribute vec3 grl_offsets;attribute float grl_colorPointers;attribute vec3 position;uniform mat4 viewProjection;uniform mat4 projection;varying float grlCounters;varying float grlColorPointer;\n#ifdef GREASED_LINE_CAMERA_FACING\nattribute vec4 grl_nextAndCounters;attribute vec4 grl_previousAndSide;uniform vec2 grlResolution;uniform float grlAspect;uniform float grlWidth;uniform float grlSizeAttenuation;vec2 grlFix( vec4 i,float aspect ) {vec2 res=i.xy/i.w;res.x*=aspect;return res;}\n#else\nattribute vec3 grl_slopes;attribute float grl_counters;\n#endif\nvoid main() {\n#include<instancesVertex>\ngrlColorPointer=grl_colorPointers;mat4 grlMatrix=viewProjection*finalWorld ;\n#ifdef GREASED_LINE_CAMERA_FACING\nfloat grlBaseWidth=grlWidth;vec3 grlPrevious=grl_previousAndSide.xyz;float grlSide=grl_previousAndSide.w;vec3 grlNext=grl_nextAndCounters.xyz;grlCounters=grl_nextAndCounters.w;float grlWidth=grlBaseWidth*grl_widths;vec3 positionUpdated=position+grl_offsets;vec3 worldDir=normalize(grlNext-grlPrevious);vec3 nearPosition=positionUpdated+(worldDir*0.001);vec4 grlFinalPosition=grlMatrix*vec4( positionUpdated ,1.0);vec4 screenNearPos=grlMatrix*vec4(nearPosition,1.0);vec2 grlLinePosition=grlFix(grlFinalPosition,grlAspect);vec2 grlLineNearPosition=grlFix(screenNearPos,grlAspect);vec2 grlDir=normalize(grlLineNearPosition-grlLinePosition);vec4 grlNormal=vec4( -grlDir.y,grlDir.x,0.,1. );\n#ifdef GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM\ngrlNormal.xy*=-.5*grlWidth;\n#else\ngrlNormal.xy*=.5*grlWidth;\n#endif\ngrlNormal*=projection;if (grlSizeAttenuation==1.) {grlNormal.xy*=grlFinalPosition.w;grlNormal.xy/=( vec4( grlResolution,0.,1. )*projection ).xy;}\ngrlFinalPosition.xy+=grlNormal.xy*grlSide;gl_Position=grlFinalPosition;\n#else\ngrlCounters=grl_counters;vec4 grlFinalPosition=grlMatrix*vec4( (position+grl_offsets)+grl_slopes*grl_widths ,1.0 ) ;gl_Position=grlFinalPosition;\n#endif\n}\n";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},27122:(e,t,i)=>{i.r(t),i.d(t,{iblShadowAccumulationPixelShaderWGSL:()=>n});const r="iblShadowAccumulationPixelShader",s="varying vUV: vec2f;uniform accumulationParameters: vec4f;\n#define remanence uniforms.accumulationParameters.x\n#define resetb uniforms.accumulationParameters.y\n#define sceneSize uniforms.accumulationParameters.z\nvar motionSampler: texture_2d<f32>;var positionSampler: texture_2d<f32>;var spatialBlurSampler : texture_2d<f32>;var oldAccumulationSamplerSampler: sampler;var oldAccumulationSampler: texture_2d<f32>;var prevPositionSamplerSampler: sampler;var prevPositionSampler: texture_2d<f32>;fn max2(v: vec2f,w: vec2f)->vec2f { \nreturn vec2f(max(v.x,w.x),max(v.y,w.y)); }\nfn lessThan(x: vec2f,y: vec2f)->vec2<bool> {return x<y;}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var reset: bool= bool(resetb);var gbufferRes : vec2f=vec2f(textureDimensions(positionSampler,0));var gbufferPixelCoord: vec2i= vec2i(input.vUV*gbufferRes);var shadowRes : vec2f=vec2f(textureDimensions(spatialBlurSampler,0));var shadowPixelCoord: vec2i= vec2i(input.vUV*shadowRes);var LP: vec4f=textureLoad(positionSampler,gbufferPixelCoord,0);if (0.0==LP.w) {fragmentOutputs.color=vec4f(1.0,0.0,0.0,1.0);return fragmentOutputs;}\nvar velocityColor: vec2f=textureLoad(motionSampler,gbufferPixelCoord,0).xy;var prevCoord: vec2f=input.vUV+velocityColor;var PrevLP: vec3f=textureSampleLevel(prevPositionSampler,prevPositionSamplerSampler,prevCoord,0.0).xyz;var PrevShadows: vec4f=textureSampleLevel(oldAccumulationSampler,oldAccumulationSamplerSampler,prevCoord,0.0);var newShadows : vec3f=textureLoad(spatialBlurSampler,shadowPixelCoord,0).xyz;PrevShadows.a=select(1.0,max(PrevShadows.a/(1.0+PrevShadows.a),1.0-remanence),!reset && all(lessThan(abs(prevCoord- vec2f(0.5)), vec2f(0.5))) &&\ndistance(LP.xyz,PrevLP)<5e-2*sceneSize);PrevShadows=max( vec4f(0.0),PrevShadows);fragmentOutputs.color= vec4f(mix(PrevShadows.x,newShadows.x,PrevShadows.a),\nmix(PrevShadows.y,newShadows.y,PrevShadows.a),\nmix(PrevShadows.z,newShadows.z,PrevShadows.a),PrevShadows.a);}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},27323:(e,t,i)=>{i.r(t),i.d(t,{particlesVertexShaderWGSL:()=>o});var r=i(69610);i(77029),i(75757),i(93226),i(85197),i(59013),i(81482);const s="particlesVertexShader",n="attribute position: vec3f;attribute color: vec4f;attribute angle: f32;attribute size: vec2f;\n#ifdef ANIMATESHEET\nattribute cellIndex: f32;\n#endif\n#ifndef BILLBOARD\nattribute direction: vec3f;\n#endif\n#ifdef BILLBOARDSTRETCHED\nattribute direction: vec3f;\n#endif\n#ifdef RAMPGRADIENT\nattribute remapData: vec4f;\n#endif\nattribute offset: vec2f;uniform view: mat4x4f;uniform projection: mat4x4f;uniform translationPivot: vec2f;\n#ifdef ANIMATESHEET\nuniform particlesInfos: vec3f; \n#endif\nvarying vUV: vec2f;varying vColor: vec4f;varying vPositionW: vec3f;\n#ifdef RAMPGRADIENT\nvarying remapRanges: vec4f;\n#endif\n#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)\nuniform invView: mat4x4f;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<logDepthDeclaration>\n#ifdef BILLBOARD\nuniform eyePosition: vec3f;\n#endif\nfn rotate(yaxis: vec3f,rotatedCorner: vec3f)->vec3f {var xaxis: vec3f=normalize(cross( vec3f(0.,1.0,0.),yaxis));var zaxis: vec3f=normalize(cross(yaxis,xaxis));var row0: vec3f= vec3f(xaxis.x,xaxis.y,xaxis.z);var row1: vec3f= vec3f(yaxis.x,yaxis.y,yaxis.z);var row2: vec3f= vec3f(zaxis.x,zaxis.y,zaxis.z);var rotMatrix: mat3x3f= mat3x3f(row0,row1,row2);var alignedCorner: vec3f=rotMatrix*rotatedCorner;return vertexInputs.position+alignedCorner;}\n#ifdef BILLBOARDSTRETCHED\nfn rotateAlign(toCamera: vec3f,rotatedCorner: vec3f)->vec3f {var normalizedToCamera: vec3f=normalize(toCamera);var normalizedCrossDirToCamera: vec3f=normalize(cross(normalize(vertexInputs.direction),normalizedToCamera));var row0: vec3f= vec3f(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);var row2: vec3f= vec3f(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);\n#ifdef BILLBOARDSTRETCHED_LOCAL\nvar row1: vec3f=vertexInputs.direction;\n#else\nvar crossProduct: vec3f=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));var row1: vec3f= vec3f(crossProduct.x,crossProduct.y,crossProduct.z);\n#endif\nvar rotMatrix: mat3x3f= mat3x3f(row0,row1,row2);var alignedCorner: vec3f=rotMatrix*rotatedCorner;return vertexInputs.position+alignedCorner;}\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar cornerPos: vec2f;cornerPos=( vec2f(input.offset.x-0.5,input.offset.y -0.5)-uniforms.translationPivot)*input.size;\n#ifdef BILLBOARD\nvar rotatedCorner: vec3f;\n#ifdef BILLBOARDY\nrotatedCorner.x=cornerPos.x*cos(input.angle)-cornerPos.y*sin(input.angle)+uniforms.translationPivot.x;rotatedCorner.z=cornerPos.x*sin(input.angle)+cornerPos.y*cos(input.angle)+uniforms.translationPivot.y;rotatedCorner.y=0.;var yaxis: vec3f=input.position-uniforms.eyePosition;yaxis.y=0.;vertexOutputs.vPositionW=rotate(normalize(yaxis),rotatedCorner);var viewPos: vec3f=(uniforms.view* vec4f(vertexOutputs.vPositionW,1.0)).xyz;\n#elif defined(BILLBOARDSTRETCHED)\nrotatedCorner.x=cornerPos.x*cos(input.angle)-cornerPos.y*sin(input.angle)+uniforms.translationPivot.x;rotatedCorner.y=cornerPos.x*sin(input.angle)+cornerPos.y*cos(input.angle)+uniforms.translationPivot.y;rotatedCorner.z=0.;var toCamera: vec3f=input.position-uniforms.eyePosition;vertexOutputs.vPositionW=rotateAlign(toCamera,rotatedCorner);var viewPos: vec3f=(uniforms.view* vec4f(vertexOutputs.vPositionW,1.0)).xyz;\n#else\nrotatedCorner.x=cornerPos.x*cos(input.angle)-cornerPos.y*sin(input.angle)+uniforms.translationPivot.x;rotatedCorner.y=cornerPos.x*sin(input.angle)+cornerPos.y*cos(input.angle)+uniforms.translationPivot.y;rotatedCorner.z=0.;var viewPos: vec3f=(uniforms.view* vec4f(input.position,1.0)).xyz+rotatedCorner;vertexOutputs.vPositionW=(uniforms.invView* vec4f(viewPos,1)).xyz;\n#endif\n#ifdef RAMPGRADIENT\nvertexOutputs.remapRanges=input.remapData;\n#endif\nvertexOutputs.position=uniforms.projection* vec4f(viewPos,1.0);\n#else\nvar rotatedCorner: vec3f;rotatedCorner.x=cornerPos.x*cos(input.angle)-cornerPos.y*sin(input.angle)+uniforms.translationPivot.x;rotatedCorner.z=cornerPos.x*sin(input.angle)+cornerPos.y*cos(input.angle)+uniforms.translationPivot.y;rotatedCorner.y=0.;var yaxis: vec3f=normalize(vertexInputs.direction);vertexOutputs.vPositionW=rotate(yaxis,rotatedCorner);vertexOutputs.position=uniforms.projection*uniforms.view* vec4f(vertexOutputs.vPositionW,1.0);\n#endif\nvertexOutputs.vColor=input.color;\n#ifdef ANIMATESHEET\nvar rowOffset: f32=floor(input.cellIndex*uniforms.particlesInfos.z);var columnOffset: f32=input.cellIndex-rowOffset/uniforms.particlesInfos.z;var uvScale: vec2f=uniforms.particlesInfos.xy;var uvOffset: vec2f= vec2f(input.offset.x ,1.0-input.offset.y);vertexOutputs.vUV=(uvOffset+ vec2f(columnOffset,rowOffset))*uvScale;\n#else\nvertexOutputs.vUV=input.offset;\n#endif\n#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6) || defined(FOG)\nvar worldPos: vec4f= vec4f(vertexOutputs.vPositionW,1.0);\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},27499:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleDepthVertexShaderWGSL:()=>n});const r="fluidRenderingParticleDepthVertexShader",s="attribute position: vec3f;attribute offset: vec2f;uniform view: mat4x4f;uniform projection: mat4x4f;uniform size: vec2f;varying uv: vec2f;varying viewPos: vec3f;varying sphereRadius: f32;\n#ifdef FLUIDRENDERING_VELOCITY\nattribute velocity: vec3f;varying velocityNorm: f32;\n#endif\n@vertex\nfn main(input: VertexInputs)->FragmentInputs {var cornerPos: vec3f=vec3f(\nvec2f(input.offset.x-0.5,input.offset.y-0.5)*uniforms.size,\n0.0\n);vertexOutputs.viewPos=(uniforms.view*vec4f(input.position,1.0)).xyz;vertexOutputs.position=uniforms.projection*vec4f(vertexOutputs.viewPos+cornerPos,1.0);vertexOutputs.uv=input.offset;vertexOutputs.sphereRadius=uniforms.size.x/2.0;\n#ifdef FLUIDRENDERING_VELOCITY\nvertexOutputs.velocityNorm=length(velocity);\n#endif\n}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},27911:(e,t,i)=>{i.r(t),i.d(t,{_HDRTextureLoader:()=>s});var r=i(82814);class s{constructor(){this.supportCascades=!1}loadCubeData(){throw".hdr not supported in Cube."}loadData(e,t,i){const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),n=(0,r.NK)(s),o=(0,r.LT)(s,n),a=n.width*n.height,l=new Float32Array(4*a);for(let e=0;e<a;e+=1)l[4*e]=o[3*e],l[4*e+1]=o[3*e+1],l[4*e+2]=o[3*e+2],l[4*e+3]=1;i(n.width,n.height,t.generateMipMaps,!1,(()=>{const e=t.getEngine();t.type=1,t.format=5,t._gammaSpace=!1,e._uploadDataToTextureDirectly(t,l)}))}}},28011:(e,t,i)=>{i.r(t),i.d(t,{ComputeShaderBoundingHelper:()=>u});var r=i(72266),s=i(31367),n=i(95616),o=i(79923),a=i(80935);const l="boundingInfoComputeShader",h="struct Results {minX : atomic<i32>,\nminY : atomic<i32>,\nminZ : atomic<i32>,\nmaxX : atomic<i32>,\nmaxY : atomic<i32>,\nmaxZ : atomic<i32>,\ndummy1 : i32,\ndummy2 : i32,};fn floatToBits(value: f32)->i32 {return bitcast<i32>(value);}\nfn bitsToFloat(value: i32)->f32 {return bitcast<f32>(value);}\nfn atomicMinFloat(atomicVar: ptr<storage,atomic<i32>,read_write>,value: f32) {let intValue=floatToBits(value);loop {let oldIntValue=atomicLoad(atomicVar);let oldValue=bitsToFloat(oldIntValue);if (value>=oldValue) {break;}\nif (atomicCompareExchangeWeak(atomicVar,oldIntValue,intValue).old_value==oldIntValue) {break;}}}\nfn atomicMaxFloat(atomicVar: ptr<storage,atomic<i32>,read_write>,value: f32) {let intValue=floatToBits(value);loop {let oldIntValue=atomicLoad(atomicVar);let oldValue=bitsToFloat(oldIntValue);if (value<=oldValue) {break;}\nif (atomicCompareExchangeWeak(atomicVar,oldIntValue,intValue).old_value==oldIntValue) {break;}}}\nfn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4<f32>\n{let offset=i32(index) *4; \nlet m0=textureLoad(smp,vec2<i32>(offset+0,0),0);let m1=textureLoad(smp,vec2<i32>(offset+1,0),0);let m2=textureLoad(smp,vec2<i32>(offset+2,0),0);let m3=textureLoad(smp,vec2<i32>(offset+3,0),0);return mat4x4<f32>(m0,m1,m2,m3);}\nconst identity=mat4x4f(\nvec4f(1.0,0.0,0.0,0.0),\nvec4f(0.0,1.0,0.0,0.0),\nvec4f(0.0,0.0,1.0,0.0),\nvec4f(0.0,0.0,0.0,1.0)\n);struct Settings {morphTargetTextureInfo: vec3f,\nmorphTargetCount: i32,\nindexResult : u32,};@group(0) @binding(0) var<storage,read> positionBuffer : array<f32>;@group(0) @binding(1) var<storage,read_write> resultBuffer : array<Results>;@group(0) @binding(7) var<uniform> settings : Settings;\n#if NUM_BONE_INFLUENCERS>0\n@group(0) @binding(2) var boneSampler : texture_2d<f32>;@group(0) @binding(3) var<storage,read> indexBuffer : array<vec4f>;@group(0) @binding(4) var<storage,read> weightBuffer : array<vec4f>;\n#if NUM_BONE_INFLUENCERS>4\n@group(0) @binding(5) var<storage,read> indexExtraBuffer : array<vec4f>;@group(0) @binding(6) var<storage,read> weightExtraBuffer : array<vec4f>;\n#endif\n#endif\n#ifdef MORPHTARGETS\n@group(0) @binding(8) var morphTargets : texture_2d_array<f32>;@group(0) @binding(9) var<storage,read> morphTargetInfluences : array<f32>;@group(0) @binding(10) var<storage,read> morphTargetTextureIndices : array<f32>;\n#endif\n#ifdef MORPHTARGETS\nfn readVector3FromRawSampler(targetIndex : i32,vertexIndex : u32)->vec3f\n{ \nlet vertexID=f32(vertexIndex)*settings.morphTargetTextureInfo.x;let y=floor(vertexID/settings.morphTargetTextureInfo.y);let x=vertexID-y*settings.morphTargetTextureInfo.y;let textureUV=vec2<i32>(i32(x),i32(y));return textureLoad(morphTargets,textureUV,i32(morphTargetTextureIndices[targetIndex]),0).xyz;}\nfn readVector4FromRawSampler(targetIndex : i32,vertexIndex : u32)->vec4f\n{ \nlet vertexID=f32(vertexIndex)*settings.morphTargetTextureInfo.x;let y=floor(vertexID/settings.morphTargetTextureInfo.y);let x=vertexID-y*settings.morphTargetTextureInfo.y;let textureUV=vec2<i32>(i32(x),i32(y));return textureLoad(morphTargets,textureUV,i32(morphTargetTextureIndices[targetIndex]),0);}\n#endif\n@compute @workgroup_size(256,1,1)\nfn main(@builtin(global_invocation_id) global_id : vec3<u32>) {let index=global_id.x;if (index>=arrayLength(&positionBuffer)/3) {return;}\nlet position=vec3f(positionBuffer[index*3],positionBuffer[index*3+1],positionBuffer[index*3+2]);var finalWorld=identity;var positionUpdated=position;\n#if NUM_BONE_INFLUENCERS>0\nvar influence : mat4x4<f32>;let matricesIndices=indexBuffer[index];let matricesWeights=weightBuffer[index];influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\nlet matricesIndicesExtra=indexExtraBuffer[index];let matricesWeightsExtra=weightExtraBuffer[index];influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.x)*matricesWeightsExtra.x;\n#if NUM_BONE_INFLUENCERS>5\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.y)*matricesWeightsExtra.y;\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.z)*matricesWeightsExtra.z;\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.w)*matricesWeightsExtra.w;\n#endif \n#endif \nfinalWorld=finalWorld*influence;\n#endif\n#ifdef MORPHTARGETS\nfor (var i=0; i<NUM_MORPH_INFLUENCERS; i=i+1) {if (i>=settings.morphTargetCount) {break;}\npositionUpdated=positionUpdated+(readVector3FromRawSampler(i,index)-position)*morphTargetInfluences[i];}\n#endif\nvar worldPos=finalWorld*vec4f(positionUpdated.x,positionUpdated.y,positionUpdated.z,1.0);atomicMinFloat(&resultBuffer[settings.indexResult].minX,worldPos.x);atomicMinFloat(&resultBuffer[settings.indexResult].minY,worldPos.y);atomicMinFloat(&resultBuffer[settings.indexResult].minZ,worldPos.z);atomicMaxFloat(&resultBuffer[settings.indexResult].maxX,worldPos.x);atomicMaxFloat(&resultBuffer[settings.indexResult].maxY,worldPos.y);atomicMaxFloat(&resultBuffer[settings.indexResult].maxZ,worldPos.z);}\n";i(69610).l.ShadersStoreWGSL[l]=h;var c=i(2940);class u{constructor(e){this._computeShadersCache={},this._positionBuffers={},this._indexBuffers={},this._weightBuffers={},this._indexExtraBuffers={},this._weightExtraBuffers={},this._morphTargetInfluenceBuffers={},this._morphTargetTextureIndexBuffers={},this._ubos=[],this._uboIndex=0,this._processedMeshes=[],this._computeShaders=[],this._uniqueComputeShaders=new Set,this._resultBuffers=[],this._engine=e}_getComputeShader(e,t,i){let s;const n=e.join("\n");if(this._computeShadersCache[n])s=this._computeShadersCache[n];else{const o={positionBuffer:{group:0,binding:0},resultBuffer:{group:0,binding:1},settings:{group:0,binding:7}};t&&(o.boneSampler={group:0,binding:2},o.indexBuffer={group:0,binding:3},o.weightBuffer={group:0,binding:4},o.indexExtraBuffer={group:0,binding:5},o.weightExtraBuffer={group:0,binding:6}),i&&(o.morphTargets={group:0,binding:8},o.morphTargetInfluences={group:0,binding:9},o.morphTargetTextureIndices={group:0,binding:10}),s=new r.H(`boundingInfoCompute${t?"_bones":""}${i?"_morphs":""}`,this._engine,"boundingInfo",{bindingsMapping:o,defines:e}),this._computeShadersCache[n]=s}return s}_getUBO(){if(this._uboIndex>=this._ubos.length){const e=new a.D(this._engine);e.addFloat3("morphTargetTextureInfo",0,0,0),e.addUniform("morphTargetCount",1),e.addUniform("indexResult",1),this._ubos.push(e)}return this._ubos[this._uboIndex++]}_extractDataAndLink(e,t,i,r,n,o){let a;const l=t.getTotalVertices();if(o[t.uniqueId])a=o[t.uniqueId];else{const e=t.getVertexBuffer(i)?.getFloatData(l);a=new s.K(this._engine,Float32Array.BYTES_PER_ELEMENT*l*r),a.update(e),o[t.uniqueId]=a}e.setStorageBuffer(n,a)}_prepareStorage(e,t,i,r,n,o){let a;r[i]?a=r[i]:(a=new s.K(this._engine,Float32Array.BYTES_PER_ELEMENT*n),r[i]=a),a.update(o),e.setStorageBuffer(t,a)}async processAsync(e){await this.registerMeshListAsync(e),this.processMeshList(),await this.fetchResultsForMeshListAsync()}registerMeshListAsync(e){this._disposeForMeshList(),Array.isArray(e)||(e=[e]);let t=0;for(let i=0;i<e.length;i++){const r=e[i];if(0===r.getTotalVertices()||!r.getVertexBuffer||!r.getVertexBuffer(n.R.PositionKind))continue;this._processedMeshes.push(r);const s=r.morphTargetManager;s&&s.supportsPositions&&(t=Math.max(t,s.numTargets))}for(let e=0;e<this._processedMeshes.length;e++){const i=this._processedMeshes[e];let r=[""],s=!1;i&&i.useBones&&i.computeBonesUsingShaders&&i.skeleton&&(r.push("#define NUM_BONE_INFLUENCERS "+i.numBoneInfluencers),s=!0);const n=this._getComputeShader(r,s,!1);this._uniqueComputeShaders.add(n);const o=i.morphTargetManager;if(o&&o.supportsPositions){r=r.slice(),r.push("#define MORPHTARGETS"),r.push("#define NUM_MORPH_INFLUENCERS "+t);const e=this._getComputeShader(r,s,!0);this._uniqueComputeShaders.add(e),this._computeShaders.push([n,e])}else this._computeShaders.push([n,n]);const a=this._getUBO();a.updateUInt("indexResult",e),a.update()}return new Promise((e=>{(0,c.F)((()=>{const e=this._uniqueComputeShaders.keys();for(let t=e.next();!0!==t.done;t=e.next()){if(!t.value.isReady())return!1}return!0}),e)}))}processMeshList(){if(0===this._processedMeshes.length)return;this._uboIndex=0;const e=8*this._processedMeshes.length,t=new Float32Array(e),i=new s.K(this._engine,Float32Array.BYTES_PER_ELEMENT*e);this._resultBuffers.push(i);for(let e=0;e<this._processedMeshes.length;e++)t[8*e+0]=Number.POSITIVE_INFINITY,t[8*e+1]=Number.POSITIVE_INFINITY,t[8*e+2]=Number.POSITIVE_INFINITY,t[8*e+3]=Number.NEGATIVE_INFINITY,t[8*e+4]=Number.NEGATIVE_INFINITY,t[8*e+5]=Number.NEGATIVE_INFINITY;i.update(t);for(let e=0;e<this._processedMeshes.length;e++){const t=this._processedMeshes[e],r=t.getTotalVertices(),[s,o]=this._computeShaders[e],a=t.morphTargetManager,l=a&&a.numInfluencers>0&&a.supportsPositions,h=l?o:s;if(this._extractDataAndLink(h,t,n.R.PositionKind,3,"positionBuffer",this._positionBuffers),t&&t.useBones&&t.computeBonesUsingShaders&&t.skeleton&&t.skeleton.useTextureToStoreBoneMatrices){this._extractDataAndLink(h,t,n.R.MatricesIndicesKind,4,"indexBuffer",this._indexBuffers),this._extractDataAndLink(h,t,n.R.MatricesWeightsKind,4,"weightBuffer",this._weightBuffers);const e=t.skeleton.getTransformMatrixTexture(t);h.setTexture("boneSampler",e,!1),t.numBoneInfluencers>4&&(this._extractDataAndLink(h,t,n.R.MatricesIndicesExtraKind,4,"indexExtraBuffer",this._indexExtraBuffers),this._extractDataAndLink(h,t,n.R.MatricesWeightsExtraKind,4,"weightExtraBuffer",this._weightExtraBuffers))}const c=this._getUBO();if(l){const e=a._targetStoreTexture;h.setTexture("morphTargets",e,!1),this._prepareStorage(h,"morphTargetInfluences",t.uniqueId,this._morphTargetInfluenceBuffers,a.numInfluencers,a.influences),this._prepareStorage(h,"morphTargetTextureIndices",t.uniqueId,this._morphTargetTextureIndexBuffers,a.numInfluencers,a._morphTargetTextureIndices),c.updateFloat3("morphTargetTextureInfo",a._textureVertexStride,a._textureWidth,a._textureHeight),c.updateInt("morphTargetCount",a.numInfluencers),c.update()}h.setStorageBuffer("resultBuffer",i),h.setUniformBuffer("settings",c),h.dispatch(Math.ceil(r/256)),this._engine.flushFramebuffer()}}fetchResultsForMeshListAsync(){return new Promise((e=>{const t=[];let i=0;for(let e=0;e<this._resultBuffers.length;e++){const r=this._resultBuffers[e].getBuffer();t.push(r),i+=r.capacity}const r=new Float32Array(i/Float32Array.BYTES_PER_ELEMENT),s=o.Pq.Zero(),n=o.Pq.Zero(),a={minimum:s,maximum:n};this._engine.readFromMultipleStorageBuffers(t,0,void 0,r,!0).then((()=>{let t=0;for(let e=0;e<this._resultBuffers.length;e++){for(let i=0;i<this._processedMeshes.length;i++){const l=this._processedMeshes[i];o.Pq.FromArrayToRef(r,t+8*i,s),o.Pq.FromArrayToRef(r,t+8*i+3,n),e>0&&(s.minimizeInPlace(l.getBoundingInfo().minimum),n.maximizeInPlace(l.getBoundingInfo().maximum)),l._refreshBoundingInfoDirect(a)}t+=8*this._processedMeshes.length}for(const e of this._resultBuffers)e.dispose();this._resultBuffers=[],this._uboIndex=0,e()}))}))}_disposeCache(e){for(const t in e)e[t].dispose()}_disposeForMeshList(){for(const e of this._resultBuffers)e.dispose();this._resultBuffers=[],this._processedMeshes=[],this._computeShaders=[],this._uniqueComputeShaders=new Set}dispose(){this._disposeCache(this._positionBuffers),this._positionBuffers={},this._disposeCache(this._indexBuffers),this._indexBuffers={},this._disposeCache(this._weightBuffers),this._weightBuffers={},this._disposeCache(this._morphTargetInfluenceBuffers),this._morphTargetInfluenceBuffers={},this._disposeCache(this._morphTargetTextureIndexBuffers),this._morphTargetTextureIndexBuffers={};for(const e of this._ubos)e.dispose();this._ubos=[],this._computeShadersCache={},this._engine=void 0,this._disposeForMeshList()}}},29468:(e,t,i)=>{i.r(t),i.d(t,{shadowMapVertexShader:()=>x});var r=i(69610);i(69707),i(18959),i(27999),i(90738),i(73325);const s="sceneVertexDeclaration",n="uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\nuniform mat4 view;uniform mat4 projection;uniform vec4 vEyePosition;\n";r.l.IncludesShadersStore[s]=n;const o="meshVertexDeclaration",a="uniform mat4 world;uniform float visibility;\n";r.l.IncludesShadersStore[o]=a;const l="shadowMapVertexDeclaration",h="#include<sceneVertexDeclaration>\n#include<meshVertexDeclaration>\n";r.l.IncludesShadersStore[l]=h;i(28764),i(96467);const c="shadowMapUboDeclaration",u="layout(std140,column_major) uniform;\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";r.l.IncludesShadersStore[c]=u;const d="shadowMapVertexExtraDeclaration",p="#if SM_NORMALBIAS==1\nuniform vec3 lightDataSM;\n#endif\nuniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;varying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nvarying vec3 vPositionWSM;\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n";r.l.IncludesShadersStore[d]=p;i(71636),i(48451),i(15060),i(3298),i(3361),i(65523);const m="shadowMapVertexNormalBias",f="#if SM_NORMALBIAS==1\n#if SM_DIRECTIONINLIGHTDATA==1\nvec3 worldLightDirSM=normalize(-lightDataSM.xyz);\n#else\nvec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;vec3 worldLightDirSM=normalize(directionToLightSM);\n#endif\nfloat ndlSM=dot(vNormalW,worldLightDirSM);float sinNLSM=sqrt(1.0-ndlSM*ndlSM);float normalBiasSM=biasAndScaleSM.y*sinNLSM;worldPos.xyz-=vNormalW*normalBiasSM;\n#endif\n";r.l.IncludesShadersStore[m]=f;i(29796),i(47314);const _="shadowMapVertexShader",g="attribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef INSTANCES\nattribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;\n#endif\n#include<helperFunctions>\n#include<__decl__shadowMapVertex>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<shadowMapVertexExtraDeclaration>\n#include<clipPlaneVertexDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef UV2\nvec2 uv2Updated=uv2;\n#endif\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef NORMAL\nmat3 normWorldSM=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvec3 vNormalW=normalize(normWorldSM*normalUpdated);\n#endif\n#endif\n#include<shadowMapVertexNormalBias>\ngl_Position=viewProjection*worldPos;\n#include<shadowMapVertexMetric>\n#ifdef ALPHATEXTURE\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#endif\n#include<clipPlaneVertex>\n}";r.l.ShadersStore[_]=g;const x={name:_,shader:g}},29533:(e,t,i)=>{i.r(t),i.d(t,{iblShadowGBufferDebugPixelShaderWGSL:()=>n});const r="iblShadowGBufferDebugPixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var depthSampler: sampler;var depthTexture: texture_2d<f32>;var normalSampler: sampler;var normalTexture: texture_2d<f32>;var positionSampler: sampler;var positionTexture: texture_2d<f32>;var velocitySampler: sampler;var velocityTexture: texture_2d<f32>;uniform sizeParams: vec4f;uniform maxDepth: f32;\n#define offsetX uniforms.sizeParams.x\n#define offsetY uniforms.sizeParams.y\n#define widthScale uniforms.sizeParams.z\n#define heightScale uniforms.sizeParams.w\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f =\nvec2f((offsetX+input.vUV.x)*widthScale,(offsetY+input.vUV.y)*heightScale);var backgroundColour: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgba;var depth: vec4f=textureSample(depthTexture,depthSampler,input.vUV);var worldNormal: vec4f=textureSample(normalTexture,normalSampler,input.vUV);var worldPosition: vec4f=textureSample(positionTexture,positionSampler,input.vUV);var velocityLinear: vec4f=textureSample(velocityTexture,velocitySampler,input.vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {fragmentOutputs.color=backgroundColour;} else {if (uv.x<=0.25) {fragmentOutputs.color=vec4f(depth.rgb,1.0);} else if (uv.x<=0.5) {velocityLinear=vec4f(velocityLinear.r*0.5+0.5,velocityLinear.g*0.5+0.5,velocityLinear.b,velocityLinear.a);fragmentOutputs.color=vec4f(velocityLinear.rgb,1.0);} else if (uv.x<=0.75) {fragmentOutputs.color=vec4f(worldPosition.rgb,1.0);} else {fragmentOutputs.color=vec4f(worldNormal.rgb,1.0);}}}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},29698:(e,t,i)=>{i.r(t),i.d(t,{pickingPixelShader:()=>n});const r="pickingPixelShader",s="#if defined(INSTANCES)\nvarying vec4 vMeshID;\n#else\nuniform vec4 meshID;\n#endif\nvoid main(void) {\n#if defined(INSTANCES)\ngl_FragColor=vMeshID;\n#else\ngl_FragColor=meshID;\n#endif\n}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},29700:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererFinaliserPixelShaderWGSL:()=>n});const r="meshUVSpaceRendererFinaliserPixelShader",s="#define DISABLE_UNIFORMITY_ANALYSIS\nvarying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var maskTextureSamplerSampler: sampler;var maskTextureSampler: texture_2d<f32>;uniform textureSize: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var mask: vec4f=textureSample(maskTextureSampler,maskTextureSamplerSampler,input.vUV).rgba;if (mask.r>0.5) {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);} else {var texelSize: vec2f=4.0/uniforms.textureSize;var uv_p01: vec2f=input.vUV+ vec2f(-1.0,0.0)*texelSize;var uv_p21: vec2f=input.vUV+ vec2f(1.0,0.0)*texelSize;var uv_p10: vec2f=input.vUV+ vec2f(0.0,-1.0)*texelSize;var uv_p12: vec2f=input.vUV+ vec2f(0.0,1.0)*texelSize;var mask_p01: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p01).r;var mask_p21: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p21).r;var mask_p10: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p10).r;var mask_p12: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p12).r;var col: vec4f= vec4f(0.0,0.0,0.0,0.0);var total_weight: f32=0.0;if (mask_p01>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p01);total_weight+=1.0;}\nif (mask_p21>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p21);total_weight+=1.0;}\nif (mask_p10>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p10);total_weight+=1.0;}\nif (mask_p12>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p12);total_weight+=1.0;}\nif (total_weight>0.0) {fragmentOutputs.color=col/total_weight;} else {fragmentOutputs.color=col;}}}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},29796:(e,t,i)=>{i.r(t),i.d(t,{shadowMapVertexMetric:()=>n});const r="shadowMapVertexMetric",s="#if SM_USEDISTANCE==1\nvPositionWSM=worldPos.xyz;\n#endif\n#if SM_DEPTHTEXTURE==1\n#ifdef IS_NDC_HALF_ZRANGE\n#define BIASFACTOR 0.5\n#else\n#define BIASFACTOR 1.0\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#else\ngl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#endif\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nzSM=gl_Position.z;gl_Position.z=0.0;\n#elif SM_USEDISTANCE==0\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\nvDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n";i(69610).l.IncludesShadersStore[r]=s;const n={name:r,shader:s}},29844:(e,t,i)=>{i.d(t,{CA:()=>o,Z7:()=>l,bO:()=>a,i_:()=>n});var r=i(21856),s=i(80516);class n extends s.e{constructor(e){super("Analyzer",e)}setOptions(e){this.fftSize=e.analyzerFFTSize??r.IR.fftSize,this.minDecibels=e.analyzerMinDecibels??r.IR.minDecibels,this.maxDecibels=e.analyzerMaxDecibels??r.IR.maxDecibels,this.smoothing=e.analyzerSmoothing??r.IR.smoothing}}function o(e){return e.getSubNode("Analyzer")}function a(e,t){return o(e)?.[t]??r.IR[t]}function l(e,t,i){e.callOnSubNode("Analyzer",(e=>{e[t]=i}))}},30371:(e,t,i)=>{i.r(t),i.d(t,{rgbdDecodePixelShaderWGSL:()=>o});var r=i(69610);i(79702);const s="rgbdDecodePixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=vec4f(fromRGBD(textureSample(textureSampler,textureSamplerSampler,input.vUV)),1.0);}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},31367:(e,t,i)=>{i.d(t,{K:()=>r});class r{constructor(e,t,i=3,r){this._engine=e,this._label=r,this._engine._storageBuffers.push(this),this._create(t,i)}_create(e,t){this._bufferSize=e,this._creationFlags=t,this._buffer=this._engine.createStorageBuffer(e,t,this._label)}_rebuild(){this._create(this._bufferSize,this._creationFlags)}getBuffer(){return this._buffer}update(e,t,i){this._buffer&&this._engine.updateStorageBuffer(this._buffer,e,t,i)}read(e,t,i,r){return this._engine.readFromStorageBuffer(this._buffer,e,t,i,r)}dispose(){const e=this._engine._storageBuffers,t=e.indexOf(this);-1!==t&&(e[t]=e[e.length-1],e.pop()),this._engine._releaseBuffer(this._buffer),this._buffer=null}}},32048:(e,t,i)=>{i.r(t),i.d(t,{chromaticAberrationPixelShader:()=>n});const r="chromaticAberrationPixelShader",s="uniform sampler2D textureSampler; \nuniform float chromatic_aberration;uniform float radialIntensity;uniform vec2 direction;uniform vec2 centerPosition;uniform float screen_width;uniform float screen_height;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 centered_screen_pos=vec2(vUV.x-centerPosition.x,vUV.y-centerPosition.y);vec2 directionOfEffect=direction;if(directionOfEffect.x==0. && directionOfEffect.y==0.){directionOfEffect=normalize(centered_screen_pos);}\nfloat radius2=centered_screen_pos.x*centered_screen_pos.x\n+ centered_screen_pos.y*centered_screen_pos.y;float radius=sqrt(radius2);vec3 ref_indices=vec3(-0.3,0.0,0.3);float ref_shiftX=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.x/screen_width;float ref_shiftY=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.y/screen_height;vec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);vec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);vec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);vec4 r=texture2D(textureSampler,ref_coords_r);vec4 g=texture2D(textureSampler,ref_coords_g);vec4 b=texture2D(textureSampler,ref_coords_b);float a=clamp(r.a+g.a+b.a,0.,1.);gl_FragColor=vec4(r.r,g.g,b.b,a);}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},32083:(e,t,i)=>{i.r(t),i.d(t,{postprocessVertexShaderWGSL:()=>n});const r="postprocessVertexShader",s="attribute position: vec2<f32>;uniform scale: vec2<f32>;varying vUV: vec2<f32>;const madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.vUV=(vertexInputs.position*madd+madd)*uniforms.scale;vertexOutputs.position=vec4(vertexInputs.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},32303:(e,t,i)=>{i.r(t),i.d(t,{shadowMapVertexShaderWGSL:()=>c});var r=i(69610);i(32806),i(98900),i(76340),i(8217),i(79702),i(98327),i(6874);const s="shadowMapVertexExtraDeclaration",n="#if SM_NORMALBIAS==1\nuniform lightDataSM: vec3f;\n#endif\nuniform biasAndScaleSM: vec3f;uniform depthValuesSM: vec2f;varying vDepthMetricSM: f32;\n#if SM_USEDISTANCE==1\nvarying vPositionWSM: vec3f;\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying zSM: f32;\n#endif\n";r.l.IncludesShadersStoreWGSL[s]=n;i(77029),i(18258),i(9129),i(91277),i(65470),i(40242);const o="shadowMapVertexNormalBias",a="#if SM_NORMALBIAS==1\n#if SM_DIRECTIONINLIGHTDATA==1\nvar worldLightDirSM: vec3f=normalize(-uniforms.lightDataSM.xyz);\n#else\nvar directionToLightSM: vec3f=uniforms.lightDataSM.xyz-worldPos.xyz;var worldLightDirSM: vec3f=normalize(directionToLightSM);\n#endif\nvar ndlSM: f32=dot(vNormalW,worldLightDirSM);var sinNLSM: f32=sqrt(1.0-ndlSM*ndlSM);var normalBiasSM: f32=uniforms.biasAndScaleSM.y*sinNLSM;worldPos=vec4f(worldPos.xyz-vNormalW*normalBiasSM,worldPos.w);\n#endif\n";r.l.IncludesShadersStoreWGSL[o]=a;i(71311),i(85197);const l="shadowMapVertexShader",h="attribute position: vec3f;\n#ifdef NORMAL\nattribute normal: vec3f;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef INSTANCES\nattribute world0: vec4f;attribute world1: vec4f;attribute world2: vec4f;attribute world3: vec4f;\n#endif\n#include<helperFunctions>\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n#ifdef ALPHATEXTURE\nvarying vUV: vec2f;uniform diffuseMatrix: mat4x4f;\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#endif\n#include<shadowMapVertexExtraDeclaration>\n#include<clipPlaneVertexDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;\n#ifdef UV1\nvar uvUpdated: vec2f=input.uv;\n#endif\n#ifdef UV2\nvar uv2Updated: vec2f=input.uv2;\n#endif\n#ifdef NORMAL\nvar normalUpdated: vec3f=input.normal;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);\n#ifdef NORMAL\nvar normWorldSM: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvar vNormalW: vec3f=normalUpdated/ vec3f(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvar vNormalW: vec3f=normalize(normWorldSM*normalUpdated);\n#endif\n#endif\n#include<shadowMapVertexNormalBias>\nvertexOutputs.position=scene.viewProjection*worldPos;\n#include<shadowMapVertexMetric>\n#ifdef ALPHATEXTURE\n#ifdef UV1\nvertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef UV2\nvertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uv2Updated,1.0,0.0)).xy;\n#endif\n#endif\n#include<clipPlaneVertex>\n}";r.l.ShadersStoreWGSL[l]=h;const c={name:l,shader:h}},32646:(e,t,i)=>{i.r(t),i.d(t,{rgbdEncodePixelShader:()=>o});var r=i(69610);i(73325);const s="rgbdEncodePixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},33314:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphReceiveCustomEventBlock:()=>o});var r=i(22086),s=i(998),n=i(56552);class o extends r.i{constructor(e){super(e),this.config=e,this.initPriority=1;for(const e in this.config.eventData)this.registerDataOutput(e,this.config.eventData[e].type)}_preparePendingTasks(e){const t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId).add((t=>{Object.keys(t).forEach((i=>{this.getDataOutput(i)?.setValue(t[i],e)})),this._execute(e)}));e._setExecutionVariable(this,"_eventObserver",t)}_cancelPendingTasks(e){const t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);if(t){const i=e._getExecutionVariable(this,"_eventObserver",null);t.remove(i)}else s.S0.Warn(`FlowGraphReceiveCustomEventBlock: Missing observable for event ${this.config.eventId}`)}_executeEvent(e,t){return!0}getClassName(){return"FlowGraphReceiveCustomEventBlock"}}(0,n.Y5)("FlowGraphReceiveCustomEventBlock",o)},33495:(e,t,i)=>{i.r(t),i.d(t,{boundingBoxRendererPixelShader:()=>l});var r=i(69610);const s="boundingBoxRendererFragmentDeclaration",n="uniform vec4 color;\n";r.l.IncludesShadersStore[s]=n;i(66566);const o="boundingBoxRendererPixelShader",a="#include<__decl__boundingBoxRendererFragment>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStore[o]=a;const l={name:o,shader:a}},33570:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererFinaliserVertexShaderWGSL:()=>n});const r="meshUVSpaceRendererFinaliserVertexShader",s="attribute position: vec3f;attribute uv: vec2f;uniform worldViewProjection: mat4x4f;varying vUV: vec2f;@vertex\nfn main(input : VertexInputs)->FragmentInputs {vertexOutputs.position=uniforms.worldViewProjection* vec4f(input.position,1.0);vertexOutputs.positionvUV=input.uv;}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},33723:(e,t,i)=>{var r=i(69610);i(98327);const s="backgroundUboDeclaration",n="uniform vPrimaryColor: vec4f;uniform vPrimaryColorShadow: vec4f;uniform vDiffuseInfos: vec2f;uniform vReflectionInfos: vec2f;uniform diffuseMatrix: mat4x4f;uniform reflectionMatrix: mat4x4f;uniform vReflectionMicrosurfaceInfos: vec3f;uniform fFovMultiplier: f32;uniform pointSize: f32;uniform shadowLevel: f32;uniform alpha: f32;uniform vBackgroundCenter: vec3f;uniform vReflectionControl: vec4f;uniform projectedGroundInfos: vec2f;\n#include<sceneUboDeclaration>\n";r.l.IncludesShadersStoreWGSL[s]=n},34294:(e,t,i)=>{i.d(t,{CubeTexture:()=>d});var r=i(75524),s=i(79259),n=i(998),o=i(79923),a=i(56526),l=i(7481),h=i(56552),c=i(99848),u=i(26877);i(69195);class d extends a.t{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(o.uq.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let r="";return e.forEach((e=>r+=e)),new d(r,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,r=!0){const s=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;const n=new d(e,t,null,!1,null,null,null,void 0,!0,i,r);return t.useDelayedTextureLoading=s,n}constructor(e,t,i=null,r=!1,s=null,n=null,a=null,h=5,u=!1,d=null,p=!1,m=.8,f=0,_,g){super(t),this.onLoadObservable=new c.cP,this.boundingBoxPosition=o.Pq.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this._textureMatrixRefraction=new o.uq,this._buffer=null,this.name=e,this.url=e,this._noMipmap=r,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=o.uq.Identity(),this.coordinatesMode=l.g.CUBIC_MODE;let x=null,v=null;null===i||Array.isArray(i)?(this._noMipmap=r,this._format=h,this._createPolynomials=p,x=i,this._loaderOptions=_,this._useSRGBBuffer=g,this._lodScale=m,this._lodOffset=f):(x=i.extensions??null,this._noMipmap=i.noMipmap??!1,s=i.files??null,v=i.buffer??null,this._format=i.format??5,u=i.prefiltered??!1,d=i.forcedExtension??null,this._createPolynomials=i.createPolynomials??!1,this._lodScale=i.lodScale??.8,this._lodOffset=i.lodOffset??0,this._loaderOptions=i.loaderOptions,this._useSRGBBuffer=i.useSRGBBuffer,n=i.onLoad??null,a=i.onError??null),(e||s)&&this.updateURL(e,d,n,u,a,x,this.getScene()?.useDelayedTextureLoading,s,v)}getClassName(){return"CubeTexture"}updateURL(e,t=null,i=null,r=!1,s=null,n=null,o=!1,a=null,l=null){this.name&&!this.name.startsWith("data:")||(this.name=e),this.url=e,t&&(this._forcedExtension=t);const h=e.lastIndexOf("."),c=t||(h>-1?e.substring(h).toLowerCase():""),u=0===c.indexOf(".dds"),d=0===c.indexOf(".env"),p=0===c.indexOf(".basis");if(d?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=r,r&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),a)this._files=a;else if(p||d||u||n||(n=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,n){for(let t=0;t<n.length;t++)this._files.push(e+n[t]);this._extensions=n}this._buffer=l,o?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=s):this._loadTexture(i,s)}delayLoad(e){4===this.delayLoadState&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){if(e.updateFlag===this._textureMatrix.updateFlag)return;if(e.isIdentity()!==this._textureMatrix.isIdentity()&&this.getScene()?.markAllMaterialsAsDirty(1,(e=>-1!==e.getActiveTextures().indexOf(this))),this._textureMatrix=e,!this.getScene()?.useRightHandedSystem)return;const t=o.AA.Vector3[0],i=o.AA.Quaternion[0],r=o.AA.Vector3[1];this._textureMatrix.decompose(t,i,r),i.z*=-1,i.w*=-1,o.uq.ComposeToRef(t,i,r,this._textureMatrixRefraction)}getRefractionTextureMatrix(){return this.getScene()?.useRightHandedSystem?this._textureMatrixRefraction:this._textureMatrix}_loadTexture(e=null,t=null){const i=this.getScene(),r=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);const s=()=>{this.onLoadObservable.notifyObservers(this),r&&(r.dispose(),this.getScene()?.markAllMaterialsAsDirty(1)),e&&e()},o=(e,i)=>{this._loadingError=!0,this._errorObject={message:e,exception:i},t&&t(e,i),l.g.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?n.S0.SetImmediate((()=>s())):this._texture.onLoadedObservable.add((()=>s())):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,i,this._lodScale,this._lodOffset,e,o,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,i,this._files,this._noMipmap,e,o,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer,this._buffer),this._texture?.onLoadedObservable.add((()=>this.onLoadObservable.notifyObservers(this))))}static Parse(e,t,i){const r=u.p.Parse((()=>{let r=!1;return e.prefiltered&&(r=e.prefiltered),new d(i+(e.url??e.name),t,e.extensions,!1,e.files||null,null,null,void 0,r,e.forcedExtension)}),e,t);if(e.boundingBoxPosition&&(r.boundingBoxPosition=o.Pq.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(r.boundingBoxSize=o.Pq.FromArray(e.boundingBoxSize)),e.animations)for(let t=0;t<e.animations.length;t++){const i=e.animations[t],s=(0,h.n9)("BABYLON.Animation");s&&r.animations.push(s.Parse(i))}return r}clone(){let e=0;const t=u.p.Clone((()=>{const t=new d(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=t.uniqueId,t}),this);return t.uniqueId=e,t}}(0,r.Cg)([(0,s.lK)()],d.prototype,"url",void 0),(0,r.Cg)([(0,s.P_)()],d.prototype,"boundingBoxPosition",void 0),(0,r.Cg)([(0,s.P_)()],d.prototype,"boundingBoxSize",null),(0,r.Cg)([(0,s.lK)("rotationY")],d.prototype,"rotationY",null),(0,r.Cg)([(0,s.lK)("files")],d.prototype,"_files",void 0),(0,r.Cg)([(0,s.lK)("forcedExtension")],d.prototype,"_forcedExtension",void 0),(0,r.Cg)([(0,s.lK)("extensions")],d.prototype,"_extensions",void 0),(0,r.Cg)([(0,s.GG)("textureMatrix")],d.prototype,"_textureMatrix",void 0),(0,r.Cg)([(0,s.GG)("textureMatrixRefraction")],d.prototype,"_textureMatrixRefraction",void 0),l.g._CubeTextureParser=d.Parse,(0,h.Y5)("BABYLON.CubeTexture",d)},34898:(e,t,i)=>{i.d(t,{t:()=>o});var r=i(26846),s=i(56744),n=i(77930);class o extends r.Ui{constructor(e,t){super(e,t,3),this._analyzer=null}get analyzer(){return this._analyzer??(this._analyzer=new n.sQ(this._subGraph))}get volume(){return(0,s.pN)(this._subGraph,"volume")}set volume(e){const t=(0,s.sf)(this._subGraph);if(!t)throw new Error("No volume subnode");t.volume=e}dispose(){super.dispose(),this._analyzer?.dispose(),this._analyzer=null,this._subGraph.dispose()}}},35256:(e,t,i)=>{i.r(t),i.d(t,{layerPixelShader:()=>o});var r=i(69610);i(73325);const s="layerPixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec4 color;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);\n#if defined(CONVERT_TO_GAMMA)\nbaseColor.rgb=toGammaSpace(baseColor.rgb);\n#elif defined(CONVERT_TO_LINEAR)\nbaseColor.rgb=toLinearSpace(baseColor.rgb);\n#endif\n#ifdef ALPHATEST\nif (baseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=baseColor*color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},35381:(e,t,i)=>{i.r(t),i.d(t,{sharpenPixelShaderWGSL:()=>n});const r="sharpenPixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;uniform sharpnessAmounts: vec2f;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var onePixel: vec2f= vec2f(1.0,1.0)/uniforms.screenSize;var color: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);var edgeDetection: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(0,-1)) +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(-1,0)) +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(1,0)) +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(0,1)) -\ncolor*4.0;fragmentOutputs.color=max(vec4f(color.rgb*uniforms.sharpnessAmounts.y,color.a)-(uniforms.sharpnessAmounts.x* vec4f(edgeDetection.rgb,0)),vec4f(0.));}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},35616:(e,t,i)=>{i.r(t),i.d(t,{backgroundVertexShaderWGSL:()=>o});var r=i(69610);i(33723),i(79702),i(32806),i(98900),i(44559),i(77029),i(75757),i(3925),i(93226),i(91277),i(65470),i(40242),i(85197),i(59013),i(79456),i(81482);const s="backgroundVertexShader",n="#include<backgroundUboDeclaration>\n#include<helperFunctions>\nattribute position: vec3f;\n#ifdef NORMAL\nattribute normal: vec3f;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\nvarying vPositionW: vec3f;\n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#endif\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#ifdef MAINUV1\nvarying vMainUV1: vec2f;\n#endif\n#ifdef MAINUV2\nvarying vMainUV2: vec2f;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nvarying vDiffuseUV: vec2f;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<lightVxUboDeclaration>[0..maxSimultaneousLights]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#ifdef REFLECTIONMAP_SKYBOX\nvertexOutputs.vPositionUVW=input.position;\n#endif\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*finalWorld* vec4f(input.position,1.0);} else {vertexOutputs.position=scene.viewProjectionR*finalWorld* vec4f(input.position,1.0);}\n#else\nvertexOutputs.position=scene.viewProjection*finalWorld* vec4f(input.position,1.0);\n#endif\nvar worldPos: vec4f=finalWorld* vec4f(input.position,1.0);vertexOutputs.vPositionW= worldPos.xyz;\n#ifdef NORMAL\nvar normalWorld: mat3x3f=mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvertexOutputs.vNormalW=normalize(normalWorld*input.normal);\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvertexOutputs.vDirectionW=normalize((finalWorld*vec4f(input.position,0.0)).xyz);\n#ifdef EQUIRECTANGULAR_RELFECTION_FOV\nvar screenToWorld: mat3x3f=inverseMat3( mat3x3f(finalWorld*scene.viewProjection));var segment: vec3f=mix(vertexOutputs.vDirectionW,screenToWorld* vec3f(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vertexOutputs.vDirectionW=normalize(segment);} else {vertexOutputs.vDirectionW=normalize(vertexOutputs.vDirectionW+(vertexOutputs.vDirectionW-segment));}\n#endif\n#endif\n#ifndef UV1\nvar uv: vec2f=vec2f(0.,0.);\n#else\nvar uv=input.uv;\n#endif\n#ifndef UV2\nvar uv2: vec2f=vec2f(0.,0.);\n#else\nvar uv2=input.uv2;\n#endif\n#ifdef MAINUV1\nvertexOutputs.vMainUV1=uv;\n#endif\n#ifdef MAINUV2\nvertexOutputs.vMainUV2=uv2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nif (uniforms.vDiffuseInfos.x==0.)\n{vertexOutputs.vDiffuseUV= (uniforms.diffuseMatrix* vec4f(uv,1.0,0.0)).xy;}\nelse\n{vertexOutputs.vDiffuseUV= (uniforms.diffuseMatrix* vec4f(uv2,1.0,0.0)).xy;}\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#ifdef VERTEXCOLOR\nvertexOutputs.vColor=vertexInputs.color;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},37614:(e,t,i)=>{i.r(t),i.d(t,{imageProcessingPixelShaderWGSL:()=>o});var r=i(69610);i(16205),i(79702),i(88996);const s="imageProcessingPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#include<imageProcessingDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var result: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);\n#ifdef IMAGEPROCESSING\n#ifndef FROMLINEARSPACE\nresult=vec4f(toLinearSpaceVec3(result.rgb),result.a);\n#endif\nresult=applyImageProcessing(result);\n#else\n#ifdef FROMLINEARSPACE\nresult=applyImageProcessing(result);\n#endif\n#endif\nfragmentOutputs.color=result;}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},37670:(e,t,i)=>{i.r(t),i.d(t,{colorCorrectionPixelShader:()=>n});const r="colorCorrectionPixelShader",s="uniform sampler2D textureSampler; \nuniform sampler2D colorTable; \nvarying vec2 vUV;const float SLICE_COUNT=16.0; \n#define inline\nvec4 sampleAs3DTexture(sampler2D textureSampler,vec3 uv,float width) {float sliceSize=1.0/width; \nfloat slicePixelSize=sliceSize/width; \nfloat sliceInnerSize=slicePixelSize*(width-1.0); \nfloat zSlice0=min(floor(uv.z*width),width-1.0);float zSlice1=min(zSlice0+1.0,width-1.0);float xOffset=slicePixelSize*0.5+uv.x*sliceInnerSize;float s0=xOffset+(zSlice0*sliceSize);float s1=xOffset+(zSlice1*sliceSize);vec4 slice0Color=texture2D(textureSampler,vec2(s0,uv.y));vec4 slice1Color=texture2D(textureSampler,vec2(s1,uv.y));float zOffset=mod(uv.z*width,1.0);vec4 result=mix(slice0Color,slice1Color,zOffset);return result;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 screen_color=texture2D(textureSampler,vUV);gl_FragColor=sampleAs3DTexture(colorTable,screen_color.rgb,SLICE_COUNT);}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},37706:(e,t,i)=>{i.r(t),i.d(t,{taaPixelShaderWGSL:()=>n});const r="taaPixelShader",s="var textureSampler: texture_2d<f32>;var historySampler: texture_2d<f32>;uniform factor: f32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {let c=textureLoad(textureSampler,vec2<i32>(fragmentInputs.position.xy),0);let h=textureLoad(historySampler,vec2<i32>(fragmentInputs.position.xy),0);fragmentOutputs.color= mix(h,c,uniforms.factor);}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},38574:(e,t,i)=>{i.r(t),i.d(t,{geometryPixelShaderWGSL:()=>o});var r=i(69610);i(39759),i(15697),i(91258),i(79702),i(97715),i(20727);const s="geometryPixelShader",n="#ifdef BUMP\nvarying vWorldView0: vec4f;varying vWorldView1: vec4f;varying vWorldView2: vec4f;varying vWorldView3: vec4f;varying vNormalW: vec3f;\n#else\nvarying vNormalV: vec3f;\n#endif\nvarying vViewPos: vec4f;\n#if defined(POSITION) || defined(BUMP)\nvarying vPositionW: vec3f;\n#endif\n#if defined(VELOCITY) || defined(VELOCITY_LINEAR)\nvarying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;\n#endif\n#ifdef NEED_UV\nvarying vUV: vec2f;\n#endif\n#ifdef BUMP\nuniform vBumpInfos: vec3f;uniform vTangentSpaceParams: vec2f;\n#endif\n#if defined(REFLECTIVITY)\n#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nvar reflectivitySamplerSampler: sampler;var reflectivitySampler: texture_2d<f32>;varying vReflectivityUV: vec2f;\n#endif\n#ifdef ALBEDOTEXTURE\nvarying vAlbedoUV: vec2f;var albedoSamplerSampler: sampler;var albedoSampler: texture_2d<f32>;\n#endif\n#ifdef REFLECTIVITYCOLOR\nuniform reflectivityColor: vec3f;\n#endif\n#ifdef ALBEDOCOLOR\nuniform albedoColor: vec3f;\n#endif\n#ifdef METALLIC\nuniform metallic: f32;\n#endif\n#if defined(ROUGHNESS) || defined(GLOSSINESS)\nuniform glossiness: f32;\n#endif\n#endif\n#if defined(ALPHATEST) && defined(NEED_UV)\nvar diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<helperFunctions>\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (textureSample(diffuseSampler,diffuseSamplerSampler,input.vUV).a<0.4) {discard;}\n#endif\nvar normalOutput: vec3f;\n#ifdef BUMP\nvar normalW: vec3f=normalize(input.vNormalW);\n#include<bumpFragment>\n#ifdef NORMAL_WORLDSPACE\nnormalOutput=normalW;\n#else\nnormalOutput=normalize( (mat4x4f(input.vWorldView0,input.vWorldView1,input.vWorldView2,input.vWorldView3)* vec4f(normalW,0.0)).xyz);\n#endif\n#else\nnormalOutput=normalize(input.vNormalV);\n#endif\n#ifdef ENCODE_NORMAL\nnormalOutput=normalOutput*0.5+0.5;\n#endif\nvar fragData: array<vec4<f32>,SCENE_MRT_COUNT>;\n#ifdef DEPTH\nfragData[DEPTH_INDEX]=vec4f(input.vViewPos.z/input.vViewPos.w,0.0,0.0,1.0);\n#endif\n#ifdef NORMAL\nfragData[NORMAL_INDEX]=vec4f(normalOutput,1.0);\n#endif\n#ifdef SCREENSPACE_DEPTH\nfragData[SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,1.0);\n#endif\n#ifdef POSITION\nfragData[POSITION_INDEX]= vec4f(input.vPositionW,1.0);\n#endif\n#ifdef VELOCITY\nvar a: vec2f=(input.vCurrentPosition.xy/input.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(input.vPreviousPosition.xy/input.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[VELOCITY_INDEX]= vec4f(velocity,0.0,1.0);\n#endif\n#ifdef VELOCITY_LINEAR\nvar velocity : vec2f=vec2f(0.5)*((input.vPreviousPosition.xy /\ninput.vPreviousPosition.w) -\n(input.vCurrentPosition.xy /\ninput.vCurrentPosition.w));fragData[VELOCITY_LINEAR_INDEX]=vec4f(velocity,0.0,1.0);\n#endif\n#ifdef REFLECTIVITY\nvar reflectivity: vec4f= vec4f(0.0,0.0,0.0,1.0);\n#ifdef METALLICWORKFLOW\nvar metal: f32=1.0;var roughness: f32=1.0;\n#ifdef ORMTEXTURE\nmetal*=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vReflectivityUV).b;roughness*=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vReflectivityUV).g;\n#endif\n#ifdef METALLIC\nmetal*=uniforms.metallic;\n#endif\n#ifdef ROUGHNESS\nroughness*=(1.0-uniforms.glossiness); \n#endif\nreflectivity=vec4f(reflectivity.rgb,reflectivity.a-roughness);var color: vec3f= vec3f(1.0);\n#ifdef ALBEDOTEXTURE\ncolor=textureSample(albedoSampler,albedoSamplerSampler,input.vAlbedoUV).rgb;\n#ifdef GAMMAALBEDO\ncolor=toLinearSpaceVec4(color);\n#endif\n#endif\n#ifdef ALBEDOCOLOR\ncolor*=uniforms.albedoColor.xyz;\n#endif\nreflectivity=vec4f(mix( vec3f(0.04),color,metal),reflectivity.a);\n#else\n#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nreflectivity=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vReflectivityUV);\n#ifdef GAMMAREFLECTIVITYTEXTURE\nreflectivity=vec4f(toLinearSpaceVec3(reflectivity.rgb),reflectivity.a);\n#endif\n#else \n#ifdef REFLECTIVITYCOLOR\nreflectivity=vec4f(toLinearSpaceVec3(uniforms.reflectivityColor.xyz),1.0);\n#endif\n#endif\n#ifdef GLOSSINESSS\nreflectivity=vec4f(reflectivity.rgb,reflectivity.a*glossiness); \n#endif\n#endif\nfragData[REFLECTIVITY_INDEX]=reflectivity;\n#endif\n#if SCENE_MRT_COUNT>0\nfragmentOutputs.fragData0=fragData[0];\n#endif\n#if SCENE_MRT_COUNT>1\nfragmentOutputs.fragData1=fragData[1];\n#endif\n#if SCENE_MRT_COUNT>2\nfragmentOutputs.fragData2=fragData[2];\n#endif\n#if SCENE_MRT_COUNT>3\nfragmentOutputs.fragData3=fragData[3];\n#endif\n#if SCENE_MRT_COUNT>4\nfragmentOutputs.fragData4=fragData[4];\n#endif\n#if SCENE_MRT_COUNT>5\nfragmentOutputs.fragData5=fragData[5];\n#endif\n#if SCENE_MRT_COUNT>6\nfragmentOutputs.fragData6=fragData[6];\n#endif\n#if SCENE_MRT_COUNT>7\nfragmentOutputs.fragData7=fragData[7];\n#endif\n}\n";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},38939:(e,t,i)=>{i.r(t),i.d(t,{depthPixelShaderWGSL:()=>o});var r=i(69610);i(39759),i(5543),i(97715);const s="depthPixelShader",n="#ifdef ALPHATEST\nvarying vUV: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#include<clipPlaneFragmentDeclaration>\nvarying vDepthMetric: f32;\n#ifdef PACKED\n#include<packingFunctions>\n#endif\n#ifdef STORE_CAMERASPACE_Z\nvarying vViewPos: vec4f;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (textureSample(diffuseSampler,diffuseSamplerSampler,input.vUV).a<0.4) {discard;}\n#endif\n#ifdef STORE_CAMERASPACE_Z\n#ifdef PACKED\nfragmentOutputs.color=pack(input.vViewPos.z);\n#else\nfragmentOutputs.color= vec4f(input.vViewPos.z,0.0,0.0,1.0);\n#endif\n#else\n#ifdef NONLINEARDEPTH\n#ifdef PACKED\nfragmentOutputs.color=pack(input.position.z);\n#else\nfragmentOutputs.color= vec4f(input.position.z,0.0,0.0,0.0);\n#endif\n#else\n#ifdef PACKED\nfragmentOutputs.color=pack(input.vDepthMetric);\n#else\nfragmentOutputs.color= vec4f(input.vDepthMetric,0.0,0.0,1.0);\n#endif\n#endif\n#endif\n}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},39107:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelGridPixelShaderWGSL:()=>n});const r="iblVoxelGridPixelShader",s="varying vNormalizedPosition: vec3f;uniform nearPlane: f32;uniform farPlane: f32;uniform stepSize: f32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var normPos: vec3f=input.vNormalizedPosition.xyz;if (normPos.z<uniforms.nearPlane || normPos.z>uniforms.farPlane) {discard;}\nfragmentOutputs.fragData0=select(vec4f(0.0),vec4f(1.0),normPos.z<uniforms.nearPlane+uniforms.stepSize);fragmentOutputs.fragData1=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+uniforms.stepSize && normPos.z<uniforms.nearPlane+2.0*uniforms.stepSize);fragmentOutputs.fragData2=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+2.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+3.0*uniforms.stepSize);fragmentOutputs.fragData3=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+3.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+4.0*uniforms.stepSize);\n#if MAX_DRAW_BUFFERS>4\nfragmentOutputs.fragData4=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+4.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+5.0*uniforms.stepSize);fragmentOutputs.fragData5=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+5.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+6.0*uniforms.stepSize);fragmentOutputs.fragData6=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+6.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+7.0*uniforms.stepSize);fragmentOutputs.fragData7=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+7.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+8.0*uniforms.stepSize);\n#endif\n}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},39174:(e,t,i)=>{i.r(t),i.d(t,{pbrVertexShaderWGSL:()=>o});var r=i(69610);i(34035),i(1008),i(41861),i(79702),i(32806),i(98900),i(44559),i(37769),i(89277),i(45978),i(97777),i(77029),i(75757),i(3925),i(76340),i(8217),i(93226),i(18258),i(9129),i(91277),i(65470),i(40242),i(47033),i(20774),i(52231),i(87921),i(85197),i(59013),i(79456),i(820),i(81482);const s="pbrVertexShader",n="#include<pbrUboDeclaration>\n#define CUSTOM_VERTEX_BEGIN\nattribute position: vec3f;\n#ifdef NORMAL\nattribute normal: vec3f;\n#endif\n#ifdef TANGENT\nattribute tangent: vec4f;\n#endif\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef VERTEXCOLOR\nattribute color: vec4f;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BASEWEIGHT,_VARYINGNAME_,BaseWeight)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)\n#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\n#ifdef CLEARCOAT\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)\n#endif\nvarying vPositionW: vec3f;\n#if DEBUGMODE>0\nvarying vClipSpacePosition: vec4f;\n#endif\n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vEnvironmentIrradiance: vec3f;\n#include<harmonicsFunctions>\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vColor: vec4f;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<lightVxUboDeclaration>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar positionUpdated: vec3f=vertexInputs.position;\n#ifdef NORMAL\nvar normalUpdated: vec3f=vertexInputs.normal;\n#endif\n#ifdef TANGENT\nvar tangentUpdated: vec4f=vertexInputs.tangent;\n#endif\n#ifdef UV1\nvar uvUpdated: vec2f=vertexInputs.uv;\n#endif\n#ifdef UV2\nvar uv2Updated: vec2f=vertexInputs.uv2;\n#endif\n#ifdef VERTEXCOLOR\nvar colorUpdated: vec4f=vertexInputs.color;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvertexOutputs.vPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*vec4f(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);vertexOutputs.vPositionW= worldPos.xyz;\n#ifdef PREPASS\n#include<prePassVertex>\n#endif\n#ifdef NORMAL\nvar normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvertexOutputs.vNormalW=normalUpdated/ vec3f(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vertexOutputs.vNormalW=normalize(normalWorld*vertexOutputs.vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvar reflectionVector: vec3f= (uniforms.reflectionMatrix* vec4f(vertexOutputs.vNormalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\nvertexOutputs.vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*worldPos;} else {vertexOutputs.position=scene.viewProjectionR*worldPos;}\n#else\nvertexOutputs.position=scene.viewProjection*worldPos;\n#endif\n#if DEBUGMODE>0\nvertexOutputs.vClipSpacePosition=vertexOutputs.position;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvertexOutputs.vDirectionW=normalize((finalWorld*vec4f(positionUpdated,0.0)).xyz);\n#endif\n#ifndef UV1\nvar uvUpdated: vec2f= vec2f(0.,0.);\n#endif\n#ifdef MAINUV1\nvertexOutputs.vMainUV1=uvUpdated;\n#endif\n#ifndef UV2\nvar uv2Updated: vec2f= vec2f(0.,0.);\n#endif\n#ifdef MAINUV2\nvertexOutputs.vMainUV2=uv2Updated;\n#endif\n#include<uvVariableDeclaration>[3..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BASEWEIGHT,_VARYINGNAME_,BaseWeight,_MATRIXNAME_,baseWeight,_INFONAME_,BaseWeightInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#ifdef CLEARCOAT\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)\n#endif\n#ifdef SHEEN\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)\n#endif\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},39336:(e,t,i)=>{i.r(t),i.d(t,{bloomMergePixelShader:()=>n});const r="bloomMergePixelShader",s="uniform sampler2D textureSampler;uniform sampler2D bloomBlur;varying vec2 vUV;uniform float bloomWeight;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(textureSampler,vUV);vec3 blurred=texture2D(bloomBlur,vUV).rgb;gl_FragColor.rgb=gl_FragColor.rgb+(blurred.rgb*bloomWeight); }\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},39477:(e,t,i)=>{i.d(t,{s:()=>s});var r=i(34898);class s extends r.t{constructor(e,t){super(e,t)}}},41199:(e,t,i)=>{i.d(t,{w:()=>s});var r=i(76237);class s{constructor(e,t,i){if(this._autoUpdate=!0,this._lastUpdateTime=0,this.minUpdateTime=0,!t)return;this.minUpdateTime=i;const s=()=>{if(!this._autoUpdate)return;let t=!1;if(0<this.minUpdateTime){const e=r.j.Now;this._lastUpdateTime&&e-this._lastUpdateTime<this.minUpdateTime&&(t=!0),this._lastUpdateTime=e}t||e.update(),requestAnimationFrame(s)};requestAnimationFrame(s)}dispose(){this._autoUpdate=!1}}},41288:(e,t,i)=>{i.r(t),i.d(t,{glowMapMergeVertexShader:()=>n});const r="glowMapMergeVertexShader",s="attribute vec2 position;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=position*madd+madd;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},41665:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphInterpolationBlock:()=>a});var r=i(71294),s=i(4720),n=i(7540),o=i(56552);class a extends r.e{constructor(e={}){super(e),this.keyFrames=[];const t="string"==typeof e?.animationType?(0,s.Yd)(e.animationType):(0,s.aZ)(e?.animationType??0),i=e?.keyFramesCount??1,r=this.registerDataInput("duration_0",s.Es,0),n=this.registerDataInput("value_0",t);this.keyFrames.push({duration:r,value:n});for(let r=1;r<i+1;r++){const n=this.registerDataInput(`duration_${r}`,s.Es,r===i?e.duration:void 0),o=this.registerDataInput(`value_${r}`,t);this.keyFrames.push({duration:n,value:o})}this.initialValue=this.keyFrames[0].value,this.endValue=this.keyFrames[i].value,this.easingFunction=this.registerDataInput("easingFunction",s.Vv),this.animation=this.registerDataOutput("animation",s.Vv),this.propertyName=this.registerDataInput("propertyName",s.Vv,e?.propertyName),this.customBuildAnimation=this.registerDataInput("customBuildAnimation",s.Vv)}_updateOutputs(e){const t=e._getGlobalContextVariable("interpolationAnimations",[]),i=this.propertyName.getValue(e),r=this.easingFunction.getValue(e),s=this._createAnimation(e,i,r);if(this.animation.setValue(s,e),Array.isArray(s))for(const e of s)t.push(e.uniqueId);else t.push(s.uniqueId);e._setGlobalContextVariable("interpolationAnimations",t)}_createAnimation(e,t,i){const r=this.initialValue.richType,s=[],o=this.initialValue.getValue(e)||r.defaultValue;s.push({frame:0,value:o});const a=this.config?.numberOfKeyFrames??1;for(let t=1;t<a+1;t++){const i=this.keyFrames[t].duration?.getValue(e);let n=this.keyFrames[t].value?.getValue(e);t===a-1&&(n=n||r.defaultValue),void 0!==i&&n&&s.push({frame:60*i,value:n})}const l=this.customBuildAnimation.getValue(e);if(l)return l()(s,60,r.animationType,i);if("string"==typeof t){const e=n.X5.CreateAnimation(t,r.animationType,60,i);return e.setKeys(s),[e]}return t.map((e=>{const t=n.X5.CreateAnimation(e,r.animationType,60,i);return t.setKeys(s),t}))}getClassName(){return"FlowGraphInterpolationBlock"}}(0,o.Y5)("FlowGraphInterpolationBlock",a)},42319:(e,t,i)=>{i.r(t),i.d(t,{defaultPixelShader:()=>l});var r=i(69610);i(48109);const s="defaultFragmentDeclaration",n="uniform vec4 vEyePosition;uniform vec4 vDiffuseColor;uniform vec4 vSpecularColor;uniform vec3 vEmissiveColor;uniform vec3 vAmbientColor;uniform float visibility;\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY \nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;\n#endif\n#ifdef ALPHATEST\nuniform float alphaCutOff;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\n#ifndef REFRACTIONMAP_3D\nuniform mat4 refractionMatrix;\n#endif\n#ifdef REFRACTIONFRESNEL\nuniform vec4 refractionLeftColor;uniform vec4 refractionRightColor;\n#endif\n#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)\nuniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; \n#endif\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\n#endif\n#ifdef DIFFUSEFRESNEL\nuniform vec4 diffuseLeftColor;uniform vec4 diffuseRightColor;\n#endif\n#ifdef OPACITYFRESNEL\nuniform vec4 opacityParts;\n#endif\n#ifdef EMISSIVEFRESNEL\nuniform vec4 emissiveLeftColor;uniform vec4 emissiveRightColor;\n#endif\n#if defined(REFLECTION) || (defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED))\nuniform vec2 vReflectionInfos;\n#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)\nuniform mat4 reflectionMatrix;\n#endif\n#ifndef REFLECTIONMAP_SKYBOX\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; \n#endif\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 reflectionLeftColor;uniform vec4 reflectionRightColor;\n#endif\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\n#endif\n#include<decalFragmentDeclaration>\n#define ADDITIONAL_FRAGMENT_DECLARATION\n";r.l.IncludesShadersStore[s]=n;i(81438),i(42694),i(89986),i(4980),i(73325),i(92270),i(22448),i(21962),i(66812),i(63022),i(51339),i(18223),i(89392),i(64017),i(17494),i(8269),i(6194),i(34581),i(7806),i(7412),i(27018),i(11205),i(1037),i(37256),i(29741),i(2360),i(94436);const o="defaultPixelShader",a="#define CUSTOM_FRAGMENT_EXTENSION\n#include<__decl__defaultFragment>\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\n#include<oitDeclaration>\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#include<helperFunctions>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef REFRACTION\n#ifdef REFRACTIONMAP_3D\nuniform samplerCube refractionCubeSampler;\n#else\nuniform sampler2D refraction2DSampler;\n#endif\n#endif\n#if defined(SPECULARTERM)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)\n#endif\n#include<fresnelFunction>\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nuniform samplerCube reflectionCubeSampler;\n#else\nuniform sampler2D reflection2DSampler;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#include<imageProcessingDeclaration>\n#include<imageProcessingFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);vec4 baseColor=vec4(1.,1.,1.,1.);vec3 diffuseColor=vDiffuseColor.rgb;float alpha=vDiffuseColor.a;\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));\n#endif\n#include<bumpFragment>\n#ifdef TWOSIDEDLIGHTING\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n#ifdef DIFFUSE\nbaseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);\n#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)\nif (baseColor.a<alphaCutOff)\ndiscard;\n#endif\n#ifdef ALPHAFROMDIFFUSE\nalpha*=baseColor.a;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\nbaseColor.rgb*=vDiffuseInfos.y;\n#endif\n#if defined(DECAL) && !defined(DECAL_AFTER_DETAIL)\nvec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);\n#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)\n#endif\n#include<depthPrePass>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nbaseColor.rgb*=vColor.rgb;\n#endif\n#ifdef DETAIL\nbaseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);\n#endif\n#if defined(DECAL) && defined(DECAL_AFTER_DETAIL)\nvec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);\n#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE\nvec3 baseAmbientColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nbaseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\nfloat glossiness=vSpecularColor.a;vec3 specularColor=vSpecularColor.rgb;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\nvec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);specularColor=specularMapColor.rgb;\n#ifdef GLOSSINESS\nglossiness=glossiness*specularMapColor.a;\n#endif\n#endif\n#endif\nvec3 diffuseBase=vec3(0.,0.,0.);lightingInfo info;\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\nfloat shadow=1.;float aggShadow=0.;float numLights=0.;\n#ifdef LIGHTMAP\nvec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor.rgb=fromRGBD(lightmapColor);\n#endif\nlightmapColor.rgb*=vLightmapInfos.y;\n#endif\n#include<lightFragment>[0..maxSimultaneousLights]\naggShadow=aggShadow/numLights;vec4 refractionColor=vec4(0.,0.,0.,1.);\n#ifdef REFRACTION\nvec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));\n#ifdef REFRACTIONMAP_3D\n#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;vec4 refractionLookup=textureCube(refractionCubeSampler,refractionVector);if (dot(refractionVector,viewDirectionW)<1.0) {refractionColor=refractionLookup;}\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;refractionColor=texture2D(refraction2DSampler,refractionCoords);\n#endif\n#ifdef RGBDREFRACTION\nrefractionColor.rgb=fromRGBD(refractionColor);\n#endif\n#ifdef IS_REFRACTION_LINEAR\nrefractionColor.rgb=toGammaSpace(refractionColor.rgb);\n#endif\nrefractionColor.rgb*=vRefractionInfos.x;\n#endif\nvec4 reflectionColor=vec4(0.,0.,0.,1.);\n#ifdef REFLECTION\nvec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nvReflectionUVW.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\n#ifdef ROUGHNESS\nfloat bias=vReflectionInfos.y;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\n#ifdef GLOSSINESS\nbias*=(1.0-specularMapColor.a);\n#endif\n#endif\n#endif\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);\n#else\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);\n#endif\n#else\nvec2 coords=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;reflectionColor=texture2D(reflection2DSampler,coords);\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor.rgb=fromRGBD(reflectionColor);\n#endif\n#ifdef IS_REFLECTION_LINEAR\nreflectionColor.rgb=toGammaSpace(reflectionColor.rgb);\n#endif\nreflectionColor.rgb*=vReflectionInfos.x;\n#ifdef REFLECTIONFRESNEL\nfloat reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);\n#ifdef REFLECTIONFRESNELFROMSPECULAR\n#ifdef SPECULARTERM\nreflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#else\nreflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#else\nreflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#endif\n#endif\n#ifdef REFRACTIONFRESNEL\nfloat refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);refractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*vOpacityInfos.y;\n#endif\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nfloat opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);alpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;\n#endif\n#ifdef ALPHATEST\n#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS\nif (alpha<alphaCutOff)\ndiscard;\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\nvec3 emissiveColor=vEmissiveColor;\n#ifdef EMISSIVE\nemissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;\n#endif\n#ifdef EMISSIVEFRESNEL\nfloat emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);emissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;\n#endif\n#ifdef DIFFUSEFRESNEL\nfloat diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);diffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#endif\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase*specularColor;\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#else\nvec3 finalSpecular=vec3(0.0);\n#endif\n#ifdef REFLECTIONOVERALPHA\nalpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);\n#else\nvec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);\n#endif\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\ncolor.rgb*=lightmapColor.rgb;\n#else\ncolor.rgb+=lightmapColor.rgb;\n#endif\n#endif\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FOG\ncolor.rgb=max(color.rgb,0.);\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ncolor.rgb=toLinearSpace(color.rgb);\n#else\n#ifdef IMAGEPROCESSING\ncolor.rgb=toLinearSpace(color.rgb);color=applyImageProcessing(color);\n#endif\n#endif\ncolor.a*=visibility;\n#ifdef PREMULTIPLYALPHA\ncolor.rgb*=color.a;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\nfloat writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;\n#ifdef PREPASS_COLOR\ngl_FragData[PREPASS_COLOR_INDEX]=color; \n#endif\n#ifdef PREPASS_POSITION\ngl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_LOCAL_POSITION\ngl_FragData[PREPASS_LOCAL_POSITION_INDEX]=vec4(vPosition,writeGeometryInfo);\n#endif\n#if defined(PREPASS_VELOCITY)\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#elif defined(PREPASS_VELOCITY_LINEAR)\nvec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w)-(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_IRRADIANCE\ngl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_DEPTH\ngl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_SCREENSPACE_DEPTH\ngl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_NORMAL\n#ifdef PREPASS_NORMAL_WORLDSPACE\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo);\n#else\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo);\n#endif\n#endif\n#ifdef PREPASS_WORLD_NORMAL\ngl_FragData[PREPASS_WORLD_NORMAL_INDEX]=vec4(normalW*0.5+0.5,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO\ngl_FragData[PREPASS_ALBEDO_INDEX]=vec4(baseColor.rgb,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\ngl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqrt(baseColor.rgb),writeGeometryInfo);\n#endif\n#ifdef PREPASS_REFLECTIVITY\n#if defined(SPECULAR)\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularMapColor))*writeGeometryInfo; \n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularColor),1.0)*writeGeometryInfo;\n#endif\n#endif\n#endif\n#if !defined(PREPASS) || defined(WEBGL2)\ngl_FragColor=color;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {frontColor.rgb+=color.rgb*color.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-color.a);} else {backColor+=color;}\n#endif\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";r.l.ShadersStore[o]=a;const l={name:o,shader:a}},43965:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelGridVertexShaderWGSL:()=>n});const r="iblVoxelGridVertexShader",s="attribute position: vec3f;attribute normal: vec3f;varying vNormalizedPosition: vec3f;uniform world: mat4x4f;uniform invWorldScale: mat4x4f;uniform viewMatrix: mat4x4f;@vertex\nfn main(input : VertexInputs)->FragmentInputs {vertexOutputs.position=uniforms.viewMatrix*uniforms.invWorldScale*uniforms.world* vec4f(input.position,1.);vertexOutputs.vNormalizedPosition=vertexOutputs.position.xyz*0.5+0.5;\n#ifdef IS_NDC_HALF_ZRANGE\nvertexOutputs.position=vec4f(vertexOutputs.position.x,vertexOutputs.position.y,vertexOutputs.position.z*0.5+0.5,vertexOutputs.position.w);\n#endif\n}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},44143:(e,t,i)=>{i.r(t),i.d(t,{screenSpaceReflection2BlurCombinerPixelShaderWGSL:()=>o});var r=i(69610);i(79702),i(75052),i(95228);const s="screenSpaceReflection2BlurCombinerPixelShader",n="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>; \nvar mainSamplerSampler: sampler;var mainSampler: texture_2d<f32>;var reflectivitySamplerSampler: sampler;var reflectivitySampler: texture_2d<f32>;uniform strength: f32;uniform reflectionSpecularFalloffExponent: f32;uniform reflectivityThreshold: f32;varying vUV: vec2f;\n#include<helperFunctions>\n#ifdef SSR_BLEND_WITH_FRESNEL\n#include<pbrBRDFFunctions>\n#include<screenSpaceRayTrace>\nuniform projection: mat4x4f;uniform invProjectionMatrix: mat4x4f;\n#ifdef SSR_NORMAL_IS_IN_WORLDSPACE\nuniform view: mat4x4f;\n#endif\nvar normalSampler: texture_2d<f32>;var depthSampler: texture_2d<f32>;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nuniform nearPlaneZ: f32;uniform farPlaneZ: f32;\n#endif\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#ifdef SSRAYTRACE_DEBUG\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);\n#else\nvar SSR: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var color: vec4f=textureSample(mainSampler,textureSamplerSampler,input.vUV);var reflectivity: vec4f=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vUV);\n#ifndef SSR_DISABLE_REFLECTIVITY_TEST\nif (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=uniforms.reflectivityThreshold) {fragmentOutputs.color=color;return fragmentOutputs;}\n#endif\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\ncolor=toLinearSpaceVec4(color);\n#endif\n#ifdef SSR_BLEND_WITH_FRESNEL\nvar texSize: vec2f= vec2f(textureDimensions(depthSampler,0));var csNormal: vec3f=textureLoad(normalSampler,vec2<i32>(input.vUV*texSize),0).xyz;\n#ifdef SSR_DECODE_NORMAL\ncsNormal=csNormal*2.0-1.0;\n#endif\n#ifdef SSR_NORMAL_IS_IN_WORLDSPACE\ncsNormal=(uniforms.view*vec4f(csNormal,0.0)).xyz;\n#endif\nvar depth: f32=textureLoad(depthSampler,vec2<i32>(input.vUV*texSize),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\ndepth=linearizeDepth(depth,uniforms.nearPlaneZ,uniforms.farPlaneZ);\n#endif\nvar csPosition: vec3f=computeViewPosFromUVDepth(input.vUV,depth,uniforms.projection,uniforms.invProjectionMatrix);var csViewDirection: vec3f=normalize(csPosition);var F0: vec3f=reflectivity.rgb;var fresnel: vec3f=fresnelSchlickGGXVec3(max(dot(csNormal,-csViewDirection),0.0),F0, vec3f(1.));var reflectionMultiplier: vec3f=clamp(pow(fresnel*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));\n#else\nvar reflectionMultiplier: vec3f=clamp(pow(reflectivity.rgb*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));\n#endif\nvar colorMultiplier: vec3f=1.0-reflectionMultiplier;var finalColor: vec3f=(color.rgb*colorMultiplier)+(SSR*reflectionMultiplier);\n#ifdef SSR_OUTPUT_IS_GAMMA_SPACE\nfinalColor=toGammaSpaceVec3(finalColor);\n#endif\nfragmentOutputs.color= vec4f(finalColor,color.a);\n#endif\n}\n";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},44190:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphConstantBlock:()=>a});var r=i(71294),s=i(4720),n=i(56552),o=i(339);class a extends r.e{constructor(e){super(e),this.config=e,this.output=this.registerDataOutput("output",(0,s.k4)(e.value))}_updateOutputs(e){this.output.setValue(this.config.value,e)}getClassName(){return"FlowGraphConstantBlock"}serialize(e={},t=o.X5){super.serialize(e),t("value",this.config.value,e.config)}}(0,n.Y5)("FlowGraphConstantBlock",a)},45076:(e,t,i)=>{i.r(t),i.d(t,{ssao2PixelShaderWGSL:()=>n});const r="ssao2PixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#ifdef SSAO\nconst scales: array<f32,16>=array<f32,16>(\n0.1,\n0.11406250000000001,\n0.131640625,\n0.15625,\n0.187890625,\n0.2265625,\n0.272265625,\n0.325,\n0.384765625,\n0.4515625,\n0.525390625,\n0.60625,\n0.694140625,\n0.7890625,\n0.891015625,\n1.0\n);uniform near: f32;uniform radius: f32;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;var randomSamplerSampler: sampler;var randomSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;uniform randTextureTiles: f32;uniform samplesFactor: f32;uniform sampleSphere: array<vec3f,SAMPLES>;uniform totalStrength: f32;uniform base: f32;uniform xViewport: f32;uniform yViewport: f32;uniform depthProjection: mat3x3f;uniform maxZ: f32;uniform minZAspect: f32;uniform texelSize: vec2f;uniform projection: mat4x4f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var random: vec3f=textureSampleLevel(randomSampler,randomSamplerSampler,input.vUV*uniforms.randTextureTiles,0.0).rgb;var depth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.0).r;var depthSign: f32=sign(depth);depth=depth*depthSign;var normal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV,0.0).rgb;var occlusion: f32=0.0;var correctedRadius: f32=min(uniforms.radius,uniforms.minZAspect*depth/uniforms.near);var vViewRay: vec3f= vec3f((input.vUV.x*2.0-1.0)*uniforms.xViewport,(input.vUV.y*2.0-1.0)*uniforms.yViewport,depthSign);var vDepthFactor: vec3f=uniforms.depthProjection* vec3f(1.0,1.0,depth);var origin: vec3f=vViewRay*vDepthFactor;var rvec: vec3f=random*2.0-1.0;rvec.z=0.0;var dotProduct: f32=dot(rvec,normal);rvec=select( vec3f(-rvec.y,0.0,rvec.x),rvec,1.0-abs(dotProduct)>1e-2);var tangent: vec3f=normalize(rvec-normal*dot(rvec,normal));var bitangent: vec3f=cross(normal,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,normal);var difference: f32;for (var i: i32=0; i<SAMPLES; i++) {var samplePosition: vec3f=scales[(i+ i32(random.x*16.0)) % 16]*tbn*uniforms.sampleSphere[(i+ i32(random.y*16.0)) % 16];samplePosition=samplePosition*correctedRadius+origin;var offset: vec4f= vec4f(samplePosition,1.0);offset=uniforms.projection*offset;offset=vec4f(offset.xyz/offset.w,offset.w);offset=vec4f(offset.xy*0.5+0.5,offset.z,offset.w);if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {continue;}\nvar sampleDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,offset.xy,0.0).r);difference=depthSign*samplePosition.z-sampleDepth;var rangeCheck: f32=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);occlusion+=step(EPSILON,difference)*rangeCheck;}\nocclusion=occlusion*(1.0-smoothstep(uniforms.maxZ*0.75,uniforms.maxZ,depth));var ao: f32=1.0-uniforms.totalStrength*occlusion*uniforms.samplesFactor;var result: f32=clamp(ao+uniforms.base,0.0,1.0);fragmentOutputs.color= vec4f( vec3f(result),1.0);}\n#else\n#ifdef BLUR\nuniform outSize: f32;uniform soften: f32;uniform tolerance: f32;uniform samples: i32;\n#ifndef BLUR_BYPASS\nvar depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;\n#ifdef BLUR_LEGACY\nfn blur13Bilateral(image: texture_2d<f32>,imageSampler: sampler,uv: vec2f,step: vec2f)->f32 {var result: f32=0.0;var off1: vec2f= vec2f(1.411764705882353)*step;var off2: vec2f= vec2f(3.2941176470588234)*step;var off3: vec2f= vec2f(5.176470588235294)*step;var compareDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv,0.0).r);var sampleDepth: f32;var weight: f32;var weightSum: f32=30.0;result+=textureSampleLevel(image,imageSampler,uv,0.0).r*30.0;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv+off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureSampleLevel(image,imageSampler,uv+off1,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv-off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureSampleLevel(image,imageSampler,uv-off1,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv+off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv+off2,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv-off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv-off2,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv+off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv+off3,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv-off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv-off3,0.0).r*weight;return result/weightSum;}\n#endif\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var result: f32=0.0;\n#ifdef BLUR_BYPASS\nresult=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0).r;\n#else\n#ifdef BLUR_H\nvar step: vec2f= vec2f(1.0/uniforms.outSize,0.0);\n#else\nvar step: vec2f= vec2f(0.0,1.0/uniforms.outSize);\n#endif\n#ifdef BLUR_LEGACY\nresult=blur13Bilateral(textureSampler,textureSamplerSampler,input.vUV,step);\n#else\nvar compareDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.0).r);var weightSum: f32=0.0;for (var i: i32=-uniforms.samples; i<uniforms.samples; i+=2)\n{var samplePos: vec2f=input.vUV+step*( f32(i)+0.5);var sampleDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,samplePos,0.0).r);var falloff: f32=smoothstep(0.0,\nf32(uniforms.samples),\nf32(uniforms.samples)-abs( f32(i))*uniforms.soften);var minDivider: f32=uniforms.tolerance*0.5+0.003;var weight: f32=falloff/( minDivider+abs(compareDepth-sampleDepth));result+=textureSampleLevel(textureSampler,textureSamplerSampler,samplePos,0.0).r*weight;weightSum+=weight;}\nresult/=weightSum;\n#endif\n#endif\nfragmentOutputs.color=vec4f(result,result,result,1.0);}\n#endif\n#endif\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},45095:(e,t,i)=>{i.r(t),i.d(t,{pickingVertexShaderWGSL:()=>o});var r=i(69610);i(32806),i(98900),i(76340),i(8217),i(44559),i(18258),i(9129),i(91277),i(65470),i(40242);const s="pickingVertexShader",n="attribute position: vec3f;\n#if defined(INSTANCES)\nattribute instanceMeshID: vec4f;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\nuniform viewProjection: mat4x4f;\n#if defined(INSTANCES)\nvarying vMeshID: vec4f;\n#endif\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld*vec4f(input.position,1.0);vertexOutputs.position=uniforms.viewProjection*worldPos;\n#if defined(INSTANCES)\nvertexOutputs.vMeshID=input.instanceMeshID;\n#endif\n}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},45499:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphPointerOutEventBlock:()=>a});var r=i(22086),s=i(4720),n=i(56552),o=i(4686);class a extends r.i{constructor(e){super(e),this.type="PointerOut",this.pointerId=this.registerDataOutput("pointerId",s.Es),this.targetMesh=this.registerDataInput("targetMesh",s.Vv,e?.targetMesh),this.meshOutOfPointer=this.registerDataOutput("meshOutOfPointer",s.Vv)}_executeEvent(e,t){const i=this.targetMesh.getValue(e);this.meshOutOfPointer.setValue(t.mesh,e),this.pointerId.setValue(t.pointerId,e);return!((!t.over||!(0,o.rC)(t.mesh,i))&&(t.mesh===i||(0,o.rC)(t.mesh,i)))||(this._execute(e),!this.config?.stopPropagation)}_preparePendingTasks(e){}_cancelPendingTasks(e){}getClassName(){return"FlowGraphPointerOutEventBlock"}}(0,n.Y5)("FlowGraphPointerOutEventBlock",a)},45791:(e,t,i)=>{i.r(t),i.d(t,{defaultPixelShaderWGSL:()=>o});var r=i(69610);i(71698),i(54211),i(18639),i(41861),i(79702),i(30379),i(76493),i(78589),i(80983),i(30976),i(72230),i(16205),i(88996),i(15697),i(91258),i(39759),i(93226),i(66407),i(97715),i(20727),i(49306),i(59104),i(25271),i(38780),i(93243),i(91347);const s="defaultPixelShader",n="#include<defaultUboDeclaration>\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\n#include<oitDeclaration>\n#define CUSTOM_FRAGMENT_BEGIN\nvarying vPositionW: vec3f;\n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vColor: vec4f;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#include<helperFunctions>\n#include<lightUboDeclaration>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef REFRACTION\n#ifdef REFRACTIONMAP_3D\nvar refractionCubeSamplerSampler: sampler;var refractionCubeSampler: texture_cube<f32>;\n#else\nvar refraction2DSamplerSampler: sampler;var refraction2DSampler: texture_2d<f32>;\n#endif\n#endif\n#if defined(SPECULARTERM)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)\n#endif\n#include<fresnelFunction>\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nvar reflectionCubeSamplerSampler: sampler;var reflectionCubeSampler: texture_cube<f32>;\n#else\nvar reflection2DSamplerSampler: sampler;var reflection2DSampler: texture_2d<f32>;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#include<imageProcessingDeclaration>\n#include<imageProcessingFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvar viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-fragmentInputs.vPositionW);var baseColor: vec4f= vec4f(1.,1.,1.,1.);var diffuseColor: vec3f=uniforms.vDiffuseColor.rgb;var alpha: f32=uniforms.vDiffuseColor.a;\n#ifdef NORMAL\nvar normalW: vec3f=normalize(fragmentInputs.vNormalW);\n#else\nvar normalW: vec3f=normalize(-cross(dpdx(fragmentInputs.vPositionW),dpdy(fragmentInputs.vPositionW)));\n#endif\n#include<bumpFragment>\n#ifdef TWOSIDEDLIGHTING\nnormalW=select(-normalW,normalW,fragmentInputs.frontFacing);\n#endif\n#ifdef DIFFUSE\nbaseColor=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vDiffuseUV+uvOffset);\n#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)\nif (baseColor.a<uniforms.alphaCutOff) {discard;}\n#endif\n#ifdef ALPHAFROMDIFFUSE\nalpha*=baseColor.a;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\nbaseColor=vec4f(baseColor.rgb*uniforms.vDiffuseInfos.y,baseColor.a);\n#endif\n#if defined(DECAL) && !defined(DECAL_AFTER_DETAIL)\nvar decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);\n#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)\n#endif\n#include<depthPrePass>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nbaseColor=vec4f(baseColor.rgb*fragmentInputs.vColor.rgb,baseColor.a);\n#endif\n#ifdef DETAIL\nbaseColor=vec4f(baseColor.rgb*2.0*mix(0.5,detailColor.r,uniforms.vDetailInfos.y),baseColor.a);\n#endif\n#if defined(DECAL) && defined(DECAL_AFTER_DETAIL)\nvar decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);\n#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE\nvar baseAmbientColor: vec3f= vec3f(1.,1.,1.);\n#ifdef AMBIENT\nbaseAmbientColor=textureSample(ambientSampler,ambientSamplerSampler,fragmentInputs.vAmbientUV+uvOffset).rgb*uniforms.vAmbientInfos.y;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\nvar glossiness: f32=uniforms.vSpecularColor.a;var specularColor: vec3f=uniforms.vSpecularColor.rgb;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\nvar specularMapColor: vec4f=textureSample(specularSampler,specularSamplerSampler,fragmentInputs.vSpecularUV+uvOffset);specularColor=specularMapColor.rgb;\n#ifdef GLOSSINESS\nglossiness=glossiness*specularMapColor.a;\n#endif\n#endif\n#endif\nvar diffuseBase: vec3f= vec3f(0.,0.,0.);var info: lightingInfo;\n#ifdef SPECULARTERM\nvar specularBase: vec3f= vec3f(0.,0.,0.);\n#endif\nvar shadow: f32=1.;var aggShadow: f32=0.;var numLights: f32=0.;\n#ifdef LIGHTMAP\nvar lightmapColor: vec4f=textureSample(lightmapSampler,lightmapSamplerSampler,fragmentInputs.vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor=vec4f(fromRGBD(lightmapColor),lightmapColor.a);\n#endif\nlightmapColor=vec4f(lightmapColor.rgb*uniforms.vLightmapInfos.y,lightmapColor.a);\n#endif\n#include<lightFragment>[0..maxSimultaneousLights]\naggShadow=aggShadow/numLights;var refractionColor: vec4f= vec4f(0.,0.,0.,1.);\n#ifdef REFRACTION\nvar refractionVector: vec3f=normalize(refract(-viewDirectionW,normalW,uniforms.vRefractionInfos.y));\n#ifdef REFRACTIONMAP_3D\n#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(fragmentInputs.vPositionW,refractionVector,uniforms.vRefractionSize,uniforms.vRefractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*uniforms.vRefractionInfos.w;var refractionLookup: vec4f=textureSample(refractionCubeSampler,refractionCubeSamplerSampler,refractionVector);if (dot(refractionVector,viewDirectionW)<1.0) {refractionColor=refractionLookup;}\n#else\nvar vRefractionUVW: vec3f= (uniforms.refractionMatrix*(scene.view* vec4f(fragmentInputs.vPositionW+refractionVector*uniforms.vRefractionInfos.z,1.0))).xyz;var refractionCoords: vec2f=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;refractionColor=textureSample(refraction2DSampler,refraction2DSamplerSampler,refractionCoords);\n#endif\n#ifdef RGBDREFRACTION\nrefractionColor=vec4f(fromRGBD(refractionColor),refractionColor.a);\n#endif\n#ifdef IS_REFRACTION_LINEAR\nrefractionColor=vec4f(toGammaSpaceVec3(refractionColor.rgb),refractionColor.a);\n#endif\nrefractionColor=vec4f(refractionColor.rgb*uniforms.vRefractionInfos.x,refractionColor.a);\n#endif\nvar reflectionColor: vec4f= vec4f(0.,0.,0.,1.);\n#ifdef REFLECTION\nvar vReflectionUVW: vec3f=computeReflectionCoords( vec4f(fragmentInputs.vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nvReflectionUVW=vec3f(vReflectionUVW.x,vReflectionUVW.y,vReflectionUVW.z*-1.0);\n#endif\n#ifdef REFLECTIONMAP_3D\n#ifdef ROUGHNESS\nvar bias: f32=uniforms.vReflectionInfos.y;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\n#ifdef GLOSSINESS\nbias*=(1.0-specularMapColor.a);\n#endif\n#endif\n#endif\nreflectionColor=textureSampleLevel(reflectionCubeSampler,reflectionCubeSamplerSampler,vReflectionUVW,bias);\n#else\nreflectionColor=textureSample(reflectionCubeSampler,reflectionCubeSamplerSampler,vReflectionUVW);\n#endif\n#else\nvar coords: vec2f=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;reflectionColor=textureSample(reflection2DSampler,reflection2DSamplerSampler,coords);\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor=vec4f(fromRGBD(reflectionColor),reflectionColor.a);\n#endif\n#ifdef IS_REFLECTION_LINEAR\nreflectionColor=vec4f(toGammaSpaceVec3(reflectionColor.rgb),reflectionColor.a);\n#endif\nreflectionColor=vec4f(reflectionColor.rgb*uniforms.vReflectionInfos.x,reflectionColor.a);\n#ifdef REFLECTIONFRESNEL\nvar reflectionFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.reflectionRightColor.a,uniforms.reflectionLeftColor.a);\n#ifdef REFLECTIONFRESNELFROMSPECULAR\n#ifdef SPECULARTERM\nreflectionColor=vec4f(reflectionColor.rgb*specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*uniforms.reflectionRightColor.rgb,reflectionColor.a);\n#else\nreflectionColor=vec4f(reflectionColor.rgb*uniforms.reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*uniforms.reflectionRightColor.rgb,reflectionColor.a);\n#endif\n#else\nreflectionColor=vec4f(reflectionColor.rgb*uniforms.reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*uniforms.reflectionRightColor.rgb,reflectionColor.a);\n#endif\n#endif\n#endif\n#ifdef REFRACTIONFRESNEL\nvar refractionFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.refractionRightColor.a,uniforms.refractionLeftColor.a);refractionColor=vec4f(refractionColor.rgb*uniforms.refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*uniforms.refractionRightColor.rgb,refractionColor.a);\n#endif\n#ifdef OPACITY\nvar opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap=vec4f(opacityMap.rgb* vec3f(0.3,0.59,0.11),opacityMap.a);alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* uniforms.vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*uniforms.vOpacityInfos.y;\n#endif\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=fragmentInputs.vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nvar opacityFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.opacityParts.z,uniforms.opacityParts.w);alpha+=uniforms.opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*uniforms.opacityParts.y;\n#endif\n#ifdef ALPHATEST\n#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS\nif (alpha<uniforms.alphaCutOff) {discard;}\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\nvar emissiveColor: vec3f=uniforms.vEmissiveColor;\n#ifdef EMISSIVE\nemissiveColor+=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vEmissiveUV+uvOffset).rgb*uniforms.vEmissiveInfos.y;\n#endif\n#ifdef EMISSIVEFRESNEL\nvar emissiveFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.emissiveRightColor.a,uniforms.emissiveLeftColor.a);emissiveColor*=uniforms.emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*uniforms.emissiveRightColor.rgb;\n#endif\n#ifdef DIFFUSEFRESNEL\nvar diffuseFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.diffuseRightColor.a,uniforms.diffuseLeftColor.a);diffuseBase*=uniforms.diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*uniforms.diffuseRightColor.rgb;\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvar finalDiffuse: vec3f=clamp(diffuseBase*diffuseColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvar finalDiffuse: vec3f=clamp((diffuseBase+emissiveColor)*diffuseColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;\n#else\nvar finalDiffuse: vec3f=clamp(diffuseBase*diffuseColor+emissiveColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;\n#endif\n#endif\n#ifdef SPECULARTERM\nvar finalSpecular: vec3f=specularBase*specularColor;\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+dot(finalSpecular, vec3f(0.3,0.59,0.11)),0.0,1.0);\n#endif\n#else\nvar finalSpecular: vec3f= vec3f(0.0);\n#endif\n#ifdef REFLECTIONOVERALPHA\nalpha=clamp(alpha+dot(reflectionColor.rgb, vec3f(0.3,0.59,0.11)),0.0,1.0);\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvar color: vec4f= vec4f(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);\n#else\nvar color: vec4f= vec4f(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);\n#endif\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\ncolor=vec4f(color.rgb*lightmapColor.rgb,color.a);\n#else\ncolor=vec4f(color.rgb+lightmapColor.rgb,color.a);\n#endif\n#endif\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FOG\ncolor=vec4f(max(color.rgb,vec3f(0.)),color.a);\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ncolor=vec4f(toLinearSpaceVec3(color.rgb),color.a);\n#else\n#ifdef IMAGEPROCESSING\ncolor=vec4f(toLinearSpaceVec3(color.rgb),color.a);color=applyImageProcessing(color);\n#endif\n#endif\ncolor=vec4f(color.rgb,color.a*mesh.visibility);\n#ifdef PREMULTIPLYALPHA\ncolor=vec4f(color.rgb*color.a, color.a);\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\nvar writeGeometryInfo: f32=select(0.0,1.0,color.a>0.4);var fragData: array<vec4<f32>,SCENE_MRT_COUNT>;\n#ifdef PREPASS_COLOR\nfragData[PREPASS_COLOR_INDEX]=color; \n#endif\n#ifdef PREPASS_POSITION\nfragData[PREPASS_POSITION_INDEX]=vec4f(fragmentInputs.vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_LOCAL_POSITION\nfragData[PREPASS_LOCAL_POSITION_INDEX]=vec4f(fragmentInputs.vPosition,writeGeometryInfo);\n#endif\n#ifdef PREPASS_VELOCITY\nvar a: vec2f=(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[PREPASS_VELOCITY_INDEX]= vec4f(velocity,0.0,writeGeometryInfo);\n#elif defined(PREPASS_VELOCITY_LINEAR)\nvar velocity : vec2f=vec2f(0.5)*((fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w) -\n(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w));fragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4f(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_IRRADIANCE\nfragData[PREPASS_IRRADIANCE_INDEX]=vec4f(0.0,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_DEPTH\nfragData[PREPASS_DEPTH_INDEX]=vec4f(fragmentInputs.vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_SCREENSPACE_DEPTH\nfragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_NORMAL\n#ifdef PREPASS_NORMAL_WORLDSPACE\nfragData[PREPASS_NORMAL_INDEX]=vec4f(normalW,writeGeometryInfo);\n#else\nfragData[PREPASS_NORMAL_INDEX]=vec4f(normalize((scene.view*vec4f(normalW,0.0)).rgb),writeGeometryInfo);\n#endif\n#endif\n#ifdef PREPASS_WORLD_NORMAL\nfragData[PREPASS_WORLD_NORMAL_INDEX]=vec4f(normalW*0.5+0.5,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO\nfragData[PREPASS_ALBEDO_INDEX]=vec4f(baseColor.rgb,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\nfragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4f(sqrt(baseColor.rgb),writeGeometryInfo);\n#endif\n#ifdef PREPASS_REFLECTIVITY\n#if defined(SPECULAR)\nfragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(toLinearSpaceVec4(specularMapColor))*writeGeometryInfo; \n#else\nfragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(toLinearSpaceVec3(specularColor),1.0)*writeGeometryInfo;\n#endif\n#endif\n#if SCENE_MRT_COUNT>0\nfragmentOutputs.fragData0=fragData[0];\n#endif\n#if SCENE_MRT_COUNT>1\nfragmentOutputs.fragData1=fragData[1];\n#endif\n#if SCENE_MRT_COUNT>2\nfragmentOutputs.fragData2=fragData[2];\n#endif\n#if SCENE_MRT_COUNT>3\nfragmentOutputs.fragData3=fragData[3];\n#endif\n#if SCENE_MRT_COUNT>4\nfragmentOutputs.fragData4=fragData[4];\n#endif\n#if SCENE_MRT_COUNT>5\nfragmentOutputs.fragData5=fragData[5];\n#endif\n#if SCENE_MRT_COUNT>6\nfragmentOutputs.fragData6=fragData[6];\n#endif\n#if SCENE_MRT_COUNT>7\nfragmentOutputs.fragData7=fragData[7];\n#endif\n#endif\n#if !defined(PREPASS) && !defined(ORDER_INDEPENDENT_TRANSPARENCY)\nfragmentOutputs.color=color;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {fragmentOutputs.frontColor=vec4f(fragmentOutputs.frontColor.rgb+color.rgb*color.a*alphaMultiplier,1.0-alphaMultiplier*(1.0-color.a));} else {fragmentOutputs.backColor+=color;}\n#endif\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},45963:(e,t,i)=>{i.r(t),i.d(t,{copyTextureToTexturePixelShader:()=>o});var r=i(69610);i(73325);const s="copyTextureToTexturePixelShader",n="uniform float conversion;uniform sampler2D textureSampler;varying vec2 vUV;\n#include<helperFunctions>\nvoid main(void) \n{vec4 color=texture2D(textureSampler,vUV);\n#ifdef DEPTH_TEXTURE\ngl_FragDepth=color.r;\n#else\nif (conversion==1.) {color=toLinearSpace(color);} else if (conversion==2.) {color=toGammaSpace(color);}\ngl_FragColor=color;\n#endif\n}\n";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},46043:(e,t,i)=>{i.r(t),i.d(t,{iblGenerateVoxelMipPixelShader:()=>n});const r="iblGenerateVoxelMipPixelShader",s="precision highp float;precision highp sampler3D;varying vec2 vUV;uniform sampler3D srcMip;uniform int layerNum;void main(void) {ivec3 Coords=ivec3(2)*ivec3(gl_FragCoord.x,gl_FragCoord.y,layerNum);uint tex =\nuint(texelFetch(srcMip,Coords+ivec3(0,0,0),0).x>0.0f ? 1u : 0u)\n<< 0u |\nuint(texelFetch(srcMip,Coords+ivec3(1,0,0),0).x>0.0f ? 1u : 0u)\n<< 1u |\nuint(texelFetch(srcMip,Coords+ivec3(0,1,0),0).x>0.0f ? 1u : 0u)\n<< 2u |\nuint(texelFetch(srcMip,Coords+ivec3(1,1,0),0).x>0.0f ? 1u : 0u)\n<< 3u |\nuint(texelFetch(srcMip,Coords+ivec3(0,0,1),0).x>0.0f ? 1u : 0u)\n<< 4u |\nuint(texelFetch(srcMip,Coords+ivec3(1,0,1),0).x>0.0f ? 1u : 0u)\n<< 5u |\nuint(texelFetch(srcMip,Coords+ivec3(0,1,1),0).x>0.0f ? 1u : 0u)\n<< 6u |\nuint(texelFetch(srcMip,Coords+ivec3(1,1,1),0).x>0.0f ? 1u : 0u)\n<< 7u;glFragColor.rgb=vec3(float(tex)/255.0f,0.0f,0.0f);glFragColor.a=1.0;}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},46391:(e,t,i)=>{i.r(t),i.d(t,{iblShadowSpatialBlurPixelShaderWGSL:()=>n});const r="iblShadowSpatialBlurPixelShader",s="#define PI 3.1415927\nvarying vUV: vec2f;var depthSampler: texture_2d<f32>;var worldNormalSampler: texture_2d<f32>;var voxelTracingSampler : texture_2d<f32>;uniform blurParameters: vec4f;\n#define stridef uniforms.blurParameters.x\n#define worldScale uniforms.blurParameters.y\nconst weights=array<f32,5>(0.0625,0.25,0.375,0.25,0.0625);const nbWeights: i32=5;fn max2(v: vec2f,w: vec2f)->vec2f {return vec2f(max(v.x,w.x),max(v.y,w.y));}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var gbufferRes=vec2f(textureDimensions(depthSampler,0));var gbufferPixelCoord= vec2i(fragmentInputs.vUV*gbufferRes);var shadowRes=vec2f(textureDimensions(voxelTracingSampler,0));var shadowPixelCoord= vec2i(fragmentInputs.vUV*shadowRes);var N: vec3f=textureLoad(worldNormalSampler,gbufferPixelCoord,0).xyz;if (length(N)<0.01) {fragmentOutputs.color=vec4f(1.0,1.0,0.0,1.0);return fragmentOutputs;}\nvar depth: f32=-textureLoad(depthSampler,gbufferPixelCoord,0).x;var X: vec4f= vec4f(0.0);for(var y: i32=0; y<nbWeights; y++) {for(var x: i32=0; x<nbWeights; x++) {var gBufferCoords: vec2i=gbufferPixelCoord+i32(stridef)*vec2i(x-(nbWeights>>1),y-(nbWeights>>1));var shadowCoords: vec2i=shadowPixelCoord+i32(stridef)*vec2i(x-(nbWeights>>1),y-(nbWeights>>1));var T : vec3f=textureLoad(voxelTracingSampler,shadowCoords,0).xyz;var ddepth: f32=-textureLoad(depthSampler,gBufferCoords,0).x-depth;var dN: vec3f=textureLoad(worldNormalSampler,gBufferCoords,0).xyz-N;var w: f32=weights[x]*weights[y] *\nexp2(max(-1000.0/(worldScale*worldScale),-0.5) *\n(ddepth*ddepth) -\n1e1*dot(dN,dN));X+= vec4f(w*T.x,w*T.y,w*T.z,w);}}\nfragmentOutputs.color= vec4f(X.x/X.w,X.y/X.w,X.z/X.w,1.0);}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},46762:(e,t,i)=>{i.r(t),i.d(t,{iblCdfDebugPixelShader:()=>n});const r="iblCdfDebugPixelShader",s="precision highp samplerCube;\n#define PI 3.1415927\nvarying vec2 vUV;uniform sampler2D cdfy;uniform sampler2D cdfx;uniform sampler2D icdf;uniform sampler2D pdf;\n#ifdef IBL_USE_CUBE_MAP\nuniform samplerCube iblSource;\n#else\nuniform sampler2D iblSource;\n#endif\nuniform sampler2D textureSampler;\n#define cdfyVSize (0.8/3.0)\n#define cdfxVSize 0.1\n#define cdfyHSize 0.5\nuniform vec4 sizeParams;\n#define offsetX sizeParams.x\n#define offsetY sizeParams.y\n#define widthScale sizeParams.z\n#define heightScale sizeParams.w\n#ifdef IBL_USE_CUBE_MAP\nvec3 equirectangularToCubemapDirection(vec2 uv) {float longitude=uv.x*2.0*PI-PI;float latitude=PI*0.5-uv.y*PI;vec3 direction;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}\n#endif\nvoid main(void) {vec3 colour=vec3(0.0);vec2 uv =\nvec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec3 backgroundColour=texture2D(textureSampler,vUV).rgb;int cdfxWidth=textureSize(cdfx,0).x;int cdfyHeight=textureSize(cdfy,0).y;const float iblStart=1.0-cdfyVSize;const float pdfStart=1.0-2.0*cdfyVSize;const float cdfyStart=1.0-3.0*cdfyVSize;const float cdfxStart=1.0-3.0*cdfyVSize-cdfxVSize;const float icdfxStart=1.0-3.0*cdfyVSize-2.0*cdfxVSize;\n#ifdef IBL_USE_CUBE_MAP\nvec3 direction=equirectangularToCubemapDirection(\n(uv-vec2(0.0,iblStart))*vec2(1.0,1.0/cdfyVSize));vec3 iblColour=textureCubeLodEXT(iblSource,direction,0.0).rgb;\n#else\nvec3 iblColour=texture2D(iblSource,(uv-vec2(0.0,iblStart)) *\nvec2(1.0,1.0/cdfyVSize))\n.rgb;\n#endif\nvec3 pdfColour=texture(icdf,(uv-vec2(0.0,pdfStart)) *\nvec2(1.0,1.0/cdfyVSize)).zzz;float cdfyColour =\ntexture2D(cdfy,(uv-vec2(0.0,cdfyStart))*vec2(2.0,1.0/cdfyVSize))\n.r;float icdfyColour =\ntexture2D(icdf,(uv-vec2(0.5,cdfyStart))*vec2(2.0,1.0/cdfyVSize))\n.g;float cdfxColour =\ntexture2D(cdfx,(uv-vec2(0.0,cdfxStart))*vec2(1.0,1.0/cdfxVSize))\n.r;float icdfxColour=texture2D(icdf,(uv-vec2(0.0,icdfxStart)) *\nvec2(1.0,1.0/cdfxVSize))\n.r;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {colour=backgroundColour;} else if (uv.y>iblStart) {colour+=iblColour;} else if (uv.y>pdfStart) {colour+=pdfColour;} else if (uv.y>cdfyStart && uv.x<0.5) {colour.r+=cdfyColour/float(cdfyHeight);} else if (uv.y>cdfyStart && uv.x>0.5) {colour.r+=icdfyColour;} else if (uv.y>cdfxStart) {colour.r+=cdfxColour/float(cdfxWidth);} else if (uv.y>icdfxStart) {colour.r+=icdfxColour;}\ngl_FragColor=vec4(colour,1.0);glFragColor.rgb=mix(gl_FragColor.rgb,backgroundColour,0.5);}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},46900:(e,t,i)=>{i.d(t,{l:()=>s});var r=i(34898);class s extends r.t{constructor(e,t){super(e,t),this._outBus=null,this._onOutBusDisposed=()=>{this.outBus=this.engine.defaultMainBus}}get outBus(){return this._outBus}set outBus(e){if(this._outBus!==e){if(this._outBus&&(this._outBus.onDisposeObservable.removeCallback(this._onOutBusDisposed),!this._disconnect(this._outBus)))throw new Error("Disconnect failed");if(this._outBus=e,this._outBus&&(this._outBus.onDisposeObservable.add(this._onOutBusDisposed),!this._connect(this._outBus)))throw new Error("Connect failed")}}dispose(){super.dispose(),this._outBus=null}}},47312:(e,t,i)=>{i.r(t),i.d(t,{oitBackBlendPixelShaderWGSL:()=>n});const r="oitBackBlendPixelShader",s="var uBackColor: texture_2d<f32>;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureLoad(uBackColor,vec2i(fragmentInputs.position.xy),0);if (fragmentOutputs.color.a==0.0) {discard;}}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},47383:(e,t,i)=>{i.r(t),i.d(t,{copyTexture3DLayerToTexturePixelShader:()=>n});const r="copyTexture3DLayerToTexturePixelShader",s="precision highp sampler3D;uniform sampler3D textureSampler;uniform int layerNum;varying vec2 vUV;void main(void) {vec3 coord=vec3(0.0,0.0,float(layerNum));coord.xy=vec2(vUV.x,vUV.y)*vec2(textureSize(textureSampler,0).xy);vec3 color=texelFetch(textureSampler,ivec3(coord),0).rgb;gl_FragColor=vec4(color,1);}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},47671:(e,t,i)=>{i.r(t),i.d(t,{iblCdfxPixelShader:()=>n});const r="iblCdfxPixelShader",s="precision highp sampler2D;\n#define PI 3.1415927\nvarying vec2 vUV;uniform sampler2D cdfy;void main(void) {ivec2 cdfyRes=textureSize(cdfy,0);ivec2 currentPixel=ivec2(gl_FragCoord.xy);float cdfx=0.0;for (int x=1; x<=currentPixel.x; x++) {cdfx+=texelFetch(cdfy,ivec2(x-1,cdfyRes.y-1),0).x;}\ngl_FragColor=vec4(vec3(cdfx),1.0);}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},48137:(e,t,i)=>{i.r(t),i.d(t,{iblCdfDebugPixelShaderWGSL:()=>n});const r="iblCdfDebugPixelShader",s="#define PI 3.1415927\nvarying vUV: vec2f;var cdfySampler: sampler;var cdfy: texture_2d<f32>;var cdfxSampler: sampler;var cdfx: texture_2d<f32>;var icdfSampler: sampler;var icdf: texture_2d<f32>;\n#ifdef IBL_USE_CUBE_MAP\nvar iblSourceSampler: sampler;var iblSource: texture_cube<f32>;\n#else\nvar iblSourceSampler: sampler;var iblSource: texture_2d<f32>;\n#endif\nvar textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#define cdfyVSize (0.8/3.0)\n#define cdfxVSize 0.1\n#define cdfyHSize 0.5\nuniform sizeParams: vec4f;\n#ifdef IBL_USE_CUBE_MAP\nfn equirectangularToCubemapDirection(uv: vec2f)->vec3f {var longitude: f32=uv.x*2.0*PI-PI;var latitude: f32=PI*0.5-uv.y*PI;var direction: vec3f;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs { \nvar colour: vec3f= vec3f(0.0);var uv: vec2f =\nvec2f((uniforms.sizeParams.x+input.vUV.x)*uniforms.sizeParams.z,(uniforms.sizeParams.y+input.vUV.y)*uniforms.sizeParams.w);var backgroundColour: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var cdfxWidth: u32=textureDimensions(cdfx,0).x;var cdfyHeight: u32=textureDimensions(cdfy,0).y;const iblStart: f32=1.0-cdfyVSize;const pdfStart: f32=1.0-2.0*cdfyVSize;const cdfyStart: f32=1.0-3.0*cdfyVSize;const cdfxStart: f32=1.0-3.0*cdfyVSize-cdfxVSize;const icdfxStart: f32=1.0-3.0*cdfyVSize-2.0*cdfxVSize;\n#ifdef IBL_USE_CUBE_MAP\nvar direction: vec3f=equirectangularToCubemapDirection(\n(uv- vec2f(0.0,iblStart))* vec2f(1.0,1.0/cdfyVSize));var iblColour: vec3f=textureSampleLevel(iblSource,iblSourceSampler,direction,0.0).rgb;\n#else\nvar iblColour: vec3f=textureSample(iblSource,iblSourceSampler,(uv- vec2f(0.0,iblStart)) *\nvec2f(1.0,1.0/cdfyVSize))\n.rgb;\n#endif\nvar pdfColour: vec3f =\ntextureSample(icdf,icdfSampler,(uv- vec2f(0.0,pdfStart))* vec2f(1.0,1.0/cdfyVSize)).zzz;var cdfyColour: f32 =\ntextureSample(cdfy,cdfySampler,(uv- vec2f(0.0,cdfyStart))* vec2f(2.0,1.0/cdfyVSize)).r;var icdfyColour: f32 =\ntextureSample(icdf,icdfSampler,(uv- vec2f(0.5,cdfyStart))* vec2f(2.0,1.0/cdfyVSize)).g;var cdfxColour: f32 =\ntextureSample(cdfx,cdfxSampler,(uv- vec2f(0.0,cdfxStart))* vec2f(1.0,1.0/cdfxVSize)).r;var icdfxColour: f32=textureSample(icdf,icdfSampler,(uv- vec2f(0.0,icdfxStart)) *\nvec2f(1.0,1.0/cdfxVSize)).r;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {colour=backgroundColour;} else if (uv.y>iblStart) {colour+=iblColour;} else if (uv.y>pdfStart) {colour+=pdfColour;} else if (uv.y>cdfyStart && uv.x<0.5) {colour.r+=cdfyColour/f32(cdfyHeight);} else if (uv.y>cdfyStart && uv.x>0.5) {colour.r+=icdfyColour;} else if (uv.y>cdfxStart) {colour.r+=cdfxColour/f32(cdfxWidth);} else if (uv.y>icdfxStart) {colour.r+=icdfxColour;}\nfragmentOutputs.color =vec4(mix(colour,backgroundColour,0.5),1.0);}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},48267:(e,t,i)=>{i.r(t),i.d(t,{glowMapGenerationVertexShaderWGSL:()=>o});var r=i(69610);i(32806),i(98900),i(76340),i(8217),i(77029),i(44559),i(18258),i(9129),i(91277),i(65470),i(40242),i(85197);const s="glowMapGenerationVertexShader",n="attribute position: vec3f;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform viewProjection: mat4x4f;varying vPosition: vec4f;\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#ifdef DIFFUSE\nvarying vUVDiffuse: vec2f;uniform diffuseMatrix: mat4x4f;\n#endif\n#ifdef OPACITY\nvarying vUVOpacity: vec2f;uniform opacityMatrix: mat4x4f;\n#endif\n#ifdef EMISSIVE\nvarying vUVEmissive: vec2f;uniform emissiveMatrix: mat4x4f;\n#endif\n#ifdef VERTEXALPHA\nattribute color: vec4f;varying vColor: vec4f;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;\n#ifdef UV1\nvar uvUpdated: vec2f=input.uv;\n#endif\n#ifdef UV2\nvar uv2Updated: vec2f=input.uv2;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);\n#ifdef CUBEMAP\nvertexOutputs.vPosition=worldPos;vertexOutputs.position=uniforms.viewProjection*finalWorld* vec4f(input.position,1.0);\n#else\nvertexOutputs.vPosition=uniforms.viewProjection*worldPos;vertexOutputs.position=vertexOutputs.vPosition;\n#endif\n#ifdef DIFFUSE\n#ifdef DIFFUSEUV1\nvertexOutputs.vUVDiffuse= (uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef DIFFUSEUV2\nvertexOutputs.vUVDiffuse= (uniforms.diffuseMatrix* vec4f(uv2Updated,1.0,0.0)).xy;\n#endif\n#endif\n#ifdef OPACITY\n#ifdef OPACITYUV1\nvertexOutputs.vUVOpacity= (uniforms.opacityMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef OPACITYUV2\nvertexOutputs.vUVOpacity= (uniforms.opacityMatrix* vec4f(uv2Updated,1.0,0.0)).xy;\n#endif\n#endif\n#ifdef EMISSIVE\n#ifdef EMISSIVEUV1\nvertexOutputs.vUVEmissive= (uniforms.emissiveMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef EMISSIVEUV2\nvertexOutputs.vUVEmissive= (uniforms.emissiveMatrix* vec4f(uv2Updated,1.0,0.0)).xy;\n#endif\n#endif\n#ifdef VERTEXALPHA\nvertexOutputs.vColor=vertexInputs.color;\n#endif\n#include<clipPlaneVertex>\n}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},48453:(e,t,i)=>{i.r(t),i.d(t,{depthVertexShaderWGSL:()=>o});var r=i(69610);i(32806),i(98900),i(76340),i(8217),i(77029),i(44559),i(18258),i(9129),i(91277),i(65470),i(40242),i(85197);const s="depthVertexShader",n="attribute position: vec3f;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform viewProjection: mat4x4f;uniform depthValues: vec2f;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vUV: vec2f;uniform diffuseMatrix: mat4x4f;\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#endif\n#ifdef STORE_CAMERASPACE_Z\nuniform view: mat4x4f;varying vViewPos: vec4f;\n#endif\nvarying vDepthMetric: f32;\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;\n#ifdef UV1\nvar uvUpdated: vec2f=input.uv;\n#endif\n#ifdef UV2\nvar uv2Updated: vec2f=input.uv2;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);\n#include<clipPlaneVertex>\nvertexOutputs.position=uniforms.viewProjection*worldPos;\n#ifdef STORE_CAMERASPACE_Z\nvertexOutputs.vViewPos=uniforms.view*worldPos;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetric=((-vertexOutputs.position.z+uniforms.depthValues.x)/(uniforms.depthValues.y));\n#else\nvertexOutputs.vDepthMetric=((vertexOutputs.position.z+uniforms.depthValues.x)/(uniforms.depthValues.y));\n#endif\n#endif\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef UV2\nvertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uv2Updated,1.0,0.0)).xy;\n#endif\n#endif\n}\n";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},49079:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleThicknessPixelShader:()=>n});const r="fluidRenderingParticleThicknessPixelShader",s="uniform float particleAlpha;varying vec2 uv;void main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;float thickness=sqrt(1.0-r2);glFragColor=vec4(vec3(particleAlpha*thickness),1.0);}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},49318:(e,t,i)=>{i.r(t),i.d(t,{_WebAudioStreamingSound:()=>m});var r=i(51137),s=i(998),n=i(15555),o=i(99848),a=i(15904);class l extends a.g{constructor(e){super(e),this.onReadyObservable=new o.cP,this.preloadedPromise=new Promise(((e,t)=>{this._rejectPreloadedProimse=t,this._resolvePreloadedPromise=e})),this.onErrorObservable.add(this._rejectPreloadedProimse),this.onReadyObservable.add(this._resolvePreloadedPromise)}set startOffset(e){this._options.startOffset=e}dispose(){super.dispose(),this.onErrorObservable.clear(),this.onReadyObservable.clear(),this._resolvePreloadedPromise()}}var h=i(82704),c=i(74232),u=i(97774),d=i(73383),p=i(14457);class m extends n.G{constructor(e,t,i){super(e,t),this._spatial=null,this._spatialAutoUpdate=!0,this._spatialMinUpdateTime=0,this._stereo=null,"boolean"==typeof i.spatialAutoUpdate&&(this._spatialAutoUpdate=i.spatialAutoUpdate),"number"==typeof i.spatialMinUpdateTime&&(this._spatialMinUpdateTime=i.spatialMinUpdateTime),this._options={autoplay:i.autoplay??!1,loop:i.loop??!1,maxInstances:i.maxInstances??1/0,preloadCount:i.preloadCount??1,startOffset:i.startOffset??0},this._subGraph=new m._SubGraph(this)}async init(e,t){const i=this.engine.audioContext;if(!(i instanceof AudioContext))throw new Error("Unsupported audio context type.");this.audioContext=i,this.source=e,t.outBus?this.outBus=t.outBus:(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.init(t),(0,h.GB)(t)&&this._initSpatialProperty(),this.preloadCount&&await this.preloadInstances(this.preloadCount),t.autoplay&&this.play(t),this.engine.addNode(this)}get inNode(){return this._subGraph.inNode}get outNode(){return this._subGraph.outNode}get spatial(){return this._spatial?this._spatial:this._initSpatialProperty()}get stereo(){return this._stereo??(this._stereo=new c.i(this._subGraph))}dispose(){super.dispose(),this._spatial=null,this._stereo=null,this._subGraph.dispose(),this.engine.removeNode(this)}getClassName(){return"_WebAudioStreamingSound"}_createInstance(){return new f(this,this._options)}_connect(e){return!!super._connect(e)&&(e.inNode&&this.outNode?.connect(e.inNode),!0)}_disconnect(e){return!!super._disconnect(e)&&(e.inNode&&this.outNode?.disconnect(e.inNode),!0)}_initSpatialProperty(){return this._spatial||(this._spatial=new p.i(this._subGraph,this._spatialAutoUpdate,this._spatialMinUpdateTime)),this._spatial}}m._SubGraph=class extends d.Q{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}};class f extends l{constructor(e,t){super(e),this._currentTimeChangedWhilePaused=!1,this._enginePlayTime=1/0,this._enginePauseTime=0,this._isReady=!1,this._isReadyPromise=new Promise(((e,t)=>{this._resolveIsReadyPromise=e,this._rejectIsReadyPromise=t})),this._onCanPlayThrough=()=>{this._isReady=!0,this._resolveIsReadyPromise(this._mediaElement),this.onReadyObservable.notifyObservers(this)},this._onEnded=()=>{this.onEndedObservable.notifyObservers(this),this.dispose()},this._onError=e=>{this._setState(4),this.onErrorObservable.notifyObservers(e),this._rejectIsReadyPromise(e),this.dispose()},this._onEngineStateChanged=()=>{"running"===this.engine.state&&(this._options.loop&&2===this.state&&this.play(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged))},this._onUserGesture=()=>{this.play()},this._options=t,this._volumeNode=new GainNode(e.audioContext),"string"==typeof e.source?this._initFromUrl(e.source):Array.isArray(e.source)?this._initFromUrls(e.source):e.source instanceof HTMLMediaElement&&this._initFromMediaElement(e.source)}get currentTime(){if(1===this._state)return 0;const e=5===this._state?0:this.engine.currentTime-this._enginePlayTime;return this._enginePauseTime+e+this._options.startOffset}set currentTime(e){const t=2===this._state||3===this._state;t&&(this._mediaElement.pause(),this._setState(1)),this._options.startOffset=e,t?this.play({startOffset:e}):5===this._state&&(this._currentTimeChangedWhilePaused=!0)}get outNode(){return this._volumeNode}get startTime(){return 1===this._state?0:this._enginePlayTime}dispose(){super.dispose(),this.stop(),this._sourceNode?.disconnect(this._volumeNode),this._sourceNode=null,this._mediaElement.removeEventListener("error",this._onError),this._mediaElement.removeEventListener("ended",this._onEnded),this._mediaElement.removeEventListener("canplaythrough",this._onCanPlayThrough);for(const e of Array.from(this._mediaElement.children))this._mediaElement.removeChild(e);this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged),this.engine.userGestureObservable.removeCallback(this._onUserGesture)}play(e={}){if(3===this._state)return;void 0!==e.loop&&(this._options.loop=e.loop),this._mediaElement.loop=this._options.loop;let t=e.startOffset;this._currentTimeChangedWhilePaused?(t=this._options.startOffset,this._currentTimeChangedWhilePaused=!1):5===this._state&&(t=this.currentTime+this._options.startOffset),t&&t>0&&(this._mediaElement.currentTime=t),this._volumeNode.gain.value=e.volume??1,this._play()}pause(){2!==this._state&&3!==this._state||(this._setState(5),this._enginePauseTime+=this.engine.currentTime-this._enginePlayTime,this._mediaElement.pause())}resume(){(5===this._state||this._currentTimeChangedWhilePaused)&&this.play()}stop(){1!==this._state&&this._stop()}getClassName(){return"_WebAudioStreamingSoundInstance"}_connect(e){return!!super._connect(e)&&(e instanceof m&&e.inNode&&this.outNode?.connect(e.inNode),!0)}_disconnect(e){return!!super._disconnect(e)&&(e instanceof m&&e.inNode&&this.outNode?.disconnect(e.inNode),!0)}_initFromMediaElement(e){if(s.S0.SetCorsBehavior(e.currentSrc,e),e.controls=!1,e.loop=this._options.loop,e.preload="auto",e.addEventListener("canplaythrough",this._onCanPlayThrough,{once:!0}),e.addEventListener("ended",this._onEnded,{once:!0}),e.addEventListener("error",this._onError,{once:!0}),e.load(),this._sourceNode=new MediaElementAudioSourceNode(this._sound.audioContext,{mediaElement:e}),this._sourceNode.connect(this._volumeNode),!this._connect(this._sound))throw new Error("Connect failed");this._mediaElement=e}_initFromUrl(e){const t=new Audio((0,u.K)(e));this._initFromMediaElement(t)}_initFromUrls(e){const t=new Audio;for(const i of e){const e=document.createElement("source");e.src=(0,u.K)(i),t.appendChild(e)}this._initFromMediaElement(t)}_play(){if(this._setState(2),this._isReady){if(2===this._state)if("running"===this.engine.state){const e=this._mediaElement.play();this._enginePlayTime=this.engine.currentTime,this._setState(3),e.catch((()=>{this._setState(4),this._options.loop&&this.engine.userGestureObservable.addOnce(this._onUserGesture)}))}else this._options.loop?this.engine.stateChangedObservable.add(this._onEngineStateChanged):(this.stop(),this._setState(4))}else this._playWhenReady()}_playWhenReady(){this._isReadyPromise.then((()=>{this._play()})).catch((()=>{r.V.Error("Streaming sound instance failed to play"),this._setState(4)}))}_stop(){this._mediaElement.pause(),this._setState(1),this._onEnded(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged)}}},50136:(e,t,i)=>{i.r(t),i.d(t,{glowMapGenerationVertexShader:()=>o});var r=i(69610);i(69707),i(18959),i(27999),i(90738),i(71636),i(1218),i(48451),i(15060),i(3298),i(3361),i(65523),i(47314);const s="glowMapGenerationVertexShader",n="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;varying vec4 vPosition;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef DIFFUSE\nvarying vec2 vUVDiffuse;uniform mat4 diffuseMatrix;\n#endif\n#ifdef OPACITY\nvarying vec2 vUVOpacity;uniform mat4 opacityMatrix;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;uniform mat4 emissiveMatrix;\n#endif\n#ifdef VERTEXALPHA\nattribute vec4 color;varying vec4 vColor;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef UV2\nvec2 uv2Updated=uv2;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef CUBEMAP\nvPosition=worldPos;gl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#else\nvPosition=viewProjection*worldPos;gl_Position=vPosition;\n#endif\n#ifdef DIFFUSE\n#ifdef DIFFUSEUV1\nvUVDiffuse=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef DIFFUSEUV2\nvUVDiffuse=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#endif\n#ifdef OPACITY\n#ifdef OPACITYUV1\nvUVOpacity=vec2(opacityMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef OPACITYUV2\nvUVOpacity=vec2(opacityMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#endif\n#ifdef EMISSIVE\n#ifdef EMISSIVEUV1\nvUVEmissive=vec2(emissiveMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef EMISSIVEUV2\nvUVEmissive=vec2(emissiveMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#endif\n#ifdef VERTEXALPHA\nvColor=color;\n#endif\n#include<clipPlaneVertex>\n}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},50186:(e,t,i)=>{i.d(t,{H:()=>c});class r{constructor(){this._createSubNodePromises={},this._isDisposed=!1,this._subNodes={},this._onSubNodeDisposed=e=>{const t=e;delete this._subNodes[t.name],this._onSubNodesChanged()}}callOnSubNode(e,t){const i=this.getSubNode(e);i?t(i):this._createSubNodePromisesResolved().then((()=>{const i=this.getSubNode(e);i?t(i):this.createAndAddSubNode(e).then((e=>{t(e)}))}))}createAndAddSubNode(e){var t;return(t=this._createSubNodePromises)[e]||(t[e]=this._createSubNode(e).then((e=>(this._addSubNode(e),e)))),this._createSubNodePromises[e]}dispose(){this._isDisposed=!0;const e=Object.values(this._subNodes);for(const t of e)t.dispose();this._subNodes={},this._createSubNodePromises={}}getSubNode(e){return this._subNodes[e]??null}async removeSubNode(e){await this._createSubNodePromisesResolved();const t=e.name;this._subNodes[t]&&delete this._subNodes[t],delete this._createSubNodePromises[t],this._onSubNodesChanged()}_createSubNodePromisesResolved(){return Promise.all(Object.values(this._createSubNodePromises))}_addSubNode(e){this._isDisposed?e.dispose():(this._subNodes[e.name]=e,e.onDisposeObservable.addOnce(this._onSubNodeDisposed),this._onSubNodesChanged())}}var s=i(29844),n=i(56744),o=i(21856);class a extends n.Sy{constructor(e){super(e),this.node=new GainNode(e.audioContext)}get volume(){return this.node.gain.value}set volume(e){this.node.gain.value=e}get inNode(){return this.node}get outNode(){return this.node}_connect(e){return!!super._connect(e)&&(e.inNode&&this.node.connect(e.inNode),!0)}_disconnect(e){return!!super._disconnect(e)&&(e.inNode&&this.node.disconnect(e.inNode),!0)}getClassName(){return"_VolumeWebAudioSubNode"}}var l=i(77930);class h extends s.i_{constructor(e){super(e),this._byteFrequencyData=null,this._floatFrequencyData=null,this._analyzerNode=new AnalyserNode(e.audioContext)}get fftSize(){return this._analyzerNode.fftSize}set fftSize(e){e!==this._analyzerNode.fftSize&&(this._analyzerNode.fftSize=e,this._clearArrays())}get inNode(){return this._analyzerNode}get minDecibels(){return this._analyzerNode.minDecibels}set minDecibels(e){this._analyzerNode.minDecibels=e}get maxDecibels(){return this._analyzerNode.maxDecibels}set maxDecibels(e){this._analyzerNode.maxDecibels=e}get smoothing(){return this._analyzerNode.smoothingTimeConstant}set smoothing(e){this._analyzerNode.smoothingTimeConstant=e}dispose(){super.dispose(),this._clearArrays(),this._byteFrequencyData=null,this._floatFrequencyData=null,this._analyzerNode.disconnect()}getClassName(){return"_WebAudioAnalyzerSubNode"}getByteFrequencyData(){return this._byteFrequencyData&&0!==this._byteFrequencyData.length||(this._byteFrequencyData=new Uint8Array(this._analyzerNode.frequencyBinCount)),this._analyzerNode.getByteFrequencyData(this._byteFrequencyData),this._byteFrequencyData}getFloatFrequencyData(){return this._floatFrequencyData&&0!==this._floatFrequencyData.length||(this._floatFrequencyData=new Float32Array(this._analyzerNode.frequencyBinCount)),this._analyzerNode.getFloatFrequencyData(this._floatFrequencyData),this._floatFrequencyData}_clearArrays(){this._byteFrequencyData?.set((0,l.hU)()),this._floatFrequencyData?.set((0,l.Hi)())}}class c extends r{constructor(e){super(),this._outNode=null,this._owner=e}async init(e){const t=(0,o.GA)(e);if(t&&await this.createAndAddSubNode("Analyzer"),await this.createAndAddSubNode("Volume"),await this._createSubNodePromisesResolved(),t){const t=(0,s.CA)(this);if(!t)throw new Error("No analyzer subnode.");t.setOptions(e)}const i=(0,n.sf)(this);if(!i)throw new Error("No volume subnode.");if(i.setOptions(e),"_VolumeWebAudioSubNode"!==i.getClassName())throw new Error("Not a WebAudio subnode.");if(this._outNode=i.node,this._outNode&&this._downstreamNodes){const e=this._downstreamNodes.values();for(let t=e.next();!t.done;t=e.next()){const e=t.value.inNode;e&&this._outNode.connect(e)}}}get inNode(){return this._outNode}get outNode(){return this._outNode}_createSubNode(e){switch(e){case"Analyzer":return async function(e){return new h(e)}(this._owner.engine);case"Volume":return async function(e){return new a(e)}(this._owner.engine);default:throw new Error(`Unknown subnode name: ${e}`)}}_onSubNodesChanged(){const e=(0,s.CA)(this),t=(0,n.sf)(this);e&&t&&t.connect(e)}}},50274:(e,t,i)=>{i.r(t),i.d(t,{hdrFilteringPixelShaderWGSL:()=>o});var r=i(69610);i(79702),i(75136),i(75052),i(58866);const s="hdrFilteringPixelShader",n="#include<helperFunctions>\n#include<importanceSampling>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\nuniform alphaG: f32;var inputTextureSampler: sampler;var inputTexture: texture_cube<f32>;uniform vFilteringInfo: vec2f;uniform hdrScale: f32;varying direction: vec3f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=radiance(uniforms.alphaG,inputTexture,inputTextureSampler,input.direction,uniforms.vFilteringInfo);fragmentOutputs.color= vec4f(color*uniforms.hdrScale,1.0);}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},50452:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphThrottleBlock:()=>o});var r=i(4720),s=i(33006),n=i(56552);class o extends s.w{constructor(e){super(e),this.reset=this._registerSignalInput("reset"),this.duration=this.registerDataInput("duration",r.Es),this.lastRemainingTime=this.registerDataOutput("lastRemainingTime",r.Es,NaN)}_execute(e,t){if(t===this.reset)return this.lastRemainingTime.setValue(NaN,e),e._setExecutionVariable(this,"lastRemainingTime",NaN),void e._setExecutionVariable(this,"timestamp",0);const i=this.duration.getValue(e);if(i<=0||isNaN(i)||!isFinite(i))return this._reportError(e,"Invalid duration in Throttle block");const r=e._getExecutionVariable(this,"lastRemainingTime",NaN),s=Date.now();if(isNaN(r))return this.lastRemainingTime.setValue(0,e),e._setExecutionVariable(this,"lastRemainingTime",0),e._setExecutionVariable(this,"timestamp",s),this.out._activateSignal(e);{const t=s-e._getExecutionVariable(this,"timestamp",0),r=1e3*i;if(r<=t)return this.lastRemainingTime.setValue(0,e),e._setExecutionVariable(this,"lastRemainingTime",0),e._setExecutionVariable(this,"timestamp",s),this.out._activateSignal(e);{const i=r-t;this.lastRemainingTime.setValue(i/1e3,e),e._setExecutionVariable(this,"lastRemainingTime",i)}}}getClassName(){return"FlowGraphThrottleBlock"}}(0,n.Y5)("FlowGraphThrottleBlock",o)},50861:(e,t,i)=>{i.r(t),i.d(t,{colorPixelShaderWGSL:()=>o});var r=i(69610);i(39759),i(66407),i(97715),i(93243);const s="colorPixelShader",n="#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\n#define VERTEXCOLOR\nvarying vColor: vec4f;\n#else\nuniform color: vec4f;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nfragmentOutputs.color=input.vColor;\n#else\nfragmentOutputs.color=uniforms.color;\n#endif\n#include<fogFragment>(color,fragmentOutputs.color)\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},50890:(e,t,i)=>{i.r(t),i.d(t,{grainPixelShader:()=>o});var r=i(69610);i(73325);const s="grainPixelShader",n="#include<helperFunctions>\nuniform sampler2D textureSampler; \nuniform float intensity;uniform float animatedSeed;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(textureSampler,vUV);vec2 seed=vUV*(animatedSeed);float grain=dither(seed,intensity);float lum=getLuminance(gl_FragColor.rgb);float grainAmount=(cos(-PI+(lum*PI*2.))+1.)/2.;gl_FragColor.rgb+=grain*grainAmount;gl_FragColor.rgb=max(gl_FragColor.rgb,0.0);}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},50926:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphGetVariableBlock:()=>o});var r=i(71294),s=i(4720),n=i(56552);class o extends r.e{constructor(e){super(e),this.config=e,this.value=this.registerDataOutput("value",s.Vv,e.initialValue)}_updateOutputs(e){const t=this.config.variable;e.hasVariable(t)&&this.value.setValue(e.getVariable(t),e)}serialize(e){super.serialize(e),e.config.variable=this.config.variable}getClassName(){return"FlowGraphGetVariableBlock"}}(0,n.Y5)("FlowGraphGetVariableBlock",o)},50994:(e,t,i)=>{i.r(t),i.d(t,{_DDSTextureLoader:()=>n});var r=i(77517),s=i(36464);class n{constructor(){this.supportCascades=!0}loadCubeData(e,t,i,n){const o=t.getEngine();let a,l=!1,h=1e3;if(Array.isArray(e))for(let i=0;i<e.length;i++){const r=e[i];a=s.DDSTools.GetDDSInfo(r),t.width=a.width,t.height=a.height,l=(a.isRGB||a.isLuminance||a.mipmapCount>1)&&t.generateMipMaps,o._unpackFlipY(a.isCompressed),s.DDSTools.UploadDDSLevels(o,t,r,a,l,6,-1,i),a.isFourCC||1!==a.mipmapCount?h=a.mipmapCount-1:o.generateMipMapsForCubemap(t)}else{const n=e;a=s.DDSTools.GetDDSInfo(n),t.width=a.width,t.height=a.height,i&&(a.sphericalPolynomial=new r.Q),l=(a.isRGB||a.isLuminance||a.mipmapCount>1)&&t.generateMipMaps,o._unpackFlipY(a.isCompressed),s.DDSTools.UploadDDSLevels(o,t,n,a,l,6),a.isFourCC||1!==a.mipmapCount?h=a.mipmapCount-1:o.generateMipMapsForCubemap(t,!1)}o._setCubeMapTextureParams(t,l,h),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n({isDDS:!0,width:t.width,info:a,data:e,texture:t})}loadData(e,t,i){const r=s.DDSTools.GetDDSInfo(e),n=(r.isRGB||r.isLuminance||r.mipmapCount>1)&&t.generateMipMaps&&Math.max(r.width,r.height)>>r.mipmapCount-1==1;i(r.width,r.height,n,r.isFourCC,(()=>{s.DDSTools.UploadDDSLevels(t.getEngine(),t,e,r,n,1)}))}}},51339:(e,t,i)=>{const r="fresnelFunction",s="#ifdef FRESNEL\nfloat computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)\n{float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}\n#endif\n";i(69610).l.IncludesShadersStore[r]=s},51537:(e,t,i)=>{i.r(t),i.d(t,{convolutionPixelShader:()=>n});const r="convolutionPixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform float kernel[9];\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 onePixel=vec2(1.0,1.0)/screenSize;vec4 colorSum =\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,-1))*kernel[0] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,-1))*kernel[1] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,-1))*kernel[2] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0))*kernel[3] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,0))*kernel[4] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0))*kernel[5] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,1))*kernel[6] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1))*kernel[7] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,1))*kernel[8];float kernelWeight =\nkernel[0] +\nkernel[1] +\nkernel[2] +\nkernel[3] +\nkernel[4] +\nkernel[5] +\nkernel[6] +\nkernel[7] +\nkernel[8];if (kernelWeight<=0.0) {kernelWeight=1.0;}\ngl_FragColor=vec4((colorSum/kernelWeight).rgb,1);}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},52046:(e,t,i)=>{i.d(t,{Z:()=>c});var r=i(75524),s=i(79259),n=i(79923),o=i(4870),a=i(64704),l=i(83316),h=i(56552);o.b.AddNodeConstructor("Light_Type_1",((e,t)=>()=>new c(e,n.Pq.Zero(),t)));class c extends l.p{get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e}constructor(e,t,i){super(e,i),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=t.scale(-1),this.direction=t}getClassName(){return"DirectionalLight"}getTypeID(){return a.v.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)}_setDefaultFixedFrustumShadowProjectionMatrix(e){const t=this.getScene().activeCamera;t&&n.uq.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,void 0!==this.shadowMinZ?this.shadowMinZ:t.minZ,void 0!==this.shadowMaxZ?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(e,t,i){const r=this.getScene().activeCamera;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){const e=n.Pq.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=-Number.MAX_VALUE,this._orthoTop=-Number.MAX_VALUE,this._orthoBottom=Number.MAX_VALUE;let r=Number.MAX_VALUE,s=-Number.MAX_VALUE;for(let o=0;o<i.length;o++){const a=i[o];if(!a)continue;const l=a.getBoundingInfo().boundingBox;for(let i=0;i<l.vectorsWorld.length;i++)n.Pq.TransformCoordinatesToRef(l.vectorsWorld[i],t,e),e.x<this._orthoLeft&&(this._orthoLeft=e.x),e.y<this._orthoBottom&&(this._orthoBottom=e.y),e.x>this._orthoRight&&(this._orthoRight=e.x),e.y>this._orthoTop&&(this._orthoTop=e.y),this.autoCalcShadowZBounds&&(e.z<r&&(r=e.z),e.z>s&&(s=e.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=r,this._shadowMaxZ=s)}const s=this._orthoRight-this._orthoLeft,o=this._orthoTop-this._orthoBottom,a=void 0!==this.shadowMinZ?this.shadowMinZ:r?.minZ||0,l=void 0!==this.shadowMaxZ?this.shadowMaxZ:r?.maxZ||1e4,h=this.getScene().getEngine().useReverseDepthBuffer;n.uq.OrthoOffCenterLHToRef(this._orthoLeft-s*this.shadowOrthoScale,this._orthoRight+s*this.shadowOrthoScale,this._orthoBottom-o*this.shadowOrthoScale,this._orthoTop+o*this.shadowOrthoScale,h?l:a,h?a:l,e,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this)}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?(e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(e){const t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}getDepthMaxZ(e){const t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,t){e["DIRLIGHT"+t]=!0}}(0,r.Cg)([(0,s.lK)()],c.prototype,"shadowFrustumSize",null),(0,r.Cg)([(0,s.lK)()],c.prototype,"shadowOrthoScale",null),(0,r.Cg)([(0,s.lK)()],c.prototype,"autoUpdateExtends",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"autoCalcShadowZBounds",void 0),(0,r.Cg)([(0,s.lK)("orthoLeft")],c.prototype,"_orthoLeft",void 0),(0,r.Cg)([(0,s.lK)("orthoRight")],c.prototype,"_orthoRight",void 0),(0,r.Cg)([(0,s.lK)("orthoTop")],c.prototype,"_orthoTop",void 0),(0,r.Cg)([(0,s.lK)("orthoBottom")],c.prototype,"_orthoBottom",void 0),(0,h.Y5)("BABYLON.DirectionalLight",c)},52047:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphPlayAnimationBlock:()=>a});var r=i(51e3),s=i(4720),n=i(56552),o=i(97689);class a extends r.M{constructor(e){super(e,["animationLoop","animationEnd","animationGroupLoop"]),this.config=e,this.speed=this.registerDataInput("speed",s.Es),this.loop=this.registerDataInput("loop",s.RI),this.from=this.registerDataInput("from",s.Es,0),this.to=this.registerDataInput("to",s.Es),this.currentFrame=this.registerDataOutput("currentFrame",s.Es),this.currentTime=this.registerDataOutput("currentTime",s.Es),this.currentAnimationGroup=this.registerDataOutput("currentAnimationGroup",s.Vv),this.animationGroup=this.registerDataInput("animationGroup",s.Vv,e?.animationGroup),this.animation=this.registerDataInput("animation",s.Vv),this.object=this.registerDataInput("object",s.Vv)}_preparePendingTasks(e){const t=this.animationGroup.getValue(e),i=this.animation.getValue(e);if(!t&&!i)return this._reportError(e,"No animation or animation group provided");{const r=this.currentAnimationGroup.getValue(e);r&&r!==t&&r.dispose();let s=t;if(i&&!s){const t=this.object.getValue(e);if(!t)return this._reportError(e,"No target object provided");const r=Array.isArray(i)?i:[i],n=r[0].name;s=new o.AnimationGroup("flowGraphAnimationGroup-"+n+"-"+t.name,e.configuration.scene);let a=!1;const l=e._getGlobalContextVariable("interpolationAnimations",[]);for(const e of r)s.addTargetedAnimation(e,t),-1!==l.indexOf(e.uniqueId)&&(a=!0);a&&this._checkInterpolationDuplications(e,r,t)}const n=this.speed.getValue(e)||1,a=this.from.getValue(e)??0,l=this.to.getValue(e)||s.to,h=!isFinite(l)||this.loop.getValue(e);this.currentAnimationGroup.setValue(s,e);const c=e._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);-1!==c.indexOf(s.uniqueId)&&s.stop();try{s.start(h,n,a,l),s.onAnimationGroupEndObservable.add((()=>this._onAnimationGroupEnd(e))),s.onAnimationEndObservable.add((()=>this._eventsSignalOutputs.animationEnd._activateSignal(e))),s.onAnimationLoopObservable.add((()=>this._eventsSignalOutputs.animationLoop._activateSignal(e))),s.onAnimationGroupLoopObservable.add((()=>this._eventsSignalOutputs.animationGroupLoop._activateSignal(e))),c.push(s.uniqueId),e._setGlobalContextVariable("currentlyRunningAnimationGroups",c)}catch(t){this._reportError(e,t)}}}_reportError(e,t){super._reportError(e,t),this.currentFrame.setValue(-1,e),this.currentTime.setValue(-1,e)}_executeOnTick(e){const t=this.currentAnimationGroup.getValue(e);t&&(this.currentFrame.setValue(t.getCurrentFrame(),e),this.currentTime.setValue(t.animatables[0]?.elapsedTime??0,e))}_execute(e){this._startPendingTasks(e)}_onAnimationGroupEnd(e){this._removeFromCurrentlyRunning(e,this.currentAnimationGroup.getValue(e)),this._resetAfterCanceled(e),this.done._activateSignal(e)}_checkInterpolationDuplications(e,t,i){const r=e._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);for(const s of r){const r=e.assetsContext.animationGroups.find((e=>e.uniqueId===s));if(r)for(const s of r.targetedAnimations)for(const n of t)s.animation.targetProperty===n.targetProperty&&s.target===i&&this._stopAnimationGroup(e,r)}}_stopAnimationGroup(e,t){t.stop(!0),t.dispose(),this._removeFromCurrentlyRunning(e,t)}_removeFromCurrentlyRunning(e,t){const i=e._getGlobalContextVariable("currentlyRunningAnimationGroups",[]),r=i.indexOf(t.uniqueId);-1!==r&&(i.splice(r,1),e._setGlobalContextVariable("currentlyRunningAnimationGroups",i))}_cancelPendingTasks(e){const t=this.currentAnimationGroup.getValue(e);t&&this._stopAnimationGroup(e,t)}getClassName(){return"FlowGraphPlayAnimationBlock"}}(0,n.Y5)("FlowGraphPlayAnimationBlock",a)},52053:(e,t,i)=>{i.d(t,{FA:()=>g,O_:()=>_,uT:()=>x});var r=i(51137);const s=1,n=2,o=3,a=9,l=10,h=11,c=48,u=4,d=0,p=1,m=2,f=3;function _(e){let t=0;return{id_length:e[t++],colormap_type:e[t++],image_type:e[t++],colormap_index:e[t++]|e[t++]<<8,colormap_length:e[t++]|e[t++]<<8,colormap_size:e[t++],origin:[e[t++]|e[t++]<<8,e[t++]|e[t++]<<8],width:e[t++]|e[t++]<<8,height:e[t++]|e[t++]<<8,pixel_size:e[t++],flags:e[t++]}}function g(e,t){if(t.length<19)return void r.V.Error("Unable to load TGA file - Not enough data to contain header");let i=18;const g=_(t);if(g.id_length+i>t.length)return void r.V.Error("Unable to load TGA file - Not enough data");i+=g.id_length;let v,S=!1,b=!1,y=!1;switch(g.image_type){case a:S=!0;case s:b=!0;break;case l:S=!0;case n:break;case h:S=!0;case o:y=!0}const P=g.pixel_size>>3,T=g.width*g.height*P;let C,E,A,I,R,M,D;if(b&&(C=t.subarray(i,i+=g.colormap_length*(g.colormap_size>>3))),S){let e,r,s;v=new Uint8Array(T);let n=0;const o=new Uint8Array(P);for(;i<T&&n<T;)if(e=t[i++],r=1+(127&e),128&e){for(s=0;s<P;++s)o[s]=t[i++];for(s=0;s<r;++s)v.set(o,n+s*P);n+=P*r}else{for(r*=P,s=0;s<r;++s)v[n+s]=t[i++];n+=r}}else v=t.subarray(i,i+=b?g.width*g.height:T);switch((g.flags&c)>>u){default:case m:E=0,I=1,D=g.width,A=0,R=1,M=g.height;break;case d:E=0,I=1,D=g.width,A=g.height-1,R=-1,M=-1;break;case f:E=g.width-1,I=-1,D=-1,A=0,R=1,M=g.height;break;case p:E=g.width-1,I=-1,D=-1,A=g.height-1,R=-1,M=-1}const O="_getImageData"+(y?"Grey":"")+g.pixel_size+"bits",N=x[O](g,C,v,A,R,M,E,I,D);e.getEngine()._uploadDataToTextureDirectly(e,N)}const x={GetTGAHeader:_,UploadContent:g,_getImageData8bits:function(e,t,i,r,s,n,o,a,l){const h=i,c=t,u=e.width,d=e.height;let p,m,f,_=0;const g=new Uint8Array(u*d*4);for(f=r;f!==n;f+=s)for(m=o;m!==l;m+=a,_++)p=h[_],g[4*(m+u*f)+3]=255,g[4*(m+u*f)+2]=c[3*p+0],g[4*(m+u*f)+1]=c[3*p+1],g[4*(m+u*f)+0]=c[3*p+2];return g},_getImageData16bits:function(e,t,i,r,s,n,o,a,l){const h=i,c=e.width,u=e.height;let d,p,m,f=0;const _=new Uint8Array(c*u*4);for(m=r;m!==n;m+=s)for(p=o;p!==l;p+=a,f+=2){d=h[f+0]+(h[f+1]<<8);const e=255*((31744&d)>>10)/31|0,t=255*((992&d)>>5)/31|0,i=255*(31&d)/31|0;_[4*(p+c*m)+0]=e,_[4*(p+c*m)+1]=t,_[4*(p+c*m)+2]=i,_[4*(p+c*m)+3]=32768&d?0:255}return _},_getImageData24bits:function(e,t,i,r,s,n,o,a,l){const h=i,c=e.width,u=e.height;let d,p,m=0;const f=new Uint8Array(c*u*4);for(p=r;p!==n;p+=s)for(d=o;d!==l;d+=a,m+=3)f[4*(d+c*p)+3]=255,f[4*(d+c*p)+2]=h[m+0],f[4*(d+c*p)+1]=h[m+1],f[4*(d+c*p)+0]=h[m+2];return f},_getImageData32bits:function(e,t,i,r,s,n,o,a,l){const h=i,c=e.width,u=e.height;let d,p,m=0;const f=new Uint8Array(c*u*4);for(p=r;p!==n;p+=s)for(d=o;d!==l;d+=a,m+=4)f[4*(d+c*p)+2]=h[m+0],f[4*(d+c*p)+1]=h[m+1],f[4*(d+c*p)+0]=h[m+2],f[4*(d+c*p)+3]=h[m+3];return f},_getImageDataGrey8bits:function(e,t,i,r,s,n,o,a,l){const h=i,c=e.width,u=e.height;let d,p,m,f=0;const _=new Uint8Array(c*u*4);for(m=r;m!==n;m+=s)for(p=o;p!==l;p+=a,f++)d=h[f],_[4*(p+c*m)+0]=d,_[4*(p+c*m)+1]=d,_[4*(p+c*m)+2]=d,_[4*(p+c*m)+3]=255;return _},_getImageDataGrey16bits:function(e,t,i,r,s,n,o,a,l){const h=i,c=e.width,u=e.height;let d,p,m=0;const f=new Uint8Array(c*u*4);for(p=r;p!==n;p+=s)for(d=o;d!==l;d+=a,m+=2)f[4*(d+c*p)+0]=h[m+0],f[4*(d+c*p)+1]=h[m+0],f[4*(d+c*p)+2]=h[m+0],f[4*(d+c*p)+3]=h[m+1];return f}}},52150:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingRenderPixelShaderWGSL:()=>n});const r="fluidRenderingRenderPixelShader",s="#define DISABLE_UNIFORMITY_ANALYSIS\n#define IOR 1.333\n#define ETA 1.0/IOR\n#define F0 0.02\nvar textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;\n#ifdef FLUIDRENDERING_DIFFUSETEXTURE\nvar diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#else\nuniform diffuseColor: vec3f;\n#endif\n#ifdef FLUIDRENDERING_FIXED_THICKNESS\nuniform thickness: f32;var bgDepthSamplerSampler: sampler;var bgDepthSampler: texture_2d<f32>;\n#else\nuniform minimumThickness: f32;var thicknessSamplerSampler: sampler;var thicknessSampler: texture_2d<f32>;\n#endif\n#ifdef FLUIDRENDERING_ENVIRONMENT\nvar reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;\n#endif\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)\nvar debugSamplerSampler: sampler;var debugSampler: texture_2d<f32>;\n#endif\nuniform viewMatrix: mat4x4f;uniform projectionMatrix: mat4x4f;uniform invProjectionMatrix: mat4x4f;uniform texelSize: vec2f;uniform dirLight: vec3f;uniform cameraFar: f32;uniform density: f32;uniform refractionStrength: f32;uniform fresnelClamp: f32;uniform specularPower: f32;varying vUV: vec2f;fn computeViewPosFromUVDepth(texCoord: vec2f,depth: f32)->vec3f {var ndc: vec4f=vec4f(texCoord*2.0-1.0,0.0,1.0);\n#ifdef FLUIDRENDERING_RHS\nndc.z=-uniforms.projectionMatrix[2].z+uniforms.projectionMatrix[3].z/depth;\n#else\nndc.z=uniforms.projectionMatrix[2].z+uniforms.projectionMatrix[3].z/depth;\n#endif\nndc.w=1.0;var eyePos: vec4f=uniforms.invProjectionMatrix*ndc;return eyePos.xyz/eyePos.w;}\nfn getViewPosFromTexCoord(texCoord: vec2f)->vec3f {var depth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,texCoord,0.).x;return computeViewPosFromUVDepth(texCoord,depth);}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var texCoord: vec2f=input.vUV;\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)\nvar color: vec4f=textureSample(debugSampler,debugSamplerSampler,texCoord);\n#ifdef FLUIDRENDERING_DEBUG_DEPTH\nfragmentOutputs.color=vec4f(color.rgb/vec3f(2.0),1.);if (color.r>0.999 && color.g>0.999) {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,texCoord);}\n#else\nfragmentOutputs.color=vec4f(color.rgb,1.);if (color.r<0.001 && color.g<0.001 && color.b<0.001) {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,texCoord);}\n#endif\nreturn fragmentOutputs;\n#endif\nvar depthVel: vec2f=textureSampleLevel(depthSampler,depthSamplerSampler,texCoord,0.).rg;var depth: f32=depthVel.r;\n#ifndef FLUIDRENDERING_FIXED_THICKNESS\nvar thickness: f32=textureSample(thicknessSampler,thicknessSamplerSampler,texCoord).x;\n#else\nvar thickness: f32=uniforms.thickness;var bgDepth: f32=textureSample(bgDepthSampler,bgDepthSamplerSampler,texCoord).x;var depthNonLinear: f32=uniforms.projectionMatrix[2].z+uniforms.projectionMatrix[3].z/depth;depthNonLinear=depthNonLinear*0.5+0.5;\n#endif\nvar backColor: vec4f=textureSample(textureSampler,textureSamplerSampler,texCoord);\n#ifndef FLUIDRENDERING_FIXED_THICKNESS\nif (depth>=uniforms.cameraFar || depth<=0. || thickness<=uniforms.minimumThickness) {\n#else\nif (depth>=uniforms.cameraFar || depth<=0. || bgDepth<=depthNonLinear) {\n#endif\n#ifdef FLUIDRENDERING_COMPOSITE_MODE\nfragmentOutputs.color=vec4f(backColor.rgb*backColor.a,backColor.a);\n#else\nfragmentOutputs.color=backColor;\n#endif\nreturn fragmentOutputs;}\nvar viewPos: vec3f=computeViewPosFromUVDepth(texCoord,depth);var ddx: vec3f=getViewPosFromTexCoord(texCoord+vec2f(uniforms.texelSize.x,0.))-viewPos;var ddy: vec3f=getViewPosFromTexCoord(texCoord+vec2f(0.,uniforms.texelSize.y))-viewPos;var ddx2: vec3f=viewPos-getViewPosFromTexCoord(texCoord+vec2f(-uniforms.texelSize.x,0.));if (abs(ddx.z)>abs(ddx2.z)) {ddx=ddx2;}\nvar ddy2: vec3f=viewPos-getViewPosFromTexCoord(texCoord+vec2f(0.,-uniforms.texelSize.y));if (abs(ddy.z)>abs(ddy2.z)) {ddy=ddy2;}\nvar normal: vec3f=normalize(cross(ddy,ddx));\n#ifdef FLUIDRENDERING_RHS\nnormal=-normal;\n#endif\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_SHOWNORMAL)\nfragmentOutputs.color=vec4f(normal*0.5+0.5,1.0);return fragmentOutputs;\n#endif\nvar rayDir: vec3f=normalize(viewPos); \n#ifdef FLUIDRENDERING_DIFFUSETEXTURE\nvar diffuseColor: vec3f=textureSampleLevel(diffuseSampler,diffuseSamplerSampler,texCoord,0.0).rgb;\n#else\nvar diffuseColor: vec3f=uniforms.diffuseColor;\n#endif\nvar lightDir: vec3f=normalize((uniforms.viewMatrix*vec4f(-uniforms.dirLight,0.)).xyz);var H: vec3f =normalize(lightDir-rayDir);var specular: f32 =pow(max(0.0,dot(H,normal)),uniforms.specularPower);\n#ifdef FLUIDRENDERING_DEBUG_DIFFUSERENDERING\nvar diffuse: f32 =max(0.0,dot(lightDir,normal))*1.0;fragmentOutputs.color=vec4f(vec3f(0.1) /*ambient*/+vec3f(0.42,0.50,1.00)*diffuse+vec3f(0,0,0.2)+specular,1.);return fragmentOutputs;\n#endif\nvar refractionDir: vec3f=refract(rayDir,normal,ETA);var transmitted: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,vec2f(texCoord+refractionDir.xy*thickness*uniforms.refractionStrength),0.0);\n#ifdef FLUIDRENDERING_COMPOSITE_MODE\nif (transmitted.a==0.) {transmitted.a=thickness;}\n#endif\nvar transmittance: vec3f=exp(-uniforms.density*thickness*(1.0-diffuseColor)); \nvar refractionColor: vec3f=transmitted.rgb*transmittance;\n#ifdef FLUIDRENDERING_ENVIRONMENT\nvar reflectionDir: vec3f=reflect(rayDir,normal);var reflectionColor: vec3f=(textureSample(reflectionSampler,reflectionSamplerSampler,reflectionDir).rgb);var fresnel: f32=clamp(F0+(1.0-F0)*pow(1.0-dot(normal,-rayDir),5.0),0.,uniforms.fresnelClamp);var finalColor: vec3f=mix(refractionColor,reflectionColor,fresnel)+specular;\n#else\nvar finalColor: vec3f=refractionColor+specular;\n#endif\n#ifdef FLUIDRENDERING_VELOCITY\nvar velocity: f32=depthVel.g;finalColor=mix(finalColor,vec3f(1.0),smoothstep(0.3,1.0,velocity/6.0));\n#endif\nfragmentOutputs.color=vec4f(finalColor,transmitted.a);}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},52383:(e,t,i)=>{const r="kernelBlurVaryingDeclaration",s="varying sampleCoord{X}: vec2f;";i(69610).l.IncludesShadersStoreWGSL[r]=s},52906:(e,t,i)=>{i.r(t),i.d(t,{convolutionPixelShaderWGSL:()=>n});const r="convolutionPixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;uniform kernel: array<f32,9>;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var onePixel: vec2f= vec2f(1.0,1.0)/uniforms.screenSize;var colorSum: vec4f =\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(-1,-1))*uniforms.kernel[0] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(0,-1))*uniforms.kernel[1] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(1,-1))*uniforms.kernel[2] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(-1,0))*uniforms.kernel[3] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(0,0))*uniforms.kernel[4] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(1,0))*uniforms.kernel[5] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(-1,1))*uniforms.kernel[6] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(0,1))*uniforms.kernel[7] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(1,1))*uniforms.kernel[8];var kernelWeight: f32 =\nuniforms.kernel[0] +\nuniforms.kernel[1] +\nuniforms.kernel[2] +\nuniforms.kernel[3] +\nuniforms.kernel[4] +\nuniforms.kernel[5] +\nuniforms.kernel[6] +\nuniforms.kernel[7] +\nuniforms.kernel[8];if (kernelWeight<=0.0) {kernelWeight=1.0;}\nfragmentOutputs.color= vec4f((colorSum/kernelWeight).rgb,1);}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},53208:(e,t,i)=>{i.r(t),i.d(t,{fxaaVertexShaderWGSL:()=>n});const r="fxaaVertexShader",s="attribute position: vec2f;uniform texelSize: vec2f;varying vUV: vec2f;varying sampleCoordS: vec2f;varying sampleCoordE: vec2f;varying sampleCoordN: vec2f;varying sampleCoordW: vec2f;varying sampleCoordNW: vec2f;varying sampleCoordSE: vec2f;varying sampleCoordNE: vec2f;varying sampleCoordSW: vec2f;const madd: vec2f= vec2f(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.vUV=(input.position*madd+madd);vertexOutputs.sampleCoordS=vertexOutputs.vUV+ vec2f( 0.0,1.0)*uniforms.texelSize;vertexOutputs.sampleCoordE=vertexOutputs.vUV+ vec2f( 1.0,0.0)*uniforms.texelSize;vertexOutputs.sampleCoordN=vertexOutputs.vUV+ vec2f( 0.0,-1.0)*uniforms.texelSize;vertexOutputs.sampleCoordW=vertexOutputs.vUV+ vec2f(-1.0,0.0)*uniforms.texelSize;vertexOutputs.sampleCoordNW=vertexOutputs.vUV+ vec2f(-1.0,-1.0)*uniforms.texelSize;vertexOutputs.sampleCoordSE=vertexOutputs.vUV+ vec2f( 1.0,1.0)*uniforms.texelSize;vertexOutputs.sampleCoordNE=vertexOutputs.vUV+ vec2f( 1.0,-1.0)*uniforms.texelSize;vertexOutputs.sampleCoordSW=vertexOutputs.vUV+ vec2f(-1.0,1.0)*uniforms.texelSize;vertexOutputs.position=vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},53696:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphCallCounterBlock:()=>o});var r=i(4720),s=i(33006),n=i(56552);class o extends s.w{constructor(e){super(e),this.count=this.registerDataOutput("count",r.Es),this.reset=this._registerSignalInput("reset")}_execute(e,t){if(t===this.reset)return e._setExecutionVariable(this,"count",0),void this.count.setValue(0,e);const i=e._getExecutionVariable(this,"count",0)+1;e._setExecutionVariable(this,"count",i),this.count.setValue(i,e),this.out._activateSignal(e)}getClassName(){return"FlowGraphCallCounterBlock"}}(0,n.Y5)("FlowGraphCallCounterBlock",o)},53813:(e,t,i)=>{i.r(t),i.d(t,{colorCorrectionPixelShaderWGSL:()=>n});const r="colorCorrectionPixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;varying vUV: vec2f;var colorTableSampler: sampler;var colorTable: texture_2d<f32>;const SLICE_COUNT: f32=16.0; \nfn sampleAs3DTexture(uv: vec3f,width: f32)->vec4f {var sliceSize: f32=1.0/width; \nvar slicePixelSize: f32=sliceSize/width; \nvar sliceInnerSize: f32=slicePixelSize*(width-1.0); \nvar zSlice0: f32=min(floor(uv.z*width),width-1.0);var zSlice1: f32=min(zSlice0+1.0,width-1.0);var xOffset: f32=slicePixelSize*0.5+uv.x*sliceInnerSize;var s0: f32=xOffset+(zSlice0*sliceSize);var s1: f32=xOffset+(zSlice1*sliceSize);var slice0Color: vec4f=textureSample(colorTable,colorTableSampler,vec2f(s0,uv.y));var slice1Color: vec4f=textureSample(colorTable,colorTableSampler,vec2f(s1,uv.y));var zOffset: f32=((uv.z*width)%(1.0));return mix(slice0Color,slice1Color,zOffset);}\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var screen_color: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);fragmentOutputs.color=sampleAs3DTexture(screen_color.rgb,SLICE_COUNT);}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},53880:(e,t,i)=>{i.r(t),i.d(t,{lensFlarePixelShaderWGSL:()=>n});const r="lensFlarePixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform color: vec4f;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvar baseColor: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);fragmentOutputs.color=baseColor*uniforms.color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},54069:(e,t,i)=>{i.r(t),i.d(t,{displayPassPixelShaderWGSL:()=>n});const r="displayPassPixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var passSamplerSampler: sampler;var passSampler: texture_2d<f32>;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(passSampler,passSamplerSampler,input.vUV);}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},54509:(e,t,i)=>{i.r(t),i.d(t,{kernelBlurPixelShader:()=>c});var r=i(69610);i(17382),i(8334);const s="kernelBlurFragment",n="#ifdef DOF\nfactor=sampleCoC(sampleCoord{X}); \ncomputedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;\n#endif\n";r.l.IncludesShadersStore[s]=n;const o="kernelBlurFragment2",a="#ifdef DOF\nfactor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_DEP_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;\n#endif\n";r.l.IncludesShadersStore[o]=a;const l="kernelBlurPixelShader",h="uniform sampler2D textureSampler;uniform vec2 delta;varying vec2 sampleCenter;\n#ifdef DOF\nuniform sampler2D circleOfConfusionSampler;float sampleCoC(in vec2 offset) {float coc=texture2D(circleOfConfusionSampler,offset).r;return coc; }\n#endif\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#ifdef PACKEDFLOAT\n#include<packingFunctions>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float computedWeight=0.0;\n#ifdef PACKEDFLOAT\nfloat blend=0.;\n#else\nvec4 blend=vec4(0.);\n#endif\n#ifdef DOF\nfloat sumOfWeights=CENTER_WEIGHT; \nfloat factor=0.0;\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;\n#else\nblend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;\n#endif\n#endif\n#include<kernelBlurFragment>[0..varyingCount]\n#include<kernelBlurFragment2>[0..depCount]\n#ifdef PACKEDFLOAT\ngl_FragColor=pack(blend);\n#else\ngl_FragColor=blend;\n#endif\n#ifdef DOF\ngl_FragColor/=sumOfWeights;\n#endif\n}";r.l.ShadersStore[l]=h;const c={name:l,shader:h}},54561:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererMaskerVertexShader:()=>n});const r="meshUVSpaceRendererMaskerVertexShader",s="attribute vec2 uv;varying vec2 vUV;void main(void) {gl_Position=vec4(vec2(uv.x,uv.y)*2.0-1.0,0.,1.0);vUV=uv;}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},54577:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleThicknessVertexShader:()=>n});const r="fluidRenderingParticleThicknessVertexShader",s="attribute vec3 position;attribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;void main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;vec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;gl_Position=projection*vec4(viewPos,1.0);uv=offset;}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},55144:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphBranchBlock:()=>o});var r=i(4720),s=i(16972),n=i(56552);class o extends s.u{constructor(e){super(e),this.condition=this.registerDataInput("condition",r.RI),this.onTrue=this._registerSignalOutput("onTrue"),this.onFalse=this._registerSignalOutput("onFalse")}_execute(e){this.condition.getValue(e)?this.onTrue._activateSignal(e):this.onFalse._activateSignal(e)}getClassName(){return"FlowGraphBranchBlock"}}(0,n.Y5)("FlowGraphBranchBlock",o)},55491:(e,t,i)=>{i.r(t),i.d(t,{extractHighlightsPixelShader:()=>o});var r=i(69610);i(73325);const s="extractHighlightsPixelShader",n="#include<helperFunctions>\nvarying vec2 vUV;uniform sampler2D textureSampler;uniform float threshold;uniform float exposure;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=texture2D(textureSampler,vUV);float luma=dot(LuminanceEncodeApprox,gl_FragColor.rgb*exposure);gl_FragColor.rgb=step(threshold,luma)*gl_FragColor.rgb;}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},55779:(e,t,i)=>{i.r(t),i.d(t,{hdrFilteringPixelShader:()=>o});var r=i(69610);i(73325),i(21469),i(8709),i(78741);const s="hdrFilteringPixelShader",n="#include<helperFunctions>\n#include<importanceSampling>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\nuniform float alphaG;uniform samplerCube inputTexture;uniform vec2 vFilteringInfo;uniform float hdrScale;varying vec3 direction;void main() {vec3 color=radiance(alphaG,inputTexture,direction,vFilteringInfo);gl_FragColor=vec4(color*hdrScale,1.0);}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},56560:(e,t,i)=>{i.r(t),i.d(t,{_WebAudioBus:()=>l});var r=i(46900),s=i(82704),n=i(74232),o=i(73383),a=i(14457);class l extends r.l{constructor(e,t,i){super(e,t),this._spatial=null,this._spatialAutoUpdate=!0,this._spatialMinUpdateTime=0,this._stereo=null,"boolean"==typeof i.spatialAutoUpdate&&(this._spatialAutoUpdate=i.spatialAutoUpdate),"number"==typeof i.spatialMinUpdateTime&&(this._spatialMinUpdateTime=i.spatialMinUpdateTime),this._subGraph=new l._SubGraph(this),this.audioContext=t.audioContext}async init(e){e.outBus?this.outBus=e.outBus:(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.init(e),(0,s.GB)(e)&&this._initSpatialProperty(),this.engine.addNode(this)}dispose(){super.dispose(),this._spatial=null,this._stereo=null,this.engine.removeNode(this)}get inNode(){return this._subGraph.inNode}get outNode(){return this._subGraph.outNode}get spatial(){return this._spatial?this._spatial:this._initSpatialProperty()}get stereo(){return this._stereo??(this._stereo=new n.i(this._subGraph))}getClassName(){return"_WebAudioBus"}_initSpatialProperty(){return this._spatial||(this._spatial=new a.i(this._subGraph,this._spatialAutoUpdate,this._spatialMinUpdateTime)),this._spatial}}l._SubGraph=class extends o.Q{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}}},56744:(e,t,i)=>{i.d(t,{Sy:()=>n,pN:()=>a,sf:()=>o});var r=i(80516);const s={volume:1};class n extends r.e{constructor(e){super("Volume",e)}setOptions(e){this.volume=e.volume??s.volume}}function o(e){return e.getSubNode("Volume")}function a(e,t){return o(e)?.[t]??s[t]}},57094:(e,t,i)=>{i.r(t),i.d(t,{glowBlurPostProcessPixelShader:()=>n});const r="glowBlurPostProcessPixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform vec2 direction;uniform float blurWidth;float getLuminance(vec3 color)\n{return dot(color,vec3(0.2126,0.7152,0.0722));}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float weights[7];weights[0]=0.05;weights[1]=0.1;weights[2]=0.2;weights[3]=0.3;weights[4]=0.2;weights[5]=0.1;weights[6]=0.05;vec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);vec2 texelStep=texelSize*direction*blurWidth;vec2 start=vUV-3.0*texelStep;vec4 baseColor=vec4(0.,0.,0.,0.);vec2 texelOffset=vec2(0.,0.);for (int i=0; i<7; i++)\n{vec4 texel=texture2D(textureSampler,start+texelOffset);baseColor.a+=texel.a*weights[i];float luminance=getLuminance(baseColor.rgb);float luminanceTexel=getLuminance(texel.rgb);float choice=step(luminanceTexel,luminance);baseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;texelOffset+=texelStep;}\ngl_FragColor=baseColor;}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},57811:(e,t,i)=>{i.r(t),i.d(t,{vrDistortionCorrectionPixelShaderWGSL:()=>n});const r="vrDistortionCorrectionPixelShader",s="#define DISABLE_UNIFORMITY_ANALYSIS\nvarying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform LensCenter: vec2f;uniform Scale: vec2f;uniform ScaleIn: vec2f;uniform HmdWarpParam: vec4f;fn HmdWarp(in01: vec2f)->vec2f {var theta: vec2f=(in01-uniforms.LensCenter)*uniforms.ScaleIn; \nvar rSq: f32=theta.x*theta.x+theta.y*theta.y;var rvector: vec2f=theta*(uniforms.HmdWarpParam.x+uniforms.HmdWarpParam.y*rSq+uniforms.HmdWarpParam.z*rSq*rSq+uniforms.HmdWarpParam.w*rSq*rSq*rSq);return uniforms.LensCenter+uniforms.Scale*rvector;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var tc: vec2f=HmdWarp(input.vUV);if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0) {fragmentOutputs.color=vec4f(0.0,0.0,0.0,0.0);}\nelse{fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,tc);}}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},57912:(e,t,i)=>{i.r(t),i.d(t,{filterPixelShaderWGSL:()=>n});const r="filterPixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform kernelMatrix: mat4x4f;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var baseColor: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var updatedColor: vec3f=(uniforms.kernelMatrix* vec4f(baseColor,1.0)).rgb;fragmentOutputs.color= vec4f(updatedColor,1.0);}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},58057:(e,t,i)=>{i.r(t),i.d(t,{backgroundPixelShader:()=>c});var r=i(69610);const s="backgroundFragmentDeclaration",n="uniform vec4 vEyePosition;uniform vec4 vPrimaryColor;\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nuniform vec4 vPrimaryColorShadow;\n#endif\nuniform float shadowLevel;uniform float alpha;\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;\n#endif\n#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)\nuniform vec3 vBackgroundCenter;\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 vReflectionControl;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif\n#ifdef PROJECTED_GROUND\nuniform vec2 projectedGroundInfos;\n#endif\n";r.l.IncludesShadersStore[s]=n;i(86722),i(73325),i(18223),i(89392),i(92270),i(22448),i(21962),i(66812),i(64017),i(34581),i(6194),i(7806);const o="intersectionFunctions",a="float diskIntersectWithBackFaceCulling(vec3 ro,vec3 rd,vec3 c,float r) {float d=rd.y;if(d>0.0) { return 1e6; }\nvec3 o=ro-c;float t=-o.y/d;vec3 q=o+rd*t;return (dot(q,q)<r*r) ? t : 1e6;}\nvec2 sphereIntersect(vec3 ro,vec3 rd,vec3 ce,float ra) {vec3 oc=ro-ce;float b=dot(oc,rd);float c=dot(oc,oc)-ra*ra;float h=b*b-c;if(h<0.0) { return vec2(-1.0,-1.0); }\nh=sqrt(h);return vec2(-b+h,-b-h);}\nvec2 sphereIntersectFromOrigin(vec3 ro,vec3 rd,float ra) {float b=dot(ro,rd);float c=dot(ro,ro)-ra*ra;float h=b*b-c;if(h<0.0) { return vec2(-1.0,-1.0); }\nh=sqrt(h);return vec2(-b+h,-b-h);}";r.l.IncludesShadersStore[o]=a;i(7412),i(37256),i(29741),i(2360);const l="backgroundPixelShader",h="#ifdef TEXTURELODSUPPORT\n#extension GL_EXT_shader_texture_lod : enable\n#endif\nprecision highp float;\n#include<__decl__backgroundFragment>\n#include<helperFunctions>\nvarying vec3 vPositionW;\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif \n#ifdef MAINUV2 \nvarying vec2 vMainUV2; \n#endif \n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef DIFFUSE\n#if DIFFUSEDIRECTUV==1\n#define vDiffuseUV vMainUV1\n#elif DIFFUSEDIRECTUV==2\n#define vDiffuseUV vMainUV2\n#else\nvarying vec2 vDiffuseUV;\n#endif\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE;\n#endif\n#ifndef SHADOWONLY\n#define SHADOWONLY;\n#endif\n#include<imageProcessingDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<imageProcessingFunctions>\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<logDepthDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<fogFragmentDeclaration>\n#ifdef REFLECTIONFRESNEL\n#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\nvec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}\n#endif\n#ifdef PROJECTED_GROUND\n#include<intersectionFunctions>\nvec3 project(vec3 viewDirectionW,vec3 eyePosition) {float radius=projectedGroundInfos.x;float height=projectedGroundInfos.y;vec3 camDir=-viewDirectionW;float skySphereDistance=sphereIntersectFromOrigin(eyePosition,camDir,radius).x;vec3 skySpherePositionW=eyePosition+camDir*skySphereDistance;vec3 p=normalize(skySpherePositionW);eyePosition.y-=height;float sIntersection=sphereIntersectFromOrigin(eyePosition,p,radius).x;vec3 h=vec3(0.0,-height,0.0);float dIntersection=diskIntersectWithBackFaceCulling(eyePosition,p,h,radius);p=(eyePosition+min(sIntersection,dIntersection)*p);return p;}\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=vec3(0.0,1.0,0.0);\n#endif\nfloat shadow=1.;float globalShadow=0.;float shadowLightCount=0.;float aggShadow=0.;float numLights=0.;\n#include<lightFragment>[0..maxSimultaneousLights]\n#ifdef SHADOWINUSE\nglobalShadow/=shadowLightCount;\n#else\nglobalShadow=1.0;\n#endif\n#ifndef BACKMAT_SHADOWONLY\nvec4 reflectionColor=vec4(1.,1.,1.,1.);\n#ifdef REFLECTION\n#ifdef PROJECTED_GROUND\nvec3 reflectionVector=project(viewDirectionW,vEyePosition.xyz);reflectionVector=vec3(reflectionMatrix*vec4(reflectionVector,1.));\n#else\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=reflectionVector;\n#else\nvec2 reflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n#ifdef REFLECTIONBLUR\nfloat reflectionLOD=vReflectionInfos.y;\n#ifdef TEXTURELODSUPPORT\nreflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;reflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);\n#else\nfloat lodReflectionNormalized=saturate(reflectionLOD);float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords),\nreflectionSpecularMid,\nlodReflectionNormalizedDoubled\n);} else {reflectionColor=mix(\nreflectionSpecularMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);}\n#endif\n#else\nvec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);reflectionColor=reflectionSample;\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor.rgb=fromRGBD(reflectionColor);\n#endif\n#ifdef GAMMAREFLECTION\nreflectionColor.rgb=toLinearSpace(reflectionColor.rgb);\n#endif\n#ifdef REFLECTIONBGR\nreflectionColor.rgb=reflectionColor.bgr;\n#endif\nreflectionColor.rgb*=vReflectionInfos.x;\n#endif\nvec3 diffuseColor=vec3(1.,1.,1.);float finalAlpha=alpha;\n#ifdef DIFFUSE\nvec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);\n#ifdef GAMMADIFFUSE\ndiffuseMap.rgb=toLinearSpace(diffuseMap.rgb);\n#endif\ndiffuseMap.rgb*=vDiffuseInfos.y;\n#ifdef DIFFUSEHASALPHA\nfinalAlpha*=diffuseMap.a;\n#endif\ndiffuseColor=diffuseMap.rgb;\n#endif\n#ifdef REFLECTIONFRESNEL\nvec3 colorBase=diffuseColor;\n#else\nvec3 colorBase=reflectionColor.rgb*diffuseColor;\n#endif\ncolorBase=max(colorBase,0.0);\n#ifdef USERGBCOLOR\nvec3 finalColor=colorBase;\n#else\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nvec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);\n#else\nvec3 mainColor=vPrimaryColor.rgb;\n#endif\nvec3 finalColor=colorBase*mainColor;\n#endif\n#ifdef REFLECTIONFRESNEL\nvec3 reflectionAmount=vReflectionControl.xxx;vec3 reflectionReflectance0=vReflectionControl.yyy;vec3 reflectionReflectance90=vReflectionControl.zzz;float VdotN=dot(normalize(vEyePosition.xyz),normalW);vec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;\n#ifdef REFLECTIONFALLOFF\nfloat reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;\n#endif\nfinalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));\n#endif\n#ifdef OPACITYFRESNEL\nfloat viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));const float startAngle=0.1;float fadeFactor=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;\n#endif\n#ifdef SHADOWINUSE\nfinalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);\n#endif\nvec4 color=vec4(finalColor,finalAlpha);\n#else\nvec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);\n#endif\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\n#if !defined(SKIPFINALCOLORCLAMP)\ncolor.rgb=clamp(color.rgb,0.,30.0);\n#endif\n#else\ncolor=applyImageProcessing(color);\n#endif\n#ifdef PREMULTIPLYALPHA\ncolor.rgb*=color.a;\n#endif\n#ifdef NOISE\ncolor.rgb+=dither(vPositionW.xy,0.5);color=max(color,0.0);\n#endif\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";r.l.ShadersStore[l]=h;const c={name:l,shader:h}},59185:(e,t,i)=>{i.d(t,{v:()=>o});var r=i(998);let s=0,n=null;class o{static get Default(){return o._Default||(o._Default=new o),o._Default}constructor(){const e=o.Configuration.decoder;this._decoderModulePromise=r.S0.LoadBabylonScriptAsync(e.url).then((()=>MeshoptDecoder.ready))}dispose(){delete this._decoderModulePromise}decodeGltfBufferAsync(e,t,i,r,o){return this._decoderModulePromise.then((async()=>{0===s&&(MeshoptDecoder.useWorkers(1),s=1);const a=await MeshoptDecoder.decodeGltfBufferAsync(t,i,e,r,o);return null!==n&&clearTimeout(n),n=setTimeout((()=>{MeshoptDecoder.useWorkers(0),s=0,n=null}),1e3),a}))}}o.Configuration={decoder:{url:`${r.S0._DefaultCdnUrl}/meshopt_decoder.js`}},o._Default=null},59235:(e,t,i)=>{i.r(t),i.d(t,{defaultVertexShaderWGSL:()=>l});var r=i(69610);i(71698),i(1008),i(79702),i(32806),i(98900),i(44559),i(37769),i(41861),i(89277),i(97777),i(77029),i(75757);const s="lightVxFragmentDeclaration",n="#ifdef LIGHT{X}\nuniform vLightData{X}: vec4f;uniform vLightDiffuse{X}: vec4f;\n#ifdef SPECULARTERM\nuniform vLightSpecular{X}: vec4f;\n#else\nvar vLightSpecular{X}: vec4f= vec4f(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform lightMatrix{X}: mat4x4f[SHADOWCSMNUM_CASCADES{X}];varying var vPositionFromLight{X}: vec4f[SHADOWCSMNUM_CASCADES{X}];varying var vDepthMetric{X}: f32[SHADOWCSMNUM_CASCADES{X}];varying var vPositionFromCamera{X}: vec4f;\n#elif defined(SHADOWCUBE{X})\n#else\nvarying var vPositionFromLight{X}: vec4f;varying var vDepthMetric{X}: f32;uniform lightMatrix{X}: mat4x4f;\n#endif\nuniform shadowsInfo{X}: vec4f;uniform depthValues{X}: vec2f;\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vLightDirection{X}: vec4f;uniform vLightFalloff{X}: vec4f;\n#elif defined(POINTLIGHT{X})\nuniform vLightFalloff{X}: vec4f;\n#elif defined(HEMILIGHT{X})\nuniform vLightGround{X}: vec3f;\n#endif\n#if defined(AREALIGHT{X})\nuniform vLightWidth{X}: vec4f;uniform vLightHeight{X}: vec4f;\n#endif\n#endif\n";r.l.IncludesShadersStoreWGSL[s]=n;i(3925),i(76340),i(8217),i(93226),i(18258),i(9129),i(91277),i(65470),i(40242),i(47033),i(20774),i(52231),i(87921),i(85197),i(59013),i(79456),i(820),i(81482);const o="defaultVertexShader",a="#include<defaultUboDeclaration>\n#define CUSTOM_VERTEX_BEGIN\nattribute position: vec3f;\n#ifdef NORMAL\nattribute normal: vec3f;\n#endif\n#ifdef TANGENT\nattribute tangent: vec4f;\n#endif\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#ifdef VERTEXCOLOR\nattribute color: vec4f;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<mainUVVaryingDeclaration>[1..7]\n#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#if defined(SPECULARTERM)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)\n#endif\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\nvarying vPositionW: vec3f;\n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vColor: vec4f;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar positionUpdated: vec3f=vertexInputs.position;\n#ifdef NORMAL\nvar normalUpdated: vec3f=vertexInputs.normal;\n#endif\n#ifdef TANGENT\nvar tangentUpdated: vec4f=vertexInputs.tangent;\n#endif\n#ifdef UV1\nvar uvUpdated: vec2f=vertexInputs.uv;\n#endif\n#ifdef UV2\nvar uv2Updated: vec2f=vertexInputs.uv2;\n#endif\n#ifdef VERTEXCOLOR\nvar colorUpdated: vec4f=vertexInputs.color;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvertexOutputs.vPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*vec4f(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld*vec4f(positionUpdated,1.0);\n#ifdef NORMAL\nvar normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvertexOutputs.vNormalW=normalUpdated/ vec3f(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vertexOutputs.vNormalW=normalize(normalWorld*vertexOutputs.vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*worldPos;} else {vertexOutputs.position=scene.viewProjectionR*worldPos;}\n#else\nvertexOutputs.position=scene.viewProjection*worldPos;\n#endif\nvertexOutputs.vPositionW= worldPos.xyz;\n#ifdef PREPASS\n#include<prePassVertex>\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvertexOutputs.vDirectionW=normalize((finalWorld* vec4f(positionUpdated,0.0)).xyz);\n#endif\n#ifndef UV1\nvar uvUpdated: vec2f=vec2f(0.,0.);\n#endif\n#ifdef MAINUV1\nvertexOutputs.vMainUV1=uvUpdated;\n#endif\n#ifndef UV2\nvar uv2Updated: vec2f=vec2f(0.,0.);\n#endif\n#ifdef MAINUV2\nvertexOutputs.vMainUV2=uv2Updated;\n#endif\n#include<uvVariableDeclaration>[3..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#if defined(SPECULARTERM)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)\n#endif\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";r.l.ShadersStoreWGSL[o]=a;const l={name:o,shader:a}},59382:(e,t,i)=>{i.r(t),i.d(t,{lensFlareVertexShaderWGSL:()=>n});const r="lensFlareVertexShader",s="attribute position: vec2f;uniform viewportMatrix: mat4x4f;varying vUV: vec2f;const madd: vec2f= vec2f(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.vUV=input.position*madd+madd;vertexOutputs.position=uniforms.viewportMatrix* vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},59384:(e,t,i)=>{i.r(t),i.d(t,{particlesVertexShader:()=>o});var r=i(69610);i(71636),i(86560),i(34581),i(47314),i(16470),i(2215);const s="particlesVertexShader",n="attribute vec3 position;attribute vec4 color;attribute float angle;attribute vec2 size;\n#ifdef ANIMATESHEET\nattribute float cellIndex;\n#endif\n#ifndef BILLBOARD\nattribute vec3 direction;\n#endif\n#ifdef BILLBOARDSTRETCHED\nattribute vec3 direction;\n#endif\n#ifdef RAMPGRADIENT\nattribute vec4 remapData;\n#endif\nattribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 translationPivot;\n#ifdef ANIMATESHEET\nuniform vec3 particlesInfos; \n#endif\nvarying vec2 vUV;varying vec4 vColor;varying vec3 vPositionW;\n#ifdef RAMPGRADIENT\nvarying vec4 remapRanges;\n#endif\n#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)\nuniform mat4 invView;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<logDepthDeclaration>\n#ifdef BILLBOARD\nuniform vec3 eyePosition;\n#endif\nvec3 rotate(vec3 yaxis,vec3 rotatedCorner) {vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));vec3 zaxis=normalize(cross(yaxis,xaxis));vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;return position+alignedCorner;}\n#ifdef BILLBOARDSTRETCHED\nvec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {vec3 normalizedToCamera=normalize(toCamera);vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);\n#ifdef BILLBOARDSTRETCHED_LOCAL\nvec3 row1=direction;\n#else\nvec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);\n#endif\nmat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;return position+alignedCorner;}\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec2 cornerPos;cornerPos=(vec2(offset.x-0.5,offset.y -0.5)-translationPivot)*size;\n#ifdef BILLBOARD\nvec3 rotatedCorner;\n#ifdef BILLBOARDY\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=position-eyePosition;yaxis.y=0.;vPositionW=rotate(normalize(yaxis),rotatedCorner);vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;\n#elif defined(BILLBOARDSTRETCHED)\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 toCamera=position-eyePosition;vPositionW=rotateAlign(toCamera,rotatedCorner);vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;\n#else\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 viewPos=(view*vec4(position,1.0)).xyz+rotatedCorner;vPositionW=(invView*vec4(viewPos,1)).xyz;\n#endif\n#ifdef RAMPGRADIENT\nremapRanges=remapData;\n#endif\ngl_Position=projection*vec4(viewPos,1.0);\n#else\nvec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=normalize(direction);vPositionW=rotate(yaxis,rotatedCorner);gl_Position=projection*view*vec4(vPositionW,1.0);\n#endif\nvColor=color;\n#ifdef ANIMATESHEET\nfloat rowOffset=floor(cellIndex*particlesInfos.z);float columnOffset=cellIndex-rowOffset/particlesInfos.z;vec2 uvScale=particlesInfos.xy;vec2 uvOffset=vec2(offset.x ,1.0-offset.y);vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;\n#else\nvUV=offset;\n#endif\n#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6) || defined(FOG)\nvec4 worldPos=vec4(vPositionW,1.0);\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},59693:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphConsoleLogBlock:()=>a});var r=i(33006),s=i(4720),n=i(56552),o=i(51137);class a extends r.w{constructor(e){super(e),this.message=this.registerDataInput("message",s.Vv),this.logType=this.registerDataInput("logType",s.Vv,"log")}_execute(e){const t=this.logType.getValue(e),i=this.message.getValue(e);"warn"===t?o.V.Warn(i):"error"===t?o.V.Error(i):o.V.Log(i),this.out._activateSignal(e)}getClassName(){return"FlowGraphConsoleLogBlock"}}(0,n.Y5)("FlowGraphConsoleLogBlock",a)},59816:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphCombineMatrix2DBlock:()=>f,FlowGraphCombineMatrix3DBlock:()=>_,FlowGraphCombineMatrixBlock:()=>m,FlowGraphCombineVector2Block:()=>u,FlowGraphCombineVector3Block:()=>d,FlowGraphCombineVector4Block:()=>p,FlowGraphExtractMatrix2DBlock:()=>b,FlowGraphExtractMatrix3DBlock:()=>y,FlowGraphExtractMatrixBlock:()=>S,FlowGraphExtractVector2Block:()=>g,FlowGraphExtractVector3Block:()=>x,FlowGraphExtractVector4Block:()=>v});var r=i(94423),s=i(4720),n=i(71294),o=i(79923),a=i(56552),l=i(57565);class h extends r.r{constructor(e,t,i){super(t,i);for(let t=0;t<e;t++)this.registerDataInput(`input_${t}`,s.Es,0)}}class c extends n.e{constructor(e,t,i){super(i),this.registerDataInput("input",t);for(let t=0;t<e;t++)this.registerDataOutput(`output_${t}`,s.Es,0)}}class u extends h{constructor(e){super(2,s.K$,e)}_doOperation(e){e._hasExecutionVariable(this,"cachedVector")||e._setExecutionVariable(this,"cachedVector",new o.I9);const t=e._getExecutionVariable(this,"cachedVector",null);return t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e)),t}getClassName(){return"FlowGraphCombineVector2Block"}}(0,a.Y5)("FlowGraphCombineVector2Block",u);class d extends h{constructor(e){super(3,s.Dx,e)}_doOperation(e){e._hasExecutionVariable(this,"cachedVector")||e._setExecutionVariable(this,"cachedVector",new o.Pq);const t=e._getExecutionVariable(this,"cachedVector",null);return t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e)),t}getClassName(){return"FlowGraphCombineVector3Block"}}(0,a.Y5)("FlowGraphCombineVector3Block",d);class p extends h{constructor(e){super(4,s.Ko,e)}_doOperation(e){e._hasExecutionVariable(this,"cachedVector")||e._setExecutionVariable(this,"cachedVector",new o.IU);const t=e._getExecutionVariable(this,"cachedVector",null);return t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_3").getValue(e)),t}getClassName(){return"FlowGraphCombineVector4Block"}}(0,a.Y5)("FlowGraphCombineVector4Block",p);class m extends h{constructor(e){super(16,s.Sp,e)}_doOperation(e){e._hasExecutionVariable(this,"cachedMatrix")||e._setExecutionVariable(this,"cachedMatrix",new o.uq);const t=e._getExecutionVariable(this,"cachedMatrix",null);return this.config?.inputIsColumnMajor?t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_4").getValue(e),this.getDataInput("input_8").getValue(e),this.getDataInput("input_12").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_5").getValue(e),this.getDataInput("input_9").getValue(e),this.getDataInput("input_13").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_6").getValue(e),this.getDataInput("input_10").getValue(e),this.getDataInput("input_14").getValue(e),this.getDataInput("input_3").getValue(e),this.getDataInput("input_7").getValue(e),this.getDataInput("input_11").getValue(e),this.getDataInput("input_15").getValue(e)):t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_3").getValue(e),this.getDataInput("input_4").getValue(e),this.getDataInput("input_5").getValue(e),this.getDataInput("input_6").getValue(e),this.getDataInput("input_7").getValue(e),this.getDataInput("input_8").getValue(e),this.getDataInput("input_9").getValue(e),this.getDataInput("input_10").getValue(e),this.getDataInput("input_11").getValue(e),this.getDataInput("input_12").getValue(e),this.getDataInput("input_13").getValue(e),this.getDataInput("input_14").getValue(e),this.getDataInput("input_15").getValue(e)),t}getClassName(){return"FlowGraphCombineMatrixBlock"}}(0,a.Y5)("FlowGraphCombineMatrixBlock",m);class f extends h{constructor(e){super(4,s.cZ,e)}_doOperation(e){e._hasExecutionVariable(this,"cachedMatrix")||e._setExecutionVariable(this,"cachedMatrix",new l.K);const t=e._getExecutionVariable(this,"cachedMatrix",null),i=this.config?.inputIsColumnMajor?[this.getDataInput("input_0").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_3").getValue(e)]:[this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_3").getValue(e)];return t.fromArray(i),t}getClassName(){return"FlowGraphCombineMatrix2DBlock"}}(0,a.Y5)("FlowGraphCombineMatrix2DBlock",f);class _ extends h{constructor(e){super(9,s.F4,e)}_doOperation(e){e._hasExecutionVariable(this,"cachedMatrix")||e._setExecutionVariable(this,"cachedMatrix",new l.z);const t=e._getExecutionVariable(this,"cachedMatrix",null),i=this.config?.inputIsColumnMajor?[this.getDataInput("input_0").getValue(e),this.getDataInput("input_3").getValue(e),this.getDataInput("input_6").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_4").getValue(e),this.getDataInput("input_7").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_5").getValue(e),this.getDataInput("input_8").getValue(e)]:[this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_3").getValue(e),this.getDataInput("input_4").getValue(e),this.getDataInput("input_5").getValue(e),this.getDataInput("input_6").getValue(e),this.getDataInput("input_7").getValue(e),this.getDataInput("input_8").getValue(e)];return t.fromArray(i),t}getClassName(){return"FlowGraphCombineMatrix3DBlock"}}(0,a.Y5)("FlowGraphCombineMatrix3DBlock",_);class g extends c{constructor(e){super(2,s.K$,e)}_updateOutputs(e){let t=this.getDataInput("input")?.getValue(e);t||(t=o.I9.Zero(),this.getDataInput("input").setValue(t,e)),this.getDataOutput("output_0").setValue(t.x,e),this.getDataOutput("output_1").setValue(t.y,e)}getClassName(){return"FlowGraphExtractVector2Block"}}(0,a.Y5)("FlowGraphExtractVector2Block",g);class x extends c{constructor(e){super(3,s.Dx,e)}_updateOutputs(e){let t=this.getDataInput("input")?.getValue(e);t||(t=o.Pq.Zero(),this.getDataInput("input").setValue(t,e)),this.getDataOutput("output_0").setValue(t.x,e),this.getDataOutput("output_1").setValue(t.y,e),this.getDataOutput("output_2").setValue(t.z,e)}getClassName(){return"FlowGraphExtractVector3Block"}}(0,a.Y5)("FlowGraphExtractVector3Block",x);class v extends c{constructor(e){super(4,s.Ko,e)}_updateOutputs(e){let t=this.getDataInput("input")?.getValue(e);t||(t=o.IU.Zero(),this.getDataInput("input").setValue(t,e)),this.getDataOutput("output_0").setValue(t.x,e),this.getDataOutput("output_1").setValue(t.y,e),this.getDataOutput("output_2").setValue(t.z,e),this.getDataOutput("output_3").setValue(t.w,e)}getClassName(){return"FlowGraphExtractVector4Block"}}(0,a.Y5)("FlowGraphExtractVector4Block",v);class S extends c{constructor(e){super(16,s.Sp,e)}_updateOutputs(e){let t=this.getDataInput("input")?.getValue(e);t||(t=o.uq.Identity(),this.getDataInput("input").setValue(t,e));for(let i=0;i<16;i++)this.getDataOutput(`output_${i}`).setValue(t.m[i],e)}getClassName(){return"FlowGraphExtractMatrixBlock"}}(0,a.Y5)("FlowGraphExtractMatrixBlock",S);class b extends c{constructor(e){super(4,s.cZ,e)}_updateOutputs(e){let t=this.getDataInput("input")?.getValue(e);t||(t=new l.K,this.getDataInput("input").setValue(t,e));for(let i=0;i<4;i++)this.getDataOutput(`output_${i}`).setValue(t.m[i],e)}getClassName(){return"FlowGraphExtractMatrix2DBlock"}}(0,a.Y5)("FlowGraphExtractMatrix2DBlock",b);class y extends c{constructor(e){super(9,s.F4,e)}_updateOutputs(e){let t=this.getDataInput("input")?.getValue(e);t||(t=new l.z,this.getDataInput("input").setValue(t,e));for(let i=0;i<9;i++)this.getDataOutput(`output_${i}`).setValue(t.m[i],e)}getClassName(){return"FlowGraphExtractMatrix3DBlock"}}(0,a.Y5)("FlowGraphExtractMatrix3DBlock",y)},61089:(e,t,i)=>{i.r(t),i.d(t,{iblShadowAccumulationPixelShader:()=>n});const r="iblShadowAccumulationPixelShader",s="#ifdef GL_ES\nprecision mediump float;\n#endif\nvarying vec2 vUV;uniform vec4 accumulationParameters;\n#define remanence accumulationParameters.x\n#define resetb accumulationParameters.y\n#define sceneSize accumulationParameters.z\nuniform sampler2D motionSampler;uniform sampler2D positionSampler;uniform sampler2D spatialBlurSampler;uniform sampler2D oldAccumulationSampler;uniform sampler2D prevPositionSampler;vec2 max2(vec2 v,vec2 w) { return vec2(max(v.x,w.x),max(v.y,w.y)); }\nvoid main(void) {bool reset=bool(resetb);vec2 gbufferRes=vec2(textureSize(motionSampler,0));ivec2 gbufferPixelCoord=ivec2(vUV*gbufferRes);vec2 shadowRes=vec2(textureSize(spatialBlurSampler,0));ivec2 shadowPixelCoord=ivec2(vUV*shadowRes);vec4 LP=texelFetch(positionSampler,gbufferPixelCoord,0);if (0.0==LP.w) {gl_FragColor=vec4(1.0,0.0,0.0,1.0);return;}\nvec2 velocityColor=texelFetch(motionSampler,gbufferPixelCoord,0).xy;vec2 prevCoord=vUV+velocityColor;vec3 PrevLP=texture(prevPositionSampler,prevCoord).xyz;vec4 PrevShadows=texture(oldAccumulationSampler,prevCoord);vec3 newShadows=texelFetch(spatialBlurSampler,shadowPixelCoord,0).xyz;PrevShadows.a =\n!reset && all(lessThan(abs(prevCoord-vec2(0.5)),vec2(0.5))) &&\ndistance(LP.xyz,PrevLP)<5e-2*sceneSize\n? max(PrevShadows.a/(1.0+PrevShadows.a),1.0-remanence)\n: 1.0;PrevShadows=max(vec4(0.0),PrevShadows);gl_FragColor =\nvec4(mix(PrevShadows.x,newShadows.x,PrevShadows.a),\nmix(PrevShadows.y,newShadows.y,PrevShadows.a),\nmix(PrevShadows.z,newShadows.z,PrevShadows.a),PrevShadows.a);}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},61094:(e,t,i)=>{i.d(t,{p:()=>o});var r=i(26877),s=i(55234),n=i(34294);class o extends n.CubeTexture{constructor(e,t,i,r=5,s=0,n=!1,o=!1,a=3,l=null){super("",e),this._texture=e.getEngine().createRawCubeTexture(t,i,r,s,n,o,a,l)}update(e,t,i,r,s=null){this._texture.getEngine().updateRawCubeTexture(this._texture,e,t,i,r,s)}updateRGBDAsync(e,t=null,i=.8,r=0){return(0,s.gW)(this._texture,e,t,i,r).then((()=>{}))}clone(){return r.p.Clone((()=>{const e=this.getScene(),t=this._texture,i=new o(e,t._bufferViewArray,t.width,t.format,t.type,t.generateMipMaps,t.invertY,t.samplingMode,t._compression);return 13===t.source&&i.updateRGBDAsync(t._bufferViewArrayArray,t._sphericalPolynomial,t._lodGenerationScale,t._lodGenerationOffset),i}),this)}}},61245:(e,t,i)=>{i.r(t),i.d(t,{iblCdfyPixelShaderWGSL:()=>n});const r="iblCdfyPixelShader",s="varying vUV : vec2f;\n#include <helperFunctions>\n#ifdef IBL_USE_CUBE_MAP\nvar iblSourceSampler: sampler;var iblSource: texture_cube<f32>;\n#else\nvar iblSourceSampler: sampler;var iblSource: texture_2d<f32>;\n#endif\nuniform iblHeight: i32;\n#ifdef IBL_USE_CUBE_MAP\nfn fetchCube(uv: vec2f)->f32 {var direction: vec3f=equirectangularToCubemapDirection(uv);return sin(PI*uv.y) *\ndot(textureSampleLevel(iblSource,iblSourceSampler,direction,0.0)\n.rgb,\nLuminanceEncodeApprox);}\n#else\nfn fetchPanoramic(Coords: vec2i,envmapHeight: f32)->f32 {return sin(PI*(f32(Coords.y)+0.5)/envmapHeight) *\ndot(textureLoad(iblSource,Coords,0).rgb,LuminanceEncodeApprox);}\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var coords: vec2i= vec2i(fragmentInputs.position.xy);var cdfy: f32=0.0;for (var y: i32=1; y<=coords.y; y++) {\n#ifdef IBL_USE_CUBE_MAP\nvar uv: vec2f= vec2f(input.vUV.x,( f32(y-1)+0.5)/ f32(uniforms.iblHeight));cdfy+=fetchCube(uv);\n#else\ncdfy+=fetchPanoramic( vec2i(coords.x,y-1), f32(uniforms.iblHeight));\n#endif\n}\nfragmentOutputs.color= vec4f(cdfy,0.0,0.0,1.0);}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},62099:(e,t,i)=>{i.r(t),i.d(t,{iblScaledLuminancePixelShaderWGSL:()=>o});var r=i(69610);i(79702);const s="iblScaledLuminancePixelShader",n="#include<helperFunctions>\n#ifdef IBL_USE_CUBE_MAP\nvar iblSourceSampler: sampler;var iblSource: texture_cube<f32>;\n#else\nvar iblSourceSampler: sampler;var iblSource: texture_2d<f32>;\n#endif\nuniform iblHeight: i32;uniform iblWidth: i32;fn fetchLuminance(coords: vec2f)->f32 {\n#ifdef IBL_USE_CUBE_MAP\nvar direction: vec3f=equirectangularToCubemapDirection(coords);var color: vec3f=textureSampleLevel(iblSource,iblSourceSampler,direction,0.0).rgb;\n#else\nvar color: vec3f=textureSampleLevel(iblSource,iblSourceSampler,coords,0.0).rgb;\n#endif\nreturn dot(color,LuminanceEncodeApprox);}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var deform: f32=sin(input.vUV.y*PI);var luminance: f32=fetchLuminance(input.vUV);fragmentOutputs.color=vec4f(vec3f(deform*luminance),1.0);}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},62661:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphSendCustomEventBlock:()=>n});var r=i(33006),s=i(56552);class n extends r.w{constructor(e){super(e),this.config=e;for(const e in this.config.eventData)this.registerDataInput(e,this.config.eventData[e].type,this.config.eventData[e].value)}_execute(e){const t=this.config.eventId,i={};this.dataInputs.forEach((t=>{i[t.name]=t.getValue(e)})),e.configuration.coordinator.notifyCustomEvent(t,i),this.out._activateSignal(e)}getClassName(){return"FlowGraphReceiveCustomEventBlock"}}(0,s.Y5)("FlowGraphReceiveCustomEventBlock",n)},62703:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphDeterminantBlock:()=>c,FlowGraphInvertMatrixBlock:()=>u,FlowGraphMatrixComposeBlock:()=>m,FlowGraphMatrixDecomposeBlock:()=>p,FlowGraphMatrixMultiplicationBlock:()=>d,FlowGraphTransposeBlock:()=>h});var r=i(71294),s=i(4720),n=i(79923),o=i(56552),a=i(63318),l=i(77467);class h extends a.a{constructor(e){super((0,s.Yd)(e?.matrixType||"Matrix"),(0,s.Yd)(e?.matrixType||"Matrix"),(e=>e.transpose?e.transpose():n.uq.Transpose(e)),"FlowGraphTransposeBlock",e)}}(0,o.Y5)("FlowGraphTransposeBlock",h);class c extends a.a{constructor(e){super((0,s.Yd)(e?.matrixType||"Matrix"),s.Es,(e=>e.determinant()),"FlowGraphDeterminantBlock",e)}}(0,o.Y5)("FlowGraphDeterminantBlock",c);class u extends a.a{constructor(e){super((0,s.Yd)(e?.matrixType||"Matrix"),(0,s.Yd)(e?.matrixType||"Matrix"),(e=>e.inverse?e.inverse():n.uq.Invert(e)),"FlowGraphInvertMatrixBlock",e)}}(0,o.Y5)("FlowGraphInvertMatrixBlock",u);class d extends l.W{constructor(e){super((0,s.Yd)(e?.matrixType||"Matrix"),(0,s.Yd)(e?.matrixType||"Matrix"),(0,s.Yd)(e?.matrixType||"Matrix"),((e,t)=>t.multiply(e)),"FlowGraphMatrixMultiplicationBlock",e)}}(0,o.Y5)("FlowGraphMatrixMultiplicationBlock",d);class p extends r.e{constructor(e){super(e),this.input=this.registerDataInput("input",s.Sp),this.position=this.registerDataOutput("position",s.Dx),this.rotationQuaternion=this.registerDataOutput("rotationQuaternion",s.P_),this.scaling=this.registerDataOutput("scaling",s.Dx),this.isValid=this.registerDataOutput("isValid",s.RI,!1)}_updateOutputs(e){const t=e._getExecutionVariable(this,"executionId",-1),i=e._getExecutionVariable(this,"cachedPosition",null),r=e._getExecutionVariable(this,"cachedRotation",null),s=e._getExecutionVariable(this,"cachedScaling",null);if(t===e.executionId&&i&&r&&s)this.position.setValue(i,e),this.rotationQuaternion.setValue(r,e),this.scaling.setValue(s,e);else{const t=this.input.getValue(e),o=i||new n.Pq,a=r||new n.PT,l=s||new n.Pq,h=Math.round(1e4*t.m[3])/1e4,c=Math.round(1e4*t.m[7])/1e4,u=Math.round(1e4*t.m[11])/1e4,d=Math.round(1e4*t.m[15])/1e4;if(0!==h||0!==c||0!==u||1!==d)return this.isValid.setValue(!1,e),this.position.setValue(n.Pq.Zero(),e),this.rotationQuaternion.setValue(n.PT.Identity(),e),void this.scaling.setValue(n.Pq.One(),e);const p=t.decompose(l,a,o);this.isValid.setValue(p,e),this.position.setValue(o,e),this.rotationQuaternion.setValue(a,e),this.scaling.setValue(l,e),e._setExecutionVariable(this,"cachedPosition",o),e._setExecutionVariable(this,"cachedRotation",a),e._setExecutionVariable(this,"cachedScaling",l),e._setExecutionVariable(this,"executionId",e.executionId)}}getClassName(){return"FlowGraphMatrixDecompose"}}(0,o.Y5)("FlowGraphMatrixDecompose",p);class m extends r.e{constructor(e){super(e),this.position=this.registerDataInput("position",s.Dx),this.rotationQuaternion=this.registerDataInput("rotationQuaternion",s.P_),this.scaling=this.registerDataInput("scaling",s.Dx),this.value=this.registerDataOutput("value",s.Sp)}_updateOutputs(e){const t=e._getExecutionVariable(this,"executionId",-1),i=e._getExecutionVariable(this,"cachedMatrix",null);if(t===e.executionId&&i)this.value.setValue(i,e);else{const t=n.uq.Compose(this.scaling.getValue(e),this.rotationQuaternion.getValue(e),this.position.getValue(e));this.value.setValue(t,e),e._setExecutionVariable(this,"cachedMatrix",t),e._setExecutionVariable(this,"executionId",e.executionId)}}getClassName(){return"FlowGraphMatrixCompose"}}(0,o.Y5)("FlowGraphMatrixCompose",m)},62843:(e,t,i)=>{i.r(t),i.d(t,{spritesPixelShaderWGSL:()=>l});var r=i(69610);i(66407),i(93226),i(38780),i(93243);const s="imageProcessingCompatibility",n="#ifdef IMAGEPROCESSINGPOSTPROCESS\nfragmentOutputs.color=vec4f(pow(fragmentOutputs.color.rgb, vec3f(2.2)),fragmentOutputs.color.a);\n#endif\n";r.l.IncludesShadersStoreWGSL[s]=n;const o="spritesPixelShader",a="uniform alphaTest: i32;varying vColor: vec4f;varying vUV: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#include<fogFragmentDeclaration>\n#include<logDepthDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#ifdef PIXEL_PERFECT\nfn uvPixelPerfect(uv: vec2f)->vec2f {var res: vec2f= vec2f(textureDimensions(diffuseSampler,0));var uvTemp=uv*res;var seam: vec2f=floor(uvTemp+0.5);uvTemp=seam+clamp((uvTemp-seam)/fwidth(uvTemp),vec2f(-0.5),vec2f(0.5));return uvTemp/res;}\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#ifdef PIXEL_PERFECT\nvar uv: vec2f=uvPixelPerfect(input.vUV);\n#else\nvar uv: vec2f=input.vUV;\n#endif\nvar color: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,uv);var fAlphaTest: f32= f32(uniforms.alphaTest);if (fAlphaTest != 0.)\n{if (color.a<0.95) {discard;}}\ncolor*=input.vColor;\n#include<logDepthFragment>\n#include<fogFragment>\nfragmentOutputs.color=color;\n#include<imageProcessingCompatibility>\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStoreWGSL[o]=a;const l={name:o,shader:a}},63145:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphDebounceBlock:()=>o});var r=i(4720),s=i(33006),n=i(56552);class o extends s.w{constructor(e){super(e),this.count=this.registerDataInput("count",r.Es),this.reset=this._registerSignalInput("reset"),this.currentCount=this.registerDataOutput("currentCount",r.Es)}_execute(e,t){if(t===this.reset)return void e._setExecutionVariable(this,"debounceCount",0);const i=this.count.getValue(e),r=e._getExecutionVariable(this,"debounceCount",0)+1;this.currentCount.setValue(r,e),e._setExecutionVariable(this,"debounceCount",r),r>=i&&(this.out._activateSignal(e),e._setExecutionVariable(this,"debounceCount",0))}getClassName(){return"FlowGraphDebounceBlock"}}(0,n.Y5)("FlowGraphDebounceBlock",o)},63866:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleThicknessVertexShaderWGSL:()=>n});const r="fluidRenderingParticleThicknessVertexShader",s="attribute position: vec3f;attribute offset: vec2f;uniform view: mat4x4f;uniform projection: mat4x4f;uniform size: vec2f;varying uv: vec2f;@vertex\nfn main(input: VertexInputs)->FragmentInputs {var cornerPos: vec3f=vec3f(\nvec2f(input.offset.x-0.5,input.offset.y-0.5)*uniforms.size,\n0.0\n);var viewPos: vec3f=(uniforms.view*vec4f(input.position,1.0)).xyz+cornerPos;vertexOutputs.position=uniforms.projection*vec4f(viewPos,1.0);vertexOutputs.uv=input.offset;}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},64353:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphStopAnimationBlock:()=>a});var r=i(4720),s=i(56552),n=i(51137),o=i(51e3);class a extends o.M{constructor(e){super(e),this.animationGroup=this.registerDataInput("animationGroup",r.Vv),this.stopAtFrame=this.registerDataInput("stopAtFrame",r.Es,-1)}_preparePendingTasks(e){const t=this.animationGroup.getValue(e),i=this.stopAtFrame.getValue(e)??-1,r=e._getGlobalContextVariable("pendingStopAnimations",[]);r.push({uniqueId:t.uniqueId,stopAtFrame:i}),e._setGlobalContextVariable("pendingStopAnimations",r)}_cancelPendingTasks(e){const t=this.animationGroup.getValue(e),i=e._getGlobalContextVariable("pendingStopAnimations",[]);for(let r=0;r<i.length;r++)if(i[r].uniqueId===t.uniqueId){i.splice(r,1),e._setGlobalContextVariable("pendingStopAnimations",i);break}}_execute(e){const t=this.animationGroup.getValue(e),i=this.stopAtFrame.getValue(e)??-1;return t?isNaN(i)?this._reportError(e,"Invalid stop time."):(i>0?this._startPendingTasks(e):this._stopAnimation(t,e),void this.out._activateSignal(e)):(n.V.Warn("No animation group provided to stop."),this._reportError(e,"No animation group provided to stop."))}_executeOnTick(e){const t=this.animationGroup.getValue(e),i=e._getGlobalContextVariable("pendingStopAnimations",[]);for(let r=0;r<i.length;r++)if(i[r].uniqueId===t.uniqueId&&t.getCurrentFrame()>=i[r].stopAtFrame){this._stopAnimation(t,e),i.splice(r,1),e._setGlobalContextVariable("pendingStopAnimations",i),this.done._activateSignal(e),e._removePendingBlock(this);break}}getClassName(){return"FlowGraphStopAnimationBlock"}_stopAnimation(e,t){const i=t._getGlobalContextVariable("currentlyRunningAnimationGroups",[]),r=i.indexOf(e.uniqueId);-1!==r&&(e.stop(),i.splice(r,1),t._setGlobalContextVariable("currentlyRunningAnimationGroups",i))}}(0,s.Y5)("FlowGraphStopAnimationBlock",a)},64972:(e,t,i)=>{i.r(t),i.d(t,{hdrIrradianceFilteringPixelShaderWGSL:()=>o});var r=i(69610);i(79702),i(75136),i(75052),i(58866);const s="hdrIrradianceFilteringPixelShader",n="#include<helperFunctions>\n#include<importanceSampling>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\nvar inputTextureSampler: sampler;var inputTexture: texture_cube<f32>;\n#ifdef IBL_CDF_FILTERING\nvar icdfTextureSampler: sampler;var icdfTexture: texture_2d<f32>;\n#endif\nuniform vFilteringInfo: vec2f;uniform hdrScale: f32;varying direction: vec3f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=irradiance(inputTexture,inputTextureSampler,input.direction,uniforms.vFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfTexture,icdfTextureSampler\n#endif\n);fragmentOutputs.color= vec4f(color*uniforms.hdrScale,1.0);}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},65783:(e,t,i)=>{i.r(t),i.d(t,{blackAndWhitePixelShaderWGSL:()=>n});const r="blackAndWhitePixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform degree: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var luminance: f32=dot(color, vec3f(0.3,0.59,0.11)); \nvar blackAndWhite: vec3f= vec3f(luminance,luminance,luminance);fragmentOutputs.color= vec4f(color-((color-blackAndWhite)*uniforms.degree),1.0);}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},66154:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphFlipFlopBlock:()=>o});var r=i(16972),s=i(4720),n=i(56552);class o extends r.u{constructor(e){super(e),this.onOn=this._registerSignalOutput("onOn"),this.onOff=this._registerSignalOutput("onOff"),this.value=this.registerDataOutput("value",s.RI)}_execute(e,t){let i=e._getExecutionVariable(this,"value","boolean"==typeof this.config?.startValue&&!this.config.startValue);i=!i,e._setExecutionVariable(this,"value",i),this.value.setValue(i,e),i?this.onOn._activateSignal(e):this.onOff._activateSignal(e)}getClassName(){return"FlowGraphFlipFlopBlock"}}(0,n.Y5)("FlowGraphFlipFlopBlock",o)},66566:(e,t,i)=>{const r="boundingBoxRendererUboDeclaration",s="#ifdef WEBGL2\nuniform vec4 color;uniform mat4 world;uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\n#else\nlayout(std140,column_major) uniform;uniform BoundingBoxRenderer {vec4 color;mat4 world;mat4 viewProjection;mat4 viewProjectionR;};\n#endif\n";i(69610).l.IncludesShadersStore[r]=s},66584:(e,t,i)=>{i.r(t),i.d(t,{screenSpaceReflection2BlurPixelShaderWGSL:()=>n});const r="screenSpaceReflection2BlurPixelShader",s="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;varying vUV: vec2f;uniform texelOffsetScale: vec2f;const weights: array<f32,8>=array<f32,8>(0.071303,0.131514,0.189879,0.321392,0.452906, 0.584419,0.715932,0.847445);fn processSample(uv: vec2f,i: f32,stepSize: vec2f,accumulator: ptr<function,vec4f>,denominator: ptr<function,f32>)\n{var offsetUV: vec2f=stepSize*i+uv;var coefficient: f32=weights[ i32(2.0-abs(i))];*accumulator+=textureSampleLevel(textureSampler,textureSamplerSampler,offsetUV,0.0)*coefficient;*denominator+=coefficient;}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var colorFull: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);if (dot(colorFull, vec4f(1.0))==0.0) {fragmentOutputs.color=colorFull;return fragmentOutputs;}\nvar blurRadius: f32=colorFull.a*255.0; \nvar stepSize: vec2f=uniforms.texelOffsetScale.xy*blurRadius;var accumulator: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0)*0.214607;var denominator: f32=0.214607;processSample(input.vUV,1.0,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.2,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.4,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.6,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.8,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.2,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.4,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.6,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.8,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*2.0,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.2,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.4,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.6,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.8,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.2,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.4,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.6,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.8,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*2.0,stepSize,&accumulator,&denominator);fragmentOutputs.color= vec4f(accumulator.rgb/denominator,colorFull.a);}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},67297:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleDepthPixelShaderWGSL:()=>n});const r="fluidRenderingParticleDepthPixelShader",s="uniform projection: mat4x4f;varying uv: vec2f;varying viewPos: vec3f;varying sphereRadius: f32;\n#ifdef FLUIDRENDERING_VELOCITY\nvarying velocityNorm: f32;\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var normalxy: vec2f=input.uv*2.0-1.0;var r2: f32=dot(normalxy,normalxy);if (r2>1.0) {discard;}\nvar normal: vec3f=vec3f(normalxy,sqrt(1.0-r2));\n#ifndef FLUIDRENDERING_RHS\nnormal.z=-normal.z;\n#endif\nvar realViewPos: vec4f=vec4f(input.viewPos+normal*input.sphereRadius,1.0);var clipSpacePos: vec4f=uniforms.projection*realViewPos;fragmentOutputs.fragDepth=clipSpacePos.z/clipSpacePos.w;\n#ifdef FLUIDRENDERING_RHS\nrealViewPos.z=-realViewPos.z;\n#endif\n#ifdef FLUIDRENDERING_VELOCITY\nfragmentOutputs.color=vec4f(realViewPos.z,input.velocityNorm,0.,1.);\n#else\nfragmentOutputs.color=vec4f(realViewPos.z,0.,0.,1.);\n#endif\n}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},67524:(e,t,i)=>{i.d(t,{H:()=>c});var r=i(75524),s=i(79259),n=i(79923),o=i(4870),a=i(64704),l=i(83316),h=i(56552);o.b.AddNodeConstructor("Light_Type_0",((e,t)=>()=>new c(e,n.Pq.Zero(),t)));class c extends l.p{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){const t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){const e=this._shadowGenerators.values();for(let t=e.next();!0!==t.done;t=e.next()){t.value.recreateShadowMap()}}}constructor(e,t,i){super(e,i),this._shadowAngle=Math.PI/2,this.position=t}getClassName(){return"PointLight"}getTypeID(){return a.v.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new n.Pq(1,0,0);case 1:return new n.Pq(-1,0,0);case 2:return new n.Pq(0,-1,0);case 3:return new n.Pq(0,1,0);case 4:return new n.Pq(0,0,1);case 5:return new n.Pq(0,0,-1)}return n.Pq.Zero()}_setDefaultShadowProjectionMatrix(e,t,i){const r=this.getScene().activeCamera;if(!r)return;const s=void 0!==this.shadowMinZ?this.shadowMinZ:r.minZ,o=void 0!==this.shadowMaxZ?this.shadowMaxZ:r.maxZ,a=this.getScene().getEngine().useReverseDepthBuffer;n.uq.PerspectiveFovLHToRef(this.shadowAngle,1,a?o:s,a?s:o,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,a)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}}(0,r.Cg)([(0,s.lK)()],c.prototype,"shadowAngle",null),(0,h.Y5)("BABYLON.PointLight",c)},67682:(e,t,i)=>{i.r(t),i.d(t,{passCubePixelShaderWGSL:()=>n});const r="passCubePixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_cube<f32>;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f=input.vUV*2.0-1.0;\n#ifdef POSITIVEX\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(1.001,uv.y,uv.x));\n#endif\n#ifdef NEGATIVEX\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(-1.001,uv.y,uv.x));\n#endif\n#ifdef POSITIVEY\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv.y,1.001,uv.x));\n#endif\n#ifdef NEGATIVEY\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv.y,-1.001,uv.x));\n#endif\n#ifdef POSITIVEZ\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv,1.001));\n#endif\n#ifdef NEGATIVEZ\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv,-1.001));\n#endif\n}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},68133:(e,t,i)=>{i.r(t),i.d(t,{screenSpaceReflection2BlurPixelShader:()=>n});const r="screenSpaceReflection2BlurPixelShader",s="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)\n#else\n#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)\n#endif\nuniform sampler2D textureSampler;varying vec2 vUV;uniform vec2 texelOffsetScale;const float weights[8]=float[8] (0.071303,0.131514,0.189879,0.321392,0.452906, 0.584419,0.715932,0.847445);void processSample(vec2 uv,float i,vec2 stepSize,inout vec4 accumulator,inout float denominator)\n{vec2 offsetUV=stepSize*i+uv;float coefficient=weights[int(2.0-abs(i))];accumulator+=TEXTUREFUNC(textureSampler,offsetUV,0.0)*coefficient;denominator+=coefficient;}\nvoid main()\n{vec4 colorFull=TEXTUREFUNC(textureSampler,vUV,0.0);if (dot(colorFull,vec4(1.0))==0.0) {gl_FragColor=colorFull;return;}\nfloat blurRadius=colorFull.a*255.0; \nvec2 stepSize=texelOffsetScale.xy*blurRadius;vec4 accumulator=TEXTUREFUNC(textureSampler,vUV,0.0)*0.214607;float denominator=0.214607;processSample(vUV,1.0,stepSize,accumulator,denominator);processSample(vUV,1.0*0.2,stepSize,accumulator,denominator);processSample(vUV,1.0*0.4,stepSize,accumulator,denominator);processSample(vUV,1.0*0.6,stepSize,accumulator,denominator);processSample(vUV,1.0*0.8,stepSize,accumulator,denominator);processSample(vUV,1.0*1.2,stepSize,accumulator,denominator);processSample(vUV,1.0*1.4,stepSize,accumulator,denominator);processSample(vUV,1.0*1.6,stepSize,accumulator,denominator);processSample(vUV,1.0*1.8,stepSize,accumulator,denominator);processSample(vUV,1.0*2.0,stepSize,accumulator,denominator);processSample(vUV,-1.0,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.2,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.4,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.6,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.8,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.2,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.4,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.6,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.8,stepSize,accumulator,denominator);processSample(vUV,-1.0*2.0,stepSize,accumulator,denominator);gl_FragColor=vec4(accumulator.rgb/denominator,colorFull.a);}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},68217:(e,t,i)=>{i.r(t),i.d(t,{ssaoCombinePixelShaderWGSL:()=>n});const r="ssaoCombinePixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var originalColorSampler: sampler;var originalColor: texture_2d<f32>;uniform viewport: vec4f;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvar uv: vec2f=uniforms.viewport.xy+input.vUV*uniforms.viewport.zw;var ssaoColor: vec4f=textureSample(textureSampler,textureSamplerSampler,uv);var sceneColor: vec4f=textureSample(originalColor,originalColorSampler,uv);fragmentOutputs.color=sceneColor*ssaoColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},68547:(e,t,i)=>{i.r(t),i.d(t,{greasedLineVertexShaderWGSL:()=>o});var r=i(69610);i(44559),i(98327),i(6874),i(91277);const s="greasedLineVertexShader",n="#include<instancesDeclaration>\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\nattribute grl_widths: f32;\n#ifdef GREASED_LINE_USE_OFFSETS\nattribute grl_offsets: vec3f; \n#endif\nattribute grl_colorPointers: f32;attribute position: vec3f;varying grlCounters: f32;varying grlColorPointer: f32;\n#ifdef GREASED_LINE_CAMERA_FACING\nattribute grl_nextAndCounters: vec4f;attribute grl_previousAndSide: vec4f;uniform grlResolution: vec2f;uniform grlAspect: f32;uniform grlWidth: f32;uniform grlSizeAttenuation: f32;fn grlFix(i: vec4f,aspect: f32)->vec2f {var res=i.xy/i.w;res.x*=aspect;return res;}\n#else\nattribute grl_slopes: vec3f;attribute grl_counters: f32;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#include<instancesVertex>\nvertexOutputs.grlColorPointer=input.grl_colorPointers;let grlMatrix: mat4x4f=scene.viewProjection*mesh.world ;\n#ifdef GREASED_LINE_CAMERA_FACING\nlet grlBaseWidth: f32=uniforms.grlWidth;let grlPrevious: vec3f=input.grl_previousAndSide.xyz;let grlSide: f32=input.grl_previousAndSide.w;let grlNext: vec3f=input.grl_nextAndCounters.xyz;vertexOutputs.grlCounters=input.grl_nextAndCounters.w;let grlWidth:f32=grlBaseWidth*input.grl_widths;\n#ifdef GREASED_LINE_USE_OFFSETS\nvar grlPositionOffset: vec3f=input.grl_offsets;\n#else\nvar grlPositionOffset=vec3f(0.);\n#endif\nlet positionUpdated: vec3f=vertexInputs.position+grlPositionOffset;let worldDir: vec3f=normalize(grlNext-grlPrevious);let nearPosition: vec3f=positionUpdated+(worldDir*0.001);let grlFinalPosition: vec4f=grlMatrix*vec4f(positionUpdated,1.0);let screenNearPos: vec4f=grlMatrix*vec4(nearPosition,1.0);let grlLinePosition: vec2f=grlFix(grlFinalPosition,uniforms.grlAspect);let grlLineNearPosition: vec2f=grlFix(screenNearPos,uniforms.grlAspect);let grlDir: vec2f=normalize(grlLineNearPosition-grlLinePosition);var grlNormal: vec4f=vec4f(-grlDir.y,grlDir.x,0.0,1.0);let grlHalfWidth: f32=0.5*grlWidth;\n#if defined(GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM)\ngrlNormal.x*=-grlHalfWidth;grlNormal.y*=-grlHalfWidth;\n#else\ngrlNormal.x*=grlHalfWidth;grlNormal.y*=grlHalfWidth;\n#endif\ngrlNormal*=scene.projection;if (uniforms.grlSizeAttenuation==1.) {grlNormal.x*=grlFinalPosition.w;grlNormal.y*=grlFinalPosition.w;let pr=vec4f(uniforms.grlResolution,0.0,1.0)*scene.projection;grlNormal.x/=pr.x;grlNormal.y/=pr.y;}\nvertexOutputs.position=vec4f(grlFinalPosition.xy+grlNormal.xy*grlSide,grlFinalPosition.z,grlFinalPosition.w);\n#else\nvertexOutputs.grlCounters=input.grl_counters;vertexOutputs.position=grlMatrix*vec4f((vertexInputs.position+input.grl_offsets)+input.grl_slopes*input.grl_widths,1.0) ;\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}\n";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},68625:(e,t,i)=>{i.r(t),i.d(t,{grainPixelShaderWGSL:()=>o});var r=i(69610);i(79702);const s="grainPixelShader",n="#include<helperFunctions>\nvarying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform intensity: f32;uniform animatedSeed: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);var seed: vec2f=input.vUV*uniforms.animatedSeed;var grain: f32=dither(seed,uniforms.intensity);var lum: f32=getLuminance(fragmentOutputs.color.rgb);var grainAmount: f32=(cos(-PI+(lum*PI*2.))+1.)/2.;fragmentOutputs.color=vec4f(fragmentOutputs.color.rgb+grain*grainAmount,fragmentOutputs.color.a);fragmentOutputs.color=vec4f(max(fragmentOutputs.color.rgb,vec3f(0.0)),fragmentOutputs.color.a);}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},69363:(e,t,i)=>{const r="screenSpaceRayTrace",s="float distanceSquared(vec2 a,vec2 b) { a-=b; return dot(a,a); }\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nfloat linearizeDepth(float depth,float near,float far) {\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nreturn -(near*far)/(far-depth*(far-near));\n#else\nreturn (near*far)/(far-depth*(far-near));\n#endif\n}\n#endif\n/**\nparam csOrigin Camera-space ray origin,which must be \nwithin the view volume and must have z>0.01 and project within the valid screen rectangle\nparam csDirection Unit length camera-space ray direction\nparam projectToPixelMatrix A projection matrix that maps to **pixel** coordinates \n(**not** [-1,+1] normalized device coordinates).\nparam csZBuffer The camera-space Z buffer\nparam csZBufferSize Dimensions of csZBuffer\nparam csZThickness Camera space csZThickness to ascribe to each pixel in the depth buffer\nparam nearPlaneZ Positive number. Doesn't have to be THE actual near plane,just a reasonable value\nfor clipping rays headed towards the camera\nparam stride Step in horizontal or vertical pixels between samples. This is a float\nbecause integer math is slow on GPUs,but should be set to an integer>=1\nparam jitterFraction Number between 0 and 1 for how far to bump the ray in stride units\nto conceal banding artifacts,plus the stride ray offset.\nparam maxSteps Maximum number of iterations. Higher gives better images but may be slow\nparam maxRayTraceDistance Maximum camera-space distance to trace before returning a miss\nparam selfCollisionNumSkip Number of steps to skip at start when raytracing to avoid self collisions.\n1 is a reasonable value,depending on the scene you may need to set this value to 2\nparam hitPixel Pixel coordinates of the first intersection with the scene\nparam numIterations number of iterations performed\nparam csHitPoint Camera space location of the ray hit\n*/\n#define inline\nbool traceScreenSpaceRay1(\nvec3 csOrigin,\nvec3 csDirection,\nmat4 projectToPixelMatrix,\nsampler2D csZBuffer,\nvec2 csZBufferSize,\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nsampler2D csZBackBuffer,\nfloat csZBackSizeFactor,\n#endif\nfloat csZThickness,\nfloat nearPlaneZ,\nfloat farPlaneZ,\nfloat stride,\nfloat jitterFraction,\nfloat maxSteps,\nfloat maxRayTraceDistance,\nfloat selfCollisionNumSkip,\nout vec2 startPixel,\nout vec2 hitPixel,\nout vec3 csHitPoint,\nout float numIterations\n#ifdef SSRAYTRACE_DEBUG\n,out vec3 debugColor\n#endif\n)\n{\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nfloat rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)>-nearPlaneZ ? (-nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;\n#else\nfloat rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)<nearPlaneZ ? (nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;\n#endif\nvec3 csEndPoint=csOrigin+csDirection*rayLength;hitPixel=vec2(-1.0,-1.0);vec4 H0=projectToPixelMatrix*vec4(csOrigin,1.0);vec4 H1=projectToPixelMatrix*vec4(csEndPoint,1.0);float k0=1.0/H0.w;float k1=1.0/H1.w;vec3 Q0=csOrigin*k0;vec3 Q1=csEndPoint*k1;vec2 P0=H0.xy*k0;vec2 P1=H1.xy*k1;\n#ifdef SSRAYTRACE_CLIP_TO_FRUSTUM\nfloat xMax=csZBufferSize.x-0.5,xMin=0.5,yMax=csZBufferSize.y-0.5,yMin=0.5;float alpha=0.0;if ((P1.y>yMax) || (P1.y<yMin)) {alpha=(P1.y-((P1.y>yMax) ? yMax : yMin))/(P1.y-P0.y);}\nif ((P1.x>xMax) || (P1.x<xMin)) {alpha=max(alpha,(P1.x-((P1.x>xMax) ? xMax : xMin))/(P1.x-P0.x));}\nP1=mix(P1,P0,alpha); k1=mix(k1,k0,alpha); Q1=mix(Q1,Q0,alpha);\n#endif\nP1+=vec2((distanceSquared(P0,P1)<0.0001) ? 0.01 : 0.0);vec2 delta=P1-P0;bool permute=false;if (abs(delta.x)<abs(delta.y)) { \npermute=true;delta=delta.yx;P0=P0.yx;P1=P1.yx; }\nfloat stepDirection=sign(delta.x);float invdx=stepDirection/delta.x;vec2 dP=vec2(stepDirection,delta.y*invdx);vec3 dQ=(Q1-Q0)*invdx;float dk=(k1-k0)*invdx;float zMin=min(csEndPoint.z,csOrigin.z);float zMax=max(csEndPoint.z,csOrigin.z);dP*=stride; dQ*=stride; dk*=stride;P0+=dP*jitterFraction; Q0+=dQ*jitterFraction; k0+=dk*jitterFraction;vec4 pqk=vec4(P0,Q0.z,k0);vec4 dPQK=vec4(dP,dQ.z,dk);startPixel=permute ? P0.yx : P0.xy;float prevZMaxEstimate=csOrigin.z;float rayZMin=prevZMaxEstimate,rayZMax=prevZMaxEstimate;float sceneZMax=rayZMax+1e4;float end=P1.x*stepDirection;bool hit=false;float stepCount;for (stepCount=0.0;stepCount<=selfCollisionNumSkip ||\n(pqk.x*stepDirection)<=end &&\nstepCount<maxSteps &&\n!hit &&\nsceneZMax != 0.0; \npqk+=dPQK,++stepCount)\n{hitPixel=permute ? pqk.yx : pqk.xy;rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;if (rayZMin>rayZMax) { \nfloat t=rayZMin; rayZMin=rayZMax; rayZMax=t;}\nsceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);\n#endif\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nfloat sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);\n#endif\nhit=(rayZMax>=sceneBackZ-csZThickness) && (rayZMin<=sceneZMax);\n#else\nhit=(rayZMax>=sceneZMax-csZThickness) && (rayZMin<=sceneZMax);\n#endif\n#else\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nfloat sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);\n#endif\nhit=(rayZMin<=sceneBackZ+csZThickness) && (rayZMax>=sceneZMax) && (sceneZMax != 0.0);\n#else\nhit=(rayZMin<=sceneZMax+csZThickness) && (rayZMax>=sceneZMax);\n#endif\n#endif\n}\npqk-=dPQK;stepCount-=1.0;if (((pqk.x+dPQK.x)*stepDirection)>end || (stepCount+1.0)>=maxSteps || sceneZMax==0.0) {hit=false;}\n#ifdef SSRAYTRACE_ENABLE_REFINEMENT\nif (stride>1.0 && hit) {pqk-=dPQK;stepCount-=1.0;float invStride=1.0/stride;dPQK*=invStride;float refinementStepCount=0.0;prevZMaxEstimate=pqk.z/pqk.w;rayZMax=prevZMaxEstimate;sceneZMax=rayZMax+1e7;for (;refinementStepCount<=1.0 ||\n(refinementStepCount<=stride*1.4) &&\n(rayZMax<sceneZMax) && (sceneZMax != 0.0);pqk+=dPQK,refinementStepCount+=1.0)\n{rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;rayZMax=max(rayZMax,rayZMin);hitPixel=permute ? pqk.yx : pqk.xy;sceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);\n#endif\n}\npqk-=dPQK;refinementStepCount-=1.0;stepCount+=refinementStepCount/stride;}\n#endif\nQ0.xy+=dQ.xy*stepCount;Q0.z=pqk.z;csHitPoint=Q0/pqk.w;numIterations=stepCount+1.0;\n#ifdef SSRAYTRACE_DEBUG\nif (((pqk.x+dPQK.x)*stepDirection)>end) {debugColor=vec3(0,0,1);} else if ((stepCount+1.0)>=maxSteps) {debugColor=vec3(1,0,0);} else if (sceneZMax==0.0) {debugColor=vec3(1,1,0);} else {debugColor=vec3(0,stepCount/maxSteps,0);}\n#endif\nreturn hit;}\n/**\ntexCoord: in the [0,1] range\ndepth: depth in view space (range [znear,zfar]])\n*/\nvec3 computeViewPosFromUVDepth(vec2 texCoord,float depth,mat4 projection,mat4 invProjectionMatrix) {vec4 ndc;ndc.xy=texCoord*2.0-1.0;\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\n#ifdef ORTHOGRAPHIC_CAMERA\nndc.z=-projection[2].z*depth+projection[3].z;\n#else\nndc.z=-projection[2].z-projection[3].z/depth;\n#endif\n#else\n#ifdef ORTHOGRAPHIC_CAMERA\nndc.z=projection[2].z*depth+projection[3].z;\n#else\nndc.z=projection[2].z+projection[3].z/depth;\n#endif\n#endif\nndc.w=1.0;vec4 eyePos=invProjectionMatrix*ndc;eyePos.xyz/=eyePos.w;return eyePos.xyz;}\n";i(69610).l.IncludesShadersStore[r]=s},69384:(e,t,i)=>{i.r(t),i.d(t,{_IESTextureLoader:()=>s});var r=i(83020);class s{constructor(){this.supportCascades=!1}loadCubeData(){throw".ies not supported in Cube."}loadData(e,t,i){const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),n=(0,r.i)(s);i(n.width,n.height,!1,!1,(()=>{const e=t.getEngine();t.type=1,t.format=6,t._gammaSpace=!1,e._uploadDataToTextureDirectly(t,n.data)}))}}},69386:(e,t,i)=>{i.r(t),i.d(t,{depthBoxBlurPixelShader:()=>n});const r="depthBoxBlurPixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 colorDepth=vec4(0.0);for (int x=-OFFSET; x<=OFFSET; x++)\nfor (int y=-OFFSET; y<=OFFSET; y++)\ncolorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);gl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},69486:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphGetAssetBlock:()=>h});var r=i(10403),s=i(71294),n=i(4720),o=i(56552),a=i(90868),l=i(4686);class h extends s.e{constructor(e){super(e),this.config=e,this.type=this.registerDataInput("type",n.Vv,e.type),this.value=this.registerDataOutput("value",n.Vv),this.index=this.registerDataInput("index",n.Vv,new a.P((0,l.$w)(e.index??-1)))}_updateOutputs(e){const t=this.type.getValue(e),i=this.index.getValue(e),s=(0,r.N)(e.assetsContext,t,(0,l.$w)(i),this.config.useIndexAsUniqueId);this.value.setValue(s,e)}getClassName(){return"FlowGraphGetAssetBlock"}}(0,o.Y5)("FlowGraphGetAssetBlock",h)},69569:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphSceneTickEventBlock:()=>o});var r=i(22086),s=i(56552),n=i(4720);class o extends r.i{constructor(){super(),this.type="SceneBeforeRender",this.timeSinceStart=this.registerDataOutput("timeSinceStart",n.Es),this.deltaTime=this.registerDataOutput("deltaTime",n.Es)}_preparePendingTasks(e){}_executeEvent(e,t){return this.timeSinceStart.setValue(t.timeSinceStart,e),this.deltaTime.setValue(t.deltaTime,e),this._execute(e),!0}_cancelPendingTasks(e){}getClassName(){return"FlowGraphSceneTickEventBlock"}}(0,s.Y5)("FlowGraphSceneTickEventBlock",o)},69723:(e,t,i)=>{i.r(t),i.d(t,{anaglyphPixelShader:()=>n});const r="anaglyphPixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D leftSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 leftFrag=texture2D(leftSampler,vUV);leftFrag=vec4(1.0,leftFrag.g,leftFrag.b,1.0);vec4 rightFrag=texture2D(textureSampler,vUV);rightFrag=vec4(rightFrag.r,1.0,1.0,1.0);gl_FragColor=vec4(rightFrag.rgb*leftFrag.rgb,1.0);}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},70169:(e,t,i)=>{i.r(t),i.d(t,{shadowMapPixelShader:()=>c});var r=i(69610);i(8334);const s="bayerDitherFunctions",n="float bayerDither2(vec2 _P) {return mod(2.0*_P.y+_P.x+1.0,4.0);}\nfloat bayerDither4(vec2 _P) {vec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5*mod(_P,4.0)); \nreturn 4.0*bayerDither2(P1)+bayerDither2(P2);}\nfloat bayerDither8(vec2 _P) {vec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5 *mod(_P,4.0)); \nvec2 P4=floor(0.25*mod(_P,8.0)); \nreturn 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}\n";r.l.IncludesShadersStore[s]=n;const o="shadowMapFragmentExtraDeclaration",a="#if SM_FLOAT==0\n#include<packingFunctions>\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#include<bayerDitherFunctions>\nuniform vec2 softTransparentShadowSM;\n#endif\nvarying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nuniform vec3 lightDataSM;varying vec3 vPositionWSM;\n#endif\nuniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n";r.l.IncludesShadersStore[o]=a;i(6194),i(7412),i(98322);const l="shadowMapPixelShader",h="#include<shadowMapFragmentExtraDeclaration>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;uniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEXTURE\nvec4 opacityMap=texture2D(diffuseSampler,vUV);float alphaFromAlphaTexture=opacityMap.a;\n#if SM_SOFTTRANSPARENTSHADOW==1\nif (softTransparentShadowSM.y==1.0) {opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);alphaFromAlphaTexture=opacityMap.x+opacityMap.y+opacityMap.z;}\n#endif\n#ifdef ALPHATESTVALUE\nif (alphaFromAlphaTexture<ALPHATESTVALUE)\ndiscard;\n#endif\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#ifdef ALPHATEXTURE\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x*alphaFromAlphaTexture) discard;\n#else\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x) discard;\n#endif\n#endif\n#include<shadowMapFragment>\n}";r.l.ShadersStore[l]=h;const c={name:l,shader:h}},70633:(e,t,i)=>{i.r(t),i.d(t,{lensFlareVertexShader:()=>n});const r="lensFlareVertexShader",s="attribute vec2 position;uniform mat4 viewportMatrix;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=position*madd+madd;gl_Position=viewportMatrix*vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},70711:(e,t,i)=>{i.r(t),i.d(t,{layerPixelShaderWGSL:()=>o});var r=i(69610);i(79702);const s="layerPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform color: vec4f;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvar baseColor: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);\n#if defined(CONVERT_TO_GAMMA)\nbaseColor=toGammaSpace(baseColor);\n#elif defined(CONVERT_TO_LINEAR)\nbaseColor=toLinearSpaceVec4(baseColor);\n#endif\n#ifdef ALPHATEST\nif (baseColor.a<0.4) {discard;}\n#endif\nfragmentOutputs.color=baseColor*uniforms.color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},71271:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphFunctionReferenceBlock:()=>o});var r=i(71294),s=i(4720),n=i(56552);class o extends r.e{constructor(e){super(e),this.functionName=this.registerDataInput("functionName",s.KV),this.object=this.registerDataInput("object",s.Vv),this.context=this.registerDataInput("context",s.Vv,null),this.output=this.registerDataOutput("output",s.Vv)}_updateOutputs(e){const t=this.functionName.getValue(e),i=this.object.getValue(e),r=this.context.getValue(e);if(i&&t){const s=i[t];s&&"function"==typeof s&&this.output.setValue(s.bind(r),e)}}getClassName(){return"FlowGraphFunctionReference"}}(0,n.Y5)("FlowGraphFunctionReference",o)},71311:(e,t,i)=>{i.r(t),i.d(t,{shadowMapVertexMetricWGSL:()=>n});const r="shadowMapVertexMetric",s="#if SM_USEDISTANCE==1\nvertexOutputs.vPositionWSM=worldPos.xyz;\n#endif\n#if SM_DEPTHTEXTURE==1\n#ifdef IS_NDC_HALF_ZRANGE\n#define BIASFACTOR 0.5\n#else\n#define BIASFACTOR 1.0\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.position.z-=uniforms.biasAndScaleSM.x*vertexOutputs.position.w*BIASFACTOR;\n#else\nvertexOutputs.position.z+=uniforms.biasAndScaleSM.x*vertexOutputs.position.w*BIASFACTOR;\n#endif\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvertexOutputs.zSM=vertexOutputs.position.z;vertexOutputs.position.z=0.0;\n#elif SM_USEDISTANCE==0\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetricSM=(-vertexOutputs.position.z+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#else\nvertexOutputs.vDepthMetricSM=(vertexOutputs.position.z+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#endif\n#endif\n";i(69610).l.IncludesShadersStoreWGSL[r]=s;const n={name:r,shader:s}},71405:(e,t,i)=>{i.r(t),i.d(t,{taaPixelShader:()=>n});const r="taaPixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D historySampler;uniform float factor;void main() {vec4 c=texelFetch(textureSampler,ivec2(gl_FragCoord.xy),0);vec4 h=texelFetch(historySampler,ivec2(gl_FragCoord.xy),0);gl_FragColor=mix(h,c,factor);}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},71698:(e,t,i)=>{var r=i(69610);i(98327),i(6874);const s="defaultUboDeclaration",n="uniform diffuseLeftColor: vec4f;uniform diffuseRightColor: vec4f;uniform opacityParts: vec4f;uniform reflectionLeftColor: vec4f;uniform reflectionRightColor: vec4f;uniform refractionLeftColor: vec4f;uniform refractionRightColor: vec4f;uniform emissiveLeftColor: vec4f;uniform emissiveRightColor: vec4f;uniform vDiffuseInfos: vec2f;uniform vAmbientInfos: vec2f;uniform vOpacityInfos: vec2f;uniform vReflectionInfos: vec2f;uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;uniform vEmissiveInfos: vec2f;uniform vLightmapInfos: vec2f;uniform vSpecularInfos: vec2f;uniform vBumpInfos: vec3f;uniform diffuseMatrix: mat4x4f;uniform ambientMatrix: mat4x4f;uniform opacityMatrix: mat4x4f;uniform reflectionMatrix: mat4x4f;uniform emissiveMatrix: mat4x4f;uniform lightmapMatrix: mat4x4f;uniform specularMatrix: mat4x4f;uniform bumpMatrix: mat4x4f;uniform vTangentSpaceParams: vec2f;uniform pointSize: f32;uniform alphaCutOff: f32;uniform refractionMatrix: mat4x4f;uniform vRefractionInfos: vec4f;uniform vRefractionPosition: vec3f;uniform vRefractionSize: vec3f;uniform vSpecularColor: vec4f;uniform vEmissiveColor: vec3f;uniform vDiffuseColor: vec4f;uniform vAmbientColor: vec3f;\n#define ADDITIONAL_UBO_DECLARATION\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";r.l.IncludesShadersStoreWGSL[s]=n},72266:(e,t,i)=>{i.d(t,{H:()=>p});var r=i(75524),s=i(79259),n=i(26877),o=i(56552),a=i(7481),l=i(82678),h=i(51137),c=i(38573),u=i(39176),d=i(2940);class p{get options(){return this._options}get shaderPath(){return this._shaderPath}constructor(e,t,i,r={}){this._bindings={},this._samplers={},this._contextIsDirty=!1,this.fastMode=!1,this.onCompiled=null,this.onError=null,this.name=e,this._engine=t,this.uniqueId=l.K.UniqueId,t.enableGPUTimingMeasurements&&(this.gpuTimeInFrame=new u.e),this._engine.getCaps().supportComputeShaders?r.bindingsMapping?(this._context=t.createComputeContext(),this._shaderPath=i,this._options={bindingsMapping:{},defines:[],...r}):h.V.Error("You must provide the binding mappings as browsers don't support reflection for wgsl shaders yet!"):h.V.Error("This engine does not support compute shaders!")}getClassName(){return"ComputeShader"}setTexture(e,t,i=!0){const r=this._bindings[e];this._bindings[e]={type:i?0:4,object:t,indexInGroupEntries:r?.indexInGroupEntries},this._contextIsDirty||(this._contextIsDirty=!r||r.object!==t||r.type!==this._bindings[e].type)}setStorageTexture(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:1,object:t,indexInGroupEntries:i?.indexInGroupEntries}}setExternalTexture(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:6,object:t,indexInGroupEntries:i?.indexInGroupEntries}}setVideoTexture(e,t){return!!t.externalTexture&&(this.setExternalTexture(e,t.externalTexture),!0)}setUniformBuffer(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:p._BufferIsDataBuffer(t)?7:2,object:t,indexInGroupEntries:i?.indexInGroupEntries}}setStorageBuffer(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:p._BufferIsDataBuffer(t)?7:3,object:t,indexInGroupEntries:i?.indexInGroupEntries}}setTextureSampler(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||!t.compareSampler(i.object)),this._bindings[e]={type:5,object:t,indexInGroupEntries:i?.indexInGroupEntries}}isReady(){let e=this._effect;for(const e in this._bindings){const t=this._bindings[e],i=t.type,r=t.object;switch(i){case 0:case 4:case 1:if(!r.isReady())return!1;break;case 6:if(!r.isReady())return!1;break}}const t=[],i=this._shaderPath;if(this._options.defines)for(let e=0;e<this._options.defines.length;e++)t.push(this._options.defines[e]);const r=t.join("\n");return this._cachedDefines!==r&&(this._cachedDefines=r,e=this._engine.createComputeEffect(i,{defines:r,entryPoint:this._options.entryPoint,onCompiled:this.onCompiled,onError:this.onError}),this._effect=e),!!e.isReady()}dispatch(e,t,i){return!(!this.fastMode&&!this._checkContext())&&(this._engine.computeDispatch(this._effect,this._context,this._bindings,e,t,i,this._options.bindingsMapping,this.gpuTimeInFrame),!0)}dispatchIndirect(e,t=0){if(!this.fastMode&&!this._checkContext())return!1;const i=p._BufferIsDataBuffer(e)?e:e.getBuffer();return this._engine.computeDispatchIndirect(this._effect,this._context,this._bindings,i,t,this._options.bindingsMapping,this.gpuTimeInFrame),!0}_checkContext(){if(!this.isReady())return!1;for(const e in this._bindings){const t=this._bindings[e];if(!this._options.bindingsMapping[e])throw new Error("ComputeShader ('"+this.name+"'): No binding mapping has been provided for the property '"+e+"'");switch(t.type){case 0:{const i=this._samplers[e],r=t.object;i&&r._texture&&i.compareSampler(r._texture)||(this._samplers[e]=(new c.u).setParameters(r.wrapU,r.wrapV,r.wrapR,r.anisotropicFilteringLevel,r._texture.samplingMode,r._texture?._comparisonFunction),this._contextIsDirty=!0);break}case 6:this._contextIsDirty=!0;break;case 2:{const e=t.object;e.getBuffer()!==t.buffer&&(t.buffer=e.getBuffer(),this._contextIsDirty=!0);break}}}return this._contextIsDirty&&(this._contextIsDirty=!1,this._context.clear()),!0}dispatchWhenReady(e,t,i,r=10){return new Promise((s=>{(0,d.F)((()=>this.dispatch(e,t,i)),s,void 0,r)}))}serialize(){const e=n.p.Serialize(this);e.options=this._options,e.shaderPath=this._shaderPath,e.bindings={},e.textures={};for(const t in this._bindings){const i=this._bindings[t],r=i.object;switch(i.type){case 0:case 4:case 1:{const s=r.serialize();s&&(e.textures[t]=s,e.bindings[t]={type:i.type});break}}}return e}static Parse(e,t,i){const r=n.p.Parse((()=>new p(e.name,t.getEngine(),e.shaderPath,e.options)),e,t,i);for(const s in e.textures){const n=e.bindings[s],o=a.g.Parse(e.textures[s],t,i);0===n.type?r.setTexture(s,o):4===n.type?r.setTexture(s,o,!1):r.setStorageTexture(s,o)}return r}static _BufferIsDataBuffer(e){return void 0!==e.underlyingResource}}(0,r.Cg)([(0,s.lK)()],p.prototype,"name",void 0),(0,r.Cg)([(0,s.lK)()],p.prototype,"fastMode",void 0),(0,o.Y5)("BABYLON.ComputeShader",p)},72536:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphMeshPickEventBlock:()=>l});var r=i(22086),s=i(66240),n=i(56552),o=i(4686),a=i(4720);class l extends r.i{constructor(e){super(e),this.config=e,this.type="MeshPick",this.asset=this.registerDataInput("asset",a.Vv,e?.targetMesh),this.pickedPoint=this.registerDataOutput("pickedPoint",a.Dx),this.pickOrigin=this.registerDataOutput("pickOrigin",a.Dx),this.pointerId=this.registerDataOutput("pointerId",a.Es),this.pickedMesh=this.registerDataOutput("pickedMesh",a.Vv),this.pointerType=this.registerDataInput("pointerType",a.Vv,s.Zp.POINTERPICK)}_getReferencedMesh(e){return this.asset.getValue(e)}_executeEvent(e,t){if(this.pointerType.getValue(e)!==t.type)return!0;const i=this._getReferencedMesh(e);return i&&t.pickInfo?.pickedMesh&&(t.pickInfo?.pickedMesh===i||(0,o.rC)(t.pickInfo?.pickedMesh,i))?(this.pointerId.setValue(t.event.pointerId,e),this.pickOrigin.setValue(t.pickInfo.ray?.origin,e),this.pickedPoint.setValue(t.pickInfo.pickedPoint,e),this.pickedMesh.setValue(t.pickInfo.pickedMesh,e),this._execute(e),!this.config?.stopPropagation):(this.pointerId.resetToDefaultValue(e),this.pickOrigin.resetToDefaultValue(e),this.pickedPoint.resetToDefaultValue(e),this.pickedMesh.resetToDefaultValue(e),!0)}_preparePendingTasks(e){}_cancelPendingTasks(e){}getClassName(){return"FlowGraphMeshPickEventBlock"}}(0,n.Y5)("FlowGraphMeshPickEventBlock",l)},72578:(e,t,i)=>{i.r(t),i.d(t,{fxaaPixelShaderWGSL:()=>n});const r="fxaaPixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform texelSize: vec2f;varying sampleCoordS: vec2f;varying sampleCoordE: vec2f;varying sampleCoordN: vec2f;varying sampleCoordW: vec2f;varying sampleCoordNW: vec2f;varying sampleCoordSE: vec2f;varying sampleCoordNE: vec2f;varying sampleCoordSW: vec2f;const fxaaQualitySubpix: f32=1.0;const fxaaQualityEdgeThreshold: f32=0.166;const fxaaQualityEdgeThresholdMin: f32=0.0833;const kLumaCoefficients: vec3f= vec3f(0.2126,0.7152,0.0722);fn FxaaLuma(rgba: vec4f)->f32 {return dot(rgba.rgb,kLumaCoefficients);} \n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var posM: vec2f;posM.x=input.vUV.x;posM.y=input.vUV.y;var rgbyM: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var lumaM: f32=FxaaLuma(rgbyM);var lumaS: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordS,0.0));var lumaE: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordE,0.0));var lumaN: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordN,0.0));var lumaW: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordW,0.0));var maxSM: f32=max(lumaS,lumaM);var minSM: f32=min(lumaS,lumaM);var maxESM: f32=max(lumaE,maxSM);var minESM: f32=min(lumaE,minSM);var maxWN: f32=max(lumaN,lumaW);var minWN: f32=min(lumaN,lumaW);var rangeMax: f32=max(maxWN,maxESM);var rangeMin: f32=min(minWN,minESM);var rangeMaxScaled: f32=rangeMax*fxaaQualityEdgeThreshold;var range: f32=rangeMax-rangeMin;var rangeMaxClamped: f32=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);\n#ifndef MALI\nif(range<rangeMaxClamped) \n{fragmentOutputs.color=rgbyM;return fragmentOutputs;}\n#endif\nvar lumaNW: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordNW,0.0));var lumaSE: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordSE,0.0));var lumaNE: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordNE,0.0));var lumaSW: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordSW,0.0));var lumaNS: f32=lumaN+lumaS;var lumaWE: f32=lumaW+lumaE;var subpixRcpRange: f32=1.0/range;var subpixNSWE: f32=lumaNS+lumaWE;var edgeHorz1: f32=(-2.0*lumaM)+lumaNS;var edgeVert1: f32=(-2.0*lumaM)+lumaWE;var lumaNESE: f32=lumaNE+lumaSE;var lumaNWNE: f32=lumaNW+lumaNE;var edgeHorz2: f32=(-2.0*lumaE)+lumaNESE;var edgeVert2: f32=(-2.0*lumaN)+lumaNWNE;var lumaNWSW: f32=lumaNW+lumaSW;var lumaSWSE: f32=lumaSW+lumaSE;var edgeHorz4: f32=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);var edgeVert4: f32=(abs(edgeVert1)*2.0)+abs(edgeVert2);var edgeHorz3: f32=(-2.0*lumaW)+lumaNWSW;var edgeVert3: f32=(-2.0*lumaS)+lumaSWSE;var edgeHorz: f32=abs(edgeHorz3)+edgeHorz4;var edgeVert: f32=abs(edgeVert3)+edgeVert4;var subpixNWSWNESE: f32=lumaNWSW+lumaNESE;var lengthSign: f32=uniforms.texelSize.x;var horzSpan: bool=edgeHorz>=edgeVert;var subpixA: f32=subpixNSWE*2.0+subpixNWSWNESE;if (!horzSpan)\n{lumaN=lumaW;}\nif (!horzSpan) \n{lumaS=lumaE;}\nif (horzSpan) \n{lengthSign=uniforms.texelSize.y;}\nvar subpixB: f32=(subpixA*(1.0/12.0))-lumaM;var gradientN: f32=lumaN-lumaM;var gradientS: f32=lumaS-lumaM;var lumaNN: f32=lumaN+lumaM;var lumaSS: f32=lumaS+lumaM;var pairN: bool=abs(gradientN)>=abs(gradientS);var gradient: f32=max(abs(gradientN),abs(gradientS));if (pairN)\n{lengthSign=-lengthSign;}\nvar subpixC: f32=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);var posB: vec2f;posB.x=posM.x;posB.y=posM.y;var offNP: vec2f;offNP.x=select(uniforms.texelSize.x,0.0,(!horzSpan));offNP.y=select(uniforms.texelSize.y,0.0,(horzSpan));if (!horzSpan) \n{posB.x+=lengthSign*0.5;}\nif (horzSpan)\n{posB.y+=lengthSign*0.5;}\nvar posN: vec2f;posN.x=posB.x-offNP.x*1.5;posN.y=posB.y-offNP.y*1.5;var posP: vec2f;posP.x=posB.x+offNP.x*1.5;posP.y=posB.y+offNP.y*1.5;var subpixD: f32=((-2.0)*subpixC)+3.0;var lumaEndN: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posN,0.0));var subpixE: f32=subpixC*subpixC;var lumaEndP: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posP,0.0));if (!pairN) \n{lumaNN=lumaSS;}\nvar gradientScaled: f32=gradient*1.0/4.0;var lumaMM: f32=lumaM-lumaNN*0.5;var subpixF: f32=subpixD*subpixE;var lumaMLTZero: bool=lumaMM<0.0;lumaEndN-=lumaNN*0.5;lumaEndP-=lumaNN*0.5;var doneN: bool=abs(lumaEndN)>=gradientScaled;var doneP: bool=abs(lumaEndP)>=gradientScaled;if (!doneN) \n{posN.x-=offNP.x*3.0;}\nif (!doneN) \n{posN.y-=offNP.y*3.0;}\nvar doneNP: bool=(!doneN) || (!doneP);if (!doneP) \n{posP.x+=offNP.x*3.0;}\nif (!doneP)\n{posP.y+=offNP.y*3.0;}\nif (doneNP)\n{if (!doneN) {lumaEndN=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posN.xy,0.0));}\nif (!doneP) {lumaEndP=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posP.xy,0.0));}\nif (!doneN) {lumaEndN=lumaEndN-lumaNN*0.5;}\nif (!doneP) {lumaEndP=lumaEndP-lumaNN*0.5;}\ndoneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) {posN.x-=offNP.x*12.0;}\nif (!doneN) {posN.y-=offNP.y*12.0;}\ndoneNP=(!doneN) || (!doneP);if (!doneP) {posP.x+=offNP.x*12.0;}\nif (!doneP) {posP.y+=offNP.y*12.0;}}\nvar dstN: f32=posM.x-posN.x;var dstP: f32=posP.x-posM.x;if (!horzSpan)\n{dstN=posM.y-posN.y;}\nif (!horzSpan) \n{dstP=posP.y-posM.y;}\nvar goodSpanN: bool=(lumaEndN<0.0) != lumaMLTZero;var spanLength: f32=(dstP+dstN);var goodSpanP: bool=(lumaEndP<0.0) != lumaMLTZero;var spanLengthRcp: f32=1.0/spanLength;var directionN: bool=dstN<dstP;var dst: f32=min(dstN,dstP);var goodSpan: bool=select(goodSpanP,goodSpanN,directionN);var subpixG: f32=subpixF*subpixF;var pixelOffset: f32=(dst*(-spanLengthRcp))+0.5;var subpixH: f32=subpixG*fxaaQualitySubpix;var pixelOffsetGood: f32=select(0.0,pixelOffset,goodSpan);var pixelOffsetSubpix: f32=max(pixelOffsetGood,subpixH);if (!horzSpan)\n{posM.x+=pixelOffsetSubpix*lengthSign;}\nif (horzSpan)\n{posM.y+=pixelOffsetSubpix*lengthSign;}\n#ifdef MALI\nif(range<rangeMaxClamped) \n{fragmentOutputs.color=rgbyM;}\nelse\n{fragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,posM,0.0);}\n#else\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,posM,0.0);\n#endif\n}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},72657:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererPixelShaderWGSL:()=>n});const r="meshUVSpaceRendererPixelShader",s="varying vDecalTC: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {if (input.vDecalTC.x<0. || input.vDecalTC.x>1. || input.vDecalTC.y<0. || input.vDecalTC.y>1.) {discard;}\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vDecalTC);}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},73383:(e,t,i)=>{i.d(t,{Q:()=>g});var r=i(93460),s=i(15518),n=i(56744),o=i(82704),a=i(23694),l=i(79923);const h=l.uq.Zero(),c=new l.PT,u=l.Pq.Zero();function d(e){return e*Math.PI/180}function p(e){return 180*e/Math.PI}class m extends r.Au{constructor(e){super(e),this._lastPosition=l.Pq.Zero(),this._lastRotation=l.Pq.Zero(),this._lastRotationQuaternion=new l.PT,this.position=o.Qc.position.clone(),this.rotation=o.Qc.rotation.clone(),this.rotationQuaternion=o.Qc.rotationQuaternion.clone(),this.node=new PannerNode(e.audioContext)}get coneInnerAngle(){return d(this.node.coneInnerAngle)}set coneInnerAngle(e){this.node.coneInnerAngle=p(e)}get coneOuterAngle(){return d(this.node.coneOuterAngle)}set coneOuterAngle(e){this.node.coneOuterAngle=p(e)}get coneOuterVolume(){return this.node.coneOuterGain}set coneOuterVolume(e){this.node.coneOuterGain=e}get distanceModel(){return this.node.distanceModel}set distanceModel(e){this.node.distanceModel=e;const t=this.node.maxDistance;this.node.maxDistance=t+.001,this.node.maxDistance=t}get minDistance(){return this.node.refDistance}set minDistance(e){this.node.refDistance=e}get maxDistance(){return this.node.maxDistance}set maxDistance(e){this.node.maxDistance=e}get panningModel(){return this.node.panningModel}set panningModel(e){this.node.panningModel=e}get rolloffFactor(){return this.node.rolloffFactor}set rolloffFactor(e){this.node.rolloffFactor=e}get inNode(){return this.node}get outNode(){return this.node}_updatePosition(){this._lastPosition.equalsWithEpsilon(this.position)||(this.node.positionX.value=this.position.x,this.node.positionY.value=this.position.y,this.node.positionZ.value=this.position.z,this._lastPosition.copyFrom(this.position))}_updateRotation(){if(this._lastRotationQuaternion.equalsWithEpsilon(this.rotationQuaternion)){if(this._lastRotation.equalsWithEpsilon(this.rotation))return;l.PT.FromEulerAnglesToRef(this.rotation.x,this.rotation.y,this.rotation.z,c),this._lastRotation.copyFrom(this.rotation)}else c.copyFrom(this.rotationQuaternion),this._lastRotationQuaternion.copyFrom(this.rotationQuaternion);l.uq.FromQuaternionToRef(c,h),l.Pq.TransformNormalToRef(l.Pq.RightReadOnly,h,u),this.node.orientationX.value=u.x,this.node.orientationY.value=u.y,this.node.orientationZ.value=u.z}_connect(e){return!!super._connect(e)&&(e.inNode&&this.node.connect(e.inNode),!0)}_disconnect(e){return!!super._disconnect(e)&&(e.inNode&&this.node.disconnect(e.inNode),!0)}getClassName(){return"_SpatialWebAudioSubNode"}}class f extends s.a7{constructor(e){super(e),this.node=new StereoPannerNode(e.audioContext)}get pan(){return this.node.pan.value}set pan(e){this.node.pan.value=e}get inNode(){return this.node}get outNode(){return this.node}getClassName(){return"_StereoWebAudioSubNode"}_connect(e){return!!super._connect(e)&&(e.inNode&&this.node.connect(e.inNode),!0)}_disconnect(e){return!!super._disconnect(e)&&(e.inNode&&this.node.disconnect(e.inNode),!0)}}var _=i(50186);class g extends _.H{constructor(){super(...arguments),this._rootNode=null,this._inNode=null}async init(e){await super.init(e);let t=!1,i=!1;(t=(0,o.GB)(e))&&await this.createAndAddSubNode("Spatial"),(i=(0,a.uD)(e))&&await this.createAndAddSubNode("Stereo"),await this._createSubNodePromisesResolved(),t&&(0,r.y5)(this)?.setOptions(e),i&&(0,s.KJ)(this)?.setOptions(e)}get inNode(){return this._inNode}_createSubNode(e){try{return super._createSubNode(e)}catch(e){}switch(e){case"Spatial":return async function(e){return new m(e)}(this._owner.engine);case"Stereo":return async function(e){return new f(e)}(this._owner.engine);default:throw new Error(`Unknown subnode name: ${e}`)}}_onSubNodesChanged(){super._onSubNodesChanged();const e=(0,r.y5)(this),t=(0,s.KJ)(this),i=(0,n.sf)(this);if(e&&"_SpatialWebAudioSubNode"!==e.getClassName())throw new Error("Not a WebAudio subnode.");if(t&&"_StereoWebAudioSubNode"!==t.getClassName())throw new Error("Not a WebAudio subnode.");if(i&&"_VolumeWebAudioSubNode"!==i.getClassName())throw new Error("Not a WebAudio subnode.");e&&(e.disconnectAll(),i&&e.connect(i)),t&&(t.disconnectAll(),i&&t.connect(i)),e&&t?(this._rootNode=new GainNode(this._owner.engine.audioContext),this._rootNode.connect(e.outNode),this._rootNode.connect(t.outNode)):(this._rootNode?.disconnect(),this._rootNode=null);let o=null,a=null;if(this._rootNode?a=this._rootNode:(e?o=e:t?o=t:i&&(o=i),a=o?.node??null),this._inNode!==a){if(this._inNode&&this._upstreamNodes){const e=this._upstreamNodes.values();for(let t=e.next();!t.done;t=e.next())t.value.outNode?.disconnect(this._inNode)}if(this._inNode=a,a&&this._upstreamNodes){const e=this._upstreamNodes.values();for(let t=e.next();!t.done;t=e.next())t.value.outNode?.connect(a)}}}}},73718:(e,t,i)=>{i.r(t),i.d(t,{displayPassPixelShader:()=>n});const r="displayPassPixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D passSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(passSampler,vUV);}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},74154:(e,t,i)=>{i.r(t),i.d(t,{ssaoCombinePixelShader:()=>n});const r="ssaoCombinePixelShader",s="uniform sampler2D textureSampler;uniform sampler2D originalColor;uniform vec4 viewport;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec2 uv=viewport.xy+vUV*viewport.zw;vec4 ssaoColor=texture2D(textureSampler,uv);vec4 sceneColor=texture2D(originalColor,uv);gl_FragColor=sceneColor*ssaoColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},74232:(e,t,i)=>{i.d(t,{i:()=>n});var r=i(23694),s=i(15518);class n extends r.bO{constructor(e){super(),this._subGraph=e}get pan(){return(0,s.x8)(this._subGraph,"pan")}set pan(e){(0,s.n9)(this._subGraph,"pan",e)}}},75007:(e,t,i)=>{i.r(t),i.d(t,{geometryPixelShader:()=>l});var r=i(69610);i(6194);const s="mrtFragmentDeclaration",n="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nlayout(location=0) out vec4 glFragData[{X}];\n#endif\n";r.l.IncludesShadersStore[s]=n;i(17494),i(8269),i(73325),i(7412),i(27018);const o="geometryPixelShader",a="#extension GL_EXT_draw_buffers : require\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\nprecision highp float;\n#ifdef BUMP\nvarying mat4 vWorldView;varying vec3 vNormalW;\n#else\nvarying vec3 vNormalV;\n#endif\nvarying vec4 vViewPos;\n#if defined(POSITION) || defined(BUMP)\nvarying vec3 vPositionW;\n#endif\n#if defined(VELOCITY) || defined(VELOCITY_LINEAR)\nvarying vec4 vCurrentPosition;varying vec4 vPreviousPosition;\n#endif\n#ifdef NEED_UV\nvarying vec2 vUV;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;\n#endif\n#if defined(REFLECTIVITY)\n#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nuniform sampler2D reflectivitySampler;varying vec2 vReflectivityUV;\n#endif\n#ifdef ALBEDOTEXTURE\nvarying vec2 vAlbedoUV;uniform sampler2D albedoSampler;\n#endif\n#ifdef REFLECTIVITYCOLOR\nuniform vec3 reflectivityColor;\n#endif\n#ifdef ALBEDOCOLOR\nuniform vec3 albedoColor;\n#endif\n#ifdef METALLIC\nuniform float metallic;\n#endif\n#if defined(ROUGHNESS) || defined(GLOSSINESS)\nuniform float glossiness;\n#endif\n#endif\n#if defined(ALPHATEST) && defined(NEED_UV)\nuniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<mrtFragmentDeclaration>[SCENE_MRT_COUNT]\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<helperFunctions>\nvoid main() {\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\nvec3 normalOutput;\n#ifdef BUMP\nvec3 normalW=normalize(vNormalW);\n#include<bumpFragment>\n#ifdef NORMAL_WORLDSPACE\nnormalOutput=normalW;\n#else\nnormalOutput=normalize(vec3(vWorldView*vec4(normalW,0.0)));\n#endif\n#else\nnormalOutput=normalize(vNormalV);\n#endif\n#ifdef ENCODE_NORMAL\nnormalOutput=normalOutput*0.5+0.5;\n#endif\n#ifdef DEPTH\ngl_FragData[DEPTH_INDEX]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);\n#endif\n#ifdef NORMAL\ngl_FragData[NORMAL_INDEX]=vec4(normalOutput,1.0);\n#endif\n#ifdef SCREENSPACE_DEPTH\ngl_FragData[SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,1.0);\n#endif\n#ifdef POSITION\ngl_FragData[POSITION_INDEX]=vec4(vPositionW,1.0);\n#endif\n#ifdef VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[VELOCITY_INDEX]=vec4(velocity,0.0,1.0);\n#endif\n#ifdef VELOCITY_LINEAR\nvec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w) -\n(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,1.0);\n#endif\n#ifdef REFLECTIVITY\nvec4 reflectivity=vec4(0.0,0.0,0.0,1.0);\n#ifdef METALLICWORKFLOW\nfloat metal=1.0;float roughness=1.0;\n#ifdef ORMTEXTURE\nmetal*=texture2D(reflectivitySampler,vReflectivityUV).b;roughness*=texture2D(reflectivitySampler,vReflectivityUV).g;\n#endif\n#ifdef METALLIC\nmetal*=metallic;\n#endif\n#ifdef ROUGHNESS\nroughness*=(1.0-glossiness); \n#endif\nreflectivity.a-=roughness;vec3 color=vec3(1.0);\n#ifdef ALBEDOTEXTURE\ncolor=texture2D(albedoSampler,vAlbedoUV).rgb;\n#ifdef GAMMAALBEDO\ncolor=toLinearSpace(color);\n#endif\n#endif\n#ifdef ALBEDOCOLOR\ncolor*=albedoColor.xyz;\n#endif\nreflectivity.rgb=mix(vec3(0.04),color,metal);\n#else\n#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nreflectivity=texture2D(reflectivitySampler,vReflectivityUV);\n#ifdef GAMMAREFLECTIVITYTEXTURE\nreflectivity.rgb=toLinearSpace(reflectivity.rgb);\n#endif\n#else \n#ifdef REFLECTIVITYCOLOR\nreflectivity.rgb=toLinearSpace(reflectivityColor.xyz);reflectivity.a=1.0;\n#endif\n#endif\n#ifdef GLOSSINESSS\nreflectivity.a*=glossiness; \n#endif\n#endif\ngl_FragData[REFLECTIVITY_INDEX]=reflectivity;\n#endif\n}\n";r.l.ShadersStore[o]=a;const l={name:o,shader:a}},75636:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleDiffusePixelShaderWGSL:()=>n});const r="fluidRenderingParticleDiffusePixelShader",s="uniform particleAlpha: f32;varying uv: vec2f;varying diffuseColor: vec3f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var normalxy: vec2f=input.uv*2.0-1.0;var r2: f32=dot(normalxy,normalxy);if (r2>1.0) {discard;}\nfragmentOutputs.color=vec4f(input.diffuseColor,1.0);}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},75679:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingStandardBlurPixelShader:()=>n});const r="fluidRenderingStandardBlurPixelShader",s="uniform sampler2D textureSampler;uniform int filterSize;uniform vec2 blurDir;varying vec2 vUV;void main(void) {vec4 s=textureLod(textureSampler,vUV,0.);if (s.r==0.) {glFragColor=vec4(0.,0.,0.,1.);return;}\nfloat sigma=float(filterSize)/3.0;float twoSigma2=2.0*sigma*sigma;vec4 sum=vec4(0.);float wsum=0.;for (int x=-filterSize; x<=filterSize; ++x) {vec2 coords=vec2(x);vec4 sampl=textureLod(textureSampler,vUV+coords*blurDir,0.);float w=exp(-coords.x*coords.x/twoSigma2);sum+=sampl*w;wsum+=w;}\nsum/=wsum;glFragColor=vec4(sum.rgb,1.);}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},76493:(e,t,i)=>{i.r(t),i.d(t,{lightsFragmentFunctionsWGSL:()=>o});var r=i(69610);i(16601);const s="lightsFragmentFunctions",n="struct lightingInfo\n{diffuse: vec3f,\n#ifdef SPECULARTERM\nspecular: vec3f,\n#endif\n#ifdef NDOTL\nndl: f32,\n#endif\n};fn computeLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32)->lightingInfo {var result: lightingInfo;var lightVectorW: vec3f;var attenuation: f32=1.0;if (lightData.w==0.)\n{var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;var attenuation: f32=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}\nelse\n{lightVectorW=normalize(-lightData.xyz);}\nvar ndl: f32=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvar angleW: vec3f=normalize(viewDirectionW+lightVectorW);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nfn getAttenuation(cosAngle: f32,exponent: f32)->f32 {return max(0.,pow(cosAngle,exponent));}\nfn getIESAttenuation(cosAngle: f32,iesLightTexture: texture_2d<f32>,iesLightTextureSampler: sampler)->f32 {var angle=acos(cosAngle)/PI;return textureSampleLevel(iesLightTexture,iesLightTextureSampler,vec2f(angle,0),0.).r;}\nfn computeBasicSpotLighting(viewDirectionW: vec3f,lightVectorW: vec3f,vNormal: vec3f,attenuation: f32,diffuseColor: vec3f,specularColor: vec3f,glossiness: f32)->lightingInfo {var result: lightingInfo;var ndl: f32=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvar angleW: vec3f=normalize(viewDirectionW+lightVectorW);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nfn computeIESSpotLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,lightDirection: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32,iesLightTexture: texture_2d<f32>,iesLightTextureSampler: sampler)->lightingInfo {var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;var lightVectorW: vec3f=normalize(direction);var attenuation: f32=max(0.,1.0-length(direction)/range);var dotProduct=dot(lightDirection.xyz,-lightVectorW);var cosAngle: f32=max(0.,dotProduct);if (cosAngle>=lightDirection.w)\n{attenuation*=getIESAttenuation(dotProduct,iesLightTexture,iesLightTextureSampler);return computeBasicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}\nvar result: lightingInfo;result.diffuse=vec3f(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3f(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;}\nfn computeSpotLighting(viewDirectionW: vec3f,vNormal: vec3f ,lightData: vec4f,lightDirection: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32)->lightingInfo {var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;var lightVectorW: vec3f=normalize(direction);var attenuation: f32=max(0.,1.0-length(direction)/range);var cosAngle: f32=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)\n{attenuation*=getAttenuation(cosAngle,lightData.w);return computeBasicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}\nvar result: lightingInfo;result.diffuse=vec3f(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3f(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;}\nfn computeHemisphericLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,diffuseColor: vec3f,specularColor: vec3f,groundColor: vec3f,glossiness: f32)->lightingInfo {var result: lightingInfo;var ndl: f32=dot(vNormal,lightData.xyz)*0.5+0.5;\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\nvar angleW: vec3f=normalize(viewDirectionW+lightData.xyz);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;\n#endif\nreturn result;}\nfn computeProjectionTextureDiffuseLighting(projectionLightTexture: texture_2d<f32>,projectionLightSampler: sampler,textureProjectionMatrix: mat4x4f,posW: vec3f)->vec3f {var strq: vec4f=textureProjectionMatrix*vec4f(posW,1.0);strq/=strq.w;var textureColor: vec3f=textureSample(projectionLightTexture,projectionLightSampler,strq.xy).rgb;return textureColor;}\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\n#include<ltcHelperFunctions>\nvar areaLightsLTC1SamplerSampler: sampler;var areaLightsLTC1Sampler: texture_2d<f32>;var areaLightsLTC2SamplerSampler: sampler;var areaLightsLTC2Sampler: texture_2d<f32>;fn computeAreaLighting(ltc1: texture_2d<f32>,ltc1Sampler:sampler,ltc2:texture_2d<f32>,ltc2Sampler:sampler,viewDirectionW: vec3f,vNormal:vec3f,vPosition:vec3f,lightPosition:vec3f,halfWidth:vec3f, halfHeight:vec3f,diffuseColor:vec3f,specularColor:vec3f,roughness:f32 )->lightingInfo\n{var result: lightingInfo;var data: areaLightData=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc1Sampler,ltc2,ltc2Sampler,viewDirectionW,vNormal,vPosition,lightPosition,halfWidth,halfHeight,roughness);\n#ifdef SPECULARTERM\nvar fresnel:vec3f=( specularColor*data.Fresnel.x+( vec3f( 1.0 )-specularColor )*data.Fresnel.y );result.specular+=specularColor*fresnel*data.Specular;\n#endif\nresult.diffuse+=diffuseColor*data.Diffuse;return result;}\n#endif\n";r.l.IncludesShadersStoreWGSL[s]=n;const o={name:s,shader:n}},77930:(e,t,i)=>{i.d(t,{Hi:()=>h,hU:()=>l,sQ:()=>c});var r=i(51137),s=i(21856),n=i(29844);let o=null,a=null;function l(){return o||(o=new Uint8Array),o}function h(){return a||(a=new Float32Array),a}class c extends s.zx{constructor(e){super(),this._subGraph=e}get fftSize(){return(0,n.bO)(this._subGraph,"fftSize")}set fftSize(e){(0,n.Z7)(this._subGraph,"fftSize",e)}get isEnabled(){return null!==(0,n.CA)(this._subGraph)}get minDecibels(){return(0,n.bO)(this._subGraph,"minDecibels")}set minDecibels(e){(0,n.Z7)(this._subGraph,"minDecibels",e)}get maxDecibels(){return(0,n.bO)(this._subGraph,"maxDecibels")}set maxDecibels(e){(0,n.Z7)(this._subGraph,"maxDecibels",e)}get smoothing(){return(0,n.bO)(this._subGraph,"smoothing")}set smoothing(e){(0,n.Z7)(this._subGraph,"smoothing",e)}dispose(){const e=(0,n.CA)(this._subGraph);e&&(this._subGraph.removeSubNode(e),e.dispose())}async enable(){return(0,n.CA)(this._subGraph)||await this._subGraph.createAndAddSubNode("Analyzer"),Promise.resolve()}getByteFrequencyData(){const e=(0,n.CA)(this._subGraph);return e?e.getByteFrequencyData():(r.V.Warn("AudioAnalyzer not enabled"),this.enable(),l())}getFloatFrequencyData(){const e=(0,n.CA)(this._subGraph);return e?e.getFloatFrequencyData():(r.V.Warn("AudioAnalyzer not enabled"),this.enable(),h())}}},78438:(e,t,i)=>{i.r(t),i.d(t,{sharpenPixelShader:()=>n});const r="sharpenPixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform vec2 sharpnessAmounts;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 onePixel=vec2(1.0,1.0)/screenSize;vec4 color=texture2D(textureSampler,vUV);vec4 edgeDetection=texture2D(textureSampler,vUV+onePixel*vec2(0,-1)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1)) -\ncolor*4.0;gl_FragColor=max(vec4(color.rgb*sharpnessAmounts.y,color.a)-(sharpnessAmounts.x*vec4(edgeDetection.rgb,0)),0.);}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},78439:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererMaskerPixelShader:()=>n});const r="meshUVSpaceRendererMaskerPixelShader",s="varying vec2 vUV;void main(void) {gl_FragColor=vec4(1.0,1.0,1.0,1.0);}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},78855:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphSequenceBlock:()=>n});var r=i(56552),s=i(16972);class n extends s.u{constructor(e){super(e),this.config=e,this.executionSignals=[],this.setNumberOfOutputSignals(this.config.outputSignalCount)}_execute(e){for(let t=0;t<this.executionSignals.length;t++)this.executionSignals[t]._activateSignal(e)}setNumberOfOutputSignals(e=1){for(;this.executionSignals.length>e;){const e=this.executionSignals.pop();e&&(e.disconnectFromAll(),this._unregisterSignalOutput(e.name))}for(;this.executionSignals.length<e;)this.executionSignals.push(this._registerSignalOutput(`out_${this.executionSignals.length}`))}getClassName(){return"FlowGraphSequenceBlock"}}(0,r.Y5)("FlowGraphSequenceBlock",n)},79720:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphSwitchBlock:()=>a});var r=i(16972),s=i(4720),n=i(56552),o=i(4686);class a extends r.u{constructor(e){super(e),this.config=e,this.default=this._registerSignalOutput("default"),this._caseToOutputFlow=new Map,this.case=this.registerDataInput("case",s.Vv),(this.config.cases||[]).forEach((e=>{this._caseToOutputFlow.set(e,this._registerSignalOutput(`out_${e}`))}))}_execute(e,t){const i=this.case.getValue(e);let r;r=(0,o.kf)(i)?this._getOutputFlowForCase((0,o.$w)(i)):this._getOutputFlowForCase(i),r?r._activateSignal(e):this.default._activateSignal(e)}addCase(e){this.config.cases.includes(e)||(this.config.cases.push(e),this._caseToOutputFlow.set(e,this._registerSignalOutput(`out_${e}`)))}removeCase(e){if(!this.config.cases.includes(e))return;const t=this.config.cases.indexOf(e);this.config.cases.splice(t,1),this._caseToOutputFlow.delete(e)}_getOutputFlowForCase(e){return this._caseToOutputFlow.get(e)}getClassName(){return"FlowGraphSwitchBlock"}serialize(e){super.serialize(e),e.cases=this.config.cases}}(0,n.Y5)("FlowGraphSwitchBlock",a)},79820:(e,t,i)=>{i.r(t),i.d(t,{passPixelShader:()=>n});const r="passPixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=texture2D(textureSampler,vUV);}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},79831:(e,t,i)=>{i.r(t),i.d(t,{spritesVertexShader:()=>o});var r=i(69610);i(86560),i(34581),i(2215);const s="spritesVertexShader",n="attribute vec4 position;attribute vec2 options;attribute vec2 offsets;attribute vec2 inverts;attribute vec4 cellInfo;attribute vec4 color;uniform mat4 view;uniform mat4 projection;varying vec2 vUV;varying vec4 vColor;\n#include<fogVertexDeclaration>\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 viewPos=(view*vec4(position.xyz,1.0)).xyz; \nvec2 cornerPos;float angle=position.w;vec2 size=vec2(options.x,options.y);vec2 offset=offsets.xy;cornerPos=vec2(offset.x-0.5,offset.y -0.5)*size;vec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;viewPos+=rotatedCorner;gl_Position=projection*vec4(viewPos,1.0); \nvColor=color;vec2 uvOffset=vec2(abs(offset.x-inverts.x),abs(1.0-offset.y-inverts.y));vec2 uvPlace=cellInfo.xy;vec2 uvSize=cellInfo.zw;vUV.x=uvPlace.x+uvSize.x*uvOffset.x;vUV.y=uvPlace.y+uvSize.y*uvOffset.y;\n#ifdef FOG\nvFogDistance=viewPos;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},80234:(e,t,i)=>{i.r(t),i.d(t,{iblScaledLuminancePixelShader:()=>o});var r=i(69610);i(73325);const s="iblScaledLuminancePixelShader",n="precision highp sampler2D;precision highp samplerCube;\n#include<helperFunctions>\nvarying vec2 vUV;\n#ifdef IBL_USE_CUBE_MAP\nuniform samplerCube iblSource;\n#else\nuniform sampler2D iblSource;\n#endif\nuniform int iblWidth;uniform int iblHeight;float fetchLuminance(vec2 coords) {\n#ifdef IBL_USE_CUBE_MAP\nvec3 direction=equirectangularToCubemapDirection(coords);vec3 color=textureCubeLodEXT(iblSource,direction,0.0).rgb;\n#else\nvec3 color=textureLod(iblSource,coords,0.0).rgb;\n#endif\nreturn dot(color,LuminanceEncodeApprox);}\nvoid main(void) {float deform=sin(vUV.y*PI);float luminance=fetchLuminance(vUV);gl_FragColor=vec4(vec3(deform*luminance),1.0);}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},80265:(e,t,i)=>{i.r(t),i.d(t,{highlightsPixelShaderWGSL:()=>n});const r="highlightsPixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;const RGBLuminanceCoefficients: vec3f= vec3f(0.2126,0.7152,0.0722);\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var tex: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);var c: vec3f=tex.rgb;var luma: f32=dot(c.rgb,RGBLuminanceCoefficients);fragmentOutputs.color= vec4f(pow(c, vec3f(25.0-luma*15.0)),tex.a); }";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},80516:(e,t,i)=>{i.d(t,{e:()=>s});var r=i(26846);class s extends r.Ui{constructor(e,t){super(e,t,3)}connect(e){if(!this._connect(e))throw new Error("Connect failed")}disconnect(e){if(!this._disconnect(e))throw new Error("Disconnect failed")}disconnectAll(){if(!this._downstreamNodes)throw new Error("Disconnect failed");const e=this._downstreamNodes.values();for(let t=e.next();!t.done;t=e.next())if(!this._disconnect(t.value))throw new Error("Disconnect failed")}}},80574:(e,t,i)=>{i.r(t),i.d(t,{lineVertexShaderWGSL:()=>o});var r=i(69610);i(44559),i(77029),i(98327),i(6874),i(93226),i(91277),i(85197),i(81482);const s="lineVertexShader",n="#define ADDITIONAL_VERTEX_DECLARATION\n#include<instancesDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\nattribute position: vec3f;attribute normal: vec4f;uniform width: f32;uniform aspectRatio: f32;\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#include<instancesVertex>\nvar worldViewProjection: mat4x4f=scene.viewProjection*finalWorld;var viewPosition: vec4f=worldViewProjection* vec4f(input.position,1.0);var viewPositionNext: vec4f=worldViewProjection* vec4f(input.normal.xyz,1.0);var currentScreen: vec2f=viewPosition.xy/viewPosition.w;var nextScreen: vec2f=viewPositionNext.xy/viewPositionNext.w;currentScreen=vec2f(currentScreen.x*uniforms.aspectRatio,currentScreen.y);nextScreen=vec2f(nextScreen.x*uniforms.aspectRatio,nextScreen.y);var dir: vec2f=normalize(nextScreen-currentScreen);var normalDir: vec2f= vec2f(-dir.y,dir.x);normalDir*=uniforms.width/2.0;normalDir=vec2f(normalDir.x/uniforms.aspectRatio,normalDir.y);var offset: vec4f= vec4f(normalDir*input.normal.w,0.0,0.0);vertexOutputs.position=viewPosition+offset;\n#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nvar worldPos: vec4f=finalWorld*vec4f(input.position,1.0);\n#include<clipPlaneVertex>\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},81438:(e,t,i)=>{var r=i(69610);i(28764),i(96467);const s="defaultUboDeclaration",n="layout(std140,column_major) uniform;uniform Material\n{vec4 diffuseLeftColor;vec4 diffuseRightColor;vec4 opacityParts;vec4 reflectionLeftColor;vec4 reflectionRightColor;vec4 refractionLeftColor;vec4 refractionRightColor;vec4 emissiveLeftColor;vec4 emissiveRightColor;vec2 vDiffuseInfos;vec2 vAmbientInfos;vec2 vOpacityInfos;vec2 vReflectionInfos;vec3 vReflectionPosition;vec3 vReflectionSize;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec2 vSpecularInfos;vec3 vBumpInfos;mat4 diffuseMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 reflectionMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 specularMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;float pointSize;float alphaCutOff;mat4 refractionMatrix;vec4 vRefractionInfos;vec3 vRefractionPosition;vec3 vRefractionSize;vec4 vSpecularColor;vec3 vEmissiveColor;vec4 vDiffuseColor;vec3 vAmbientColor;\n#define ADDITIONAL_UBO_DECLARATION\n};\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";r.l.IncludesShadersStore[s]=n},81448:(e,t,i)=>{i.r(t),i.d(t,{pbrVertexShader:()=>l});var r=i(69610);i(96019);const s="pbrVertexDeclaration",n="uniform mat4 view;uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nmat4 viewProjectionR;\n#endif\n#ifdef ALBEDO\nuniform mat4 albedoMatrix;uniform vec2 vAlbedoInfos;\n#endif\n#ifdef BASEWEIGHT\nuniform mat4 baseWeightMatrix;uniform vec2 vBaseWeightInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;uniform vec4 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;\n#endif\n#ifdef REFLECTIVITY\nuniform vec3 vReflectivityInfos;uniform mat4 reflectivityMatrix;\n#endif\n#ifdef METALLIC_REFLECTANCE\nuniform vec2 vMetallicReflectanceInfos;uniform mat4 metallicReflectanceMatrix;\n#endif\n#ifdef REFLECTANCE\nuniform vec2 vReflectanceInfos;uniform mat4 reflectanceMatrix;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;uniform mat4 microSurfaceSamplerMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform mat4 bumpMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;\n#endif\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform vec4 vClearCoatInfos;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform mat4 clearCoatMatrix;\n#endif\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS\nuniform mat4 clearCoatRoughnessMatrix;\n#endif\n#ifdef CLEARCOAT_BUMP\nuniform vec2 vClearCoatBumpInfos;uniform mat4 clearCoatBumpMatrix;\n#endif\n#ifdef CLEARCOAT_TINT_TEXTURE\nuniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;\n#endif\n#endif\n#ifdef IRIDESCENCE\n#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)\nuniform vec4 vIridescenceInfos;\n#endif\n#ifdef IRIDESCENCE_TEXTURE\nuniform mat4 iridescenceMatrix;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nuniform mat4 iridescenceThicknessMatrix;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#ifdef ANISOTROPIC_TEXTURE\nuniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;\n#endif\n#endif\n#ifdef SHEEN\n#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform vec4 vSheenInfos;\n#endif\n#ifdef SHEEN_TEXTURE\nuniform mat4 sheenMatrix;\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\nuniform mat4 sheenRoughnessMatrix;\n#endif\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\nuniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nuniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nuniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nuniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\nuniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;\n#endif\n#endif\n#ifdef NORMAL\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;\n#else\nuniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;\n#endif\n#endif\n#endif\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;uniform mat4 detailMatrix;\n#endif\n#include<decalVertexDeclaration>\n#define ADDITIONAL_VERTEX_DECLARATION\n";r.l.IncludesShadersStore[s]=n;i(4096),i(94381),i(4980),i(73325),i(69707),i(18959),i(1218),i(78328),i(85136),i(19495),i(56390),i(71636),i(86560),i(47059),i(4662),i(27999),i(90738),i(34581),i(48451),i(15060),i(3298),i(3361),i(65523),i(65438),i(4981),i(41316),i(19440),i(47314),i(16470),i(35687),i(94483),i(2215);const o="pbrVertexShader",a="#define CUSTOM_VERTEX_EXTENSION\nprecision highp float;\n#include<__decl__pbrVertex>\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BASEWEIGHT,_VARYINGNAME_,BaseWeight)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)\n#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\n#ifdef CLEARCOAT\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)\n#endif\nvarying vec3 vPositionW;\n#if DEBUGMODE>0\nvarying vec4 vClipSpacePosition;\n#endif\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#include<harmonicsFunctions>\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef UV2\nvec2 uv2Updated=uv2;\n#endif\n#ifdef VERTEXCOLOR\nvec4 colorUpdated=color;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vPositionW=vec3(worldPos);\n#ifdef PREPASS\n#include<prePassVertex>\n#endif\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\nvEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#if DEBUGMODE>0\nvClipSpacePosition=gl_Position;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2Updated=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2Updated;\n#endif\n#include<uvVariableDeclaration>[3..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BASEWEIGHT,_VARYINGNAME_,BaseWeight,_MATRIXNAME_,baseWeight,_INFONAME_,BaseWeightInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#ifdef CLEARCOAT\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)\n#endif\n#ifdef SHEEN\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)\n#endif\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStore[o]=a;const l={name:o,shader:a}},82187:(e,t,i)=>{i.r(t),i.d(t,{boundingBoxRendererVertexShader:()=>l});var r=i(69610);const s="boundingBoxRendererVertexDeclaration",n="uniform mat4 world;uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\n";r.l.IncludesShadersStore[s]=n;i(66566);const o="boundingBoxRendererVertexShader",a="attribute vec3 position;\n#include<__decl__boundingBoxRendererVertex>\n#ifdef INSTANCES\nattribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#ifdef INSTANCES\nmat4 finalWorld=mat4(world0,world1,world2,world3);vec4 worldPos=finalWorld*vec4(position,1.0);\n#else\nvec4 worldPos=world*vec4(position,1.0);\n#endif\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}\n";r.l.ShadersStore[o]=a;const l={name:o,shader:a}},82365:(e,t,i)=>{i.r(t),i.d(t,{rsmFullGlobalIlluminationPixelShaderWGSL:()=>n});const r="rsmFullGlobalIlluminationPixelShader",s="/**\n* The implementation is a direct application of the formula found in http:\n*/\nvarying vUV: vec2f;uniform rsmLightMatrix: mat4x4f;uniform rsmInfo: vec4f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;var rsmPositionW: texture_2d<f32>;var rsmNormalW: texture_2d<f32>;var rsmFlux: texture_2d<f32>;\n#ifdef TRANSFORM_NORMAL\nuniform invView: mat4x4f;\n#endif\nfn computeIndirect(p: vec3f,n: vec3f)->vec3f {var indirectDiffuse: vec3f= vec3f(0.);var intensity: f32=uniforms.rsmInfo.z;var edgeArtifactCorrection: f32=uniforms.rsmInfo.w;var texRSM: vec4f=uniforms.rsmLightMatrix* vec4f(p,1.);texRSM=vec4f(texRSM.xy/texRSM.w,texRSM.z,texRSM.w);texRSM=vec4f(texRSM.xy*0.5+0.5,texRSM.z,texRSM.w);var width: i32= i32(uniforms.rsmInfo.x);var height: i32= i32(uniforms.rsmInfo.y);for (var j: i32=0; j<height; j++) {for (var i: i32=0; i<width; i++) {var uv=vec2<i32>(i,j);var vplPositionW: vec3f=textureLoad(rsmPositionW,uv,0).xyz;var vplNormalW: vec3f=textureLoad(rsmNormalW,uv,0).xyz*2.0-1.0;var vplFlux: vec3f=textureLoad(rsmFlux,uv,0).rgb;vplPositionW-=vplNormalW*edgeArtifactCorrection; \nvar dist2: f32=dot(vplPositionW-p,vplPositionW-p);indirectDiffuse+=vplFlux*max(0.,dot(n,vplPositionW-p))*max(0.,dot(vplNormalW,p-vplPositionW))/(dist2*dist2);}}\nreturn clamp(indirectDiffuse*intensity,vec3f(0.0),vec3f(1.0));}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var positionW: vec3f=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.vUV).xyz;var normalW: vec3f=textureSample(normalSampler,normalSamplerSampler,fragmentInputs.vUV).xyz;\n#ifdef DECODE_NORMAL\nnormalW=normalW*2.0-1.0;\n#endif\n#ifdef TRANSFORM_NORMAL\nnormalW=(uniforms.invView* vec4f(normalW,0.)).xyz;\n#endif\nfragmentOutputs.color=vec4f(computeIndirect(positionW,normalW),1.0);}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},82704:(e,t,i)=>{i.d(t,{GB:()=>n,Qc:()=>s,lA:()=>o});var r=i(79923);const s={coneInnerAngle:6.28318530718,coneOuterAngle:6.28318530718,coneOuterVolume:0,distanceModel:"linear",maxDistance:1e4,minDistance:1,panningModel:"equalpower",position:r.Pq.Zero(),rolloffFactor:1,rotation:r.Pq.Zero(),rotationQuaternion:new r.PT};function n(e){return e.spatialEnabled||void 0!==e.spatialAutoUpdate||void 0!==e.spatialConeInnerAngle||void 0!==e.spatialConeOuterAngle||void 0!==e.spatialConeOuterVolume||void 0!==e.spatialDistanceModel||void 0!==e.spatialMaxDistance||void 0!==e.spatialMinDistance||void 0!==e.spatialMinUpdateTime||void 0!==e.spatialPanningModel||void 0!==e.spatialPosition||void 0!==e.spatialRolloffFactor||void 0!==e.spatialRotation||void 0!==e.spatialRotationQuaternion}class o{}},82937:(e,t,i)=>{i.r(t),i.d(t,{glowBlurPostProcessPixelShaderWGSL:()=>n});const r="glowBlurPostProcessPixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;uniform direction: vec2f;uniform blurWidth: f32;fn getLuminance(color: vec3f)->f32\n{return dot(color, vec3f(0.2126,0.7152,0.0722));}\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var weights: array<f32 ,7>;weights[0]=0.05;weights[1]=0.1;weights[2]=0.2;weights[3]=0.3;weights[4]=0.2;weights[5]=0.1;weights[6]=0.05;var texelSize: vec2f= vec2f(1.0/uniforms.screenSize.x,1.0/uniforms.screenSize.y);var texelStep: vec2f=texelSize*uniforms.direction*uniforms.blurWidth;var start: vec2f=input.vUV-3.0*texelStep;var baseColor: vec4f= vec4f(0.,0.,0.,0.);var texelOffset: vec2f= vec2f(0.,0.);for (var i: i32=0; i<7; i++)\n{var texel: vec4f=textureSample(textureSampler,textureSamplerSampler,start+texelOffset);baseColor=vec4f(baseColor.rgb,baseColor.a+texel.a*weights[i]);var luminance: f32=getLuminance(baseColor.rgb);var luminanceTexel: f32=getLuminance(texel.rgb);var choice: f32=step(luminanceTexel,luminance);baseColor=vec4f(choice*baseColor.rgb+(1.0-choice)*texel.rgb,baseColor.a);texelOffset+=texelStep;}\nfragmentOutputs.color=baseColor;}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},83020:(e,t,i)=>{i.d(t,{i:()=>a});var r=i(84867);function s(e){return e.split(" ").filter((e=>""!==e)).map((e=>parseFloat(e)))}function n(e,t,i){for(;i.length!==t;){const t=s(e.lines[e.index++]);i.push(...t)}}function o(e,t,i){let s=0,n=0,o=0,a=0,l=0,h=0;for(let t=0;t<e.numberOfHorizontalAngles-1;t++)if(i<e.horizontalAngles[t+1]||t===e.numberOfHorizontalAngles-2){n=t,o=e.horizontalAngles[t],a=e.horizontalAngles[t+1];break}for(let i=0;i<e.numberOfVerticalAngles-1;i++)if(t<e.verticalAngles[i+1]||i===e.numberOfVerticalAngles-2){s=i,l=e.verticalAngles[i],h=e.verticalAngles[i+1];break}const c=a-o,u=h-l;if(0===u)return 0;const d=0===c?0:(i-o)/c,p=(t-l)/u,m=0===c?n:n+1,f=(0,r.Lerp)(e.candelaValues[n][s],e.candelaValues[m][s],d),_=(0,r.Lerp)(e.candelaValues[n][s+1],e.candelaValues[m][s+1],d);return(0,r.Lerp)(f,_,p)}function a(e){const t={lines:new TextDecoder("utf-8").decode(e).split("\n"),index:0},i={version:t.lines[0],candelaValues:[],horizontalAngles:[],verticalAngles:[],numberOfHorizontalAngles:0,numberOfVerticalAngles:0};for(t.index=1;t.lines.length>0&&!t.lines[t.index].includes("TILT=");)t.index++;t.lines[t.index].includes("INCLUDE"),t.index++;const r=s(t.lines[t.index++]);i.numberOfLights=r[0],i.lumensPerLamp=r[1],i.candelaMultiplier=r[2],i.numberOfVerticalAngles=r[3],i.numberOfHorizontalAngles=r[4],i.photometricType=r[5],i.unitsType=r[6],i.width=r[7],i.length=r[8],i.height=r[9];const a=s(t.lines[t.index++]);i.ballastFactor=a[0],i.fileGenerationType=a[1],i.inputWatts=a[2];for(let e=0;e<i.numberOfHorizontalAngles;e++)i.candelaValues[e]=[];n(t,i.numberOfVerticalAngles,i.verticalAngles),n(t,i.numberOfHorizontalAngles,i.horizontalAngles);for(let e=0;e<i.numberOfHorizontalAngles;e++)n(t,i.numberOfVerticalAngles,i.candelaValues[e]);let l=-1;for(let e=0;e<i.numberOfHorizontalAngles;e++)for(let t=0;t<i.numberOfVerticalAngles;t++)i.candelaValues[e][t]*=i.candelaValues[e][t]*i.candelaMultiplier*i.ballastFactor*i.fileGenerationType,l=Math.max(l,i.candelaValues[e][t]);if(l>0)for(let e=0;e<i.numberOfHorizontalAngles;e++)for(let t=0;t<i.numberOfVerticalAngles;t++)i.candelaValues[e][t]/=l;const h=180,c=360,u=new Float32Array(64800),d=i.horizontalAngles[0],p=i.horizontalAngles[i.numberOfHorizontalAngles-1];for(let e=0;e<64800;e++){let t=e%c;const r=Math.floor(e/c);p-d!=0&&(t<d||t>=p)&&(t%=2*p,t>p&&(t=2*p-t)),u[r+t*h]=o(i,r,t)}return{width:180,height:1,data:u}}},83153:(e,t,i)=>{i.r(t),i.d(t,{imageProcessingPixelShader:()=>o});var r=i(69610);i(89392),i(73325),i(64017);const s="imageProcessingPixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;\n#include<imageProcessingDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 result=texture2D(textureSampler,vUV);\n#ifdef IMAGEPROCESSING\n#ifndef FROMLINEARSPACE\nresult.rgb=toLinearSpace(result.rgb);\n#endif\nresult=applyImageProcessing(result);\n#else\n#ifdef FROMLINEARSPACE\nresult=applyImageProcessing(result);\n#endif\n#endif\ngl_FragColor=result;}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},83234:(e,t,i)=>{i.r(t),i.d(t,{glowMapGenerationPixelShader:()=>o});var r=i(69610);i(73325),i(6194),i(7412);const s="glowMapGenerationPixelShader",n="#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)\n#include<helperFunctions>\n#endif\n#ifdef DIFFUSE\nvarying vec2 vUVDiffuse;uniform sampler2D diffuseSampler;\n#endif\n#ifdef OPACITY\nvarying vec2 vUVOpacity;uniform sampler2D opacitySampler;uniform float opacityIntensity;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;uniform sampler2D emissiveSampler;\n#endif\n#ifdef VERTEXALPHA\nvarying vec4 vColor;\n#endif\nuniform vec4 glowColor;uniform float glowIntensity;\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\nvec4 finalColor=glowColor;\n#ifdef DIFFUSE\nvec4 albedoTexture=texture2D(diffuseSampler,vUVDiffuse);\n#ifdef DIFFUSE_ISLINEAR\nalbedoTexture=toGammaSpace(albedoTexture);\n#endif\n#ifdef GLOW\nfinalColor.a*=albedoTexture.a;\n#endif\n#ifdef HIGHLIGHT\nfinalColor.a=albedoTexture.a;\n#endif\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vUVOpacity);\n#ifdef OPACITYRGB\nfinalColor.a*=getLuminance(opacityMap.rgb);\n#else\nfinalColor.a*=opacityMap.a;\n#endif\nfinalColor.a*=opacityIntensity;\n#endif\n#ifdef VERTEXALPHA\nfinalColor.a*=vColor.a;\n#endif\n#ifdef ALPHATEST\nif (finalColor.a<ALPHATESTVALUE)\ndiscard;\n#endif\n#ifdef EMISSIVE\nvec4 emissive=texture2D(emissiveSampler,vUVEmissive);\n#ifdef EMISSIVE_ISLINEAR\nemissive=toGammaSpace(emissive);\n#endif\ngl_FragColor=emissive*finalColor*glowIntensity;\n#else\ngl_FragColor=finalColor*glowIntensity;\n#endif\n#ifdef HIGHLIGHT\ngl_FragColor.a=glowColor.a;\n#endif\n}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},83802:(e,t,i)=>{i.r(t),i.d(t,{kernelBlurVertexShader:()=>l});var r=i(69610);i(17382);const s="kernelBlurVertex",n="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";r.l.IncludesShadersStore[s]=n;const o="kernelBlurVertexShader",a="attribute vec2 position;uniform vec2 delta;varying vec2 sampleCenter;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nsampleCenter=(position*madd+madd);\n#include<kernelBlurVertex>[0..varyingCount]\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStore[o]=a;const l={name:o,shader:a}},84237:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelGrid3dDebugPixelShaderWGSL:()=>n});const r="iblVoxelGrid3dDebugPixelShader",s="varying vUV: vec2f;var voxelTextureSampler: sampler;var voxelTexture: texture_3d<f32>;var voxelSlabTextureSampler: sampler;var voxelSlabTexture: texture_2d<f32>;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform sizeParams: vec4f;\n#define offsetX uniforms.sizeParams.x\n#define offsetY uniforms.sizeParams.y\n#define widthScale uniforms.sizeParams.z\n#define heightScale uniforms.sizeParams.w\nuniform mipNumber: f32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f =\nvec2f((offsetX+input.vUV.x)*widthScale,(offsetY+input.vUV.y)*heightScale);var background: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);var voxelSlab: vec4f=textureSample(voxelSlabTexture,voxelSlabTextureSampler,input.vUV);var size: vec3u=textureDimensions(voxelTexture, i32(uniforms.mipNumber));var dimension: f32=ceil(sqrt( f32(size.z)));var samplePos: vec2f=fract(uv.xy* vec2f(dimension));var sampleIndex: u32= u32(floor(uv.x* f32(dimension)) +\nfloor(uv.y* f32(dimension))*dimension);var mip_separator: f32=0.0;if (samplePos.x<0.01 || samplePos.y<0.01) {mip_separator=1.0;}\nvar outBounds: bool=select(false,true,sampleIndex>size.z-1);sampleIndex=clamp(sampleIndex,0,size.z-1);var samplePosInt: vec2i= vec2i(samplePos.xy* vec2f(size.xy));var voxel: vec3f=textureLoad(voxelTexture,\nvec3i(i32(samplePosInt.x),i32(samplePosInt.y),i32(sampleIndex)),\ni32(uniforms.mipNumber)).rgb;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {fragmentOutputs.color=background;} else {if (outBounds) {voxel= vec3f(0.15,0.0,0.0);} else {if (voxel.r>0.001) {voxel.g=1.0;}\nvoxel.r+=mip_separator;}\nfragmentOutputs.color=vec4f(mix(background.rgb,voxelSlab.rgb,voxelSlab.a)+voxel,1.0);}}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},84556:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleThicknessPixelShaderWGSL:()=>n});const r="fluidRenderingParticleThicknessPixelShader",s="uniform particleAlpha: f32;varying uv: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var normalxy: vec2f=input.uv*2.0-1.0;var r2: f32=dot(normalxy,normalxy);if (r2>1.0) {discard;}\nvar thickness: f32=sqrt(1.0-r2);fragmentOutputs.color=vec4f(vec3f(uniforms.particleAlpha*thickness),1.0);}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},84679:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphDoNBlock:()=>a});var r=i(4720),s=i(33006),n=i(56552),o=i(90868);class a extends s.w{constructor(e={}){super(e),this.config=e,this.config.startIndex=e.startIndex??new o.P(0),this.reset=this._registerSignalInput("reset"),this.maxExecutions=this.registerDataInput("maxExecutions",r.x2),this.executionCount=this.registerDataOutput("executionCount",r.x2,new o.P(0))}_execute(e,t){if(t===this.reset)this.executionCount.setValue(this.config.startIndex,e);else{const t=this.executionCount.getValue(e);t.value<this.maxExecutions.getValue(e).value&&(this.executionCount.setValue(new o.P(t.value+1),e),this.out._activateSignal(e))}}getClassName(){return"FlowGraphDoNBlock"}}(0,n.Y5)("FlowGraphDoNBlock",a)},84710:(e,t,i)=>{i.r(t),i.d(t,{greasedLinePixelShader:()=>n});const r="greasedLinePixelShader",s="precision highp float;uniform sampler2D grlColors;uniform float grlUseColors;uniform float grlUseDash;uniform float grlDashArray;uniform float grlDashOffset;uniform float grlDashRatio;uniform float grlVisibility;uniform float grlColorsWidth;uniform vec2 grl_colorModeAndColorDistributionType;uniform vec3 grlColor;varying float grlCounters;varying float grlColorPointer;void main() {float grlColorMode=grl_colorModeAndColorDistributionType.x;float grlColorDistributionType=grl_colorModeAndColorDistributionType.y;gl_FragColor=vec4(grlColor,1.);gl_FragColor.a=step(grlCounters,grlVisibility);if (gl_FragColor.a==0.) discard;if( grlUseDash==1. ){gl_FragColor.a=ceil(mod(grlCounters+grlDashOffset,grlDashArray)-(grlDashArray*grlDashRatio));if (gl_FragColor.a==0.) discard;}\nif (grlUseColors==1.) {vec4 textureColor;if (grlColorDistributionType==COLOR_DISTRIBUTION_TYPE_LINE) { \ntextureColor=texture2D(grlColors,vec2(grlCounters,0.),0.);} else {textureColor=texture2D(grlColors,vec2(grlColorPointer/grlColorsWidth,0.),0.);}\nif (grlColorMode==COLOR_MODE_SET) {gl_FragColor=textureColor;} else if (grlColorMode==COLOR_MODE_ADD) {gl_FragColor+=textureColor;} else if (grlColorMode==COLOR_MODE_MULTIPLY) {gl_FragColor*=textureColor;}}}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},84935:(e,t,i)=>{i.r(t),i.d(t,{colorVertexShaderWGSL:()=>o});var r=i(69610);i(32806),i(98900),i(77029),i(75757),i(44559),i(91277),i(65470),i(40242),i(85197),i(59013),i(820);const s="colorVertexShader",n="attribute position: vec3f;\n#ifdef VERTEXCOLOR\nattribute color: vec4f;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#ifdef FOG\nuniform view: mat4x4f;\n#endif\n#include<instancesDeclaration>\nuniform viewProjection: mat4x4f;\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vColor: vec4f;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#ifdef VERTEXCOLOR\nvar colorUpdated: vec4f=vertexInputs.color;\n#endif\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(input.position,1.0);vertexOutputs.position=uniforms.viewProjection*worldPos;\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<vertexColorMixing>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},85035:(e,t,i)=>{i.r(t),i.d(t,{rgbdEncodePixelShaderWGSL:()=>o});var r=i(69610);i(79702);const s="rgbdEncodePixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=toRGBD(textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb);}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},85257:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelSlabDebugPixelShader:()=>n});const r="iblVoxelSlabDebugPixelShader",s="precision highp float;varying vec3 vNormalizedPosition;uniform float nearPlane;uniform float farPlane;uniform float stepSize;void main(void) {vec3 normPos=vNormalizedPosition.xyz;float chunkSize=stepSize*float(MAX_DRAW_BUFFERS);float numChunks=1.0/chunkSize;float positionInChunk=fract(normPos.z/chunkSize);float slab=floor(positionInChunk*float(MAX_DRAW_BUFFERS)) /\nfloat(MAX_DRAW_BUFFERS);if (normPos.x<0.0 || normPos.y<0.0 || normPos.z<0.0 ||\nnormPos.x>1.0 || normPos.y>1.0 || normPos.z>1.0) {gl_FragColor=vec4(0.0,0.0,0.0,0.0);} else {gl_FragColor=vec4(slab,0.0,0.0,0.75);}}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},85264:(e,t,i)=>{i.r(t),i.d(t,{linePixelShaderWGSL:()=>o});var r=i(69610);i(39759),i(93226),i(38780),i(97715);const s="linePixelShader",n="#include<clipPlaneFragmentDeclaration>\nuniform color: vec4f;\n#include<logDepthDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<logDepthFragment>\n#include<clipPlaneFragment>\nfragmentOutputs.color=uniforms.color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},85363:(e,t,i)=>{i.r(t),i.d(t,{ssao2PixelShader:()=>n});const r="ssao2PixelShader",s="precision highp float;uniform sampler2D textureSampler;varying vec2 vUV;\n#ifdef SSAO\nfloat scales[16]=float[16](\n0.1,\n0.11406250000000001,\n0.131640625,\n0.15625,\n0.187890625,\n0.2265625,\n0.272265625,\n0.325,\n0.384765625,\n0.4515625,\n0.525390625,\n0.60625,\n0.694140625,\n0.7890625,\n0.891015625,\n1.0\n);uniform float near;uniform float radius;uniform sampler2D depthSampler;uniform sampler2D randomSampler;uniform sampler2D normalSampler;uniform float randTextureTiles;uniform float samplesFactor;uniform vec3 sampleSphere[SAMPLES];uniform float totalStrength;uniform float base;uniform float xViewport;uniform float yViewport;uniform mat3 depthProjection;uniform float maxZ;uniform float minZAspect;uniform vec2 texelSize;uniform mat4 projection;void main()\n{vec3 random=textureLod(randomSampler,vUV*randTextureTiles,0.0).rgb;float depth=textureLod(depthSampler,vUV,0.0).r;float depthSign=sign(depth);depth=depth*depthSign;vec3 normal=textureLod(normalSampler,vUV,0.0).rgb;float occlusion=0.0;float correctedRadius=min(radius,minZAspect*depth/near);vec3 vViewRay=vec3((vUV.x*2.0-1.0)*xViewport,(vUV.y*2.0-1.0)*yViewport,depthSign);vec3 vDepthFactor=depthProjection*vec3(1.0,1.0,depth);vec3 origin=vViewRay*vDepthFactor;vec3 rvec=random*2.0-1.0;rvec.z=0.0;float dotProduct=dot(rvec,normal);rvec=1.0-abs(dotProduct)>1e-2 ? rvec : vec3(-rvec.y,0.0,rvec.x);vec3 tangent=normalize(rvec-normal*dot(rvec,normal));vec3 bitangent=cross(normal,tangent);mat3 tbn=mat3(tangent,bitangent,normal);float difference;for (int i=0; i<SAMPLES; ++i) {vec3 samplePosition=scales[(i+int(random.x*16.0)) % 16]*tbn*sampleSphere[(i+int(random.y*16.0)) % 16];samplePosition=samplePosition*correctedRadius+origin;vec4 offset=vec4(samplePosition,1.0);offset=projection*offset;offset.xyz/=offset.w;offset.xy=offset.xy*0.5+0.5;if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {continue;}\nfloat sampleDepth=abs(textureLod(depthSampler,offset.xy,0.0).r);difference=depthSign*samplePosition.z-sampleDepth;float rangeCheck=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);occlusion+=step(EPSILON,difference)*rangeCheck;}\nocclusion=occlusion*(1.0-smoothstep(maxZ*0.75,maxZ,depth));float ao=1.0-totalStrength*occlusion*samplesFactor;float result=clamp(ao+base,0.0,1.0);gl_FragColor=vec4(vec3(result),1.0);}\n#endif\n#ifdef BLUR\nuniform float outSize;uniform float soften;uniform float tolerance;uniform int samples;\n#ifndef BLUR_BYPASS\nuniform sampler2D depthSampler;\n#ifdef BLUR_LEGACY\n#define inline\nfloat blur13Bilateral(sampler2D image,vec2 uv,vec2 step) {float result=0.0;vec2 off1=vec2(1.411764705882353)*step;vec2 off2=vec2(3.2941176470588234)*step;vec2 off3=vec2(5.176470588235294)*step;float compareDepth=abs(textureLod(depthSampler,uv,0.0).r);float sampleDepth;float weight;float weightSum=30.0;result+=textureLod(image,uv,0.0).r*30.0;sampleDepth=abs(textureLod(depthSampler,uv+off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv+off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv-off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off3,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off3,0.0).r*weight;return result/weightSum;}\n#endif\n#endif\nvoid main()\n{float result=0.0;\n#ifdef BLUR_BYPASS\nresult=textureLod(textureSampler,vUV,0.0).r;\n#else\n#ifdef BLUR_H\nvec2 step=vec2(1.0/outSize,0.0);\n#else\nvec2 step=vec2(0.0,1.0/outSize);\n#endif\n#ifdef BLUR_LEGACY\nresult=blur13Bilateral(textureSampler,vUV,step);\n#else\nfloat compareDepth=abs(textureLod(depthSampler,vUV,0.0).r);float weightSum=0.0;for (int i=-samples; i<samples; i+=2)\n{vec2 samplePos=vUV+step*(float(i)+0.5);float sampleDepth=abs(textureLod(depthSampler,samplePos,0.0).r);float falloff=smoothstep(0.0,\nfloat(samples),\nfloat(samples)-abs(float(i))*soften);float minDivider=tolerance*0.5+0.003;float weight=falloff/( minDivider+abs(compareDepth-sampleDepth));result+=textureLod(textureSampler,samplePos,0.0).r*weight;weightSum+=weight;}\nresult/=weightSum;\n#endif\n#endif\ngl_FragColor.rgb=vec3(result);gl_FragColor.a=1.0;}\n#endif\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},85417:(e,t,i)=>{i.r(t),i.d(t,{kernelBlurVertexShaderWGSL:()=>l});var r=i(69610);i(52383);const s="kernelBlurVertex",n="vertexOutputs.sampleCoord{X}=vertexOutputs.sampleCenter+uniforms.delta*KERNEL_OFFSET{X};";r.l.IncludesShadersStoreWGSL[s]=n;const o="kernelBlurVertexShader",a="attribute position: vec2f;uniform delta: vec2f;varying sampleCenter: vec2f;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {const madd: vec2f= vec2f(0.5,0.5);\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.sampleCenter=(input.position*madd+madd);\n#include<kernelBlurVertex>[0..varyingCount]\nvertexOutputs.position= vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStoreWGSL[o]=a;const l={name:o,shader:a}},85423:(e,t,i)=>{i.r(t),i.d(t,{screenSpaceReflection2PixelShaderWGSL:()=>o});var r=i(69610);i(79702),i(75052),i(95228);const s="screenSpaceReflection2PixelShader",n="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;varying vUV: vec2f;\n#ifdef SSR_SUPPORTED\nvar reflectivitySamplerSampler: sampler;var reflectivitySampler: texture_2d<f32>;var normalSampler: texture_2d<f32>;var depthSampler: texture_2d<f32>;\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nvar backDepthSampler: texture_2d<f32>;uniform backSizeFactor: f32;\n#endif\n#ifdef SSR_USE_ENVIRONMENT_CUBE\nvar envCubeSamplerSampler: sampler;var envCubeSampler: texture_cube<f32>;\n#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC\nuniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;\n#endif\n#endif\nuniform view: mat4x4f;uniform invView: mat4x4f;uniform projection: mat4x4f;uniform invProjectionMatrix: mat4x4f;uniform projectionPixel: mat4x4f;uniform nearPlaneZ: f32;uniform farPlaneZ: f32;uniform stepSize: f32;uniform maxSteps: f32;uniform strength: f32;uniform thickness: f32;uniform roughnessFactor: f32;uniform reflectionSpecularFalloffExponent: f32;uniform maxDistance: f32;uniform selfCollisionNumSkip: f32;uniform reflectivityThreshold: f32;\n#include<helperFunctions>\n#include<pbrBRDFFunctions>\n#include<screenSpaceRayTrace>\nfn hash(a: vec3f)->vec3f\n{var result=fract(a*0.8);result+=dot(result,result.yxz+19.19);return fract((result.xxy+result.yxx)*result.zyx);}\nfn computeAttenuationForIntersection(ihitPixel: vec2f,hitUV: vec2f,vsRayOrigin: vec3f,vsHitPoint: vec3f,reflectionVector: vec3f,maxRayDistance: f32,numIterations: f32)->f32 {var attenuation: f32=1.0;\n#ifdef SSR_ATTENUATE_SCREEN_BORDERS\nvar dCoords: vec2f=smoothstep(vec2f(0.2),vec2f(0.6),abs( vec2f(0.5,0.5)-hitUV.xy));attenuation*=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);\n#endif\n#ifdef SSR_ATTENUATE_INTERSECTION_DISTANCE\nattenuation*=1.0-clamp(distance(vsRayOrigin,vsHitPoint)/maxRayDistance,0.0,1.0);\n#endif\n#ifdef SSR_ATTENUATE_INTERSECTION_NUMITERATIONS\nattenuation*=1.0-(numIterations/uniforms.maxSteps);\n#endif\n#ifdef SSR_ATTENUATE_BACKFACE_REFLECTION\nvar reflectionNormal: vec3f=texelFetch(normalSampler,hitPixel,0).xyz;var directionBasedAttenuation: f32=smoothstep(-0.17,0.0,dot(reflectionNormal,-reflectionVector));attenuation*=directionBasedAttenuation;\n#endif\nreturn attenuation;}\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#ifdef SSR_SUPPORTED\nvar colorFull: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var color: vec3f=colorFull.rgb;var reflectivity: vec4f=textureSampleLevel(reflectivitySampler,reflectivitySamplerSampler,input.vUV,0.0);\n#ifndef SSR_DISABLE_REFLECTIVITY_TEST\nif (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=uniforms.reflectivityThreshold) {\n#ifdef SSR_USE_BLUR\nfragmentOutputs.color= vec4f(0.);\n#else\nfragmentOutputs.color=colorFull;\n#endif\nreturn fragmentOutputs;}\n#endif\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\ncolor=toLinearSpaceVec3(color);\n#endif\nvar texSize: vec2f= vec2f(textureDimensions(depthSampler,0));var csNormal: vec3f=textureLoad(normalSampler,vec2<i32>(input.vUV*texSize),0).xyz; \n#ifdef SSR_DECODE_NORMAL\ncsNormal=csNormal*2.0-1.0;\n#endif\n#ifdef SSR_NORMAL_IS_IN_WORLDSPACE\ncsNormal=(uniforms.view* vec4f(csNormal,0.0)).xyz;\n#endif\nvar depth: f32=textureLoad(depthSampler,vec2<i32>(input.vUV*texSize),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\ndepth=linearizeDepth(depth,uniforms.nearPlaneZ,uniforms.farPlaneZ);\n#endif\nvar csPosition: vec3f=computeViewPosFromUVDepth(input.vUV,depth,uniforms.projection,uniforms.invProjectionMatrix);\n#ifdef ORTHOGRAPHIC_CAMERA\nvar csViewDirection: vec3f= vec3f(0.,0.,1.);\n#else\nvar csViewDirection: vec3f=normalize(csPosition);\n#endif\nvar csReflectedVector: vec3f=reflect(csViewDirection,csNormal);\n#ifdef SSR_USE_ENVIRONMENT_CUBE\nvar wReflectedVector: vec3f=(uniforms.invView* vec4f(csReflectedVector,0.0)).xyz;\n#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC\nvar worldPos: vec4f=uniforms.invView* vec4f(csPosition,1.0);wReflectedVector=parallaxCorrectNormal(worldPos.xyz,normalize(wReflectedVector),uniforms.vReflectionSize,uniforms.vReflectionPosition);\n#endif\n#ifdef SSR_INVERTCUBICMAP\nwReflectedVector.y*=-1.0;\n#endif\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nwReflectedVector.z*=-1.0;\n#endif\nvar envColor: vec3f=textureSampleLevel(envCubeSampler,envCubeSamplerSampler,wReflectedVector,0.0).xyz;\n#ifdef SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE\nenvColor=toLinearSpaceVec3(envColor);\n#endif\n#else\nvar envColor: vec3f=color;\n#endif\nvar reflectionAttenuation: f32=1.0;var rayHasHit: bool=false;var startPixel: vec2f;var hitPixel: vec2f;var hitPoint: vec3f;var numIterations: f32;\n#ifdef SSRAYTRACE_DEBUG\nvar debugColor: vec3f;\n#endif\n#ifdef SSR_ATTENUATE_FACING_CAMERA\nreflectionAttenuation*=1.0-smoothstep(0.25,0.5,dot(-csViewDirection,csReflectedVector));\n#endif\nif (reflectionAttenuation>0.0) {\n#ifdef SSR_USE_BLUR\nvar jitt: vec3f= vec3f(0.);\n#else\nvar roughness: f32=1.0-reflectivity.a;var jitt: vec3f=mix( vec3f(0.0),hash(csPosition)- vec3f(0.5),roughness)*uniforms.roughnessFactor; \n#endif\nvar uv2: vec2f=input.vUV*texSize;var c: f32=(uv2.x+uv2.y)*0.25;var jitter: f32=((c)%(1.0)); \nrayHasHit=traceScreenSpaceRay1(\ncsPosition,\nnormalize(csReflectedVector+jitt),\nuniforms.projectionPixel,\ndepthSampler,\ntexSize,\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nbackDepthSampler,\nuniforms.backSizeFactor,\n#endif\nuniforms.thickness,\nuniforms.nearPlaneZ,\nuniforms.farPlaneZ,\nuniforms.stepSize,\njitter,\nuniforms.maxSteps,\nuniforms.maxDistance,\nuniforms.selfCollisionNumSkip,\n&startPixel,\n&hitPixel,\n&hitPoint,\n&numIterations\n#ifdef SSRAYTRACE_DEBUG\n,&debugColor\n#endif\n);}\n#ifdef SSRAYTRACE_DEBUG\nfragmentOutputs.color= vec4f(debugColor,1.);return fragmentOutputs;\n#endif\nvar F0: vec3f=reflectivity.rgb;var fresnel: vec3f=fresnelSchlickGGXVec3(max(dot(csNormal,-csViewDirection),0.0),F0, vec3f(1.));var SSR: vec3f=envColor;if (rayHasHit) {var reflectedColor: vec3f=textureLoad(textureSampler,vec2<i32>(hitPixel),0).rgb;\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\nreflectedColor=toLinearSpaceVec3(reflectedColor);\n#endif\nreflectionAttenuation*=computeAttenuationForIntersection(hitPixel,hitPixel/texSize,csPosition,hitPoint,csReflectedVector,uniforms.maxDistance,numIterations);SSR=reflectedColor*reflectionAttenuation+(1.0-reflectionAttenuation)*envColor;}\n#ifndef SSR_BLEND_WITH_FRESNEL\nSSR*=fresnel;\n#endif\n#ifdef SSR_USE_BLUR\nvar blur_radius: f32=0.0;var roughness: f32=1.0-reflectivity.a*(1.0-uniforms.roughnessFactor);if (roughness>0.001) {var cone_angle: f32=min(roughness,0.999)*3.14159265*0.5;var cone_len: f32=distance(startPixel,hitPixel);var op_len: f32=2.0*tan(cone_angle)*cone_len; \nvar a: f32=op_len;var h: f32=cone_len;var a2: f32=a*a;var fh2: f32=4.0f*h*h;blur_radius=(a*(sqrt(a2+fh2)-a))/(4.0f*h);}\nfragmentOutputs.color= vec4f(SSR,blur_radius/255.0); \n#else\n#ifdef SSR_BLEND_WITH_FRESNEL\nvar reflectionMultiplier: vec3f=clamp(pow(fresnel*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));\n#else\nvar reflectionMultiplier: vec3f=clamp(pow(reflectivity.rgb*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));\n#endif\nvar colorMultiplier: vec3f=1.0-reflectionMultiplier;var finalColor: vec3f=(color*colorMultiplier)+(SSR*reflectionMultiplier);\n#ifdef SSR_OUTPUT_IS_GAMMA_SPACE\nfinalColor=toGammaSpaceVec3(finalColor);\n#endif\nfragmentOutputs.color= vec4f(finalColor,colorFull.a);\n#endif\n#else\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);\n#endif\n}\n";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},85426:(e,t,i)=>{i.r(t),i.d(t,{shadowMapFragmentSoftTransparentShadow:()=>n});const r="shadowMapFragmentSoftTransparentShadow",s="#if SM_SOFTTRANSPARENTSHADOW==1\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x*alpha) discard;\n#endif\n";i(69610).l.IncludesShadersStore[r]=s;const n={name:r,shader:s}},85520:(e,t,i)=>{i.r(t),i.d(t,{outlineVertexShaderWGSL:()=>o});var r=i(69610);i(32806),i(98900),i(76340),i(8217),i(77029),i(44559),i(93226),i(18258),i(9129),i(91277),i(65470),i(40242),i(85197),i(81482);const s="outlineVertexShader",n="attribute position: vec3f;attribute normal: vec3f;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\nuniform offset: f32;\n#include<instancesDeclaration>\nuniform viewProjection: mat4x4f;\n#ifdef ALPHATEST\nvarying vUV: vec2f;uniform diffuseMatrix: mat4x4f; \n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input: VertexInputs)->FragmentInputs {var positionUpdated: vec3f=vertexInputs.position;var normalUpdated: vec3f=vertexInputs.normal;\n#ifdef UV1\nvar uvUpdated: vec2f=vertexInputs.uv;\n#endif\n#ifdef UV2\nvar uv2Updated: vec2f=vertexInputs.uv2;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\nvar offsetPosition: vec3f=positionUpdated+(normalUpdated*uniforms.offset);\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld*vec4f(offsetPosition,1.0);vertexOutputs.position=uniforms.viewProjection*worldPos;\n#ifdef ALPHATEST\n#ifdef UV1\nvertexOutputs.vUV=(uniforms.diffuseMatrix*vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef UV2\nvertexOutputs.vUV=(uniforms.diffuseMatrix*vec4f(uv2Updated,1.0,0.0)).xy;\n#endif\n#endif\n#include<clipPlaneVertex>\n#include<logDepthVertex>\n}\n";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},86100:(e,t,i)=>{i.d(t,{l:()=>s});var r=i(79923);class s{constructor(e){this._attachmentType=3,this._position=new r.Pq,this._rotationQuaternion=new r.PT,this._sceneNode=null,this._useBoundingBox=!1,this.dispose=()=>{this.detach()},this._spatialAudioNode=e}get isAttached(){return null!==this._sceneNode}attach(e,t,i){this._sceneNode!==e&&(this.detach(),e&&(this._attachmentType=i,this._sceneNode=e,this._sceneNode.onDisposeObservable.add(this.dispose),this._useBoundingBox=t))}detach(){this._sceneNode?.onDisposeObservable.removeCallback(this.dispose),this._sceneNode=null}update(){1&this._attachmentType&&(this._useBoundingBox&&this._sceneNode.getBoundingInfo?this._position.copyFrom(this._sceneNode.getBoundingInfo().boundingBox.centerWorld):this._sceneNode?.getWorldMatrix().getTranslationToRef(this._position),this._spatialAudioNode.position.copyFrom(this._position),this._spatialAudioNode._updatePosition()),2&this._attachmentType&&(this._sceneNode?.getWorldMatrix().decompose(void 0,this._rotationQuaternion),this._spatialAudioNode.rotationQuaternion.copyFrom(this._rotationQuaternion),this._spatialAudioNode._updateRotation())}}},86109:(e,t,i)=>{i.r(t),i.d(t,{hdrFilteringVertexShader:()=>n});const r="hdrFilteringVertexShader",s="attribute vec2 position;varying vec3 direction;uniform vec3 up;uniform vec3 right;uniform vec3 front;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nmat3 view=mat3(up,right,front);direction=view*vec3(position,1.0);gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},86722:(e,t,i)=>{var r=i(69610);i(28764);const s="backgroundUboDeclaration",n="layout(std140,column_major) uniform;uniform Material\n{uniform vec4 vPrimaryColor;uniform vec4 vPrimaryColorShadow;uniform vec2 vDiffuseInfos;uniform vec2 vReflectionInfos;uniform mat4 diffuseMatrix;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;uniform float pointSize;uniform float shadowLevel;uniform float alpha;uniform vec3 vBackgroundCenter;uniform vec4 vReflectionControl;uniform vec2 projectedGroundInfos;};\n#include<sceneUboDeclaration>\n";r.l.IncludesShadersStore[s]=n},86951:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphPointerOverEventBlock:()=>a});var r=i(22086),s=i(4720),n=i(56552),o=i(4686);class a extends r.i{constructor(e){super(e),this.type="PointerOver",this.pointerId=this.registerDataOutput("pointerId",s.Es),this.targetMesh=this.registerDataInput("targetMesh",s.Vv,e?.targetMesh),this.meshUnderPointer=this.registerDataOutput("meshUnderPointer",s.Vv)}_executeEvent(e,t){const i=this.targetMesh.getValue(e);this.meshUnderPointer.setValue(t.mesh,e);const r=t.out&&(0,o.rC)(t.out,i);return this.pointerId.setValue(t.pointerId,e),!(!r&&(t.mesh===i||(0,o.rC)(t.mesh,i)))||(this._execute(e),!this.config?.stopPropagation)}_preparePendingTasks(e){}_cancelPendingTasks(e){}getClassName(){return"FlowGraphPointerOverEventBlock"}}(0,n.Y5)("FlowGraphPointerOverEventBlock",a)},87428:(e,t,i)=>{i.r(t),i.d(t,{shadowMapPixelShaderWGSL:()=>c});var r=i(69610);i(5543);const s="bayerDitherFunctions",n="fn bayerDither2(_P: vec2f)->f32 {return ((2.0*_P.y+_P.x+1.0)%(4.0));}\nfn bayerDither4(_P: vec2f)->f32 {var P1: vec2f=((_P)%(2.0)); \nvar P2: vec2f=floor(0.5*((_P)%(4.0))); \nreturn 4.0*bayerDither2(P1)+bayerDither2(P2);}\nfn bayerDither8(_P: vec2f)->f32 {var P1: vec2f=((_P)%(2.0)); \nvar P2: vec2f=floor(0.5 *((_P)%(4.0))); \nvar P4: vec2f=floor(0.25*((_P)%(8.0))); \nreturn 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}\n";r.l.IncludesShadersStoreWGSL[s]=n;const o="shadowMapFragmentExtraDeclaration",a="#if SM_FLOAT==0\n#include<packingFunctions>\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#include<bayerDitherFunctions>\nuniform softTransparentShadowSM: vec2f;\n#endif\nvarying vDepthMetricSM: f32;\n#if SM_USEDISTANCE==1\nuniform lightDataSM: vec3f;varying vPositionWSM: vec3f;\n#endif\nuniform biasAndScaleSM: vec3f;uniform depthValuesSM: vec2f;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying zSM: f32;\n#endif\n";r.l.IncludesShadersStoreWGSL[o]=a;i(39759),i(97715),i(89273);const l="shadowMapPixelShader",h="#include<shadowMapFragmentExtraDeclaration>\n#ifdef ALPHATEXTURE\nvarying vUV: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#include<clipPlaneFragment>\n#ifdef ALPHATEXTURE\nvar opacityMap: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vUV);var alphaFromAlphaTexture: f32=opacityMap.a;\n#if SM_SOFTTRANSPARENTSHADOW==1\nif (uniforms.softTransparentShadowSM.y==1.0) {opacityMap=vec4f(opacityMap.rgb* vec3f(0.3,0.59,0.11),opacityMap.a);alphaFromAlphaTexture=opacityMap.x+opacityMap.y+opacityMap.z;}\n#endif\n#ifdef ALPHATESTVALUE\nif (alphaFromAlphaTexture<ALPHATESTVALUE) {discard;}\n#endif\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#ifdef ALPHATEXTURE\nif ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x*alphaFromAlphaTexture) {discard;}\n#else\nif ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x) {discard;} \n#endif\n#endif\n#include<shadowMapFragment>\n}";r.l.ShadersStoreWGSL[l]=h;const c={name:l,shader:h}},87554:(e,t,i)=>{i.r(t),i.d(t,{spritesPixelShader:()=>l});var r=i(69610);i(7806),i(34581),i(29741),i(2360);const s="imageProcessingCompatibility",n="#ifdef IMAGEPROCESSINGPOSTPROCESS\ngl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));\n#endif\n";r.l.IncludesShadersStore[s]=n;const o="spritesPixelShader",a="#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nuniform bool alphaTest;varying vec4 vColor;varying vec2 vUV;uniform sampler2D diffuseSampler;\n#include<fogFragmentDeclaration>\n#include<logDepthDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#ifdef PIXEL_PERFECT\nvec2 uvPixelPerfect(vec2 uv) {vec2 res=vec2(textureSize(diffuseSampler,0));uv=uv*res;vec2 seam=floor(uv+0.5);uv=seam+clamp((uv-seam)/fwidth(uv),-0.5,0.5);return uv/res;}\n#endif\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#ifdef PIXEL_PERFECT\nvec2 uv=uvPixelPerfect(vUV);\n#else\nvec2 uv=vUV;\n#endif\nvec4 color=texture2D(diffuseSampler,uv);float fAlphaTest=float(alphaTest);if (fAlphaTest != 0.)\n{if (color.a<0.95)\ndiscard;}\ncolor*=vColor;\n#include<logDepthFragment>\n#include<fogFragment>\ngl_FragColor=color;\n#include<imageProcessingCompatibility>\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStore[o]=a;const l={name:o,shader:a}},87593:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphWhileLoopBlock:()=>a});var r=i(4720),s=i(56552),n=i(33006),o=i(51137);class a extends n.w{constructor(e){super(e),this.config=e,this.condition=this.registerDataInput("condition",r.RI),this.executionFlow=this._registerSignalOutput("executionFlow"),this.completed=this._registerSignalOutput("completed"),this._unregisterSignalOutput("out")}_execute(e,t){let i=this.condition.getValue(e);this.config?.doWhile&&!i&&this.executionFlow._activateSignal(e);let r=0;for(;i;){if(this.executionFlow._activateSignal(e),++r,r>=a.MaxLoopCount){o.V.Warn("FlowGraphWhileLoopBlock: Max loop count reached. Breaking.");break}i=this.condition.getValue(e)}this.completed._activateSignal(e)}getClassName(){return"FlowGraphWhileLoopBlock"}}a.MaxLoopCount=1e3,(0,s.Y5)("FlowGraphWhileLoopBlock",a)},87641:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphPauseAnimationBlock:()=>o});var r=i(33006),s=i(4720),n=i(56552);class o extends r.w{constructor(e){super(e),this.animationToPause=this.registerDataInput("animationToPause",s.Vv)}_execute(e){this.animationToPause.getValue(e).pause(),this.out._activateSignal(e)}getClassName(){return"FlowGraphPauseAnimationBlock"}}(0,n.Y5)("FlowGraphPauseAnimationBlock",o)},88188:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelGrid2dArrayDebugPixelShader:()=>n});const r="iblVoxelGrid2dArrayDebugPixelShader",s="precision highp sampler2DArray;varying vec2 vUV;uniform sampler2DArray voxelTexture;uniform sampler2D textureSampler;uniform int slice;void main(void) {ivec3 size=textureSize(voxelTexture,0);float dimension=sqrt(float(size.z));vec2 samplePos=fract(vUV.xy*vec2(dimension));int sampleIndex=int(floor(vUV.x*float(dimension))+floor(vUV.y*float(dimension))*dimension);glFragColor.rgb=texture(voxelTexture,vec3(samplePos.xy,sampleIndex)).rrr;glFragColor.a=1.0;glFragColor.rgb+=texture(textureSampler,vUV.xy).rgb;}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},88826:(e,t,i)=>{i.r(t),i.d(t,{rsmFullGlobalIlluminationPixelShader:()=>n});const r="rsmFullGlobalIlluminationPixelShader",s="/**\n* The implementation is a direct application of the formula found in http:\n*/\nprecision highp float;varying vec2 vUV;uniform mat4 rsmLightMatrix;uniform vec4 rsmInfo;uniform sampler2D textureSampler;uniform sampler2D normalSampler;uniform sampler2D rsmPositionW;uniform sampler2D rsmNormalW;uniform sampler2D rsmFlux;\n#ifdef TRANSFORM_NORMAL\nuniform mat4 invView;\n#endif\nvec3 computeIndirect(vec3 p,vec3 n) {vec3 indirectDiffuse=vec3(0.);float intensity=rsmInfo.z;float edgeArtifactCorrection=rsmInfo.w;vec4 texRSM=rsmLightMatrix*vec4(p,1.);texRSM.xy/=texRSM.w;texRSM.xy=texRSM.xy*0.5+0.5;int width=int(rsmInfo.x);int height=int(rsmInfo.y);for (int j=0; j<height; j++) {for (int i=0; i<width; i++) {ivec2 uv=ivec2(i,j);vec3 vplPositionW=texelFetch(rsmPositionW,uv,0).xyz;vec3 vplNormalW=texelFetch(rsmNormalW,uv,0).xyz*2.0-1.0;vec3 vplFlux=texelFetch(rsmFlux,uv,0).rgb;vplPositionW-=vplNormalW*edgeArtifactCorrection; \nfloat dist2=dot(vplPositionW-p,vplPositionW-p);indirectDiffuse+=vplFlux*max(0.,dot(n,vplPositionW-p))*max(0.,dot(vplNormalW,p-vplPositionW))/(dist2*dist2);}}\nreturn clamp(indirectDiffuse*intensity,0.0,1.0);}\nvoid main(void) \n{vec3 positionW=texture2D(textureSampler,vUV).xyz;vec3 normalW=texture2D(normalSampler,vUV).xyz;\n#ifdef DECODE_NORMAL\nnormalW=normalW*2.0-1.0;\n#endif\n#ifdef TRANSFORM_NORMAL\nnormalW=(invView*vec4(normalW,0.)).xyz;\n#endif\ngl_FragColor.rgb=computeIndirect(positionW,normalW);gl_FragColor.a=1.0;}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},88852:(e,t,i)=>{i.r(t),i.d(t,{depthPixelShader:()=>o});var r=i(69610);i(6194),i(8334),i(7412);const s="depthPixelShader",n="#ifdef ALPHATEST\nvarying vec2 vUV;uniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\nvarying float vDepthMetric;\n#ifdef PACKED\n#include<packingFunctions>\n#endif\n#ifdef STORE_CAMERASPACE_Z\nvarying vec4 vViewPos;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#ifdef STORE_CAMERASPACE_Z\n#ifdef PACKED\ngl_FragColor=pack(vViewPos.z);\n#else\ngl_FragColor=vec4(vViewPos.z,0.0,0.0,1.0);\n#endif\n#else\n#ifdef NONLINEARDEPTH\n#ifdef PACKED\ngl_FragColor=pack(gl_FragCoord.z);\n#else\ngl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);\n#endif\n#else\n#ifdef PACKED\ngl_FragColor=pack(vDepthMetric);\n#else\ngl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);\n#endif\n#endif\n#endif\n}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},89252:(e,t,i)=>{i.r(t),i.d(t,{boundingBoxRendererVertexShaderWGSL:()=>n});const r="boundingBoxRendererVertexShader",s="attribute position: vec3f;uniform world: mat4x4f;uniform viewProjection: mat4x4f;\n#ifdef INSTANCES\nattribute world0 : vec4<f32>;attribute world1 : vec4<f32>;attribute world2 : vec4<f32>;attribute world3 : vec4<f32>;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#ifdef INSTANCES\nvar finalWorld=mat4x4<f32>(vertexInputs.world0,vertexInputs.world1,vertexInputs.world2,vertexInputs.world3);var worldPos: vec4f=finalWorld* vec4f(input.position,1.0);\n#else\nvar worldPos: vec4f=uniforms.world* vec4f(input.position,1.0);\n#endif\nvertexOutputs.position=uniforms.viewProjection*worldPos;\n#define CUSTOM_VERTEX_MAIN_END\n}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},89273:(e,t,i)=>{i.r(t),i.d(t,{shadowMapFragmentWGSL:()=>n});const r="shadowMapFragment",s="var depthSM: f32=fragmentInputs.vDepthMetricSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\n#if SM_USEDISTANCE==1\ndepthSM=(length(fragmentInputs.vPositionWSM-uniforms.lightDataSM)+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\ndepthSM=(-fragmentInputs.zSM+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#else\ndepthSM=(fragmentInputs.zSM+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#endif\n#endif\ndepthSM=clamp(depthSM,0.0,1.0);\n#ifdef USE_REVERSE_DEPTHBUFFER\nfragmentOutputs.fragDepth=clamp(1.0-depthSM,0.0,1.0);\n#else\nfragmentOutputs.fragDepth=clamp(depthSM,0.0,1.0); \n#endif\n#elif SM_USEDISTANCE==1\ndepthSM=(length(fragmentInputs.vPositionWSM-uniforms.lightDataSM)+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#endif\n#if SM_ESM==1\ndepthSM=clamp(exp(-min(87.,uniforms.biasAndScaleSM.z*depthSM)),0.,1.);\n#endif\n#if SM_FLOAT==1\nfragmentOutputs.color= vec4f(depthSM,1.0,1.0,1.0);\n#else\nfragmentOutputs.color=pack(depthSM);\n#endif\n";i(69610).l.IncludesShadersStoreWGSL[r]=s;const n={name:r,shader:s}},89480:(e,t,i)=>{i.r(t),i.d(t,{depthOfFieldMergePixelShaderWGSL:()=>n});const r="depthOfFieldMergePixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var circleOfConfusionSamplerSampler: sampler;var circleOfConfusionSampler: texture_2d<f32>;var blurStep0Sampler: sampler;var blurStep0: texture_2d<f32>;\n#if BLUR_LEVEL>0\nvar blurStep1Sampler: sampler;var blurStep1: texture_2d<f32>;\n#endif\n#if BLUR_LEVEL>1\nvar blurStep2Sampler: sampler;var blurStep2: texture_2d<f32>;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var coc: f32=textureSampleLevel(circleOfConfusionSampler,circleOfConfusionSamplerSampler,input.vUV,0.0).r;\n#if BLUR_LEVEL==0\nvar original: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var blurred0: vec4f=textureSampleLevel(blurStep0,blurStep0Sampler,input.vUV,0.0);fragmentOutputs.color=mix(original,blurred0,coc);\n#endif\n#if BLUR_LEVEL==1\nif(coc<0.5){var original: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);fragmentOutputs.color=mix(original,blurred1,coc/0.5);}else{var blurred0: vec4f=textureSampleLevel(blurStep0,blurStep0Sampler,input.vUV,0.0);var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);fragmentOutputs.color=mix(blurred1,blurred0,(coc-0.5)/0.5);}\n#endif\n#if BLUR_LEVEL==2\nif(coc<0.33){var original: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var blurred2: vec4f=textureSampleLevel(blurStep2,blurStep2Sampler,input.vUV,0.0);fragmentOutputs.color=mix(original,blurred2,coc/0.33);}else if(coc<0.66){var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);var blurred2: vec4f=textureSampleLevel(blurStep2,blurStep2Sampler,input.vUV,0.0);fragmentOutputs.color=mix(blurred2,blurred1,(coc-0.33)/0.33);}else{var blurred0: vec4f=textureSampleLevel(blurStep0,blurStep0Sampler,input.vUV,0.0);var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);fragmentOutputs.color=mix(blurred1,blurred0,(coc-0.66)/0.34);}\n#endif\n}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},89619:(e,t,i)=>{i.r(t),i.d(t,{chromaticAberrationPixelShaderWGSL:()=>n});const r="chromaticAberrationPixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform chromatic_aberration: f32;uniform radialIntensity: f32;uniform direction: vec2f;uniform centerPosition: vec2f;uniform screen_width: f32;uniform screen_height: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var centered_screen_pos: vec2f= vec2f(input.vUV.x-uniforms.centerPosition.x,input.vUV.y-uniforms.centerPosition.y);var directionOfEffect: vec2f=uniforms.direction;if(directionOfEffect.x==0. && directionOfEffect.y==0.){directionOfEffect=normalize(centered_screen_pos);}\nvar radius2: f32=centered_screen_pos.x*centered_screen_pos.x\n+ centered_screen_pos.y*centered_screen_pos.y;var radius: f32=sqrt(radius2);var ref_indices: vec3f= vec3f(-0.3,0.0,0.3);var ref_shiftX: f32=uniforms.chromatic_aberration*pow(radius,uniforms.radialIntensity)*directionOfEffect.x/uniforms.screen_width;var ref_shiftY: f32=uniforms.chromatic_aberration*pow(radius,uniforms.radialIntensity)*directionOfEffect.y/uniforms.screen_height;var ref_coords_r: vec2f=vec2f(input.vUV.x+ref_indices.r*ref_shiftX,input.vUV.y+ref_indices.r*ref_shiftY*0.5);var ref_coords_g: vec2f=vec2f(input.vUV.x+ref_indices.g*ref_shiftX,input.vUV.y+ref_indices.g*ref_shiftY*0.5);var ref_coords_b: vec2f=vec2f(input.vUV.x+ref_indices.b*ref_shiftX,input.vUV.y+ref_indices.b*ref_shiftY*0.5);var r=textureSample(textureSampler,textureSamplerSampler,ref_coords_r);var g=textureSample(textureSampler,textureSamplerSampler,ref_coords_g);var b=textureSample(textureSampler,textureSamplerSampler,ref_coords_b);var a=clamp(r.a+g.a+b.a,0.,1.);fragmentOutputs.color=vec4f(r.r,g.g,b.b,a);}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},90982:(e,t,i)=>{i.r(t),i.d(t,{iblIcdfPixelShader:()=>o});var r=i(69610);i(73325);const s="iblIcdfPixelShader",n="precision highp sampler2D;\n#include<helperFunctions>\nvarying vec2 vUV;\n#ifdef IBL_USE_CUBE_MAP\nuniform samplerCube iblSource;\n#else\nuniform sampler2D iblSource;\n#endif\nuniform sampler2D scaledLuminanceSampler;uniform int iblWidth;uniform int iblHeight;uniform sampler2D cdfx;uniform sampler2D cdfy;float fetchLuminance(vec2 coords) {\n#ifdef IBL_USE_CUBE_MAP\nvec3 direction=equirectangularToCubemapDirection(coords);vec3 color=textureCubeLodEXT(iblSource,direction,0.0).rgb;\n#else\nvec3 color=textureLod(iblSource,coords,0.0).rgb;\n#endif\nreturn dot(color,LuminanceEncodeApprox);}\nfloat fetchCDFx(int x) { return texelFetch(cdfx,ivec2(x,0),0).x; }\nfloat bisectx(int size,float targetValue) {int a=0,b=size-1;while (b-a>1) {int c=a+b>>1;if (fetchCDFx(c)<targetValue)\na=c;else\nb=c;}\nreturn mix(float(a),float(b),\n(targetValue-fetchCDFx(a))/(fetchCDFx(b)-fetchCDFx(a))) /\nfloat(size-1);}\nfloat fetchCDFy(int y,int invocationId) {return texelFetch(cdfy,ivec2(invocationId,y),0).x;}\nfloat bisecty(int size,float targetValue,int invocationId) {int a=0,b=size-1;while (b-a>1) {int c=a+b>>1;if (fetchCDFy(c,invocationId)<targetValue)\na=c;else\nb=c;}\nreturn mix(float(a),float(b),\n(targetValue-fetchCDFy(a,invocationId)) /\n(fetchCDFy(b,invocationId)-fetchCDFy(a,invocationId))) /\nfloat(size-1);}\nvoid main(void) {ivec2 cdfxSize=textureSize(cdfx,0);int cdfWidth=cdfxSize.x;int icdfWidth=cdfWidth-1;ivec2 currentPixel=ivec2(gl_FragCoord.xy);vec3 outputColor=vec3(1.0);if (currentPixel.x==0) {outputColor.x=0.0;} else if (currentPixel.x==icdfWidth-1) {outputColor.x=1.0;} else {float targetValue=fetchCDFx(cdfWidth-1)*vUV.x;outputColor.x=bisectx(cdfWidth,targetValue);}\nivec2 cdfySize=textureSize(cdfy,0);int cdfHeight=cdfySize.y;if (currentPixel.y==0) {outputColor.y=0.0;} else if (currentPixel.y==cdfHeight-2) {outputColor.y=1.0;} else {float targetValue=fetchCDFy(cdfHeight-1,currentPixel.x)*vUV.y;outputColor.y=max(bisecty(cdfHeight,targetValue,currentPixel.x),0.0);}\nvec2 size=vec2(textureSize(scaledLuminanceSampler,0));float highestMip=floor(log2(size.x));float normalization=texture(scaledLuminanceSampler,vUV,highestMip).r;float pixelLuminance=fetchLuminance(vUV);outputColor.z=pixelLuminance/(2.0*PI*normalization);gl_FragColor=vec4(outputColor,1.0);}\n";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},91211:(e,t,i)=>{const r="pointCloudVertex",s="#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n";i(69610).l.IncludesShadersStore[r]=s},91480:(e,t,i)=>{i.d(t,{OptimizeIndices:()=>s});var r=i(2001);function s(e){const t=[],i=e.length/3;for(let r=0;r<i;r++)t.push([e[3*r],e[3*r+1],e[3*r+2]]);const s=new Map;t.forEach(((e,t)=>{e.forEach((e=>{let i=s.get(e);i||s.set(e,i=[]),i.push(t)}))}));const n=new r.P(i),o=[],a=e=>{const i=[e];for(;i.length>0;){const e=i.pop();n.get(e)||(n.set(e,!0),o.push(t[e]),t[e].forEach((e=>{const t=s.get(e);t&&t.forEach((e=>{n.get(e)||i.push(e)}))})))}};for(let e=0;e<i;e++)n.get(e)||a(e);let l=0;o.forEach((t=>{e[l++]=t[0],e[l++]=t[1],e[l++]=t[2]}))}},91506:(e,t,i)=>{i.r(t),i.d(t,{anaglyphPixelShaderWGSL:()=>n});const r="anaglyphPixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var leftSamplerSampler: sampler;var leftSampler: texture_2d<f32>;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var leftFrag: vec4f=textureSample(leftSampler,leftSamplerSampler,input.vUV);leftFrag= vec4f(1.0,leftFrag.g,leftFrag.b,1.0);var rightFrag: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);rightFrag= vec4f(rightFrag.r,1.0,1.0,1.0);fragmentOutputs.color= vec4f(rightFrag.rgb*leftFrag.rgb,1.0);}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},91650:(e,t,i)=>{i.r(t),i.d(t,{lodCubePixelShaderWGSL:()=>n});const r="lodCubePixelShader",s="const GammaEncodePowerApprox=1.0/2.2;varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_cube<f32>;uniform lod: f32;uniform gamma: i32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {let uv=fragmentInputs.vUV*2.0-1.0;\n#ifdef POSITIVEX\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(1.001,uv.y,uv.x),uniforms.lod);\n#endif\n#ifdef NEGATIVEX\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(-1.001,uv.y,uv.x),uniforms.lod);\n#endif\n#ifdef POSITIVEY\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(uv.y,1.001,uv.x),uniforms.lod);\n#endif\n#ifdef NEGATIVEY\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(uv.y,-1.001,uv.x),uniforms.lod);\n#endif\n#ifdef POSITIVEZ\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(uv,1.001),uniforms.lod);\n#endif\n#ifdef NEGATIVEZ\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(uv,-1.001),uniforms.lod);\n#endif\nif (uniforms.gamma==0) {fragmentOutputs.color=vec4f(pow(fragmentOutputs.color.rgb,vec3f(GammaEncodePowerApprox)),fragmentOutputs.color.a);}}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},91807:(e,t,i)=>{i.r(t),i.d(t,{bilateralBlurPixelShaderWGSL:()=>n});const r="bilateralBlurPixelShader",s="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;uniform filterSize: i32;uniform blurDir: vec2f;uniform depthThreshold: f32;uniform normalThreshold: f32;varying vUV: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.).rgb;var depth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.).x;if (depth>=1e6 || depth<=0.) {fragmentOutputs.color= vec4f(color,1.);return fragmentOutputs;}\nvar normal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV,0.).rgb;\n#ifdef DECODE_NORMAL\nnormal=normal*2.0-1.0;\n#endif\nvar sigma: f32= f32(uniforms.filterSize);var two_sigma2: f32=2.0*sigma*sigma;var sigmaDepth: f32=uniforms.depthThreshold;var two_sigmaDepth2: f32=2.0*sigmaDepth*sigmaDepth;var sigmaNormal: f32=uniforms.normalThreshold;var two_sigmaNormal2: f32=2.0*sigmaNormal*sigmaNormal;var sum: vec3f= vec3f(0.);var wsum: f32=0.;for (var x: i32=-uniforms.filterSize; x<=uniforms.filterSize; x++) {var coords=vec2f(f32(x));var sampleColor: vec3f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV+coords*uniforms.blurDir,0.).rgb;var sampleDepth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV+coords*uniforms.blurDir,0.).r;var sampleNormal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV+coords*uniforms.blurDir,0.).rgb;\n#ifdef DECODE_NORMAL\nsampleNormal=sampleNormal*2.0-1.0;\n#endif\nvar r: f32=dot(coords,coords);var w: f32=exp(-r/two_sigma2);var depthDelta: f32=abs(sampleDepth-depth);var wd: f32=step(depthDelta,uniforms.depthThreshold);var normalDelta: vec3f=abs(sampleNormal-normal);var wn: f32=step(normalDelta.x+normalDelta.y+normalDelta.z,uniforms.normalThreshold);sum+=sampleColor*w*wd*wn;wsum+=w*wd*wn;}\nfragmentOutputs.color= vec4f(sum/wsum,1.);}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},91932:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingBilateralBlurPixelShader:()=>n});const r="fluidRenderingBilateralBlurPixelShader",s="uniform sampler2D textureSampler;uniform int maxFilterSize;uniform vec2 blurDir;uniform float projectedParticleConstant;uniform float depthThreshold;varying vec2 vUV;void main(void) {float depth=textureLod(textureSampler,vUV,0.).x;if (depth>=1e6 || depth<=0.) {glFragColor=vec4(vec3(depth),1.);return;}\nint filterSize=min(maxFilterSize,int(ceil(projectedParticleConstant/depth)));float sigma=float(filterSize)/3.0;float two_sigma2=2.0*sigma*sigma;float sigmaDepth=depthThreshold/3.0;float two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;float sum=0.;float wsum=0.;float sumVel=0.;for (int x=-filterSize; x<=filterSize; ++x) {vec2 coords=vec2(x);vec2 sampleDepthVel=textureLod(textureSampler,vUV+coords*blurDir,0.).rg;float r=dot(coords,coords);float w=exp(-r/two_sigma2);float rDepth=sampleDepthVel.r-depth;float wd=exp(-rDepth*rDepth/two_sigmaDepth2);sum+=sampleDepthVel.r*w*wd;sumVel+=sampleDepthVel.g*w*wd;wsum+=w*wd;}\nglFragColor=vec4(sum/wsum,sumVel/wsum,0.,1.);}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},92199:(e,t,i)=>{i.r(t),i.d(t,{iblCombineVoxelGridsPixelShaderWGSL:()=>n});const r="iblCombineVoxelGridsPixelShader",s="varying vUV: vec2f;var voxelXaxisSamplerSampler: sampler;var voxelXaxisSampler: texture_3d<f32>;var voxelYaxisSamplerSampler: sampler;var voxelYaxisSampler: texture_3d<f32>;var voxelZaxisSamplerSampler: sampler;var voxelZaxisSampler: texture_3d<f32>;uniform layer: f32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var coordZ: vec3f= vec3f(fragmentInputs.vUV.x,fragmentInputs.vUV.y,uniforms.layer);var voxelZ: f32=textureSample(voxelZaxisSampler,voxelZaxisSamplerSampler,coordZ).r;var coordX: vec3f= vec3f(1.0-uniforms.layer,fragmentInputs.vUV.y,fragmentInputs.vUV.x);var voxelX: f32=textureSample(voxelXaxisSampler,voxelXaxisSamplerSampler,coordX).r;var coordY: vec3f= vec3f(uniforms.layer,fragmentInputs.vUV.x,fragmentInputs.vUV.y);var voxelY: f32=textureSample(voxelYaxisSampler,voxelYaxisSamplerSampler,coordY).r;var voxel=select(0.0,1.0,(voxelX>0.0 || voxelY>0.0 || voxelZ>0.0));fragmentOutputs.color= vec4f( vec3f(voxel),1.0);}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},92248:(e,t,i)=>{i.r(t),i.d(t,{hdrFilteringVertexShaderWGSL:()=>n});const r="hdrFilteringVertexShader",s="attribute position: vec2f;varying direction: vec3f;uniform up: vec3f;uniform right: vec3f;uniform front: vec3f;\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar view: mat3x3f= mat3x3f(uniforms.up,uniforms.right,uniforms.front);vertexOutputs.direction=view*vec3f(input.position,1.0);vertexOutputs.position= vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},92321:(e,t,i)=>{i.r(t),i.d(t,{backgroundPixelShaderWGSL:()=>l});var r=i(69610);i(33723),i(79702),i(72230),i(16205),i(30379),i(76493),i(78589),i(88996),i(93226),i(39759),i(66407);const s="intersectionFunctions",n="fn diskIntersectWithBackFaceCulling(ro: vec3f,rd: vec3f,c: vec3f,r: f32)->f32 {var d: f32=rd.y;if(d>0.0) { return 1e6; }\nvar o: vec3f=ro-c;var t: f32=-o.y/d;var q: vec3f=o+rd*t;return select(1e6,t,(dot(q,q)<r*r));}\nfn sphereIntersect(ro: vec3f,rd: vec3f,ce: vec3f,ra: f32)->vec2f {var oc: vec3f=ro-ce;var b: f32=dot(oc,rd);var c: f32=dot(oc,oc)-ra*ra;var h: f32=b*b-c;if(h<0.0) { return vec2f(-1.,-1.); }\nh=sqrt(h);return vec2f(-b+h,-b-h);}\nfn sphereIntersectFromOrigin(ro: vec3f,rd: vec3f,ra: f32)->vec2f {var b: f32=dot(ro,rd);var c: f32=dot(ro,ro)-ra*ra;var h: f32=b*b-c;if(h<0.0) { return vec2f(-1.,-1.); }\nh=sqrt(h);return vec2f(-b+h,-b-h);}";r.l.IncludesShadersStoreWGSL[s]=n;i(97715),i(25271),i(38780),i(93243);const o="backgroundPixelShader",a="#include<backgroundUboDeclaration>\n#include<helperFunctions>\nvarying vPositionW: vec3f;\n#ifdef MAINUV1\nvarying vMainUV1: vec2f;\n#endif \n#ifdef MAINUV2 \nvarying vMainUV2: vec2f; \n#endif \n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#endif\n#ifdef DIFFUSE\n#if DIFFUSEDIRECTUV==1\n#define vDiffuseUV vMainUV1\n#elif DIFFUSEDIRECTUV==2\n#define vDiffuseUV vMainUV2\n#else\nvarying vDiffuseUV: vec2f;\n#endif\nvar diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nvar reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;\n#ifdef TEXTURELODSUPPORT\n#else\nvar reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;\n#endif\n#else\nvar reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;\n#ifdef TEXTURELODSUPPORT\n#else\nvar reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE;\n#endif\n#ifndef SHADOWONLY\n#define SHADOWONLY;\n#endif\n#include<imageProcessingDeclaration>\n#include<lightUboDeclaration>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<imageProcessingFunctions>\n#include<logDepthDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<fogFragmentDeclaration>\n#ifdef REFLECTIONFRESNEL\n#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\nfn fresnelSchlickEnvironmentGGX(VdotN: f32,reflectance0: vec3f,reflectance90: vec3f,smoothness: f32)->vec3f\n{var weight: f32=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}\n#endif\n#ifdef PROJECTED_GROUND\n#include<intersectionFunctions>\nfn project(viewDirectionW: vec3f,eyePosition: vec3f)->vec3f {var radius: f32=uniforms.projectedGroundInfos.x;var height: f32=uniforms.projectedGroundInfos.y;var camDir: vec3f=-viewDirectionW;var skySphereDistance: f32=sphereIntersectFromOrigin(eyePosition,camDir,radius).x;var skySpherePositionW: vec3f=eyePosition+camDir*skySphereDistance;var p: vec3f=normalize(skySpherePositionW);var upEyePosition=vec3f(eyePosition.x,eyePosition.y-height,eyePosition.z);var sIntersection: f32=sphereIntersectFromOrigin(upEyePosition,p,radius).x;var h: vec3f= vec3f(0.0,-height,0.0);var dIntersection: f32=diskIntersectWithBackFaceCulling(upEyePosition,p,h,radius);p=(upEyePosition+min(sIntersection,dIntersection)*p);return p;}\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvar viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-input.vPositionW);\n#ifdef NORMAL\nvar normalW: vec3f=normalize(fragmentInputs.vNormalW);\n#else\nvar normalW: vec3f= vec3f(0.0,1.0,0.0);\n#endif\nvar shadow: f32=1.;var globalShadow: f32=0.;var shadowLightCount: f32=0.;var aggShadow: f32=0.;var numLights: f32=0.;\n#include<lightFragment>[0..maxSimultaneousLights]\n#ifdef SHADOWINUSE\nglobalShadow/=shadowLightCount;\n#else\nglobalShadow=1.0;\n#endif\n#ifndef BACKMAT_SHADOWONLY\nvar reflectionColor: vec4f= vec4f(1.,1.,1.,1.);\n#ifdef REFLECTION\n#ifdef PROJECTED_GROUND\nvar reflectionVector: vec3f=project(viewDirectionW,scene.vEyePosition.xyz);reflectionVector= (uniforms.reflectionMatrix*vec4f(reflectionVector,1.)).xyz;\n#else\nvar reflectionVector: vec3f=computeReflectionCoords( vec4f(fragmentInputs.vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvar reflectionCoords: vec3f=reflectionVector;\n#else\nvar reflectionCoords: vec2f=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n#ifdef REFLECTIONBLUR\nvar reflectionLOD: f32=uniforms.vReflectionInfos.y;\n#ifdef TEXTURELODSUPPORT\nreflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;reflectionColor=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);\n#else\nvar lodReflectionNormalized: f32=saturate(reflectionLOD);var lodReflectionNormalizedDoubled: f32=lodReflectionNormalized*2.0;var reflectionSpecularMid: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(\ntextureSample(reflectionrHighSampler,reflectionrHighSamplerSampler,reflectionCoords),\nreflectionSpecularMid,\nlodReflectionNormalizedDoubled\n);} else {reflectionColor=mix(\nreflectionSpecularMid,\ntextureSample(reflectionLowSampler,reflectionLowSamplerSampler,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);}\n#endif\n#else\nvar reflectionSample: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);reflectionColor=reflectionSample;\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor=vec4f(fromRGBD(reflectionColor).rgb,reflectionColor.a);\n#endif\n#ifdef GAMMAREFLECTION\nreflectionColor=vec4f(toLinearSpaceVec3(reflectionColor.rgb),reflectionColor.a);\n#endif\n#ifdef REFLECTIONBGR\nreflectionColor=vec4f(reflectionColor.bgr,reflectionColor.a);\n#endif\nreflectionColor=vec4f(reflectionColor.rgb*uniforms.vReflectionInfos.x,reflectionColor.a);\n#endif\nvar diffuseColor: vec3f= vec3f(1.,1.,1.);var finalAlpha: f32=uniforms.alpha;\n#ifdef DIFFUSE\nvar diffuseMap: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,input.vDiffuseUV);\n#ifdef GAMMADIFFUSE\ndiffuseMap=vec4f(toLinearSpaceVec3(diffuseMap.rgb),diffuseMap.a);\n#endif\ndiffuseMap=vec4f(diffuseMap.rgb *uniforms.vDiffuseInfos.y,diffuseMap.a);\n#ifdef DIFFUSEHASALPHA\nfinalAlpha*=diffuseMap.a;\n#endif\ndiffuseColor=diffuseMap.rgb;\n#endif\n#ifdef REFLECTIONFRESNEL\nvar colorBase: vec3f=diffuseColor;\n#else\nvar colorBase: vec3f=reflectionColor.rgb*diffuseColor;\n#endif\ncolorBase=max(colorBase,vec3f(0.0));\n#ifdef USERGBCOLOR\nvar finalColor: vec3f=colorBase;\n#else\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nvar mainColor: vec3f=mix(uniforms.vPrimaryColorShadow.rgb,uniforms.vPrimaryColor.rgb,colorBase);\n#else\nvar mainColor: vec3f=uniforms.vPrimaryColor.rgb;\n#endif\nvar finalColor: vec3f=colorBase*mainColor;\n#endif\n#ifdef REFLECTIONFRESNEL\nvar reflectionAmount: vec3f=uniforms.vReflectionControl.xxx;var reflectionReflectance0: vec3f=uniforms.vReflectionControl.yyy;var reflectionReflectance90: vec3f=uniforms.vReflectionControl.zzz;var VdotN: f32=dot(normalize(scene.vEyePosition.xyz),normalW);var planarReflectionFresnel: vec3f=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;\n#ifdef REFLECTIONFALLOFF\nvar reflectionDistanceFalloff: f32=1.0-saturate(length(vPositionW.xyz-uniforms.vBackgroundCenter)*uniforms.vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;\n#endif\nfinalColor=mix(finalColor,reflectionColor.rgb,saturateVec3(reflectionAmount));\n#endif\n#ifdef OPACITYFRESNEL\nvar viewAngleToFloor: f32=dot(normalW,normalize(scene.vEyePosition.xyz-uniforms.vBackgroundCenter));const startAngle: f32=0.1;var fadeFactor: f32=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;\n#endif\n#ifdef SHADOWINUSE\nfinalColor=mix(finalColor*uniforms.shadowLevel,finalColor,globalShadow);\n#endif\nvar color: vec4f= vec4f(finalColor,finalAlpha);\n#else\nvar color: vec4f= vec4f(uniforms.vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*uniforms.alpha);\n#endif\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\n#if !defined(SKIPFINALCOLORCLAMP)\ncolor=vec4f(clamp(color.rgb,vec3f(0.),vec3f(30.0)),color.a);\n#endif\n#else\ncolor=applyImageProcessing(color);\n#endif\n#ifdef PREMULTIPLYALPHA\ncolor=vec4f(color.rgb *color.a,color.a);\n#endif\n#ifdef NOISE\ncolor=vec4f(color.rgb+dither(fragmentInputs.vPositionW.xy,0.5),color.a);color=max(color,vec4f(0.0));\n#endif\nfragmentOutputs.color=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";r.l.ShadersStoreWGSL[o]=a;const l={name:o,shader:a}},92579:(e,t,i)=>{i.d(t,{H:()=>o});var r=i(90868),s=i(4720);const n=new RegExp(/\/\{(\w+)\}\//g);class o{constructor(e,t){this.path=e,this.ownerBlock=t,this.templatedInputs=[];let i=n.exec(e);const o=new Set;for(;i;){const[,a]=i;if(o.has(a))throw new Error("Duplicate template variable detected.");o.add(a),this.templatedInputs.push(t.registerDataInput(a,s.x2,new r.P(0))),i=n.exec(e)}}getAccessor(e,t){let i=this.path;for(const e of this.templatedInputs){const r=e.getValue(t).value;if("number"!=typeof r||r<0)throw new Error("Invalid value for templated input.");i=i.replace(`{${e.name}}`,r.toString())}return e.convert(i)}}},92905:(e,t,i)=>{i.r(t),i.d(t,{lodCubePixelShader:()=>n});const r="lodCubePixelShader",s="precision highp float;const float GammaEncodePowerApprox=1.0/2.2;varying vec2 vUV;uniform samplerCube textureSampler;uniform float lod;uniform int gamma;void main(void)\n{vec2 uv=vUV*2.0-1.0;\n#ifdef POSITIVEX\ngl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x),lod);\n#endif\n#ifdef NEGATIVEX\ngl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x),lod);\n#endif\n#ifdef POSITIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x),lod);\n#endif\n#ifdef NEGATIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x),lod);\n#endif\n#ifdef POSITIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,1.001),lod);\n#endif\n#ifdef NEGATIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,-1.001),lod);\n#endif\nif (gamma==0) {gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(GammaEncodePowerApprox));}}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},93101:(e,t,i)=>{i.d(t,{C:()=>r});class r{constructor(e){this.engine=e}}},93460:(e,t,i)=>{i.d(t,{Au:()=>o,Pt:()=>h,hG:()=>l,y5:()=>a});var r=i(86100),s=i(82704),n=i(80516);class o extends n.e{constructor(e){super("Spatial",e),this._attacherComponent=null}get isAttached(){return null!==this._attacherComponent&&this._attacherComponent.isAttached}attach(e,t,i){this.detach(),this._attacherComponent||(this._attacherComponent=new r.l(this)),this._attacherComponent.attach(e,t,i)}detach(){this._attacherComponent?.detach()}dispose(){super.dispose(),this._attacherComponent?.dispose(),this._attacherComponent=null}setOptions(e){this.coneInnerAngle=e.spatialConeInnerAngle??s.Qc.coneInnerAngle,this.coneOuterAngle=e.spatialConeOuterAngle??s.Qc.coneOuterAngle,this.coneOuterVolume=e.spatialConeOuterVolume??s.Qc.coneOuterVolume,this.distanceModel=e.spatialDistanceModel??s.Qc.distanceModel,this.maxDistance=e.spatialMaxDistance??s.Qc.maxDistance,this.minDistance=e.spatialMinDistance??s.Qc.minDistance,this.panningModel=e.spatialPanningModel??s.Qc.panningModel,this.rolloffFactor=e.spatialRolloffFactor??s.Qc.rolloffFactor,e.spatialPosition&&(this.position=e.spatialPosition.clone()),e.spatialRotationQuaternion?this.rotationQuaternion=e.spatialRotationQuaternion.clone():e.spatialRotation?this.rotation=e.spatialRotation.clone():this.rotationQuaternion=s.Qc.rotationQuaternion.clone(),this.update()}update(){this.isAttached?this._attacherComponent?.update():(this._updatePosition(),this._updateRotation())}}function a(e){return e.getSubNode("Spatial")}function l(e,t){return a(e)?.[t]??s.Qc[t]}function h(e,t,i){e.callOnSubNode("Spatial",(e=>{e[t]=i}))}},93968:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelSlabDebugVertexShader:()=>n});const r="iblVoxelSlabDebugVertexShader",s="attribute vec3 position;varying vec3 vNormalizedPosition;uniform mat4 world;uniform mat4 invWorldScale;uniform mat4 cameraViewMatrix;uniform mat4 projection;uniform mat4 viewMatrix;void main(void) {vec4 worldPosition=(world*vec4(position,1.));gl_Position=projection*cameraViewMatrix*worldPosition;vNormalizedPosition=(viewMatrix*invWorldScale*worldPosition).rgb;vNormalizedPosition.xyz=vNormalizedPosition.xyz*vec3(0.5)+vec3(0.5);}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},94354:(e,t,i)=>{i.r(t),i.d(t,{screenSpaceReflection2PixelShader:()=>o});var r=i(69610);i(73325),i(8709),i(69363);const s="screenSpaceReflection2PixelShader",n="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)\n#define TEXTURECUBEFUNC(s,c,lod) textureLod(s,c,lod)\n#else\n#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)\n#define TEXTURECUBEFUNC(s,c,bias) textureCube(s,c,bias)\n#endif\nuniform sampler2D textureSampler;varying vec2 vUV;\n#ifdef SSR_SUPPORTED\nuniform sampler2D reflectivitySampler;uniform sampler2D normalSampler;uniform sampler2D depthSampler;\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nuniform sampler2D backDepthSampler;uniform float backSizeFactor;\n#endif\n#ifdef SSR_USE_ENVIRONMENT_CUBE\nuniform samplerCube envCubeSampler;\n#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC\nuniform vec3 vReflectionPosition;uniform vec3 vReflectionSize;\n#endif\n#endif\nuniform mat4 view;uniform mat4 invView;uniform mat4 projection;uniform mat4 invProjectionMatrix;uniform mat4 projectionPixel;uniform float nearPlaneZ;uniform float farPlaneZ;uniform float stepSize;uniform float maxSteps;uniform float strength;uniform float thickness;uniform float roughnessFactor;uniform float reflectionSpecularFalloffExponent;uniform float maxDistance;uniform float selfCollisionNumSkip;uniform float reflectivityThreshold;\n#include<helperFunctions>\n#include<pbrBRDFFunctions>\n#include<screenSpaceRayTrace>\nvec3 hash(vec3 a)\n{a=fract(a*0.8);a+=dot(a,a.yxz+19.19);return fract((a.xxy+a.yxx)*a.zyx);}\nfloat computeAttenuationForIntersection(ivec2 hitPixel,vec2 hitUV,vec3 vsRayOrigin,vec3 vsHitPoint,vec3 reflectionVector,float maxRayDistance,float numIterations) {float attenuation=1.0;\n#ifdef SSR_ATTENUATE_SCREEN_BORDERS\nvec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-hitUV.xy));attenuation*=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);\n#endif\n#ifdef SSR_ATTENUATE_INTERSECTION_DISTANCE\nattenuation*=1.0-clamp(distance(vsRayOrigin,vsHitPoint)/maxRayDistance,0.0,1.0);\n#endif\n#ifdef SSR_ATTENUATE_INTERSECTION_NUMITERATIONS\nattenuation*=1.0-(numIterations/maxSteps);\n#endif\n#ifdef SSR_ATTENUATE_BACKFACE_REFLECTION\nvec3 reflectionNormal=texelFetch(normalSampler,hitPixel,0).xyz;float directionBasedAttenuation=smoothstep(-0.17,0.0,dot(reflectionNormal,-reflectionVector));attenuation*=directionBasedAttenuation;\n#endif\nreturn attenuation;}\n#endif\nvoid main()\n{\n#ifdef SSR_SUPPORTED\nvec4 colorFull=TEXTUREFUNC(textureSampler,vUV,0.0);vec3 color=colorFull.rgb;vec4 reflectivity=TEXTUREFUNC(reflectivitySampler,vUV,0.0);\n#ifndef SSR_DISABLE_REFLECTIVITY_TEST\nif (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=reflectivityThreshold) {\n#ifdef SSR_USE_BLUR\ngl_FragColor=vec4(0.);\n#else\ngl_FragColor=colorFull;\n#endif\nreturn;}\n#endif\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\ncolor=toLinearSpace(color);\n#endif\nvec2 texSize=vec2(textureSize(depthSampler,0));vec3 csNormal=texelFetch(normalSampler,ivec2(vUV*texSize),0).xyz; \n#ifdef SSR_DECODE_NORMAL\ncsNormal=csNormal*2.0-1.0;\n#endif\n#ifdef SSR_NORMAL_IS_IN_WORLDSPACE\ncsNormal=(view*vec4(csNormal,0.0)).xyz;\n#endif\nfloat depth=texelFetch(depthSampler,ivec2(vUV*texSize),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\ndepth=linearizeDepth(depth,nearPlaneZ,farPlaneZ);\n#endif\nvec3 csPosition=computeViewPosFromUVDepth(vUV,depth,projection,invProjectionMatrix);\n#ifdef ORTHOGRAPHIC_CAMERA\nvec3 csViewDirection=vec3(0.,0.,1.);\n#else\nvec3 csViewDirection=normalize(csPosition);\n#endif\nvec3 csReflectedVector=reflect(csViewDirection,csNormal);\n#ifdef SSR_USE_ENVIRONMENT_CUBE\nvec3 wReflectedVector=vec3(invView*vec4(csReflectedVector,0.0));\n#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC\nvec4 worldPos=invView*vec4(csPosition,1.0);wReflectedVector=parallaxCorrectNormal(worldPos.xyz,normalize(wReflectedVector),vReflectionSize,vReflectionPosition);\n#endif\n#ifdef SSR_INVERTCUBICMAP\nwReflectedVector.y*=-1.0;\n#endif\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nwReflectedVector.z*=-1.0;\n#endif\nvec3 envColor=TEXTURECUBEFUNC(envCubeSampler,wReflectedVector,0.0).xyz;\n#ifdef SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE\nenvColor=toLinearSpace(envColor);\n#endif\n#else\nvec3 envColor=color;\n#endif\nfloat reflectionAttenuation=1.0;bool rayHasHit=false;vec2 startPixel;vec2 hitPixel;vec3 hitPoint;float numIterations;\n#ifdef SSRAYTRACE_DEBUG\nvec3 debugColor;\n#endif\n#ifdef SSR_ATTENUATE_FACING_CAMERA\nreflectionAttenuation*=1.0-smoothstep(0.25,0.5,dot(-csViewDirection,csReflectedVector));\n#endif\nif (reflectionAttenuation>0.0) {\n#ifdef SSR_USE_BLUR\nvec3 jitt=vec3(0.);\n#else\nfloat roughness=1.0-reflectivity.a;vec3 jitt=mix(vec3(0.0),hash(csPosition)-vec3(0.5),roughness)*roughnessFactor; \n#endif\nvec2 uv2=vUV*texSize;float c=(uv2.x+uv2.y)*0.25;float jitter=mod(c,1.0); \nrayHasHit=traceScreenSpaceRay1(\ncsPosition,\nnormalize(csReflectedVector+jitt),\nprojectionPixel,\ndepthSampler,\ntexSize,\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nbackDepthSampler,\nbackSizeFactor,\n#endif\nthickness,\nnearPlaneZ,\nfarPlaneZ,\nstepSize,\njitter,\nmaxSteps,\nmaxDistance,\nselfCollisionNumSkip,\nstartPixel,\nhitPixel,\nhitPoint,\nnumIterations\n#ifdef SSRAYTRACE_DEBUG\n,debugColor\n#endif\n);}\n#ifdef SSRAYTRACE_DEBUG\ngl_FragColor=vec4(debugColor,1.);return;\n#endif\nvec3 F0=reflectivity.rgb;vec3 fresnel=fresnelSchlickGGX(max(dot(csNormal,-csViewDirection),0.0),F0,vec3(1.));vec3 SSR=envColor;if (rayHasHit) {vec3 reflectedColor=texelFetch(textureSampler,ivec2(hitPixel),0).rgb;\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\nreflectedColor=toLinearSpace(reflectedColor);\n#endif\nreflectionAttenuation*=computeAttenuationForIntersection(ivec2(hitPixel),hitPixel/texSize,csPosition,hitPoint,csReflectedVector,maxDistance,numIterations);SSR=reflectedColor*reflectionAttenuation+(1.0-reflectionAttenuation)*envColor;}\n#ifndef SSR_BLEND_WITH_FRESNEL\nSSR*=fresnel;\n#endif\n#ifdef SSR_USE_BLUR\nfloat blur_radius=0.0;float roughness=1.0-reflectivity.a*(1.0-roughnessFactor);if (roughness>0.001) {float cone_angle=min(roughness,0.999)*3.14159265*0.5;float cone_len=distance(startPixel,hitPixel);float op_len=2.0*tan(cone_angle)*cone_len; \nfloat a=op_len;float h=cone_len;float a2=a*a;float fh2=4.0f*h*h;blur_radius=(a*(sqrt(a2+fh2)-a))/(4.0f*h);}\ngl_FragColor=vec4(SSR,blur_radius/255.0); \n#else\n#ifdef SSR_BLEND_WITH_FRESNEL\nvec3 reflectionMultiplier=clamp(pow(fresnel*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#else\nvec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#endif\nvec3 colorMultiplier=1.0-reflectionMultiplier;vec3 finalColor=(color*colorMultiplier)+(SSR*reflectionMultiplier);\n#ifdef SSR_OUTPUT_IS_GAMMA_SPACE\nfinalColor=toGammaSpace(finalColor);\n#endif\ngl_FragColor=vec4(finalColor,colorFull.a);\n#endif\n#else\ngl_FragColor=TEXTUREFUNC(textureSampler,vUV,0.0);\n#endif\n}\n";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},94619:(e,t,i)=>{i.r(t),i.d(t,{hdrIrradianceFilteringVertexShader:()=>n});const r="hdrIrradianceFilteringVertexShader",s="attribute vec2 position;varying vec3 direction;uniform vec3 up;uniform vec3 right;uniform vec3 front;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nmat3 view=mat3(up,right,front);direction=view*vec3(position,1.0);gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},95176:(e,t,i)=>{i.r(t),i.d(t,{copyTexture3DLayerToTexturePixelShaderWGSL:()=>n});const r="copyTexture3DLayerToTexturePixelShader",s="var textureSampler: texture_3d<f32>;uniform layerNum: i32;varying vUV: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {let coord=vec3f(vec2f(input.vUV.x,input.vUV.y)*vec2f(textureDimensions(textureSampler,0).xy),f32(uniforms.layerNum));let color=textureLoad(textureSampler,vec3i(coord),0).rgb;fragmentOutputs.color= vec4f(color,1);}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},95228:(e,t,i)=>{const r="screenSpaceRayTrace",s="fn distanceSquared(a: vec2f,b: vec2f)->f32 { \nvar temp=a-b; \nreturn dot(temp,temp); }\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nfn linearizeDepth(depth: f32,near: f32,far: f32)->f32 {\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nreturn -(near*far)/(far-depth*(far-near));\n#else\nreturn (near*far)/(far-depth*(far-near));\n#endif\n}\n#endif\n/**\nparam csOrigin Camera-space ray origin,which must be \nwithin the view volume and must have z>0.01 and project within the valid screen rectangle\nparam csDirection Unit length camera-space ray direction\nparam projectToPixelMatrix A projection matrix that maps to **pixel** coordinates \n(**not** [-1,+1] normalized device coordinates).\nparam csZBuffer The camera-space Z buffer\nparam csZBufferSize Dimensions of csZBuffer\nparam csZThickness Camera space csZThickness to ascribe to each pixel in the depth buffer\nparam nearPlaneZ Positive number. Doesn't have to be THE actual near plane,just a reasonable value\nfor clipping rays headed towards the camera. Should be the actual near plane if screen-space depth is enabled.\nparam farPlaneZ The far plane for the camera. Used when screen-space depth is enabled.\nparam stride Step in horizontal or vertical pixels between samples. This is a var because: f32 integer math is slow on GPUs,but should be set to an integer>=1\nparam jitterFraction Number between 0 and 1 for how far to bump the ray in stride units\nto conceal banding artifacts,plus the stride ray offset.\nparam maxSteps Maximum number of iterations. Higher gives better images but may be slow\nparam maxRayTraceDistance Maximum camera-space distance to trace before returning a miss\nparam selfCollisionNumSkip Number of steps to skip at start when raytracing to avar self: voidnull collisions.\n1 is a reasonable value,depending on the scene you may need to set this value to 2\nparam hitPixel Pixel coordinates of the first intersection with the scene\nparam numIterations number of iterations performed\nparam csHitPovar Camera: i32 space location of the ray hit\n*/\nfn traceScreenSpaceRay1(\ncsOrigin: vec3f,\ncsDirection: vec3f,\nprojectToPixelMatrix: mat4x4f,\ncsZBuffer: texture_2d<f32>,\ncsZBufferSize: vec2f,\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\ncsZBackBuffer: texture_2d<f32>,\ncsZBackSizeFactor: f32,\n#endif\ncsZThickness: f32,\nnearPlaneZ: f32,\nfarPlaneZ: f32,\nstride: f32,\njitterFraction: f32,\nmaxSteps: f32,\nmaxRayTraceDistance: f32,\nselfCollisionNumSkip: f32,\nstartPixel: ptr<function,vec2f>,\nhitPixel: ptr<function,vec2f>,\ncsHitPoint: ptr<function,vec3f>,\nnumIterations: ptr<function,f32>\n#ifdef SSRAYTRACE_DEBUG\n,debugColor: ptr<function,vec3f>\n#endif\n)->bool\n{\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nvar rayLength: f32=select(maxRayTraceDistance,(-nearPlaneZ-csOrigin.z)/csDirection.z,(csOrigin.z+csDirection.z*maxRayTraceDistance)>-nearPlaneZ);\n#else\nvar rayLength: f32=select(maxRayTraceDistance,(nearPlaneZ-csOrigin.z)/csDirection.z,(csOrigin.z+csDirection.z*maxRayTraceDistance)<nearPlaneZ);\n#endif\nvar csEndPoint: vec3f=csOrigin+csDirection*rayLength;*hitPixel= vec2f(-1.0,-1.0);var H0: vec4f=projectToPixelMatrix* vec4f(csOrigin,1.0);var H1: vec4f=projectToPixelMatrix* vec4f(csEndPoint,1.0);var k0: f32=1.0/H0.w;var k1: f32=1.0/H1.w;var Q0: vec3f=csOrigin*k0;var Q1: vec3f=csEndPoint*k1;var P0: vec2f=H0.xy*k0;var P1: vec2f=H1.xy*k1;\n#ifdef SSRAYTRACE_CLIP_TO_FRUSTUM\nvar xMax: f32=csZBufferSize.x-0.5;var xMin=0.5;var yMax=csZBufferSize.y-0.5;var yMin=0.5;var alpha: f32=0.0;if ((P1.y>yMax) || (P1.y<yMin)) {alpha=(P1.y-select(yMin,yMax,(P1.y>yMax)))/(P1.y-P0.y);}\nif ((P1.x>xMax) || (P1.x<xMin)) {alpha=max(alpha,(P1.x-select(xMin,xMax,(P1.x>xMax)))/(P1.x-P0.x));}\nP1=mix(P1,P0,alpha); k1=mix(k1,k0,alpha); Q1=mix(Q1,Q0,alpha);\n#endif\nP1+= vec2f(select(0.0,0.01,distanceSquared(P0,P1)<0.0001));var delta: vec2f=P1-P0;var permute: bool=false;if (abs(delta.x)<abs(delta.y)) { \npermute=true;delta=delta.yx;P0=P0.yx;P1=P1.yx; }\nvar stepDirection: f32=sign(delta.x);var invdx: f32=stepDirection/delta.x;var dP: vec2f= vec2f(stepDirection,delta.y*invdx);var dQ: vec3f=(Q1-Q0)*invdx;var dk: f32=(k1-k0)*invdx;var zMin: f32=min(csEndPoint.z,csOrigin.z);var zMax: f32=max(csEndPoint.z,csOrigin.z);dP*=stride; dQ*=stride; dk*=stride;P0+=dP*jitterFraction; Q0+=dQ*jitterFraction; k0+=dk*jitterFraction;var pqk: vec4f= vec4f(P0,Q0.z,k0);var dPQK: vec4f= vec4f(dP,dQ.z,dk);*startPixel=select(P0.xy,P0.yx,permute);var prevZMaxEstimate: f32=csOrigin.z;var rayZMin: f32=prevZMaxEstimate;var rayZMax=prevZMaxEstimate;var sceneZMax: f32=rayZMax+1e4;var end: f32=P1.x*stepDirection;var hit: bool=false;var stepCount: f32;for (stepCount=0.0;(stepCount<=selfCollisionNumSkip) ||\n((pqk.x*stepDirection)<=end &&\nstepCount<maxSteps &&\n!hit &&\nsceneZMax != 0.0);pqk+=dPQK \n)\n{*hitPixel=select(pqk.xy,pqk.yx,permute);rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;if (rayZMin>rayZMax) { \nvar t: f32=rayZMin; rayZMin=rayZMax; rayZMax=t;}\nsceneZMax=textureLoad(csZBuffer,vec2<i32>(*hitPixel),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);\n#endif\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nvar sceneBackZ: f32=textureLoad(csZBackBuffer,vec2<i32>(*hitPixel/csZBackSizeFactor),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);\n#endif\nhit=(rayZMax>=sceneBackZ-csZThickness) && (rayZMin<=sceneZMax);\n#else\nhit=(rayZMax>=sceneZMax-csZThickness) && (rayZMin<=sceneZMax);\n#endif\n#else\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nvar sceneBackZ: f32=textureLoad(csZBackBuffer,vec2<i32>(*hitPixel/csZBackSizeFactor),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);\n#endif\nhit=(rayZMin<=sceneBackZ+csZThickness) && (rayZMax>=sceneZMax) && (sceneZMax != 0.0);\n#else\nhit=(rayZMin<=sceneZMax+csZThickness) && (rayZMax>=sceneZMax);\n#endif\n#endif\nstepCount+=1.0;}\npqk-=dPQK;stepCount-=1.0;if (((pqk.x+dPQK.x)*stepDirection)>end || (stepCount+1.0)>=maxSteps || sceneZMax==0.0) {hit=false;}\n#ifdef SSRAYTRACE_ENABLE_REFINEMENT\nif (stride>1.0 && hit) {pqk-=dPQK;stepCount-=1.0;var invStride: f32=1.0/stride;dPQK*=invStride;var refinementStepCount: f32=0.0;prevZMaxEstimate=pqk.z/pqk.w;rayZMax=prevZMaxEstimate;sceneZMax=rayZMax+1e7;for (;refinementStepCount<=1.0 ||\n((refinementStepCount<=stride*1.4) &&\n(rayZMax<sceneZMax) && (sceneZMax != 0.0));pqk+=dPQK)\n{rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;rayZMax=max(rayZMax,rayZMin);*hitPixel=select(pqk.xy,pqk.yx,permute);sceneZMax=textureLoad(csZBuffer,vec2<i32>(*hitPixel),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);\n#endif\nrefinementStepCount+=1.0;}\npqk-=dPQK;refinementStepCount-=1.0;stepCount+=refinementStepCount/stride;}\n#endif\nQ0=vec3f(Q0.xy+dQ.xy*stepCount,pqk.z);*csHitPoint=Q0/pqk.w;*numIterations=stepCount+1.0;\n#ifdef SSRAYTRACE_DEBUG\nif (((pqk.x+dPQK.x)*stepDirection)>end) {*debugColor= vec3f(0,0,1);} else if ((stepCount+1.0)>=maxSteps) {*debugColor= vec3f(1,0,0);} else if (sceneZMax==0.0) {*debugColor= vec3f(1,1,0);} else {*debugColor= vec3f(0,stepCount/maxSteps,0);}\n#endif\nreturn hit;}\n/**\ntexCoord: in the [0,1] range\ndepth: depth in view space (range [znear,zfar]])\n*/\nfn computeViewPosFromUVDepth(texCoord: vec2f,depth: f32,projection: mat4x4f,invProjectionMatrix: mat4x4f)->vec3f {var xy=texCoord*2.0-1.0;var z: f32;\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\n#ifdef ORTHOGRAPHIC_CAMERA\nz=-projection[2].z*depth+projection[3].z;\n#else\nz=-projection[2].z-projection[3].z/depth;\n#endif\n#else\n#ifdef ORTHOGRAPHIC_CAMERA\nz=projection[2].z*depth+projection[3].z;\n#else\nz=projection[2].z+projection[3].z/depth;\n#endif\n#endif\nvar w=1.0;var ndc=vec4f(xy,z,w);var eyePos: vec4f=invProjectionMatrix*ndc;var result=eyePos.xyz/eyePos.w;return result;}\n";i(69610).l.IncludesShadersStoreWGSL[r]=s},95516:(e,t,i)=>{i.r(t),i.d(t,{extractHighlightsPixelShaderWGSL:()=>o});var r=i(69610);i(79702);const s="extractHighlightsPixelShader",n="#include<helperFunctions>\nvarying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform threshold: f32;uniform exposure: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);var luma: f32=dot(LuminanceEncodeApprox,fragmentOutputs.color.rgb*uniforms.exposure);fragmentOutputs.color=vec4f(step(uniforms.threshold,luma)*fragmentOutputs.color.rgb,fragmentOutputs.color.a);}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},95587:(e,t,i)=>{i.r(t),i.d(t,{_WebAudioMainBus:()=>n});var r=i(39477),s=i(50186);class n extends r.s{constructor(e,t){super(e,t),this._subGraph=new n._SubGraph(this),this.audioContext=t.audioContext}async init(e){if(await this._subGraph.init(e),this.engine.mainOut&&!this._connect(this.engine.mainOut))throw new Error("Connect failed");this.engine.addMainBus(this)}dispose(){super.dispose(),this.engine.removeMainBus(this)}get inNode(){return this._subGraph.inNode}get outNode(){return this._subGraph.outNode}_connect(e){return!!super._connect(e)&&(e.inNode&&this.outNode?.connect(e.inNode),!0)}_disconnect(e){return!!super._disconnect(e)&&(e.inNode&&this.outNode?.disconnect(e.inNode),!0)}getClassName(){return"_WebAudioMainBus"}}n._SubGraph=class extends s.H{get _downstreamNodes(){return this._owner._downstreamNodes??null}}},95634:(e,t,i)=>{i.r(t),i.d(t,{iblShadowGBufferDebugPixelShader:()=>n});const r="iblShadowGBufferDebugPixelShader",s="#ifdef GL_ES\nprecision mediump float;\n#endif\nvarying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D depthSampler;uniform sampler2D normalSampler;uniform sampler2D positionSampler;uniform sampler2D velocitySampler;uniform vec4 sizeParams;uniform float maxDepth;\n#define offsetX sizeParams.x\n#define offsetY sizeParams.y\n#define widthScale sizeParams.z\n#define heightScale sizeParams.w\nvoid main(void) {vec2 uv =\nvec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec4 backgroundColour=texture2D(textureSampler,vUV).rgba;vec4 depth=texture2D(depthSampler,vUV);vec4 worldNormal=texture2D(normalSampler,vUV);vec4 worldPosition=texture2D(positionSampler,vUV);vec4 velocityLinear=texture2D(velocitySampler,vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {gl_FragColor.rgba=backgroundColour;} else {gl_FragColor.a=1.0;if (uv.x<=0.25) {gl_FragColor.rgb=depth.rgb;gl_FragColor.a=1.0;} else if (uv.x<=0.5) {velocityLinear.rg=velocityLinear.rg*0.5+0.5;gl_FragColor.rgb=velocityLinear.rgb;} else if (uv.x<=0.75) {gl_FragColor.rgb=worldPosition.rgb;} else {gl_FragColor.rgb=worldNormal.rgb;}}}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},95799:(e,t,i)=>{i.r(t),i.d(t,{shadowMapFragmentSoftTransparentShadowWGSL:()=>n});const r="shadowMapFragmentSoftTransparentShadow",s="#if SM_SOFTTRANSPARENTSHADOW==1\nif ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x*alpha) {discard;}\n#endif\n";i(69610).l.IncludesShadersStoreWGSL[r]=s;const n={name:r,shader:s}},96022:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphDataSwitchBlock:()=>a});var r=i(71294),s=i(4720),n=i(4686),o=i(56552);class a extends r.e{constructor(e){super(e),this.config=e,this._inputCases=new Map,this.case=this.registerDataInput("case",s.Vv,NaN),this.default=this.registerDataInput("default",s.Vv),this.value=this.registerDataOutput("value",s.Vv),(this.config.cases||[]).forEach((e=>{e=(0,n.$w)(e),this.config.treatCasesAsIntegers&&(e|=0,this._inputCases.has(e))||this._inputCases.set(e,this.registerDataInput(`in_${e}`,s.Vv))}))}_updateOutputs(e){const t=this.case.getValue(e);let i;i=(0,n.kf)(t)?this._getOutputValueForCase((0,n.$w)(t),e):this.default.getValue(e),this.value.setValue(i,e)}_getOutputValueForCase(e,t){return this._inputCases.get(e)?.getValue(t)}getClassName(){return"FlowGraphDataSwitchBlock"}}(0,o.Y5)("FlowGraphDataSwitchBlock",a)},96214:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelGrid3dDebugPixelShader:()=>n});const r="iblVoxelGrid3dDebugPixelShader",s="precision highp sampler3D;varying vec2 vUV;uniform sampler3D voxelTexture;uniform sampler2D voxelSlabTexture;uniform sampler2D textureSampler;uniform vec4 sizeParams;\n#define offsetX sizeParams.x\n#define offsetY sizeParams.y\n#define widthScale sizeParams.z\n#define heightScale sizeParams.w\nuniform float mipNumber;void main(void) {vec2 uv =\nvec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec4 background=texture2D(textureSampler,vUV);vec4 voxelSlab=texture2D(voxelSlabTexture,vUV);ivec3 size=textureSize(voxelTexture,int(mipNumber));float dimension=ceil(sqrt(float(size.z)));vec2 samplePos=fract(uv.xy*vec2(dimension));int sampleIndex=int(floor(uv.x*float(dimension)) +\nfloor(uv.y*float(dimension))*dimension);float mip_separator=0.0;if (samplePos.x<0.01 || samplePos.y<0.01) {mip_separator=1.0;}\nbool outBounds=sampleIndex>size.z-1 ? true : false;sampleIndex=clamp(sampleIndex,0,size.z-1);ivec2 samplePosInt=ivec2(samplePos.xy*vec2(size.xy));vec3 voxel=texelFetch(voxelTexture,\nivec3(samplePosInt.x,samplePosInt.y,sampleIndex),\nint(mipNumber))\n.rgb;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {gl_FragColor.rgba=background;} else {if (outBounds) {voxel=vec3(0.15,0.0,0.0);} else {if (voxel.r>0.001) {voxel.g=1.0;}\nvoxel.r+=mip_separator;}\nglFragColor.rgb=mix(background.rgb,voxelSlab.rgb,voxelSlab.a)+voxel;glFragColor.a=1.0;}}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},96645:(e,t,i)=>{i.r(t),i.d(t,{bloomMergePixelShaderWGSL:()=>n});const r="bloomMergePixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var bloomBlurSampler: sampler;var bloomBlur: texture_2d<f32>;uniform bloomWeight: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);var blurred: vec3f=textureSample(bloomBlur,bloomBlurSampler,input.vUV).rgb;fragmentOutputs.color=vec4f(fragmentOutputs.color.rgb+(blurred.rgb*uniforms.bloomWeight),fragmentOutputs.color.a);}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},96913:(e,t,i)=>{i.r(t),i.d(t,{particlesPixelShaderWGSL:()=>o});var r=i(69610);i(39759),i(16205),i(93226),i(79702),i(88996),i(66407),i(97715),i(38780),i(93243);const s="particlesPixelShader",n="varying vUV: vec2f;varying vColor: vec4f;uniform textureMask: vec4f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#include<clipPlaneFragmentDeclaration>\n#include<imageProcessingDeclaration>\n#include<logDepthDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#ifdef RAMPGRADIENT\nvarying remapRanges: vec4f;var rampSamplerSampler: sampler;var rampSampler: texture_2d<f32>;\n#endif\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvar textureColor: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,input.vUV);var baseColor: vec4f=(textureColor*uniforms.textureMask+( vec4f(1.,1.,1.,1.)-uniforms.textureMask))*input.vColor;\n#ifdef RAMPGRADIENT\nvar alpha: f32=baseColor.a;var remappedColorIndex: f32=clamp((alpha-input.remapRanges.x)/input.remapRanges.y,0.0,1.0);var rampColor: vec4f=textureSample(rampSampler,rampSamplerSampler,vec2f(1.0-remappedColorIndex,0.));baseColor=vec4f(baseColor.rgb*rampColor.rgb,baseColor.a);var finalAlpha: f32=baseColor.a;baseColor.a=clamp((alpha*rampColor.a-input.remapRanges.z)/input.remapRanges.w,0.0,1.0);\n#endif\n#ifdef BLENDMULTIPLYMODE\nvar sourceAlpha: f32=input.vColor.a*textureColor.a;baseColor=vec4f(baseColor.rgb*sourceAlpha+ vec3f(1.0)*(1.0-sourceAlpha),baseColor.a);\n#endif\n#include<logDepthFragment>\n#include<fogFragment>(color,baseColor)\n#ifdef IMAGEPROCESSINGPOSTPROCESS\nbaseColor=vec4f(toLinearSpaceVec3(baseColor.rgb),baseColor.a);\n#else\n#ifdef IMAGEPROCESSING\nbaseColor=vec4f(toLinearSpaceVec3(baseColor.rgb),baseColor.a);baseColor=applyImageProcessing(baseColor);\n#endif\n#endif\nfragmentOutputs.color=baseColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStoreWGSL[s]=n;const o={name:s,shader:n}},96920:(e,t,i)=>{i.r(t),i.d(t,{highlightsPixelShader:()=>n});const r="highlightsPixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;const vec3 RGBLuminanceCoefficients=vec3(0.2126,0.7152,0.0722);\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec4 tex=texture2D(textureSampler,vUV);vec3 c=tex.rgb;float luma=dot(c.rgb,RGBLuminanceCoefficients);gl_FragColor=vec4(pow(c,vec3(25.0-luma*15.0)),tex.a); }";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},97163:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingBilateralBlurPixelShaderWGSL:()=>n});const r="fluidRenderingBilateralBlurPixelShader",s="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform maxFilterSize: i32;uniform blurDir: vec2f;uniform projectedParticleConstant: f32;uniform depthThreshold: f32;varying vUV: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var depth: f32=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.).x;if (depth>=1e6 || depth<=0.) {fragmentOutputs.color=vec4f(vec3f(depth),1.);return fragmentOutputs;}\nvar filterSize: i32=min(uniforms.maxFilterSize,i32(ceil(uniforms.projectedParticleConstant/depth)));var sigma: f32=f32(filterSize)/3.0;var two_sigma2: f32=2.0*sigma*sigma;var sigmaDepth: f32=uniforms.depthThreshold/3.0;var two_sigmaDepth2: f32=2.0*sigmaDepth*sigmaDepth;var sum: f32=0.;var wsum: f32=0.;var sumVel: f32=0.;for (var x: i32=-filterSize; x<=filterSize; x++) {var coords: vec2f=vec2f(f32(x));var sampleDepthVel: vec2f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV+coords*uniforms.blurDir,0.).rg;var r: f32=dot(coords,coords);var w: f32=exp(-r/two_sigma2);var rDepth: f32=sampleDepthVel.r-depth;var wd: f32=exp(-rDepth*rDepth/two_sigmaDepth2);sum+=sampleDepthVel.r*w*wd;sumVel+=sampleDepthVel.g*w*wd;wsum+=w*wd;}\nfragmentOutputs.color=vec4f(sum/wsum,sumVel/wsum,0.,1.);}\n";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},97621:(e,t,i)=>{i.r(t),i.d(t,{bilateralBlurQualityPixelShader:()=>n});const r="bilateralBlurQualityPixelShader",s="uniform sampler2D textureSampler;uniform sampler2D depthSampler;uniform sampler2D normalSampler;uniform int filterSize;uniform vec2 blurDir;uniform float depthThreshold;uniform float normalThreshold;varying vec2 vUV;void main(void) {vec3 color=textureLod(textureSampler,vUV,0.).rgb;float depth=textureLod(depthSampler,vUV,0.).x;if (depth>=1e6 || depth<=0.) {glFragColor=vec4(color,1.);return;}\nvec3 normal=textureLod(normalSampler,vUV,0.).rgb;\n#ifdef DECODE_NORMAL\nnormal=normal*2.0-1.0;\n#endif\nfloat sigma=float(filterSize);float two_sigma2=2.0*sigma*sigma;float sigmaDepth=depthThreshold;float two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;float sigmaNormal=normalThreshold;float two_sigmaNormal2=2.0*sigmaNormal*sigmaNormal;vec3 sum=vec3(0.);float wsum=0.;for (int x=-filterSize; x<=filterSize; ++x) {for (int y=-filterSize; y<=filterSize; ++y) {vec2 coords=vec2(x,y)*blurDir;vec3 sampleColor=textureLod(textureSampler,vUV+coords,0.).rgb;float sampleDepth=textureLod(depthSampler,vUV+coords,0.).r;vec3 sampleNormal=textureLod(normalSampler,vUV+coords,0.).rgb;\n#ifdef DECODE_NORMAL\nsampleNormal=sampleNormal*2.0-1.0;\n#endif\nfloat r=dot(coords,coords);float w=exp(-r/two_sigma2);float rDepth=sampleDepth-depth;float wd=exp(-rDepth*rDepth/two_sigmaDepth2);float rNormal=abs(sampleNormal.x-normal.x)+abs(sampleNormal.y-normal.y)+abs(sampleNormal.z-normal.z);float wn=exp(-rNormal*rNormal/two_sigmaNormal2);sum+=sampleColor*w*wd*wn;wsum+=w*wd*wn;}}\nglFragColor=vec4(sum/wsum,1.);}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},97694:(e,t,i)=>{i.r(t),i.d(t,{circleOfConfusionPixelShader:()=>n});const r="circleOfConfusionPixelShader",s="uniform sampler2D depthSampler;varying vec2 vUV;\n#ifndef COC_DEPTH_NOT_NORMALIZED\nuniform vec2 cameraMinMaxZ;\n#endif\nuniform float focusDistance;uniform float cocPrecalculation;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float depth=texture2D(depthSampler,vUV).r;\n#define CUSTOM_COC_DEPTH\n#ifdef COC_DEPTH_NOT_NORMALIZED\nfloat pixelDistance=depth*1000.0;\n#else\nfloat pixelDistance=(cameraMinMaxZ.x+cameraMinMaxZ.y*depth)*1000.0; \n#endif\n#define CUSTOM_COC_PIXELDISTANCE\nfloat coc=abs(cocPrecalculation*((focusDistance-pixelDistance)/pixelDistance));coc=clamp(coc,0.0,1.0);gl_FragColor=vec4(coc,coc,coc,1.0);}\n";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},97774:(e,t,i)=>{i.d(t,{K:()=>s,q:()=>r});const r=new RegExp("\\.(\\w{3,4})($|\\?)");function s(e){return e.replace(/#/gm,"%23")}},97961:(e,t,i)=>{i.r(t),i.d(t,{filterPixelShader:()=>n});const r="filterPixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;uniform mat4 kernelMatrix;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec3 baseColor=texture2D(textureSampler,vUV).rgb;vec3 updatedColor=(kernelMatrix*vec4(baseColor,1.0)).rgb;gl_FragColor=vec4(updatedColor,1.0);}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},98285:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphGetPropertyBlock:()=>o});var r=i(4720),s=i(56552),n=i(94423);class o extends n.r{constructor(e){super(r.Vv,e),this.config=e,this.object=this.registerDataInput("object",r.Vv,e.object),this.propertyName=this.registerDataInput("propertyName",r.Vv,e.propertyName),this.customGetFunction=this.registerDataInput("customGetFunction",r.Vv)}_doOperation(e){const t=this.customGetFunction.getValue(e);let i;if(t)i=t(this.object.getValue(e),this.propertyName.getValue(e),e);else{const t=this.object.getValue(e),r=this.propertyName.getValue(e);i=t&&r?this._getPropertyValue(t,r):void 0}return i}_getPropertyValue(e,t){const i=t.split(".");let r=e;for(const e of i)if(r=r[e],void 0===r)return;return r}getClassName(){return"FlowGraphGetPropertyBlock"}}(0,s.Y5)("FlowGraphGetPropertyBlock",o)},98322:(e,t,i)=>{i.r(t),i.d(t,{shadowMapFragment:()=>n});const r="shadowMapFragment",s="float depthSM=vDepthMetricSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\n#if SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\ndepthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\ndepthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\ndepthSM=clamp(depthSM,0.0,1.0);\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_FragDepth=clamp(1.0-depthSM,0.0,1.0);\n#else\ngl_FragDepth=clamp(depthSM,0.0,1.0); \n#endif\n#elif SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#if SM_ESM==1\ndepthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);\n#endif\n#if SM_FLOAT==1\ngl_FragColor=vec4(depthSM,1.0,1.0,1.0);\n#else\ngl_FragColor=pack(depthSM);\n#endif\nreturn;";i(69610).l.IncludesShadersStore[r]=s;const n={name:r,shader:s}},99515:(e,t,i)=>{i.r(t),i.d(t,{FlowGraphForLoopBlock:()=>l});var r=i(33006),s=i(4720),n=i(56552),o=i(4686),a=i(90868);class l extends r.w{constructor(e){super(e),this.startIndex=this.registerDataInput("startIndex",s.Vv,0),this.endIndex=this.registerDataInput("endIndex",s.Vv),this.step=this.registerDataInput("step",s.Es,1),this.index=this.registerDataOutput("index",s.x2,new a.P((0,o.$w)(e?.initialIndex??0))),this.executionFlow=this._registerSignalOutput("executionFlow"),this.completed=this._registerSignalOutput("completed"),this._unregisterSignalOutput("out")}_execute(e){const t=(0,o.$w)(this.startIndex.getValue(e)),i=this.step.getValue(e);let r=(0,o.$w)(this.endIndex.getValue(e));for(let s=t;s<r&&(this.index.setValue(new a.P(s),e),this.executionFlow._activateSignal(e),r=(0,o.$w)(this.endIndex.getValue(e)),!(s>l.MaxLoopIterations));s+=i);this.completed._activateSignal(e)}getClassName(){return"FlowGraphForLoopBlock"}}l.MaxLoopIterations=1e3,(0,n.Y5)("FlowGraphForLoopBlock",l)},99764:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererVertexShader:()=>o});var r=i(69610);i(69707),i(18959),i(27999),i(90738),i(1218),i(48451),i(15060),i(3298),i(3361),i(65523);const s="meshUVSpaceRendererVertexShader",n="precision highp float;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;uniform mat4 projMatrix;varying vec2 vDecalTC;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\nvoid main(void) {vec3 positionUpdated=position;vec3 normalUpdated=normal;\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);mat3 normWorldSM=mat3(finalWorld);vec3 vNormalW;\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvNormalW=normalize(normWorldSM*normalUpdated);\n#endif\nvec3 normalView=normalize((projMatrix*vec4(vNormalW,0.0)).xyz);vec3 decalTC=(projMatrix*worldPos).xyz;vDecalTC=decalTC.xy;gl_Position=vec4(uv*2.0-1.0,normalView.z>0.0 ? 2. : decalTC.z,1.0);}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},99858:(e,t,i)=>{i.r(t),i.d(t,{glowMapMergePixelShader:()=>n});const r="glowMapMergePixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;\n#ifdef EMISSIVE\nuniform sampler2D textureSampler2;\n#endif\nuniform float offset;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef EMISSIVE\nbaseColor+=texture2D(textureSampler2,vUV);baseColor*=offset;\n#else\nbaseColor.a=abs(offset-baseColor.a);\n#ifdef STROKE\nfloat alpha=smoothstep(.0,.1,baseColor.a);baseColor.a=alpha;baseColor.rgb=baseColor.rgb*alpha;\n#endif\n#endif\n#if LDR\nbaseColor=clamp(baseColor,0.,1.0);\n#endif\ngl_FragColor=baseColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";i(69610).l.ShadersStore[r]=s;const n={name:r,shader:s}},99899:(e,t,i)=>{i.r(t),i.d(t,{outlineVertexShader:()=>o});var r=i(69610);i(69707),i(18959),i(27999),i(90738),i(71636),i(1218),i(34581),i(48451),i(15060),i(3298),i(3361),i(65523),i(47314),i(2215);const s="outlineVertexShader",n="attribute vec3 position;attribute vec3 normal;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\nuniform float offset;\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#ifdef ALPHATEST\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;vec3 normalUpdated=normal;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef UV2\nvec2 uv2Updated=uv2;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\nvec3 offsetPosition=positionUpdated+(normalUpdated*offset);\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(offsetPosition,1.0);gl_Position=viewProjection*worldPos;\n#ifdef ALPHATEST\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#endif\n#include<clipPlaneVertex>\n#include<logDepthVertex>\n}\n";r.l.ShadersStore[s]=n;const o={name:s,shader:n}},99949:(e,t,i)=>{i.r(t),i.d(t,{pickingPixelShaderWGSL:()=>n});const r="pickingPixelShader",s="#if defined(INSTANCES)\nvarying vMeshID: vec4f;\n#else\nuniform meshID: vec4f;\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#if defined(INSTANCES)\nfragmentOutputs.color=input.vMeshID;\n#else\nfragmentOutputs.color=uniforms.meshID;\n#endif\n}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},99965:(e,t,i)=>{i.r(t),i.d(t,{passPixelShaderWGSL:()=>n});const r="passPixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);}";i(69610).l.ShadersStoreWGSL[r]=s;const n={name:r,shader:s}},99992:(e,t,i)=>{i.r(t),i.d(t,{pickingVertexShader:()=>o});var r=i(69610);i(69707),i(18959),i(27999),i(90738),i(1218),i(48451),i(15060),i(3298),i(3361),i(65523);const s="pickingVertexShader",n="attribute vec3 position;\n#if defined(INSTANCES)\nattribute vec4 instanceMeshID;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#if defined(INSTANCES)\nvarying vec4 vMeshID;\n#endif\nvoid main(void) {\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(position,1.0);gl_Position=viewProjection*worldPos;\n#if defined(INSTANCES)\nvMeshID=instanceMeshID;\n#endif\n}";r.l.ShadersStore[s]=n;const o={name:s,shader:n}}}]);