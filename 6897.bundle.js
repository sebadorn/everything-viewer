"use strict";(self.webpackChunkeverything_viewer=self.webpackChunkeverything_viewer||[]).push([[6897],{89278:(t,e,n)=>{n.d(e,{EXT_mesh_gpu_instancing:()=>o});var a=n(79923),s=n(45316),r=n(37812);n(90203);const i="EXT_mesh_gpu_instancing";class o{constructor(t){this.name=i,this._loader=t,this.enabled=this._loader.isExtensionUsed(i)}dispose(){this._loader=null}loadNodeAsync(t,e,n){return s.BT.LoadExtensionAsync(t,e,this.name,((t,r)=>{this._loader._disableInstancedMesh++;const i=this._loader.loadNodeAsync(`/nodes/${e.index}`,e,n);if(this._loader._disableInstancedMesh--,!e._primitiveBabylonMeshes)return i;const o=new Array;let h=0;const f=e=>{if(null==r.attributes[e])return void o.push(Promise.resolve(null));const n=s.l2.Get(`${t}/attributes/${e}`,this._loader.gltf.accessors,r.attributes[e]);if(o.push(this._loader._loadFloatAccessorAsync(`/accessors/${n.bufferView}`,n)),0===h)h=n.count;else if(h!==n.count)throw new Error(`${t}/attributes: Instance buffer accessors do not have the same count.`)};return f("TRANSLATION"),f("ROTATION"),f("SCALE"),i.then((t=>Promise.all(o).then((([n,s,r])=>{const i=new Float32Array(16*h);a.AA.Vector3[0].copyFromFloats(0,0,0),a.AA.Quaternion[0].copyFromFloats(0,0,0,1),a.AA.Vector3[1].copyFromFloats(1,1,1);for(let t=0;t<h;++t)n&&a.Pq.FromArrayToRef(n,3*t,a.AA.Vector3[0]),s&&a.PT.FromArrayToRef(s,4*t,a.AA.Quaternion[0]),r&&a.Pq.FromArrayToRef(r,3*t,a.AA.Vector3[1]),a.uq.ComposeToRef(a.AA.Vector3[1],a.AA.Quaternion[0],a.AA.Vector3[0],a.AA.Matrix[0]),a.AA.Matrix[0].copyToArray(i,16*t);for(const t of e._primitiveBabylonMeshes)t.thinInstanceSetBuffer("matrix",i,16,!0);return t}))))}))}}(0,r.Hg)(i),(0,r.Ye)(i,!0,(t=>new o(t)))},90203:(t,e,n)=>{var a=n(76595),s=n(95616),r=n(79923),i=n(51137),o=n(20863);a.e.prototype.thinInstanceAdd=function(t,e=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return i.V.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(t)?t.length:1);const n=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(t))for(let n=0;n<t.length;++n)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,t[n],n===t.length-1&&e);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,t,e);return n},a.e.prototype.thinInstanceAddSelf=function(t=!0){return this.thinInstanceAdd(r.uq.IdentityReadOnly,t)},a.e.prototype.thinInstanceRegisterAttribute=function(t,e){t===s.R.ColorKind&&(t=s.R.ColorInstanceKind),this.removeVerticesData(t),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[t]=e,this._userThinInstanceBuffersStorage.sizes[t]=e*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[t]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[t]),this._userThinInstanceBuffersStorage.vertexBuffers[t]=new s.R(this.getEngine(),this._userThinInstanceBuffersStorage.data[t],t,!0,!1,e,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[t])},a.e.prototype.thinInstanceSetMatrixAt=function(t,e,n=!0){if(!this._thinInstanceDataStorage.matrixData||t>=this._thinInstanceDataStorage.instancesCount)return!1;const a=this._thinInstanceDataStorage.matrixData;return e.copyToArray(a,16*t),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[t]=e),n&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0},a.e.prototype.thinInstanceSetAttributeAt=function(t,e,n,a=!0){return t===s.R.ColorKind&&(t=s.R.ColorInstanceKind),!(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[t]||e>=this._thinInstanceDataStorage.instancesCount)&&(this._thinInstanceUpdateBufferSize(t,0),this._userThinInstanceBuffersStorage.data[t].set(n,e*this._userThinInstanceBuffersStorage.strides[t]),a&&this.thinInstanceBufferUpdated(t),!0)},Object.defineProperty(a.e.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(t){const e=this._thinInstanceDataStorage.matrixData??this.source?._thinInstanceDataStorage.matrixData;t<=(e?e.length/16:0)&&(this._thinInstanceDataStorage.instancesCount=t)},enumerable:!0,configurable:!0}),a.e.prototype._thinInstanceCreateMatrixBuffer=function(t,e,n=!0){const a=new s.h(this.getEngine(),e,!n,16,!1,!0);for(let e=0;e<4;e++)this.setVerticesBuffer(a.createVertexBuffer(t+e,4*e,4));return a},a.e.prototype.thinInstanceSetBuffer=function(t,e,n=0,a=!0){n=n||16,"matrix"===t?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=e?e.length:32*n,this._thinInstanceDataStorage.matrixData=e,this._thinInstanceDataStorage.worldMatrices=null,null!==e?(this._thinInstanceDataStorage.instancesCount=e.length/n,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",e,a),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):"previousMatrix"===t?(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=e,null!==e&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",e,a))):(t===s.R.ColorKind&&(t=s.R.ColorInstanceKind),null===e?this._userThinInstanceBuffersStorage?.data[t]&&(this.removeVerticesData(t),delete this._userThinInstanceBuffersStorage.data[t],delete this._userThinInstanceBuffersStorage.strides[t],delete this._userThinInstanceBuffersStorage.sizes[t],delete this._userThinInstanceBuffersStorage.vertexBuffers[t]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[t]=e,this._userThinInstanceBuffersStorage.strides[t]=n,this._userThinInstanceBuffersStorage.sizes[t]=e.length,this._userThinInstanceBuffersStorage.vertexBuffers[t]=new s.R(this.getEngine(),e,t,!a,!1,n,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[t])))},a.e.prototype.thinInstanceBufferUpdated=function(t){"matrix"===t?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.matrixBuffer&&!this._thinInstanceDataStorage.matrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(t),this._thinInstanceDataStorage.matrixBuffer?.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount)):"previousMatrix"===t?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.previousMatrixBuffer&&!this._thinInstanceDataStorage.previousMatrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(t),this._thinInstanceDataStorage.previousMatrixBuffer?.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount)):(t===s.R.ColorKind&&(t=s.R.ColorInstanceKind),this._userThinInstanceBuffersStorage?.vertexBuffers[t]&&(this.thinInstanceAllowAutomaticStaticBufferRecreation&&!this._userThinInstanceBuffersStorage.vertexBuffers[t].isUpdatable()&&this._thinInstanceRecreateBuffer(t),this._userThinInstanceBuffersStorage.vertexBuffers[t].updateDirectly(this._userThinInstanceBuffersStorage.data[t],0)))},a.e.prototype.thinInstancePartialBufferUpdate=function(t,e,n){"matrix"===t?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(e,n):(t===s.R.ColorKind&&(t=s.R.ColorInstanceKind),this._userThinInstanceBuffersStorage?.vertexBuffers[t]&&this._userThinInstanceBuffersStorage.vertexBuffers[t].updateDirectly(e,n))},a.e.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];const t=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=[];for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e)this._thinInstanceDataStorage.worldMatrices[e]=r.uq.FromArray(t,16*e)}return this._thinInstanceDataStorage.worldMatrices},a.e.prototype.thinInstanceRefreshBoundingInfo=function(t=!1,e=!1,n=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;const a=this._thinInstanceDataStorage.boundingVectors;if(t||!this.rawBoundingInfo){a.length=0,this.refreshBoundingInfo(e,n);const t=this.getBoundingInfo();this.rawBoundingInfo=new o.j(t.minimum,t.maximum)}const s=this.getBoundingInfo(),i=this._thinInstanceDataStorage.matrixData;if(0===a.length)for(let t=0;t<s.boundingBox.vectors.length;++t)a.push(s.boundingBox.vectors[t].clone());r.AA.Vector3[0].setAll(Number.POSITIVE_INFINITY),r.AA.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let t=0;t<this._thinInstanceDataStorage.instancesCount;++t){r.uq.FromArrayToRef(i,16*t,r.AA.Matrix[0]);for(let t=0;t<a.length;++t)r.Pq.TransformCoordinatesToRef(a[t],r.AA.Matrix[0],r.AA.Vector3[2]),r.AA.Vector3[0].minimizeInPlace(r.AA.Vector3[2]),r.AA.Vector3[1].maximizeInPlace(r.AA.Vector3[2])}s.reConstruct(r.AA.Vector3[0],r.AA.Vector3[1]),this._updateBoundingInfo()},a.e.prototype._thinInstanceRecreateBuffer=function(t,e=!0){"matrix"===t?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",this._thinInstanceDataStorage.matrixData,e)):"previousMatrix"===t?this._scene.needsPreviousWorldMatrices&&(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.previousMatrixData??this._thinInstanceDataStorage.matrixData,e)):(t===s.R.ColorKind&&(t=s.R.ColorInstanceKind),this._userThinInstanceBuffersStorage.vertexBuffers[t]?.dispose(),this._userThinInstanceBuffersStorage.vertexBuffers[t]=new s.R(this.getEngine(),this._userThinInstanceBuffersStorage.data[t],t,!e,!1,this._userThinInstanceBuffersStorage.strides[t],!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[t]))},a.e.prototype._thinInstanceUpdateBufferSize=function(t,e=1){t===s.R.ColorKind&&(t=s.R.ColorInstanceKind);const n="matrix"===t;if(!(n||this._userThinInstanceBuffersStorage&&this._userThinInstanceBuffersStorage.strides[t]))return;const a=n?16:this._userThinInstanceBuffersStorage.strides[t],r=n?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[t];let i=n?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[t];const o=(this._thinInstanceDataStorage.instancesCount+e)*a;let h=r;for(;h<o;)h*=2;if(!i||r!=h){if(i){const t=new Float32Array(h);t.set(i,0),i=t}else i=new Float32Array(h);n?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",i,!1),this._thinInstanceDataStorage.matrixData=i,this._thinInstanceDataStorage.matrixBufferSize=h,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",i,!1))):(this._userThinInstanceBuffersStorage.vertexBuffers[t]?.dispose(),this._userThinInstanceBuffersStorage.data[t]=i,this._userThinInstanceBuffersStorage.sizes[t]=h,this._userThinInstanceBuffersStorage.vertexBuffers[t]=new s.R(this.getEngine(),i,t,!0,!1,a,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[t]))}},a.e.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})},a.e.prototype._disposeThinInstanceSpecificData=function(){this._thinInstanceDataStorage?.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)}}}]);