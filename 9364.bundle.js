"use strict";(self.webpackChunkeverything_viewer=self.webpackChunkeverything_viewer||[]).push([[9364],{19364:(e,t,r)=>{r.d(t,{KHR_draco_mesh_compression:()=>_});var o=r(998),s=r(97573);function n(e,t,r,o,s){const n=e;let i=null,a=null,d=null;try{let e;i=new n.Decoder,a=new n.DecoderBuffer,a.Init(t,t.byteLength);const l=i.GetEncodedGeometryType(a);switch(l){case n.TRIANGULAR_MESH:{const t=new n.Mesh;if(e=i.DecodeBufferToMesh(a,t),!e.ok()||0===t.ptr)throw new Error(e.error_msg());const r=3*t.num_faces(),s=4*r,l=n._malloc(s);try{i.GetTrianglesUInt32Array(t,s,l);const e=new Uint32Array(r);e.set(new Uint32Array(n.HEAPF32.buffer,l,r)),o(e)}finally{n._free(l)}d=t;break}case n.POINT_CLOUD:{const t=new n.PointCloud;if(e=i.DecodeBufferToPointCloud(a,t),!e.ok()||!t.ptr)throw new Error(e.error_msg());d=t;break}default:throw new Error(`Invalid geometry type ${l}`)}const c=d.num_points(),u=(e,t,r,o)=>{const i=o.data_type(),a=o.num_components(),d=o.normalized(),l=o.byte_stride(),u=o.byte_offset(),f={[n.DT_FLOAT32]:{typedArrayConstructor:Float32Array,heap:n.HEAPF32},[n.DT_INT8]:{typedArrayConstructor:Int8Array,heap:n.HEAP8},[n.DT_INT16]:{typedArrayConstructor:Int16Array,heap:n.HEAP16},[n.DT_INT32]:{typedArrayConstructor:Int32Array,heap:n.HEAP32},[n.DT_UINT8]:{typedArrayConstructor:Uint8Array,heap:n.HEAPU8},[n.DT_UINT16]:{typedArrayConstructor:Uint16Array,heap:n.HEAPU16},[n.DT_UINT32]:{typedArrayConstructor:Uint32Array,heap:n.HEAPU32}}[i];if(!f)throw new Error(`Invalid data type ${i}`);const m=c*a,y=m*f.typedArrayConstructor.BYTES_PER_ELEMENT,h=n._malloc(y);try{e.GetAttributeDataArrayForAllPoints(t,o,i,y,h);const n=new f.typedArrayConstructor(f.heap.buffer,h,m);s(r,n.slice(),a,u,l,d)}finally{n._free(h)}};if(r)for(const e in r){const t=r[e],o=i.GetAttributeByUniqueId(d,t);u(i,d,e,o)}else{const e={position:n.POSITION,normal:n.NORMAL,color:n.COLOR,uv:n.TEX_COORD};for(const t in e){const r=i.GetAttributeId(d,e[t]);if(-1!==r){const e=i.GetAttribute(d,r);u(i,d,t,e)}}}return c}finally{d&&n.destroy(d),a&&n.destroy(a),i&&n.destroy(i)}}function i(){let e;onmessage=t=>{const r=t.data;switch(r.id){case"init":{r.url&&importScripts(r.url);const t=r.wasmBinary?{wasmBinary:r.wasmBinary}:{};e=DracoDecoderModule(t),postMessage({id:"initDone"});break}case"decodeMesh":if(!e)throw new Error("Draco decoder module is not available");e.then(e=>{const t=n(e,r.dataView,r.attributes,e=>{postMessage({id:"indices",data:e},[e.buffer])},(e,t,r,o,s,n)=>{postMessage({id:"attribute",kind:e,data:t,size:r,byteOffset:o,byteStride:s,normalized:n},[t.buffer])});postMessage({id:"decodeMeshDone",totalVertices:t})})}}}class a{constructor(e){if(e.workerPool)return void(this._workerPoolPromise=Promise.resolve(e.workerPool));const t=e.wasmBinary,r=e.numWorkers??("object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1),n=r&&"function"==typeof Worker&&"function"==typeof URL,i=n||!e.jsModule,a=e.wasmUrl&&e.wasmBinaryUrl&&"object"==typeof WebAssembly?{url:i?o.S0.GetBabylonScriptURL(e.wasmUrl,!0):"",wasmBinaryPromise:t?Promise.resolve(t):o.S0.LoadFileAsync(o.S0.GetBabylonScriptURL(e.wasmBinaryUrl,!0))}:{url:i?o.S0.GetBabylonScriptURL(e.fallbackUrl):"",wasmBinaryPromise:Promise.resolve(void 0)};n?this._workerPoolPromise=a.wasmBinaryPromise.then(e=>{const t=this._getWorkerContent(),o=URL.createObjectURL(new Blob([t],{type:"application/javascript"}));return new s.h(r,()=>async function(e,t,r){return await new Promise((o,s)=>{const n=t=>{e.removeEventListener("error",n),e.removeEventListener("message",i),s(t)},i=t=>{"initDone"===t.data.id&&(e.removeEventListener("error",n),e.removeEventListener("message",i),o(e))};if(e.addEventListener("error",n),e.addEventListener("message",i),t){const o=t.slice(0);e.postMessage({id:"init",url:r,wasmBinary:o},[o])}else e.postMessage({id:"init",url:r})})}(new Worker(o),e,a.url))}):this._modulePromise=a.wasmBinaryPromise.then(async t=>{if(!this._isModuleAvailable()&&!e.jsModule){if(!a.url)throw new Error("Draco codec module is not available");await o.S0.LoadBabylonScriptAsync(a.url)}return await this._createModuleAsync(t,e.jsModule)})}async whenReadyAsync(){this._workerPoolPromise?await this._workerPoolPromise:this._modulePromise&&await this._modulePromise}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then(e=>{e.dispose()}),delete this._workerPoolPromise,delete this._modulePromise}}var d=r(27050),l=r(56608),c=r(51137);class u extends a{static get DefaultAvailable(){return!!((e=u.DefaultConfiguration).wasmUrl&&(e.wasmBinary||e.wasmBinaryUrl)&&"object"==typeof WebAssembly||e.fallbackUrl);var e}static get Default(){return u._Default??(u._Default=new u),u._Default}static ResetDefault(e){u._Default&&(e||u._Default.dispose(),u._Default=null)}_isModuleAvailable(){return"undefined"!=typeof DracoDecoderModule}async _createModuleAsync(e,t){return{module:await(t||DracoDecoderModule)({wasmBinary:e})}}_getWorkerContent(){return`${n}(${i})()`}constructor(e=u.DefaultConfiguration){super(e)}decodeMeshToMeshDataAsync(e,t,r){const o=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e.buffer,e.byteOffset,e.byteLength);if(this._workerPoolPromise)return this._workerPoolPromise.then(async e=>await new Promise((s,n)=>{e.push((e,i)=>{let a=null;const d=[],l=t=>{e.removeEventListener("error",l),e.removeEventListener("message",u),n(t),i()},u=t=>{const o=t.data;switch(o.id){case"indices":a=o.data;break;case"attribute":d.push({kind:o.kind,data:o.data,size:o.size,byteOffset:o.byteOffset,byteStride:o.byteStride,normalized:(n=o.kind,f=o.normalized,r&&void 0!==r[n]?(f!==r[n]&&c.V.Warn(`Normalized flag from Draco data (${f}) does not match normalized flag from glTF accessor (${r[n]}). Using flag from glTF accessor.`),r[n]):f)});break;case"decodeMeshDone":e.removeEventListener("error",l),e.removeEventListener("message",u),s({indices:a,attributes:d,totalVertices:o.totalVertices}),i()}var n,f};e.addEventListener("error",l),e.addEventListener("message",u);const f=o.slice();e.postMessage({id:"decodeMesh",dataView:f,attributes:t},[f.buffer])})}));if(this._modulePromise)return this._modulePromise.then(e=>{let r=null;const s=[],i=n(e.module,o,t,e=>{r=e},(e,t,r,o,n,i)=>{s.push({kind:e,data:t,size:r,byteOffset:o,byteStride:n,normalized:i})});return{indices:r,attributes:s,totalVertices:i}});throw new Error("Draco decoder module is not available")}async decodeMeshToGeometryAsync(e,t,r,o){const s=await this.decodeMeshToMeshDataAsync(r,o),n=new d.V(e,t);s.indices&&n.setIndices(s.indices);for(const e of s.attributes)n.setVerticesBuffer(new l.R(t.getEngine(),e.data,e.kind,!1,void 0,e.byteStride,void 0,e.byteOffset,e.size,void 0,e.normalized,!0),s.totalVertices);return n}async _decodeMeshToGeometryForGltfAsync(e,t,r,o,s,n){const i=await this.decodeMeshToMeshDataAsync(r,o,s),a=new d.V(e,t);n&&(a._boundingInfo=n,a.useBoundingInfoFromGeometry=!0),i.indices&&a.setIndices(i.indices);for(const e of i.attributes)a.setVerticesBuffer(new l.R(t.getEngine(),e.data,e.kind,!1,void 0,e.byteStride,void 0,e.byteOffset,e.size,void 0,e.normalized,!0),i.totalVertices);return a}}u.DefaultConfiguration={wasmUrl:`${o.S0._DefaultCdnUrl}/draco_wasm_wrapper_gltf.js`,wasmBinaryUrl:`${o.S0._DefaultCdnUrl}/draco_decoder_gltf.wasm`,fallbackUrl:`${o.S0._DefaultCdnUrl}/draco_decoder_gltf.js`},u._Default=null;var f=r(95616),m=r(98556),y=r(37812);const h="KHR_draco_mesh_compression";class _{constructor(e){this.name=h,this.useNormalizedFlagFromAccessor=!0,this._loader=e,this.enabled=u.DefaultAvailable&&this._loader.isExtensionUsed(h)}dispose(){delete this.dracoDecoder,this._loader=null}_loadVertexDataAsync(e,t,r){return m.BT.LoadExtensionAsync(e,t,this.name,async(o,s)=>{if(null!=t.mode&&4!==t.mode&&5!==t.mode)throw new Error(`${e}: Unsupported mode ${t.mode}`);const n={},i={},a=(e,o)=>{const a=s.attributes[e];if(null!=a&&(r._delayInfo=r._delayInfo||[],-1===r._delayInfo.indexOf(o)&&r._delayInfo.push(o),n[o]=a,this.useNormalizedFlagFromAccessor)){const r=m.l2.TryGet(this._loader.gltf.accessors,t.attributes[e]);r&&(i[o]=r.normalized||!1)}};a("POSITION",f.R.PositionKind),a("NORMAL",f.R.NormalKind),a("TANGENT",f.R.TangentKind),a("TEXCOORD_0",f.R.UVKind),a("TEXCOORD_1",f.R.UV2Kind),a("TEXCOORD_2",f.R.UV3Kind),a("TEXCOORD_3",f.R.UV4Kind),a("TEXCOORD_4",f.R.UV5Kind),a("TEXCOORD_5",f.R.UV6Kind),a("JOINTS_0",f.R.MatricesIndicesKind),a("WEIGHTS_0",f.R.MatricesWeightsKind),a("COLOR_0",f.R.ColorKind);const d=m.l2.Get(o,this._loader.gltf.bufferViews,s.bufferView);return d._dracoBabylonGeometry||(d._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${d.index}`,d).then(async o=>{const s=this.dracoDecoder||u.Default,a=m.l2.TryGet(this._loader.gltf.accessors,t.attributes.POSITION),d=this._loader.parent.alwaysComputeBoundingBox||r.skeleton||!a?null:(0,m.dM)(a);return await s._decodeMeshToGeometryForGltfAsync(r.name,this._loader.babylonScene,o,n,i,d).catch(t=>{throw new Error(`${e}: ${t.message}`)})})),await d._dracoBabylonGeometry})}}(0,y.Hg)(h),(0,y.Ye)(h,!0,e=>new _(e))},56608:(e,t,r)=>{r.d(t,{R:()=>o.R});var o=r(95616)},97573:(e,t,r)=>{r.d(t,{h:()=>s});class o{constructor(e){this._pendingActions=new Array,this._workerInfos=e.map(e=>({workerPromise:Promise.resolve(e),idle:!0}))}dispose(){for(const e of this._workerInfos)e.workerPromise.then(e=>{e.terminate()});this._workerInfos.length=0,this._pendingActions.length=0}push(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e)}_executeOnIdleWorker(e){for(const t of this._workerInfos)if(t.idle)return this._execute(t,e),!0;return!1}_execute(e,t){e.idle=!1,e.workerPromise.then(r=>{t(r,()=>{const t=this._pendingActions.shift();t?this._execute(e,t):e.idle=!0})})}}class s extends o{constructor(e,t,r=s.DefaultOptions){super([]),this._maxWorkers=e,this._createWorkerAsync=t,this._options=r}push(e){if(!this._executeOnIdleWorker(e))if(this._workerInfos.length<this._maxWorkers){const t={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(t),this._execute(t,e)}else this._pendingActions.push(e)}_execute(e,t){e.timeoutId&&(clearTimeout(e.timeoutId),delete e.timeoutId),super._execute(e,(r,o)=>{t(r,()=>{o(),e.idle&&(e.timeoutId=setTimeout(()=>{e.workerPromise.then(e=>{e.terminate()});const t=this._workerInfos.indexOf(e);-1!==t&&this._workerInfos.splice(t,1)},this._options.idleTimeElapsedBeforeRelease))})})}}s.DefaultOptions={idleTimeElapsedBeforeRelease:1e3}}}]);