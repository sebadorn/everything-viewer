"use strict";(self.webpackChunkeverything_viewer=self.webpackChunkeverything_viewer||[]).push([[3486],{13486:(e,t,r)=>{r.r(t);var n=r(90854),i=r(51137),a=r(77008);a.ThinEngine.prototype.restoreSingleAttachment=function(){const e=this._gl;this.bindAttachments([e.BACK])},a.ThinEngine.prototype.restoreSingleAttachmentForRenderTarget=function(){const e=this._gl;this.bindAttachments([e.COLOR_ATTACHMENT0])},a.ThinEngine.prototype.buildTextureLayout=function(e,t=!1){const r=this._gl,n=[];if(t)n.push(r.BACK);else for(let t=0;t<e.length;t++)e[t]?n.push(r["COLOR_ATTACHMENT"+t]):n.push(r.NONE);return n},a.ThinEngine.prototype.bindAttachments=function(e){this._gl.drawBuffers(e)},a.ThinEngine.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t=!1,r){this._currentRenderTarget=null,e.disableAutomaticMSAAResolve||this.resolveMultiFramebuffer(e),t||this.generateMipMapsMultiFramebuffer(e),r&&(e._MSAAFramebuffer&&this._bindUnboundFramebuffer(e._framebuffer),r()),this._bindUnboundFramebuffer(null)},a.ThinEngine.prototype.createMultipleRenderTarget=function(e,t,r=!0){let a,s=!1,u=!0,f=!1,T=!1,_=1,l=1;let h=[],o=[],E=[],p=[],d=[],m=[],b=[],c=[],A=[],g=!1;const R=this._createHardwareRenderTargetWrapper(!0,!1,e);void 0!==t&&(s=void 0!==t.generateMipMaps&&t.generateMipMaps,u=void 0===t.generateDepthBuffer||t.generateDepthBuffer,f=void 0!==t.generateStencilBuffer&&t.generateStencilBuffer,T=void 0!==t.generateDepthTexture&&t.generateDepthTexture,_=t.textureCount??1,l=t.samples??l,h=t.types||h,o=t.samplingModes||o,E=t.useSRGBBuffers||E,p=t.formats||p,d=t.targetTypes||d,m=t.faceIndex||m,b=t.layerIndex||b,c=t.layerCounts||c,A=t.labels||A,g=t.dontCreateTextures??!1,this.webGLVersion>1&&(13===t.depthTextureFormat||17===t.depthTextureFormat||16===t.depthTextureFormat||14===t.depthTextureFormat||18===t.depthTextureFormat)&&(a=t.depthTextureFormat)),void 0===a&&(a=f?13:14);const M=this._gl,F=this._currentFramebuffer,S=M.createFramebuffer();this._bindUnboundFramebuffer(S);const D=e.width??e,x=e.height??e,C=[],B=[],N=this.webGLVersion>1&&(13===a||17===a||18===a);R.label=t?.label??"MultiRenderTargetWrapper",R._framebuffer=S,R._generateDepthBuffer=T||u,R._generateStencilBuffer=T?N:f,R._depthStencilBuffer=this._setupFramebufferDepthAttachments(R._generateStencilBuffer,R._generateDepthBuffer,D,x,1,a),R._attachments=B;for(let e=0;e<_;e++){let t=o[e]||3,r=h[e]||0,a=E[e]||false;const u=p[e]||5,f=d[e]||3553,T=c[e]??1;(1!==r||this._caps.textureFloatLinearFiltering)&&(2!==r||this._caps.textureHalfFloatLinearFiltering)||(t=1);const _=this._getSamplingParameters(t,s);1!==r||this._caps.textureFloat||(r=0,i.V.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),a=a&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);const l=this.webGLVersion>1,m=M[l?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"];if(B.push(m),-1===f||g)continue;const b=new n.h(this,6);C[e]=b,M.activeTexture(M["TEXTURE"+e]),M.bindTexture(f,b._hardwareTexture.underlyingResource),M.texParameteri(f,M.TEXTURE_MAG_FILTER,_.mag),M.texParameteri(f,M.TEXTURE_MIN_FILTER,_.min),M.texParameteri(f,M.TEXTURE_WRAP_S,M.CLAMP_TO_EDGE),M.texParameteri(f,M.TEXTURE_WRAP_T,M.CLAMP_TO_EDGE);const F=this._getRGBABufferInternalSizedFormat(r,u,a),S=this._getInternalFormat(u),N=this._getWebGLTextureType(r);if(!l||35866!==f&&32879!==f)if(34067===f){for(let e=0;e<6;e++)M.texImage2D(M.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,F,D,x,0,S,N,null);b.isCube=!0}else M.texImage2D(M.TEXTURE_2D,0,F,D,x,0,S,N,null);else 35866===f?b.is2DArray=!0:b.is3D=!0,b.baseDepth=b.depth=T,M.texImage3D(f,0,F,D,x,T,0,S,N,null);s&&M.generateMipmap(f),this._bindTextureDirectly(f,null),b.baseWidth=D,b.baseHeight=x,b.width=D,b.height=x,b.isReady=!0,b.samples=1,b.generateMipMaps=s,b.samplingMode=t,b.type=r,b._useSRGBBuffer=a,b.format=u,b.label=A[e]??R.label+"-Texture"+e,this._internalTexturesCache.push(b)}if(T&&this._caps.depthTextureExtension&&!g){const e=new n.h(this,14);let t=5,r=M.DEPTH_COMPONENT16,i=M.DEPTH_COMPONENT,u=M.UNSIGNED_SHORT,f=M.DEPTH_ATTACHMENT;this.webGLVersion<2?r=M.DEPTH_COMPONENT:14===a?(t=1,u=M.FLOAT,r=M.DEPTH_COMPONENT32F):18===a?(t=0,u=M.FLOAT_32_UNSIGNED_INT_24_8_REV,r=M.DEPTH32F_STENCIL8,i=M.DEPTH_STENCIL,f=M.DEPTH_STENCIL_ATTACHMENT):16===a?(t=0,u=M.UNSIGNED_INT,r=M.DEPTH_COMPONENT24,f=M.DEPTH_ATTACHMENT):13!==a&&17!==a||(t=12,u=M.UNSIGNED_INT_24_8,r=M.DEPTH24_STENCIL8,i=M.DEPTH_STENCIL,f=M.DEPTH_STENCIL_ATTACHMENT),this._bindTextureDirectly(M.TEXTURE_2D,e,!0),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MAG_FILTER,M.NEAREST),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MIN_FILTER,M.NEAREST),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_WRAP_S,M.CLAMP_TO_EDGE),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_WRAP_T,M.CLAMP_TO_EDGE),M.texImage2D(M.TEXTURE_2D,0,r,D,x,0,i,u,null),M.framebufferTexture2D(M.FRAMEBUFFER,f,M.TEXTURE_2D,e._hardwareTexture.underlyingResource,0),this._bindTextureDirectly(M.TEXTURE_2D,null),R._depthStencilTexture=e,R._depthStencilTextureWithStencil=N,e.baseWidth=D,e.baseHeight=x,e.width=D,e.height=x,e.isReady=!0,e.samples=1,e.generateMipMaps=s,e.samplingMode=1,e.format=a,e.type=t,e.label=R.label+"-DepthStencil",C[_]=e,this._internalTexturesCache.push(e)}if(R.setTextures(C),r&&M.drawBuffers(B),this._bindUnboundFramebuffer(F),R.setLayerAndFaceIndices(b,m),this.resetTextureCache(),g){if(l>1){const e=M.createFramebuffer();if(!e)throw new Error("Unable to create multi sampled framebuffer");R._samples=l,R._MSAAFramebuffer=e,_>0&&r&&(this._bindUnboundFramebuffer(e),M.drawBuffers(B),this._bindUnboundFramebuffer(F))}}else this.updateMultipleRenderTargetTextureSampleCount(R,l,r);return R},a.ThinEngine.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t,r=!0){if(this.webGLVersion<2||!e)return 1;if(e.samples===t)return t;const n=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples),e._depthStencilBuffer&&(n.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(n.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null);const i=e._attachments.length;for(let t=0;t<i;t++){const r=e.textures[t]._hardwareTexture;r?.releaseMSAARenderBuffers()}if(t>1&&"function"==typeof n.renderbufferStorageMultisample){const a=n.createFramebuffer();if(!a)throw new Error("Unable to create multi sampled framebuffer");e._MSAAFramebuffer=a,this._bindUnboundFramebuffer(a);const s=[];for(let r=0;r<i;r++){const i=e.textures[r],a=i._hardwareTexture,u=n[this.webGLVersion>1?"COLOR_ATTACHMENT"+r:"COLOR_ATTACHMENT"+r+"_WEBGL"],f=this._createRenderBuffer(i.width,i.height,t,-1,this._getRGBABufferInternalSizedFormat(i.type,i.format,i._useSRGBBuffer),u);if(!f)throw new Error("Unable to create multi sampled framebuffer");a.addMSAARenderBuffer(f),i.samples=t,s.push(u)}r&&n.drawBuffers(s)}else this._bindUnboundFramebuffer(e._framebuffer);const a=e._depthStencilTexture?e._depthStencilTexture.format:void 0;return e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.width,e.height,t,a),this._bindUnboundFramebuffer(null),e._samples=t,t},a.ThinEngine.prototype.generateMipMapsMultiFramebuffer=function(e){const t=e,r=this._gl;if(t.isMulti)for(let e=0;e<t._attachments.length;e++){const n=t.textures[e];!n?.generateMipMaps||n?.isCube||n?.is3D||(this._bindTextureDirectly(r.TEXTURE_2D,n,!0),r.generateMipmap(r.TEXTURE_2D),this._bindTextureDirectly(r.TEXTURE_2D,null))}},a.ThinEngine.prototype.resolveMultiFramebuffer=function(e){const t=e,r=this._gl;if(!t._MSAAFramebuffer||!t.isMulti)return;let n=t.resolveMSAAColors?r.COLOR_BUFFER_BIT:0;n|=t._generateDepthBuffer&&t.resolveMSAADepth?r.DEPTH_BUFFER_BIT:0,n|=t._generateStencilBuffer&&t.resolveMSAAStencil?r.STENCIL_BUFFER_BIT:0;const i=t._attachments,a=i.length;r.bindFramebuffer(r.READ_FRAMEBUFFER,t._MSAAFramebuffer),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,t._framebuffer);for(let e=0;e<a;e++){const s=t.textures[e];for(let e=0;e<a;e++)i[e]=r.NONE;i[e]=r[this.webGLVersion>1?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"],r.readBuffer(i[e]),r.drawBuffers(i),r.blitFramebuffer(0,0,s.width,s.height,0,0,s.width,s.height,n,r.NEAREST)}for(let e=0;e<a;e++)i[e]=r[this.webGLVersion>1?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"];r.drawBuffers(i),r.bindFramebuffer(this._gl.FRAMEBUFFER,t._MSAAFramebuffer)}}}]);