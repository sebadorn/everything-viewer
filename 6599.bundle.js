"use strict";(self.webpackChunkeverything_viewer=self.webpackChunkeverything_viewer||[]).push([[6599],{59535:(e,t,n)=>{n.d(t,{A:()=>i});var r=n(49313),a=n(53871);const o=new r.R("imageRetrievalPool");o.setMaxSimultaneousRequests(a.A.Interaction,200),o.setMaxSimultaneousRequests(a.A.Thumbnail,200),o.setMaxSimultaneousRequests(a.A.Prefetch,200),o.grabDelay=0;const i=o},66599:(e,t,n)=>{n.r(t),n.d(t,{constants:()=>r,convertColorSpace:()=>be,convertPALETTECOLOR:()=>f,convertRGBColorByPixel:()=>a,convertRGBColorByPlane:()=>o,convertYBRFullByPixel:()=>i,convertYBRFullByPlane:()=>s,createImage:()=>Ne,decodeImageFrame:()=>wt.p,decodeJPEGBaseline8BitColor:()=>Ae,default:()=>Ct,getImageFrame:()=>Te,getMinMax:()=>Se.A,getPixelData:()=>mt,init:()=>Dt,internal:()=>G,isColorImage:()=>we.A,isJPEGBaseline8BitColor:()=>_t,wadors:()=>bt,wadouri:()=>$e});var r={};function a(e,t,n){if(void 0===e)throw new Error("decodeRGB: rgbBuffer must be defined");if(e.length%3!=0)throw new Error(`decodeRGB: rgbBuffer length ${e.length} must be divisible by 3`);const r=e.length/3;let a=0,o=0;if(n)for(let n=0;n<r;n++)t[o++]=e[a++],t[o++]=e[a++],t[o++]=e[a++],t[o++]=255;else t.set(e)}function o(e,t,n){if(void 0===e)throw new Error("decodeRGB: rgbBuffer must be defined");if(e.length%3!=0)throw new Error(`decodeRGB: rgbBuffer length ${e.length} must be divisible by 3`);const r=e.length/3;let a=0,o=0,i=r,s=2*r;if(n)for(let n=0;n<r;n++)t[a++]=e[o++],t[a++]=e[i++],t[a++]=e[s++],t[a++]=255;else for(let n=0;n<r;n++)t[a++]=e[o++],t[a++]=e[i++],t[a++]=e[s++]}function i(e,t,n){if(void 0===e)throw new Error("convertYBRFullByPixel: ybrBuffer must be defined");if(e.length%3!=0)throw new Error(`convertYBRFullByPixel: ybrBuffer length ${e.length} must be divisible by 3`);const r=e.length/3;let a=0,o=0;if(n)for(let n=0;n<r;n++){const n=e[a++],r=e[a++],i=e[a++];t[o++]=n+1.402*(i-128),t[o++]=n-.34414*(r-128)-.71414*(i-128),t[o++]=n+1.772*(r-128),t[o++]=255}else for(let n=0;n<r;n++){const n=e[a++],r=e[a++],i=e[a++];t[o++]=n+1.402*(i-128),t[o++]=n-.34414*(r-128)-.71414*(i-128),t[o++]=n+1.772*(r-128)}}function s(e,t,n){if(void 0===e)throw new Error("convertYBRFullByPlane: ybrBuffer must be defined");if(e.length%3!=0)throw new Error(`convertYBRFullByPlane: ybrBuffer length ${e.length} must be divisible by 3`);const r=e.length/3;let a=0,o=0,i=r,s=2*r;if(n)for(let n=0;n<r;n++){const n=e[o++],r=e[i++],l=e[s++];t[a++]=n+1.402*(l-128),t[a++]=n-.34414*(r-128)-.71414*(l-128),t[a++]=n+1.772*(r-128),t[a++]=255}else for(let n=0;n<r;n++){const n=e[o++],r=e[i++],l=e[s++];t[a++]=n+1.402*(l-128),t[a++]=n-.34414*(r-128)-.71414*(l-128),t[a++]=n+1.772*(r-128)}}n.r(r),n.d(r,{transferSyntaxes:()=>Tt});var l=n(74374);function c(e,t){const n=e.length,r=new Uint8ClampedArray(n);for(let a=0;a<n;++a)r[a]=e[a]>>t;return r}function u(e,t,n){const r=e[`${t}PaletteColorLookupTableData`];if(r)return Promise.resolve(r);const a=l.get("imagePixelModule",e.imageId);return a&&"function"==typeof a.then?a.then(e=>e?e[`${t}PaletteColorLookupTableData`]:n):Promise.resolve(a?a[`${t}PaletteColorLookupTableData`]:n)}function f(e,t,n){const r=e.columns*e.rows,a=e.pixelData;Promise.all([u(e,"red",null),u(e,"green",null),u(e,"blue",null)]).then(([o,i,s])=>{if(!o||!i||!s)throw new Error("The image does not have a complete color palette. R, G, and B palette data are required.");const l=o.length;let u=0,f=0;const d=e.redPaletteColorLookupTableDescriptor[1],m=8===e.redPaletteColorLookupTableDescriptor[2]?0:8,g=c(o,m),p=c(i,m),h=c(s,m);if(n)for(let e=0;e<r;++e){let e=a[u++];e<d?e=0:e>d+l-1?e=l-1:e-=d,t[f++]=g[e],t[f++]=p[e],t[f++]=h[e],t[f++]=255}else for(let e=0;e<r;++e){let e=a[u++];e<d?e=0:e>d+l-1?e=l-1:e-=d,t[f++]=g[e],t[f++]=p[e],t[f++]=h[e]}})}function d(e,t){if(e.elements[t]&&6===e.elements[t].length)return[e.uint16(t,0),e.uint16(t,1),e.uint16(t,2)]}function m(e,t,n){const r=[],a=e.elements[t];for(let o=0;o<n[0];o++)16===n[2]?r[o]=e.uint16(t,o):r[o]=e.byteArray[o+a.dataOffset];return r}const g=function(e){const t={samplesPerPixel:e.uint16("x00280002"),photometricInterpretation:e.string("x00280004"),rows:e.uint16("x00280010"),columns:e.uint16("x00280011"),bitsAllocated:e.uint16("x00280100"),bitsStored:e.uint16("x00280101"),highBit:e.uint16("x00280102"),pixelRepresentation:e.uint16("x00280103"),planarConfiguration:e.uint16("x00280006"),pixelAspectRatio:e.string("x00280034")};return function(e,t){0===e.uint16("x00280103")?(t.smallestPixelValue=e.uint16("x00280106"),t.largestPixelValue=e.uint16("x00280107")):(t.smallestPixelValue=e.int16("x00280106"),t.largestPixelValue=e.int16("x00280107"))}(e,t),"PALETTE COLOR"===t.photometricInterpretation&&e.elements.x00281101&&function(e,t){t.redPaletteColorLookupTableDescriptor=d(e,"x00281101"),t.greenPaletteColorLookupTableDescriptor=d(e,"x00281102"),t.bluePaletteColorLookupTableDescriptor=d(e,"x00281103"),0===t.redPaletteColorLookupTableDescriptor[0]&&(t.redPaletteColorLookupTableDescriptor[0]=65536,t.greenPaletteColorLookupTableDescriptor[0]=65536,t.bluePaletteColorLookupTableDescriptor[0]=65536);const n=t.redPaletteColorLookupTableDescriptor[0],r=e.elements.x00281201.length===n?8:16;t.redPaletteColorLookupTableDescriptor[2]!==r&&(t.redPaletteColorLookupTableDescriptor[2]=r,t.greenPaletteColorLookupTableDescriptor[2]=r,t.bluePaletteColorLookupTableDescriptor[2]=r),t.redPaletteColorLookupTableData=m(e,"x00281201",t.redPaletteColorLookupTableDescriptor),t.greenPaletteColorLookupTableData=m(e,"x00281202",t.greenPaletteColorLookupTableDescriptor),t.bluePaletteColorLookupTableData=m(e,"x00281203",t.bluePaletteColorLookupTableDescriptor)}(e,t),t};function p(e,t){let n=t.uint16("x00283002",0);0===n&&(n=65535);let r=0;r=0===e?t.uint16("x00283002",1):t.int16("x00283002",1);const a={id:"1",firstValueMapped:r,numBitsPerEntry:t.uint16("x00283002",2),lut:[]};for(let r=0;r<n;r++)a.lut[r]=0===e?t.uint16("x00283006",r):t.int16("x00283006",r);return a}const h=function(e,t){if(!t||!t.items||!t.items.length)return;const n=[];for(let r=0;r<t.items.length;r++){const a=p(e,t.items[r].dataSet);a&&n.push(a)}return n};const x=function(e){const t=e.string("x00080016");if("1.2.840.10008.5.1.4.1.1.2"===t||"1.2.840.10008.5.1.4.1.1.2.1"===t)return 1;const n=e.floatString("x00281052"),r=e.floatString("x00281053");if(void 0!==n&&void 0!==r){const t=function(e){const t=e.uint16("x00280103"),n=e.uint16("x00280101");return 0===t?0:-1<<n-1}(e);return t*r+n<0?1:0}return e.elements.x00283000&&e.elements.x00283000.length>0?0:e.uint16("x00280103")};const S=function(e,t,n){const r=[],a=e.string(t);if(!a)return;const o=a.split("\\");if(!(n&&o.length<n)){for(let e=0;e<o.length;e++)r.push(parseFloat(o[e]));return r}};var E=n(42573),y=n(35915);const P=function(e){const t=e.indexOf(":");let n=e.substring(t+1);const r=n.indexOf("frame=");let a;if(-1!==r){const e=n.substring(r+6);a=parseInt(e,10),n=n.substring(0,r-1)}return{scheme:e.substring(0,t),url:n,frame:a,pixelDataFrame:void 0!==a?a-1:void 0}};let I={open(e,t){e.open("get",t,!0)},beforeSend(){},beforeProcessing:e=>Promise.resolve(e.response),imageCreated(){},strict:!1};function b(e){I=Object.assign(I,e)}function L(){return I}var A=n(45630),D=n(5186);const _=function(e,t,n={},r={}){const a=L(),o=e=>{if("function"==typeof a.errorInterceptor){const t=new Error("request failed");t.request=e,t.response=e.response,t.status=e.status,a.errorInterceptor(t)}},i=new XMLHttpRequest,s=new Promise((s,l)=>{a.open(i,e,n,r);const c=a.beforeSend(i,t,n,r);i.responseType="arraybuffer";const u=Object.assign({},n,c);Object.keys(u).forEach(function(t){null!==u[t]&&("Accept"===t&&-1!==e.indexOf("accept=")||i.setRequestHeader(t,u[t]))}),r.deferred={resolve:s,reject:l},r.url=e,r.imageId=t,i.onloadstart=function(n){a.onloadstart&&a.onloadstart(n,r);const o={url:e,imageId:t};(0,A.A)(D.A,"cornerstoneimageloadstart",o)},i.onloadend=function(n){a.onloadend&&a.onloadend(n,r);const o={url:e,imageId:t};(0,A.A)(D.A,"cornerstoneimageloadend",o)},i.onreadystatechange=function(e){a.onreadystatechange&&a.onreadystatechange(e,r),4===i.readyState&&(200===i.status||206===i.status?a.beforeProcessing(i).then(s).catch(()=>{o(i),l(i)}):(o(i),l(i)))},i.onprogress=function(n){const o=n.loaded;let i,s;n.lengthComputable&&(i=n.total,s=Math.round(o/i*100));const l={url:e,imageId:t,loaded:o,total:i,percentComplete:s};(0,A.A)(D.A,"cornerstoneimageloadprogress",l),a.onprogress&&a.onprogress(n,r)},i.onerror=function(){o(i),l(i)},i.onabort=function(){o(i),l(i)},i.send()});return s.xhr=i,s};var T=n(23387);function w(e,t,n){if(n+e.length>t.length)return!1;let r=n;for(let n=0;n<e.length;n++)if(e[n]!==t[r++])return!1;return!0}const C=function(e,t,n){n=n||0;const r=function(e){const t=new Uint8Array(e.length);for(let n=0,r=e.length;n<r;n++)t[n]=e.charCodeAt(n);return t}(t);for(let t=n;t<e.length;t++)if(r[0]===e[t]&&w(r,e,t))return t;return-1},{ImageQualityStatus:O}=E;function R(e,t,n){n||={};const r=new Uint8Array(t),a=!!n?.isPartial;if(-1===e.indexOf("multipart"))return{contentType:e,imageQualityStatus:a?O.SUBRESOLUTION:O.FULL_RESOLUTION,pixelData:r};let{tokenIndex:o,responseHeaders:i,boundary:s,multipartContentType:l}=n;if(o||=C(r,"\r\n\r\n"),-1===o)throw new Error("invalid response - no multipart mime header");if(!s){const e=function(e,t,n){t=t||0,n=n||e.length-t;let r="";for(let a=t;a<t+n;a++)r+=String.fromCharCode(e[a]);return r}(r,0,o);if(i=e.split("\r\n"),s=function(e){for(let t=0;t<e.length;t++)if("--"===e[t].substr(0,2))return e[t]}(i),!s)throw new Error("invalid response - no boundary marker")}const c=o+4,u=C(r,s,c);if(-1===u&&!a)throw new Error("invalid response - terminating boundary not found");return l||=function(e){for(let t=0;t<e.length;t++)if("Content-Type:"===e[t].substr(0,13))return e[t].substr(13).trim()}(i),n.tokenIndex=o,n.boundary=s,n.responseHeaders=i,n.multipartContentType=l,n.isPartial=-1===u,{contentType:l,extractDone:!a||-1!==u,tokenIndex:o,responseHeaders:i,boundary:s,multipartContentType:l,pixelData:t.slice(c,u-2)}}const{ImageQualityStatus:M}=E;function v(e,t=!0){return t?e.imageQualityStatus??M.FULL_RESOLUTION:M.SUBRESOLUTION}const{ProgressiveIterator:N}=T;function F(e,t,n={},r={}){const a=L(),{retrieveOptions:o={},streamingData:i={}}=r,s=o.minChunkSize||131072,l=new N("streamRequest");return l.generate(async(r,l)=>{const c=a.beforeSend?.(null,e,n,{}),u=Object.assign({},n,c);Object.keys(u).forEach(function(t){null===u[t]&&(u[t]=void 0),"Accept"===t&&-1!==e.indexOf("accept=")&&(u[t]=void 0)});try{const n=await fetch(e,{headers:u,signal:void 0});if(200!==n.status)throw new Error(`Couldn't retrieve ${e} got status ${n.status}`);const a=n.body.getReader(),l=n.headers,c=l.get("content-type"),f=Number(l.get("Content-Length"));let d=!1,m=i.encodedData,g=i.lastSize||0;for(i.isPartial=!0;!d;){const{done:n,value:l}=await a.read();if(m=U(m,l),!m){if(d)throw new Error(`Done but no image frame available ${t}`);continue}if(d=n||m.byteLength===f,!d&&m.length<g+s)continue;g=m.length,i.isPartial=!n;const u=R(c,m,i),p=v(o,d),h={url:e,imageId:t,...u,percentComplete:n?100:100*u.pixelData?.length/f,imageQualityStatus:p,done:d};r.add(h,d)}}catch(e){(()=>{if("function"==typeof a.errorInterceptor){const e=new Error("request failed");a.errorInterceptor(e)}})(),console.error(e),l(e)}}),l.getNextPromise()}function U(e,t){if(!e)return t;if(!t)return e;const n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n}const G={xhrRequest:_,streamRequest:F,setOptions:b,getOptions:L};function B(e){let t,n=y.parseDicom(e,{untilTag:"x7fe00010"});n.elements.x7fe00010||console.warn("Pixel data not found!");try{t=y.parseDicom(e)}catch(e){console.error(e),console.log("pixel data dataset:",e.dataSet),t=e.dataSet}return n.elements.x7fe00010=t.elements.x7fe00010,n=function(e){const t=e.elements.x7fe00010.fragments,n=e.byteArray.length;for(const e of t){const{position:t,length:r}=e;r>n-t&&(console.log(`Truncated fragment, changing fragment length from ${e.length} to ${n-t}`),e.length=n-t)}return e}(n),n}async function k(e,t,n){const r=B(e),{uri:a,imageId:o,fileTotalLength:i}=n;return r.fetchMore=async function(s){const l=Object.assign({uri:a,imageId:o,fetchedLength:e.length,lengthToFetch:i-e.length},s),{fetchedLength:c,lengthToFetch:u}=l,{arrayBuffer:f}=await t(a,o,{byteRange:`${c}-${c+u}`}),d=new Uint8Array(f),m=new Uint8Array(r.byteArray.length+d.length);return m.set(r.byteArray),m.set(d,r.byteArray.length),k(m,t,n)},r}function V(e,t,n){const r={};(t?Object.values(t.items[0].dataSet.elements):[]).map(e=>r[e.tag]=e);const a={};return(e?Object.values(e.items[n-1].dataSet.elements):[]).map(e=>a[e.tag]=e),{shared:r,perFrame:a}}function $(e){if(!e)return;const{elements:t,...n}=e,{x52009230:r,x52009229:a,...o}=t;return{NumberOfFrames:e.intString("x00280008"),PerFrameFunctionalGroupsSequence:r,SharedFunctionalGroupsSequence:a,otherElements:o,otherAttributtes:n}}let H={};function q(e){if(H[e])return H[e]}function j(e){if(!e)return!1;const t=e.intString("x00280008");return t&&t>1}const Y={_get:q,generateMultiframeWADOURIs:function(e){const t=[],n=q(e);if(j(n)){const r=n.intString("x00280008");for(let n=1;n<=r;n++)t.push(`${e}&frame=${n}`)}else t.push(e);return t},retrieveMultiframeDataset:function(e){const t=function(e){return e.indexOf("&frame=")}(e),n=-1===t?e:e.slice(0,t),r=parseInt(e.slice(t+7),10)||1;let a;return a=H[n]?H[n].dataSet:void 0,{dataSet:a,frame:r}},isMultiframeDataset:function(e){return j(q(e))}};let J=0,X={};function W(){return{cacheSizeInBytes:J,numberOfDataSetsCached:Object.keys(H).length}}const z={isLoaded:function(e){return void 0!==H[e]},load:function(e,t=_,n){if(H[e])return new Promise(t=>{H[e].cacheCount++,t(H[e].dataSet)});if(X[e])return X[e].cacheCount++,X[e];const r=t(e,n),a=new Promise((o,i)=>{r.then(async function(r){const s={isPartialContent:!1,fileTotalLength:null};if(!(r instanceof ArrayBuffer)){if(!r.arrayBuffer)return i(new Error("If not returning ArrayBuffer, must return object with `arrayBuffer` parameter"));s.isPartialContent=r.flags.isPartialContent,s.fileTotalLength=r.flags.fileTotalLength,r=r.arrayBuffer}const l=new Uint8Array(r);let c;try{c=s.isPartialContent?await k(l,t,{uri:e,imageId:n,fileTotalLength:s.fileTotalLength}):y.parseDicom(l)}catch(e){return i(e)}H[e]={dataSet:c,cacheCount:a.cacheCount},J+=c.byteArray.length,o(c),(0,A.A)(D.A,"datasetscachechanged",{uri:e,action:"loaded",cacheInfo:W()})},i).then(()=>{delete X[e]},()=>{delete X[e]})});return a.cacheCount=1,X[e]=a,a},unload:function(e){H[e]&&(H[e].cacheCount--,0===H[e].cacheCount&&(J-=H[e].dataSet.byteArray.length,delete H[e],(0,A.A)(D.A,"datasetscachechanged",{uri:e,action:"unloaded",cacheInfo:W()})))},getInfo:W,purge:function(){H={},X={},J=0},get:function(e){let t;if(e.includes("&frame=")){const{frame:n,dataSet:r}=Y.retrieveMultiframeDataset(e);t=function(e,t){if(!t)return;const{NumberOfFrames:n,PerFrameFunctionalGroupsSequence:r,SharedFunctionalGroupsSequence:a,otherElements:o}=$(t);if(r||n>1){const{shared:n,perFrame:i}=V(r,a,e),s={elements:{...o,...n,...i}},l=Object.create(t);return Object.assign(l,s)}return t}(n,r)}else H[e]&&(t=H[e].dataSet);return t},update:function(e,t){const n=H[e];n?(J-=n.dataSet.byteArray.length,n.dataSet=t,J+=t.byteArray.length,(0,A.A)(D.A,"datasetscachechanged",{uri:e,action:"updated",cacheInfo:W()})):console.error(`No loaded dataSet for uri ${e}`)}};function Q(e){return"RECON TOMO"===e||"RECON GATED TOMO"===e}function K(e,t){const n=e.string("x00080008");if(n){const e=n.split("\\");if(e.length>t)return e[t]}}function Z(e){let t=S(e,"x00200037",6);return!t&&e.elements.x00209116&&(t=S(e.elements.x00209116.items[0].dataSet,"x00200037",6)),t||(t=function(e){let t;const n=e.string("x00080060");if(n?.includes("NM")){const n=K(e,2);n&&Q(n)&&e.elements.x00540022&&(t=S(e.elements.x00540022.items[0].dataSet,"x00200037",6))}return t}(e)),t}function ee(e){let t=S(e,"x00200032",3);return!t&&e.elements.x00209113&&(t=S(e.elements.x00209113.items[0].dataSet,"x00200032",3)),t||(t=function(e){let t;const n=e.string("x00080060");if(n?.includes("NM")){const n=K(e,2);n&&Q(n)&&e.elements.x00540022&&(t=S(e.elements.x00540022.items[0].dataSet,"x00200032",3))}return t}(e)),t}function te(e){let t=S(e,"x00280030",2);return!t&&e.elements.x00289110&&(t=S(e.elements.x00289110.items[0].dataSet,"x00280030",2)),t}function ne(e){let t;return e.elements.x00180050?t=e.floatString("x00180050"):e.elements.x00289110&&e.elements.x00289110.items.length&&e.elements.x00289110.items[0].dataSet.elements.x00180050&&(t=e.elements.x00289110.items[0].dataSet.floatString("x00180050")),t}function re(e,t,n){const r={};for(const a of n)try{const n=t(a,e);if(n){const e={};for(const t in n)if(t in n){e[ae(t)]=n[t]}Object.assign(r,e)}}catch(e){console.error(`Error retrieving ${a} data:`,e)}return r}const ae=e=>e.charAt(0).toUpperCase()+e.slice(1),oe=["multiframeModule","generalSeriesModule","patientStudyModule","imagePlaneModule","nmMultiframeGeometryModule","imagePixelModule","modalityLutModule","voiLutModule","sopCommonModule","petIsotopeModule","overlayPlaneModule","transferSyntax","petSeriesModule","petImageModule"];function ie(e){const t=e.elements.x00186011;if(!t||!t.items)return[];return t.items.map(e=>{const t=e.dataSet.double("x0018602c"),n=e.dataSet.double("x0018602e"),r=e.dataSet.uint16("x00186024"),a=e.dataSet.uint16("x00186026");return{regionLocationMinY0:e.dataSet.uint16("x0018601a"),regionLocationMaxY1:e.dataSet.uint16("x0018601e"),regionLocationMinX0:e.dataSet.uint16("x00186018"),regionLocationMaxX1:e.dataSet.uint16("x0018601c"),referencePixelX0:e.dataSet.int32("x00186020")||null,referencePixelY0:e.dataSet.int32("x00186022")||null,physicalDeltaX:t,physicalDeltaY:n,physicalUnitsXDirection:r,physicalUnitsYDirection:a,referencePhysicalPixelValueY:e.dataSet.uint16("x0018602a"),referencePhysicalPixelValueX:e.dataSet.uint16("x00186028"),regionSpatialFormat:e.dataSet.uint16("x00186012"),regionDataType:e.dataSet.uint16("x00186014"),regionFlags:e.dataSet.uint16("x00186016"),transducerFrequency:e.dataSet.uint16("x00186030")}})}function se(e,t){const{MetadataModules:n}=E;if(Array.isArray(t))return;const r=P(t);if(e===n.MULTIFRAME){const e=Y.retrieveMultiframeDataset(r.url);if(!e.dataSet)return;const t=function(e,t){if(!e)return;const{NumberOfFrames:n,PerFrameFunctionalGroupsSequence:r,SharedFunctionalGroupsSequence:a}=$(e);if(r||n>1){const{shared:e,perFrame:o}=V(r,a,t);return{NumberOfFrames:n,PerFrameFunctionalInformation:o,SharedFunctionalInformation:e}}return{NumberOfFrames:n}}(e.dataSet,e.frame);return t}let a=r.url;r.frame&&(a=`${a}&frame=${r.frame}`);const o=z.get(a);return o?le(e,t,o):void 0}function le(e,t,n){const{MetadataModules:r}=E;if(e===r.GENERAL_STUDY)return{studyDescription:n.string("x00081030"),studyDate:y.parseDA(n.string("x00080020")),studyTime:y.parseTM(n.string("x00080030")||""),accessionNumber:n.string("x00080050")};if(e===r.GENERAL_SERIES)return{modality:n.string("x00080060"),seriesInstanceUID:n.string("x0020000e"),seriesDescription:n.string("x0008103e"),seriesNumber:n.intString("x00200011"),studyInstanceUID:n.string("x0020000d"),seriesDate:y.parseDA(n.string("x00080021")),seriesTime:y.parseTM(n.string("x00080031")||""),acquisitionDate:y.parseDA(n.string("x00080022")),acquisitionTime:y.parseTM(n.string("x00080032")||"")};if(e===r.GENERAL_IMAGE)return{sopInstanceUID:n.string("x00080018"),instanceNumber:n.intString("x00200013"),lossyImageCompression:n.string("x00282110"),lossyImageCompressionRatio:n.floatString("x00282112"),lossyImageCompressionMethod:n.string("x00282114")};if(e===r.PATIENT)return{patientID:n.string("x00100020"),patientName:n.string("x00100010")};if(e===r.PATIENT_STUDY)return{patientAge:n.intString("x00101010"),patientSize:n.floatString("x00101020"),patientSex:n.string("x00100040"),patientWeight:n.floatString("x00101030")};if(e===r.NM_MULTIFRAME_GEOMETRY){const e=n.string("x00080060"),t=K(n,2);return{modality:e,imageType:n.string("x00080008"),imageSubType:t,imageOrientationPatient:Z(n),imagePositionPatient:ee(n),sliceThickness:ne(n),pixelSpacing:te(n),numberOfFrames:n.uint16("x00280008"),isNMReconstructable:Q(t)&&e.includes("NM")}}if(e===r.IMAGE_PLANE){const e=Z(n),t=ee(n),r=te(n),a=ne(n);let o=null,i=null;r&&(i=r[0],o=r[1]);let s=null,l=null;return e&&(s=[parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])],l=[parseFloat(e[3]),parseFloat(e[4]),parseFloat(e[5])]),{frameOfReferenceUID:n.string("x00200052"),rows:n.uint16("x00280010"),columns:n.uint16("x00280011"),imageOrientationPatient:e,rowCosines:s,columnCosines:l,imagePositionPatient:t,sliceThickness:a,sliceLocation:n.floatString("x00201041"),pixelSpacing:r,rowPixelSpacing:i,columnPixelSpacing:o}}if(e===r.CINE)return{frameTime:n.floatString("x00181063")};if(e===r.IMAGE_PIXEL)return g(n);if(e===r.VOI_LUT){const e=x(n);return{windowCenter:S(n,"x00281050",1),windowWidth:S(n,"x00281051",1),voiLUTSequence:h(e,n.elements.x00283010),voiLUTFunction:n.string("x00281056")}}if(e===r.MODALITY_LUT)return{rescaleIntercept:n.floatString("x00281052"),rescaleSlope:n.floatString("x00281053"),rescaleType:n.string("x00281054"),modalityLUTSequence:h(n.uint16("x00280103"),n.elements.x00283000)};if(e===r.SOP_COMMON)return{sopClassUID:n.string("x00080016"),sopInstanceUID:n.string("x00080018")};if(e===r.PET_ISOTOPE){const e=n.elements.x00540016;if(void 0===e)return;const t=e.items[0].dataSet;return{radiopharmaceuticalInfo:{radiopharmaceuticalStartTime:y.parseTM(t.string("x00181072")||""),radionuclideTotalDose:t.floatString("x00181074"),radionuclideHalfLife:t.floatString("x00181075")}}}if(e===r.OVERLAY_PLANE)return function(e){const t=[];for(let n=0;n<=30;n+=2){let r=`x60${n.toString(16)}`;4===r.length&&(r=`x600${n.toString(16)}`);const a=e.elements[`${r}3000`];if(!a)continue;const o=[];for(let t=0;t<a.length;t++)for(let n=0;n<8;n++){const r=e.byteArray[a.dataOffset+t];o[8*t+n]=r>>n&1}t.push({rows:e.uint16(`${r}0010`),columns:e.uint16(`${r}0011`),type:e.string(`${r}0040`),x:e.int16(`${r}0050`,1)-1,y:e.int16(`${r}0050`,0)-1,pixelData:o,description:e.string(`${r}0022`),label:e.string(`${r}1500`),roiArea:e.string(`${r}1301`),roiMean:e.string(`${r}1302`),roiStandardDeviation:e.string(`${r}1303`)})}return{overlays:t}}(n);if("transferSyntax"===e){let e;try{e=n.string("x00020010")}catch(e){}return{transferSyntaxUID:e}}if(e===r.PET_SERIES)return{correctedImage:n.string("x00280051"),units:n.string("x00541001"),decayCorrection:n.string("x00541102")};if(e===r.PET_IMAGE)return{frameReferenceTime:n.floatString(n.string("x00541300")||""),actualFrameDuration:n.intString(n.string("x00181242"))};if(e===r.ULTRASOUND_ENHANCED_REGION)return ie(n);if(e===r.CALIBRATION){if("US"===n.string("x00080060")){return{sequenceOfUltrasoundRegions:ie(n)}}}return"instance"===e?re(t,se,oe):void 0}const ce=se;let ue=[];const fe={add:function(e){return"dicomfile:"+(ue.push(e)-1)},get:function(e){return ue[e]},remove:function(e){ue[e]=void 0},purge:function(){ue=[]}};function de(e,t){if(e.elements.x7fe00010&&e.elements.x7fe00010.basicOffsetTable.length)return y.readEncapsulatedImageFrame(e,e.elements.x7fe00010,t);if(function(e){return e.intString("x00280008")!==e.elements.x7fe00010.fragments.length}(e)){const n=y.createJPEGBasicOffsetTable(e,e.elements.x7fe00010);return y.readEncapsulatedImageFrame(e,e.elements.x7fe00010,t,n)}const n=e.elements.x7fe00010.fragments,r=new y.ByteStream(e.byteArrayParser,e.byteArray,e.elements.x7fe00010.dataOffset),a=y.readSequenceItem(r);if("xfffee000"!==a.tag)throw"dicomParser.readEncapsulatedPixelData: missing basic offset table xfffee000";r.seek(a.length);const o=r.position;if(t+1>n.length)throw"dicomParser.readEncapsulatedPixelData: frame exceeds number of fragments";const i=o+n[t].offset+8,s=n[t].length;return new Uint8Array(r.byteArray.buffer.slice(r.byteArray.byteOffset+i,r.byteArray.byteOffset+i+s))}function me(e,t){return e&1<<t}const ge=function(e,t,n){const r=new Uint8Array(n);for(let a=0;a<n;a++){const n=e[Math.floor(a/8)+t],o=a%8;r[a]=me(n,o)?1:0}return r};const pe=function(e,t){const n=e.elements.x7fe00010||e.elements.x7fe00008,r=e.uint16("x00280100"),a=e.uint16("x00280010"),o=e.uint16("x00280011");let i=e.uint16("x00280002");"YBR_FULL_422"===e.string("x00280004")&&(i=2,console.warn("Using SamplesPerPixel of 2 for YBR_FULL_422 photometric interpretation.\n      See http://dicom.nema.org/medical/dicom/current/output/chtml/part03/sect_C.7.6.3.html for more information."));const s=n.dataOffset,l=a*o*i;let c;if(8===r){if(c=s+t*l,c>=e.byteArray.length)throw new Error("frame exceeds size of pixelData");return new Uint8Array(e.byteArray.buffer.slice(c,c+l))}if(16===r){if(c=s+t*l*2,c>=e.byteArray.length)throw new Error("frame exceeds size of pixelData");return new Uint8Array(e.byteArray.buffer.slice(c,c+2*l))}if(1===r){if(c=s+t*l*.125,c>=e.byteArray.length)throw new Error("frame exceeds size of pixelData");return ge(e.byteArray,c,l)}if(32===r){if(c=s+t*l*4,c>=e.byteArray.length)throw new Error("frame exceeds size of pixelData");return new Uint8Array(e.byteArray.buffer.slice(c,c+4*l))}throw new Error("unsupported pixel format")};const he=function(e){const t=P(e),n=parseInt(t.url,10),r=fe.get(n);return new Promise((e,t)=>{const n=new FileReader;n.onload=t=>{const n=t.target.result;e(n)},n.onerror=t,n.readAsArrayBuffer(r)})};const xe=function(e,t=0){const n=e.elements.x7fe00010||e.elements.x7fe00008;return n?n.encapsulatedPixelData?de(e,t):pe(e,t):null};var Se=n(97416),Ee=n(27802),ye=n(50669),Pe=n(11226);function Ie(e,t,n){0===e.planarConfiguration?a(e.pixelData,t,n):o(e.pixelData,t,n)}function be(e,t,n){if("RGB"===e.photometricInterpretation)Ie(e,t,n);else if("YBR_RCT"===e.photometricInterpretation)Ie(e,t,n);else if("YBR_ICT"===e.photometricInterpretation)Ie(e,t,n);else if("PALETTE COLOR"===e.photometricInterpretation)f(e,t,n);else if("YBR_FULL_422"===e.photometricInterpretation)!function(e,t,n){if(void 0===e)throw new Error("convertYBRFull422ByPixel: ybrBuffer must be defined");if(e.length%2!=0)throw new Error(`convertYBRFull422ByPixel: ybrBuffer length ${e.length} must be divisible by 2`);const r=e.length/2;let a=0,o=0;if(n)for(let n=0;n<r;n+=2){const n=e[a++],r=e[a++],i=e[a++],s=e[a++];t[o++]=n+1.402*(s-128),t[o++]=n-.34414*(i-128)-.71414*(s-128),t[o++]=n+1.772*(i-128),t[o++]=255,t[o++]=r+1.402*(s-128),t[o++]=r-.34414*(i-128)-.71414*(s-128),t[o++]=r+1.772*(i-128),t[o++]=255}else for(let n=0;n<r;n+=2){const n=e[a++],r=e[a++],i=e[a++],s=e[a++];t[o++]=n+1.402*(s-128),t[o++]=n-.34414*(i-128)-.71414*(s-128),t[o++]=n+1.772*(i-128),t[o++]=r+1.402*(s-128),t[o++]=r-.34414*(i-128)-.71414*(s-128),t[o++]=r+1.772*(i-128)}}(e.pixelData,t,n);else{if("YBR_FULL"!==e.photometricInterpretation)throw new Error(`No color space conversion for photometric interpretation ${e.photometricInterpretation}`);!function(e,t,n){0===e.planarConfiguration?i(e.pixelData,t,n):s(e.pixelData,t,n)}(e,t,n)}}function Le(e){return function(e){let t;try{return decodeURIComponent(escape(e))}catch(n){if(t=n,t instanceof URIError)return e;throw t}}(String.fromCharCode.apply(null,Array.prototype.slice.apply(new Uint8Array(e))))}const Ae=function(e,t,n){const r=(new Date).getTime(),a=new Blob([t],{type:"image/jpeg"});return new Promise((t,o)=>{const i=new FileReader;void 0===i.readAsBinaryString?i.readAsArrayBuffer(a):i.readAsBinaryString(a),i.onload=function(){const a=new Image;a.onload=function(){n.height=a.height,n.width=a.width,e.rows=a.height,e.columns=a.width;const o=n.getContext("2d");o.drawImage(this,0,0);const i=o.getImageData(0,0,a.width,a.height),s=(new Date).getTime();e.pixelData=new Uint8Array(i.data.buffer),e.imageData=i,e.decodeTimeInMS=s-r;const l=(0,Se.A)(e.pixelData);e.smallestPixelValue=l.min,e.largestPixelValue=l.max,e.pixelDataLength=e.pixelData.length,t(e)},a.onerror=function(e){o(e)},void 0===i.readAsBinaryString?a.src=`data:image/jpeg;base64,${window.btoa(Le(i.result))}`:a.src=`data:image/jpeg;base64,${window.btoa(i.result)}`},i.onerror=e=>{o(e)}})};function De(e,t,n,r,a){const o={...r};delete o.loader,delete o.streamingData;const i=(0,Ee.G_)(),s=o.priority||void 0;o.transferPixelData&&n.buffer;return i.executeTask("dicomImageLoader","decodeTask",{imageFrame:e,transferSyntax:t,pixelData:n,options:o,decodeConfig:a},{priority:s,requestType:o?.requestType})}const _e=function(e,t,n,r,a={},o){switch(t){case"1.2.840.10008.1.2":case"1.2.840.10008.1.2.1":case"1.2.840.10008.1.2.2":case"1.2.840.10008.1.2.1.99":case"1.2.840.10008.1.2.5":case"1.2.840.10008.1.2.4.51":case"1.2.840.10008.1.2.4.57":case"1.2.840.10008.1.2.4.70":case"1.2.840.10008.1.2.4.80":case"1.2.840.10008.1.2.4.81":case"1.2.840.10008.1.2.4.90":case"1.2.840.10008.1.2.4.91":case"3.2.840.10008.1.2.4.96":case"1.2.840.10008.1.2.4.201":case"1.2.840.10008.1.2.4.202":case"1.2.840.10008.1.2.4.203":return De(e,t,n,a,o);case"1.2.840.10008.1.2.4.50":return 8!==e.bitsAllocated||3!==e.samplesPerPixel&&4!==e.samplesPerPixel?De(e,t,n,a,o):Ae(e,n,r)}return Promise.reject(new Error(`No decoder for transfer syntax ${t}`))};const Te=function(e){const t=l.get("imagePixelModule",e);return{samplesPerPixel:t.samplesPerPixel,photometricInterpretation:t.photometricInterpretation,planarConfiguration:t.planarConfiguration,rows:t.rows,columns:t.columns,bitsAllocated:t.bitsAllocated,bitsStored:t.bitsStored,pixelRepresentation:t.pixelRepresentation,smallestPixelValue:t.smallestPixelValue,largestPixelValue:t.largestPixelValue,redPaletteColorLookupTableDescriptor:t.redPaletteColorLookupTableDescriptor,greenPaletteColorLookupTableDescriptor:t.greenPaletteColorLookupTableDescriptor,bluePaletteColorLookupTableDescriptor:t.bluePaletteColorLookupTableDescriptor,redPaletteColorLookupTableData:t.redPaletteColorLookupTableData,greenPaletteColorLookupTableData:t.greenPaletteColorLookupTableData,bluePaletteColorLookupTableData:t.bluePaletteColorLookupTableData,pixelData:void 0,imageId:e}};var we=n(47092);const Ce=function(e,t){const n=e.length/4;let r=0,a=0;for(let o=0;o<n;o++)t[a++]=e[r++],t[a++]=e[r++],t[a++]=e[r++],r++;return t};const Oe=function(e){return"1.2.840.10008.5.1.4.1.1.12.1"!==e&&"1.2.840.10008.5.1.4.1.1.12.2.1"!==e};var Re=n(10678);const Me=function(e){const t=e.smallestPixelValue,n=e.largestPixelValue,r=(0,Re.A)(t,n);if(!r)throw new Error("Could not apply a typed array to the pixel data");{const t=new r(e.pixelData);e.pixelData=t}};let ve="";const Ne=function(e,t,n,r={}){const a=r.useRGBA;if(r.preScale={enabled:!r.preScale||void 0===r.preScale.enabled||r.preScale.enabled},!t?.length)return Promise.reject(new Error("The pixel data is missing"));const{MetadataModules:o}=E,i=document.createElement("canvas"),s=Te(e);if(s.decodeLevel=r.decodeLevel,r.allowFloatRendering=(0,Ee.lk)(),r.preScale.enabled){const t=function(e,t){const n=e.get("modalityLutModule",t)||{},r=e.get("generalSeriesModule",t)||{},{modality:a}=r,o={rescaleSlope:n.rescaleSlope,rescaleIntercept:n.rescaleIntercept,modality:a},i=e.get("scalingModule",t)||{};return{...o,..."PT"===a&&{suvbw:i.suvbw},..."RTDOSE"===a&&{doseGridScaling:i.DoseGridScaling,doseSummation:i.DoseSummation,doseType:i.DoseType,doseUnit:i.DoseUnit}}}(l,e);t&&(r.preScale={...r.preScale,scalingParameters:t})}const{decodeConfig:c}=L();Object.keys(s).forEach(e=>{("function"==typeof s[e]||s[e]instanceof Promise)&&delete s[e]});const u=_e(s,n,t,i,r,c),f=(0,we.A)(s.photometricInterpretation);return new Promise((t,n)=>{u.then(function(n){let s=!1;if(r.targetBuffer&&r.targetBuffer.type&&!f){const{arrayBuffer:e,type:t,offset:a=0,length:o}=r.targetBuffer,i=n.pixelDataLength,l=a,c=null!=o?o:i-l,u={Uint8Array,Uint16Array,Int16Array,Float32Array,Uint32Array};if(c!==n.pixelDataLength)throw new Error(`target array for image does not have the same length (${c}) as the decoded image length (${n.pixelDataLength}).`);const f=u[t],d=e?new f(e,l,c):new f(n.pixelData);if(c!==n.pixelDataLength)throw new Error("target array for image does not have the same length as the decoded image length.");n.pixelData=d,s=!0}s||Me(n);const c=l.get(o.IMAGE_PLANE,e)||{},u=l.get(o.VOI_LUT,e)||{},d=l.get(o.MODALITY_LUT,e)||{},m=l.get(o.SOP_COMMON,e)||{},g=l.get(o.CALIBRATION,e)||{},{rows:p,columns:h}=n;if(f){if(function(e){if(void 0===e)return!1;const{rows:t,columns:n,photometricInterpretation:r,pixelDataLength:a,planarConfiguration:o}=e;return a!==4*n*t&&("PALETTE COLOR"===r||(r.endsWith("420")?a===(3*Math.ceil(n/2)+Math.floor(n/2))*t:r.endsWith("422")?a===(3*Math.ceil(n/2)+Math.floor(n/2))*Math.ceil(t/2)+Math.floor(t/2)*n:"RGB"!==r||1===o))}(n)){i.height=n.rows,i.width=n.columns;let e=i.getContext("2d").createImageData(n.columns,n.rows);a||(e={...e,data:new Uint8ClampedArray(3*n.columns*n.rows)}),be(n,e.data,a),n.imageData=e,n.pixelData=e.data,n.pixelDataLength=e.data.length}else if(!a&&n.pixelDataLength===4*p*h){const e=new Uint8Array(n.pixelData.length/4*3);n.pixelData=Ce(n.pixelData,e),n.pixelDataLength=n.pixelData.length}const e=(0,Se.A)(n.pixelData);n.smallestPixelValue=e.min,n.largestPixelValue=e.max}let x=n.samplesPerPixel;"PALETTE COLOR"===n.photometricInterpretation&&(x=a?4:3);const S=ye.A.createImageVoxelManager({scalarData:n.pixelData,width:n.columns,height:n.rows,numberOfComponents:x}),E={imageId:e,dataType:n.pixelData.constructor.name,color:f,calibration:g,columnPixelSpacing:c.columnPixelSpacing,columns:n.columns,height:n.rows,preScale:n.preScale,intercept:d.rescaleIntercept?d.rescaleIntercept:0,slope:d.rescaleSlope?d.rescaleSlope:1,invert:"MONOCHROME1"===n.photometricInterpretation,minPixelValue:n.smallestPixelValue,maxPixelValue:n.largestPixelValue,rowPixelSpacing:c.rowPixelSpacing,rows:n.rows,sizeInBytes:n.pixelData.byteLength,width:n.columns,windowCenter:u.windowCenter?u.windowCenter[0]:void 0,windowWidth:u.windowWidth?u.windowWidth[0]:void 0,voiLUTFunction:u.voiLUTFunction?u.voiLUTFunction:void 0,decodeTimeInMS:n.decodeTimeInMS,floatPixelData:void 0,imageFrame:n,voxelManager:S,rgba:f&&a,getPixelData:()=>n.pixelData,getCanvas:void 0,numberOfComponents:x};if(E.color&&(E.getCanvas=function(){if(ve===e)return i;const t=E.columns,r=E.rows;i.height=r,i.width=t;const a=i.getContext("2d"),o=a.createImageData(t,r),s=n.pixelData;if(s.length===t*r*4)for(let e=0;e<s.length;e++)o.data[e]=s[e];else if(s.length===t*r*3){let e=0;for(let t=0;t<s.length;t+=3)o.data[e++]=s[t],o.data[e++]=s[t+1],o.data[e++]=s[t+2],o.data[e++]=255}return n.pixelData=o.data,n.pixelDataLength=o.data.length,n.imageData=o,a.putImageData(n.imageData,0,0),ve=e,i}),d.modalityLUTSequence&&d.modalityLUTSequence.length>0&&Oe(m.sopClassUID)&&(E.modalityLUT=d.modalityLUTSequence[0]),u.voiLUTSequence&&u.voiLUTSequence.length>0&&(E.voiLUT=u.voiLUTSequence[0]),E.color&&(E.windowWidth=256,E.windowCenter=128),void 0===E.windowCenter||void 0===E.windowWidth){const e=Pe.toWindowLevel(E.imageFrame.smallestPixelValue,E.imageFrame.largestPixelValue);E.windowWidth=e.windowWidth,E.windowCenter=e.windowCenter}t(E)},n)})},{ImageQualityStatus:Fe}=E;function Ue(e,t,n=0,r,a,o){const i=(new Date).getTime(),s={cancelFn:void 0,promise:void 0};return s.promise=new Promise((l,c)=>{e.then(e=>{const u=xe(e,n),f=e.string("x00020010"),d=(new Date).getTime(),m=Ne(t,u,f,a);!function(e,t){e.decache=function(){const e=P(t);z.unload(e.url)}}(s,t),m.then(t=>{t.data=e,t.sharedCacheKey=r;const n=(new Date).getTime();t.loadTimeInMS=d-i,t.totalTimeInMS=n-i,t.imageQualityStatus=Fe.FULL_RESOLUTION,void 0!==o&&void 0!==o.imageDoneCallback&&o.imageDoneCallback(t),l(t)},function(t){c({error:t,dataSet:e})})},function(e){c({error:e})})}),s}function Ge(e){return"dicomweb"===e||"wadouri"===e?_:"dicomfile"===e?he:void 0}function Be(e,t={}){const n=P(e);delete(t=Object.assign({},t)).loader;const r=Ge(n.scheme);if(z.isLoaded(n.url)){return function(e,t,n=0,r,a){const o=(new Date).getTime();return{promise:new Promise((r,i)=>{const s=(new Date).getTime();let l;try{const r=xe(e,n),o=e.string("x00020010");l=Ne(t,r,o,a)}catch(t){return void i({error:t,dataSet:e})}l.then(t=>{t.data=e;const n=(new Date).getTime();t.loadTimeInMS=s-o,t.totalTimeInMS=n-o,t.imageQualityStatus=Fe.FULL_RESOLUTION,r(t)},i)}),cancelFn:void 0}}(z.get(n.url,r,e),e,n.pixelDataFrame,n.url,t)}return Ue(z.load(n.url,r,e),e,n.frame,n.url,t)}var ke=n(8038);function Ve(){(0,ke.registerImageLoader)("dicomweb",Be),(0,ke.registerImageLoader)("wadouri",Be),(0,ke.registerImageLoader)("dicomfile",Be),l.addProvider(ce)}const $e={metaData:{getImagePixelModule:g,getLUTs:h,getModalityLUTOutputPixelRepresentation:x,getNumberValues:S,metaDataProvider:ce,metadataForDataset:le},dataSetCacheManager:z,fileManager:fe,getEncapsulatedImageFrame:de,getUncompressedImageFrame:pe,loadFileRequest:he,loadImageFromPromise:Ue,getLoaderForScheme:Ge,getPixelData:xe,loadImage:Be,parseImageId:P,unpackBinaryFrame:ge,register:Ve};const He=function(e,t,n){return t=t||0,e&&e.Value?Array.isArray(e.Value)&&e.Value.length<=t?n:e.Value[t]:n};const qe=function(e,t,n){const r=He(e,t,n);if(void 0!==r)return parseFloat(String(r))};const je=function(e,t){const n=He(e,t);if(void 0!==n)return parseFloat(n)};const Ye=function(e,t){if(!e)return;if(!e.Value)return;if(!Array.isArray(e.Value))return;if(t&&e.Value.length<t)return;const n=[];for(let t=0;t<e.Value.length;t++)n.push(parseFloat(e.Value[t]));return n};var Je=n(63631);function Xe(e){const t=e.indexOf(":");return e.substring(t+1)}function We(e,t=!0){return e&&e.Value?e.Value[0]&&t?e.Value[0]:e.Value:e}function ze(e,t,n){return{shared:(t?Object.values(t[0]):[]).map(e=>e.Value?.[0]).filter(e=>void 0!==e&&"object"==typeof e),perFrame:(e?Object.values(e[n-1]):[]).map(e=>e.Value?.[0]).filter(e=>void 0!==e&&"object"==typeof e)}}function Qe(e){let{52009230:t,52009229:n,"00280008":r,...a}=e;return t=We(t,!1),n=We(n,!1),r=We(r),{PerFrameFunctionalGroupsSequence:t,SharedFunctionalGroupsSequence:n,NumberOfFrames:r,rest:a}}let Ke=[],Ze={};function et(e){const t=e.indexOf("/frames/")+8,n=e.slice(0,t),r=parseInt(e.slice(t),10);return{metadata:Ke[`${n}1`],frame:r}}function tt(e){if(void 0!==e[52009230]||void 0!==e[52009229])return!0;const t=He(e["00280008"]);return t&&t>1}const nt={add:function(e,t){const n=Xe(e);Object.defineProperty(t,"isMultiframe",{value:tt(t),enumerable:!1}),Ke[n]=t},get:function(e){const t=Xe(e),n=Ke[t];if(n&&!n?.isMultiframe)return n;const r=Ze[t];if(r)return r;const a=et(t);if(!a||!a.metadata)return;const{metadata:o,frame:i}=a;if(o){const e=function(e,t){const{PerFrameFunctionalGroupsSequence:n,SharedFunctionalGroupsSequence:r,NumberOfFrames:a,rest:o}=Qe(t);if(n||a>1){const{shared:i,perFrame:s}=ze(n,r,e),l=Object.assign(t,{frameNumber:e});return[...i,...s].forEach(e=>{Object.entries(e).forEach(([e,t])=>{l[e]=t})}),Object.assign(o,{"00280008":a},l)}return t}(i,o);return Ze[t]=e,e}},remove:function(e){const t=Xe(e);Ke[t]=void 0,Ze[t]=void 0},purge:function(){Ke=[],Ze={}}};function rt(e){return He(e["00080060"]).includes("NM")}function at(e,t){const n=We(e["00080008"],!1);if(n)return n[t]}function ot(e){let t=Ye(e["00200037"],6);return!t&&rt(e)&&(t=function(e){let t;const n=at(e,2);if(n&&Q(n)){const n=We(e["00540022"]);n&&(t=Ye(n["00200037"],6))}return t}(e)),t}function it(e){let t=Ye(e["00200032"],3);return!t&&rt(e)&&(t=function(e){let t;const n=at(e,2);if(n&&Q(n)){const n=We(e["00540022"]);n&&(t=Ye(n["00200032"],3))}return t}(e)),t}function st(e,t){const n=Ye(e[t]);return n?n[0]:null}const lt=function(e){return e?.Value?.length?Array.isArray(e.Value)?e.Value:"object"==typeof e.Value?(console.warn("Warning: Value should be an array, but an object was found. Encapsulating the object in an array."),[e.Value]):[]:[]};function ct(e){const t=lt(e["00186011"]);if(!t||!t.length)return null;return t.map(e=>{const t=st(e,"0018602C"),n=st(e,"0018602E"),r=st(e,"00186024"),a=st(e,"00186026");return{regionLocationMinY0:st(e,"0018601A"),regionLocationMaxY1:st(e,"0018601E"),regionLocationMinX0:st(e,"00186018"),regionLocationMaxX1:st(e,"0018601C"),referencePixelX0:st(e,"00186020"),referencePixelY0:st(e,"00186022"),physicalDeltaX:t,physicalDeltaY:n,physicalUnitsXDirection:r,physicalUnitsYDirection:a,referencePhysicalPixelValueY:st(e,"0018602A"),referencePhysicalPixelValueX:st(e,"00186028"),regionSpatialFormat:st(e,"00186012"),regionDataType:st(e,"00186014"),regionFlags:st(e,"00186016"),transducerFrequency:st(e,"00186030")}})}function ut(e,t){return{transferSyntaxUID:He(t["00020010"])||He(t["00083002"])}}const ft=function e(t,n){const{MetadataModules:r}=E;if(t===r.MULTIFRAME){const{metadata:e,frame:t}=function(e){return et(Xe(e))}(n);if(!e)return;const{PerFrameFunctionalGroupsSequence:r,SharedFunctionalGroupsSequence:a,NumberOfFrames:o}=Qe(e);if(r||o>1){const{shared:e,perFrame:n}=ze(r,a,t);return{NumberOfFrames:o,PerFrameFunctionalInformation:n,SharedFunctionalInformation:e}}return{NumberOfFrames:o}}const a=nt.get(n);if(a){if(t===r.GENERAL_STUDY)return{studyDescription:He(a["00081030"]),studyDate:y.parseDA(He(a["00080020"])),studyTime:y.parseTM(He(a["00080030"],0,"")),accessionNumber:He(a["00080050"])};if(t===r.GENERAL_SERIES)return{modality:He(a["00080060"]),seriesInstanceUID:He(a["0020000E"]),seriesDescription:He(a["0008103E"]),seriesNumber:je(a["00200011"]),studyInstanceUID:He(a["0020000D"]),seriesDate:y.parseDA(He(a["00080021"])),seriesTime:y.parseTM(He(a["00080031"],0,"")),acquisitionDate:y.parseDA(He(a["00080022"])),acquisitionTime:y.parseTM(He(a["00080032"],0,""))};if(t===r.GENERAL_IMAGE)return{sopInstanceUID:He(a["00080018"]),instanceNumber:je(a["00200013"]),lossyImageCompression:He(a["00282110"]),lossyImageCompressionRatio:je(a["00282112"]),lossyImageCompressionMethod:He(a["00282114"])};if(t===r.PATIENT)return{patientID:He(a["00100020"]),patientName:He(a["00100010"])};if(t===r.PATIENT_STUDY)return{patientAge:je(a["00101010"]),patientSize:je(a["00101020"]),patientSex:He(a["00100040"]),patientWeight:je(a["00101030"])};if(t===r.NM_MULTIFRAME_GEOMETRY){const e=He(a["00080060"]),t=at(a,2);return{modality:e,imageType:He(a["00080008"]),imageSubType:t,imageOrientationPatient:ot(a),imagePositionPatient:it(a),sliceThickness:je(a["00180050"]),spacingBetweenSlices:je(a["00180088"]),pixelSpacing:Ye(a["00280030"],2),numberOfFrames:je(a["00280008"]),isNMReconstructable:Q(t)&&e.includes("NM")}}if(t===r.IMAGE_PLANE){let e=ot(a),t=it(a);const n=Ye(a["00280030"],2);let r=null,o=null,i=null,s=null,l=!1;return n?(o=n[0],r=n[1]):(l=!0,o=1,r=1),e?(i=[parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])],s=[parseFloat(e[3]),parseFloat(e[4]),parseFloat(e[5])]):(i=[1,0,0],s=[0,1,0],l=!0,e=[...i,...s]),t||(t=[0,0,0],l=!0),{frameOfReferenceUID:He(a["00200052"]),rows:je(a["00280010"]),columns:je(a["00280011"]),imageOrientationPatient:e,rowCosines:i,columnCosines:s,imagePositionPatient:t,sliceThickness:je(a["00180050"]),sliceLocation:je(a["00201041"]),pixelSpacing:n,rowPixelSpacing:o,columnPixelSpacing:r,usingDefaultValues:l}}if(t===r.ULTRASOUND_ENHANCED_REGION)return ct(a);if(t===r.CALIBRATION){if("US"===He(a["00080060"])){return{sequenceOfUltrasoundRegions:ct(a)}}}if(t===r.IMAGE_URL)return function(e,t){const{transferSyntaxUID:n}=ut(e,t),r=Je.A(n),a=e.substring(7),o=a.replace("/frames/","/thumbnail/");let i=a.replace("/frames/","/rendered/");r&&(i=i.replace("/rendered/1","/rendered"));return{isVideo:r,rendered:i,thumbnail:o}}(n,a);if(t===r.CINE)return function(e,t){const n=He(t["00180040"]);return{cineRate:n,numberOfFrames:je(t["00280008"])}}(0,a);if(t===r.IMAGE_PIXEL)return{samplesPerPixel:je(a["00280002"]),photometricInterpretation:He(a["00280004"]),rows:je(a["00280010"]),columns:je(a["00280011"]),bitsAllocated:je(a["00280100"]),bitsStored:je(a["00280101"]),highBit:He(a["00280102"]),pixelRepresentation:je(a["00280103"]),planarConfiguration:je(a["00280006"]),pixelAspectRatio:He(a["00280034"]),smallestPixelValue:je(a["00280106"]),largestPixelValue:je(a["00280107"]),redPaletteColorLookupTableDescriptor:Ye(a["00281101"]),greenPaletteColorLookupTableDescriptor:Ye(a["00281102"]),bluePaletteColorLookupTableDescriptor:Ye(a["00281103"]),redPaletteColorLookupTableData:Ye(a["00281201"]),greenPaletteColorLookupTableData:Ye(a["00281202"]),bluePaletteColorLookupTableData:Ye(a["00281203"])};if(t===r.VOI_LUT)return{windowCenter:Ye(a["00281050"],1),windowWidth:Ye(a["00281051"],1),voiLUTFunction:He(a["00281056"])};if(t===r.MODALITY_LUT)return{rescaleIntercept:je(a["00281052"]),rescaleSlope:je(a["00281053"]),rescaleType:He(a["00281054"])};if(t===r.SOP_COMMON)return{sopClassUID:He(a["00080016"]),sopInstanceUID:He(a["00080018"])};if(t===r.PET_ISOTOPE){const e=He(a["00540016"]);if(void 0===e)return;return{radiopharmaceuticalInfo:{radiopharmaceuticalStartTime:y.parseTM(He(e["00181072"],0,"")),radiopharmaceuticalStartDateTime:He(e["00181078"],0,""),radionuclideTotalDose:je(e["00181074"]),radionuclideHalfLife:je(e["00181075"])}}}return t===r.OVERLAY_PLANE?function(e){const t=[];for(let n=0;n<=30;n+=2){let r=`x60${n.toString(16)}`;4===r.length&&(r=`x600${n.toString(16)}`);const a=He(e[`${r}3000`]);if(!a)continue;const o=[];for(let t=0;t<a.length;t++)for(let n=0;n<8;n++){const r=e.Value[a.dataOffset+t];o[8*t+n]=r>>n&1}t.push({rows:je(e[`${r}0010`]),columns:je(e[`${r}0011`]),type:He(e[`${r}0040`]),x:je(e[`${r}0050`],1)-1,y:je(e[`${r}0050`],0)-1,pixelData:o,description:He(e[`${r}0022`]),label:He(e[`${r}1500`]),roiArea:He(e[`${r}1301`]),roiMean:He(e[`${r}1302`]),roiStandardDeviation:He(e[`${r}1303`])})}return{overlays:t}}(a):"transferSyntax"===t?ut(n,a):t===r.PET_SERIES?{correctedImage:He(a["00280051"]),units:He(a["00541001"]),decayCorrection:He(a["00541102"])}:t===r.PET_IMAGE?{frameReferenceTime:je(a["00541300"]),actualFrameDuration:je(a["00181242"])}:"instance"===t?re(n,e,oe):void 0}};function dt(e,t,n={},r={}){const a=L(),{retrieveOptions:o={},streamingData:i}=r,s=i.chunkSize||function(e,t,n){const r=t[n];if("function"!=typeof r)return r;const a=nt.get(e);return r(a,e)}(t,o,"chunkSize")||65536,l=new Promise(async(t,r)=>{const l=Object.assign({},n);Object.keys(l).forEach(function(e){null!==l[e]&&void 0!==l[e]||delete l[e]});try{i.encodedData||(i.chunkSize=s,i.rangesFetched=0);const n=function(e,t){const{totalBytes:n,encodedData:r,chunkSize:a=65536}=e,{rangeIndex:o=0}=t;if(!(-1!==o||n&&r))return[0,""];if(-1===o||r?.byteLength>n-a)return[r?.byteLength||0,""];return[r?.byteLength||0,a*(o+1)-1]}(i,o),{encodedData:r,responseHeaders:a}=await async function(e,t,n,r){n&&(t=Object.assign(t,{Range:`bytes=${n[0]}-${n[1]}`}));let{encodedData:a}=r;if(n[1]&&a?.byteLength>n[1])return r;const o=await fetch(e,{headers:t,signal:void 0}),i=await o.arrayBuffer(),s=new Uint8Array(i),{status:l}=o;let c;a?(c=new Uint8Array(a.length+s.length),c.set(a,0),c.set(s,a.length),r.rangesFetched=1):(c=new Uint8Array(s.length),c.set(s,0),r.rangesFetched++);r.encodedData=a=c,r.responseHeaders=o.headers;const u=o.headers.get("Content-Range");u?r.totalBytes=Number(u.split("/")[1]):206===l&&n?""===n[1]||a?.length<n[1]?r.totalBytes=a.byteLength:r.totalBytes=Number.MAX_SAFE_INTEGER:r.totalBytes=a?.byteLength;return r}(e,l,n,i),c=a.get("content-type"),{totalBytes:u}=i,f=u===r.byteLength,d=R(c,r,{isPartial:!0}),m=v(o,f||d.extractDone);t({...d,imageQualityStatus:m,percentComplete:d.extractDone?100:100*s/u})}catch(e){(e=>{if("function"==typeof a.errorInterceptor){const e=new Error("request failed");a.errorInterceptor(e)}else console.warn("rangeRequest:Caught",e)})(e),console.error(e),r(e)}});return l}const mt=function(e,t,n="application/octet-stream",r){const{streamingData:a,retrieveOptions:o={}}=r||{},i={Accept:n};let s=o.urlArguments?`${e}${-1===e.indexOf("?")?"?":"&"}${o.urlArguments}`:e;if(o.framesPath&&(s=s.replace("/frames/",o.framesPath)),a?.url!==s&&(r.streamingData={url:s}),void 0!==o.rangeIndex)return dt(s,t,i,r);if(o.streaming)return F(s,t,i,r);const l=_(s,t,i),{xhr:c}=l;return l.then(function(e){const t=R(c.getResponseHeader("Content-Type")||"application/octet-stream",new Uint8Array(e));return t.imageQualityStatus=v(o,!0),t})};var gt=n(59535),pt=n(53871);const{ProgressiveIterator:ht}=T,{ImageQualityStatus:xt}=E,St=new Set(["3.2.840.10008.1.2.4.96","1.2.840.10008.1.2.4.202","1.2.840.10008.1.2.4.203"]);function Et(e){const t="1.2.840.10008.1.2";if(!e)return t;const n=e.split(";"),r={};n.forEach(e=>{const t=e.split("=");if(2!==t.length)return;const n=t[1].trim().replace(/"/g,"");r[t[0].trim()]=n});const a={"image/jpeg":"1.2.840.10008.1.2.4.50","image/x-dicom-rle":"1.2.840.10008.1.2.5","image/x-jls":"1.2.840.10008.1.2.4.80","image/jls":"1.2.840.10008.1.2.4.80","image/jll":"1.2.840.10008.1.2.4.70","image/jp2":"1.2.840.10008.1.2.4.90","image/jpx":"1.2.840.10008.1.2.4.92","image/jphc":"3.2.840.10008.1.2.4.96","image/jxl":"1.2.840.10008.1.2.4.140"};return r["transfer-syntax"]?r["transfer-syntax"]:e&&!Object.keys(r).length&&a[e]?a[e]:r.type&&a[r.type]?a[r.type]:a[e]?a[e]:t}function yt(e,t=4){const n=e/100-.02;return n>1/4?Math.min(t,0):n>1/16?Math.min(t,1):n>1/64?Math.min(t,2):Math.min(t,3)}const Pt=function(e,t={}){const n=gt.A,r=(new Date).getTime(),a=new ht("decompress"),o=t.requestType||pt.A.Interaction,i=t.additionalDetails||{imageId:e},s=void 0===t.priority?5:t.priority,l=e.substring(7);return n.addRequest(async function(e,n,o){a.generate(async a=>{const i=ht.as(mt(e,n,o,t));let s=10;for await(const e of i){const{pixelData:o,imageQualityStatus:i=xt.FULL_RESOLUTION,percentComplete:l,done:c=!0,extractDone:u=!0}=e,f=Et(e.contentType);if(!u&&!St.has(f))continue;const d=e.decodeLevel??(i===xt.FULL_RESOLUTION?0:yt(l,t.retrieveOptions?.decodeLevel));if(c||!(s<=d))try{const e={...t,decodeLevel:d},l=await Ne(n,o,f,e),u=(new Date).getTime();l.loadTimeInMS=u-r,l.transferSyntaxUID=f,l.imageQualityStatus=i,a.add(l,c),s=d}catch(e){if(u)throw console.warn("Couldn't decode",e),e}}})}.bind(this,l,e,"multipart/related; type=application/octet-stream; transfer-syntax=*"),o,i,s),{promise:a.getDonePromise(),cancelFn:void 0}};function It(){(0,ke.registerImageLoader)("wadors",Pt),l.addProvider(ft)}const bt={metaData:{getNumberString:qe,getNumberValue:je,getNumberValues:Ye,getValue:He,metaDataProvider:ft},findIndexOfString:C,getPixelData:mt,loadImage:Pt,metaDataManager:nt,register:It};const Lt=function(){It(),Ve()},At=()=>new Worker(new URL(n.p+n.u(9921),n.b),{type:void 0});const Dt=function(e={}){b(e),Lt();const t=(0,Ee.G_)(),n=e?.maxWebWorkers||function(){if("undefined"!=typeof navigator&&navigator.hardwareConcurrency)return Math.max(1,Math.floor(navigator.hardwareConcurrency/2));return 1}();t.registerWorker("dicomImageLoader",At,{maxWorkerInstances:n})};const _t=function(e,t){if(t=t||e.transferSyntax,8===e.bitsAllocated&&"1.2.840.10008.1.2.4.50"===t&&(3===e.samplesPerPixel||4===e.samplesPerPixel))return!0},Tt={IMPLICIT_VR_LITTLE_ENDIAN:"1.2.840.10008.1.2",EXPLICIT_VR_LITTLE_ENDIAN:"1.2.840.10008.1.2.1",DEFLATED_EXPLICIT_VR_LITTLE_ENDIAN:"1.2.840.10008.1.2.1.99",EXPLICIT_VR_BIG_ENDIAN:"1.2.840.10008.1.2.2",JPEG_BASELINE_PROCESS_1:"1.2.840.10008.1.2.4.50",JPEG_EXTENDED_PROCESS_2_4:"1.2.840.10008.1.2.4.51",JPEG_EXTENDED_PROCESSES_3_5:"1.2.840.10008.1.2.4.52",JPEG_SPECTRAL_SELECTION_NONHIERARCHICAL_PROCESSES_6_8:"1.2.840.10008.1.2.4.53",JPEG_SPECTRAL_SELECTION_NONHIERARCHICAL_PROCESSES_7_9:"1.2.840.10008.1.2.4.54",JPEG_FULL_PROGRESSION_NONHIERARCHICAL_PROCESSES_10_12:"1.2.840.10008.1.2.4.55",JPEG_FULL_PROGRESSION_NONHIERARCHICAL_PROCESSES_11_13:"1.2.840.10008.1.2.4.56",JPEG_LOSSLESS_NONHIERARCHICAL_PROCESS_14:"1.2.840.10008.1.2.4.57",JPEG_LOSSLESS_NONHIERARCHICAL_PROCESS_15:"1.2.840.10008.1.2.4.58",JPEG_EXTENDED_HIERARCHICAL_PROCESSES_16_18:"1.2.840.10008.1.2.4.59",JPEG_EXTENDED_HIERARCHICAL_PROCESSES_17_19:"1.2.840.10008.1.2.4.60",JPEG_SPECTRAL_SELECTION_HIERARCHICAL_PROCESSES_20_22:"1.2.840.10008.1.2.4.61",JPEG_SPECTRAL_SELECTION_HIERARCHICAL_PROCESSES_21_23:"1.2.840.10008.1.2.4.62",JPEG_FULL_PROGRESSION_HIERARCHICAL_PROCESSES_24_26:"1.2.840.10008.1.2.4.63",JPEG_FULL_PROGRESSION_HIERARCHICAL_PROCESSES_25_27:"1.2.840.10008.1.2.4.64",JPEG_LOSSLESS_NONHIERARCHICAL_PROCESS_28:"1.2.840.10008.1.2.4.65",JPEG_LOSSLESS_NONHIERARCHICAL_PROCESS_29:"1.2.840.10008.1.2.4.66",JPEG_LOSSLESS_NONHIERARCHICAL_FIRST_ORDER_PREDICTION_PROCESS_14:"1.2.840.10008.1.2.4.70",JPEG_LS_LOSSLESS_IMAGE_COMPRESSION:"1.2.840.10008.1.2.4.80",JPEG_LS_LOSSY_NEAR_LOSSLESS_IMAGE_COMPRESSION:"1.2.840.10008.1.2.4.81",JPEG_2000_IMAGE_COMPRESSION_LOSSLESS_ONLY:"1.2.840.10008.1.2.4.90",JPEG_2000_IMAGE_COMPRESSION:"1.2.840.10008.1.2.4.91",JPEG_2000_PART_2_MULTICOMPONENT_IMAGE_COMPRESSION_LOSSLESS_ONLY:"1.2.840.10008.1.2.4.92",JPEG_2000_PART_2_MULTICOMPONENT_IMAGE_COMPRESSION:"1.2.840.10008.1.2.4.93",JPIP_REFERENCED:"1.2.840.10008.1.2.4.94",JPIP_REFERENCED_DEFLATE:"1.2.840.10008.1.2.4.95",MPEG2_MAIN_PROFILE_MAIN_LEVEL:"1.2.840.10008.1.2.4.100",MPEG4_AVC_H264_HIGH_PROFILE_LEVEL_4_1:"1.2.840.10008.1.2.4.101",MPEG4_AVC_H264_BD_COMPATIBLE_HIGH_PROFILE_LEVEL_4_1:"1.2.840.10008.1.2.4.102",MPEG4_AVC_H264_HIGH_PROFILE_FOR_2D_VIDEO:"1.2.840.10008.1.2.4.103",MPEG4_AVC_H264_HIGH_PROFILE_FOR_3D_VIDEO:"1.2.840.10008.1.2.4.104",JPIP_LOSSLESS:"1.2.840.10008.1.2.4.96",JPIP_PART2_MULTICOMPONENT_IMAGE_COMPRESSION:"1.2.840.10008.1.2.4.97",RFC_2557_MIME_ENCAPSULATION:"1.2.840.10008.1.2.6.1",JPEG_XR_IMAGE_COMPRESSION:"1.2.840.10008.1.2.6.2",JPEG_2000_IMAGE_COMPRESSION_LOSSLESS_ONLY_RETIRED:"1.2.840.10008.1.2.4.90R",JPEG_2000_IMAGE_COMPRESSION_RETIRED:"1.2.840.10008.1.2.4.91R",JPEG_2000_PART_2_MULTICOMPONENT_IMAGE_COMPRESSION_LOSSLESS_ONLY_RETIRED:"1.2.840.10008.1.2.4.92R",JPEG_2000_PART_2_MULTICOMPONENT_IMAGE_COMPRESSION_RETIRED:"1.2.840.10008.1.2.4.93R"};var wt=n(84218);const Ct={constants:r,convertRGBColorByPixel:a,convertRGBColorByPlane:o,convertYBRFullByPixel:i,convertYBRFullByPlane:s,convertPALETTECOLOR:f,wadouri:$e,wadors:bt,init:Dt,convertColorSpace:be,createImage:Ne,decodeJPEGBaseline8BitColor:Ae,getImageFrame:Te,getPixelData:mt,getMinMax:Se.A,isColorImage:we.A,isJPEGBaseline8BitColor:_t,internal:G,decodeImageFrame:wt.p}},84218:(e,t,n)=>{n.d(t,{p:()=>A});var r=n(14670),a=n(71587),o=n(14590),i=n(61625),s=n(29849),l=n(45565),c=n(42812),u=n(34602),f=n(20038),d=n(71069),m=n(75202),g=n(27649),p=n(27933),h=n(97416),x=n(10678),S=n(47092);const E={bilinear:r.A,replicate:a.A},y={Uint8Array,Uint16Array,Int16Array,Float32Array,Uint32Array};function P(e,t,n,r){const a=void 0!==e.pixelRepresentation&&1===e.pixelRepresentation,o=a&&void 0!==e.bitsStored?32-e.bitsStored:void 0;if(a&&void 0!==o)for(let t=0;t<e.pixelData.length;t++)e.pixelData[t]=e.pixelData[t]<<o>>o;let i=e.pixelData;e.pixelDataLength=e.pixelData.length;const{min:s,max:l}=(0,h.A)(e.pixelData),c=void 0===t.allowFloatRendering||t.allowFloatRendering;let u=(0,S.A)(e.photometricInterpretation)&&void 0===t.targetBuffer?.offset;const f=t.preScale?.enabled,d=f&&Object.values(t.preScale.scalingParameters).some(e=>"number"==typeof e&&!Number.isInteger(e)),m=!t.preScale.enabled||!c&&d,g=t.targetBuffer?.type;if(g&&t.preScale.enabled&&!m){const e=b(s,l,t.preScale.scalingParameters);u=!(0,x.r)(e.min,e.max,y[g])}i=g&&!u?function(e,t,n,r){const{arrayBuffer:a,type:o,offset:i=0,length:s,rows:l}=e.targetBuffer,c=n[o];if(!c)throw new Error(`target array ${o} is not supported, or doesn't exist.`);l&&l!=t.rows&&function(e,t,n){const r=function(e,t,n){const{samplesPerPixel:r}=e,{rows:a,columns:o}=t,i=a*o*r,s=new n(i),l=s.byteLength/i;return{pixelData:s,rows:a,columns:o,frameInfo:{...e.frameInfo,rows:a,columns:o},imageInfo:{...e.imageInfo,rows:a,columns:o,bytesPerPixel:l}}}(e,t,n),{scalingType:a="replicate"}=t;E[a](e,r),Object.assign(e,r),e.pixelDataLength=e.pixelData.length}(t,e.targetBuffer,c);const u=t.pixelDataLength,f=i,d=null!=s?s:u-f,m=t.pixelData;if(d!==m.length)throw new Error(`target array for image does not have the same length (${d}) as the decoded image length (${m.length}).`);const g=a?new c(a,f,d):new c(d);return g.set(m,0),r=g,r}(t,e,y,i):t.preScale.enabled&&!m?function(e,t,n,r){const a=e.preScale.scalingParameters;L(a);const o=b(t,n,a);return I(o.min,o.max,r)}(t,s,l,e):I(s,l,e);let P=s,A=l;if(t.preScale.enabled&&!m){const n=t.preScale.scalingParameters;L(n);const r=function(e){const{rescaleSlope:t,rescaleIntercept:n,modality:r,doseGridScaling:a,suvbw:o}=e,i="RTDOSE"===r&&"number"==typeof a,s="PT"===r&&"number"==typeof o;return"number"==typeof t&&"number"==typeof n||i||s}(n);if(r){(0,p.A)(i,n),e.preScale={...t.preScale,scaled:!0};const r=b(s,l,n);P=r.min,A=r.max}}else m&&(e.preScale={enabled:!0,scaled:!1},P=s,A=l);e.pixelData=i,e.smallestPixelValue=P,e.largestPixelValue=A;const D=(new Date).getTime();return e.decodeTimeInMS=D-n,e}function I(e,t,n){const r=new((0,x.A)(e,t))(n.pixelData.length);return r.set(n.pixelData,0),r}function b(e,t,n){const{rescaleSlope:r,rescaleIntercept:a,modality:o,doseGridScaling:i,suvbw:s}=n;return"PT"!==o||"number"!=typeof s||isNaN(s)?"RTDOSE"!==o||"number"!=typeof i||isNaN(i)?"number"==typeof r&&"number"==typeof a?{min:r*e+a,max:r*t+a}:{min:e,max:t}:{min:e*i,max:t*i}:{min:s*(e*r+a),max:s*(t*r+a)}}function L(e){if(!e)throw new Error("options.preScale.scalingParameters must be defined if preScale.enabled is true, and scalingParameters cannot be derived from the metadata providers.")}async function A(e,t,n,r,a,o){const p=(new Date).getTime();let h,x=null;switch(t){case"1.2.840.10008.1.2":case"1.2.840.10008.1.2.1":case"1.2.840.10008.1.2.1.99":x=(0,i.A)(e,n);break;case"1.2.840.10008.1.2.2":x=(0,s.A)(e,n);break;case"1.2.840.10008.1.2.5":x=(0,l.A)(e,n);break;case"1.2.840.10008.1.2.4.50":h={...e},x=(0,c.A)(n,h);break;case"1.2.840.10008.1.2.4.51":x=(0,u.A)(e,n);break;case"1.2.840.10008.1.2.4.57":case"1.2.840.10008.1.2.4.70":x=(0,f.A)(e,n);break;case"1.2.840.10008.1.2.4.80":case"1.2.840.10008.1.2.4.81":h={signed:1===e.pixelRepresentation,bytesPerPixel:e.bitsAllocated<=8?1:2,...e},x=(0,d.A)(n,h);break;case"1.2.840.10008.1.2.4.90":case"1.2.840.10008.1.2.4.91":h={...e},x=(0,m.A)(n,h);break;case"3.2.840.10008.1.2.4.96":case"1.2.840.10008.1.2.4.201":case"1.2.840.10008.1.2.4.202":case"1.2.840.10008.1.2.4.203":h={...e},x=(0,g.A)(n,h);break;default:throw new Error(`no decoder for transfer syntax ${t}`)}if(!x)throw new Error("decodePromise not defined");const S=P(await x,a,p);return o?.(S),S}const D={decodeTask:({imageFrame:e,transferSyntax:t,decodeConfig:n,options:r,pixelData:a,callbackFn:o})=>A(e,t,a,0,r,o)};(0,o.p)(D)}}]);