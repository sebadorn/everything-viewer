"use strict";(self.webpackChunkeverything_viewer=self.webpackChunkeverything_viewer||[]).push([[5316],{45316:(e,t,n)=>{n.d(t,{l2:()=>q,GLTFFileLoader:()=>B,BT:()=>W,dM:()=>j});var s=n(39018),r=n(79923),o=n(26041),a=n(998),i=n(30388),l=n(11710),h=n(36504),d=n(15397),c=n(28986),u=n(23975),_=n(7481),p=n(97328),f=n(95616),b=n(27050),m=n(35985),y=n(76595),g=n(80706),A=n(98639),v=n(99848),x=n(15909),E=n(97889),M=n(51137),w=n(97974);function C(e,t,n,s){const r={externalResourceFunction:s};return n&&(r.uri="file:"===t?n:t+n),ArrayBuffer.isView(e)?GLTFValidator.validateBytes(e,r):GLTFValidator.validateString(e,r)}function T(){const e=[];onmessage=t=>{const n=t.data;switch(n.id){case"init":importScripts(n.url);break;case"validate":C(n.data,n.rootUrl,n.fileName,(t=>new Promise(((n,s)=>{const r=e.length;e.push({resolve:n,reject:s}),postMessage({id:"getExternalResource",index:r,uri:t})})))).then((e=>{postMessage({id:"validate.resolve",value:e})}),(e=>{postMessage({id:"validate.reject",reason:e})}));break;case"getExternalResource.resolve":e[n.index].resolve(n.value);break;case"getExternalResource.reject":e[n.index].reject(n.reason)}}}class S{static ValidateAsync(e,t,n,s){return"function"==typeof Worker?new Promise(((r,o)=>{const i=`${C}(${T})()`,l=URL.createObjectURL(new Blob([i],{type:"application/javascript"})),h=new Worker(l),d=e=>{h.removeEventListener("error",d),h.removeEventListener("message",c),o(e)},c=e=>{const t=e.data;switch(t.id){case"getExternalResource":s(t.uri).then((e=>{h.postMessage({id:"getExternalResource.resolve",index:t.index,value:e},[e.buffer])}),(e=>{h.postMessage({id:"getExternalResource.reject",index:t.index,reason:e})}));break;case"validate.resolve":h.removeEventListener("error",d),h.removeEventListener("message",c),r(t.value),h.terminate();break;case"validate.reject":h.removeEventListener("error",d),h.removeEventListener("message",c),o(t.reason),h.terminate()}};if(h.addEventListener("error",d),h.addEventListener("message",c),h.postMessage({id:"init",url:a.S0.GetBabylonScriptURL(this.Configuration.url)}),ArrayBuffer.isView(e)){const s=e.slice();h.postMessage({id:"validate",data:s,rootUrl:t,fileName:n},[s.buffer])}else h.postMessage({id:"validate",data:e,rootUrl:t,fileName:n})})):(this._LoadScriptPromise||(this._LoadScriptPromise=a.S0.LoadBabylonScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then((()=>C(e,t,n,s))))}}S.Configuration={url:`${a.S0._DefaultCdnUrl}/gltf_validator.js`};var L,O,$,P=n(2972),R=n(8532),k=n(88563);function N(e,t,n){try{return Promise.resolve(new Uint8Array(e,t,n))}catch(e){return Promise.reject(e)}}!function(e){e[e.AUTO=0]="AUTO",e[e.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"}(L||(L={})),function(e){e[e.NONE=0]="NONE",e[e.FIRST=1]="FIRST",e[e.ALL=2]="ALL"}(O||(O={})),function(e){e[e.LOADING=0]="LOADING",e[e.READY=1]="READY",e[e.COMPLETE=2]="COMPLETE"}($||($={}));class I{constructor(){this.coordinateSystemMode=L.AUTO,this.animationStartMode=O.FIRST,this.loadNodeAnimations=!0,this.loadSkins=!0,this.loadMorphTargets=!0,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.loadOnlyMaterials=!1,this.skipMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.useGltfTextureNames=!1,this.preprocessUrlAsync=e=>Promise.resolve(e),this.extensionOptions={}}copyFrom(e){e&&(this.onParsed=e.onParsed,this.coordinateSystemMode=e.coordinateSystemMode??this.coordinateSystemMode,this.animationStartMode=e.animationStartMode??this.animationStartMode,this.loadNodeAnimations=e.loadNodeAnimations??this.loadNodeAnimations,this.loadSkins=e.loadSkins??this.loadSkins,this.loadMorphTargets=e.loadMorphTargets??this.loadMorphTargets,this.compileMaterials=e.compileMaterials??this.compileMaterials,this.useClipPlane=e.useClipPlane??this.useClipPlane,this.compileShadowGenerators=e.compileShadowGenerators??this.compileShadowGenerators,this.transparencyAsCoverage=e.transparencyAsCoverage??this.transparencyAsCoverage,this.useRangeRequests=e.useRangeRequests??this.useRangeRequests,this.createInstances=e.createInstances??this.createInstances,this.alwaysComputeBoundingBox=e.alwaysComputeBoundingBox??this.alwaysComputeBoundingBox,this.loadAllMaterials=e.loadAllMaterials??this.loadAllMaterials,this.loadOnlyMaterials=e.loadOnlyMaterials??this.loadOnlyMaterials,this.skipMaterials=e.skipMaterials??this.skipMaterials,this.useSRGBBuffers=e.useSRGBBuffers??this.useSRGBBuffers,this.targetFps=e.targetFps??this.targetFps,this.alwaysComputeSkeletonRootNode=e.alwaysComputeSkeletonRootNode??this.alwaysComputeSkeletonRootNode,this.useGltfTextureNames=e.useGltfTextureNames??this.useGltfTextureNames,this.preprocessUrlAsync=e.preprocessUrlAsync??this.preprocessUrlAsync,this.customRootNode=e.customRootNode,this.onMeshLoaded=e.onMeshLoaded,this.onSkinLoaded=e.onSkinLoaded,this.onTextureLoaded=e.onTextureLoaded,this.onMaterialLoaded=e.onMaterialLoaded,this.onCameraLoaded=e.onCameraLoaded,this.extensionOptions=e.extensionOptions??this.extensionOptions)}}class B extends I{constructor(e){super(),this.onParsedObservable=new v.cP,this.onMeshLoadedObservable=new v.cP,this.onSkinLoadedObservable=new v.cP,this.onTextureLoadedObservable=new v.cP,this.onMaterialLoadedObservable=new v.cP,this.onCameraLoadedObservable=new v.cP,this.onCompleteObservable=new v.cP,this.onErrorObservable=new v.cP,this.onDisposeObservable=new v.cP,this.onExtensionLoadedObservable=new v.cP,this.validate=!1,this.onValidatedObservable=new v.cP,this._loader=null,this._state=null,this._requests=new Array,this.name=P._.name,this.extensions=P._.extensions,this.onLoaderStateChangedObservable=new v.cP,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled,this.copyFrom(e)}set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),e&&(this._onParsedObserver=this.onParsedObservable.add(e))}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),e&&(this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e))}set onSkinLoaded(e){this._onSkinLoadedObserver&&this.onSkinLoadedObservable.remove(this._onSkinLoadedObserver),e&&(this._onSkinLoadedObserver=this.onSkinLoadedObservable.add((t=>e(t.node,t.skinnedNode))))}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),e&&(this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e))}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),e&&(this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e))}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),e&&(this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e))}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const e of this._requests)e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(e,t,n,s,r,o,i,l){if(ArrayBuffer.isView(t))return this._loadBinary(e,t,n,s,i,l),null;this._progressCallback=r;const h=t.name||a.S0.GetFilename(t);if(o){if(this.useRangeRequests){this.validate&&M.V.Warn("glTF validation is not supported when range requests are enabled");const n={abort:()=>{},onCompleteObservable:new v.cP},r={readAsync:(n,s)=>new Promise(((r,o)=>{this._loadFile(e,t,(e=>{r(new Uint8Array(e))}),!0,(e=>{o(e)}),(e=>{e.setRequestHeader("Range",`bytes=${n}-${n+s-1}`)}))})),byteLength:0};return this._unpackBinaryAsync(new w.s(r)).then((e=>{n.onCompleteObservable.notifyObservers(n),s(e)}),i?e=>i(void 0,e):void 0),n}return this._loadFile(e,t,(t=>{this._validate(e,new Uint8Array(t,0,t.byteLength),n,h),this._unpackBinaryAsync(new w.s({readAsync:(e,n)=>N(t,e,n),byteLength:t.byteLength})).then((e=>{s(e)}),i?e=>i(void 0,e):void 0)}),!0,i)}return this._loadFile(e,t,(t=>{try{this._validate(e,t,n,h),s({json:this._parseJson(t)})}catch{i&&i()}}),!1,i)}_loadBinary(e,t,n,s,r,o){this._validate(e,new Uint8Array(t.buffer,t.byteOffset,t.byteLength),n,o),this._unpackBinaryAsync(new w.s({readAsync:(e,n)=>function(e,t,n){try{if(t<0||t>=e.byteLength)throw new RangeError("Offset is out of range.");if(t+n>e.byteLength)throw new RangeError("Length is out of range.");return Promise.resolve(new Uint8Array(e.buffer,e.byteOffset+t,n))}catch(e){return Promise.reject(e)}}(t,e,n),byteLength:t.byteLength})).then((e=>{s(e)}),r?e=>r(void 0,e):void 0)}importMeshAsync(e,t,n,s,r,o){return Promise.resolve().then((()=>(this.onParsedObservable.notifyObservers(n),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(n),this._loader.importMeshAsync(e,t,null,n,s,r,o))))}loadAsync(e,t,n,s,r){return Promise.resolve().then((()=>(this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${r||""}`),this._loader=this._getLoader(t),this._loader.loadAsync(e,t,n,s,r))))}loadAssetContainerAsync(e,t,n,s,r){return Promise.resolve().then((()=>{this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${r||""}`),this._loader=this._getLoader(t);const o=new E.WZ(e),a=[];this.onMaterialLoadedObservable.add((e=>{a.push(e)}));const i=[];this.onTextureLoadedObservable.add((e=>{i.push(e)}));const l=[];this.onCameraLoadedObservable.add((e=>{l.push(e)}));const h=[];return this.onMeshLoadedObservable.add((e=>{e.morphTargetManager&&h.push(e.morphTargetManager)})),this._loader.importMeshAsync(null,e,o,t,n,s,r).then((e=>(Array.prototype.push.apply(o.geometries,e.geometries),Array.prototype.push.apply(o.meshes,e.meshes),Array.prototype.push.apply(o.particleSystems,e.particleSystems),Array.prototype.push.apply(o.skeletons,e.skeletons),Array.prototype.push.apply(o.animationGroups,e.animationGroups),Array.prototype.push.apply(o.materials,a),Array.prototype.push.apply(o.textures,i),Array.prototype.push.apply(o.lights,e.lights),Array.prototype.push.apply(o.transformNodes,e.transformNodes),Array.prototype.push.apply(o.cameras,l),Array.prototype.push.apply(o.morphTargetManagers,h),o)))}))}canDirectLoad(e){return P._.canDirectLoad(e)}directLoad(e,t){if(t.startsWith("base64,"+P.i)||t.startsWith(";base64,"+P.i)||t.startsWith("application/octet-stream;base64,"+P.i)||t.startsWith("model/gltf-binary;base64,"+P.i)){const n=(0,R.rz)(t);return this._validate(e,new Uint8Array(n,0,n.byteLength)),this._unpackBinaryAsync(new w.s({readAsync:(e,t)=>N(n,e,t),byteLength:n.byteLength}))}return this._validate(e,t),Promise.resolve({json:this._parseJson(t)})}createPlugin(e){return new B(e[P._.name])}get loaderState(){return this._state}whenCompleteAsync(){return new Promise(((e,t)=>{this.onCompleteObservable.addOnce((()=>{e()})),this.onErrorObservable.addOnce((e=>{t(e)}))}))}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log($[this._state]))}_loadFile(e,t,n,s,r,o){const a=e._loadFile(t,n,(e=>{this._onProgress(e,a)}),!0,s,r,o);return a.onCompleteObservable.add((()=>{a._lengthComputable=!0,a._total=a._loaded})),this._requests.push(a),a}_onProgress(e,t){if(!this._progressCallback)return;t._lengthComputable=e.lengthComputable,t._loaded=e.loaded,t._total=e.total;let n=!0,s=0,r=0;for(const e of this._requests){if(void 0===e._lengthComputable||void 0===e._loaded||void 0===e._total)return;n=n&&e._lengthComputable,s+=e._loaded,r+=e._total}this._progressCallback({lengthComputable:n,loaded:s,total:n?r:0})}_validate(e,t,n="",s=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),S.ValidateAsync(t,n,s,(t=>this.preprocessUrlAsync(n+t).then((t=>e._loadFileAsync(t,void 0,!0,!0).then((e=>new Uint8Array(e,0,e.byteLength))))))).then((e=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(e),this.onValidatedObservable.clear()}),(e=>{this._endPerformanceCounter("Validate JSON"),a.S0.Warn(`Failed to validate: ${e.message}`),this.onValidatedObservable.clear()})))}_getLoader(e){const t=e.json.asset||{};this._log(`Asset version: ${t.version}`),t.minVersion&&this._log(`Asset minimum version: ${t.minVersion}`),t.generator&&this._log(`Asset generator: ${t.generator}`);const n=B._parseVersion(t.version);if(!n)throw new Error("Invalid version: "+t.version);if(void 0!==t.minVersion){const e=B._parseVersion(t.minVersion);if(!e)throw new Error("Invalid minimum version: "+t.minVersion);if(B._compareVersion(e,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+t.minVersion)}const s={1:B._CreateGLTF1Loader,2:B._CreateGLTF2Loader}[n.major];if(!s)throw new Error("Unsupported version: "+t.version);return s(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${e.length}`);const t=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),t}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then((()=>{const t=e.readUint32();if(1179937895!==t)throw new k.bu("Unexpected magic: "+t,k.tG.GLTFLoaderUnexpectedMagicError);const n=e.readUint32();this.loggingEnabled&&this._log(`Binary version: ${n}`);const s=e.readUint32();let r;switch(this.useRangeRequests||s===e.buffer.byteLength||M.V.Warn(`Length in header does not match actual data length: ${s} != ${e.buffer.byteLength}`),n){case 1:r=this._unpackBinaryV1Async(e,s);break;case 2:r=this._unpackBinaryV2Async(e,s);break;default:throw new Error("Unsupported version: "+n)}return this._endPerformanceCounter("Unpack Binary"),r}))}_unpackBinaryV1Async(e,t){const n=e.readUint32(),s=e.readUint32();if(0!==s)throw new Error(`Unexpected content format: ${s}`);const r=t-e.byteOffset,o={json:this._parseJson(e.readString(n)),bin:null};if(0!==r){const t=e.byteOffset;o.bin={readAsync:(n,s)=>e.buffer.readAsync(t+n,s),byteLength:r}}return Promise.resolve(o)}_unpackBinaryV2Async(e,t){const n=1313821514,s=5130562,r=e.readUint32();if(e.readUint32()!==n)throw new Error("First chunk format is not JSON");return e.byteOffset+r===t?e.loadAsync(r).then((()=>({json:this._parseJson(e.readString(r)),bin:null}))):e.loadAsync(r+8).then((()=>{const o={json:this._parseJson(e.readString(r)),bin:null},a=()=>{const r=e.readUint32();switch(e.readUint32()){case n:throw new Error("Unexpected JSON chunk");case s:{const t=e.byteOffset;o.bin={readAsync:(n,s)=>e.buffer.readAsync(t+n,s),byteLength:r},e.skipBytes(r);break}default:e.skipBytes(r)}return e.byteOffset!==t?e.loadAsync(8).then(a):Promise.resolve(o)};return a()}))}static _parseVersion(e){if("1.0"===e||"1.0.1"===e)return{major:1,minor:0};const t=(e+"").match(/^(\d+)\.(\d+)/);return t?{major:parseInt(t[1]),minor:parseInt(t[2])}:null}static _compareVersion(e,t){return e.major>t.major?1:e.major<t.major?-1:e.minor>t.minor?1:e.minor<t.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(e){const t=B._logSpaces.substring(0,2*this._logIndentLevel);M.V.Log(`${t}${e}`)}_logDisabled(e){}_startPerformanceCounterEnabled(e){a.S0.StartPerformanceCounter(e)}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(e){a.S0.EndPerformanceCounter(e)}_endPerformanceCounterDisabled(e){}}B.IncrementalLoading=!0,B.HomogeneousCoordinates=!1,B._logSpaces="                                ",(0,x.qS)(new B);var V=n(20863),F=n(37812),G=n(49532),D=n(28853),U=n(11675);class q{static Get(e,t,n){if(!t||null==n||!t[n])throw new Error(`${e}: Failed to find index (${n})`);return t[n]}static TryGet(e,t){return e&&null!=t&&e[t]?e[t]:null}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}}function j(e){if(e.min&&e.max){const t=e.min,n=e.max,s=r.AA.Vector3[0].copyFromFloats(t[0],t[1],t[2]),o=r.AA.Vector3[1].copyFromFloats(n[0],n[1],n[2]);if(e.normalized&&5126!==e.componentType){let t=1;switch(e.componentType){case 5120:t=127;break;case 5121:t=255;break;case 5122:t=32767;break;case 5123:t=65535}const n=1/t;s.scaleInPlace(n),o.scaleInPlace(n)}return new V.j(s,o)}return null}class W{static RegisterExtension(e,t){(0,F.Ye)(e,!1,t)}static UnregisterExtension(e){return(0,F.Hg)(e)}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}get rootUrl(){return this._rootUrl}constructor(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._allMaterialsDirtyRequired=!1,this._skipStartAnimationStep=!1,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=e}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach((e=>e.dispose&&e.dispose())),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}importMeshAsync(e,t,n,s,r,o,a=""){return Promise.resolve().then((()=>{this._babylonScene=t,this._assetContainer=n,this._loadData(s);let o=null;if(e){const t={};if(this._gltf.nodes)for(const e of this._gltf.nodes)e.name&&(t[e.name]=e.index);o=(e instanceof Array?e:[e]).map((e=>{const n=t[e];if(void 0===n)throw new Error(`Failed to find node '${e}'`);return n}))}return this._loadAsync(r,a,o,(()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries(),spriteManagers:[]})))}))}loadAsync(e,t,n,s,r=""){return Promise.resolve().then((()=>(this._babylonScene=e,this._loadData(t),this._loadAsync(n,r,null,(()=>{})))))}_loadAsync(e,t,n,s){return Promise.resolve().then((async()=>{this._rootUrl=e,this._uniqueRootUrl=!e.startsWith("file:")&&t?e:`${e}${Date.now()}/`,this._fileName=t,this._allMaterialsDirtyRequired=!1,await this._loadExtensionsAsync();const r=`${$[$.LOADING]} => ${$[$.READY]}`,o=`${$[$.LOADING]} => ${$[$.COMPLETE]}`;this._parent._startPerformanceCounter(r),this._parent._startPerformanceCounter(o),this._parent._setState($.LOADING),this._extensionsOnLoading();const i=new Array,l=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials)if(n)i.push(this.loadSceneAsync("/nodes",{nodes:n,index:-1}));else if(null!=this._gltf.scene||this._gltf.scenes&&this._gltf.scenes[0]){const e=q.Get("/scene",this._gltf.scenes,this._gltf.scene||0);i.push(this.loadSceneAsync(`/scenes/${e.index}`,e))}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let e=0;e<this._gltf.materials.length;++e){const t=this._gltf.materials[e],n="/materials/"+e,s=c.i.TriangleFillMode;i.push(this._loadMaterialAsync(n,t,null,s,(()=>{})))}this._allMaterialsDirtyRequired?this._babylonScene.blockMaterialDirtyMechanism=l:this._babylonScene._forceBlockMaterialDirtyMechanism(l),this._parent.compileMaterials&&i.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&i.push(this._compileShadowGeneratorsAsync());return Promise.all(i).then((()=>{this._rootBabylonMesh&&this._rootBabylonMesh!==this._parent.customRootNode&&this._rootBabylonMesh.setEnabled(!0);for(const e of this._babylonScene.materials){const t=e;void 0!==t.maxSimultaneousLights&&(t.maxSimultaneousLights=Math.max(t.maxSimultaneousLights,this._babylonScene.lights.length))}return this._extensionsOnReady(),this._parent._setState($.READY),this._skipStartAnimationStep||this._startAnimations(),s()})).then((e=>(this._parent._endPerformanceCounter(r),a.S0.SetImmediate((()=>{this._disposed||Promise.all(this._completePromises).then((()=>{this._parent._endPerformanceCounter(o),this._parent._setState($.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()}),(e=>{this._parent.onErrorObservable.notifyObservers(e),this._parent.onErrorObservable.clear(),this.dispose()}))})),e)))})).catch((e=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(e),this._parent.onErrorObservable.clear(),this.dispose()),e}))}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){const t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){const n=t[0];(n.byteLength<e.bin.byteLength-3||n.byteLength>e.bin.byteLength)&&M.V.Warn(`Binary buffer length (${n.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin}else M.V.Warn("Unexpected BIN chunk")}}_setupData(){if(q.Assign(this._gltf.accessors),q.Assign(this._gltf.animations),q.Assign(this._gltf.buffers),q.Assign(this._gltf.bufferViews),q.Assign(this._gltf.cameras),q.Assign(this._gltf.images),q.Assign(this._gltf.materials),q.Assign(this._gltf.meshes),q.Assign(this._gltf.nodes),q.Assign(this._gltf.samplers),q.Assign(this._gltf.scenes),q.Assign(this._gltf.skins),q.Assign(this._gltf.textures),this._gltf.nodes){const e={};for(const t of this._gltf.nodes)if(t.children)for(const n of t.children)e[n]=t.index;const t=this._createRootNode();for(const n of this._gltf.nodes){const s=e[n.index];n.parent=void 0===s?t:this._gltf.nodes[s]}}}async _loadExtensionsAsync(){const e=[];if(F.Sv.forEach(((t,n)=>{!1===this.parent.extensionOptions[n]?.enabled?t.isGLTFExtension&&this.isExtensionUsed(n)&&M.V.Warn(`Extension ${n} is used but has been explicitly disabled.`):t.isGLTFExtension&&!this.isExtensionUsed(n)||e.push((async()=>{const e=await t.factory(this);return e.name!==n&&M.V.Warn(`The name of the glTF loader extension instance does not match the registered name: ${e.name} !== ${n}`),this._parent.onExtensionLoadedObservable.notifyObservers(e),e})())})),this._extensions.push(...await Promise.all(e)),this._extensions.sort(((e,t)=>(e.order||Number.MAX_VALUE)-(t.order||Number.MAX_VALUE))),this._parent.onExtensionLoadedObservable.clear(),this._gltf.extensionsRequired)for(const e of this._gltf.extensionsRequired){if(!this._extensions.some((t=>t.name===e&&t.enabled))){if(!1===this.parent.extensionOptions[e]?.enabled)throw new Error(`Required extension ${e} is disabled`);throw new Error(`Required extension ${e} is not available`)}}}_createRootNode(){if(void 0!==this._parent.customRootNode)return this._rootBabylonMesh=this._parent.customRootNode,{_babylonTransformNode:null===this._rootBabylonMesh?void 0:this._rootBabylonMesh,index:-1};this._babylonScene._blockEntityCollection=!!this._assetContainer;const e=new y.e("__root__",this._babylonScene);this._rootBabylonMesh=e,this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);const t={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case L.AUTO:this._babylonScene.useRightHandedSystem||(t.rotation=[0,1,0,0],t.scale=[1,1,-1],W._LoadTransform(t,this._rootBabylonMesh));break;case L.FORCE_RIGHT_HANDED:this._babylonScene.useRightHandedSystem=!0;break;default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(e),t}loadSceneAsync(e,t){const n=this._extensionsLoadSceneAsync(e,t);if(n)return n;const s=new Array;if(this.logOpen(`${e} ${t.name||""}`),t.nodes)for(const n of t.nodes){const t=q.Get(`${e}/nodes/${n}`,this._gltf.nodes,n);s.push(this.loadNodeAsync(`/nodes/${t.index}`,t,(e=>{e.parent=this._rootBabylonMesh})))}for(const e of this._postSceneLoadActions)e();return s.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(s).then((()=>{}))}_forEachPrimitive(e,t){if(e._primitiveBabylonMeshes)for(const n of e._primitiveBabylonMeshes)t(n)}_getGeometries(){const e=[],t=this._gltf.nodes;if(t)for(const n of t)this._forEachPrimitive(n,(t=>{const n=t.geometry;n&&-1===e.indexOf(n)&&e.push(n)}));return e}_getMeshes(){const e=[];this._rootBabylonMesh instanceof m.u&&e.push(this._rootBabylonMesh);const t=this._gltf.nodes;if(t)for(const n of t)this._forEachPrimitive(n,(t=>{e.push(t)}));return e}_getTransformNodes(){const e=[],t=this._gltf.nodes;if(t)for(const n of t)n._babylonTransformNode&&"TransformNode"===n._babylonTransformNode.getClassName()&&e.push(n._babylonTransformNode),n._babylonTransformNodeForSkin&&e.push(n._babylonTransformNodeForSkin);return e}_getSkeletons(){const e=[],t=this._gltf.skins;if(t)for(const n of t)n._data&&e.push(n._data.babylonSkeleton);return e}_getAnimationGroups(){const e=[],t=this._gltf.animations;if(t)for(const n of t)n._babylonAnimationGroup&&e.push(n._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case O.NONE:break;case O.FIRST:{const e=this._getAnimationGroups();0!==e.length&&e[0].start(!0);break}case O.ALL:{const e=this._getAnimationGroups();for(const t of e)t.start(!0);break}default:return void M.V.Error(`Invalid animation start mode (${this._parent.animationStartMode})`)}}loadNodeAsync(e,t,n=()=>{}){const s=this._extensionsLoadNodeAsync(e,t,n);if(s)return s;if(t._babylonTransformNode)throw new Error(`${e}: Invalid recursive node hierarchy`);const r=new Array;this.logOpen(`${e} ${t.name||""}`);const o=s=>{if(W.AddPointerMetadata(s,e),W._LoadTransform(t,s),null!=t.camera){const n=q.Get(`${e}/camera`,this._gltf.cameras,t.camera);r.push(this.loadCameraAsync(`/cameras/${n.index}`,n,(e=>{e.parent=s})))}if(t.children)for(const n of t.children){const t=q.Get(`${e}/children/${n}`,this._gltf.nodes,n);r.push(this.loadNodeAsync(`/nodes/${t.index}`,t,(e=>{e.parent=s})))}n(s)},a=null!=t.mesh,i=this._parent.loadSkins&&null!=t.skin;if(!a||i){const e=t.name||`node${t.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new p.V(e,this._babylonScene);n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,null==t.mesh?t._babylonTransformNode=n:t._babylonTransformNodeForSkin=n,o(n)}if(a)if(i){const n=q.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);r.push(this._loadMeshAsync(`/meshes/${n.index}`,t,n,(n=>{const s=t._babylonTransformNodeForSkin;n.metadata=(0,D.$)(s.metadata,n.metadata||{});const o=q.Get(`${e}/skin`,this._gltf.skins,t.skin);r.push(this._loadSkinAsync(`/skins/${o.index}`,t,o,(e=>{this._forEachPrimitive(t,(t=>{t.skeleton=e})),this._postSceneLoadActions.push((()=>{if(null!=o.skeleton){const e=q.Get(`/skins/${o.index}/skeleton`,this._gltf.nodes,o.skeleton).parent;t.index===e.index?n.parent=s.parent:n.parent=e._babylonTransformNode}else n.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:s,skinnedNode:n})}))})))})))}else{const n=q.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);r.push(this._loadMeshAsync(`/meshes/${n.index}`,t,n,o))}return this.logClose(),Promise.all(r).then((()=>(this._forEachPrimitive(t,(e=>{const t=e;!t.isAnInstance&&t.geometry&&t.geometry.useBoundingInfoFromGeometry?e._updateBoundingInfo():e.refreshBoundingInfo(!0,!0)})),t._babylonTransformNode)))}_loadMeshAsync(e,t,n,s){const r=n.primitives;if(!r||!r.length)throw new Error(`${e}: Primitives are missing`);null==r[0].index&&q.Assign(r);const o=new Array;this.logOpen(`${e} ${n.name||""}`);const a=t.name||`node${t.index}`;if(1===r.length){const s=n.primitives[0];o.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${s.index}`,a,t,n,s,(e=>{t._babylonTransformNode=e,t._primitiveBabylonMeshes=[e]})))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,t._babylonTransformNode=new p.V(a,this._babylonScene),t._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._primitiveBabylonMeshes=[];for(const s of r)o.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${s.index}`,`${a}_primitive${s.index}`,t,n,s,(e=>{e.parent=t._babylonTransformNode,t._primitiveBabylonMeshes.push(e)})))}return s(t._babylonTransformNode),this.logClose(),Promise.all(o).then((()=>t._babylonTransformNode))}_loadMeshPrimitiveAsync(e,t,n,s,r,o){const a=this._extensionsLoadMeshPrimitiveAsync(e,t,n,s,r,o);if(a)return a;this.logOpen(`${e}`);const i=0===this._disableInstancedMesh&&this._parent.createInstances&&null==n.skin&&!s.primitives[0].targets;let l,h;if(i&&r._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,l=r._instanceData.babylonSourceMesh.createInstance(t),l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,h=r._instanceData.promise;else{const o=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new y.e(t,this._babylonScene);a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,a.sideOrientation=this._babylonScene.useRightHandedSystem?c.i.CounterClockWiseSideOrientation:c.i.ClockWiseSideOrientation,this._createMorphTargets(e,n,s,r,a),o.push(this._loadVertexDataAsync(e,r,a).then((t=>this._loadMorphTargetsAsync(e,r,a,t).then((()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,t.applyToMesh(a),t._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})))));const d=W._GetDrawMode(e,r.mode);if(null==r.material){let e=this._defaultBabylonMaterialData[d];e||(e=this._createDefaultMaterial("__GLTFLoader._default",d),this._parent.onMaterialLoadedObservable.notifyObservers(e),this._defaultBabylonMaterialData[d]=e),a.material=e}else if(!this.parent.skipMaterials){const t=q.Get(`${e}/material`,this._gltf.materials,r.material);o.push(this._loadMaterialAsync(`/materials/${t.index}`,t,a,d,(e=>{a.material=e})))}h=Promise.all(o),i&&(r._instanceData={babylonSourceMesh:a,promise:h}),l=a}return W.AddPointerMetadata(l,e),this._parent.onMeshLoadedObservable.notifyObservers(l),o(l),this.logClose(),h.then((()=>l))}_loadVertexDataAsync(e,t,n){const s=this._extensionsLoadVertexDataAsync(e,t,n);if(s)return s;const r=t.attributes;if(!r)throw new Error(`${e}: Attributes are missing`);const o=new Array,a=new b.V(n.name,this._babylonScene);if(null==t.indices)n.isUnIndexed=!0;else{const n=q.Get(`${e}/indices`,this._gltf.accessors,t.indices);o.push(this._loadIndicesAccessorAsync(`/accessors/${n.index}`,n).then((e=>{a.setIndices(e)})))}const i=(t,s,i)=>{if(null==r[t])return;n._delayInfo=n._delayInfo||[],-1===n._delayInfo.indexOf(s)&&n._delayInfo.push(s);const l=q.Get(`${e}/attributes/${t}`,this._gltf.accessors,r[t]);o.push(this._loadVertexAccessorAsync(`/accessors/${l.index}`,l,s).then((e=>{if(e.getKind()===f.R.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!n.skeleton){const e=j(l);e&&(a._boundingInfo=e,a.useBoundingInfoFromGeometry=!0)}a.setVerticesBuffer(e,l.count)}))),s==f.R.MatricesIndicesExtraKind&&(n.numBoneInfluencers=8),i&&i(l)};return i("POSITION",f.R.PositionKind),i("NORMAL",f.R.NormalKind),i("TANGENT",f.R.TangentKind),i("TEXCOORD_0",f.R.UVKind),i("TEXCOORD_1",f.R.UV2Kind),i("TEXCOORD_2",f.R.UV3Kind),i("TEXCOORD_3",f.R.UV4Kind),i("TEXCOORD_4",f.R.UV5Kind),i("TEXCOORD_5",f.R.UV6Kind),i("JOINTS_0",f.R.MatricesIndicesKind),i("WEIGHTS_0",f.R.MatricesWeightsKind),i("JOINTS_1",f.R.MatricesIndicesExtraKind),i("WEIGHTS_1",f.R.MatricesWeightsExtraKind),i("COLOR_0",f.R.ColorKind,(e=>{"VEC4"===e.type&&(n.hasVertexAlpha=!0)})),Promise.all(o).then((()=>a))}_createMorphTargets(e,t,n,s,r){if(!s.targets||!this._parent.loadMorphTargets)return;if(null==t._numMorphTargets)t._numMorphTargets=s.targets.length;else if(s.targets.length!==t._numMorphTargets)throw new Error(`${e}: Primitives do not have the same number of targets`);const o=n.extras?n.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,r.morphTargetManager=new A.j(this._babylonScene),r.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,r.morphTargetManager.areUpdatesFrozen=!0;for(let e=0;e<s.targets.length;e++){const s=t.weights?t.weights[e]:n.weights?n.weights[e]:0,a=o?o[e]:`morphTarget${e}`;r.morphTargetManager.addTarget(new g.M(a,s,r.getScene()))}}_loadMorphTargetsAsync(e,t,n,s){if(!t.targets||!this._parent.loadMorphTargets)return Promise.resolve();const r=new Array,o=n.morphTargetManager;for(let n=0;n<o.numTargets;n++){const a=o.getTarget(n);r.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${n}`,s,t.targets[n],a))}return Promise.all(r).then((()=>{o.areUpdatesFrozen=!1}))}_loadMorphTargetVertexDataAsync(e,t,n,s){const r=new Array,o=(s,o,a)=>{if(null==n[s])return;const i=t.getVertexBuffer(o);if(!i)return;const l=q.Get(`${e}/${s}`,this._gltf.accessors,n[s]);r.push(this._loadFloatAccessorAsync(`/accessors/${l.index}`,l).then((e=>{a(i,e)})))};return o("POSITION",f.R.PositionKind,((e,t)=>{const n=new Float32Array(t.length);e.forEach(t.length,((e,s)=>{n[s]=t[s]+e})),s.setPositions(n)})),o("NORMAL",f.R.NormalKind,((e,t)=>{const n=new Float32Array(t.length);e.forEach(n.length,((e,s)=>{n[s]=t[s]+e})),s.setNormals(n)})),o("TANGENT",f.R.TangentKind,((e,t)=>{const n=new Float32Array(t.length/3*4);let r=0;e.forEach(t.length/3*4,((e,s)=>{(s+1)%4!=0&&(n[r]=t[r]+e,r++)})),s.setTangents(n)})),o("TEXCOORD_0",f.R.UVKind,((e,t)=>{const n=new Float32Array(t.length);e.forEach(t.length,((e,s)=>{n[s]=t[s]+e})),s.setUVs(n)})),o("TEXCOORD_1",f.R.UV2Kind,((e,t)=>{const n=new Float32Array(t.length);e.forEach(t.length,((e,s)=>{n[s]=t[s]+e})),s.setUV2s(n)})),o("COLOR_0",f.R.ColorKind,((t,n)=>{let r=null;const o=t.getSize();if(3===o){r=new Float32Array(n.length/3*4),t.forEach(n.length,((e,t)=>{const s=Math.floor(t/3),o=t%3;r[4*s+o]=n[3*s+o]+e}));for(let e=0;e<n.length/3;++e)r[4*e+3]=1}else{if(4!==o)throw new Error(`${e}: Invalid number of components (${o}) for COLOR_0 attribute`);r=new Float32Array(n.length),t.forEach(n.length,((e,t)=>{r[t]=n[t]+e}))}s.setColors(r)})),Promise.all(r).then((()=>{}))}static _LoadTransform(e,t){if(null!=e.skin)return;let n=r.Pq.Zero(),s=r.PT.Identity(),o=r.Pq.One();if(e.matrix){r.uq.FromArray(e.matrix).decompose(o,s,n)}else e.translation&&(n=r.Pq.FromArray(e.translation)),e.rotation&&(s=r.PT.FromArray(e.rotation)),e.scale&&(o=r.Pq.FromArray(e.scale));t.position=n,t.rotationQuaternion=s,t.scaling=o}_loadSkinAsync(e,t,n,s){if(!this._parent.loadSkins)return Promise.resolve();const r=this._extensionsLoadSkinAsync(e,t,n);if(r)return r;if(n._data)return s(n._data.babylonSkeleton),n._data.promise;const o=`skeleton${n.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new d.E(n.name||o,o,this._babylonScene);a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,n,a);const i=this._loadSkinInverseBindMatricesDataAsync(e,n).then((e=>{this._updateBoneMatrices(a,e)}));return n._data={babylonSkeleton:a,promise:i},s(a),i}_loadBones(e,t,n){if(null==t.skeleton||this._parent.alwaysComputeSkeletonRootNode){const n=this._findSkeletonRootNode(`${e}/joints`,t.joints);if(n)if(void 0===t.skeleton)t.skeleton=n.index;else{const s=(e,t)=>{for(;t.parent;t=t.parent)if(t.parent===e)return!0;return!1},r=q.Get(`${e}/skeleton`,this._gltf.nodes,t.skeleton);r===n||s(r,n)||(M.V.Warn(`${e}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),t.skeleton=n.index)}else M.V.Warn(`${e}: Failed to find common root`)}const s={};for(const r of t.joints){const o=q.Get(`${e}/joints/${r}`,this._gltf.nodes,r);this._loadBone(o,t,n,s)}}_findSkeletonRootNode(e,t){if(0===t.length)return null;const n={};for(const s of t){const t=[];let r=q.Get(`${e}/${s}`,this._gltf.nodes,s);for(;-1!==r.index;)t.unshift(r),r=r.parent;n[s]=t}let s=null;for(let e=0;;++e){let r=n[t[0]];if(e>=r.length)return s;const o=r[e];for(let a=1;a<t.length;++a)if(r=n[t[a]],e>=r.length||o!==r[e])return s;s=o}}_loadBone(e,t,n,s){e._isJoint=!0;let r=s[e.index];if(r)return r;let o=null;e.index!==t.skeleton&&(e.parent&&-1!==e.parent.index?o=this._loadBone(e.parent,t,n,s):void 0!==t.skeleton&&M.V.Warn(`/skins/${t.index}/skeleton: Skeleton node is not a common root`));const a=t.joints.indexOf(e.index);return r=new h.$(e.name||`joint${e.index}`,n,o,this._getNodeMatrix(e),null,null,a),s[e.index]=r,this._postSceneLoadActions.push((()=>{r.linkTransformNode(e._babylonTransformNode)})),r}_loadSkinInverseBindMatricesDataAsync(e,t){if(null==t.inverseBindMatrices)return Promise.resolve(null);const n=q.Get(`${e}/inverseBindMatrices`,this._gltf.accessors,t.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${n.index}`,n)}_updateBoneMatrices(e,t){for(const n of e.bones){const e=r.uq.Identity(),s=n._index;t&&-1!==s&&(r.uq.FromArrayToRef(t,16*s,e),e.invertToRef(e));const o=n.getParent();o&&e.multiplyToRef(o.getAbsoluteInverseBindMatrix(),e),n.updateMatrix(e,!1,!1),n._updateAbsoluteBindMatrices(void 0,!1)}}_getNodeMatrix(e){return e.matrix?r.uq.FromArray(e.matrix):r.uq.Compose(e.scale?r.Pq.FromArray(e.scale):r.Pq.One(),e.rotation?r.PT.FromArray(e.rotation):r.PT.Identity(),e.translation?r.Pq.FromArray(e.translation):r.Pq.Zero())}loadCameraAsync(e,t,n=()=>{}){const s=this._extensionsLoadCameraAsync(e,t,n);if(s)return s;const o=new Array;this.logOpen(`${e} ${t.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new l.S(t.name||`camera${t.index}`,r.Pq.Zero(),this._babylonScene,!1);switch(a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,a.ignoreParentScaling=!0,t._babylonCamera=a,a.rotation.set(0,Math.PI,0),t.type){case"perspective":{const n=t.perspective;if(!n)throw new Error(`${e}: Camera perspective properties are missing`);a.fov=n.yfov,a.minZ=n.znear,a.maxZ=n.zfar||0;break}case"orthographic":if(!t.orthographic)throw new Error(`${e}: Camera orthographic properties are missing`);a.mode=i.i.ORTHOGRAPHIC_CAMERA,a.orthoLeft=-t.orthographic.xmag,a.orthoRight=t.orthographic.xmag,a.orthoBottom=-t.orthographic.ymag,a.orthoTop=t.orthographic.ymag,a.minZ=t.orthographic.znear,a.maxZ=t.orthographic.zfar;break;default:throw new Error(`${e}: Invalid camera type (${t.type})`)}return W.AddPointerMetadata(a,e),this._parent.onCameraLoadedObservable.notifyObservers(a),n(a),this.logClose(),Promise.all(o).then((()=>a))}_loadAnimationsAsync(){const e=this._gltf.animations;if(!e)return Promise.resolve();const t=new Array;for(let n=0;n<e.length;n++){const s=e[n];t.push(this.loadAnimationAsync(`/animations/${s.index}`,s).then((e=>{0===e.targetedAnimations.length&&e.dispose()})))}return Promise.all(t).then((()=>{}))}loadAnimationAsync(e,t){const s=this._extensionsLoadAnimationAsync(e,t);return s||n.e(7689).then(n.bind(n,97689)).then((({AnimationGroup:n})=>{this._babylonScene._blockEntityCollection=!!this._assetContainer;const s=new n(t.name||`animation${t.index}`,this._babylonScene);s._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonAnimationGroup=s;const r=new Array;q.Assign(t.channels),q.Assign(t.samplers);for(const n of t.channels)r.push(this._loadAnimationChannelAsync(`${e}/channels/${n.index}`,e,t,n,((e,t)=>{e.animations=e.animations||[],e.animations.push(t),s.addTargetedAnimation(t,e)})));return Promise.all(r).then((()=>(s.normalize(0),s)))}))}async _loadAnimationChannelAsync(e,t,s,r,o){const a=this._extensionsLoadAnimationChannelAsync(e,t,s,r,o);if(a)return a;if(null==r.target.node)return Promise.resolve();const i=q.Get(`${e}/target/node`,this._gltf.nodes,r.target.node),l=r.target.path,h="weights"===l;if(h&&!i._numMorphTargets||!h&&!i._babylonTransformNode)return Promise.resolve();if(!this._parent.loadNodeAnimations&&!h&&!i._isJoint)return Promise.resolve();let d;switch(await n.e(4236).then(n.bind(n,34236)),l){case"translation":d=(0,G.tQ)("/nodes/{}/translation")?.interpolation;break;case"rotation":d=(0,G.tQ)("/nodes/{}/rotation")?.interpolation;break;case"scale":d=(0,G.tQ)("/nodes/{}/scale")?.interpolation;break;case"weights":d=(0,G.tQ)("/nodes/{}/weights")?.interpolation;break;default:throw new Error(`${e}/target/path: Invalid value (${r.target.path})`)}if(!d)throw new Error(`${e}/target/path: Could not find interpolation properties for target path (${r.target.path})`);const c={object:i,info:d};return this._loadAnimationChannelFromTargetInfoAsync(e,t,s,r,c,o)}_loadAnimationChannelFromTargetInfoAsync(e,t,n,s,r,o){const a=this.parent.targetFps,i=1/a,l=q.Get(`${e}/sampler`,n.samplers,s.sampler);return this._loadAnimationSamplerAsync(`${t}/samplers/${s.sampler}`,l).then((e=>{let t=0;const l=r.object,h=r.info;for(const r of h){const h=r.getStride(l),d=e.input,c=e.output,u=new Array(d.length);let _=0;switch(e.interpolation){case"STEP":for(let e=0;e<d.length;e++){const t=r.getValue(l,c,_,1);_+=h,u[e]={frame:d[e]*a,value:t,interpolation:1}}break;case"CUBICSPLINE":for(let e=0;e<d.length;e++){const t=r.getValue(l,c,_,i);_+=h;const n=r.getValue(l,c,_,1);_+=h;const s=r.getValue(l,c,_,i);_+=h,u[e]={frame:d[e]*a,inTangent:t,value:n,outTangent:s}}break;case"LINEAR":for(let e=0;e<d.length;e++){const t=r.getValue(l,c,_,1);_+=h,u[e]={frame:d[e]*a,value:t}}}if(_>0){const e=`${n.name||`animation${n.index}`}_channel${s.index}_${t}`,i=r.buildAnimations(l,e,a,u);for(const e of i)t++,o(e.babylonAnimatable,e.babylonAnimation)}}}))}_loadAnimationSamplerAsync(e,t){if(t._data)return t._data;const n=t.interpolation||"LINEAR";switch(n){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${e}/interpolation: Invalid value (${t.interpolation})`)}const s=q.Get(`${e}/input`,this._gltf.accessors,t.input),r=q.Get(`${e}/output`,this._gltf.accessors,t.output);return t._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${s.index}`,s),this._loadFloatAccessorAsync(`/accessors/${r.index}`,r)]).then((([e,t])=>({input:e,interpolation:n,output:t}))),t._data}loadBufferAsync(e,t,n,s){const r=this._extensionsLoadBufferAsync(e,t,n,s);if(r)return r;if(!t._data)if(t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{if(!this._bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);t._data=this._bin.readAsync(0,t.byteLength)}return t._data.then((t=>{try{return new Uint8Array(t.buffer,t.byteOffset+n,s)}catch(t){throw new Error(`${e}: ${t.message}`)}}))}loadBufferViewAsync(e,t){const n=this._extensionsLoadBufferViewAsync(e,t);if(n)return n;if(t._data)return t._data;const s=q.Get(`${e}/buffer`,this._gltf.buffers,t.buffer);return t._data=this.loadBufferAsync(`/buffers/${s.index}`,s,t.byteOffset||0,t.byteLength),t._data}_loadAccessorAsync(e,t,n){if(t._data)return t._data;const s=W._GetNumComponents(e,t.type),r=s*f.R.GetTypeByteLength(t.componentType),o=s*t.count;if(null==t.bufferView)t._data=Promise.resolve(new n(o));else{const a=q.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${a.index}`,a).then((i=>{if(5126!==t.componentType||t.normalized||a.byteStride&&a.byteStride!==r){const e=new n(o);return f.R.ForEach(i,t.byteOffset||0,a.byteStride||r,s,t.componentType,e.length,t.normalized||!1,((t,n)=>{e[n]=t})),e}return W._GetTypedArray(e,t.componentType,i,t.byteOffset,o)}))}if(t.sparse){const o=t.sparse;t._data=t._data.then((a=>{const i=a,l=q.Get(`${e}/sparse/indices/bufferView`,this._gltf.bufferViews,o.indices.bufferView),h=q.Get(`${e}/sparse/values/bufferView`,this._gltf.bufferViews,o.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${l.index}`,l),this.loadBufferViewAsync(`/bufferViews/${h.index}`,h)]).then((([a,l])=>{const h=W._GetTypedArray(`${e}/sparse/indices`,o.indices.componentType,a,o.indices.byteOffset,o.count),d=s*o.count;let c;if(5126!==t.componentType||t.normalized){const a=W._GetTypedArray(`${e}/sparse/values`,t.componentType,l,o.values.byteOffset,d);c=new n(d),f.R.ForEach(a,0,r,s,t.componentType,c.length,t.normalized||!1,((e,t)=>{c[t]=e}))}else c=W._GetTypedArray(`${e}/sparse/values`,t.componentType,l,o.values.byteOffset,d);let u=0;for(let e=0;e<h.length;e++){let t=h[e]*s;for(let e=0;e<s;e++)i[t++]=c[u++]}return i}))}))}return t._data}_loadFloatAccessorAsync(e,t){return this._loadAccessorAsync(e,t,Float32Array)}_loadIndicesAccessorAsync(e,t){if("SCALAR"!==t.type)throw new Error(`${e}/type: Invalid value ${t.type}`);if(5121!==t.componentType&&5123!==t.componentType&&5125!==t.componentType)throw new Error(`${e}/componentType: Invalid value ${t.componentType}`);if(t._data)return t._data;if(t.sparse){const n=W._GetTypedArrayConstructor(`${e}/componentType`,t.componentType);t._data=this._loadAccessorAsync(e,t,n)}else{const n=q.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${n.index}`,n).then((n=>W._GetTypedArray(e,t.componentType,n,t.byteOffset,t.count)))}return t._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;const t=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${e.index}`,e).then((e=>new f.h(t,e,!1))),e._babylonBuffer}_loadVertexAccessorAsync(e,t,n){if(t._babylonVertexBuffer?.[n])return t._babylonVertexBuffer[n];t._babylonVertexBuffer||(t._babylonVertexBuffer={});const s=this._babylonScene.getEngine();if(t.sparse||null==t.bufferView)t._babylonVertexBuffer[n]=this._loadFloatAccessorAsync(e,t).then((e=>new f.R(s,e,n,!1)));else{const r=q.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._babylonVertexBuffer[n]=this._loadVertexBufferViewAsync(r).then((o=>{const a=W._GetNumComponents(e,t.type);return new f.R(s,o,n,!1,void 0,r.byteStride,void 0,t.byteOffset,a,t.componentType,t.normalized,!0,void 0,!0)}))}return t._babylonVertexBuffer[n]}_loadMaterialMetallicRoughnessPropertiesAsync(e,t,n){if(!(n instanceof u.Y))throw new Error(`${e}: Material type not supported`);const s=new Array;return t&&(t.baseColorFactor?(n.albedoColor=o.v9.FromArray(t.baseColorFactor),n.alpha=t.baseColorFactor[3]):n.albedoColor=o.v9.White(),n.metallic=null==t.metallicFactor?1:t.metallicFactor,n.roughness=null==t.roughnessFactor?1:t.roughnessFactor,t.baseColorTexture&&s.push(this.loadTextureInfoAsync(`${e}/baseColorTexture`,t.baseColorTexture,(e=>{e.name=`${n.name} (Base Color)`,n.albedoTexture=e}))),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${e}/metallicRoughnessTexture`,t.metallicRoughnessTexture,(e=>{e.name=`${n.name} (Metallic Roughness)`,n.metallicTexture=e}))),n.useMetallnessFromMetallicTextureBlue=!0,n.useRoughnessFromMetallicTextureGreen=!0,n.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(s).then((()=>{}))}_loadMaterialAsync(e,t,n,s,r=()=>{}){const o=this._extensionsLoadMaterialAsync(e,t,n,s,r);if(o)return o;t._data=t._data||{};let a=t._data[s];if(!a){this.logOpen(`${e} ${t.name||""}`);const n=this.createMaterial(e,t,s);a={babylonMaterial:n,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,t,n)},t._data[s]=a,W.AddPointerMetadata(n,e),this._parent.onMaterialLoadedObservable.notifyObservers(n),this.logClose()}return n&&(a.babylonMeshes.push(n),n.onDisposeObservable.addOnce((()=>{const e=a.babylonMeshes.indexOf(n);-1!==e&&a.babylonMeshes.splice(e,1)}))),r(a.babylonMaterial),a.promise.then((()=>a.babylonMaterial))}_createDefaultMaterial(e,t){this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new u.Y(e,this._babylonScene);return n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n.fillMode=t,n.enableSpecularAntiAliasing=!0,n.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,n.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,n.transparencyMode=u.Y.PBRMATERIAL_OPAQUE,n.metallic=1,n.roughness=1,n}createMaterial(e,t,n){const s=this._extensionsCreateMaterial(e,t,n);if(s)return s;const r=t.name||`material${t.index}`;return this._createDefaultMaterial(r,n)}loadMaterialPropertiesAsync(e,t,n){const s=this._extensionsLoadMaterialPropertiesAsync(e,t,n);if(s)return s;const r=new Array;return r.push(this.loadMaterialBasePropertiesAsync(e,t,n)),t.pbrMetallicRoughness&&r.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${e}/pbrMetallicRoughness`,t.pbrMetallicRoughness,n)),this.loadMaterialAlphaProperties(e,t,n),Promise.all(r).then((()=>{}))}loadMaterialBasePropertiesAsync(e,t,n){if(!(n instanceof u.Y))throw new Error(`${e}: Material type not supported`);const s=new Array;return n.emissiveColor=t.emissiveFactor?o.v9.FromArray(t.emissiveFactor):new o.v9(0,0,0),t.doubleSided&&(n.backFaceCulling=!1,n.twoSidedLighting=!0),t.normalTexture&&(t.normalTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${e}/normalTexture`,t.normalTexture,(e=>{e.name=`${n.name} (Normal)`,n.bumpTexture=e}))),n.invertNormalMapX=!this._babylonScene.useRightHandedSystem,n.invertNormalMapY=this._babylonScene.useRightHandedSystem,null!=t.normalTexture.scale&&n.bumpTexture&&(n.bumpTexture.level=t.normalTexture.scale),n.forceIrradianceInFragment=!0),t.occlusionTexture&&(t.occlusionTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${e}/occlusionTexture`,t.occlusionTexture,(e=>{e.name=`${n.name} (Occlusion)`,n.ambientTexture=e}))),n.useAmbientInGrayScale=!0,null!=t.occlusionTexture.strength&&(n.ambientTextureStrength=t.occlusionTexture.strength)),t.emissiveTexture&&s.push(this.loadTextureInfoAsync(`${e}/emissiveTexture`,t.emissiveTexture,(e=>{e.name=`${n.name} (Emissive)`,n.emissiveTexture=e}))),Promise.all(s).then((()=>{}))}loadMaterialAlphaProperties(e,t,n){if(!(n instanceof u.Y))throw new Error(`${e}: Material type not supported`);switch(t.alphaMode||"OPAQUE"){case"OPAQUE":n.transparencyMode=u.Y.PBRMATERIAL_OPAQUE,n.alpha=1;break;case"MASK":n.transparencyMode=u.Y.PBRMATERIAL_ALPHATEST,n.alphaCutOff=null==t.alphaCutoff?.5:t.alphaCutoff,n.albedoTexture&&(n.albedoTexture.hasAlpha=!0);break;case"BLEND":n.transparencyMode=u.Y.PBRMATERIAL_ALPHABLEND,n.albedoTexture&&(n.albedoTexture.hasAlpha=!0,n.useAlphaFromAlbedoTexture=!0);break;default:throw new Error(`${e}/alphaMode: Invalid value (${t.alphaMode})`)}}loadTextureInfoAsync(e,t,n=()=>{}){const s=this._extensionsLoadTextureInfoAsync(e,t,n);if(s)return s;if(this.logOpen(`${e}`),t.texCoord>=6)throw new Error(`${e}/texCoord: Invalid value (${t.texCoord})`);const r=q.Get(`${e}/index`,this._gltf.textures,t.index);r._textureInfo=t;const o=this._loadTextureAsync(`/textures/${t.index}`,r,(s=>{s.coordinatesIndex=t.texCoord||0,W.AddPointerMetadata(s,e),this._parent.onTextureLoadedObservable.notifyObservers(s),n(s)}));return this.logClose(),o}_loadTextureAsync(e,t,n=()=>{}){const s=this._extensionsLoadTextureAsync(e,t,n);if(s)return s;this.logOpen(`${e} ${t.name||""}`);const r=null==t.sampler?W.DefaultSampler:q.Get(`${e}/sampler`,this._gltf.samplers,t.sampler),o=q.Get(`${e}/source`,this._gltf.images,t.source),a=this._createTextureAsync(e,r,o,n,void 0,!t._textureInfo.nonColorData);return this.logClose(),a}_createTextureAsync(e,t,n,r=()=>{},o,a){const i=this._loadSampler(`/samplers/${t.index}`,t),l=new Array,h=new s.c;this._babylonScene._blockEntityCollection=!!this._assetContainer;const d={noMipmap:i.noMipMaps,invertY:!1,samplingMode:i.samplingMode,onLoad:()=>{this._disposed||h.resolve()},onError:(t,n)=>{this._disposed||h.reject(new Error(`${e}: ${n&&n.message?n.message:t||"Failed to load texture"}`))},mimeType:n.mimeType,loaderOptions:o,useSRGBBuffer:!!a&&this._parent.useSRGBBuffers},c=new _.g(null,this._babylonScene,d);return c._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,l.push(h.promise),l.push(this.loadImageAsync(`/images/${n.index}`,n).then((e=>{const t=n.uri||`${this._fileName}#image${n.index}`,s=`data:${this._uniqueRootUrl}${t}`;c.updateURL(s,e);const r=c.getInternalTexture();r&&(r.label=n.name)}))),c.wrapU=i.wrapU,c.wrapV=i.wrapV,r(c),this._parent.useGltfTextureNames&&(c.name=n.name||n.uri||`image${n.index}`),Promise.all(l).then((()=>c))}_loadSampler(e,t){return t._data||(t._data={noMipMaps:9728===t.minFilter||9729===t.minFilter,samplingMode:W._GetTextureSamplingMode(e,t),wrapU:W._GetTextureWrapMode(`${e}/wrapS`,t.wrapS),wrapV:W._GetTextureWrapMode(`${e}/wrapT`,t.wrapT)}),t._data}loadImageAsync(e,t){if(!t._data){if(this.logOpen(`${e} ${t.name||""}`),t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{const n=q.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${n.index}`,n)}this.logClose()}return t._data}loadUriAsync(e,t,n){const s=this._extensionsLoadUriAsync(e,t,n);if(s)return s;if(!W._ValidateUri(n))throw new Error(`${e}: '${n}' is invalid`);if((0,R.f2)(n)){const t=new Uint8Array((0,R.rz)(n));return this.log(`${e}: Decoded ${n.substring(0,64)}... (${t.length} bytes)`),Promise.resolve(t)}return this.log(`${e}: Loading ${n}`),this._parent.preprocessUrlAsync(this._rootUrl+n).then((t=>new Promise(((s,r)=>{this._parent._loadFile(this._babylonScene,t,(t=>{this._disposed||(this.log(`${e}: Loaded ${n} (${t.byteLength} bytes)`),s(new Uint8Array(t)))}),!0,(t=>{r(new R.hX(`${e}: Failed to load '${n}'${t?": "+t.status+" "+t.statusText:""}`,t))}))}))))}static AddPointerMetadata(e,t){e.metadata=e.metadata||{};const n=e._internalMetadata=e._internalMetadata||{},s=n.gltf=n.gltf||{};(s.pointers=s.pointers||[]).push(t)}static _GetTextureWrapMode(e,t){switch(t=null==t?10497:t){case 33071:return _.g.CLAMP_ADDRESSMODE;case 33648:return _.g.MIRROR_ADDRESSMODE;case 10497:return _.g.WRAP_ADDRESSMODE;default:return M.V.Warn(`${e}: Invalid value (${t})`),_.g.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,t){const n=null==t.magFilter?9729:t.magFilter,s=null==t.minFilter?9987:t.minFilter;if(9729===n)switch(s){case 9728:return _.g.LINEAR_NEAREST;case 9729:return _.g.LINEAR_LINEAR;case 9984:return _.g.LINEAR_NEAREST_MIPNEAREST;case 9985:return _.g.LINEAR_LINEAR_MIPNEAREST;case 9986:return _.g.LINEAR_NEAREST_MIPLINEAR;case 9987:return _.g.LINEAR_LINEAR_MIPLINEAR;default:return M.V.Warn(`${e}/minFilter: Invalid value (${s})`),_.g.LINEAR_LINEAR_MIPLINEAR}else switch(9728!==n&&M.V.Warn(`${e}/magFilter: Invalid value (${n})`),s){case 9728:return _.g.NEAREST_NEAREST;case 9729:return _.g.NEAREST_LINEAR;case 9984:return _.g.NEAREST_NEAREST_MIPNEAREST;case 9985:return _.g.NEAREST_LINEAR_MIPNEAREST;case 9986:return _.g.NEAREST_NEAREST_MIPLINEAR;case 9987:return _.g.NEAREST_LINEAR_MIPLINEAR;default:return M.V.Warn(`${e}/minFilter: Invalid value (${s})`),_.g.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,t){try{return(0,U.w)(t)}catch(t){throw new Error(`${e}: ${t.message}`)}}static _GetTypedArray(e,t,n,s,r){const o=n.buffer;s=n.byteOffset+(s||0);const a=W._GetTypedArrayConstructor(`${e}/componentType`,t),i=f.R.GetTypeByteLength(t);return s%i!=0?(M.V.Warn(`${e}: Copying buffer as byte offset (${s}) is not a multiple of component type byte length (${i})`),new a(o.slice(s,s+r*i),0)):new a(o,s,r)}static _GetNumComponents(e,t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${e}: Invalid type (${t})`)}static _ValidateUri(e){return a.S0.IsBase64(e)||-1===e.indexOf("..")}static _GetDrawMode(e,t){switch(null==t&&(t=4),t){case 0:return c.i.PointListDrawMode;case 1:return c.i.LineListDrawMode;case 2:return c.i.LineLoopDrawMode;case 3:return c.i.LineStripDrawMode;case 4:return c.i.TriangleFillMode;case 5:return c.i.TriangleStripDrawMode;case 6:return c.i.TriangleFanDrawMode}throw new Error(`${e}: Invalid mesh primitive mode (${t})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");const e=new Array;if(this._gltf.materials)for(const t of this._gltf.materials)if(t._data)for(const n in t._data){const s=t._data[n];for(const t of s.babylonMeshes){t.computeWorldMatrix(!0);const n=s.babylonMaterial;e.push(n.forceCompilationAsync(t)),e.push(n.forceCompilationAsync(t,{useInstances:!0})),this._parent.useClipPlane&&(e.push(n.forceCompilationAsync(t,{clipPlane:!0})),e.push(n.forceCompilationAsync(t,{clipPlane:!0,useInstances:!0})))}}return Promise.all(e).then((()=>{this._parent._endPerformanceCounter("Compile materials")}))}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");const e=new Array,t=this._babylonScene.lights;for(const n of t){const t=n.getShadowGenerator();t&&e.push(t.forceCompilationAsync())}return Promise.all(e).then((()=>{this._parent._endPerformanceCounter("Compile shadow generators")}))}_forEachExtensions(e){for(const t of this._extensions)t.enabled&&e(t)}_applyExtensions(e,t,n){for(const s of this._extensions)if(s.enabled){const r=`${s.name}.${t}`,o=e;o._activeLoaderExtensionFunctions=o._activeLoaderExtensionFunctions||{};const a=o._activeLoaderExtensionFunctions;if(!a[r]){a[r]=!0;try{const e=n(s);if(e)return e}finally{delete a[r]}}}return null}_extensionsOnLoading(){this._forEachExtensions((e=>e.onLoading&&e.onLoading()))}_extensionsOnReady(){this._forEachExtensions((e=>e.onReady&&e.onReady()))}_extensionsLoadSceneAsync(e,t){return this._applyExtensions(t,"loadScene",(n=>n.loadSceneAsync&&n.loadSceneAsync(e,t)))}_extensionsLoadNodeAsync(e,t,n){return this._applyExtensions(t,"loadNode",(s=>s.loadNodeAsync&&s.loadNodeAsync(e,t,n)))}_extensionsLoadCameraAsync(e,t,n){return this._applyExtensions(t,"loadCamera",(s=>s.loadCameraAsync&&s.loadCameraAsync(e,t,n)))}_extensionsLoadVertexDataAsync(e,t,n){return this._applyExtensions(t,"loadVertexData",(s=>s._loadVertexDataAsync&&s._loadVertexDataAsync(e,t,n)))}_extensionsLoadMeshPrimitiveAsync(e,t,n,s,r,o){return this._applyExtensions(r,"loadMeshPrimitive",(a=>a._loadMeshPrimitiveAsync&&a._loadMeshPrimitiveAsync(e,t,n,s,r,o)))}_extensionsLoadMaterialAsync(e,t,n,s,r){return this._applyExtensions(t,"loadMaterial",(o=>o._loadMaterialAsync&&o._loadMaterialAsync(e,t,n,s,r)))}_extensionsCreateMaterial(e,t,n){return this._applyExtensions(t,"createMaterial",(s=>s.createMaterial&&s.createMaterial(e,t,n)))}_extensionsLoadMaterialPropertiesAsync(e,t,n){return this._applyExtensions(t,"loadMaterialProperties",(s=>s.loadMaterialPropertiesAsync&&s.loadMaterialPropertiesAsync(e,t,n)))}_extensionsLoadTextureInfoAsync(e,t,n){return this._applyExtensions(t,"loadTextureInfo",(s=>s.loadTextureInfoAsync&&s.loadTextureInfoAsync(e,t,n)))}_extensionsLoadTextureAsync(e,t,n){return this._applyExtensions(t,"loadTexture",(s=>s._loadTextureAsync&&s._loadTextureAsync(e,t,n)))}_extensionsLoadAnimationAsync(e,t){return this._applyExtensions(t,"loadAnimation",(n=>n.loadAnimationAsync&&n.loadAnimationAsync(e,t)))}_extensionsLoadAnimationChannelAsync(e,t,n,s,r){return this._applyExtensions(n,"loadAnimationChannel",(o=>o._loadAnimationChannelAsync&&o._loadAnimationChannelAsync(e,t,n,s,r)))}_extensionsLoadSkinAsync(e,t,n){return this._applyExtensions(n,"loadSkin",(s=>s._loadSkinAsync&&s._loadSkinAsync(e,t,n)))}_extensionsLoadUriAsync(e,t,n){return this._applyExtensions(t,"loadUri",(s=>s._loadUriAsync&&s._loadUriAsync(e,t,n)))}_extensionsLoadBufferViewAsync(e,t){return this._applyExtensions(t,"loadBufferView",(n=>n.loadBufferViewAsync&&n.loadBufferViewAsync(e,t)))}_extensionsLoadBufferAsync(e,t,n,s){return this._applyExtensions(t,"loadBuffer",(r=>r.loadBufferAsync&&r.loadBufferAsync(e,t,n,s)))}static LoadExtensionAsync(e,t,n,s){if(!t.extensions)return null;const r=t.extensions[n];return r?s(`${e}/extensions/${n}`,r):null}static LoadExtraAsync(e,t,n,s){if(!t.extras)return null;const r=t.extras[n];return r?s(`${e}/extras/${n}`,r):null}isExtensionUsed(e){return!!this._gltf.extensionsUsed&&-1!==this._gltf.extensionsUsed.indexOf(e)}logOpen(e){this._parent._logOpen(e)}logClose(){this._parent._logClose()}log(e){this._parent._log(e)}startPerformanceCounter(e){this._parent._startPerformanceCounter(e)}endPerformanceCounter(e){this._parent._endPerformanceCounter(e)}}W.DefaultSampler={index:-1},B._CreateGLTF2Loader=e=>new W(e)}}]);