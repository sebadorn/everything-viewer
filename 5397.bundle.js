"use strict";(self.webpackChunkeverything_viewer=self.webpackChunkeverything_viewer||[]).push([[5397],{15397:(t,e,i)=>{i.d(e,{E:()=>g});var n=i(36504),s=i(99848),r=i(79923),a=i(96041),o=i(7540),h=i(56227),l=i(6315),u=i(51137),m=i(74609);class g{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(t){this._useTextureToStoreBoneMatrices=t,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(t){this._animationPropertiesOverride=t}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(t,e,i){this.name=t,this.id=e,this.bones=[],this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=r.uq.Identity(),this._currentRenderId=-1,this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new s.cP,this.metadata=null,this.bones=[],this._scene=i||l.q.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;const n=this._scene.getEngine().getCaps();this._canUseTextureForBones=n.textureFloat&&n.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter(t=>!t.getParent())}getTransformMatrices(t){if(this.needInitialSkinMatrix){if(!t)throw new Error("getTransformMatrices: When using the needInitialSkinMatrix flag, a mesh must be provided");return t._bonesTransformMatrices||this.prepare(!0),t._bonesTransformMatrices}return this._transformMatrices&&!this._isDirty||this.prepare(!this._transformMatrices),this._transformMatrices}getTransformMatrixTexture(t){return this.needInitialSkinMatrix&&t._transformMatrixTexture?t._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(t){let e=`Name: ${this.name}, nBones: ${this.bones.length}`;if(e+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,t){e+=", Ranges: {";let t=!0;for(const i in this._ranges)t&&(e+=", ",t=!1),e+=i;e+="}"}return e}getBoneIndexByName(t){for(let e=0,i=this.bones.length;e<i;e++)if(this.bones[e].name===t)return e;return-1}createAnimationRange(t,e,i){if(!this._ranges[t]){this._ranges[t]=new h.K(t,e,i);for(let n=0,s=this.bones.length;n<s;n++)this.bones[n].animations[0]&&this.bones[n].animations[0].createRange(t,e,i)}}deleteAnimationRange(t,e=!0){for(let i=0,n=this.bones.length;i<n;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(t,e);this._ranges[t]=null}getAnimationRange(t){return this._ranges[t]||null}getAnimationRanges(){const t=[];let e;for(e in this._ranges)t.push(this._ranges[e]);return t}copyAnimationRange(t,e,i=!1){if(this._ranges[e]||!t.getAnimationRange(e))return!1;let n=!0;const s=this._getHighestAnimationFrame()+1,r={},a=t.bones;let o,l;for(l=0,o=a.length;l<o;l++)r[a[l].name]=a[l];this.bones.length!==a.length&&(u.V.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${a.length}`),n=!1);const m=i&&this.dimensionsAtRest&&t.dimensionsAtRest?this.dimensionsAtRest.divide(t.dimensionsAtRest):null;for(l=0,o=this.bones.length;l<o;l++){const t=this.bones[l].name,a=r[t];a?n=n&&this.bones[l].copyAnimationRange(a,e,s,i,m):(u.V.Warn("copyAnimationRange: not same rig, missing source bone "+t),n=!1)}const g=t.getAnimationRange(e);return g&&(this._ranges[e]=new h.K(e,g.from+s,g.to+s)),n}returnToRest(){for(const t of this.bones)-1!==t._index&&t.returnToRest()}_getHighestAnimationFrame(){let t=0;for(let e=0,i=this.bones.length;e<i;e++)if(this.bones[e].animations[0]){const i=this.bones[e].animations[0].getHighestFrame();t<i&&(t=i)}return t}beginAnimation(t,e,i,n){const s=this.getAnimationRange(t);return s?this._scene.beginAnimation(this,s.from,s.to,e,i,n):null}static MakeAnimationAdditive(t,e=0,i){const n=t.getAnimationRange(i);if(!n)return null;const s=t._scene.getAllAnimatablesByTarget(t);let r=null;for(let t=0;t<s.length;t++){const e=s[t];if(e.fromFrame===n?.from&&e.toFrame===n?.to){r=e;break}}const a=t.getAnimatables();for(let t=0;t<a.length;t++){const n=a[t].animations;if(n)for(let t=0;t<n.length;t++)o.X5.MakeAnimationAdditive(n[t],e,i)}return r&&(r.isAdditive=!0),t}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(t){this._meshesWithPoseMatrix.push(t)}_unregisterMeshWithPoseMatrix(t){const e=this._meshesWithPoseMatrix.indexOf(t);e>-1&&this._meshesWithPoseMatrix.splice(e,1)}_computeTransformMatrices(t,e){this.onBeforeComputeObservable.notifyObservers(this);for(let i=0;i<this.bones.length;i++){const n=this.bones[i];n._childUpdateId++;const s=n.getParent();if(s?n.getLocalMatrix().multiplyToRef(s.getFinalMatrix(),n.getFinalMatrix()):e?n.getLocalMatrix().multiplyToRef(e,n.getFinalMatrix()):n.getFinalMatrix().copyFrom(n.getLocalMatrix()),-1!==n._index){const e=null===n._index?i:n._index;n.getAbsoluteInverseBindMatrix().multiplyToArray(n.getFinalMatrix(),t,16*e)}}this._identity.copyToArray(t,16*this.bones.length)}prepare(t=!1){if(!t){const t=this.getScene().getRenderId();if(this._currentRenderId===t)return;this._currentRenderId=t}if(this._numBonesWithLinkedTransformNode>0)for(const t of this.bones)if(t._linkedTransformNode){const e=t._linkedTransformNode;t.position=e.position,e.rotationQuaternion?t.rotationQuaternion=e.rotationQuaternion:t.rotation=e.rotation,t.scaling=e.scaling}if(this.needInitialSkinMatrix)for(const t of this._meshesWithPoseMatrix){const e=t.getPoseMatrix();let i=this._isDirty;if(t._bonesTransformMatrices&&t._bonesTransformMatrices.length===16*(this.bones.length+1)||(t._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),i=!0),i){if(this._synchronizedWithMesh!==t){this._synchronizedWithMesh=t;for(const t of this.bones)if(!t.getParent()){t.getBindMatrix().multiplyToRef(e,r.AA.Matrix[1]),t._updateAbsoluteBindMatrices(r.AA.Matrix[1])}if(this.isUsingTextureForMatrices){const e=4*(this.bones.length+1);t._transformMatrixTexture&&t._transformMatrixTexture.getSize().width===e||(t._transformMatrixTexture&&t._transformMatrixTexture.dispose(),t._transformMatrixTexture=a.I.CreateRGBATexture(t._bonesTransformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(t._bonesTransformMatrices,e),this.isUsingTextureForMatrices&&t._transformMatrixTexture&&t._transformMatrixTexture.update(t._bonesTransformMatrices)}}else{if(!this._isDirty)return;this._transformMatrices&&this._transformMatrices.length===16*(this.bones.length+1)||(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=a.I.CreateRGBATexture(this._transformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let t=0;t<this.bones.length;t++)this._animatables.push(this.bones[t])}return this._animatables}clone(t,e){const i=new g(t,e||t,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix,i.metadata=this.metadata;for(let t=0;t<this.bones.length;t++){const e=this.bones[t];let s=null;const r=e.getParent();if(r){const t=this.bones.indexOf(r);s=i.bones[t]}const a=new n.$(e.name,i,s,e.getBindMatrix().clone(),e.getRestMatrix().clone());a._index=e._index,e._linkedTransformNode&&a.linkTransformNode(e._linkedTransformNode),m.r.DeepCopy(e.animations,a.animations)}if(this._ranges){i._ranges={};for(const t in this._ranges){const e=this._ranges[t];e&&(i._ranges[t]=e.clone())}}return this._isDirty=!0,i.prepare(!0),i}enableBlending(t=.01){for(const e of this.bones)for(const i of e.animations)i.enableBlending=!0,i.blendingSpeed=t}dispose(){if(this._meshesWithPoseMatrix.length=0,this.metadata=null,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const t=this._parentContainer.skeletons.indexOf(this);t>-1&&this._parentContainer.skeletons.splice(t,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){const t={};t.name=this.name,t.id=this.id,this.dimensionsAtRest&&(t.dimensionsAtRest=this.dimensionsAtRest.asArray()),t.bones=[],t.needInitialSkinMatrix=this.needInitialSkinMatrix,this.metadata&&(t.metadata=this.metadata);for(let e=0;e<this.bones.length;e++){const i=this.bones[e],n=i.getParent(),s={parentBoneIndex:n?this.bones.indexOf(n):-1,index:i.getIndex(),name:i.name,id:i.id,matrix:i.getBindMatrix().asArray(),rest:i.getRestMatrix().asArray(),linkedTransformNodeId:i.getTransformNode()?.id};t.bones.push(s),i.length&&(s.length=i.length),i.metadata&&(s.metadata=i.metadata),i.animations&&i.animations.length>0&&(s.animation=i.animations[0].serialize()),t.ranges=[];for(const e in this._ranges){const i=this._ranges[e];if(!i)continue;const n={};n.name=e,n.from=i.from,n.to=i.to,t.ranges.push(n)}}return t}static Parse(t,e){const i=new g(t.name,t.id,e);let s;for(t.dimensionsAtRest&&(i.dimensionsAtRest=r.Pq.FromArray(t.dimensionsAtRest)),i.needInitialSkinMatrix=t.needInitialSkinMatrix,t.metadata&&(i.metadata=t.metadata),s=0;s<t.bones.length;s++){const e=t.bones[s],a=t.bones[s].index;let h=null;e.parentBoneIndex>-1&&(h=i.bones[e.parentBoneIndex]);const l=e.rest?r.uq.FromArray(e.rest):null,u=new n.$(e.name,i,h,r.uq.FromArray(e.matrix),l,null,a);void 0!==e.id&&null!==e.id&&(u.id=e.id),e.length&&(u.length=e.length),e.metadata&&(u.metadata=e.metadata),e.animation&&u.animations.push(o.X5.Parse(e.animation)),void 0!==e.linkedTransformNodeId&&null!==e.linkedTransformNodeId&&(i._hasWaitingData=!0,u._waitingTransformNodeId=e.linkedTransformNodeId)}if(t.ranges)for(s=0;s<t.ranges.length;s++){const e=t.ranges[s];i.createAnimationRange(e.name,e.from,e.to)}return i}computeAbsoluteMatrices(t=!1){(this._absoluteTransformIsDirty||t)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=!1)}computeAbsoluteTransforms(t=!1){this.computeAbsoluteMatrices(t)}getPoseMatrix(){let t=null;return this._meshesWithPoseMatrix.length>0&&(t=this._meshesWithPoseMatrix[0].getPoseMatrix()),t}sortBones(){const t=[],e=new Array(this.bones.length);for(let i=0;i<this.bones.length;i++)this._sortBones(i,t,e);this.bones=t}_sortBones(t,e,i){if(i[t])return;i[t]=!0;const n=this.bones[t];if(!n)return;void 0===n._index&&(n._index=t);const s=n.getParent();s&&this._sortBones(this.bones.indexOf(s),e,i),e.push(n)}setCurrentPoseAsRest(){for(const t of this.bones)t.setCurrentPoseAsRest()}}},96041:(t,e,i)=>{i.d(e,{I:()=>s});var n=i(82781);class s extends n.g{constructor(t,e,i,s,r,a=!0,o=!1,h=3,l=0,u,m,g){super(null,r,!a,o,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,u),this.format=s,this._engine&&(this._engine._caps.textureFloatLinearFiltering||1!==l||(h=1),this._engine._caps.textureHalfFloatLinearFiltering||2!==l||(h=1),this._texture=this._engine.createRawTexture(t,e,i,s,a,o,h,null,l,u??0,m??!1),this.wrapU=n.g.CLAMP_ADDRESSMODE,this.wrapV=n.g.CLAMP_ADDRESSMODE,this._waitingForData=!!g&&!t)}update(t){this._getEngine().updateRawTexture(this._texture,t,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer),this._waitingForData=!1}clone(){if(!this._texture)return super.clone();const t=new s(null,this.getSize().width,this.getSize().height,this.format,this.getScene(),this._texture.generateMipMaps,this._invertY,this.samplingMode,this._texture.type,this._texture._creationFlags,this._useSRGBBuffer);return t._texture=this._texture,this._texture.incrementReferences(),t}isReady(){return super.isReady()&&!this._waitingForData}static CreateLuminanceTexture(t,e,i,n,r=!0,a=!1,o=3){return new s(t,e,i,1,n,r,a,o)}static CreateLuminanceAlphaTexture(t,e,i,n,r=!0,a=!1,o=3){return new s(t,e,i,2,n,r,a,o)}static CreateAlphaTexture(t,e,i,n,r=!0,a=!1,o=3){return new s(t,e,i,0,n,r,a,o)}static CreateRGBTexture(t,e,i,n,r=!0,a=!1,o=3,h=0,l=0,u=!1){return new s(t,e,i,4,n,r,a,o,h,l,u)}static CreateRGBATexture(t,e,i,n,r=!0,a=!1,o=3,h=0,l=0,u=!1,m=!1){return new s(t,e,i,5,n,r,a,o,h,l,u,m)}static CreateRGBAStorageTexture(t,e,i,n,r=!0,a=!1,o=3,h=0,l=!1){return new s(t,e,i,5,n,r,a,o,h,1,l)}static CreateRTexture(t,e,i,r,a=!0,o=!1,h=n.g.TRILINEAR_SAMPLINGMODE,l=1){return new s(t,e,i,6,r,a,o,h,l)}static CreateRStorageTexture(t,e,i,r,a=!0,o=!1,h=n.g.TRILINEAR_SAMPLINGMODE,l=1){return new s(t,e,i,6,r,a,o,h,l,1)}}}}]);