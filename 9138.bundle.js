"use strict";(self.webpackChunkeverything_viewer=self.webpackChunkeverything_viewer||[]).push([[9138],{9138:(t,e,i)=>{i.r(e),i.d(e,{AddRayExtensions:()=>v,CreatePickingRay:()=>m,CreatePickingRayInCameraSpace:()=>d,CreatePickingRayInCameraSpaceToRef:()=>g,CreatePickingRayToRef:()=>R,GetForwardRay:()=>A,GetForwardRayToRef:()=>I,MultiPick:()=>k,MultiPickWithRay:()=>q,Pick:()=>_,PickWithBoundingInfo:()=>x,PickWithRay:()=>M,PickingCustomization:()=>f,Ray:()=>y});var n=i(29794),r=i(30388),o=i(65559),s=i(14037),a=i(27309),c=i(77103),h=i(30311),u=i(6315),l=i(65877);const f={internalPickerForMesh:void 0};class y{constructor(t,e,i=Number.MAX_VALUE,n=o.bH){this.origin=t,this.direction=e,this.length=i,this.epsilon=n}clone(){return new y(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(t,e,i=0){const n=y._TmpVector3[0].copyFromFloats(t.x-i,t.y-i,t.z-i),r=y._TmpVector3[1].copyFromFloats(e.x+i,e.y+i,e.z+i);let o,s,a,c,h=0,u=Number.MAX_VALUE;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<n.x||this.origin.x>r.x)return!1}else if(o=1/this.direction.x,s=(n.x-this.origin.x)*o,a=(r.x-this.origin.x)*o,a===-1/0&&(a=1/0),s>a&&(c=s,s=a,a=c),h=Math.max(s,h),u=Math.min(a,u),h>u)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<n.y||this.origin.y>r.y)return!1}else if(o=1/this.direction.y,s=(n.y-this.origin.y)*o,a=(r.y-this.origin.y)*o,a===-1/0&&(a=1/0),s>a&&(c=s,s=a,a=c),h=Math.max(s,h),u=Math.min(a,u),h>u)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<n.z||this.origin.z>r.z)return!1}else if(o=1/this.direction.z,s=(n.z-this.origin.z)*o,a=(r.z-this.origin.z)*o,a===-1/0&&(a=1/0),s>a&&(c=s,s=a,a=c),h=Math.max(s,h),u=Math.min(a,u),h>u)return!1;return!0}intersectsBox(t,e=0){return this.intersectsBoxMinMax(t.minimum,t.maximum,e)}intersectsSphere(t,e=0){const i=t.center.x-this.origin.x,n=t.center.y-this.origin.y,r=t.center.z-this.origin.z,o=i*i+n*n+r*r,s=t.radius+e,a=s*s;if(o<=a)return!0;const c=i*this.direction.x+n*this.direction.y+r*this.direction.z;if(c<0)return!1;return o-c*c<=a}intersectsTriangle(t,e,i){const n=y._TmpVector3[0],r=y._TmpVector3[1],o=y._TmpVector3[2],a=y._TmpVector3[3],h=y._TmpVector3[4];e.subtractToRef(t,n),i.subtractToRef(t,r),s.Pq.CrossToRef(this.direction,r,o);const u=s.Pq.Dot(n,o);if(0===u)return null;const l=1/u;this.origin.subtractToRef(t,a);const f=s.Pq.Dot(a,o)*l;if(f<-this.epsilon||f>1+this.epsilon)return null;s.Pq.CrossToRef(a,n,h);const m=s.Pq.Dot(this.direction,h)*l;if(m<-this.epsilon||f+m>1+this.epsilon)return null;const R=s.Pq.Dot(r,h)*l;return R>this.length?null:new c.w(1-f-m,f,R)}intersectsPlane(t){let e;const i=s.Pq.Dot(t.normal,this.direction);if(Math.abs(i)<9.99999997475243e-7)return null;{const n=s.Pq.Dot(t.normal,this.origin);return e=(-t.d-n)/i,e<0?e<-9.99999997475243e-7?null:0:e}}intersectsAxis(t,e=0){switch(t){case"y":{const t=(this.origin.y-e)/this.direction.y;return t>0?null:new s.Pq(this.origin.x+this.direction.x*-t,e,this.origin.z+this.direction.z*-t)}case"x":{const t=(this.origin.x-e)/this.direction.x;return t>0?null:new s.Pq(e,this.origin.y+this.direction.y*-t,this.origin.z+this.direction.z*-t)}case"z":{const t=(this.origin.z-e)/this.direction.z;return t>0?null:new s.Pq(this.origin.x+this.direction.x*-t,this.origin.y+this.direction.y*-t,e)}default:return null}}intersectsMesh(t,e,i,n=!1,r,o=!1){const a=s.AA.Matrix[0];return t.getWorldMatrix().invertToRef(a),this._tmpRay?y.TransformToRef(this,a,this._tmpRay):this._tmpRay=y.Transform(this,a),t.intersects(this._tmpRay,e,i,n,r,o)}intersectsMeshes(t,e,i){i?i.length=0:i=[];for(let n=0;n<t.length;n++){const r=this.intersectsMesh(t[n],e);r.hit&&i.push(r)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(t,e){return t.distance<e.distance?-1:t.distance>e.distance?1:0}intersectionSegment(t,e,i){const n=this.origin,r=s.AA.Vector3[0],o=s.AA.Vector3[1],a=s.AA.Vector3[2],c=s.AA.Vector3[3];e.subtractToRef(t,r),this.direction.scaleToRef(y._Rayl,a),n.addToRef(a,o),t.subtractToRef(n,c);const h=s.Pq.Dot(r,r),u=s.Pq.Dot(r,a),l=s.Pq.Dot(a,a),f=s.Pq.Dot(r,c),m=s.Pq.Dot(a,c),R=h*l-u*u;let d,g,p=R,T=R;R<y._Smallnum?(d=0,p=1,g=m,T=l):(d=u*m-l*f,g=h*m-u*f,d<0?(d=0,g=m,T=l):d>p&&(d=p,g=m+u,T=l)),g<0?(g=0,-f<0?d=0:-f>h?d=p:(d=-f,p=h)):g>T&&(g=T,-f+u<0?d=0:-f+u>h?d=p:(d=-f+u,p=h));const P=Math.abs(d)<y._Smallnum?0:d/p,x=Math.abs(g)<y._Smallnum?0:g/T,_=s.AA.Vector3[4];a.scaleToRef(x,_);const M=s.AA.Vector3[5];r.scaleToRef(P,M),M.addInPlace(c);const k=s.AA.Vector3[6];M.subtractToRef(_,k);return x>0&&x<=this.length&&k.lengthSquared()<i*i?M.length():-1}update(t,e,i,n,r,o,a,c=!1){if(c){y._RayDistant||(y._RayDistant=y.Zero()),y._RayDistant.unprojectRayToRef(t,e,i,n,s.uq.IdentityReadOnly,o,a);const c=s.AA.Matrix[0];r.invertToRef(c),y.TransformToRef(y._RayDistant,c,this)}else this.unprojectRayToRef(t,e,i,n,r,o,a);return this}static Zero(){return new y(s.Pq.Zero(),s.Pq.Zero())}static CreateNew(t,e,i,n,r,o,s){return y.Zero().update(t,e,i,n,r,o,s)}static CreateNewFromTo(t,e,i=s.uq.IdentityReadOnly){const n=new y(new s.Pq(0,0,0),new s.Pq(0,0,0));return y.CreateFromToToRef(t,e,n,i)}static CreateFromToToRef(t,e,i,n=s.uq.IdentityReadOnly){i.origin.copyFrom(t);const r=e.subtractToRef(t,i.direction),o=Math.sqrt(r.x*r.x+r.y*r.y+r.z*r.z);return i.length=o,i.direction.normalize(),y.TransformToRef(i,n,i)}static Transform(t,e){const i=new y(new s.Pq(0,0,0),new s.Pq(0,0,0));return y.TransformToRef(t,e,i),i}static TransformToRef(t,e,i){s.Pq.TransformCoordinatesToRef(t.origin,e,i.origin),s.Pq.TransformNormalToRef(t.direction,e,i.direction),i.length=t.length,i.epsilon=t.epsilon;const n=i.direction,r=n.length();if(0!==r&&1!==r){const t=1/r;n.x*=t,n.y*=t,n.z*=t,i.length*=r}return i}unprojectRayToRef(t,e,i,n,r,o,a){const c=s.AA.Matrix[0];r.multiplyToRef(o,c),c.multiplyToRef(a,c),c.invert();const h=u.q.LastCreatedEngine,l=s.AA.Vector3[0];l.x=t/i*2-1,l.y=-(e/n*2-1),l.z=h?.useReverseDepthBuffer?1:h?.isNDCHalfZRange?0:-1;const f=s.AA.Vector3[1].copyFromFloats(l.x,l.y,1-1e-8),y=s.AA.Vector3[2],m=s.AA.Vector3[3];s.Pq.TransformCoordinatesToRef(l,c,y),s.Pq.TransformCoordinatesToRef(f,c,m),this.origin.copyFrom(y),m.subtractToRef(y,this.direction),this.direction.normalize()}}function m(t,e,i,n,r,o=!1){const s=y.Zero();return R(t,e,i,n,s,r,o),s}function R(t,e,i,n,r,o,a=!1,c=!1){const h=t.getEngine();if(!o&&!(o=t.activeCamera))return t;const u=o.viewport,l=h.getRenderHeight(),{x:f,y,width:m,height:R}=u.toGlobal(h.getRenderWidth(),l),d=1/h.getHardwareScalingLevel();return e=e*d-f,i=i*d-(l-y-R),r.update(e,i,m,R,n||s.uq.IdentityReadOnly,a?s.uq.IdentityReadOnly:o.getViewMatrix(),o.getProjectionMatrix(),c),t}function d(t,e,i,n){const r=y.Zero();return g(t,e,i,r,n),r}function g(t,e,i,n,r){if(!h.G)return t;const o=t.getEngine();if(!r&&!(r=t.activeCamera))throw new Error("Active camera not set");const a=r.viewport,c=o.getRenderHeight(),{x:u,y:l,width:f,height:y}=a.toGlobal(o.getRenderWidth(),c),m=s.uq.Identity(),R=1/o.getHardwareScalingLevel();return e=e*R-u,i=i*R-(c-l-y),n.update(e,i,f,y,m,m,r.getProjectionMatrix()),t}function p(t,e,i,n,r,o,s,a){const c=e(n,i.enableDistantPicking),h=i.intersects(c,r,s,o,n,a);return h&&h.hit?!r&&null!=t&&h.distance>=t.distance?null:h:null}function T(t,e,i,n,r,o){let a=null;const c=!!(t.activeCameras&&t.activeCameras.length>1&&t.cameraToUseForPointers!==t.activeCamera),u=t.cameraToUseForPointers||t.activeCamera,l=f.internalPickerForMesh||p;for(let h=0;h<t.meshes.length;h++){const f=t.meshes[h];if(i){if(!i(f,-1))continue}else if(!f.isEnabled()||!f.isVisible||!f.isPickable)continue;const y=c&&f.isWorldMatrixCameraDependent(),m=f.computeWorldMatrix(y,u);if(f.hasThinInstances&&f.thinInstanceEnablePicking){const t=l(a,e,f,m,!0,!0,o);if(t){if(r)return t;const c=s.AA.Matrix[1],h=f.thinInstanceGetWorldMatrices();for(let t=0;t<h.length;t++){if(i&&!i(f,t))continue;h[t].multiplyToRef(m,c);const s=l(a,e,f,c,n,r,o,!0);if(s&&(a=s,a.thinInstanceIndex=t,n))return a}}}else{const t=l(a,e,f,m,n,r,o);if(t&&(a=t,n))return a}}return a||new h.G}function P(t,e,i,n){if(!h.G)return null;const r=[],o=!!(t.activeCameras&&t.activeCameras.length>1&&t.cameraToUseForPointers!==t.activeCamera),a=t.cameraToUseForPointers||t.activeCamera,c=f.internalPickerForMesh||p;for(let h=0;h<t.meshes.length;h++){const u=t.meshes[h];if(i){if(!i(u,-1))continue}else if(!u.isEnabled()||!u.isVisible||!u.isPickable)continue;const l=o&&u.isWorldMatrixCameraDependent(),f=u.computeWorldMatrix(l,a);if(u.hasThinInstances&&u.thinInstanceEnablePicking){if(c(null,e,u,f,!0,!0,n)){const t=s.AA.Matrix[1],o=u.thinInstanceGetWorldMatrices();for(let s=0;s<o.length;s++){if(i&&!i(u,s))continue;o[s].multiplyToRef(f,t);const a=c(null,e,u,t,!1,!1,n,!0);a&&(a.thinInstanceIndex=s,r.push(a))}}}else{const t=c(null,e,u,f,!1,!1,n);t&&r.push(t)}}return r}function x(t,e,i,n,r,o){if(!h.G)return null;const a=T(t,n=>(t._tempPickingRay||(t._tempPickingRay=y.Zero()),R(t,e,i,n,t._tempPickingRay,o||null),t._tempPickingRay),n,r,!0);return a&&(a.ray=m(t,e,i,s.uq.Identity(),o||null)),a}function _(t,e,i,n,r,o,a,c=!1){const h=T(t,(n,r)=>(t._tempPickingRay||(t._tempPickingRay=y.Zero()),R(t,e,i,n,t._tempPickingRay,o||null,!1,r),t._tempPickingRay),n,r,!1,a);return h&&(h.ray=m(t,e,i,s.uq.Identity(),o||null)),h}function M(t,e,i,n,r){const o=T(t,i=>(t._pickWithRayInverseMatrix||(t._pickWithRayInverseMatrix=s.uq.Identity()),i.invertToRef(t._pickWithRayInverseMatrix),t._cachedRayForTransform||(t._cachedRayForTransform=y.Zero()),y.TransformToRef(e,t._pickWithRayInverseMatrix,t._cachedRayForTransform),t._cachedRayForTransform),i,n,!1,r);return o&&(o.ray=e),o}function k(t,e,i,n,r,o){return P(t,n=>m(t,e,i,n,r||null),n,o)}function q(t,e,i,n){return P(t,i=>(t._pickWithRayInverseMatrix||(t._pickWithRayInverseMatrix=s.uq.Identity()),i.invertToRef(t._pickWithRayInverseMatrix),t._cachedRayForTransform||(t._cachedRayForTransform=y.Zero()),y.TransformToRef(e,t._pickWithRayInverseMatrix,t._cachedRayForTransform),t._cachedRayForTransform),i,n)}function A(t,e=100,i,n){return I(t,new y(s.Pq.Zero(),s.Pq.Zero(),e),e,i,n)}function I(t,e,i=100,n,r){n||(n=t.getWorldMatrix()),e.length=i,r?e.origin.copyFrom(r):e.origin.copyFrom(t.position);const o=s.AA.Vector3[2];o.set(0,0,t._scene.useRightHandedSystem?-1:1);const a=s.AA.Vector3[3];return s.Pq.TransformNormalToRef(o,n,a),s.Pq.NormalizeToRef(a,e.direction),e}function v(t,e){e&&(e.prototype.getForwardRay=function(t=100,e,i){return I(this,new y(s.Pq.Zero(),s.Pq.Zero(),t),t,e,i)},e.prototype.getForwardRayToRef=function(t,e=100,i,n){return I(this,t,e,i,n)}),t&&(l.h._IsPickingAvailable=!0,t.prototype.createPickingRay=function(t,e,i,n,r=!1){return m(this,t,e,i,n,r)})}y._TmpVector3=(0,a.mI)(6,s.Pq.Zero),y._RayDistant=y.Zero(),y._Smallnum=1e-8,y._Rayl=1e9,v(n.Z,r.i),n.Z.prototype.createPickingRayToRef=function(t,e,i,n,r,o=!1,s=!1){return R(this,t,e,i,n,r,o,s)},n.Z.prototype.createPickingRayInCameraSpace=function(t,e,i){return d(this,t,e,i)},n.Z.prototype.createPickingRayInCameraSpaceToRef=function(t,e,i,n){return g(this,t,e,i,n)},n.Z.prototype.pickWithBoundingInfo=function(t,e,i,n,r){return x(this,t,e,i,n,r)},n.Z.prototype.pick=function(t,e,i,n,r,o,s=!1){return _(this,t,e,i,n,r,o,s)},n.Z.prototype.pickWithRay=function(t,e,i,n){return M(this,t,e,i,n)},n.Z.prototype.multiPick=function(t,e,i,n,r){return k(this,t,e,i,n,r)},n.Z.prototype.multiPickWithRay=function(t,e,i){return q(this,t,e,i)}}}]);