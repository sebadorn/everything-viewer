"use strict";(self.webpackChunkeverything_viewer=self.webpackChunkeverything_viewer||[]).push([[7433],{27433:(e,s,t)=>{t.d(s,{MSFT_lod:()=>l});var r=t(99848),i=t(39018),n=t(45316),o=t(37812);const a="MSFT_lod";class l{constructor(e){this.name=a,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new r.cP,this.onMaterialLODsLoadedObservable=new r.cP,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.maxLODsToLoad=this._loader.parent.extensionOptions[a]?.maxLODsToLoad??this.maxLODsToLoad,this.enabled=this._loader.isExtensionUsed(a)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){const s=Promise.all(this._nodePromiseLODs[e]).then((()=>{0!==e&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())}));this._loader._completePromises.push(s)}for(let e=0;e<this._materialPromiseLODs.length;e++){const s=Promise.all(this._materialPromiseLODs[e]).then((()=>{0!==e&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())}));this._loader._completePromises.push(s)}}loadSceneAsync(e,s){const t=this._loader.loadSceneAsync(e,s);return this._loadBufferLOD(this._bufferLODs,0),t}loadNodeAsync(e,s,t){return n.BT.LoadExtensionAsync(e,s,this.name,((e,r)=>{let n;const o=this._getLODs(e,s,this._loader.gltf.nodes,r.ids);this._loader.logOpen(`${e}`);for(let e=0;e<o.length;e++){const s=o[e];0!==e&&(this._nodeIndexLOD=e,this._nodeSignalLODs[e]=this._nodeSignalLODs[e]||new i.c);const r=e=>{t(e),e.setEnabled(!1)},a=this._loader.loadNodeAsync(`/nodes/${s.index}`,s,r).then((s=>{if(0!==e){const s=o[e-1];s._babylonTransformNode&&(this._disposeTransformNode(s._babylonTransformNode),delete s._babylonTransformNode)}return s.setEnabled(!0),s}));this._nodePromiseLODs[e]=this._nodePromiseLODs[e]||[],0===e?n=a:(this._nodeIndexLOD=null,this._nodePromiseLODs[e].push(a))}return this._loader.logClose(),n}))}_loadMaterialAsync(e,s,t,r,i){return this._nodeIndexLOD?null:n.BT.LoadExtensionAsync(e,s,this.name,((e,n)=>{let o;const a=this._getLODs(e,s,this._loader.gltf.materials,n.ids);this._loader.logOpen(`${e}`);for(let e=0;e<a.length;e++){const s=a[e];0!==e&&(this._materialIndexLOD=e);const n=this._loader._loadMaterialAsync(`/materials/${s.index}`,s,t,r,(s=>{0===e&&i(s)})).then((s=>{if(0!==e){i(s);const t=a[e-1]._data;t[r]&&(this._disposeMaterials([t[r].babylonMaterial]),delete t[r])}return s}));this._materialPromiseLODs[e]=this._materialPromiseLODs[e]||[],0===e?o=n:(this._materialIndexLOD=null,this._materialPromiseLODs[e].push(n))}return this._loader.logClose(),o}))}_loadUriAsync(e,s,t){if(null!==this._nodeIndexLOD){this._loader.log("deferred");const r=this._nodeIndexLOD-1;return this._nodeSignalLODs[r]=this._nodeSignalLODs[r]||new i.c,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then((()=>this._loader.loadUriAsync(e,s,t)))}if(null!==this._materialIndexLOD){this._loader.log("deferred");const r=this._materialIndexLOD-1;return this._materialSignalLODs[r]=this._materialSignalLODs[r]||new i.c,this._materialSignalLODs[r].promise.then((()=>this._loader.loadUriAsync(e,s,t)))}return null}loadBufferAsync(e,s,t,r){if(this._loader.parent.useRangeRequests&&!s.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);const s=(e,s)=>{const n=t,o=n+r-1;let a=e[s];return a?(a.start=Math.min(a.start,n),a.end=Math.max(a.end,o)):(a={start:n,end:o,loaded:new i.c},e[s]=a),a.loaded.promise.then((e=>new Uint8Array(e.buffer,e.byteOffset+t-a.start,r)))};return this._loader.log("deferred"),null!==this._nodeIndexLOD?s(this._nodeBufferLODs,this._nodeIndexLOD):null!==this._materialIndexLOD?s(this._materialBufferLODs,this._materialIndexLOD):s(this._bufferLODs,0)}return null}_loadBufferLOD(e,s){const t=e[s];t&&(this._loader.log(`Loading buffer range [${t.start}-${t.end}]`),this._loader.bin.readAsync(t.start,t.end-t.start+1).then((e=>{t.loaded.resolve(e)}),(e=>{t.loaded.reject(e)})))}_getLODs(e,s,t,r){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");const i=[];for(let s=r.length-1;s>=0;s--)if(i.push(n.l2.Get(`${e}/ids/${r[s]}`,t,r[s])),i.length===this.maxLODsToLoad)return i;return i.push(s),i}_disposeTransformNode(e){const s=[],t=e.material;t&&s.push(t);for(const t of e.getChildMeshes())t.material&&s.push(t.material);e.dispose();const r=s.filter((e=>this._loader.babylonScene.meshes.every((s=>s.material!=e))));this._disposeMaterials(r)}_disposeMaterials(e){const s={};for(const t of e){for(const e of t.getActiveTextures())s[e.uniqueId]=e;t.dispose()}for(const e in s)for(const t of this._loader.babylonScene.materials)t.hasTexture(s[e])&&delete s[e];for(const e in s)s[e].dispose()}}(0,o.Hg)(a),(0,o.Ye)(a,!0,(e=>new l(e)))}}]);