"use strict";(self.webpackChunkeverything_viewer=self.webpackChunkeverything_viewer||[]).push([[9711],{79711:(e,t,s)=>{s.r(t),s.d(t,{ShadowGenerator:()=>P});var i=s(14037),r=s(26041),a=s(95616),n=s(64704),o=s(82781),h=s(96882),l=s(77891),d=s(75524),u=s(56552),p=s(79259),c=s(26877),_=s(84255),f=s(18800);class g extends _.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([s.e(2850).then(s.bind(s,12850)),s.e(5417).then(s.bind(s,85417))]))):t.push(Promise.all([s.e(4509).then(s.bind(s,54509)),s.e(3802).then(s.bind(s,83802))]))}constructor(e,t=null,s,i,r){const a=!!r?.blockCompilation;super({...r,name:e,engine:t||f.Engine.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:g.FragmentUrl,uniforms:g.Uniforms,samplers:g.Samplers,vertexUrl:g.VertexUrl,blockCompilation:!0}),this._packedFloat=!1,this._staticDefines="",this.textureWidth=0,this.textureHeight=0,this._staticDefines=r?Array.isArray(r.defines)?r.defines.join("\n"):r.defines||"":"",this.options.blockCompilation=a,void 0!==s&&(this.direction=s),void 0!==i&&(this.kernel=i)}set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this.options.blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this.options.blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}bind(e=!1){super.bind(e),this._drawWrapper.effect.setFloat2("delta",1/this.textureWidth*this.direction.x,1/this.textureHeight*this.direction.y)}_updateParameters(e,t){const s=this._kernel,i=(s-1)/2;let r=[],a=[],n=0;for(let e=0;e<s;e++){const t=e/(s-1),o=this._gaussianWeight(2*t-1);r[e]=e-i,a[e]=o,n+=o}for(let e=0;e<a.length;e++)a[e]/=n;const o=[],h=[],l=[];for(let e=0;e<=i;e+=2){const t=Math.min(e+1,Math.floor(i));if(e===t)l.push({o:r[e],w:a[e]});else{const s=t===i,n=a[e]+a[t]*(s?.5:1),o=r[e]+1/(1+a[e]/a[t]);0===o?(l.push({o:r[e],w:a[e]}),l.push({o:r[e+1],w:a[e+1]})):(l.push({o,w:n}),l.push({o:-o,w:n}))}}for(let e=0;e<l.length;e++)h[e]=l[e].o,o[e]=l[e].w;r=h,a=o;const d=this.options.engine.getCaps().maxVaryingVectors-(1===this.options.shaderLanguage?1:0),u=Math.max(d,0)-1;let p=Math.min(r.length,u),c="";c+=this._staticDefines,-1!=this._staticDefines.indexOf("DOF")&&(c+=`#define CENTER_WEIGHT ${this._glslFloat(a[p-1])}\n`,p--);for(let e=0;e<p;e++)c+=`#define KERNEL_OFFSET${e} ${this._glslFloat(r[e])}\n`,c+=`#define KERNEL_WEIGHT${e} ${this._glslFloat(a[e])}\n`;let _=0;for(let e=u;e<r.length;e++)c+=`#define KERNEL_DEP_OFFSET${_} ${this._glslFloat(r[e])}\n`,c+=`#define KERNEL_DEP_WEIGHT${_} ${this._glslFloat(a[e])}\n`,_++;this.packedFloat&&(c+="#define PACKEDFLOAT 1"),this.options.blockCompilation=!1,this.updateEffect(c,null,null,{varyingCount:p,depCount:_},e,t)}_nearestBestKernel(e){const t=Math.round(e);for(const e of[t,t-1,t+1,t-2,t+2])if(e%2!=0&&Math.floor(e/2)%2==0&&e>0)return Math.max(e,3);return Math.max(t,3)}_gaussianWeight(e){const t=1/3,s=-e*e/(2*t*t);return 1/(Math.sqrt(2*Math.PI)*t)*Math.exp(s)}_glslFloat(e,t=8){return e.toFixed(t).replace(/0+$/,"")}}g.VertexUrl="kernelBlur",g.FragmentUrl="kernelBlur",g.Uniforms=["delta","direction"],g.Samplers=["circleOfConfusionSampler"];class S extends l.w{get direction(){return this._effectWrapper.direction}set direction(e){this._effectWrapper.direction=e}set kernel(e){this._effectWrapper.kernel=e}get kernel(){return this._effectWrapper.kernel}set packedFloat(e){this._effectWrapper.packedFloat=e}get packedFloat(){return this._effectWrapper.packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,t,s,i,r=null,a=o.g.BILINEAR_SAMPLINGMODE,n,h,l=0,d="",u=!1,p=5){const c="number"==typeof i?u:!!i.blockCompilation,_={uniforms:g.Uniforms,samplers:g.Samplers,size:"number"==typeof i?i:void 0,camera:r,samplingMode:a,engine:n,reusable:h,textureType:l,vertexUrl:g.VertexUrl,indexParameters:{varyingCount:0,depCount:0},textureFormat:p,defines:d,...i,blockCompilation:!0};super(e,g.FragmentUrl,{effectWrapper:"number"!=typeof i&&i.effectWrapper?void 0:new g(e,n,void 0,void 0,_),..._}),this._effectWrapper.options.blockCompilation=c,this.direction=t,this.onApplyObservable.add(()=>{this._effectWrapper.textureWidth=this._outputTexture?this._outputTexture.width:this.width,this._effectWrapper.textureHeight=this._outputTexture?this._outputTexture.height:this.height}),this.kernel=s}updateEffect(e=null,t=null,s=null,i,r,a){this._effectWrapper._updateParameters(r,a)}static _Parse(e,t,s,i){return c.p.Parse(()=>new S(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,s.getEngine(),e.reusable,e.textureType,void 0,!1),e,s,i)}}(0,d.Cg)([(0,p.WM)()],S.prototype,"direction",null),(0,d.Cg)([(0,p.lK)()],S.prototype,"kernel",null),(0,d.Cg)([(0,p.lK)()],S.prototype,"packedFloat",null),(0,u.Y5)("BABYLON.BlurPostProcess",S);var M=s(99848),E=s(45503),w=s(82565),m=s(23099),T=s(35476),x=s(30492),L=s(80467);class P{get bias(){return this._bias}set bias(e){this._bias=e}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())}get depthScale(){return void 0!==this._depthScale?this._depthScale:this._light.getDepthScale()}set depthScale(e){this._depthScale=e}_validateFilter(e){return e}get filter(){return this._filter}set filter(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===P.FILTER_BLUREXPONENTIALSHADOWMAP)return void(this.useExponentialShadowMap=!0);if(e===P.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)return void(this.useCloseExponentialShadowMap=!0);if(e===P.FILTER_PCF||e===P.FILTER_PCSS)return void(this.usePoissonSampling=!0)}e!==P.FILTER_PCF&&e!==P.FILTER_PCSS||this._scene.getEngine()._features.supportShadowSamplers?this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty()):this.usePoissonSampling=!0}get usePoissonSampling(){return this.filter===P.FILTER_POISSONSAMPLING}set usePoissonSampling(e){const t=this._validateFilter(P.FILTER_POISSONSAMPLING);(e||this.filter===P.FILTER_POISSONSAMPLING)&&(this.filter=e?t:P.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===P.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(e){const t=this._validateFilter(P.FILTER_EXPONENTIALSHADOWMAP);(e||this.filter===P.FILTER_EXPONENTIALSHADOWMAP)&&(this.filter=e?t:P.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===P.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(e){const t=this._validateFilter(P.FILTER_BLUREXPONENTIALSHADOWMAP);(e||this.filter===P.FILTER_BLUREXPONENTIALSHADOWMAP)&&(this.filter=e?t:P.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===P.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(e){const t=this._validateFilter(P.FILTER_CLOSEEXPONENTIALSHADOWMAP);(e||this.filter===P.FILTER_CLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:P.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===P.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(e){const t=this._validateFilter(P.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);(e||this.filter===P.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:P.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===P.FILTER_PCF}set usePercentageCloserFiltering(e){const t=this._validateFilter(P.FILTER_PCF);(e||this.filter===P.FILTER_PCF)&&(this.filter=e?t:P.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===P.FILTER_PCSS}set useContactHardeningShadow(e){const t=this._validateFilter(P.FILTER_PCSS);(e||this.filter===P.FILTER_PCSS)&&(this.filter=e?t:P.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(e){this._contactHardeningLightSizeUVRatio=e}get darkness(){return this._darkness}set darkness(e){this.setDarkness(e)}getDarkness(){return this._darkness}setDarkness(e){return this._darkness=e>=1?1:e<=0?0:e,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){this.setTransparencyShadow(e)}setTransparencyShadow(e){return this._transparencyShadow=e,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return P.CLASSNAME}addShadowCaster(e,t=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),-1===this._shadowMap.renderList.indexOf(e)&&this._shadowMap.renderList.push(e),t)for(const t of e.getChildMeshes())-1===this._shadowMap.renderList.indexOf(t)&&this._shadowMap.renderList.push(t);return this}removeShadowCaster(e,t=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;const s=this._shadowMap.renderList.indexOf(e);if(-1!==s&&this._shadowMap.renderList.splice(s,1),t)for(const t of e.getChildren())this.removeShadowCaster(t);return this}getLight(){return this._light}get shaderLanguage(){return this._shaderLanguage}_getCamera(){return this._camera??this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}constructor(e,t,s,r,a,n=!1){this.onBeforeShadowMapRenderObservable=new M.cP,this.onAfterShadowMapRenderObservable=new M.cP,this.onBeforeShadowMapRenderMeshObservable=new M.cP,this.onAfterShadowMapRenderMeshObservable=new M.cP,this.doNotSerialize=!1,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=P.FILTER_NONE,this._filteringQuality=P.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this._shaderLanguage=0,this.forceBackFacesOnly=!1,this._lightDirection=i.Pq.Zero(),this._viewMatrix=i.uq.Zero(),this._projectionMatrix=i.uq.Zero(),this._transformMatrix=i.uq.Zero(),this._cachedPosition=new i.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new i.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=i.uq.Identity(),this._shadersLoaded=!1,this._mapSize=e,this._light=t,this._scene=t.getScene(),this._camera=r??null,this._useRedTextureType=!!a,this._initShaderSourceAsync(n);let o=t._shadowGenerators;o||(o=t._shadowGenerators=new Map),o.set(this._camera,this),this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),P._SceneComponentInitialization(this._scene);const h=this._scene.getEngine().getCaps();s?h.textureFloatRender&&h.textureFloatLinearFiltering?this._textureType=1:h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering?this._textureType=2:h.textureFloatRender&&h.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){const e=this._scene.getEngine();e._features.supportDepthStencilTexture?(this._shadowMap=new h.RenderTargetTexture(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,`DepthStencilForShadowGenerator-${this._light.name}`)):this._shadowMap=new h.RenderTargetTexture(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube()),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(this._createTargetRenderTexture(),null===this._shadowMap)return;this._shadowMap.wrapU=o.g.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=o.g.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(o.g.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=(e,t,s,i)=>this._renderForShadowMap(e,t,s,i),this._shadowMap.customIsReadyFunction=(e,t,s)=>{if(!s||!e.subMeshes)return!0;let i=!0;for(const t of e.subMeshes){const e=t.getRenderingMesh(),s=this._scene.getEngine(),r=t.getMaterial();if(!r||0===t.verticesCount||this.customAllowRendering&&!this.customAllowRendering(t))continue;const a=e._getInstancesRenderList(t._id,!!t.getReplacementMesh());if(a.mustReturn)continue;const n=s.getCaps().instancedArrays&&(null!==a.visibleInstances[t._id]&&void 0!==a.visibleInstances[t._id]||e.hasThinInstances),o=r.needAlphaBlendingForMesh(e);i=this.isReady(t,n,o)&&i}return i};const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(()=>{this._currentSceneUBO=this._scene.getSceneUniformBuffer(),e._debugPushGroup?.(`shadow map generation for pass id ${e.currentRenderPassId}`,1)}),this._shadowMap.onBeforeRenderObservable.add(t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=t,this._filter===P.FILTER_PCF&&e.setColorWrite(!1),this.getTransformMatrix(),this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onAfterUnbindObservable.add(()=>{if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._scene.updateTransformMatrix(),this._filter===P.FILTER_PCF&&e.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap)return void e._debugPopGroup?.(1);const t=this.getShadowMapForRendering();t&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,t.renderTarget,!0),e.unBindFramebuffer(t.renderTarget,!0)),e._debugPopGroup?.(1)});const t=new r.ov(0,0,0,0),s=new r.ov(1,1,1,1);this._shadowMap.onClearObservable.add(e=>{this._filter===P.FILTER_PCF?e.clear(s,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e.clear(t,!0,!0,!1):e.clear(s,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(e=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=e.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()});for(let e=m.m.MIN_RENDERINGGROUPS;e<m.m.MAX_RENDERINGGROUPS;e++)this._shadowMap.setRenderingAutoClearDepthStencil(e,!1)}async _initShaderSourceAsync(e=!1){!this._scene.getEngine().isWebGPU||e||P.ForceGLSL?await Promise.all([s.e(357).then(s.bind(s,70357)),s.e(3906).then(s.bind(s,53906)),s.e(9386).then(s.bind(s,69386)),s.e(5426).then(s.bind(s,85426))]):(this._shaderLanguage=1,await Promise.all([s.e(60).then(s.bind(s,90060)),s.e(5738).then(s.bind(s,65738)),s.e(355).then(s.bind(s,10355)),s.e(5799).then(s.bind(s,95799))])),this._shadersLoaded=!0}_initializeBlurRTTAndPostProcesses(){const e=this._scene.getEngine(),t=this._mapSize/this.blurScale;this.useKernelBlur&&1===this.blurScale||(this._shadowMap2=new h.RenderTargetTexture(this._light.name+"_shadowMap2",t,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=o.g.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=o.g.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(o.g.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new S(this._light.name+"KernelBlurX",new i.I9(1,0),this.blurKernel,1,null,o.g.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.width=t,this._kernelBlurXPostprocess.height=t,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add(e=>{e.setTexture("textureSampler",this._shadowMap)}),this._kernelBlurYPostprocess=new S(this._light.name+"KernelBlurY",new i.I9(0,1),this.blurKernel,1,null,o.g.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,0===this._textureType&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new l.w(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,o.g.BILINEAR_SAMPLINGMODE,e,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType,void 0,void 0,void 0,void 0,this._shaderLanguage),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add(e=>{e.setFloat2("screenSize",t,t),e.setTexture("textureSampler",this._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(e,t,s,i){let r;if(i.length)for(r=0;r<i.length;r++)this._renderSubMeshForShadowMap(i.data[r]);for(r=0;r<e.length;r++)this._renderSubMeshForShadowMap(e.data[r]);for(r=0;r<t.length;r++)this._renderSubMeshForShadowMap(t.data[r]);if(this._transparencyShadow)for(r=0;r<s.length;r++)this._renderSubMeshForShadowMap(s.data[r],!0);else for(r=0;r<s.length;r++)s.data[r].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(e,t,s){t.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(e,t=!1){const s=e.getRenderingMesh(),i=e.getEffectiveMesh(),r=this._scene,a=r.getEngine(),o=e.getMaterial();if(i._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!o||0===e.verticesCount||e._renderId===r.getRenderId())return;const h=r.useRightHandedSystem,l=i._getWorldMatrixDeterminant()<0;let d=o._getEffectiveOrientation(s);(l&&!h||!l&&h)&&(d=0===d?1:0);const u=0===d;a.setState(o.backFaceCulling,void 0,void 0,u,o.cullBackFaces);const p=s._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(p.mustReturn)return;const c=a.getCaps().instancedArrays&&(null!==p.visibleInstances[e._id]&&void 0!==p.visibleInstances[e._id]||s.hasThinInstances);if(!this.customAllowRendering||this.customAllowRendering(e))if(this.isReady(e,c,t)){e._renderId=r.getRenderId();const h=o.shadowDepthWrapper,l=h?.getEffect(e,this,a.currentRenderPassId)??e._getDrawWrapper(),d=T.E.GetEffect(l);a.enableEffect(l),c||s._bind(e,d,o.fillMode),this.getTransformMatrix(),d.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===n.v.LIGHTTYPEID_DIRECTIONALLIGHT?d.setVector3("lightDataSM",this._cachedDirection):d.setVector3("lightDataSM",this._cachedPosition);const u=this._getCamera();if(d.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(u),this.getLight().getDepthMinZ(u)+this.getLight().getDepthMaxZ(u)),t&&this.enableSoftTransparentShadow&&d.setFloat2("softTransparentShadowSM",i.visibility*o.alpha,this._opacityTexture?.getAlphaFromRGB?1:0),h)e._setMainDrawWrapperOverride(l),h.standalone?h.baseMaterial.bindForSubMesh(i.getWorldMatrix(),s,e):o.bindForSubMesh(i.getWorldMatrix(),s,e),e._setMainDrawWrapperOverride(null);else{if(this._opacityTexture&&(d.setTexture("diffuseSampler",this._opacityTexture),d.setMatrix("diffuseMatrix",this._opacityTexture.getTextureMatrix()||this._defaultTextureMatrix)),s.useBones&&s.computeBonesUsingShaders&&s.skeleton){const e=s.skeleton;if(e.isUsingTextureForMatrices){const t=e.getTransformMatrixTexture(s);if(!t)return;d.setTexture("boneSampler",t),d.setFloat("boneTextureWidth",4*(e.bones.length+1))}else d.setMatrices("mBones",e.getTransformMatrices(s))}(0,L.nR)(s,d),s.morphTargetManager&&s.morphTargetManager.isUsingTextureForTargets&&s.morphTargetManager._bind(d);const t=e.getMesh().bakedVertexAnimationManager;t&&t.isEnabled&&t.bind(d,c),(0,x.ij)(d,o,r)}this._useUBO||h||this._bindCustomEffectForRenderSubMeshForShadowMap(e,d,i),(0,L._8)(d,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();const _=i.getWorldMatrix();c&&(i.getMeshUniformBuffer().bindToEffect(d,"Mesh"),i.transferToEffect(_)),this.forceBackFacesOnly&&a.setState(!0,0,!1,!0,o.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(s),this.onBeforeShadowMapRenderObservable.notifyObservers(d),s._processRendering(i,e,d,o.fillMode,p,c,(e,t)=>{i===s||e?(i.getMeshUniformBuffer().bindToEffect(d,"Mesh"),i.transferToEffect(e?t:_)):(s.getMeshUniformBuffer().bindToEffect(d,"Mesh"),s.transferToEffect(t))}),this.forceBackFacesOnly&&a.setState(!0,0,!1,!1,o.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(d),this.onAfterShadowMapRenderMeshObservable.notifyObservers(s)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){this._shadowMap&&(this.filter===P.FILTER_NONE||this.filter===P.FILTER_PCSS?this._shadowMap.updateSamplingMode(o.g.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(o.g.BILINEAR_SAMPLINGMODE))}forceCompilation(e,t){const s={useInstances:!1,...t},i=this.getShadowMap();if(!i)return void(e&&e(this));const r=i.renderList;if(!r)return void(e&&e(this));const a=[];for(const e of r)a.push(...e.subMeshes);if(0===a.length)return void(e&&e(this));let n=0;const o=()=>{if(this._scene&&this._scene.getEngine()){for(;this.isReady(a[n],s.useInstances,a[n].getMaterial()?.needAlphaBlendingForMesh(a[n].getMesh())??!1);)if(n++,n>=a.length)return void(e&&e(this));setTimeout(o,16)}};o()}async forceCompilationAsync(e){return await new Promise(t=>{this.forceCompilation(()=>{t()},e)})}_isReadyCustomDefines(e,t,s){}_prepareShadowDefines(e,t,s,i){s.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),s.push("#define SM_FLOAT "+(0!==this._textureType?"1":"0")),s.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),s.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));const r=e.getMesh();return s.push("#define SM_NORMALBIAS "+(this.normalBias&&r.isVerticesDataPresent(a.R.NormalKind)?"1":"0")),s.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===n.v.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),s.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),s.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&i?"1":"0")),this._isReadyCustomDefines(s,e,t),s}isReady(e,t,s){if(!this._shadersLoaded)return!1;const i=e.getMaterial(),r=i?.shadowDepthWrapper;if(this._opacityTexture=null,!i)return!1;const n=[];if(this._prepareShadowDefines(e,t,n,s),r){if(!r.isReadyForSubMesh(e,n,this,t,this._scene.getEngine().currentRenderPassId))return!1}else{const s=e._getDrawWrapper(void 0,!0);let r=s.effect,o=s.defines;const h=[a.R.PositionKind],l=e.getMesh();let d=!1,u=!1,p=!1;const c=!1;this.normalBias&&l.isVerticesDataPresent(a.R.NormalKind)&&(h.push(a.R.NormalKind),n.push("#define NORMAL"),d=!0,l.nonUniformScaling&&n.push("#define NONUNIFORMSCALING"));const _=i.needAlphaTestingForMesh(l);if((_||i.needAlphaBlendingForMesh(l))&&(this.useOpacityTextureForTransparentShadow?this._opacityTexture=i.opacityTexture:this._opacityTexture=i.getAlphaTestTexture(),this._opacityTexture)){if(!this._opacityTexture.isReady())return!1;const e=i.alphaCutOff??P.DEFAULT_ALPHA_CUTOFF;n.push("#define ALPHATEXTURE"),_&&n.push(`#define ALPHATESTVALUE ${e}${e%1==0?".":""}`),l.isVerticesDataPresent(a.R.UVKind)&&(h.push(a.R.UVKind),n.push("#define UV1"),u=!0),l.isVerticesDataPresent(a.R.UV2Kind)&&1===this._opacityTexture.coordinatesIndex&&(h.push(a.R.UV2Kind),n.push("#define UV2"),p=!0)}const f=new w.J;if(l.useBones&&l.computeBonesUsingShaders&&l.skeleton){h.push(a.R.MatricesIndicesKind),h.push(a.R.MatricesWeightsKind),l.numBoneInfluencers>4&&(h.push(a.R.MatricesIndicesExtraKind),h.push(a.R.MatricesWeightsExtraKind));const e=l.skeleton;n.push("#define NUM_BONE_INFLUENCERS "+l.numBoneInfluencers),l.numBoneInfluencers>0&&f.addCPUSkinningFallback(0,l),e.isUsingTextureForMatrices?n.push("#define BONETEXTURE"):n.push("#define BonesPerMesh "+(e.bones.length+1))}else n.push("#define NUM_BONE_INFLUENCERS 0");const g=l.morphTargetManager?(0,L.Dk)(l.morphTargetManager,n,h,l,!0,d,!1,u,p,c):0;if((0,x.r4)(i,this._scene,n),t&&(n.push("#define INSTANCES"),(0,L.te)(h),e.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(const e of this.customShaderOptions.defines)-1===n.indexOf(e)&&n.push(e);const S=l.bakedVertexAnimationManager;S&&S.isEnabled&&(n.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&h.push("bakedVertexAnimationSettingsInstanced"));const M=n.join("\n");if(o!==M){o=M;let e="shadowMap";const t=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","morphTargetCount","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],i=["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"],a=["Scene","Mesh"];if((0,x.Ll)(t),this.customShaderOptions){if(e=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(const e of this.customShaderOptions.attributes)-1===h.indexOf(e)&&h.push(e);if(this.customShaderOptions.uniforms)for(const e of this.customShaderOptions.uniforms)-1===t.indexOf(e)&&t.push(e);if(this.customShaderOptions.samplers)for(const e of this.customShaderOptions.samplers)-1===i.indexOf(e)&&i.push(e)}const n=this._scene.getEngine();r=n.createEffect(e,{attributes:h,uniformsNames:t,uniformBuffersNames:a,samplers:i,defines:M,fallbacks:f,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:g},shaderLanguage:this._shaderLanguage},n),s.setEffect(r,o)}if(!r.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(this._blurPostProcesses&&this._blurPostProcesses.length||this._initializeBlurRTTAndPostProcesses()),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady())&&(!(this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady())&&!(this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady()))}prepareDefines(e,t){const s=this._scene,i=this._light;s.shadowsEnabled&&i.shadowEnabled&&(e["SHADOW"+t]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=!0,this._filteringQuality===P.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===P.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=!0,this._filteringQuality===P.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===P.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=!0),i.needCube()&&(e["SHADOWCUBE"+t]=!0))}bindShadowLight(e,t){const s=this._light;if(!this._scene.shadowsEnabled||!s.shadowEnabled)return;const i=this._getCamera(),r=this.getShadowMap();if(!r)return;s.needCube()||t.setMatrix("lightMatrix"+e,this.getTransformMatrix());const a=this.getShadowMapForRendering();this._filter===P.FILTER_PCF?(t.setDepthStencilTexture("shadowTexture"+e,a),s._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),r.getSize().width,1/r.getSize().width,this.frustumEdgeFalloff,e)):this._filter===P.FILTER_PCSS?(t.setDepthStencilTexture("shadowTexture"+e,a),t.setTexture("depthTexture"+e,a),s._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/r.getSize().width,this._contactHardeningLightSizeUVRatio*r.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowTexture"+e,a),s._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/r.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),s._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(i),this.getLight().getDepthMinZ(i)+this.getLight().getDepthMaxZ(i),e)}get viewMatrix(){return this._viewMatrix}get projectionMatrix(){return this._projectionMatrix}getTransformMatrix(){const e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),i.Pq.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),1===Math.abs(i.Pq.Dot(this._lightDirection,i.Pq.Up()))&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),i.uq.LookAtLHToRef(t,t.add(this._lightDirection),i.Pq.Up(),this._viewMatrix);const e=this.getShadowMap();if(e){const t=e.renderList;t&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,t)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){const e=this._shadowMap;if(!e)return;const t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(const e of t)this._shadowMap.renderList.push(e)}else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){const e=this._light._shadowGenerators.entries();for(let t=e.next();!0!==t.done;t=e.next()){const[e,s]=t.value;s===this&&this._light._shadowGenerators.delete(e)}0===this._light._shadowGenerators.size&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){const e={},t=this.getShadowMap();if(!t)return e;if(e.className=this.getClassName(),e.lightId=this._light.id,e.cameraId=this._camera?.id,e.id=this.id,e.mapSize=t.getRenderSize(),e.forceBackFacesOnly=this.forceBackFacesOnly,e.darkness=this.getDarkness(),e.transparencyShadow=this._transparencyShadow,e.frustumEdgeFalloff=this.frustumEdgeFalloff,e.bias=this.bias,e.normalBias=this.normalBias,e.usePercentageCloserFiltering=this.usePercentageCloserFiltering,e.useContactHardeningShadow=this.useContactHardeningShadow,e.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,e.filteringQuality=this.filteringQuality,e.useExponentialShadowMap=this.useExponentialShadowMap,e.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,e.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.usePoissonSampling=this.usePoissonSampling,e.depthScale=this.depthScale,e.blurBoxOffset=this.blurBoxOffset,e.blurKernel=this.blurKernel,e.blurScale=this.blurScale,e.useKernelBlur=this.useKernelBlur,e.renderList=[],t.renderList)for(let s=0;s<t.renderList.length;s++){const i=t.renderList[s];e.renderList.push(i.id)}return e}static Parse(e,t,s){const i=t.getLightById(e.lightId),r=void 0!==e.cameraId?t.getCameraById(e.cameraId):null,a=s?s(e.mapSize,i,r):new P(e.mapSize,i,void 0,r),n=a.getShadowMap();for(let s=0;s<e.renderList.length;s++){const i=t.getMeshesById(e.renderList[s]);for(const e of i)n&&(n.renderList||(n.renderList=[]),n.renderList.push(e))}return void 0!==e.id&&(a.id=e.id),a.forceBackFacesOnly=!!e.forceBackFacesOnly,void 0!==e.darkness&&a.setDarkness(e.darkness),e.transparencyShadow&&a.setTransparencyShadow(!0),void 0!==e.frustumEdgeFalloff&&(a.frustumEdgeFalloff=e.frustumEdgeFalloff),void 0!==e.bias&&(a.bias=e.bias),void 0!==e.normalBias&&(a.normalBias=e.normalBias),e.usePercentageCloserFiltering?a.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?a.useContactHardeningShadow=!0:e.usePoissonSampling?a.usePoissonSampling=!0:e.useExponentialShadowMap?a.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?a.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?a.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?a.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?a.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(a.useBlurExponentialShadowMap=!0),void 0!==e.contactHardeningLightSizeUVRatio&&(a.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),void 0!==e.filteringQuality&&(a.filteringQuality=e.filteringQuality),e.depthScale&&(a.depthScale=e.depthScale),e.blurScale&&(a.blurScale=e.blurScale),e.blurBoxOffset&&(a.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(a.useKernelBlur=e.useKernelBlur),e.blurKernel&&(a.blurKernel=e.blurKernel),a}}P.CLASSNAME="ShadowGenerator",P.ForceGLSL=!1,P.FILTER_NONE=0,P.FILTER_EXPONENTIALSHADOWMAP=1,P.FILTER_POISSONSAMPLING=2,P.FILTER_BLUREXPONENTIALSHADOWMAP=3,P.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,P.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,P.FILTER_PCF=6,P.FILTER_PCSS=7,P.QUALITY_HIGH=0,P.QUALITY_MEDIUM=1,P.QUALITY_LOW=2,P.DEFAULT_ALPHA_CUTOFF=.5,P._SceneComponentInitialization=e=>{throw(0,E.n)("ShadowGeneratorSceneComponent")}}}]);