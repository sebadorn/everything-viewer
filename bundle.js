(()=>{"use strict";var e,t,n,i,a={},s={};function r(e){var t=s[e];if(void 0!==t)return t.exports;var n=s[e]={id:e,loaded:!1,exports:{}};return a[e].call(n.exports,n,n.exports,r),n.loaded=!0,n.exports}r.m=a,r.amdD=function(){throw new Error("define cannot be used indirect")},r.amdO={},r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,r.t=function(n,i){if(1&i&&(n=this(n)),8&i)return n;if("object"==typeof n&&n){if(4&i&&n.__esModule)return n;if(16&i&&"function"==typeof n.then)return n}var a=Object.create(null);r.r(a);var s={};e=e||[null,t({}),t([]),t(t)];for(var o=2&i&&n;"object"==typeof o&&!~e.indexOf(o);o=t(o))Object.getOwnPropertyNames(o).forEach((e=>s[e]=()=>n[e]));return s.default=()=>n,r.d(a,s),a},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,n)=>(r.f[n](e,t),t)),[])),r.u=e=>e+".bundle.js",r.miniCssF=e=>{},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n={},i="everything-viewer:",r.l=(e,t,a,s)=>{if(n[e])n[e].push(t);else{var o,l;if(void 0!==a)for(var c=document.getElementsByTagName("script"),d=0;d<c.length;d++){var u=c[d];if(u.getAttribute("src")==e||u.getAttribute("data-webpack")==i+a){o=u;break}}o||(l=!0,(o=document.createElement("script")).charset="utf-8",o.timeout=120,r.nc&&o.setAttribute("nonce",r.nc),o.setAttribute("data-webpack",i+a),o.src=e),n[e]=[t];var m=(t,i)=>{o.onerror=o.onload=null,clearTimeout(h);var a=n[e];if(delete n[e],o.parentNode&&o.parentNode.removeChild(o),a&&a.forEach((e=>e(i))),t)return t(i)},h=setTimeout(m.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=m.bind(null,o.onerror),o.onload=m.bind(null,o.onload),l&&document.head.appendChild(o)}},r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{var e;r.g.importScripts&&(e=r.g.location+"");var t=r.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");if(n.length)for(var i=n.length-1;i>-1&&(!e||!/^http(s?):/.test(e));)e=n[i--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e})(),(()=>{r.b=document.baseURI||self.location.href;var e={411:0};r.f.j=(t,n)=>{var i=r.o(e,t)?e[t]:void 0;if(0!==i)if(i)n.push(i[2]);else{var a=new Promise(((n,a)=>i=e[t]=[n,a]));n.push(i[2]=a);var s=r.p+r.u(t),o=new Error;r.l(s,(n=>{if(r.o(e,t)&&(0!==(i=e[t])&&(e[t]=void 0),i)){var a=n&&("load"===n.type?"missing":n.type),s=n&&n.target&&n.target.src;o.message="Loading chunk "+t+" failed.\n("+a+": "+s+")",o.name="ChunkLoadError",o.type=a,o.request=s,i[1](o)}}),"chunk-"+t,t)}};var t=(t,n)=>{var i,a,[s,o,l]=n,c=0;if(s.some((t=>0!==e[t]))){for(i in o)r.o(o,i)&&(r.m[i]=o[i]);if(l)l(r)}for(t&&t(n);c<s.length;c++)a=s[c],r.o(e,a)&&e[a]&&e[a][0](),e[a]=0},n=self.webpackChunkeverything_viewer=self.webpackChunkeverything_viewer||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();class o{constructor(e){this._events={},e.addEventListener("dragover",(e=>{e.preventDefault()})),e.addEventListener("drop",(e=>{e.preventDefault(),this._handleDropped(e.dataTransfer)}))}_handleDirectory(e){console.log("[DropHandler._handleDirectory] Directory dropped: "+e.name);const t=this._events.directory;Array.isArray(t)&&t.forEach((t=>t(e)))}_handleDropped(e){if(e.items){const t=e.items[0];if(t&&"file"===t.kind)if("function"==typeof t.webkitGetAsEntry){const e=t.webkitGetAsEntry();e.isFile?this._handleFile(t.getAsFile()):e.isDirectory&&this._handleDirectory(e)}else console.warn('[DropHandler._handleDropped] Method "webkitGetAsEntry" not supported by browser. Cannot support directories.'),this._handleFile(t.getAsFile())}else if(e.files){console.warn('[DropHandler._handleDropped] DataTransfer has no attribute "items", using fallback on "files".');const t=e.files[0];t&&this._handleFile(t)}else console.error('[DropHandler._handleDropped] DataTransfer has neither "items" nor "files" attribute.',e)}_handleFile(e){console.log("[DropHandler._handleFile] File dropped: "+e.name);const t=this._events.file;Array.isArray(t)&&t.forEach((t=>t(e)))}on(e,t){this._events[e]=this._events[e]||[],this._events[e].push(t)}}const l={extToMimeType(e){if(!e)return null;return{csv:"text/csv",ical:"text/calendar",ics:"text/calendar",ifb:"text/calendar",vcf:"text/vcard",vcs:"text/calendar"}[e=e.toLowerCase().trim()]||null},getFileExt:e=>e.name.split(".").pop().toLowerCase(),async getMimeType(e){const t=await e.slice(0,348).arrayBuffer(),n=new Uint8Array(t).reduce(((e,t)=>e+t.toString(16).padStart(2,"0")),""),i=e.type||this.extToMimeType(this.getFileExt(e));let a=this.headerToMimeType(n,i);return"string"==typeof a&&(a=a.toLowerCase()),a},headerToMimeType(e,t=null){let n=null,i=e.substring(0,8);switch(i){case"47494638":n="image/gif";break;case"89504e47":n="image/png";break;case"ffd8ffe0":case"ffd8ffe1":case"ffd8ffe2":case"ffd8ffe3":case"ffd8ffe8":n="image/jpeg"}return!n&&e.length>8&&("4449434d"===e.substring(256,264)?(i="4449434d",n="application/dicom"):"6e2b31"===e.substring(688,694)&&(i="6e2b3100",n="application/octet-stream")),n?console.log(`[FileHandler.headerToMimeType] "${i}" -> ${n}`):t?(n=t,console.log(`[FileHandler.headerToMimeType] Using "${n}" based on extension.`)):(i.startsWith("2321")?n="application/x-shellscript":i.startsWith("efbbbf")||i.startsWith("feff")||i.startsWith("fffe")||i.startsWith("0000feff")||i.startsWith("2b2f7638")||i.startsWith("2b2f7639")||i.startsWith("2b2f762b")||i.startsWith("2b2f762f")?n="text/plain":(i.startsWith("504b34")||i.startsWith("504b0304")||i.startsWith("504b0506"))&&(n="application/zip"),n&&console.log(`[FileHandler.headerToMimeType] Guessing "${i}" -> ${n}`)),n||console.log(`[FileHandler.headerToMimeType] Failed to find MIME type for header "${i}".`),n},isTypeText(e,t,n){if(e=String(e||""),t=String(t||""),n=String(n||""),e.startsWith("text/")||e.startsWith("message/"))return!0;if(["application/json","application/x-javascript","application/x-php","application/x-python","application/x-shellscript","application/x-yaml"].includes(e))return!0;if(["authors","changelog","contributors","copying","install","license","makefile","readme","todo"].includes(n))return!0;return!!["cfg","dart","frag","glsl","in","ini","less","proto","vert"].includes(t)||("bat"===t&&"application/x-msdos-program"===e||!!(n.length>1&&n.startsWith(".")))}};class c{constructor(e,t=!1){this.file=e.file||e.fileList,this.mimeType=e.mimeType,this.isDir=t}destroy(){}detectLanguage(){const e=l.getFileExt(this.file);if(["c","cc","cpp","cmake","css","scss","dart","diff","glsl","htm","html","ini","java","js","json","less","php","sh","tex","vb","xml","yaml","yml","zone"].includes(e))return e;const t={arb:"json",frag:"glsl",gitignore:"ini",h:"cpp",in:"cpp",jshintrc:"json",md:"markdown",py:"python",ts:"typescript",tsx:"typescript",vert:"glsl"};if(t[e])return t[e];const n={"application/x-shellscript":"sh"};if(n[this.mimeType])return n[this.mimeType];const i=this.file.name.toLowerCase();return".gitmodules"===i?"ini":"cmakelists.txt"===i?"cmake":"makefile"===i?"make":null}getArrayBuffer(e){this.file.arrayBuffer().then((t=>e(null,t))).catch((t=>{console.error(t),e(t,null)}))}getText(e){this.file.text().then((t=>e(null,t))).catch((t=>{console.error(t),e(t,null)}))}}class d{constructor(e,t="base"){this.parser=e,this.type=t,this.metaData=[{name:"Filename",value:this.parser.file.name},{name:"Type",value:this.parser.mimeType},{name:"Filesize",value:Z.formatSize(this.parser.file.size)}],this.nodeView=document.createElement("div"),this.nodeView.className="view view-"+this.type,this.nodeMeta=document.createElement("div"),this.nodeMeta.className="meta meta-"+this.type}_buildMetaDataRow(e){const t=document.createElement("tr");if(e.hr){const e=document.createElement("td");e.colSpan=2,t.classList.add("hr"),t.append(e)}else if("string"==typeof e.group){const n=document.createElement("caption");n.textContent=e.group;const i=document.createElement("table");i.classList.add("group-table"),i.append(n),e.items.forEach((e=>{i.append(this._buildMetaDataRow(e))}));const a=document.createElement("td");a.colSpan=2,a.append(i),t.classList.add("group"),t.append(a)}else{const n=e.name,i=e.value,a=document.createElement("th");a.className="name",a.textContent=n+": ";const s=document.createElement("td");s.className="value",s.textContent=i,t.classList.add("item"),t.append(a,s)}return t}buildMetaNode(e={}){if(0===Object.keys(this.metaData).length)return;if(this.nodeMeta&&(this.nodeMeta.querySelector(".meta-table")?.remove(),this.nodeMeta.querySelector(".option-toggle-empty")?.remove()),e.toggleForEmpty){const e=Z.build('<div class="option option-toggle-empty"><input type="checkbox" id="metadata-toggle-empty" value="1" /><label for="metadata-toggle-empty">Omit empty entries</label></div>'),t=e.querySelector("input");t.addEventListener("change",(e=>this.toggleEmptyMetaData(t.checked))),this.nodeMeta.append(e)}const t=document.createElement("table");t.className="meta-table",this.metaData.forEach((e=>{const n=this._buildMetaDataRow(e);t.append(n)})),this.nodeMeta.append(t)}destroy(){this.nodeView.remove(),this.nodeMeta.remove()}load(e){const t=document.createElement("p");t.className="note",t.textContent=`No parser found for file of type: "${this.parser.mimeType}"`,this.buildMetaNode(),this.nodeView.append(t),e()}mdAdd(e,t){this.metaData.push({name:e,value:t})}mdAddGroup(e,t){this.metaData.push({group:e,items:t})}mdHR(){this.metaData.push({hr:1})}toggleEmptyMetaData(e){if(e){const e=t=>{let n=0;const i=t.querySelectorAll(":scope > tr:not([hidden])");i.forEach(((e,t)=>{!e.classList.contains("hr")||0!==t&&t!==i.length-1||(e.setAttribute("hidden",""),n++)})),n>0&&e(t)},t=(t,n)=>{let i=!1;t.forEach((e=>{if(e.classList.contains("hr"))i&&e.setAttribute("hidden",""),i=!0;else{0===e.querySelector("td.value").innerHTML.length?e.setAttribute("hidden",""):i=!1}})),e(n)};this.nodeMeta.querySelectorAll(".meta-table .group-table").forEach((e=>{const n=e.querySelectorAll(":scope > tr.item");t(n,e)}));const n=this.nodeMeta.querySelectorAll(".meta-table > tr.item");t(n,this.nodeMeta)}else{this.nodeMeta.querySelectorAll("tr[hidden]").forEach((e=>e.removeAttribute("hidden")))}}}const u=0,m=1,h=50,p=100;class g{_importData=null;_parser=null;_view=null;canHandleImport(e){return m}getParser(){return this._parser??=new c(this._importData,!!this._importData?.dir),this._parser}getView(){return this._view??=new d(this.getParser()),this._view}reset(){this._parser?.destroy(),this._view?.destroy(),this._importData=null,this._parser=null,this._view=null}setImportData(e){this._importData=e}}class f extends d{constructor(e){super(e,"audio"),this._objectURL=null}destroy(){super.destroy(),this._objectURL&&URL.revokeObjectURL(this._objectURL)}load(e){this._objectURL=URL.createObjectURL(this.parser.file);const t=document.createElement("audio");if(t.setAttribute("controls",""),t.setAttribute("preload","metadata"),t.volume=.5,t.canPlayType(this.parser.mimeType))t.addEventListener("loadedmetadata",(()=>{this.mdAdd("Duration",Z.formatDuration(1e3*t.duration)),this.buildMetaNode(),this.nodeView.appendChild(t),e()})),t.src=this._objectURL;else{const t=document.createElement("p");t.className="note",t.textContent=`Playback for audio format not supported: "${this.parser.mimeType}"`,this.buildMetaNode(),this.nodeView.append(t),e()}}}class y extends g{canHandleImport(e){return e.mimeType?.startsWith("audio/")?h:u}getView(){return this._view??=new f(this.getParser()),this._view}}class _ extends c{constructor(e){super(e)}parse(e){this.getText((async(t,n)=>{const{parse:i}=await r.e(829).then(r.bind(r,304)),a=i(n);e(null,a)}))}}class v extends d{constructor(e){super(e,"csv")}_build(e){const t=document.createElement("table");for(let n=0;n<e.length;n++){const i=e[n],a=document.createElement("tr"),s=0===n?"th":"td";for(let e=0;e<i.length;e++){const t=document.createElement("span");t.textContent=i[e];const n=document.createElement(s);n.append(t),a.append(n)}t.append(a)}return t}load(e){this.parser.parse(((t,n)=>{this.mdAdd("Columns",n.length>0?n[0].length:0),this.mdAdd("Rows",n.length),this.buildMetaNode();const i=this._build(n);this.nodeView.append(i),e()}))}}class b extends g{canHandleImport(e){return"csv"===e.ext?p:u}getParser(){return this._parser??=new _(this._importData),this._parser}getView(){return this._view??=new v(this.getParser()),this._view}}class w extends c{constructor(e){super(e,!!e.dir),this.file=e.dir||e.file,e.fileList&&(this.entries=e.fileList)}_loadFromDicomdirFile(e,t){e.arrayBuffer().then((async e=>{const n=(await Promise.all([r.e(915),r.e(995)]).then(r.t.bind(r,5915,23))).parseDicom(new Uint8Array(e),{TransferSyntaxUID:"1.2.840.10008.1.2"}).elements.x00041220;n&&Array.isArray(n.items)?t(null,n):console.error("[DICOMParser._parseHandlerDir] Record is either not set or has no entries.",n)})).catch((e=>console.error(e)))}_parseHandlerDir(e){const t=this.entries,n=t.find((e=>e.isFile&&"dicomdir"===e.name.toLowerCase()));n?n.file((t=>this._loadFromDicomdirFile(t,e)),(t=>{console.error("[DICOMParser._parseHandlerDir]",t),e(t)})):e(null,t)}async addAndLoadFile(e){const t=this.wadouri.fileManager.add(e);return await this.wadouri.loadImage(t).promise}destroy(){try{this.cache.purgeCache(),this.wadouri.dataSetCacheManager.purge(),this.wadouri.fileManager.purge()}catch(e){console.error("[DICOMParser.destroy]",e)}}static getModalityName(e){if(!e)return e;e=String(e).toUpperCase();let t=w.MODALITY_MAP[e];return t&&(t+=` [${e}]`),t||e}static getPregnancyStatus(e){if(isNaN(Number(e)))return e;return["not pregnant","possibly pregnant","definitely pregnant","unknown"][(e=Number(e))+1]||e}getFilepathsFromRecord(e){const t=[];return e.items.forEach((e=>{let n=e.dataSet.string("x00041500");n&&(n=n.replace(/\\/g,"/"),t.push(n))})),t}loadDICOMDIRFiles(e,t){const n=[];if(Array.isArray(e)){const i=a=>{if(a>=e.length)return void t(null,n);e[a].file((async e=>{const t=await this.addAndLoadFile(e);n.push(t),i(a+1)}))};i(0)}else{const i=this.getFilepathsFromRecord(e),a=e=>{if(e>=i.length)return void t(null,n);const s=i[e];this.file.getFile(s,{},(t=>{t.file((async t=>{const i=await this.addAndLoadFile(t);n.push(i),a(e+1)}))}),(t=>{console.error(`[DICOMParser.loadDICOMDIRFiles] getFile "${s}": `+t.message),a(e+1)}))};a(0)}}async parse(e){const t=await Promise.all([r.e(960),r.e(178),r.e(483)]).then(r.bind(r,6178)),n=await Promise.all([r.e(612),r.e(960),r.e(915),r.e(320),r.e(146)]).then(r.bind(r,5320));if(t.init(),n.init(),this.cache=t.cache,this.wadouri=n.wadouri,this.isDir)this._parseHandlerDir(e);else if("dicomdir"===this.file.name.toLowerCase())this._loadFromDicomdirFile(this.file,((t,n)=>{const i=this.getFilepathsFromRecord(n);e(null,i)}));else{const t=await this.addAndLoadFile(this.file);e(null,t)}}}w.MODALITY_MAP={AR:"Autorefraction",AS:"Angioscopy",ASMT:"Content Assessment Results",AU:"Audio",BDUS:"Bone Densitometry (ultrasound)",BI:"Biomagnetic imaging",BMD:"Bone Densitometry (X-Ray)",CD:"Color flow Doppler",CF:"Cinefluorography",CP:"Colposcopy",CR:"Computed Radiography",CS:"Cystoscopy",CT:"Computed Tomography",DD:"Duplex Doppler",DF:"Digital fluoroscopy",DG:"Diaphanography",DM:"Digital microscopy",DOC:"Document",DS:"Digital Subtraction Angiography",DX:"Digital Radiography",EC:"Echocardiography",ECG:"Electrocardiography",EPS:"Cardiac Electrophysiology",ES:"Endoscopy",FA:"Fluorescein angiography",FID:"Fiducials",FS:"Fundoscopy",GM:"General Microscopy",HC:"Hard Copy",HD:"Hemodynamic Waveform",IO:"Intra-Oral Radiography",IOL:"Intraocular Lens Data",IVOCT:"Intravascular Optical Coherence Tomography",IVUS:"Intravascular Ultrasound",KER:"Keratometry",KO:"Key Object Selection",LEN:"Lensometry",LP:"Laparoscopy",LS:"Laser surface scan",MA:"Magnetic resonance angiography",MG:"Mammography",MR:"Magnetic Resonance",MS:"Magnetic resonance spectroscopy",NM:"Nuclear Medicine",OAM:"Ophthalmic Axial Measurements",OCT:"Optical Coherence Tomography (non-Ophthalmic)",OP:"Ophthalmic Photography",OPM:"Ophthalmic Mapping",OPR:"Ophthalmic Refraction",OPT:"Ophthalmic Tomography",OPV:"Ophthalmic Visual Field",OSS:"Optical Surface Scan",OT:"Other",PLAN:"Plan",PR:"Presentation State",PT:"Positron emission tomography (PET)",PX:"Panoramic X-Ray",REG:"Registration",RESP:"Respiratory Waveform",RF:"Radio Fluoroscopy",RG:"Radiographic imaging (conventional film/screen)",RTDOSE:"Radiotherapy Dose",RTIMAGE:"Radiotherapy Image",RTPLAN:"Radiotherapy Plan",RTRECORD:"RT Treatment Record",RTSTRUCT:"Radiotherapy Structure Set",RWV:"Real World Value Map",SEG:"Segmentation",SM:"Slide Microscopy",SMR:"Stereometric Relationship",SR:"SR Document",SRF:"Subjective Refraction",ST:"Single-photon emission computed tomography (SPECT)",STAIN:"Automated Slide Stainer",TG:"Thermography",US:"Ultrasound",VA:"Visual Acuity",VF:"Videofluorography",XA:"X-Ray Angiography",XC:"External-camera Photography"};class x{constructor(){this._events={}}fire(e,t){const n=this._events[e]||[];for(let e=0;e<n.length;e++){if(!1===(0,n[e])(t))break}}off(e,t){if(t){const n=this._events[e]||[],i=n.indexOf(t);i>-1&&n.splice(i,1)}else this._events[e]=[]}on(e,t){const n=this._events[e]||[];n.push(t),this._events[e]=n}removeAllEvents(){this._events={}}}class T extends x{constructor(){super(),this._node=null}render(){this._node&&this._node.remove()}}class D extends T{constructor(e){super(),this._config=e,"function"==typeof this._config.onClick&&this.on("click",this._config.onClick)}_updateNode(){if(!this._node)return;const e="string"==typeof this._config.icon,t="string"==typeof this._config.text;if(this._node.innerHTML="",this._node.className="",this._node.classList.add("btn"),"string"==typeof this._config.classes&&this._node.classList.add(...this._config.classes.split(" ")),e&&(this._node.innerHTML=`<span class="icon">${this._config.icon}</span>`),t){const e=Z.escapeHTML(this._config.text);this._node.innerHTML+=`<span class="text">${e}</span>`}e&&t||!0===this._config.iconWithBorder?(this._node.classList.add("btn-icon-text"),this._config.iconWithBorder&&this._node.classList.add("btn-icon-border")):e?this._node.classList.add("btn-icon"):t&&this._node.classList.add("btn-text"),"string"==typeof this._config.title?this._node.setAttribute("title",this._config.title):this._node.removeAttribute("title")}disable(){this._node?this._node.disabled=!0:window.Logger.warn("[Button.disable] Button has not been rendered yet.")}enable(){this._node?this._node.disabled=!1:window.Logger.warn("[Button.enable] Button has not been rendered yet.")}render(){return super.render(),this._node=document.createElement("button"),this._updateNode(),this._node.addEventListener("click",(e=>{this._node.disabled||this.fire("click",e)})),this._node}update(e){for(const t in e)this._config[t]=e[t];this._updateNode()}}class S extends d{constructor(e){super(e,"dicom"),this._frameDelay=250,this._frameIndex=0,this._frameTime=33.333,this._listenerKeyNav=null,this._timer=0}_addMetaInfo(e){this.mdAddGroup("Patient",[{name:"Patient ID",value:e.string("x00100020")},{name:"Issuer of Patient ID",value:e.string("x00100021")},{name:"Type of Patient ID",value:e.string("x00100022")},{hr:1},{name:"Patient Name",value:e.string("x00100010")},{name:"Other Patient Names",value:e.string("x00101001")},{name:"Patient Birth Date",value:e.string("x00100030")},{name:"Patient Birth Time",value:e.string("x00100032")},{name:"Patient Sex",value:e.string("x00100040")},{name:"Ethnic Group",value:e.string("x00102160")},{name:"Patient Breed Desc.",value:e.string("x00102292")},{name:"Patient Species Desc.",value:e.string("x00102201")},{name:"Patient Comments",value:e.string("x00104000")},{name:"Strain Desc.",value:e.string("x00100212")},{name:"Strain Nomenclature",value:e.string("x00100213")},{name:"Strain Addit. Info.",value:e.string("x00100218")},{hr:1},{name:"Responsible Person",value:e.string("x00102297")},{name:"Resp. Person Role",value:e.string("x00102298")},{name:"Resp. Organization",value:e.string("x00102299")}]),this.mdAddGroup("Patient Study",[{name:"Admitting Diagnoses Desc.",value:e.string("x00081080")},{name:"Patient's Age (years)",value:e.string("x00101010")},{name:"Patient's Size (m)",value:e.string("x00101020")},{name:"Patient's BMI",value:e.string("x00101022")},{name:"Measured AP Dimension (mm)",value:e.string("x00101023")},{name:"Measured Lateral Dimension (mm)",value:e.string("x00101024")},{name:"Patient's Weight (kg)",value:e.string("x00101030")},{name:"Medical Alerts",value:e.string("x00102000")},{name:"Allergies",value:e.string("x00102110")},{name:"Occupation",value:e.string("x00102180")},{name:"Smoking Status",value:e.string("x001021a0")},{name:"Addit. Patient History",value:e.string("x001021b0")},{name:"Pregnancy Status",value:w.getPregnancyStatus(e.string("x001021c0"))},{name:"Last Menstrual Date",value:e.string("x001021d0")},{name:"Patient's Sex Neutered",value:e.string("x00102203")},{name:"Reason for Visit",value:e.string("x00321066")},{name:"Admission ID",value:e.string("x00380010")},{name:"Service Episode ID",value:e.string("x00380060")},{name:"Service Episode Desc.",value:e.string("x00380062")},{name:"Patient State",value:e.string("x00380500")}]),this.mdAddGroup("General Study",[{name:"Study Date",value:e.string("x00080020")},{name:"Study Time",value:e.string("x00080030")},{name:"Accession Number",value:e.string("x00080050")},{name:"Referring Physician Name",value:e.string("x00080090")},{name:"Consulting Physician's Name",value:e.string("x0008109c")},{name:"Study Desc.",value:e.string("x00081030")},{name:"Physician(s) of Record",value:e.string("x00081048")},{name:"Physician(s) Reading Study",value:e.string("x00081060")},{name:"Study ID",value:e.string("x00200010")},{name:"Requesting Service",value:e.string("x00321033")}]),this.mdAddGroup("General Series",[{name:"Series Date",value:e.string("x00080021")},{name:"Series Time",value:e.string("x00080031")},{name:"Modality",value:w.getModalityName(e.string("x00080060"))},{name:"Series Desc.",value:e.string("x0008103e")},{name:"Performing Physician's Name",value:e.string("x00081050")},{name:"Operator's Name",value:e.string("x00081070")},{name:"Anatomical Orientation Type",value:e.string("x00102210")},{name:"Body Part Examined",value:e.string("x00180015")},{name:"Protocol Name",value:e.string("x00181030")},{name:"Patient Position",value:e.string("x00185100")},{name:"Series Number",value:e.string("x00200011")},{name:"Laterality",value:e.string("x00200060")},{name:"Performed Procedure Step Desc.",value:e.string("x00400254")},{name:"Comments on the Procedure Step",value:e.string("x00400280")}]),this.mdAddGroup("General Image",[{name:"Image Type",value:e.string("x00080008")},{name:"Patient Orientation",value:e.string("x00200020")},{name:"Image Laterality",value:e.string("x00200062")},{name:"Image Comments",value:e.string("x00204000")}]),this.mdAddGroup("General Equipment",[{name:"Manufacturer",value:e.string("x00080070")},{name:"Institution Name",value:e.string("x00080080")},{name:"Institution Address",value:e.string("x00080081")},{name:"Station Name",value:e.string("x00081010")},{name:"Institutional Department Name",value:e.string("x00081040")},{name:"Manufacturer's Model Name",value:e.string("x00081090")},{name:"Device Serial Number",value:e.string("x00181000")},{name:"Device UID",value:e.string("x00181002")},{name:"Gantry ID",value:e.string("x00181008")},{name:"Software Versions",value:e.string("x00181020")},{name:"Spatial Resolution",value:e.string("x00181050")},{name:"Date of Last Calibration",value:e.string("x00181200")},{name:"Time of Last Calibration",value:e.string("x00181201")}])}_buildControls(){const e=Z.build(`\n\t\t\t<div class="image-container"></div>\n\t\t\t<div class="actions">\n\t\t\t\t<input type="range" min="1" max="${this._numFrames}" value="1" />\n\t\t\t\t<div class="line">\n\t\t\t\t\t<div class="wrap wrap-frame-controls"></div>\n\t\t\t\t\t<div class="wrap wrap-playback">\n\t\t\t\t\t\t<select class="speed">\n\t\t\t\t\t\t\t<option value="${this._frameTime}">Default: ${this._frameTime} ms</option>\n\t\t\t\t\t\t\t<option value="16.7">16.7 ms</option>\n\t\t\t\t\t\t\t<option value="33.3">33.3 ms</option>\n\t\t\t\t\t\t\t<option value="66.7">66.7 ms</option>\n\t\t\t\t\t\t\t<option value="133.3">133.3 ms</option>\n\t\t\t\t\t\t</select>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`),t=new D({classes:"frame-prev",text:"←"}),n=new D({classes:"frame-next",text:"→"}),i=new D({classes:"play-pause",text:"▶"});if(e.querySelector(".wrap-frame-controls").append(t.render(),Z.build('<span class="counter"></span>'),n.render()),e.querySelector(".wrap-playback").append(i.render()),this._frameIndex=0,this._numFrames<=2)e.querySelector(".actions").remove();else{const a=e.querySelector('input[type="range"]');a.addEventListener("change",(e=>{this._frameIndex=e.target.valueAsNumber-1,this._controlGoto(this._frameIndex)})),t.on("click",(e=>{this._controlGoto(--this._frameIndex),a.value=this._frameIndex+1})),n.on("click",(e=>{this._controlGoto(++this._frameIndex),a.value=this._frameIndex+1}));const s=e.querySelector("select.speed");s.addEventListener("change",(e=>{this._frameTime=Number(s.value)})),i.on("click",(e=>{this._timer?(i.update({text:"▶"}),clearTimeout(this._timer),this._timer=0):(i.update({text:"⏸"}),this._playback(a))})),this._listenerKeyNav=e=>{const t=document.activeElement;t&&"range"===t.type||("ArrowLeft"===e.key?(this._controlGoto(--this._frameIndex),a.value=this._frameIndex+1):"ArrowRight"===e.key&&(this._controlGoto(++this._frameIndex),a.value=this._frameIndex+1))},document.body.addEventListener("keyup",this._listenerKeyNav),this._counter=e.querySelector(".counter")}this.nodeView.append(e)}_buildDICOMDIRFileList(e){const t=document.createElement("ol");e.forEach((e=>{const n=document.createElement("li");n.textContent=e,t.append(n)}));const n=document.createElement("wrap");n.className="dicomdir-list",n.append(t),this.nodeView.append(n)}_controlGoto(e){this._frameIndex=this.showImage(e),this._counter&&(this._counter.textContent=this._frameIndex+1+"/"+this._numFrames)}async _initViewport(){const{RenderingEngine:e}=await Promise.all([r.e(960),r.e(178),r.e(483)]).then(r.bind(r,6178)),{OrientationAxis:t,ViewportType:n}=await r.e(136).then(r.bind(r,3286)),i=this.nodeView.querySelector(".image-container");this._renderingEnginge=new e,this._renderingEnginge.enableElement({viewportId:"ctStack",type:n.STACK,element:i,defaultOptions:{orientation:t.AXIAL}}),this._viewport=this._renderingEnginge.getViewport("ctStack")}_playback(e){if(this._timer)return;const t=0===this._frameIndex?this._frameDelay:0;this._timer=setTimeout((()=>{this._controlGoto(++this._frameIndex),e.value=this._frameIndex+1,this._timer=0,this._playback(e)}),this._frameTime+t)}destroy(){super.destroy(),clearTimeout(this._timer),this.parser.destroy(),this._images=null,this._imageId=null,document.body.removeEventListener("keyup",this._listenerKeyNav)}load(e){this.parser.parse((async(t,n)=>{if(!t)if(this.parser.isDir)this.parser.loadDICOMDIRFiles(n,(async(t,n)=>{this._images=n,this._numFrames=this._images.length,this._buildControls(),e(),await this._initViewport(),this._viewport.setStack(this._images.map((e=>e.imageId))),this.showFile(0),this._controlGoto(0)}));else if(Array.isArray(n))this._buildDICOMDIRFileList(n),this.buildMetaNode(),e();else{const t=n.data;this._numFrames=Number(t.string("x00280008")||1),this._frameDelay=Number(t.string("x00181033")||this._frameDelay),this._frameTime=Number(t.string("x00181063")||this._frameTime),this._addMetaInfo(t),this.buildMetaNode({toggleForEmpty:!0}),this._buildControls(),e(),this._imageId=n.imageId,await this._initViewport();let i=[];for(let e=0;e<this._numFrames;e++){let t=e>0?this._imageId+"?frame="+e:this._imageId;i.push(t)}this._viewport.setStack(i),this._controlGoto(0)}}))}showFile(e){e>=this._images.length?e=0:e<0&&(e=this._images.length-1);const t=this._images[e],n=t.data;return this._frameDelay=Number(n.string("x00181033")||this._frameDelay),this._frameTime=Number(n.string("x00181063")||this._frameTime),this._addMetaInfo(n),this.buildMetaNode({toggleForEmpty:!0}),this._imageId=t.imageId,e}showImage(e){return e>=this._numFrames?e=0:e<0&&(e=this._numFrames-1),this._viewport.setImageIdIndex(e),e}}class E extends g{canHandleImport(e){return"application/dicom"===e.mimeType?p:u}getParser(){return this._parser??=new w(this._importData),this._parser}getView(){return this._view??=new S(this.getParser()),this._view}static containsDICOMDIRFile(e){return!!e.find((e=>e.isFile&&"dicomdir"===e.name.toLowerCase()))}static async containsDICOMFiles(e){let t=0;for(let n=0;n<e.length;n++){const i=e[n];if(await this.isDICOMFile(i)&&(t++,t>1))return!0}return!1}static isDICOMFile(e){return e?.isFile?e.name.toLocaleLowerCase().endsWith(".dcm")?new Promise(((e,t)=>e(!0))):new Promise(((t,n)=>{e.file((async e=>{const n=await l.getMimeType(e);t("application/dicom"===n)}),(e=>{console.error("[DICOMPlugin.isDICOMFile]",e),t(!1)}))})):new Promise(((e,t)=>e(!1)))}}class M extends c{constructor(e){super(e),this._domParser=new DOMParser,this._lastParsed=null}_decodeContent(e){return e=(e=e.replaceAll(/=[\r]?\n/g,"")).replaceAll(/(=[0-9A-Z]{2})+/g,(e=>{try{return decodeURIComponent(e.replaceAll("=","%"))}catch(t){return console.error(t,e),e}}))}_removeExternal(e){e.querySelectorAll("img").forEach((e=>{(e.getAttribute("src")||"").startsWith("data:")||e.removeAttribute("src")}));e.querySelectorAll(["audio[src]","embed","iframe",'link[rel="stylesheet"]',"object","script","source","video[src]"].join(",")).forEach((e=>e.remove()));e.querySelectorAll("[background]").forEach((e=>{(e.getAttribute("background")||"").includes("//")&&e.removeAttribute("background")}));e.querySelectorAll("style").forEach((e=>{let t=e.textContent;t=t.replaceAll(/url[ \t]*\([ \t]*.+[ \t]*\)/gi,"url()"),e.textContent=t}))}buildBodyDOM(e){return this._domParser.parseFromString(e,"text/html")}buildHeadersHTML(e){const t=document.createElement("table");e.forEach((e=>{const n=document.createElement("th");n.className="header-name",n.textContent=e.name;const i=document.createElement("td");i.className="header-value",i.textContent=e.value;const a=document.createElement("tr");a.append(n,i),t.append(a)}));const n=document.createElement("div");return n.className="headers",n.append(t),n}buildPlainTextDOM(e){return this._domParser.parseFromString(`<pre>${e}</pre>`,"text/html")}getBodyDOM(e,t){if(e||(e={}),"boolean"!=typeof e.remove_external&&(e.remove_external=!0),this._lastParsed){let n=this._decodeContent(this._lastParsed.body),i=null,a=this.getHeader(this._lastParsed.headers,"content-type")||"";a=a.toLowerCase();let s="plaintext";a.startsWith("text/html")?(i=this.buildBodyDOM(n,e),s="html"):i=this.buildPlainTextDOM(n),i&&e.remove_external&&this._removeExternal(i),t(null,i,s)}else this.getText(((n,i)=>{this.parse(i),this._lastParsed?this.getBodyDOM(e,t):t(new Error("Failed to parse"),null,null)}))}getHeader(e,t){e=e||{};for(const n of e)if(n.name.toLowerCase()===t)return n.value;return null}getHeadersHTML(e){if(this._lastParsed){const t=this.buildHeadersHTML(this._lastParsed.headers);e(null,t)}else this.getText(((t,n)=>{const i=this.parse(n),a=this.buildHeadersHTML(i.headers);e(null,a)}))}parse(e){this._lastParsed=null;let t=(e=e.trimStart()).split("\r\n\r\n");if(2!==t.length&&(t=e.split("\n\n")),t.length<2)return null;const n=t.splice(0,1)[0].trim(),i={headers:[],body:t.join("\n\n")};let a=null,s=null,r=!0,o=n.split("\r\n");1===o.length&&(o=n.split("\n"));for(const e of o)if(e.startsWith(" ")||e.startsWith("\t")?(s+=e.trimStart(),r=!1):a&&(i.headers.push({name:a,value:s}),r=!0),r){const t=e.split(": ");a=t[0],s=t.slice(1).join(": ")}return a&&i.headers.push({name:a,value:s}),this._lastParsed=i,i}}class A extends T{constructor(e){super(),this._buttons=e}_toggle(e){this._buttons.forEach((e=>e._node.classList.remove("selected"))),e._node.classList.add("selected")}render(){super.render(),this._node=Z.build('<div class="button-group"></div>');for(let e=0;e<this._buttons.length;e++){const t=this._buttons[e];t.on("click",(()=>this._toggle(t))),this._node.append(t.render())}return this._node}}class L extends d{constructor(e){super(e,"eml")}_buildActions(){return new A([new D({text:"Show Headers",onClick:()=>{this.nodeView.querySelector("iframe.content-res ")?.remove();this.nodeView.querySelector("iframe.content-no-res").style.display="none";this.nodeView.querySelector(".headers").style.display=""}}),new D({text:"Content (no external)",classes:"selected",onClick:()=>{this.nodeView.querySelector("iframe.content-res ")?.remove();this.nodeView.querySelector("iframe.content-no-res").style.display="";this.nodeView.querySelector(".headers").style.display="none"}}),new D({text:"Content (with external)",onClick:()=>{if(!window.confirm("Show the content and load its external resources?\nThis could pose a security risk.\n\nOnly agree if you trust the EML file."))return!1;this.nodeView.querySelector("iframe.content-res ")?.remove();this.nodeView.querySelector("iframe.content-no-res").style.display="none";this.nodeView.querySelector(".headers").style.display="none",this.parser.getBodyDOM({remove_external:!1},((e,t,n)=>{const i=document.createElement("iframe");i.className=`content-res eml-type-${n}`,i.setAttribute("sandbox",""),i.setAttribute("srcdoc",t.documentElement.outerHTML),this.nodeView.append(i)}))}})]).render()}load(e){const t=document.createElement("iframe");t.className="content-no-res",t.setAttribute("sandbox",""),this.parser.getBodyDOM({remove_external:!0},((n,i,a)=>{this.parser.getHeadersHTML(((n,s)=>{this.buildMetaNode();const r=this._buildActions();s.style.display="none",t.classList.add(`eml-type-${a}`),t.setAttribute("srcdoc",i.documentElement.outerHTML),this.nodeView.append(r,s,t),e()}))}))}}class C extends g{canHandleImport(e){return"eml"===e.ext?p:u}getParser(){return this._parser??=new M(this._importData),this._parser}getView(){return this._view??=new L(this.getParser()),this._view}}class P extends c{constructor(e){super(e)}parse(e){this.getArrayBuffer((async(t,n)=>{const{GifReader:i}=await r.e(900).then(r.t.bind(r,4399,19));let a=null;try{a=new i(new Uint8Array(n))}catch(t){return console.error(t),void e(t,null)}e(null,a)}))}}class I extends d{constructor(e){super(e,"gif"),this._currentCanvas=null,this._frameIndex=0,this._frames=[],this._gifReader=null,this._listenerKeyNav=null}_buildSlideshow(e){const t=this._gifReader.numFrames(),n=Z.build(`\n\t\t\t<div class="frame-container"></div>\n\t\t\t<div class="actions">\n\t\t\t\t<input type="range" min="1" max="${t}" value="1" />\n\t\t\t\t<div class="line">\n\t\t\t\t\t<button class="frame-prev">&larr;</button>\n\t\t\t\t\t<span class="counter"></span>\n\t\t\t\t\t<button class="frame-next">&rarr;</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`);this._frameIndex=0,this._generateFrames((()=>{const t=n.querySelector('input[type="range"]');t.addEventListener("change",(e=>{this._frameIndex=e.target.valueAsNumber-1,this.showFrame(this._frameIndex)}));n.querySelector("button.frame-prev").addEventListener("click",(e=>{this.showFrame(--this._frameIndex),t.value=this._frameIndex+1}));n.querySelector("button.frame-next").addEventListener("click",(e=>{this.showFrame(++this._frameIndex),t.value=this._frameIndex+1})),this._listenerKeyNav=e=>{const n=document.activeElement;n&&"range"===n.type||("ArrowLeft"===e.key?(this.showFrame(--this._frameIndex),t.value=this._frameIndex+1):"ArrowRight"===e.key&&(this.showFrame(++this._frameIndex),t.value=this._frameIndex+1))},document.body.addEventListener("keyup",this._listenerKeyNav),this._counter=n.querySelector(".counter"),e(n)}))}_generateFrame(e,t){const n=this._gifReader.width,i=this._gifReader.height,a=document.createElement("canvas");a.width=n,a.height=i,a.style.width=n+"px",a.style.height=i+"px";const s=a.getContext("2d");if(0===e){const r=new ImageData(n,i);return this._lastNonDisposedImgData=r,this._gifReader.decodeAndBlitFrameRGBA(e,r.data),s.putImageData(r,0,0),void t(a)}const r=this._gifReader.frameInfo(e-1);let o=null;if(r.disposal<=1||3===r.disposal){const e=Uint8ClampedArray.from(this._lastNonDisposedImgData.data);o=new ImageData(e,n,i)}else o=new ImageData(n,i);this._gifReader.decodeAndBlitFrameRGBA(e,o.data);this._gifReader.frameInfo(e).disposal<=1&&(this._lastNonDisposedImgData=o),s.putImageData(o,0,0),t(a)}_generateFrames(e){const t=this._gifReader.numFrames(),n=i=>{i>=t?e():this._generateFrame(i,(e=>{this._frames.push(e),n(i+1)}))};n(0)}destroy(){super.destroy(),document.body.removeEventListener("keyup",this._listenerKeyNav)}load(e){this.parser.parse(((t,n)=>{this._gifReader=n,this.mdAdd("Dimensions",n.width+"×"+n.height+" px"),this.mdAdd("Frames",n.numFrames()),this.buildMetaNode(),this._buildSlideshow((t=>{this.nodeView.append(t),this.showFrame(this._frameIndex),e()}))}))}showFrame(e){const t=this._gifReader.numFrames();e>=t?e=0:e<0&&(e=t-1),this._currentCanvas&&this._currentCanvas.remove(),this._frameIndex=e,this._currentCanvas=this._frames[e];this.nodeView.querySelector(".frame-container").append(this._currentCanvas),this._counter.textContent=e+1+"/"+t}}class R extends g{canHandleImport(e){return"image/gif"===e.mimeType?p:u}getParser(){return this._parser??=new P(this._importData),this._parser}getView(){return this._view??=new I(this.getParser()),this._view}}class N extends c{constructor(e,t){super(e,t)}_buildHTMLComponent(e){const t=document.createElement("div");t.className="container";const n=document.createElement("table"),i=e.summary||"(no summary)",a=document.createElement("h2");a.className="summary",a.textContent=i,e.color&&(a.style.backgroundColor=e.color);const s=this._getParameterValue(e,"status");if(s){const e=document.createElement("span");e.className="state",e.textContent=s,a.append(e)}const r=this._getParameterValue(e,"class");if(r){const e=document.createElement("span");e.className="state",e.textContent=r,a.append(e)}if(t.append(a),e.description){const n=document.createElement("div");n.className="description",n.innerHTML=e.description.replaceAll(/\n/g,"<br>"),t.append(n)}if(e.startDate){const t=this._buildHTMLTableRowTime("Start",e.startDate);if(n.append(t),e.endDate){const t=this._buildHTMLTableRowTime("End",e.endDate);n.append(t)}if(e.duration){const t=1e3*e.duration.toSeconds(),i=Z.buildTableRow("Duration",Z.formatDuration(t));n.append(i)}}const o=e.component.jCal[1].filter((e=>"freebusy"===e[0]));o.length>0&&o.forEach((e=>{const t=e[3],i=ICAL.Time.fromDateTimeString(t[0]),a=this._buildTimeSelect(i);let s=null,r="";if(t[1].length>=16){const e=ICAL.Time.fromDateTimeString(t[1]);s=this._buildTimeSelect(e),r=" – "}else s=t[1],r=" / ";const o=Z.buildTableRow("Period",""),l=o.querySelector("td");l.innerHTML="",l.append(a,r,s),n.append(o)}));const l=this._getParameterValue(e,"due");if(l){const e=ICAL.Time.fromDateTimeString(l),t=this._buildHTMLTableRowTime("Due",e);n.append(t)}if(e.location){const t=Z.buildTableRow("Location",e.location);t.className="location",n.append(t)}if(e.organizer){const t=e.component.jCal[1].find((e=>"organizer"===e[0]));let i=t?.[1]?.cn||e.organizer.replace(/^mailto:/,"");const a=Z.buildTableRow("Organizer",i);if(a.className="organizer",e.organizer.startsWith("mailto:")){const t=document.createElement("a");t.href=e.organizer,t.textContent=i;const n=a.querySelector("td");n.innerHTML="",n.append(t)}n.append(a)}if(Array.isArray(e.attendees)&&e.attendees.length>0){const t=Z.buildTableRow("Attendees","");t.className="attendees";const i=document.createElement("ul");e.attendees.forEach((e=>{const t=document.createElement("a");t.href=e.getFirstValue(),t.textContent=e.getParameter("cn")||t.href.replace(/^mailto:/,"");const n=document.createElement("li");if(n.append(t),e.getParameter("partstat")){const t=document.createElement("span");t.className="state",t.textContent=e.getParameter("partstat"),n.append(t)}i.append(n)}));t.querySelector("td").append(i),n.append(t)}const c=this._getParameterValue(e,"comment");if(c){const e=Z.buildTableRow("Comment",c);n.append(e)}const d=this._getParameterValue(e,"url");if(d){const e=Z.buildTableRow("URL",d),t=document.createElement("a");t.href=d,t.textContent=d;const i=e.querySelector("td");i.innerHTML="",i.append(t),n.append(e)}t.append(n);const u=this._buildHTMLVAlarms(e);return u&&t.append(u),t}_buildHTMLTableRowTime(e,t){const n=this._buildTimeSelect(t),i=Z.buildTableRow(e,"");return i.className=e.toLowerCase(),i.querySelector("td").append(n),i}_buildHTMLVAlarm(e){if(!Array.isArray(e))return null;const t=document.createElement("div");t.className="valarm";const n=e.find((e=>"description"===e[0]));if(n&&n[3]){const e=document.createElement("div");e.className="alarm-description",e.textContent=n[3],t.append(e)}const i=document.createElement("table"),a=e.find((e=>"trigger"===e[0]));if(a&&a[3]){const e=Z.buildTableRow("Trigger",a[3]);i.append(e)}const s=e.find((e=>"duration"===e[0]));if(s&&s[3]){const e=Z.buildTableRow("Duration",s[3]);i.append(e)}const r=e.find((e=>"repeat"===e[0]));if(r&&r[3]){const e=Z.buildTableRow("Repeat",r[3]);i.append(e)}const o=e.find((e=>"action"===e[0]));if(o&&o[3]){const e=Z.buildTableRow("Action",o[3]);i.append(e)}const l=e.find((e=>"attach"===e[0]));if(l&&l[3]){const e=Z.buildTableRow("Attach",l[3]);i.append(e)}return t.append(i),t}_buildHTMLVAlarms(e){const t=e.component.jCal[2];if(!Array.isArray(t))return null;const n=t.filter((e=>"valarm"===e[0]));if(0===n.length)return null;const i=document.createElement("div");return i.className="valarms",n.forEach((e=>{const t=this._buildHTMLVAlarm(e[1]);t&&i.append(t)})),i}_buildTimeSelect(e){const t={UTC:Z.formatDateTime(e.toJSDate()),ICAL:e.toString(),Unix:e.toUnixTime()};e.timezone&&(t.ICAL+=` (${e.timezone})`);const n=document.createElement("select");for(const e in t){const i=t[e],a=document.createElement("option");a.value=e,a.textContent=i+` [${e}]`,n.append(a)}return n}_getParameterValue(e,t){const n=e.component.jCal;if(!Array.isArray(n)||!Array.isArray(n[1]))return null;const i=n[1].find((e=>e[0]===t));return Array.isArray(i)?i[3]:null}build(e){const t=document.createElement("div");t.className="ical";const n=new this.ICAL.Component(e),i=n.getAllSubcomponents("vevent"),a=n.getAllSubcomponents("vtodo"),s=n.getAllSubcomponents("vjournal"),r=n.getAllSubcomponents("vfreebusy");return i.concat(a).concat(s).concat(r).forEach((e=>{const n=new this.ICAL.Event(e),i=this._buildHTMLComponent(n);i.className+=" "+e.jCal[0],t.append(i)})),t}getHTML(e){this.getText(((t,n)=>{this.parse(n,(t=>{const n=this.build(t);e(null,n)}))}))}parse(e,t){r.e(859).then(r.bind(r,8202)).then((n=>{this.ICAL=n.default;const i=this.ICAL.parse(e);t(i)}))}}class F extends d{constructor(e){super(e,"ical")}load(e){this.parser.getHTML(((t,n)=>{this.buildMetaNode(),this.nodeView.append(n),e()}))}}class O extends g{canHandleImport(e){return"text/calendar"===e.mimeType||["ical","ics","ifb","vcs"].includes(e.ext)?p:u}getParser(){return this._parser??=new N(this._importData),this._parser}getView(){return this._view??=new F(this.getParser()),this._view}}class H extends d{constructor(e){super(e,"image"),this._objectURL=null}destroy(){super.destroy(),this._objectURL&&URL.revokeObjectURL(this._objectURL)}load(e){const t=new Image;t.onload=()=>{t.height=t.naturalHeight,t.width=t.naturalWidth,this.mdAdd("Dimensions",t.naturalWidth+"×"+t.naturalHeight+" px"),this.buildMetaNode(),this.nodeView.append(t),e()},t.onerror=()=>{const t=document.createElement("p");t.className="note",t.textContent=`Image format not supported: "${this.parser.mimeType}"`,this.buildMetaNode(),this.nodeView.append(t),e()},this._objectURL=URL.createObjectURL(this.parser.file),t.src=this._objectURL}}class k extends g{canHandleImport(e){return e.mimeType?.startsWith("image/")?h:u}getView(){return this._view??=new H(this.getParser()),this._view}}class j extends d{constructor(e){super(e,"pdf"),this._objectURL=null}destroy(){super.destroy(),this._objectURL&&URL.revokeObjectURL(this._objectURL)}load(e){this._objectURL=URL.createObjectURL(this.parser.file);const t=document.createElement("iframe");t.src=this._objectURL,this.buildMetaNode(),this.nodeView.appendChild(t),e()}}class V extends g{canHandleImport(e){return"application/pdf"===e.mimeType?p:u}getView(){return this._view??=new j(this.getParser()),this._view}}class U extends d{constructor(e){super(e,"text")}static async initHljs(){if(U.hljs)return U.hljs;U.hljs=(await r.e(755).then(r.bind(r,11))).default;const e={bash:await r.e(140).then(r.bind(r,9510)),cmake:await r.e(383).then(r.bind(r,7237)),diff:await r.e(255).then(r.bind(r,6551)),dns:await r.e(659).then(r.bind(r,3561)),ini:await r.e(720).then(r.bind(r,6e3)),javascript:await r.e(527).then(r.bind(r,5603)),json:await r.e(792).then(r.bind(r,7402)),makefile:await r.e(974).then(r.bind(r,3308)),markdown:await r.e(617).then(r.bind(r,3265)),powershell:await r.e(265).then(r.bind(r,1569)),typescript:await r.e(311).then(r.bind(r,5387)),xml:await r.e(529).then(r.bind(r,9359)),yaml:await r.e(95).then(r.bind(r,6347))};for(const t in e){const n=e[t].default;U.hljs.registerLanguage(t,n)}return U.hljs}load(e){const t=document.createElement("div");t.className="code",this.nodeView.appendChild(t),this.parser.getText((async(n,i)=>{t.textContent=i;const a=this.parser.detectLanguage();if(a){const e=await U.initHljs();t.className+=" language-"+a,e.highlightElement(t)}this.mdAdd("Lines",(i.match(/\n/g)||[]).length),this.buildMetaNode(),e()}))}}class q extends g{canHandleImport(e){return l.isTypeText(e.mimeType,e.ext,e.file.name.toLowerCase())?h:u}getView(){return this._view??=new U(this.getParser()),this._view}}class B extends c{constructor(e,t){super(e,t)}_getTypes(e){if(!Array.isArray(e.type)||0===e.type.length)return null;let t=e.type.find((e=>e.startsWith("TYPE#")));return t?(t=t.substring(5),t.split(",")):e.type}build(e,t){const n=document.createElement("div");n.className="vcard";const i=document.createElement("h3");if(i.className="name",i.textContent=e.fn,n.append(i),e.title){const t=document.createElement("h4");t.className="title",t.textContent=e.title.join(", "),n.append(t)}const a=document.createElement("table");if(e.n["honorific-prefix"]){const t=e.n["honorific-prefix"].join(" "),n=Z.buildTableRow("Name prefix",t);a.append(n)}if(e.n["given-name"]){const t=e.n["given-name"].join(" "),n=Z.buildTableRow("Given name",t);a.append(n)}if(e.n["family-name"]){const t=e.n["family-name"].join(" "),n=Z.buildTableRow("Family name",t);a.append(n)}if(e.photo){const n=Z.buildTableRow("Photo",e.photo),i=t.match(/\nPHOTO.+[\r]?\n/);let s=null;if(i){let e=i[0];if(e.startsWith("PHOTO:data:")&&e.includes("base64"))s=e.substring(11,e.indexOf(";base64"));else if(e.includes("ENCODING=b")){const t=e.match(/;TYPE=([a-z0-9\/]+)[;:]/i);t&&t.length>=2&&(s=t[0])}else if(e.includes("ENCODING=BASE64")){const t=e.match(/;([a-z0-9\/]+)[;:]/i);t&&t.length>=2&&(s=t[0])}s&&(s=s.toLowerCase(),s.startsWith("image/")||(s="image/"+s))}if(s){n.querySelector("td").innerHTML=`<img src="data:${s};base64,${e.photo}" />`}else if(e.photo.includes("://")){n.querySelector("td").innerHTML=`<a href="${e.photo}">${e.photo}</a>`}a.append(n)}if(e.adr){const t=e=>{let t="Adr.";const n=this._getTypes(e);n&&(t+=` (${n.join(", ")})`);let i=e.value.split(";").filter((e=>e.length>0)).map((e=>e+"<br>")).join("");const s=Z.buildTableRow(t,i,{valueAsHTML:!0});a.append(s)};Array.isArray(e.adr)?e.adr.forEach((e=>t(e))):t(e.adr)}return e.org&&e.org.forEach((e=>{let t=e["organization-name"];e["organization-unit"]&&(t+=", "+e["organization-unit"]);const n=Z.buildTableRow("Organization",t);a.append(n)})),e.email&&e.email.forEach((e=>{let t="Email";const n=this._getTypes(e);n&&(t+=` (${n.join(", ")})`);const i=Z.buildTableRow(t,e.value);if(e.value.includes("@")){i.querySelector("td").innerHTML=`<a href="mailto:${e.value}">${e.value}</a>`}a.append(i)})),e.tel&&e.tel.forEach((e=>{let t="Tel.";const n=this._getTypes(e);n&&(t+=` (${n.join(", ")})`);const i=Z.buildTableRow(t,e.value);if(e.value.startsWith("tel:")){const t=e.value.substring(4),n=e.value.replaceAll(/-/g,"");i.querySelector("td").innerHTML=`<a href="${n}">${t}</a>`}a.append(i)})),n.append(a),n}getHTML(e){this.getText(((t,n)=>{const i=(n.match(/BEGIN:VCARD[\r]?\n/g)||[]).length;let a=0;const s=document.createElement("div");s.className="container",this.parse(n,(t=>{a++;const r=this.build(t,n);s.append(r),a===i&&e(null,s)}))}))}parse(e,t){r.e(776).then(r.t.bind(r,7534,23)).then((n=>{n.VCF.parse(e,t)}))}}class G extends d{constructor(e){super(e,"vcf")}load(e){this.parser.getHTML(((t,n)=>{this.buildMetaNode(),this.nodeView.append(n),e()}))}}class $ extends g{canHandleImport(e){return"vcf"===e.ext||"text/vcard"===e.mimeType?p:u}getParser(){return this._parser??=new B(this._importData),this._parser}getView(){return this._view??=new G(this.getParser()),this._view}}class z extends d{constructor(e){super(e,"video"),this._objectURL=null}destroy(){super.destroy(),this._objectURL&&URL.revokeObjectURL(this._objectURL)}load(e){this._objectURL=URL.createObjectURL(this.parser.file);const t=document.createElement("video");if(t.setAttribute("controls",""),t.setAttribute("preload","metadata"),t.volume=.25,t.canPlayType(this.parser.mimeType))t.addEventListener("loadedmetadata",(()=>{t.videoHeight&&(t.height=t.videoHeight),t.width=t.videoWidth||900,this.mdAdd("Dimensions",t.width+"×"+t.height+" px"),this.mdAdd("Duration",Z.formatDuration(1e3*t.duration)),this.buildMetaNode(),this.nodeView.append(t),e()})),t.src=this._objectURL;else{const t=document.createElement("p");t.className="note",t.textContent=`Playback for video format not supported: "${this.parser.mimeType}"`,this.buildMetaNode(),this.nodeView.append(t),e()}}}class W extends g{canHandleImport(e){return e.mimeType?.startsWith("video/")?h:u}getView(){return this._view??=new z(this.getParser()),this._view}}class K extends c{constructor(e,t){super(e,t)}build(e){const t=document.createElement("table");t.className="zip";const n=document.createElement("th");n.className="name",n.textContent="Name";const i=document.createElement("th");i.className="size",i.textContent="Size";const a=document.createElement("th");a.className="date",a.textContent="Date";const s=document.createElement("tr");s.className="head",s.append(n,i,a),t.append(s),this.uncompressedSize=0;for(const n in e.files){const i=e.files[n];let a=i.name,s=(i.name.match(/\//g)||[]).length;i.dir?(s--,a=a.split("/").slice(-2,-1)+"/"):a=a.split("/").pop();const r="····".repeat(s),o=document.createElement("span");o.className="indent",o.textContent=r;const l=document.createElement("span");l.className="text",l.textContent=a;const c=document.createElement("td");c.className="name",c.append(o,l);const d=document.createElement("td");d.className="size",d.textContent=i.dir?"":Z.formatSize(i._data.uncompressedSize),i.dir||(this.uncompressedSize+=i._data.uncompressedSize);const u=document.createElement("td");u.className="date",u.textContent=Z.formatDate(i.date);const m=document.createElement("tr");m.className=i.dir?"zip-dir":"zip-file",m.append(c,d,u),t.append(m)}return t}getHTML(e){this.getArrayBuffer(((t,n)=>{this.parse(n,((t,n)=>{if(t)return void e(t);const i=this.build(n);e(null,i)}))}))}parse(e,t){r.e(211).then(r.t.bind(r,1710,23)).then((n=>{(new(0,n.default)).loadAsync(e).then((e=>t(null,e)),(e=>t(e,null)))}))}}class X extends d{constructor(e){super(e,"zip")}load(e){this.parser.getHTML(((t,n)=>{t&&((n=document.createElement("p")).className="note",n.textContent=t.message),this.metaData.push({name:"Uncompressed",value:Z.formatSize(this.parser.uncompressedSize)}),this.buildMetaNode();const i=document.createElement("div");i.className="wrap",i.append(n),this.nodeView.append(i),e()}))}}class Y extends g{canHandleImport(e){return"application/zip"===e.mimeType?h:u}getParser(){return this._parser??=new K(this._importData),this._parser}getView(){return this._view??=new X(this.getParser()),this._view}}const J={_basePlugin:new g,_plugins:[],init(){this._plugins=[this._basePlugin,new y,new b,new E,new C,new R,new O,new k,new V,new q,new $,new W,new Y]},_getImportDataForFile:async e=>({file:e,dir:null,fileList:null,ext:l.getFileExt(e),mimeType:await l.getMimeType(e)}),async _getPluginForDirectoryImport(e){const t=e.createReader();return new Promise(((n,i)=>{t.readEntries((async t=>{let i=this._basePlugin,a=null;if(E.containsDICOMDIRFile(t))a=t;else if(await E.containsDICOMFiles(t))a=t.filter((async e=>await E.isDICOMFile(e))).sort(((e,t)=>e.name.localeCompare(t.name,{numeric:!0})));else{const t=new Error(`No fitting parser for directory entries in ${e.name} found.`);console.error(t)}a&&(i=this._plugins.find((e=>e instanceof E))||i,i.setImportData({file:null,dir:e,fileList:a,ext:null,mimeType:"application/dicom"})),n(i)}),(e=>{console.error(e),n(this._basePlugin)}))}))},async getPluginForImport(e){if(e instanceof FileSystemDirectoryEntry)return await this._getPluginForDirectoryImport(e);const t=await this._getImportDataForFile(e),n=[];this._plugins.forEach((e=>{const i=e.canHandleImport(t);i>0&&n.push({priority:i,plugin:e})})),n.sort(((e,t)=>t.priority-e.priority));const i=n[0]?.plugin||this._basePlugin;return i.setImportData(t),i}},Z={_domParser:new DOMParser,_prevPlugin:null,_updateMetaInfo(e){const t=document.querySelector("#meta-container");e?(t.style.display="block",t.querySelector(".content").append(e.nodeMeta)):t.style.display=""},_updateViewer(e){const t=document.querySelector("main .viewer"),n=t.querySelector(".note-dragdrop");e?(n.style.display="none",t.append(e.nodeView)):n.style.display=""},build(e){const t=this._domParser.parseFromString(e.trim(),"text/html");let n=null;return t.body.childElementCount>1?(n=document.createDocumentFragment(),n.append(...t.body.children)):(n=t.body.firstChild,n.remove()),n},buildTableRow(e,t,n={}){const i=document.createElement("th");i.textContent=e;const a=document.createElement("td");!0===n.valueAsHTML?a.innerHTML=t:a.textContent=t;const s=document.createElement("tr");return s.append(i,a),s},escapeHTML:e=>e=(e=(e=(e=(e=(e=String(e)).replaceAll("&","&amp;")).replaceAll("<","&lt;")).replaceAll(">","&gt;")).replaceAll('"',"&quot;")).replaceAll("'","&#039;"),formatDate(e){if(!e)return"";let t=e.getUTCFullYear(),n=e.getUTCMonth()+1,i=e.getUTCDate();return n=String(n).padStart(2,"0"),i=String(i).padStart(2,"0"),`${t}-${n}-${i}`},formatDateTime(e){if(!e)return"";const t=this.formatDate(e);let n=e.getUTCHours(),i=e.getUTCMinutes(),a=e.getUTCSeconds();return n=String(n).padStart(2,"0"),i=String(i).padStart(2,"0"),a=String(a).padStart(2,"0"),t+` ${n}:${i}:${a}`},formatDuration(e){let t=Number(e);if(isNaN(t))return e;let n=0,i=["ms","sec","min","h"],a=i[n++];for(t>=1e3&&(t/=1e3,a=i[n],n++);t>=60&&n<i.length;)t/=60,a=i[n],n++;let s=Math.floor(t)+a;if(a!==i[0]){let e=t-Math.floor(t);e*=a===i[1]?1e3:60,e>0&&(s+=" "+Math.floor(e)+i[n-2])}return s},formatSize(e,t=!1){let n=Number(e);if(isNaN(n))return e;let i=t?1024:1e3,a=t?["KiB","MiB","GiB","TiB","PiB"]:["kB","MB","GB","TB","PB"],s="B",r=0;for(;n>=i&&r<a.length;)n/=i,s=a[r],r++;return n.toFixed(1)+" "+s},async open(e){if(!e)return;this._prevPlugin?.reset();const t=await J.getPluginForImport(e);this._prevPlugin=t;const n=t.getView();n.load((()=>this.update(n)))},update(e){this._updateMetaInfo(e),this._updateViewer(e)}};class Q extends T{constructor(e){super(),this._config=e,this._isDragging=!1,this._lastPos={x:null,y:null},this._cbMouseUp=this._onEnd.bind(this),this._cbMouseMove=this._onMove.bind(this)}_applyConfig(){if(this._config){if(this._config.id&&this._node.setAttribute("id",this._config.id),Array.isArray(this._config.content)){const e=this._node.querySelector(".content");for(let t of this._config.content)t instanceof T?e.append(t.render()):e.append(t)}this._config.x&&(this._node.style.left=this._config.x+"px"),this._config.y&&(this._node.style.top=this._config.y+"px")}}_onEnd(e){this._isDragging=!1,document.body.removeEventListener("mouseup",this._cbMouseUp),document.body.removeEventListener("mousemove",this._cbMouseMove),this._node.style.zIndex=1}_onMove(e){if(!this._isDragging)return;if(null===this._lastPos.x)return this._lastPos.x=e.clientX,void(this._lastPos.y=e.clientY);const t=parseInt(this._node.style.left,10),n=parseInt(this._node.style.top,10),i=e.clientX-this._lastPos.x,a=e.clientY-this._lastPos.y;this._node.style.left=Math.round(t+i)+"px",this._node.style.top=Math.round(n+a)+"px",this._lastPos.x=e.clientX,this._lastPos.y=e.clientY}_onStart(e){String(e.target.className).includes("toggle")||(0===e.button&&(this._isDragging=!0,document.body.addEventListener("mouseup",this._cbMouseUp),document.body.addEventListener("mousemove",this._cbMouseMove)),this._lastPos.x=null,this._lastPos.y=null,this._node.style.zIndex=100)}_toggleContent(){let e=this._node.className;e=e.includes("window-closed")?e.replace("window-closed","window-open"):e.replace("window-open","window-closed"),this._node.className=e}render(){super.render(),this._node=Z.build(`\n\t\t\t<aside class="window window-open">\n\t\t\t\t<header>\n\t\t\t\t\t<span class="toggle"></span>\n\t\t\t\t\t${this._config.title||""}\n\t\t\t\t</header>\n\t\t\t\t<div class="content"></div>\n\t\t\t</aside>\n\t\t`),this._applyConfig(),delete this._config;const e=this._node.querySelector(":scope > header");return e.querySelector(".toggle").addEventListener("click",(e=>this._toggleContent())),e.addEventListener("mousedown",(e=>this._onStart(e))),this._node}}J.init();const ee=new class extends T{render(){super.render();const e=new D({classes:"file-open",text:"Open…"});e.on("click",(e=>{const t=document.createElement("input");t.type="file",t.addEventListener("change",(e=>{Z.open(t.files[0])})),t.click()}));const t=new Q({title:"Everything Viewer",x:20,y:20,content:[e,Z.build('<a href="https://github.com/sebadorn/everything-viewer" id="github">GitHub</a>')]}),n=new Q({title:"Information",id:"meta-container",x:20,y:116}),i=Z.build('\n\t\t\t<main>\n\t\t\t\t<div class="viewer">\n\t\t\t\t\t<div class="note-dragdrop">\n\t\t\t\t\t\t<h1>Everything Viewer</h1>\n\t\t\t\t\t\t<span>Just drag &amp; drop your file here</span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</main>\n\t\t'),a=i.querySelector(".viewer"),s=new o(a);return s.on("file",(e=>Z.open(e))),s.on("directory",((e,t)=>Z.open(e))),this._node=document.createDocumentFragment(),this._node.append(t.render(),n.render(),i),this._node}};document.body.append(ee.render())})();